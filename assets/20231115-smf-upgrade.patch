diff --git a/SSI.php b/SSI.php
index 31e0960..020fd06 100644
--- a/SSI.php
+++ b/SSI.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.10
+ * @version 2.0.18
  */
 
 // Don't do anything if SMF is already loaded.
@@ -23,10 +23,12 @@ global $boardurl, $boarddir, $sourcedir, $webmaster_email, $cookiename;
 global $db_server, $db_name, $db_user, $db_prefix, $db_persist, $db_error_send, $db_last_error;
 global $db_connection, $modSettings, $context, $sc, $user_info, $topic, $board, $txt;
 global $smcFunc, $ssi_db_user, $scripturl, $ssi_db_passwd, $db_passwd, $cachedir;
+global $image_proxy_enabled, $image_proxy_secret, $image_proxy_maxsize;
+global $auth_secret, $cookie_no_auth_secret;
 
 // Remember the current configuration so it can be set back.
-$ssi_magic_quotes_runtime = function_exists('get_magic_quotes_gpc') && get_magic_quotes_runtime();
-if (function_exists('set_magic_quotes_runtime'))
+$ssi_magic_quotes_runtime = version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('get_magic_quotes_gpc') && get_magic_quotes_runtime();
+if (version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('set_magic_quotes_runtime'))
 	@set_magic_quotes_runtime(0);
 $time_start = microtime();
 
@@ -42,7 +44,7 @@ require_once(dirname(__FILE__) . '/Settings.php');
 if ((empty($cachedir) || !file_exists($cachedir)) && file_exists($boarddir . '/cache'))
 	$cachedir = $boarddir . '/cache';
 
-$ssi_error_reporting = error_reporting(defined('E_STRICT') ? E_ALL | E_STRICT : E_ALL);
+$ssi_error_reporting = error_reporting((defined('E_STRICT') ? E_ALL | E_STRICT : E_ALL) & ~E_DEPRECATED);
 /* Set this to one of three values depending on what you want to happen in the case of a fatal error.
 	false:	Default, will just load the error sub template and die - not putting any theme layers around it.
 	true:	Will load the error sub template AND put the SMF layers around it (Not useful if on total custom pages).
@@ -186,7 +188,7 @@ elseif (basename($_SERVER['PHP_SELF']) == 'SSI.php')
 	die(sprintf($txt['ssi_not_direct'], $user_info['is_admin'] ? '\'' . addslashes(__FILE__) . '\'' : '\'SSI.php\''));
 
 error_reporting($ssi_error_reporting);
-if (function_exists('set_magic_quotes_runtime'))
+if (version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('set_magic_quotes_runtime'))
 	@set_magic_quotes_runtime($ssi_magic_quotes_runtime);
 
 return true;
@@ -1028,7 +1030,7 @@ function ssi_login($redirect_to = '', $output_method = 'echo')
 
 	echo '<tr>
 					<td><input type="hidden" name="cookielength" value="-1" /></td>
-					<td><input type="submit" value="', $txt['login'], '" class="button_submit" /></td>
+					<td><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" /><input type="submit" value="', $txt['login'], '" class="button_submit" /></td>
 				</tr>
 			</table>
 		</form>';
@@ -1083,7 +1085,7 @@ function ssi_recentPoll($topPollInstead = false, $output_method = 'echo')
 	$smcFunc['db_free_result']($request);
 
 	// This user has voted on all the polls.
-	if ($row === false)
+	if (empty($row))
 		return array();
 
 	// If this is a guest who's voted we'll through ourselves to show poll to show the results.
diff --git a/Sources/Admin.php b/Sources/Admin.php
index 6e4894a..5272baa 100644
--- a/Sources/Admin.php
+++ b/Sources/Admin.php
@@ -9,7 +9,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -350,6 +350,7 @@ function AdminMain()
 					'subsections' => array(
 						'register' => array($txt['admin_browse_register_new'], 'moderate_forum'),
 						'agreement' => array($txt['registration_agreement'], 'admin_forum'),
+						'policy' => array($txt['privacy_policy'], 'admin_forum'),
 						'reservednames' => array($txt['admin_reserved_set'], 'admin_forum'),
 						'settings' => array($txt['settings'], 'admin_forum'),
 					),
@@ -617,18 +618,18 @@ function AdminHome()
 
 	// Lastly, fill in the blanks in the support resources paragraphs.
 	$txt['support_resources_p1'] = sprintf($txt['support_resources_p1'],
-		'http://wiki.simplemachines.org/',
-		'http://wiki.simplemachines.org/smf/features2',
-		'http://wiki.simplemachines.org/smf/options2',
-		'http://wiki.simplemachines.org/smf/themes2',
-		'http://wiki.simplemachines.org/smf/packages2'
+		'https://wiki.simplemachines.org/',
+		'https://wiki.simplemachines.org/smf/features2',
+		'https://wiki.simplemachines.org/smf/options2',
+		'https://wiki.simplemachines.org/smf/themes2',
+		'https://wiki.simplemachines.org/smf/packages2'
 	);
 	$txt['support_resources_p2'] = sprintf($txt['support_resources_p2'],
-		'http://www.simplemachines.org/community/',
-		'http://www.simplemachines.org/redirect/english_support',
-		'http://www.simplemachines.org/redirect/international_support_boards',
-		'http://www.simplemachines.org/redirect/smf_support',
-		'http://www.simplemachines.org/redirect/customize_support'
+		'https://www.simplemachines.org/community/',
+		'https://www.simplemachines.org/redirect/english_support',
+		'https://www.simplemachines.org/redirect/international_support_boards',
+		'https://www.simplemachines.org/redirect/smf_support',
+		'https://www.simplemachines.org/redirect/customize_support'
 	);
 }
 
@@ -727,7 +728,7 @@ function AdminSearchInternal()
 	// Load a lot of language files.
 	$language_files = array(
 		'Help', 'ManageMail', 'ManageSettings', 'ManageCalendar', 'ManageBoards', 'ManagePaid', 'ManagePermissions', 'Search',
-		'Login', 'ManageSmileys',
+		'Login', 'ManageSmileys', 'Install',
 	);
 	loadLanguage(implode('+', $language_files));
 
@@ -812,7 +813,7 @@ function AdminSearchInternal()
 
 		foreach ($config_vars as $var)
 			if (!empty($var[1]) && !in_array($var[0], array('permissions', 'switch')))
-				$search_data['settings'][] = array($var[(isset($var[2]) && in_array($var[2], array('file', 'db'))) ? 0 : 1], $setting_area[1]);
+				$search_data['settings'][] = array($var[(isset($var[2]) && in_array($var[2], array('file', 'db'))) ? 0 : 1], $setting_area[1], 'alttxt' => (isset($var[2]) && in_array($var[2], array('file', 'db'))) || isset($var[3]) ? (in_array($var[2], array('file', 'db')) ? $var[1] : $var[3]) : '');
 	}
 
 	$context['page_title'] = $txt['admin_search_results'];
@@ -840,14 +841,14 @@ function AdminSearchInternal()
 			if ($found)
 			{
 				// Format the name - and remove any descriptions the entry may have.
-				$name = isset($txt[$found]) ? $txt[$found] : (isset($txt['setting_' . $found]) ? $txt['setting_' . $found] : $found);
+				$name = isset($txt[$found]) ? $txt[$found] : (isset($txt['setting_' . $found]) ? $txt['setting_' . $found] : (!empty($item['alttxt']) ? $item['alttxt'] : $found));
 				$name = preg_replace('~<(?:div|span)\sclass="smalltext">.+?</(?:div|span)>~', '', $name);
 
 				$context['search_results'][] = array(
 					'url' => (substr($item[1], 0, 4) == 'area' ? $scripturl . '?action=admin;' . $item[1] : $item[1]) . ';' . $context['session_var'] . '=' . $context['session_id'] . ((substr($item[1], 0, 4) == 'area' && $section == 'settings' ? '#' . $item[0][0] : '')),
 					'name' => $name,
 					'type' => $section,
-					'help' => shorten_subject(isset($item[2]) ? strip_tags($helptxt[$item2]) : (isset($helptxt[$found]) ? strip_tags($helptxt[$found]) : ''), 255),
+					'help' => shorten_subject(isset($item[2]) ? strip_tags($helptxt[$item[2]]) : (isset($helptxt[$found]) ? strip_tags($helptxt[$found]) : ''), 255),
 				);
 			}
 		}
diff --git a/Sources/Agreement.php b/Sources/Agreement.php
new file mode 100644
index 0000000..7ffe0f8
--- /dev/null
+++ b/Sources/Agreement.php
@@ -0,0 +1,223 @@
+<?php
+
+/**
+ * Simple Machines Forum (SMF)
+ *
+ * @package SMF
+ * @author Simple Machines
+ * @copyright 2018 Simple Machines
+ * @license http://www.simplemachines.org/about/smf/license.php BSD
+ *
+ * @version 2.0.18
+ */
+
+if (!defined('SMF'))
+	die('Hacking attempt...');
+
+/*	The purpose of this file is to show the user an updated registration
+	agreement, and get them to agree to it.
+
+	bool prepareAgreementContext()
+		// !!!
+
+	bool canRequireAgreement()
+		// !!!
+
+	bool canRequirePrivacyPolicy()
+		// !!!
+
+	void Agreement()
+		- Show the new registration agreement
+
+	void AcceptAgreement()
+		- Called when they actually accept the agreement
+		- Save the date of the current agreement to the members database table
+		- Redirect back to wherever they came from
+*/
+
+function prepareAgreementContext()
+{
+	global $boarddir, $context, $modSettings, $user_info, $language;
+
+	if ($context['show_agreement'])
+	{
+		// Grab the agreement.
+		// Have we got a localized one?
+		if (file_exists($boarddir . '/agreement.' . $user_info['language'] . '.txt'))
+			$context['agreement_file'] = $boarddir . '/agreement.' . $user_info['language'] . '.txt';
+		elseif (file_exists($boarddir . '/agreement.txt'))
+			$context['agreement_file'] = $boarddir . '/agreement.txt';
+
+		if (!empty($context['agreement_file']))
+		{
+			$cache_id = strtr($context['agreement_file'], array($boarddir => '', '.txt' => '', '.' => '_'));
+			$context['agreement'] = parse_bbc(file_get_contents($context['agreement_file']), true, $cache_id);
+		}
+
+		// An agreement file must be present and its text cannot be empty.
+		if (empty($context['agreement']))
+		{
+			if ($_REQUEST['sa'] == 'both')
+				$context['show_agreement'] = false;
+			else
+				fatal_lang_error('no_agreement', false);
+		}
+	}
+
+	if ($context['show_privacy_policy'])
+	{
+		// Have we got a localized policy?
+		if (!empty($modSettings['policy_' . $user_info['language']]))
+			$context['policy'] = parse_bbc($modSettings['policy_' . $user_info['language']]);
+		elseif (!empty($modSettings['policy_' . $language]))
+			$context['policy'] = parse_bbc($modSettings['policy_' . $language]);
+		// Then I guess we've got nothing
+		elseif ($_REQUEST['sa'] == 'both')
+			$context['show_privacy_policy'] = false;
+		else
+			fatal_lang_error('error_no_privacy_policy', false);
+	}
+
+	// Nothing to show? That's no good.
+	if (!$context['show_agreement'] && !$context['show_privacy_policy'])
+		fatal_lang_error('no_agreement', false);
+}
+
+function canRequireAgreement()
+{
+	global $modSettings, $options, $user_info, $context;
+
+	// Guests can't agree
+	if ($user_info['is_guest'] || empty($modSettings['requireAgreement']))
+		return false;
+
+	$agreement_lang = strpos($context['agreement_file'], 'agreement.' . $user_info['language'] . '.txt') !== false ? $user_info['language'] : 'default';
+
+	if (empty($modSettings['agreement_updated_' . $agreement_lang]))
+		return false;
+
+	$context['agreement_accepted_date'] = empty($options['agreement_accepted']) ? 0 : $options['agreement_accepted'];
+
+	// A new timestamp means that there are new changes to the registration agreement and must therefore be shown.
+	return empty($options['agreement_accepted']) || $modSettings['agreement_updated_' . $agreement_lang] > $options['agreement_accepted'];
+}
+
+function canRequirePrivacyPolicy()
+{
+	global $modSettings, $options, $user_info, $language, $context;
+
+	if ($user_info['is_guest'] || empty($modSettings['requirePolicyAgreement']))
+		return false;
+
+	$policy_lang = !empty($modSettings['policy_' . $user_info['language']]) ? $user_info['language'] : $language;
+
+	if (empty($modSettings['policy_updated_' . $policy_lang]))
+		return false;
+
+	$context['privacy_policy_accepted_date'] = empty($options['policy_accepted']) ? 0 : $options['policy_accepted'];
+
+	return empty($options['policy_accepted']) || $modSettings['policy_updated_' . $policy_lang] > $options['policy_accepted'];
+}
+
+// Let's tell them there's a new agreement
+function Agreement()
+{
+	global $context, $scripturl, $txt;
+
+	// Keep it sanitary
+	if (!isset($_REQUEST['sa']) || !in_array($_REQUEST['sa'], array('agreement', 'policy')))
+		$_REQUEST['sa'] = 'both';
+
+	// Now, what do we actually want to show?
+	$context['show_agreement'] = in_array($_REQUEST['sa'], array('agreement', 'both'));
+	$context['show_privacy_policy'] = in_array($_REQUEST['sa'], array('policy', 'both'));
+
+	prepareAgreementContext();
+
+	// What, if anything, do they need to accept?
+	$context['can_accept_agreement'] = $context['show_agreement'] && canRequireAgreement();
+	$context['can_accept_privacy_policy'] = $context['show_privacy_policy'] && canRequirePrivacyPolicy();
+
+	// The form will need to tell us what they are accepting
+	if ($context['can_accept_agreement'] && $context['can_accept_privacy_policy'])
+		$context['accept_doc'] = 'both';
+	elseif ($context['can_accept_agreement'])
+		$context['accept_doc'] = 'agreement';
+	elseif ($context['can_accept_privacy_policy'])
+		$context['accept_doc'] = 'policy';
+
+	loadLanguage('Agreement');
+	loadTemplate('Agreement');
+
+	if ($context['show_agreement'] && $context['show_privacy_policy'])
+		$page_title = $txt['agreement_and_privacy_policy'];
+	elseif ($context['show_agreement'])
+		$page_title = $txt['agreement'];
+	elseif ($context['show_privacy_policy'])
+		$page_title = $txt['privacy_policy'];
+
+	if (isset($_SESSION['old_url']))
+		$_SESSION['redirect_url'] = $_SESSION['old_url'];
+	$context['page_title'] = $page_title;
+	$context['linktree'][] = array(
+		'url' => $scripturl . '?action=agreement',
+		'name' => $txt['agreement_and_privacy_policy'],
+	);
+
+	if ($_REQUEST['sa'] !== 'both')
+		$context['linktree'][] = array(
+			'url' => $scripturl . '?action=agreement;sa=' . $_REQUEST['sa'],
+			'name' => $context['page_title'],
+		);
+}
+
+// I solemly swear to no longer chase squirrels.
+function AcceptAgreement()
+{
+	global $smcFunc, $user_info, $context;
+
+	// No funny business allowed
+	if (!isset($_REQUEST['doc']) || !in_array($_REQUEST['doc'], array('agreement', 'policy', 'both')))
+		redirectexit('action=agreement');
+
+	// Zero in on the agreement for this...
+	$context['show_agreement'] = in_array($_REQUEST['doc'], array('agreement', 'both'));
+	$context['show_privacy_policy'] = in_array($_REQUEST['doc'], array('policy', 'both'));
+
+	prepareAgreementContext();
+
+	// Can they agree to what they are trying to agree to?
+	if ($context['show_agreement'] && !canRequireAgreement())
+		redirectexit('action=agreement');
+	if ($context['show_privacy_policy'] && !canRequirePrivacyPolicy())
+		redirectexit('action=agreement');
+
+	checkSession();
+
+	if (in_array($_REQUEST['doc'], array('agreement', 'both')))
+	{
+		$smcFunc['db_insert']('replace',
+			'{db_prefix}themes',
+			array('id_member' => 'int', 'id_theme' => 'int', 'variable' => 'string', 'value' => 'string'),
+			array($user_info['id'], 1, 'agreement_accepted', time()),
+			array('id_member', 'id_theme', 'variable')
+		);
+		logAction('agreement_accepted', array('applicator' => $user_info['id']), 'user');
+	}
+
+	if (in_array($_REQUEST['doc'], array('policy', 'both')))
+	{
+		$smcFunc['db_insert']('replace',
+			'{db_prefix}themes',
+			array('id_member' => 'int', 'id_theme' => 'int', 'variable' => 'string', 'value' => 'string'),
+			array($user_info['id'], 1, 'policy_accepted', time()),
+			array('id_member', 'id_theme', 'variable')
+		);
+		logAction('policy_accepted', array('applicator' => $user_info['id']), 'user');
+	}
+
+	// Redirect back to chasing those squirrels, er, viewing those memes.
+	redirectexit(!empty($_SESSION['redirect_url']) ? $_SESSION['redirect_url'] : '');
+}
+
+?>
\ No newline at end of file
diff --git a/Sources/Class-CurlFetchWeb.php b/Sources/Class-CurlFetchWeb.php
index 8df7707..44d2d40 100644
--- a/Sources/Class-CurlFetchWeb.php
+++ b/Sources/Class-CurlFetchWeb.php
@@ -7,7 +7,7 @@
  * @copyright 2017 Simple Machines and individual contributors
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.14
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -303,7 +303,7 @@ class curl_fetch_web_data
 
 		// set proper headers only
 		if (isset($temp[0]) && isset($temp[1]))
-			$this->headers[strtolower($temp[0])] = strtolower(trim($temp[1]));
+			$this->headers[strtolower($temp[0])] = trim($temp[1]);
 
 		// return the length of what was passed unless you want a Failed writing header error ;)
 		return strlen($header);
diff --git a/Sources/Class-Graphics.php b/Sources/Class-Graphics.php
index 0550ecc..a36851a 100644
--- a/Sources/Class-Graphics.php
+++ b/Sources/Class-Graphics.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 /*	Gif Util copyright 2003 by Yamasoft (S/C). All rights reserved.
@@ -219,7 +219,7 @@ class gif_lzw_compression
 			if ($count)
 			{
 				for ($i = 0; $i < $count; $i++)
-					$this->Buf[2 + $i] = ord($data{$i});
+					$this->Buf[2 + $i] = ord($data[$i]);
 
 				$data = substr($data, $count);
 			}
@@ -643,7 +643,7 @@ class gif_file
 			{
 				// Is this in the proper range?  If so, get the specific pixel data...
 				if ($x >= $header->m_nLeft && $y >= $header->m_nTop && $x < ($header->m_nLeft + $header->m_nWidth) && $y < ($header->m_nTop + $header->m_nHeight))
-					$bmp .= $data{$i};
+					$bmp .= $data[$i];
 				// Otherwise, this is background...
 				else
 					$bmp .= chr($background_color);
diff --git a/Sources/DbExtra-mysql.php b/Sources/DbExtra-mysql.php
index 22601a8..2ef92e7 100644
--- a/Sources/DbExtra-mysql.php
+++ b/Sources/DbExtra-mysql.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -61,6 +61,7 @@ function db_extra_init()
 			'db_table_sql' => 'smf_db_table_sql',
 			'db_list_tables' => 'smf_db_list_tables',
 			'db_get_version' => 'smf_db_get_version',
+			'db_get_engine' => 'smf_db_get_engine',
 		);
 }
 
@@ -415,7 +416,7 @@ function smf_db_table_sql($tableName)
 		// Ensure the columns are in proper order.
 		ksort($columns);
 
-		$schema_create .= ',' . $crlf . ' ' . $keyname . ' (' . implode($columns, ', ') . ')';
+		$schema_create .= ',' . $crlf . ' ' . $keyname . ' (' . implode(', ', $columns) . ')';
 	}
 
 	// Now just get the comment and type... (MyISAM, etc.)
@@ -451,4 +452,35 @@ function smf_db_get_version()
 	return $ver;
 }
 
+/**
+ * Figures out if we are using MySQL, Percona or MariaDB
+ *
+ * @return string The database engine we are using
+*/
+function smf_db_get_engine()
+{
+	global $smcFunc;
+	static $db_type;
+
+	if (!empty($db_type))
+		return $db_type;
+
+	$request = $smcFunc['db_query']('', 'SELECT @@version_comment');
+	list ($comment) = $smcFunc['db_fetch_row']($request);
+	$smcFunc['db_free_result']($request);
+
+	// Skip these if we don't have a comment.
+	if (!empty($comment))
+	{
+		if (stripos($comment, 'percona') !== false)
+			return 'Percona';
+		if (stripos($comment, 'mariadb') !== false)
+			return 'MariaDB';
+	}
+	else
+		return 'fail';
+
+	return 'MySQL';
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/DbExtra-postgresql.php b/Sources/DbExtra-postgresql.php
index 2f5271f..d25b05a 100644
--- a/Sources/DbExtra-postgresql.php
+++ b/Sources/DbExtra-postgresql.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.15
  */
 
 if (!defined('SMF'))
@@ -61,6 +61,7 @@ function db_extra_init()
 			'db_table_sql' => 'smf_db_table_sql',
 			'db_list_tables' => 'smf_db_list_tables',
 			'db_get_version' => 'smf_db_get_version',
+			'db_get_engine' => 'smf_db_get_engine',
 		);
 }
 
@@ -325,4 +326,14 @@ function smf_db_get_version()
 	return $ver;
 }
 
+/**
+ * Return PostgreSQL
+ *
+ * @return string The database engine we are using
+*/
+function smf_db_get_engine()
+{
+	return 'PostgreSQL';
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/DbExtra-sqlite.php b/Sources/DbExtra-sqlite.php
index 4964a22..6efdb4a 100644
--- a/Sources/DbExtra-sqlite.php
+++ b/Sources/DbExtra-sqlite.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.15
  */
 
 if (!defined('SMF'))
@@ -62,6 +62,7 @@ function db_extra_init()
 			'db_list_tables' => 'smf_db_list_tables',
 			'db_get_backup' => 'smf_db_get_backup',
 			'db_get_version' => 'smf_db_get_version',
+			'db_get_engine' => 'smf_db_get_engine',
 		);
 }
 
@@ -343,4 +344,14 @@ function smf_db_get_backup()
 	obExit(false);
 }
 
+/**
+ * Return SQLite
+ *
+ * @return string The database engine we are using
+*/
+function smf_db_get_engine()
+{
+	return 'SQLite';
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/DbPackages-mysql.php b/Sources/DbPackages-mysql.php
index 6847d3a..2dfd9eb 100644
--- a/Sources/DbPackages-mysql.php
+++ b/Sources/DbPackages-mysql.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.15
  */
 
 if (!defined('SMF'))
@@ -132,7 +132,7 @@ function smf_db_create_table($table_name, $columns, $indexes = array(), $paramet
 		list ($type, $size) = $smcFunc['db_calculate_type']($column['type'], $column['size']);
 
 		// Allow unsigned integers (mysql only)
-		$unsigned = in_array($type, array('int', 'tinyint', 'smallint', 'mediumint', 'bigint', 'float')) && !empty($column_info['unsigned']) ? 'unsigned ' : '';
+		$unsigned = in_array($type, array('int', 'tinyint', 'smallint', 'mediumint', 'bigint', 'float')) && !empty($column['unsigned']) ? 'unsigned ' : '';
 
 		if ($size !== null)
 			$type = $type . '(' . $size . ')';
diff --git a/Sources/Display.php b/Sources/Display.php
index 345b36b..5a38ebd 100644
--- a/Sources/Display.php
+++ b/Sources/Display.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -734,9 +734,9 @@ img_gpbp_up=new Image;img_gpbp_up.src="' . $settings['images_url'] . '/gpbp'.$gp
 			'has_voted' => !empty($pollinfo['has_voted']),
 			'starter' => array(
 				'id' => $pollinfo['id_member'],
-				'name' => $row['poster_name'],
+				'name' => $pollinfo['poster_name'],
 				'href' => $pollinfo['id_member'] == 0 ? '' : $scripturl . '?action=profile;u=' . $pollinfo['id_member'],
-				'link' => $pollinfo['id_member'] == 0 ? $row['poster_name'] : '<a href="' . $scripturl . '?action=profile;u=' . $pollinfo['id_member'] . '">' . $row['poster_name'] . '</a>'
+				'link' => $pollinfo['id_member'] == 0 ? $pollinfo['poster_name'] : '<a href="' . $scripturl . '?action=profile;u=' . $pollinfo['id_member'] . '">' . $pollinfo['poster_name'] . '</a>'
 			)
 		);
 
@@ -1493,9 +1493,10 @@ function Download()
 
 	// Convert the file to UTF-8, cuz most browsers dig that.
 	$utf8name = !$context['utf8'] && function_exists('iconv') ? iconv($context['character_set'], 'UTF-8', $real_filename) : (!$context['utf8'] && function_exists('mb_convert_encoding') ? mb_convert_encoding($real_filename, 'UTF-8', $context['character_set']) : $real_filename);
-	$fixchar = create_function('$n', '
+	$fixchar = function($n)
+	{
 		if ($n < 32)
-			return \'\';
+			return '';
 		elseif ($n < 128)
 			return chr($n);
 		elseif ($n < 2048)
@@ -1503,7 +1504,8 @@ function Download()
 		elseif ($n < 65536)
 			return chr(224 | $n >> 12) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);
 		else
-			return chr(240 | $n >> 18) . chr(128 | $n >> 12 & 63) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);');
+			return chr(240 | $n >> 18) . chr(128 | $n >> 12 & 63) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);
+	};
 
 	$disposition = !isset($_REQUEST['image']) ? 'attachment' : 'inline';
 
@@ -1536,11 +1538,11 @@ function Download()
 	if (!empty($modSettings['attachmentRecodeLineEndings']) && !isset($_REQUEST['image']) && in_array($file_ext, array('txt', 'css', 'htm', 'html', 'php', 'xml')))
 	{
 		if (strpos($_SERVER['HTTP_USER_AGENT'], 'Windows') !== false)
-			$callback = create_function('$buffer', 'return preg_replace(\'~[\r]?\n~\', "\r\n", $buffer);');
+			$callback = function($buffer){return preg_replace('~[\r]?\n~', "\r\n", $buffer);};
 		elseif (strpos($_SERVER['HTTP_USER_AGENT'], 'Mac') !== false)
-			$callback = create_function('$buffer', 'return preg_replace(\'~[\r]?\n~\', "\r", $buffer);');
+			$callback = function($buffer){return preg_replace('~[\r]?\n~', "\r", $buffer);};
 		else
-			$callback = create_function('$buffer', 'return preg_replace(\'~[\r]?\n~\', "\n", $buffer);');
+			$callback = function($buffer){return preg_replace('~[\r]?\n~', "\n", $buffer);};
 	}
 
 	// Since we don't do output compression for files this large...
diff --git a/Sources/Errors.php b/Sources/Errors.php
index 5f80b70..af85687 100644
--- a/Sources/Errors.php
+++ b/Sources/Errors.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.4
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -203,9 +203,22 @@ function error_handler($error_level, $error_string, $file, $line)
 {
 	global $settings, $modSettings, $db_show_debug;
 
-	// Ignore errors if we're ignoring them or they are strict notices from PHP 5 (which cannot be solved without breaking PHP 4.)
-	if (error_reporting() == 0 || (defined('E_STRICT') && $error_level == E_STRICT && (empty($modSettings['enableErrorLogging']) || $modSettings['enableErrorLogging'] != 2)))
-		return;
+	// Error was suppressed with the @-operator.
+	if (error_reporting() == 0)
+		return true;
+
+	// Ignore errors that should should not be logged.
+	$error_match = error_reporting() & $error_level;
+	if (empty($error_match) || empty($modSettings['enableErrorLogging']))
+		return false;
+
+	// Send these notices introduced by PHP 7.2 to where the sun don't shine!
+	if (strpos($error_string, 'create_function()') !== false)
+		return true;
+
+	// Also ignore these deprecation warnings introduced in PHP 8.1.
+	if (defined('PHP_VERSION_ID') && PHP_VERSION_ID >= 80100 && strpos($error_string, 'strftime()') !== false)
+		return true;
 
 	if (strpos($file, 'eval()') !== false && !empty($settings['current_include_filename']))
 	{
diff --git a/Sources/Groups.php b/Sources/Groups.php
index e1a0625..e48b7c3 100644
--- a/Sources/Groups.php
+++ b/Sources/Groups.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -194,16 +194,15 @@ function GroupList()
 					'value' => $txt['name'],
 				),
 				'data' => array(
-					'function' => create_function('$group', '
-						global $scripturl, $context;
-
-						$output = \'<a href="\' . $scripturl . \'?action=\' . $context[\'current_action\'] . (isset($context[\'admin_area\']) ? \';area=\' . $context[\'admin_area\'] : \'\') . \';sa=members;group=\' . $group[\'id\'] . \'" \' . ($group[\'color\'] ? \'style="color: \' . $group[\'color\'] . \';"\' : \'\') . \'>\' . $group[\'name\'] . \'</a>\';
+					'function' => function($group) use ($scripturl, $context)
+					{
+						$output = '<a href="' . $scripturl . '?action=' . $context['current_action'] . (isset($context['admin_area']) ? ';area=' . $context['admin_area'] : '') . ';sa=members;group=' . $group['id'] . '" ' . ($group['color'] ? 'style="color: ' . $group['color'] . ';"' : '') . '>' . $group['name'] . '</a>';
 
-						if ($group[\'desc\'])
-							$output .= \'<div class="smalltext">\' . $group[\'desc\'] . \'</div>\';
+						if ($group['desc'])
+							$output .= '<div class="smalltext">' . $group['desc'] . '</div>';
 
 						return $output;
-					'),
+					},
 					'style' => 'width: 50%;',
 				),
 			),
@@ -220,11 +219,10 @@ function GroupList()
 					'value' => $txt['moderators'],
 				),
 				'data' => array(
-					'function' => create_function('$group', '
-						global $txt;
-
-						return empty($group[\'moderators\']) ? \'<em>\' . $txt[\'membergroups_new_copy_none\'] . \'</em>\' : implode(\', \', $group[\'moderators\']);
-					'),
+					'function' => function($group) use ($txt)
+					{
+						return empty($group['moderators']) ? '<em>' . $txt['membergroups_new_copy_none'] . '</em>' : implode(', ', $group['moderators']);
+					},
 				),
 			),
 			'members' => array(
@@ -456,6 +454,10 @@ function MembergroupMembers()
 	{
 		checkSession();
 
+		// Only proven admins can remove admins.
+		if ($context['group']['id'] == 1)
+			validateSession();
+
 		// Make sure we're dealing with integers only.
 		foreach ($_REQUEST['rem'] as $key => $group)
 			$_REQUEST['rem'][$key] = (int) $group;
@@ -468,6 +470,10 @@ function MembergroupMembers()
 	{
 		checkSession();
 
+		// Demand an admin password before adding new admins -- every time, no matter what.
+		if ($context['group']['id'] == 1)
+			validateSession(true);
+
 		$member_query = array();
 		$member_parameters = array();
 
diff --git a/Sources/Help.php b/Sources/Help.php
index 2896e60..163de32 100644
--- a/Sources/Help.php
+++ b/Sources/Help.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -41,7 +41,7 @@ function ShowHelp()
 	loadLanguage('Manual');
 
 	// We need to know where our wiki is.
-	$context['wiki_url'] = 'http://wiki.simplemachines.org/smf';
+	$context['wiki_url'] = 'https://wiki.simplemachines.org/smf';
 
 	// Sections were are going to link...
 	$context['manual_sections'] = array(
diff --git a/Sources/Load.php b/Sources/Load.php
index e563df5..6c023dc 100644
--- a/Sources/Load.php
+++ b/Sources/Load.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -160,71 +160,96 @@ function reloadSettings()
 		if (empty($modSettings['defaultMaxMembers']) || $modSettings['defaultMaxMembers'] <= 0 || $modSettings['defaultMaxMembers'] > 999)
 			$modSettings['defaultMaxMembers'] = 30;
 
+		// Covers null and !isset cases
+		if (empty($modSettings['requirePolicyAgreement']))
+			$modSettings['requirePolicyAgreement'] = 0;
+
 		if (!empty($modSettings['cache_enable']))
 			cache_put_data('modSettings', $modSettings, 90);
 	}
 
 	// UTF-8 in regular expressions is unsupported on PHP(win) versions < 4.2.3.
-	$utf8 = (empty($modSettings['global_character_set']) ? $txt['lang_character_set'] : $modSettings['global_character_set']) === 'UTF-8' && (strpos(strtolower(PHP_OS), 'win') === false || @version_compare(PHP_VERSION, '4.2.3') != -1);
+	$utf8 = (empty($modSettings['global_character_set']) ? (!empty($txt['lang_character_set']) ? $txt['lang_character_set'] : '') : $modSettings['global_character_set']) === 'UTF-8' && (strpos(strtolower(PHP_OS), 'win') === false || @version_compare(PHP_VERSION, '4.2.3') != -1);
 
 	// Set a list of common functions.
-	$ent_list = empty($modSettings['disableEntityCheck']) ? '&(#\d{1,7}|quot|amp|lt|gt|nbsp);' : '&(#021|quot|amp|lt|gt|nbsp);';
-	$ent_check = empty($modSettings['disableEntityCheck']) ? array('preg_replace_callback(\'~(&#(\d{1,7}|x[0-9a-fA-F]{1,6});)~\', \'entity_fix__callback\', ', ')') : array('', '');
+	$ent_list = empty($modSettings['disableEntityCheck']) ? '&(?>#\d{1,7}|quot|amp|lt|gt|nbsp);' : '&(?>#021|quot|amp|lt|gt|nbsp);';
+	$ent_check = empty($modSettings['disableEntityCheck']) ? function($string, $double = false)
+		{
+			$string = preg_replace_callback('~(&' . (!empty($double) ? '(?:amp;)?' : '') . '#(\d{1,7}|x[0-9a-fA-F]{1,6});)~', 'entity_fix__callback', $string);
+			return $string;
+		} : function($string)
+		{
+			return $string;
+		};
+	$fix_utf8mb4 = function($string) use ($utf8, $smcFunc)
+	{
+		if (!$utf8)
+			return $string;
+
+		$i = 0;
+		$len = strlen($string);
+		$new_string = '';
+		while ($i < $len)
+		{
+			$ord = ord($string[$i]);
+			if ($ord < 128)
+			{
+				$new_string .= $string[$i];
+				$i++;
+			}
+			elseif ($ord < 224)
+			{
+				$new_string .= $string[$i] . $string[$i + 1];
+				$i += 2;
+			}
+			elseif ($ord < 240)
+			{
+				$new_string .= $string[$i] . $string[$i + 1] . $string[$i + 2];
+				$i += 3;
+			}
+			elseif ($ord < 248)
+			{
+				// Magic happens.
+				$val = (ord($string[$i]) & 0x07) << 18;
+				$val += (ord($string[$i + 1]) & 0x3F) << 12;
+				$val += (ord($string[$i + 2]) & 0x3F) << 6;
+				$val += (ord($string[$i + 3]) & 0x3F);
+				$new_string .= '&#' . $val . ';';
+				$i += 4;
+			}
+		}
+		return $new_string;
+	};
 
 	// Preg_replace can handle complex characters only for higher PHP versions.
 	$space_chars = $utf8 ? (@version_compare(PHP_VERSION, '4.3.3') != -1 ? '\x{A0}\x{AD}\x{2000}-\x{200F}\x{201F}\x{202F}\x{3000}\x{FEFF}' : "\xC2\xA0\xC2\xAD\xE2\x80\x80-\xE2\x80\x8F\xE2\x80\x9F\xE2\x80\xAF\xE2\x80\x9F\xE3\x80\x80\xEF\xBB\xBF") : '\x00-\x08\x0B\x0C\x0E-\x19\xA0';
 
 	$smcFunc += array(
-		'entity_fix' => create_function('$string', '
-			$num = substr($string, 0, 1) === \'x\' ? hexdec(substr($string, 1)) : (int) $string;
-			return $num < 0x20 || $num > 0x10FFFF || ($num >= 0xD800 && $num <= 0xDFFF) || $num === 0x202E || $num === 0x202D ? \'\' : \'&#\' . $num . \';\';'),
-		'htmlspecialchars' => create_function('$string, $quote_style = ENT_COMPAT, $charset = \'ISO-8859-1\'', '
-			global $smcFunc;
-			return ' . ($utf8 ? '$smcFunc[\'fix_utf8mb4\'](' : '') . strtr($ent_check[0], array('&' => '&amp;')) . 'htmlspecialchars($string, $quote_style, ' . ($utf8 ? '\'UTF-8\'' : '$charset') . ')' . $ent_check[1] . ($utf8 ? ')' : '') . ';'),
-		'fix_utf8mb4' => create_function('$string', '
-			$i = 0;
-			$len = strlen($string);
-			$new_string = \'\';
-			while ($i < $len)
-			{
-				$ord = ord($string[$i]);
-				if ($ord < 128)
-				{
-					$new_string .= $string[$i];
-					$i++;
-				}
-				elseif ($ord < 224)
-				{
-					$new_string .= $string[$i] . $string[$i+1];
-					$i += 2;
-				}
-				elseif ($ord < 240)
-				{
-					$new_string .= $string[$i] . $string[$i+1] . $string[$i+2];
-					$i += 3;
-				}
-				elseif ($ord < 248)
-				{
-					// Magic happens.
-					$val = (ord($string[$i]) & 0x07) << 18;
-					$val += (ord($string[$i+1]) & 0x3F) << 12;
-					$val += (ord($string[$i+2]) & 0x3F) << 6;
-					$val += (ord($string[$i+3]) & 0x3F);
-					$new_string .= \'&#\' . $val . \';\';
-					$i += 4;
-				}
-			}
-			return $new_string;'),
-		'htmltrim' => create_function('$string', '
-			global $smcFunc;
-			return preg_replace(\'~^(?:[ \t\n\r\x0B\x00' . $space_chars . ']|&nbsp;)+|(?:[ \t\n\r\x0B\x00' . $space_chars . ']|&nbsp;)+$~' . ($utf8 ? 'u' : '') . '\', \'\', ' . implode('$string', $ent_check) . ');'),
-		'strlen' => create_function('$string', '
-			global $smcFunc;
-			return strlen(preg_replace(\'~' . $ent_list . ($utf8 ? '|.~u' : '~') . '\', \'_\', ' . implode('$string', $ent_check) . '));'),
-		'strpos' => create_function('$haystack, $needle, $offset = 0', '
-			global $smcFunc;
-			$haystack_arr = preg_split(\'~(&#' . (empty($modSettings['disableEntityCheck']) ? '\d{1,7}' : '021') . ';|&quot;|&amp;|&lt;|&gt;|&nbsp;|.)~' . ($utf8 ? 'u' : '') . '\', ' . implode('$haystack', $ent_check) . ', -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
-			$haystack_size = count($haystack_arr);
+		'entity_fix' => function($string)
+		{
+			$num = $string[0] === 'x' ? hexdec(substr($string, 1)) : (int) $string;
+			return $num < 0x20 || $num > 0x10FFFF || ($num >= 0xD800 && $num <= 0xDFFF) || $num === 0x202E || $num === 0x202D ? '' : '&#' . $num . ';';
+		},
+		'htmlspecialchars' => function($string, $quote_style = ENT_COMPAT, $charset = 'ISO-8859-1') use ($ent_check, $utf8, $fix_utf8mb4)
+		{
+			return $fix_utf8mb4($ent_check(htmlspecialchars($string, $quote_style, $utf8 ? 'UTF-8' : $charset), true));
+		},
+		'fix_utf8mb4' => $fix_utf8mb4,
+		'htmltrim' => function($string) use ($utf8, $ent_check)
+		{
+			// Preg_replace space characters depend on the character set in use
+			$space_chars = $utf8 ? '\p{Z}\p{C}' : '\x00-\x20\x80-\xA0';
+
+			return preg_replace('~^(?:[' . $space_chars . ']|&nbsp;)+|(?:[' . $space_chars . ']|&nbsp;)+$~' . ($utf8 ? 'u' : ''), '', $ent_check($string));
+		},
+		'strlen' => function($string) use ($ent_list, $utf8, $ent_check)
+		{
+			return strlen(preg_replace('~' . $ent_list . ($utf8 ? '|.~u' : '~'), '_', $ent_check($string)));
+		},
+		'strpos' => function($haystack, $needle, $offset = 0) use ($utf8, $ent_check, $ent_list, $modSettings)
+		{
+			$haystack_arr = preg_split('~(' . $ent_list . '|.)~' . ($utf8 ? 'u' : ''), $ent_check($haystack), -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
+
 			if (strlen($needle) === 1)
 			{
 				$result = array_search($needle, array_slice($haystack_arr, $offset));
@@ -232,11 +257,11 @@ function reloadSettings()
 			}
 			else
 			{
-				$needle_arr = preg_split(\'~(&#' . (empty($modSettings['disableEntityCheck']) ? '\d{1,7}' : '021') . ';|&quot;|&amp;|&lt;|&gt;|&nbsp;|.)~' . ($utf8 ? 'u' : '') . '\',  ' . implode('$needle', $ent_check) . ', -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
+				$needle_arr = preg_split('~(' . $ent_list . '|.)~' . ($utf8 ? 'u' : '') . '', $ent_check($needle), -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
 				$needle_size = count($needle_arr);
 
 				$result = array_search($needle_arr[0], array_slice($haystack_arr, $offset));
-				while (is_int($result))
+				while ((int) $result === $result)
 				{
 					$offset += $result;
 					if (array_slice($haystack_arr, $offset, $needle_size) === $needle_arr)
@@ -244,38 +269,55 @@ function reloadSettings()
 					$result = array_search($needle_arr[0], array_slice($haystack_arr, ++$offset));
 				}
 				return false;
-			}'),
-		'substr' => create_function('$string, $start, $length = null', '
-			global $smcFunc;
-			$ent_arr = preg_split(\'~(&#' . (empty($modSettings['disableEntityCheck']) ? '\d{1,7}' : '021') . ';|&quot;|&amp;|&lt;|&gt;|&nbsp;|.)~' . ($utf8 ? 'u' : '') . '\', ' . implode('$string', $ent_check) . ', -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
-			return $length === null ? implode(\'\', array_slice($ent_arr, $start)) : implode(\'\', array_slice($ent_arr, $start, $length));'),
-		'strtolower' => $utf8 ? (function_exists('mb_strtolower') ? create_function('$string', '
-			return mb_strtolower($string, \'UTF-8\');') : create_function('$string', '
-			global $sourcedir;
-			require_once($sourcedir . \'/Subs-Charset.php\');
-			return utf8_strtolower($string);')) : 'strtolower',
-		'strtoupper' => $utf8 ? (function_exists('mb_strtoupper') ? create_function('$string', '
-			return mb_strtoupper($string, \'UTF-8\');') : create_function('$string', '
+			}
+		},
+		'substr' => function($string, $start, $length = null) use ($utf8, $ent_check, $ent_list, $modSettings)
+		{
+			$ent_arr = preg_split('~(' . $ent_list . '|.)~' . ($utf8 ? 'u' : '') . '', $ent_check($string), -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
+			return $length === null ? implode('', array_slice($ent_arr, $start)) : implode('', array_slice($ent_arr, $start, $length));
+		},
+		'strtolower' => $utf8 ? function($string) use ($sourcedir)
+		{
+			if (!function_exists('mb_strtolower'))
+			{
+				require_once($sourcedir . '/Subs-Charset.php');
+				return utf8_strtolower($string);
+			}
+
+			return mb_strtolower($string, 'UTF-8');
+		} : 'strtolower',
+		'strtoupper' => $utf8 ? function($string)
+		{
 			global $sourcedir;
-			require_once($sourcedir . \'/Subs-Charset.php\');
-			return utf8_strtoupper($string);')) : 'strtoupper',
-		'truncate' => create_function('$string, $length', (empty($modSettings['disableEntityCheck']) ? '
-			global $smcFunc;
-			$string = ' . implode('$string', $ent_check) . ';' : '') . '
-			preg_match(\'~^(' . $ent_list . '|.){\' . $smcFunc[\'strlen\'](substr($string, 0, $length)) . \'}~'.  ($utf8 ? 'u' : '') . '\', $string, $matches);
+
+			if (!function_exists('mb_strtolower'))
+			{
+				require_once($sourcedir . '/Subs-Charset.php');
+				return utf8_strtoupper($string);
+			}
+
+			return mb_strtoupper($string, 'UTF-8');
+		} : 'strtoupper',
+		'truncate' => function($string, $length) use ($utf8, $ent_check, $ent_list, &$smcFunc)
+		{
+			$string = $ent_check($string);
+			preg_match('~^(' . $ent_list . '|.){' . $smcFunc['strlen'](substr($string, 0, $length)) . '}~' . ($utf8 ? 'u' : ''), $string, $matches);
 			$string = $matches[0];
 			while (strlen($string) > $length)
-				$string = preg_replace(\'~(?:' . $ent_list . '|.)$~'.  ($utf8 ? 'u' : '') . '\', \'\', $string);
-			return $string;'),
-		'ucfirst' => $utf8 ? create_function('$string', '
-			global $smcFunc;
-			return $smcFunc[\'strtoupper\']($smcFunc[\'substr\']($string, 0, 1)) . $smcFunc[\'substr\']($string, 1);') : 'ucfirst',
-		'ucwords' => $utf8 ? create_function('$string', '
-			global $smcFunc;
-			$words = preg_split(\'~([\s\r\n\t]+)~\', $string, -1, PREG_SPLIT_DELIM_CAPTURE);
+				$string = preg_replace('~(?:' . $ent_list . '|.)$~' . ($utf8 ? 'u' : ''), '', $string);
+			return $string;
+		},
+		'ucfirst' => $utf8 ? function($string) use (&$smcFunc)
+		{
+			return $smcFunc['strtoupper']($smcFunc['substr']($string, 0, 1)) . $smcFunc['substr']($string, 1);
+		} : 'ucfirst',
+		'ucwords' => $utf8 ? function($string) use (&$smcFunc)
+		{
+			$words = preg_split('~([\s\r\n\t]+)~', $string, -1, PREG_SPLIT_DELIM_CAPTURE);
 			for ($i = 0, $n = count($words); $i < $n; $i += 2)
-				$words[$i] = $smcFunc[\'ucfirst\']($words[$i]);
-			return implode(\'\', $words);') : 'ucwords',
+				$words[$i] = $smcFunc['ucfirst']($words[$i]);
+			return implode('', $words);
+		} : 'ucwords',
 	);
 
 	// Setting the timezone is a requirement for some functions in PHP >= 5.1.
@@ -335,6 +377,8 @@ function loadUserSettings()
 {
 	global $modSettings, $user_settings, $sourcedir, $smcFunc;
 	global $cookiename, $user_info, $language;
+	global $boardurl, $image_proxy_enabled, $image_proxy_secret;
+	global $cookie_no_auth_secret;
 
 	// Check first the integration, then the cookie, and last the session.
 	if (count($integration_ids = call_integration_hook('integrate_verify_user')) > 0)
@@ -391,6 +435,9 @@ function loadUserSettings()
 			$user_settings = $smcFunc['db_fetch_assoc']($request);
 			$smcFunc['db_free_result']($request);
 
+			if (!empty($user_settings['avatar']))
+				$user_settings['avatar'] = get_proxied_url($user_settings['avatar']);
+
 			if (!empty($modSettings['cache_enable']) && $modSettings['cache_enable'] >= 2)
 				cache_put_data('user_settings-' . $id_member, $user_settings, 60);
 		}
@@ -403,7 +450,7 @@ function loadUserSettings()
 				$check = true;
 			// SHA-1 passwords should be 40 characters long.
 			elseif (strlen($password) == 40)
-				$check = sha1($user_settings['passwd'] . $user_settings['password_salt']) == $password;
+				$check = empty($cookie_no_auth_secret) ? hash_hmac('sha1', sha1($user_settings['passwd'] . $user_settings['password_salt']), get_auth_secret()) == $password : sha1($user_settings['passwd'] . $user_settings['password_salt']) == $password;
 			else
 				$check = false;
 
@@ -709,7 +756,7 @@ function loadBoard()
 				'posts_count' => empty($row['count_posts']),
 				'cur_topic_approved' => empty($topic) || $row['approved'],
 				'cur_topic_starter' => empty($topic) ? 0 : $row['id_member_started'],
-				
+
 				'gpbp_enabled' => !empty($row['enable_gpbp']),
 			);
 
@@ -974,6 +1021,7 @@ function loadPermissions()
 function loadMemberData($users, $is_name = false, $set = 'normal')
 {
 	global $user_profile, $modSettings, $board_info, $smcFunc;
+	global $boardurl, $image_proxy_enabled, $image_proxy_secret, $user_info;
 	// Can't just look for no users :P.
 	if (empty($users))
 		return false;
@@ -1035,7 +1083,7 @@ function loadMemberData($users, $is_name = false, $set = 'normal')
 			CASE WHEN mem.id_group = 0 OR mg.stars = {string:blank_string} THEN pg.stars ELSE mg.stars END AS stars, mem.password_salt, mem.pm_prefs';
 
 		$select_columns .= ',
-			mem.gpbp_respect';		
+			mem.gpbp_respect';
 
 		$select_tables = '
 			LEFT JOIN {db_prefix}log_online AS lo ON (lo.id_member = mem.id_member)
@@ -1068,6 +1116,14 @@ function loadMemberData($users, $is_name = false, $set = 'normal')
 		$new_loaded_ids = array();
 		while ($row = $smcFunc['db_fetch_assoc']($request))
 		{
+			// If the image proxy is enabled, we still want the original URL when they're editing the profile...
+			if (isset($row['avatar']))
+				$row['avatar_original'] = $row['avatar'];
+
+			// Take care of proxying avatar if required, do this here for maximum reach
+			if (!empty($row['avatar']))
+				$row['avatar'] = get_proxied_url($row['avatar']);
+
 			$new_loaded_ids[] = $row['id_member'];
 			$loaded_ids[] = $row['id_member'];
 			$row['options'] = array();
@@ -1216,9 +1272,9 @@ function loadMemberContext($user, $display_custom_fields = false)
 		'location' => $profile['location'],
 		'icq' => $profile['icq'] != '' && (empty($modSettings['guest_hideContacts']) || !$user_info['is_guest']) ? array(
 			'name' => $profile['icq'],
-			'href' => 'http://www.icq.com/whitepages/about_me.php?uin=' . $profile['icq'],
-			'link' => '<a class="icq new_win" href="http://www.icq.com/whitepages/about_me.php?uin=' . $profile['icq'] . '" target="_blank" title="' . $txt['icq_title'] . ' - ' . $profile['icq'] . '"><img src="http://status.icq.com/online.gif?img=5&amp;icq=' . $profile['icq'] . '" alt="' . $txt['icq_title'] . ' - ' . $profile['icq'] . '" width="18" height="18" /></a>',
-			'link_text' => '<a class="icq extern" href="http://www.icq.com/whitepages/about_me.php?uin=' . $profile['icq'] . '" title="' . $txt['icq_title'] . ' - ' . $profile['icq'] . '">' . $profile['icq'] . '</a>',
+			'href' => 'https://www.icq.com/whitepages/about_me.php?uin=' . $profile['icq'],
+			'link' => '<a class="icq new_win" href="https://www.icq.com/whitepages/about_me.php?uin=' . $profile['icq'] . '" target="_blank" title="' . $txt['icq_title'] . ' - ' . $profile['icq'] . '"><img src="https://status.icq.com/online.gif?img=5&amp;icq=' . $profile['icq'] . '" alt="' . $txt['icq_title'] . ' - ' . $profile['icq'] . '" width="18" height="18" /></a>',
+			'link_text' => '<a class="icq extern" href="https://www.icq.com/whitepages/about_me.php?uin=' . $profile['icq'] . '" title="' . $txt['icq_title'] . ' - ' . $profile['icq'] . '">' . $profile['icq'] . '</a>',
 		) : array('name' => '', 'add' => '', 'href' => '', 'link' => '', 'link_text' => ''),
 		'aim' => $profile['aim'] != '' && (empty($modSettings['guest_hideContacts']) || !$user_info['is_guest']) ? array(
 			'name' => $profile['aim'],
@@ -1228,22 +1284,23 @@ function loadMemberContext($user, $display_custom_fields = false)
 		) : array('name' => '', 'href' => '', 'link' => '', 'link_text' => ''),
 		'yim' => $profile['yim'] != '' && (empty($modSettings['guest_hideContacts']) || !$user_info['is_guest']) ? array(
 			'name' => $profile['yim'],
-			'href' => 'http://edit.yahoo.com/config/send_webmesg?.target=' . urlencode($profile['yim']),
-			'link' => '<a class="yim" href="http://edit.yahoo.com/config/send_webmesg?.target=' . urlencode($profile['yim']) . '" title="' . $txt['yim_title'] . ' - ' . $profile['yim'] . '"><img src="http://opi.yahoo.com/online?u=' . urlencode($profile['yim']) . '&amp;m=g&amp;t=0" alt="' . $txt['yim_title'] . ' - ' . $profile['yim'] . '" /></a>',
-			'link_text' => '<a class="yim" href="http://edit.yahoo.com/config/send_webmesg?.target=' . urlencode($profile['yim']) . '" title="' . $txt['yim_title'] . ' - ' . $profile['yim'] . '">' . $profile['yim'] . '</a>'		) : array('name' => '', 'href' => '', 'link' => '', 'link_text' => ''),
+			'href' => 'https://edit.yahoo.com/config/send_webmesg?.target=' . urlencode($profile['yim']),
+			'link' => '<a class="yim" href="https://edit.yahoo.com/config/send_webmesg?.target=' . urlencode($profile['yim']) . '" title="' . $txt['yim_title'] . ' - ' . $profile['yim'] . '"><img src="https://opi.yahoo.com/online?u=' . urlencode($profile['yim']) . '&amp;m=g&amp;t=0" alt="' . $txt['yim_title'] . ' - ' . $profile['yim'] . '" /></a>',
+			'link_text' => '<a class="yim" href="https://edit.yahoo.com/config/send_webmesg?.target=' . urlencode($profile['yim']) . '" title="' . $txt['yim_title'] . ' - ' . $profile['yim'] . '">' . $profile['yim'] . '</a>'
+		) : array('name' => '', 'href' => '', 'link' => '', 'link_text' => ''),
 		'msn' => $profile['msn'] !='' && (empty($modSettings['guest_hideContacts']) || !$user_info['is_guest']) ? array(
 			'name' => $profile['msn'],
-			'href' => 'http://members.msn.com/' . $profile['msn'],
-			'link' => '<a class="msn new_win" href="http://members.msn.com/' . $profile['msn'] . '" title="' . $txt['msn_title'] . ' - ' . $profile['msn'] . '"><img src="' . $settings['images_url'] . '/msntalk.gif" alt="' . $txt['msn_title'] . ' - ' . $profile['msn'] . '" /></a>',
-			'link_text' => '<a class="msn new_win" href="http://members.msn.com/' . $profile['msn'] . '" title="' . $txt['msn_title'] . ' - ' . $profile['msn'] . '">' . $profile['msn'] . '</a>'
+			'href' => 'https://members.msn.com/' . $profile['msn'],
+			'link' => '<a class="msn new_win" href="https://members.msn.com/' . $profile['msn'] . '" title="' . $txt['msn_title'] . ' - ' . $profile['msn'] . '"><img src="' . $settings['images_url'] . '/msntalk.gif" alt="' . $txt['msn_title'] . ' - ' . $profile['msn'] . '" /></a>',
+			'link_text' => '<a class="msn new_win" href="https://members.msn.com/' . $profile['msn'] . '" title="' . $txt['msn_title'] . ' - ' . $profile['msn'] . '">' . $profile['msn'] . '</a>'
 		) : array('name' => '', 'href' => '', 'link' => '', 'link_text' => ''),
 		'real_posts' => $profile['posts'],
 		'posts' => $profile['posts'] > 500000 ? $txt['geek'] : comma_format($profile['posts']),
 				'avatar' => array(
 			'name' => $profile['avatar'],
-			'image' => $profile['avatar'] == '' ? ($profile['id_attach'] > 0 ? '<img class="avatar" src="' . (empty($profile['attachment_type']) ? $scripturl . '?action=dlattach;attach=' . $profile['id_attach'] . ';type=avatar' : $modSettings['custom_avatar_url'] . '/' . $profile['filename']) . '" alt="" />' : '') : (stristr($profile['avatar'], 'http://') ? '<img class="avatar" src="' . $profile['avatar'] . '"' . $avatar_width . $avatar_height . ' alt="" />' : '<img class="avatar" src="' . $modSettings['avatar_url'] . '/' . htmlspecialchars($profile['avatar']) . '" alt="" />'),
-			'href' => $profile['avatar'] == '' ? ($profile['id_attach'] > 0 ? (empty($profile['attachment_type']) ? $scripturl . '?action=dlattach;attach=' . $profile['id_attach'] . ';type=avatar' : $modSettings['custom_avatar_url'] . '/' . $profile['filename']) : '') : (stristr($profile['avatar'], 'http://') ? $profile['avatar'] : $modSettings['avatar_url'] . '/' . $profile['avatar']),
-			'url' => $profile['avatar'] == '' ? '' : (stristr($profile['avatar'], 'http://') ? $profile['avatar'] : $modSettings['avatar_url'] . '/' . $profile['avatar'])
+			'image' => $profile['avatar'] == '' ? ($profile['id_attach'] > 0 ? '<img class="avatar" src="' . (empty($profile['attachment_type']) ? $scripturl . '?action=dlattach;attach=' . $profile['id_attach'] . ';type=avatar' : $modSettings['custom_avatar_url'] . '/' . $profile['filename']) . '" alt="" />' : '') : ((stristr($profile['avatar'], 'http://') || stristr($profile['avatar'], 'https://')) ? '<img class="avatar" src="' . $profile['avatar'] . '"' . $avatar_width . $avatar_height . ' alt="" />' : '<img class="avatar" src="' . $modSettings['avatar_url'] . '/' . htmlspecialchars($profile['avatar']) . '" alt="" />'),
+			'href' => $profile['avatar'] == '' ? ($profile['id_attach'] > 0 ? (empty($profile['attachment_type']) ? $scripturl . '?action=dlattach;attach=' . $profile['id_attach'] . ';type=avatar' : $modSettings['custom_avatar_url'] . '/' . $profile['filename']) : '') : ((stristr($profile['avatar'], 'http://') || stristr($profile['avatar'], 'https://')) ? $profile['avatar'] : $modSettings['avatar_url'] . '/' . $profile['avatar']),
+			'url' => $profile['avatar'] == '' ? '' : ((stristr($profile['avatar'], 'http://') || stristr($profile['avatar'], 'https://')) ? $profile['avatar'] : $modSettings['avatar_url'] . '/' . $profile['avatar'])
 		),
 		'last_login' => empty($profile['last_login']) ? $txt['never'] : timeformat($profile['last_login']),
 		'last_login_timestamp' => empty($profile['last_login']) ? 0 : forum_time(0, $profile['last_login']),
@@ -1512,6 +1569,36 @@ function loadTheme($id_theme = 0, $initialize = true)
 	if (!$initialize)
 		return;
 
+	// Perhaps we've changed the agreement or privacy policy? Only redirect if:
+	// 1. They're not a guest or admin
+	// 2. This isn't called from SSI
+	// 3. This isn't an XML request
+	// 4. They're not trying to do any of the following actions:
+	// 4a. View or accept the agreement and/or policy
+	// 4b. Login or logout
+	// 4c. Get a feed (RSS, ATOM, etc.)
+	if (!$user_info['is_guest'] && !$user_info['is_admin'] && SMF != 'SSI' && !isset($_REQUEST['xml']) && (!isset($_REQUEST['action']) || !in_array($_REQUEST['action'], array('agreement', 'acceptagreement', 'login2', 'logout', '.xml'))))
+	{
+		$agreement_lang = !empty($modSettings['agreement_updated_' . $user_info['language']]) ? $user_info['language'] : 'default';
+		$policy_lang = !empty($modSettings['policy_' . $user_info['language']]) ? $user_info['language'] : $language;
+
+		// Do they need to accept the latest registration agreement?
+		if (!empty($modSettings['requireAgreement']) && !empty($modSettings['agreement_updated_' . $agreement_lang]) && (empty($options['agreement_accepted']) || $modSettings['agreement_updated_' . $agreement_lang] > $options['agreement_accepted']))
+		{
+			$agreement_subaction = 'agreement';
+		}
+
+		// Do they need to consent to the latest privacy policy?
+		if (!empty($modSettings['requirePolicyAgreement']) && !empty($modSettings['policy_updated_' . $policy_lang]) && (empty($options['policy_accepted']) || $modSettings['policy_updated_' . $policy_lang] > $options['policy_accepted']))
+		{
+			$agreement_subaction = !empty($agreement_subaction) ? 'both' : 'policy';
+		}
+
+		// Send them to the right place
+		if (!empty($agreement_subaction))
+			redirectexit('action=agreement;sa=' . $agreement_subaction);
+	}
+
 	// Check to see if they're accessing it from the wrong place.
 	if (isset($_SERVER['HTTP_HOST']) || isset($_SERVER['SERVER_NAME']))
 	{
@@ -1544,7 +1631,9 @@ function loadTheme($id_theme = 0, $initialize = true)
 				redirectexit('wwwRedirect');
 			else
 			{
-				list ($k, $v) = each($_GET);
+				reset($_GET);
+				$k = key($_GET);
+				$v = $_GET[$k];
 
 				if ($k != 'wwwRedirect')
 					redirectexit('wwwRedirect;' . $k . '=' . $v);
@@ -2424,6 +2513,11 @@ function loadSession()
 		// Use database sessions? (they don't work in 4.1.x!)
 		if (!empty($modSettings['databaseSession_enable']) && @version_compare(PHP_VERSION, '4.2.0') != -1)
 		{
+			@ini_set('session.serialize_handler', 'php_serialize');
+
+			if (ini_get('session.serialize_handler') != 'php_serialize')
+				@ini_set('session.serialize_handler', 'php');
+
 			session_set_save_handler('sessionOpen', 'sessionClose', 'sessionRead', 'sessionWrite', 'sessionDestroy', 'sessionGC');
 			@ini_set('session.gc_probability', '1');
 		}
@@ -2489,8 +2583,7 @@ function sessionRead($session_id)
 	list ($sess_data) = $smcFunc['db_fetch_row']($result);
 	$smcFunc['db_free_result']($result);
 
-return $sess_data;
-
+	return $sess_data != null ? $sess_data : '';
 }
 
 function sessionWrite($session_id, $data)
@@ -2521,7 +2614,7 @@ array($session_id, $data, time()),
 			array('session_id')
 		);
 
-	return $result;
+	return true;
 }
 
 function sessionDestroy($session_id)
@@ -2531,14 +2624,16 @@ function sessionDestroy($session_id)
 	if (preg_match('~^[A-Za-z0-9,-]{16,32}$~', $session_id) == 0)
 		return false;
 
-// Just delete the row...
-	return $smcFunc['db_query']('', '
+	// Just delete the row...
+	$smcFunc['db_query']('', '
 		DELETE FROM {db_prefix}sessions
 		WHERE session_id = {string:session_id}',
 		array(
 			'session_id' => $session_id,
 		)
 	);
+
+	return true;
 }
 
 function sessionGC($max_lifetime)
@@ -2550,13 +2645,15 @@ function sessionGC($max_lifetime)
 		$max_lifetime = max($modSettings['databaseSession_lifetime'], 60);
 
 	// Clean up ;).
-	return $smcFunc['db_query']('', '
+	$smcFunc['db_query']('', '
 		DELETE FROM {db_prefix}sessions
 		WHERE last_update < {int:last_update}',
 		array(
 			'last_update' => time() - $max_lifetime,
 		)
 	);
+
+	return $smcFunc['db_affected_rows']() != 0;
 }
 
 // Load up a database connection.
@@ -2776,9 +2873,16 @@ function cache_get_data($key, $ttl = 120)
 	elseif (function_exists('xcache_get') && ini_get('xcache.var_size') > 0)
 		$value = xcache_get($key);
 	// Otherwise it's SMF data!
-	elseif (file_exists($cachedir . '/data_' . $key . '.php') && filesize($cachedir . '/data_' . $key . '.php') > 10)
+	elseif (file_exists($cachedir . '/data_' . $key . '.php'))
 	{
+		// Turns out that include does not honor locking, but we need it to.
+		// This can be accomplished by placing a small wrapper around it:
+		$tmp = fopen($cachedir . '/data_' . $key . '.php', 'rb');
+		@flock($tmp, LOCK_SH);
 		@include($cachedir . '/data_' . $key . '.php');
+		@flock($tmp, LOCK_UN);
+		fclose($tmp);
+
 		if (!empty($expired) && isset($value))
 		{
 			@unlink($cachedir . '/data_' . $key . '.php');
@@ -2819,4 +2923,34 @@ function get_memcached_server($level = 3)
 		get_memcached_server($level - 1);
 }
 
-?>
\ No newline at end of file
+function get_auth_secret()
+{
+	global $auth_secret, $sourcedir;
+
+	if (empty($auth_secret))
+	{
+		// Best.
+		if (function_exists('random_bytes'))
+			$auth_secret = bin2hex(random_bytes(32));
+
+		// Equally good, if installed.
+		elseif (function_exists('mcrypt_create_iv'))
+			$auth_secret = bin2hex(mcrypt_create_iv(32));
+
+		// Good enough.
+		elseif (function_exists('openssl_random_pseudo_bytes'))
+			$auth_secret = bin2hex(openssl_random_pseudo_bytes(32));
+
+		// Less than ideal, but we're out of options.
+		else
+			$auth_secret = hash('sha256', mt_rand());
+
+		// It is important to store this in Settings.php, not the database.
+		require_once($sourcedir . '/Subs-Admin.php');
+		updateSettingsFile(array('auth_secret' => '\'' . $auth_secret . '\''));
+	}
+
+	return $auth_secret;
+}
+
+?>
diff --git a/Sources/LogInOut.php b/Sources/LogInOut.php
index a651463..c382183 100644
--- a/Sources/LogInOut.php
+++ b/Sources/LogInOut.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.13
+ * @version 2.0.14
  */
 
 if (!defined('SMF'))
@@ -139,6 +139,7 @@ function Login2()
 		redirectexit();
 
 	// Are you guessing with a script?
+	checkSession('post');
 	spamProtection('login');
 
 	// Set the login_url if it's not already set (but careful not to send us to an attachment).
@@ -352,7 +353,7 @@ function Login2()
 			$other_passwords[] = sha1($user_settings['password_salt'] . sha1($user_settings['password_salt'] . sha1($_POST['passwrd'])));
 
 			// Perhaps we converted to UTF-8 and have a valid password being hashed differently.
-			if ($context['character_set'] == 'utf8' && !empty($modSettings['previousCharacterSet']) && $modSettings['previousCharacterSet'] != 'utf8')
+			if ($context['character_set'] == 'UTF-8' && !empty($modSettings['previousCharacterSet']) && $modSettings['previousCharacterSet'] != 'utf8')
 			{
 				// Try iconv first, for no particular reason.
 				if (function_exists('iconv'))
diff --git a/Sources/ManageAttachments.php b/Sources/ManageAttachments.php
index 227afee..dae53e2 100644
--- a/Sources/ManageAttachments.php
+++ b/Sources/ManageAttachments.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -327,37 +327,36 @@ function BrowseFiles()
 					'value' => $txt['attachment_name'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $modSettings, $context, $scripturl;
-
-						$link = \'<a href="\';
+					'function' => function($rowData) use ($modSettings, $context, $scripturl)
+					{
+						$link = '<a href="';
 
 						// In case of a custom avatar URL attachments have a fixed directory.
-						if ($rowData[\'attachment_type\'] == 1)
-							$link .= sprintf(\'%1$s/%2$s\', $modSettings[\'custom_avatar_url\'], $rowData[\'filename\']);
+						if ($rowData['attachment_type'] == 1)
+							$link .= sprintf('%1$s/%2$s', $modSettings['custom_avatar_url'], $rowData['filename']);
 
 						// By default avatars are downloaded almost as attachments.
-						elseif ($context[\'browse_type\'] == \'avatars\')
-							$link .= sprintf(\'%1$s?action=dlattach;type=avatar;attach=%2$d\', $scripturl, $rowData[\'id_attach\']);
+						elseif ($context['browse_type'] == 'avatars')
+							$link .= sprintf('%1$s?action=dlattach;type=avatar;attach=%2$d', $scripturl, $rowData['id_attach']);
 
 						// Normal attachments are always linked to a topic ID.
 						else
-							$link .= sprintf(\'%1$s?action=dlattach;topic=%2$d.0;attach=%3$d\', $scripturl, $rowData[\'id_topic\'], $rowData[\'id_attach\']);
+							$link .= sprintf('%1$s?action=dlattach;topic=%2$d.0;attach=%3$d', $scripturl, $rowData['id_topic'], $rowData['id_attach']);
 
-						$link .= \'"\';
+						$link .= '"';
 
-						// Show a popup on click if it\'s a picture and we know its dimensions.
-						if (!empty($rowData[\'width\']) && !empty($rowData[\'height\']))
-							$link .= sprintf(\' onclick="return reqWin(this.href\' . ($rowData[\'attachment_type\'] == 1 ? \'\' : \' + \\\';image\\\'\') . \', %1$d, %2$d, true);"\', $rowData[\'width\'] + 20, $rowData[\'height\'] + 20);
+						// Show a popup on click if it's a picture and we know its dimensions.
+						if (!empty($rowData['width']) && !empty($rowData['height']))
+							$link .= sprintf(' onclick="return reqWin(this.href' . ($rowData['attachment_type'] == 1 ? '' : '+ \';image\'') . ', %1$d, %2$d, true);"', $rowData['width'] + 20, $rowData['height'] + 20);
 
-						$link .= sprintf(\'>%1$s</a>\', preg_replace(\'~&amp;#(\\\\d{1,7}|x[0-9a-fA-F]{1,6});~\', \'&#\\\\1;\', htmlspecialchars($rowData[\'filename\'])));
+						$link .= sprintf('>%1$s</a>', preg_replace('~&amp;#(\\\\d{1,7}|x[0-9a-fA-F]{1,6});~', '&#\\\\1;', htmlspecialchars($rowData['filename'])));
 
 						// Show the dimensions.
-						if (!empty($rowData[\'width\']) && !empty($rowData[\'height\']))
-							$link .= sprintf(\' <span class="smalltext">%1$dx%2$d</span>\', $rowData[\'width\'], $rowData[\'height\']);
+						if (!empty($rowData['width']) && !empty($rowData['height']))
+							$link .= sprintf(' <span class="smalltext">%1$dx%2$d</span>', $rowData['width'], $rowData['height']);
 
 						return $link;
-					'),
+					},
 				),
 				'sort' => array(
 					'default' => 'a.filename',
@@ -369,11 +368,10 @@ function BrowseFiles()
 					'value' => $txt['attachment_file_size'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData','
-						global $txt;
-
-						return sprintf(\'%1$s%2$s\', round($rowData[\'size\'] / 1024, 2), $txt[\'kilobyte\']);
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return sprintf('%1$s%2$s', round($rowData['size'] / 1024, 2), $txt['kilobyte']);
+					},
 					'class' => 'windowbg',
 				),
 				'sort' => array(
@@ -386,17 +384,16 @@ function BrowseFiles()
 					'value' => $context['browse_type'] == 'avatars' ? $txt['attachment_manager_member'] : $txt['posted_by'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl;
-
+					'function' => function($rowData) use ($scripturl)
+					{
 						// In case of an attachment, return the poster of the attachment.
-						if (empty($rowData[\'id_member\']))
-							return htmlspecialchars($rowData[\'poster_name\']);
+						if (empty($rowData['id_member']))
+							return htmlspecialchars($rowData['poster_name']);
 
 						// Otherwise it must be an avatar, return the link to the owner of it.
 						else
-							return sprintf(\'<a href="%1$s?action=profile;u=%2$d">%3$s</a>\', $scripturl, $rowData[\'id_member\'], $rowData[\'poster_name\']);
-					'),
+							return sprintf('<a href="%1$s?action=profile;u=%2$d">%3$s</a>', $scripturl, $rowData['id_member'], $rowData['poster_name']);
+					},
 				),
 				'sort' => array(
 					'default' => 'mem.real_name',
@@ -408,18 +405,17 @@ function BrowseFiles()
 					'value' => $context['browse_type'] == 'avatars' ? $txt['attachment_manager_last_active'] : $txt['date'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt, $context, $scripturl;
-
+					'function' => function($rowData) use ($txt, $context, $scripturl)
+					{
 						// The date the message containing the attachment was posted or the owner of the avatar was active.
-						$date = empty($rowData[\'poster_time\']) ? $txt[\'never\'] : timeformat($rowData[\'poster_time\']);
+						$date = empty($rowData['poster_time']) ? $txt['never'] : timeformat($rowData['poster_time']);
 
 						// Add a link to the topic in case of an attachment.
-						if ($context[\'browse_type\'] !== \'avatars\')
-							$date .= sprintf(\'<br />%1$s <a href="%2$s?topic=%3$d.msg%4$d#msg%4$d">%5$s</a>\', $txt[\'in\'], $scripturl, $rowData[\'id_topic\'], $rowData[\'id_msg\'], $rowData[\'subject\']);
+						if ($context['browse_type'] !== 'avatars')
+							$date .= sprintf('<br />%1$s <a href="%2$s?topic=%3$d.msg%4$d#msg%4$d">%5$s</a>', $txt['in'], $scripturl, $rowData['id_topic'], $rowData['id_msg'], $rowData['subject']);
 
 						return $date;
-						'),
+					},
 					'class' => 'windowbg',
 				),
 				'sort' => array(
@@ -432,11 +428,10 @@ function BrowseFiles()
 					'value' => $txt['downloads'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData','
-						global $txt;
-
-						return comma_format($rowData[\'downloads\']);
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return comma_format($rowData['downloads']);
+					},
 					'class' => 'windowbg',
 				),
 				'sort' => array(
@@ -1673,9 +1668,10 @@ function ManageAttachmentPaths()
 					'value' => $txt['attach_current_dir'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return \'<input type="radio" name="current_dir" value="\' . $rowData[\'id\'] . \'" \' . ($rowData[\'current\'] ? \'checked="checked"\' : \'\') . \' class="input_radio" />\';
-					'),
+					'function' => function($rowData)
+					{
+						return '<input type="radio" name="current_dir" value="' . $rowData['id'] . '" ' . ($rowData['current'] ? 'checked="checked"' : '') . ' class="input_radio" />';
+					},
 					'style' => 'text-align: center; width: 15%;',
 				),
 			),
@@ -1684,9 +1680,10 @@ function ManageAttachmentPaths()
 					'value' => $txt['attach_path'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return \'<input type="text" size="30" name="dirs[\' . $rowData[\'id\'] . \']" value="\' . $rowData[\'path\'] . \'" class="input_text" style="width: 100%" />\';
-					'),
+					'function' => function($rowData)
+					{
+						return '<input type="text" size="30" name="dirs[' . $rowData['id'] . ']" value="' . $rowData['path'] . '" class="input_text" style="width: 100%" />';
+					},
 					'style' => 'text-align: center; width: 30%;',
 				),
 			),
diff --git a/Sources/ManageBans.php b/Sources/ManageBans.php
index 48e38d9..0f97daa 100644
--- a/Sources/ManageBans.php
+++ b/Sources/ManageBans.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -240,11 +240,10 @@ function BanList()
 					'value' => $txt['ban_added'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context;
-
-						return timeformat($rowData[\'ban_time\'], empty($context[\'ban_time_format\']) ? true : $context[\'ban_time_format\']);
-					'),
+					'function' => function($rowData) use ($context)
+					{
+						return timeformat($rowData['ban_time'], empty($context['ban_time_format']) ? true : $context['ban_time_format']);
+					},
 				),
 				'sort' => array(
 					'default' => 'bg.ban_time',
@@ -256,21 +255,20 @@ function BanList()
 					'value' => $txt['ban_expires'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
+					'function' => function($rowData) use ($txt)
+					{
 						// This ban never expires...whahaha.
-						if ($rowData[\'expire_time\'] === null)
-							return $txt[\'never\'];
+						if ($rowData['expire_time'] === null)
+							return $txt['never'];
 
 						// This ban has already expired.
-						elseif ($rowData[\'expire_time\'] < time())
-							return sprintf(\'<span style="color: red">%1$s</span>\', $txt[\'ban_expired\']);
+						elseif ($rowData['expire_time'] < time())
+							return sprintf('<span style="color: red">%1$s</span>', $txt['ban_expired']);
 
 						// Still need to wait a few days for this ban to expire.
 						else
-							return sprintf(\'%1$d&nbsp;%2$s\', ceil(($rowData[\'expire_time\'] - time()) / (60 * 60 * 24)), $txt[\'ban_days\']);
-					'),
+							return sprintf('%1$d&nbsp;%2$s', ceil(($rowData['expire_time'] - time()) / (60 * 60 * 24)), $txt['ban_days']);
+					},
 				),
 				'sort' => array(
 					'default' => 'IFNULL(bg.expire_time, 1=1) DESC, bg.expire_time DESC',
@@ -1216,19 +1214,20 @@ function BanBrowseTriggers()
 	if ($context['selected_entity'] === 'ip')
 	{
 		$listOptions['columns']['banned_entity']['data'] = array(
-			'function' => create_function('$rowData', '
+			'function' => function($rowData)
+			{
 				return range2ip(array(
-					$rowData[\'ip_low1\'],
-					$rowData[\'ip_low2\'],
-					$rowData[\'ip_low3\'],
-					$rowData[\'ip_low4\']
+					$rowData['ip_low1'],
+					$rowData['ip_low2'],
+					$rowData['ip_low3'],
+					$rowData['ip_low4']
 				), array(
-					$rowData[\'ip_high1\'],
-					$rowData[\'ip_high2\'],
-					$rowData[\'ip_high3\'],
-					$rowData[\'ip_high4\']
+					$rowData['ip_high1'],
+					$rowData['ip_high2'],
+					$rowData['ip_high3'],
+					$rowData['ip_high4']
 				));
-			'),
+			},
 		);
 		$listOptions['columns']['banned_entity']['sort'] = array(
 			'default' => 'bi.ip_low1, bi.ip_high1, bi.ip_low2, bi.ip_high2, bi.ip_low3, bi.ip_high3, bi.ip_low4, bi.ip_high4',
@@ -1238,10 +1237,10 @@ function BanBrowseTriggers()
 	elseif ($context['selected_entity'] === 'hostname')
 	{
 		$listOptions['columns']['banned_entity']['data'] = array(
-			'function' => create_function('$rowData', '
-				global $smcFunc;
-				return strtr($smcFunc[\'htmlspecialchars\']($rowData[\'hostname\']), array(\'%\' => \'*\'));
-			'),
+			'function' => function($rowData) use ($smcFunc)
+			{
+				return strtr($smcFunc['htmlspecialchars']($rowData['hostname']), array('%' => '*'));
+			},
 		);
 		$listOptions['columns']['banned_entity']['sort'] = array(
 			'default' => 'bi.hostname',
@@ -1251,10 +1250,10 @@ function BanBrowseTriggers()
 	elseif ($context['selected_entity'] === 'email')
 	{
 		$listOptions['columns']['banned_entity']['data'] = array(
-			'function' => create_function('$rowData', '
-				global $smcFunc;
-				return strtr($smcFunc[\'htmlspecialchars\']($rowData[\'email_address\']), array(\'%\' => \'*\'));
-			'),
+			'function' => function($rowData) use ($smcFunc)
+			{
+				return strtr($smcFunc['htmlspecialchars']($rowData['email_address']), array('%' => '*'));
+			},
 		);
 		$listOptions['columns']['banned_entity']['sort'] = array(
 			'default' => 'bi.email_address',
@@ -1445,9 +1444,10 @@ function BanLog()
 					'value' => $txt['ban_log_date'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return timeformat($rowData[\'log_time\']);
-					'),
+					'function' => function($rowData)
+					{
+						return timeformat($rowData['log_time']);
+					},
 				),
 				'sort' => array(
 					'default' => 'lb.log_time DESC',
diff --git a/Sources/ManageCalendar.php b/Sources/ManageCalendar.php
index a2ae4f3..96f738a 100644
--- a/Sources/ManageCalendar.php
+++ b/Sources/ManageCalendar.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -111,15 +111,14 @@ function ModifyHolidays()
 					'value' => $txt['date'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
+					'function' => function($rowData) use ($txt)
+					{
 						// Recurring every year or just a single year?
-						$year = $rowData[\'year\'] == \'0004\' ? sprintf(\'(%1$s)\', $txt[\'every_year\']) : $rowData[\'year\'];
+						$year = $rowData['year'] == '0004' ? sprintf('(%1$s)', $txt['every_year']) : $rowData['year'];
 
 						// Construct the date.
-						return sprintf(\'%1$d %2$s %3$s\', $rowData[\'day\'], $txt[\'months\'][(int) $rowData[\'month\']], $year);
-					'),
+						return sprintf('%1$d %2$s %3$s', $rowData['day'], $txt['months'][(int) $rowData['month']], $year);
+					},
 					'class' => 'windowbg',
 				),
 				'sort' => array(
diff --git a/Sources/ManageErrors.php b/Sources/ManageErrors.php
index 93fc9bd..47c4ed4 100644
--- a/Sources/ManageErrors.php
+++ b/Sources/ManageErrors.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.4
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -126,7 +126,7 @@ function ViewErrorLog()
 	for ($i = 0; $row = $smcFunc['db_fetch_assoc']($request); $i ++)
 	{
 		$search_message = preg_replace('~&lt;span class=&quot;remove&quot;&gt;(.+?)&lt;/span&gt;~', '%', $smcFunc['db_escape_wildcard_string']($row['message']));
-		if ($search_message == $filter['value']['sql'])
+		if (isset($filter) && $search_message == $filter['value']['sql'])
 			$search_message = $smcFunc['db_escape_wildcard_string']($row['message']);
 		$show_message = strtr(strtr(preg_replace('~&lt;span class=&quot;remove&quot;&gt;(.+?)&lt;/span&gt;~', '$1', $row['message']), array("\r" => '', '<br />' => "\n", '<' => '&lt;', '>' => '&gt;', '"' => '&quot;')), array("\n" => '<br />'));
 
diff --git a/Sources/ManageMail.php b/Sources/ManageMail.php
index 9b8b027..f325259 100644
--- a/Sources/ManageMail.php
+++ b/Sources/ManageMail.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -121,10 +121,10 @@ function BrowseMailQueue()
 					'value' => $txt['mailqueue_subject'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $smcFunc;
-						return $smcFunc[\'strlen\']($rowData[\'subject\']) > 50 ? sprintf(\'%1$s...\', htmlspecialchars($smcFunc[\'substr\']($rowData[\'subject\'], 0, 47))) : htmlspecialchars($rowData[\'subject\']);
-					'),
+					'function' => function($rowData) use ($smcFunc)
+					{
+						return $smcFunc['strlen']($rowData['subject']) > 50 ? sprintf('%1$s...', $smcFunc['htmlspecialchars']($smcFunc['substr']($rowData['subject'], 0, 47))) : $smcFunc['htmlspecialchars']($rowData['subject']);
+					},
 					'class' => 'smalltext',
 				),
 				'sort' => array(
@@ -155,15 +155,14 @@ function BrowseMailQueue()
 					'value' => $txt['mailqueue_priority'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
+					'function' => function($rowData) use ($txt)
+					{
 						// We probably have a text label with your priority.
-						$txtKey = sprintf(\'mq_mpriority_%1$s\', $rowData[\'priority\']);
+						$txtKey = sprintf('mq_mpriority_%1$s', $rowData['priority']);
 
 						// But if not, revert to priority 0.
-						return isset($txt[$txtKey]) ? $txt[$txtKey] : $txt[\'mq_mpriority_1\'];
-					'),
+						return isset($txt[$txtKey]) ? $txt[$txtKey] : $txt['mq_mpriority_1'];
+					},
 					'class' => 'smalltext',
 				),
 				'sort' => array(
@@ -176,9 +175,10 @@ function BrowseMailQueue()
 					'value' => $txt['mailqueue_age'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return time_since(time() - $rowData[\'time_sent\']);
-					'),
+					'function' => function($rowData)
+					{
+						return time_since(time() - $rowData['time_sent']);
+					},
 					'class' => 'smalltext',
 				),
 				'sort' => array(
@@ -191,9 +191,10 @@ function BrowseMailQueue()
 					'value' => '<input type="checkbox" onclick="invertAll(this, this.form);" class="input_check" />',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return \'<input type="checkbox" name="delete[]" value="\' . $rowData[\'id_mail\'] . \'" class="input_check" />\';
-					'),
+					'function' => function($rowData)
+					{
+						return '<input type="checkbox" name="delete[]" value="' . $rowData['id_mail'] . '">';
+					},
 					'class' => 'smalltext',
 				),
 			),
diff --git a/Sources/ManageMaintenance.php b/Sources/ManageMaintenance.php
index 634206a..8caa2ad 100644
--- a/Sources/ManageMaintenance.php
+++ b/Sources/ManageMaintenance.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.7
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -778,11 +778,6 @@ function ConvertEntities()
 	);
 	$context['num_tables'] = count($tables);
 
-	// This function will do the conversion later on.
-	$entity_replace = create_function('$string', '
-		$num = substr($string, 0, 1) === \'x\' ? hexdec(substr($string, 1)) : (int) $string;
-		return $num < 0x20 || $num > 0x10FFFF || ($num >= 0xD800 && $num <= 0xDFFF) ? \'\' : ($num < 0x80 ? \'&#\' . $num . \';\' : ($num < 0x800 ? chr(192 | $num >> 6) . chr(128 | $num & 63) : ($num < 0x10000 ? chr(224 | $num >> 12) . chr(128 | $num >> 6 & 63) . chr(128 | $num & 63) : chr(240 | $num >> 18) . chr(128 | $num >> 12 & 63) . chr(128 | $num >> 6 & 63) . chr(128 | $num & 63))));');
-
 	// Loop through all tables that need converting.
 	for (; $context['table'] < $context['num_tables']; $context['table']++)
 	{
@@ -830,20 +825,20 @@ function ConvertEntities()
 		if (empty($primary_key) || empty($columns))
 			continue;
 
-		// Get the maximum value for the primary key.
+		// Get the count of records.
 		$request = $smcFunc['db_query']('', '
-			SELECT MAX(' . $primary_key . ')
+			SELECT COUNT(*)
 			FROM {db_prefix}' . $cur_table,
 			array(
 			)
 		);
-		list($max_value) = $smcFunc['db_fetch_row']($request);
+		list($rec_count) = $smcFunc['db_fetch_row']($request);
 		$smcFunc['db_free_result']($request);
 
-		if (empty($max_value))
+		if (empty($rec_count))
 			continue;
 
-		while ($context['start'] <= $max_value)
+		while ($context['start'] <= $rec_count)
 		{
 			// Retrieve a list of rows that has at least one entity to convert.
 			$request = $smcFunc['db_query']('', '
@@ -869,7 +864,7 @@ function ConvertEntities()
 					if ($column_name !== $primary_key && strpos($column_value, '&#') !== false)
 					{
 						$changes[] = $column_name . ' = {string:changes_' . $column_name . '}';
-						$insertion_variables['changes_' . $column_name] = preg_replace_callback('~&#(\d{1,7}|x[0-9a-fA-F]{1,6});~', 'fixchar__callback', $column_value);
+						$insertion_variables['changes_' . $column_name] = preg_replace_callback('~&#(\d{1,7}|x[0-9a-fA-F]{1,6});~', 'fixchardb__callback', $column_value);
 					}
 
 				$where = array();
@@ -897,7 +892,7 @@ function ConvertEntities()
 			if (time() - $context['start_time'] > 10)
 			{
 				// Calculate an approximation of the percentage done.
-				$context['continue_percent'] = round(100 * ($context['table'] + ($context['start'] / $max_value)) / $context['num_tables'], 1);
+				$context['continue_percent'] = round(100 * ($context['table'] + ($context['start'] / $rec_count)) / $context['num_tables'], 1);
 				$context['continue_get_data'] = '?action=admin;area=maintain;sa=database;activity=convertentities;table=' . $context['table'] . ';start=' . $context['start'] . ';' . $context['session_var'] . '=' . $context['session_id'];
 				return;
 			}
diff --git a/Sources/ManageMembergroups.php b/Sources/ManageMembergroups.php
index 80f64e5..80067ec 100644
--- a/Sources/ManageMembergroups.php
+++ b/Sources/ManageMembergroups.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.7
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -131,26 +131,25 @@ function MembergroupIndex()
 					'value' => $txt['membergroups_name'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl;
-
+					'function' => function($rowData) use ($scripturl)
+					{
 						// Since the moderator group has no explicit members, no link is needed.
-						if ($rowData[\'id_group\'] == 3)
-							$group_name = $rowData[\'group_name\'];
+						if ($rowData['id_group'] == 3)
+							$group_name = $rowData['group_name'];
 						else
 						{
-							$color_style = empty($rowData[\'online_color\']) ? \'\' : sprintf(\' style="color: %1$s;"\', $rowData[\'online_color\']);
-							$group_name = sprintf(\'<a href="%1$s?action=admin;area=membergroups;sa=members;group=%2$d"%3$s>%4$s</a>\', $scripturl, $rowData[\'id_group\'], $color_style, $rowData[\'group_name\']);
+							$color_style = empty($rowData['online_color']) ? '' : sprintf(' style="color: %1$s;"', $rowData['online_color']);
+							$group_name = sprintf('<a href="%1$s?action=admin;area=membergroups;sa=members;group=%2$d"%3$s>%4$s</a>', $scripturl, $rowData['id_group'], $color_style, $rowData['group_name']);
 						}
 
 						// Add a help option for moderator and administrator.
-						if ($rowData[\'id_group\'] == 1)
-							$group_name .= sprintf(\' (<a href="%1$s?action=helpadmin;help=membergroup_administrator" onclick="return reqWin(this.href);">?</a>)\', $scripturl);
-						elseif ($rowData[\'id_group\'] == 3)
-							$group_name .= sprintf(\' (<a href="%1$s?action=helpadmin;help=membergroup_moderator" onclick="return reqWin(this.href);">?</a>)\', $scripturl);
+						if ($rowData['id_group'] == 1)
+							$group_name .= sprintf(' (<a href="%1$s?action=helpadmin;help=membergroup_administrator" onclick="return reqWin(this.href);">?</a>)', $scripturl);
+						elseif ($rowData['id_group'] == 3)
+							$group_name .= sprintf(' (<a href="%1$s?action=helpadmin;help=membergroup_moderator" onclick="return reqWin(this.href);">?</a>)', $scripturl);
 
 						return $group_name;
-					'),
+					},
 				),
 				'sort' => array(
 					'default' => 'CASE WHEN id_group < 4 THEN id_group ELSE 4 END, group_name',
@@ -162,23 +161,21 @@ function MembergroupIndex()
 					'value' => $txt['membergroups_stars'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $settings;
-
-						$stars = explode(\'#\', $rowData[\'stars\']);
+					'function' => function($rowData) use ($settings)
+					{
+						$stars = explode('#', $rowData['stars']);
 
 						// In case no stars are setup, return with nothing
 						if (empty($stars[0]) || empty($stars[1]))
-							return \'\';
+							return '';
 
 						// Otherwise repeat the image a given number of times.
 						else
 						{
-							$image = sprintf(\'<img src="%1$s/%2$s" alt="*" />\', $settings[\'images_url\'], $stars[1]);
+							$image = sprintf('<img src="%1$s/%2$s" alt="*" />', $settings['images_url'], $stars[1]);
 							return str_repeat($image, $stars[0]);
 						}
-					'),
-
+					},
 				),
 				'sort' => array(
 					'default' => 'stars',
@@ -190,12 +187,11 @@ function MembergroupIndex()
 					'value' => $txt['membergroups_members_top'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
+					'function' => function($rowData) use ($txt)
+					{
 						// No explicit members for the moderator group.
-						return $rowData[\'id_group\'] == 3 ? $txt[\'membergroups_guests_na\'] : $rowData[\'num_members\'];
-					'),
+						return $rowData['id_group'] == 3 ? $txt['membergroups_guests_na'] : $rowData['num_members'];
+					},
 					'style' => 'text-align: center',
 				),
 				'sort' => array(
@@ -252,12 +248,11 @@ function MembergroupIndex()
 					'value' => $txt['membergroups_name'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl;
-
-						$colorStyle = empty($rowData[\'online_color\']) ? \'\' : sprintf(\' style="color: %1$s;"\', $rowData[\'online_color\']);
-						return sprintf(\'<a href="%1$s?action=moderate;area=viewgroups;sa=members;group=%2$d"%3$s>%4$s</a>\', $scripturl, $rowData[\'id_group\'], $colorStyle, $rowData[\'group_name\']);
-					'),
+					'function' => function($rowData) use ($scripturl)
+					{
+						$colorStyle = empty($rowData['online_color']) ? '' : sprintf(' style="color: %1$s;"', $rowData['online_color']);
+						return sprintf('<a href="%1$s?action=moderate;area=viewgroups;sa=members;group=%2$d"%3$s>%4$s</a>', $scripturl, $rowData['id_group'], $colorStyle, $rowData['group_name']);
+					},
 				),
 				'sort' => array(
 					'default' => 'group_name',
@@ -269,19 +264,18 @@ function MembergroupIndex()
 					'value' => $txt['membergroups_stars'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $settings;
-
-						$stars = explode(\'#\', $rowData[\'stars\']);
+					'function' => function($rowData) use ($settings)
+					{
+						$stars = explode('#', $rowData['stars']);
 
 						if (empty($stars[0]) || empty($stars[1]))
-							return \'\';
+							return '';
 						else
 						{
-							$star_image = sprintf(\'<img src="%1$s/%2$s" alt="*" />\', $settings[\'images_url\'], $stars[1]);
+							$star_image = sprintf('<img src="%1$s/%2$s" alt="*" />', $settings['images_url'], $stars[1]);
 							return str_repeat($star_image, $stars[0]);
 						}
-					'),
+					},
 				),
 				'sort' => array(
 					'default' => 'CASE WHEN id_group < 4 THEN id_group ELSE 4 END, stars',
diff --git a/Sources/ManageMembers.php b/Sources/ManageMembers.php
index 6d34cf4..4823b94 100644
--- a/Sources/ManageMembers.php
+++ b/Sources/ManageMembers.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.11
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -198,8 +198,18 @@ function ViewMemberlist()
 		}
 	}
 
-	if ($context['sub_action'] == 'query' && !empty($_REQUEST['params']) && empty($_POST))
-		$_POST += safe_unserialize(base64_decode($_REQUEST['params']));
+	if ($context['sub_action'] == 'query' && empty($_POST))
+	{
+		if (!empty($_REQUEST['params']))
+		{
+			$_POST += safe_unserialize(base64_decode($_REQUEST['params']));
+		}
+		elseif ($context['browser']['is_ie'] && !empty($_SESSION['params']))
+		{
+			$_POST += $_SESSION['params'];
+			unset($_SESSION['params']);
+		}
+	}
 
 	// Check input after a member search has been submitted.
 	if ($context['sub_action'] == 'query')
@@ -424,7 +434,14 @@ function ViewMemberlist()
 		$where = empty($query_parts) ? '1' : implode('
 			AND ', $query_parts);
 
-		$search_params = base64_encode(serialize($_POST));
+		if ($context['browser']['is_ie'])
+		{
+			// Cache the results in the session and avoid IE's 2083 character limit.
+			$_SESSION['params'] = $_POST;
+			$search_params = null;
+		}
+		else
+			$search_params = base64_encode(serialize($_POST));
 	}
 	else
 		$search_params = null;
@@ -547,35 +564,34 @@ function ViewMemberlist()
 					'value' => $txt['viewmembers_online'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
+					'function' => function($rowData) use ($txt)
+					{
 						// Calculate number of days since last online.
-						if (empty($rowData[\'last_login\']))
-							$difference = $txt[\'never\'];
+						if (empty($rowData['last_login']))
+							$difference = $txt['never'];
 						else
 						{
-							$num_days_difference = jeffsdatediff($rowData[\'last_login\']);
+							$num_days_difference = jeffsdatediff($rowData['last_login']);
 
 							// Today.
 							if (empty($num_days_difference))
-								$difference = $txt[\'viewmembers_today\'];
+								$difference = $txt['viewmembers_today'];
 
 							// Yesterday.
 							elseif ($num_days_difference == 1)
-								$difference = sprintf(\'1 %1$s\', $txt[\'viewmembers_day_ago\']);
+								$difference = sprintf('1 %1$s', $txt['viewmembers_day_ago']);
 
 							// X days ago.
 							else
-								$difference = sprintf(\'%1$d %2$s\', $num_days_difference, $txt[\'viewmembers_days_ago\']);
+								$difference = sprintf('%1$d %2$s', $num_days_difference, $txt['viewmembers_days_ago']);
 						}
 
-						// Show it in italics if they\'re not activated...
-						if ($rowData[\'is_activated\'] % 10 != 1)
-							$difference = sprintf(\'<em title="%1$s">%2$s</em>\', $txt[\'not_activated\'], $difference);
+						// Show it in italics if they're not activated...
+						if ($rowData['is_activated'] % 10 != 1)
+							$difference = sprintf('<em title="%1$s">%2$s</em>', $txt['not_activated'], $difference);
 
 						return $difference;
-					'),
+					},
 				),
 				'sort' => array(
 					'default' => 'last_login DESC',
@@ -599,11 +615,10 @@ function ViewMemberlist()
 					'value' => '<input type="checkbox" onclick="invertAll(this, this.form);" class="input_check" />',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $user_info;
-
-						return \'<input type="checkbox" name="delete[]" value="\' . $rowData[\'id_member\'] . \'" class="input_check" \' . ($rowData[\'id_member\'] == $user_info[\'id\'] || $rowData[\'id_group\'] == 1 || in_array(1, explode(\',\', $rowData[\'additional_groups\'])) ? \'disabled="disabled"\' : \'\') . \' />\';
-					'),
+					'function' => function($rowData) use ($user_info)
+					{
+						return '<input type="checkbox" name="delete[]" value="' . $rowData['id_member'] . '" class="input_check" ' . ($rowData['id_member'] == $user_info['id'] || $rowData['id_group'] == 1 || in_array(1, explode(',', $rowData['additional_groups'])) ? 'disabled="disabled"' : '') . ' />';
+					},
 					'class' => 'windowbg',
 					'style' => 'text-align: center',
 				),
@@ -893,11 +908,10 @@ function MembersAwaitingActivation()
 					'value' => $txt['hostname'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $modSettings;
-
-						return host_from_ip($rowData[\'member_ip\']);
-					'),
+					'function' => function($rowData)
+					{
+						return host_from_ip($rowData['member_ip']);
+					},
 					'class' => 'smalltext',
 				),
 			),
@@ -906,9 +920,10 @@ function MembersAwaitingActivation()
 					'value' => $txt['date_registered'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return timeformat($rowData[\'date_registered\']);
-					'),
+					'function' => function($rowData)
+					{
+						return timeformat($rowData['date_registered']);
+					},
 				),
 				'sort' => array(
 					'default' => 'date_registered DESC',
@@ -922,19 +937,18 @@ function MembersAwaitingActivation()
 					'style' => 'width: 20%',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl, $txt;
-
+					'function' => function($rowData) use ($scripturl, $txt)
+					{
 						$member_links = array();
-						foreach ($rowData[\'duplicate_members\'] as $member)
+						foreach ($rowData['duplicate_members'] as $member)
 						{
-							if ($member[\'id\'])
-								$member_links[] = \'<a href="\' . $scripturl . \'?action=profile;u=\' . $member[\'id\'] . \'" \' . (!empty($member[\'is_banned\']) ? \'style="color: red;"\' : \'\') . \'>\' . $member[\'name\'] . \'</a>\';
+							if ($member['id'])
+								$member_links[] = '<a href="' . $scripturl . '?action=profile;u=' . $member['id'] . '" ' . (!empty($member['is_banned']) ? 'style="color: red;"' : '') . '>' . $member['name'] . '</a>';
 							else
-								$member_links[] = $member[\'name\'] . \' (\' . $txt[\'guest\'] . \')\';
+								$member_links[] = $member['name'] . ' (' . $txt['guest'] . ')';
 						}
-						return implode (\', \', $member_links);
-					'),
+						return implode (', ', $member_links);
+					},
 					'class' => 'smalltext',
 				),
 			),
diff --git a/Sources/ManageNews.php b/Sources/ManageNews.php
index 8d0eb8b..04c74f6 100644
--- a/Sources/ManageNews.php
+++ b/Sources/ManageNews.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.10
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -520,13 +520,13 @@ function SendMailing($clean_only = false)
 		}
 	}
 	// Finally - emails!
-	if (!empty($_POST['emails']))
+	if (!empty($_POST['emails']) && empty($modSettings['force_gdpr']))
 	{
 		$addressed = array_unique(explode(';', strtr($_POST['emails'], array("\n" => ';', "\r" => ';', ',' => ';'))));
 		foreach ($addressed as $curmem)
 		{
 			$curmem = trim($curmem);
-			if ($curmem != '' && preg_match('~^[0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $curmem) !== 0)
+			if ($curmem != '' && filter_var($curmem, FILTER_VALIDATE_EMAIL) !== false)
 				$context['recipients']['emails'][$curmem] = $curmem;
 		}
 	}
@@ -541,6 +541,14 @@ function SendMailing($clean_only = false)
 	$context['subject'] = htmlspecialchars($_POST['subject']);
 	$context['message'] = htmlspecialchars($_POST['message']);
 
+	// Include an unsubscribe link if necessary.
+	if (!$context['send_pm'] && !empty($modSettings['notify_tokens']))
+	{
+		require_once($sourcedir . '/Notify.php');
+		$include_unsubscribe = true;
+		$_POST['message'] .= "\n\n" . '{$member.unsubscribe}';
+	}
+
 	// Prepare the message for sending it as HTML
 	if (!$context['send_pm'] && !empty($_POST['send_html']))
 	{
@@ -594,7 +602,8 @@ function SendMailing($clean_only = false)
 		'{$member.email}',
 		'{$member.link}',
 		'{$member.id}',
-		'{$member.name}'
+		'{$member.name}',
+		'{$member.unsubscribe}',
 	);
 
 	// If we still have emails, do them first!
@@ -612,11 +621,15 @@ function SendMailing($clean_only = false)
 		if ($context['send_pm'])
 			continue;
 
+		// Non-members can't subscribe or unsubscribe from anything...
+		$unsubscribe_link = '';
+
 		$to_member = array(
 			$email,
 			!empty($_POST['send_html']) ? '<a href="mailto:' . $email . '">' . $email . '</a>' : $email,
 			'??',
-			$email
+			$email,
+			$unsubscribe_link,
 		);
 
 		sendmail($email, str_replace($from_member, $to_member, $_POST['subject']), str_replace($from_member, $to_member, $_POST['message']), null, null, !empty($_POST['send_html']), 5);
@@ -671,7 +684,7 @@ function SendMailing($clean_only = false)
 		}
 
 		// Force them to have it?
-		if (empty($context['email_force']))
+		if (empty($context['email_force']) || !empty($modSettings['force_gdpr']))
 			$sendQuery .= ' AND mem.notify_announcements = {int:notify_announcements}';
 
 		// Get the smelly people - note we respect the id_member range as it gives us a quicker query.
@@ -714,6 +727,14 @@ function SendMailing($clean_only = false)
 			// We might need this
 			$cleanMemberName = empty($_POST['send_html']) || $context['send_pm'] ? un_htmlspecialchars($row['real_name']) : $row['real_name'];
 
+			if (!empty($include_unsubscribe))
+			{
+				$token = createUnsubscribeToken($row['id_member'], $row['email_address'], 'announcements');
+				$unsubscribe_link = sprintf($txt['unsubscribe_announcements_' . (!empty($_POST['send_html']) ? 'html' : 'plain')], $scripturl . '?action=notifyannouncements;u=' . $row['id_member'] . ';token=' . $token);
+			}
+			else
+				$unsubscribe_link = '';
+
 			// Replace the member-dependant variables
 			$message = str_replace($from_member,
 				array(
@@ -721,6 +742,7 @@ function SendMailing($clean_only = false)
 					!empty($_POST['send_html']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '">' . $cleanMemberName . '</a>' : ($context['send_pm'] ? '[url=' . $scripturl . '?action=profile;u=' . $row['id_member'] . ']' . $cleanMemberName . '[/url]' : $cleanMemberName),
 					$row['id_member'],
 					$cleanMemberName,
+					$unsubscribe_link,
 				), $_POST['message']);
 
 			$subject = str_replace($from_member,
diff --git a/Sources/ManagePaid.php b/Sources/ManagePaid.php
index 5e4443b..2ed869b 100644
--- a/Sources/ManagePaid.php
+++ b/Sources/ManagePaid.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -237,16 +237,16 @@ function ViewSubscriptions()
 		'items_per_page' => 20,
 		'base_href' => $scripturl . '?action=admin;area=paidsubscribe;sa=view',
 		'get_items' => array(
-			'function' => create_function('', '
-				global $context;
-				return $context[\'subscriptions\'];
-			'),
+			'function' => function() use ($context)
+			{
+				return $context['subscriptions'];
+			},
 		),
 		'get_count' => array(
-			'function' => create_function('', '
-				global $context;
-				return count($context[\'subscriptions\']);
-			'),
+			'function' => function() use ($context)
+			{
+				return count($context['subscriptions']);
+			},
 		),
 		'no_items_label' => $txt['paid_none_yet'],
 		'columns' => array(
@@ -256,11 +256,10 @@ function ViewSubscriptions()
 					'style' => 'text-align: left; width: 35%;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl;
-
-						return sprintf(\'<a href="%1$s?action=admin;area=paidsubscribe;sa=viewsub;sid=%2$s">%3$s</a>\', $scripturl, $rowData[\'id\'], $rowData[\'name\']);
-					'),
+					'function' => function($rowData) use ($scripturl)
+					{
+						return sprintf('<a href="%1$s?action=admin;area=paidsubscribe;sa=viewsub;sid=%2$s">%3$s</a>', $scripturl, $rowData['id'], $rowData['name']);
+					},
 				),
 			),
 			'cost' => array(
@@ -269,11 +268,10 @@ function ViewSubscriptions()
 					'style' => 'text-align: left;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt;
-
-						return $rowData[\'flexible\'] ? \'<em>\' . $txt[\'flexible\'] . \'</em>\' : $rowData[\'cost\'] . \' / \' . $rowData[\'length\'];
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return $rowData['flexible'] ? '<em>' . $txt['flexible'] . '</em>' : $rowData['cost'] . ' / ' . $rowData['length'];
+					},
 				),
 			),
 			'pending' => array(
@@ -309,31 +307,28 @@ function ViewSubscriptions()
 					'value' => $txt['paid_is_active'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt;
-
-						return \'<span style="color: \' . ($rowData[\'active\'] ? \'green\' : \'red\') . \'">\' . ($rowData[\'active\'] ? $txt[\'yes\'] : $txt[\'no\']) . \'</span>\';
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return '<span style="color: ' . ($rowData['active'] ? 'green' : 'red') . '">' . ($rowData['active'] ? $txt['yes'] : $txt['no']) . '</span>';
+					},
 					'style' => 'text-align: center;',
 				),
 			),
 			'modify' => array(
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt, $scripturl;
-
-						return \'<a href="\' . $scripturl . \'?action=admin;area=paidsubscribe;sa=modify;sid=\' . $rowData[\'id\'] . \'">\' . $txt[\'modify\'] . \'</a>\';
-					'),
+					'function' => function($rowData) use ($txt, $scripturl)
+					{
+						return '<a href="' . $scripturl . '?action=admin;area=paidsubscribe;sa=modify;sid=' . $rowData['id'] . '">' . $txt['modify'] . '</a>';
+					},
 					'style' => 'text-align: center;',
 				),
 			),
 			'delete' => array(
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt, $scripturl;
-
-						return \'<a href="\' . $scripturl . \'?action=admin;area=paidsubscribe;sa=modify;delete;sid=\' . $rowData[\'id\'] . \'">\' . $txt[\'delete\'] . \'</a>\';
-					'),
+					'function' => function($rowData) use ($scripturl, $txt)
+					{
+						return '<a href="' . $scripturl . '?action=admin;area=paidsubscribe;sa=modify;delete;sid=' . $rowData['id'] . '">' . $txt['delete'] . '</a>';
+					},
 					'style' => 'text-align: center;',
 				),
 			),
@@ -672,11 +667,10 @@ function ViewSubscribedUsers()
 					'style' => 'text-align: left; width: 20%;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt, $scripturl;
-
-						return $rowData[\'id_member\'] == 0 ? $txt[\'guest\'] : \'<a href="\' . $scripturl . \'?action=profile;u=\' . $rowData[\'id_member\'] . \'">\' . $rowData[\'name\'] . \'</a>\';
-					'),
+					'function' => function($rowData) use ($context, $txt, $scripturl)
+					{
+						return $rowData['id_member'] == 0 ? $txt['guest'] : '<a href="' . $scripturl . '?action=profile;u=' . $rowData['id_member'] . '">' . $rowData['name'] . '</a>';
+					},
 				),
 				'sort' => array(
 					'default' => 'name',
@@ -742,11 +736,10 @@ function ViewSubscribedUsers()
 					'style' => 'width: 10%;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt, $scripturl;
-
-						return \'<a href="\' . $scripturl . \'?action=admin;area=paidsubscribe;sa=modifyuser;lid=\' . $rowData[\'id\'] . \'">\' . $txt[\'modify\'] . \'</a>\';
-					'),
+					'function' => function($rowData) use ($txt, $scripturl)
+					{
+						return '<a href="' . $scripturl . '?action=admin;area=paidsubscribe;sa=modifyuser;lid=' . $rowData['id'] . '">' . $txt['modify'] . '</a>';
+					},
 					'style' => 'text-align: center;',
 				),
 			),
@@ -755,11 +748,10 @@ function ViewSubscribedUsers()
 					'style' => 'width: 4%;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt, $scripturl;
-
-						return \'<input type="checkbox" name="delsub[\' . $rowData[\'id\'] . \']" class="input_check" />\';
-					'),
+					'function' => function($rowData)
+					{
+						return '<input type="checkbox" name="delsub[' . $rowData['id'] . ']" class="input_check" />';
+					},
 					'style' => 'text-align: center;',
 				),
 			),
diff --git a/Sources/ManageRegistration.php b/Sources/ManageRegistration.php
index 764a662..d917d47 100644
--- a/Sources/ManageRegistration.php
+++ b/Sources/ManageRegistration.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -64,6 +64,7 @@ function RegCenter()
 	$subActions = array(
 		'register' => array('AdminRegister', 'moderate_forum'),
 		'agreement' => array('EditAgreement', 'admin_forum'),
+		'policy' => array('EditPrivacyPolicy', 'admin_forum'),
 		'reservednames' => array('SetReserve', 'admin_forum'),
 		'settings' => array('ModifyRegistrationSettings', 'admin_forum'),
 	);
@@ -91,6 +92,9 @@ function RegCenter()
 			'agreement' => array(
 				'description' => $txt['registration_agreement_desc'],
 			),
+			'policy' => array(
+				'description' => $txt['privacy_policy_desc'],
+			),
 			'reservednames' => array(
 				'description' => $txt['admin_reserved_desc'],
 			),
@@ -107,7 +111,7 @@ function RegCenter()
 // This function allows the admin to register a new member by hand.
 function AdminRegister()
 {
-	global $txt, $context, $sourcedir, $scripturl, $smcFunc;
+	global $txt, $context, $sourcedir, $scripturl, $smcFunc, $modSettings;
 
 	if (!empty($_POST['regSubmit']))
 	{
@@ -131,6 +135,12 @@ function AdminRegister()
 			'memberGroup' => empty($_POST['group']) || !allowedTo('manage_membergroups') ? 0 : (int) $_POST['group'],
 		);
 
+		if (empty($_POST['requireAgreement']) && empty($modSettings['force_gdpr']))
+			$regOptions['theme_vars']['agreement_accepted'] = time();
+
+		if (empty($_POST['requirePolicyAgreement']) && empty($modSettings['force_gdpr']))
+			$regOptions['theme_vars']['policy_accepted'] = time();
+
 		require_once($sourcedir . '/Subs-Members.php');
 		$memberID = registerMember($regOptions);
 		if (!empty($memberID))
@@ -182,7 +192,9 @@ function AdminRegister()
 // I hereby agree not to be a lazy bum.
 function EditAgreement()
 {
-	global $txt, $boarddir, $context, $modSettings, $smcFunc, $settings;
+	global $txt, $boarddir, $context, $modSettings, $smcFunc, $user_info;
+
+	$context['force_gdpr'] = !empty($modSettings['force_gdpr']);
 
 	// By default we look at agreement.txt.
 	$context['current_agreement'] = '';
@@ -207,7 +219,11 @@ function EditAgreement()
 		}
 	}
 
-	if (isset($_POST['agreement']))
+	$agreement_lang = empty($context['current_agreement']) ? 'default' : substr($context['current_agreement'], 1);
+
+	$context['agreement'] = file_exists($boarddir . '/agreement' . $context['current_agreement'] . '.txt') ? str_replace("\r", '', file_get_contents($boarddir . '/agreement' . $context['current_agreement'] . '.txt')) : '';
+
+	if (isset($_POST['agreement']) && str_replace("\r", '', $_POST['agreement']) != $context['agreement'])
 	{
 		checkSession();
 
@@ -216,12 +232,30 @@ function EditAgreement()
 		fwrite($fp, str_replace("\r", '', $_POST['agreement']));
 		fclose($fp);
 
-		updateSettings(array('requireAgreement' => !empty($_POST['requireAgreement'])));
+		if (!isset($_POST['minor_edit']) || !empty($modSettings['force_gdpr']))
+		{
+			$agreement_settings['agreement_updated_' . $agreement_lang] = time();
+
+			// Writing it counts as agreeing to it, right?
+			$smcFunc['db_insert']('replace',
+				'{db_prefix}themes',
+				array('id_member' => 'int', 'id_theme' => 'int', 'variable' => 'string', 'value' => 'string'),
+				array($user_info['id'], 1, 'agreement_accepted', time()),
+				array('id_member', 'id_theme', 'variable')
+			);
+			logAction('agreement_updated', array('language' => $context['editable_agreements'][$context['current_agreement']]), 'admin');
+			logAction('agreement_accepted', array('applicator' => $user_info['id']), 'user');
+
+			updateSettings($agreement_settings);
+		}
+
+		$context['agreement'] = str_replace("\r", '', $_POST['agreement']);
 	}
 
-	$context['agreement'] = file_exists($boarddir . '/agreement' . $context['current_agreement'] . '.txt') ? htmlspecialchars(file_get_contents($boarddir . '/agreement' . $context['current_agreement'] . '.txt')) : '';
+	$context['agreement_info'] = sprintf($txt['admin_agreement_info'], empty($modSettings['agreement_updated_' . $agreement_lang]) ? $txt['never'] : timeformat($modSettings['agreement_updated_' . $agreement_lang]));
+
+	$context['agreement'] = $smcFunc['htmlspecialchars']($context['agreement']);
 	$context['warning'] = is_writable($boarddir . '/agreement' . $context['current_agreement'] . '.txt') ? '' : $txt['agreement_not_writable'];
-	$context['require_agreement'] = !empty($modSettings['requireAgreement']);
 
 	$context['sub_template'] = 'edit_agreement';
 	$context['page_title'] = $txt['registration_agreement'];
@@ -265,15 +299,25 @@ function SetReserve()
 function ModifyRegistrationSettings($return_config = false)
 {
 	global $txt, $context, $scripturl, $modSettings, $sourcedir;
+	global $language, $boarddir;
 
 	// This is really quite wanting.
 	require_once($sourcedir . '/ManageServer.php');
 
+	// Do we have at least default versions of the agreement and privacy policy?
+	$agreement = file_exists($boarddir . '/agreement.' . $language . '.txt') || file_exists($boarddir . '/agreement.txt');
+	$policy = !empty($modSettings['policy_' . $language]);
+
 	$config_vars = array(
 			array('select', 'registration_method', array($txt['setting_registration_standard'], $txt['setting_registration_activate'], $txt['setting_registration_approval'], $txt['setting_registration_disabled'])),
 			array('check', 'enableOpenID'),
 			array('check', 'notify_new_registration'),
 			array('check', 'send_welcomeEmail'),
+		'',
+			array('check', 'requireAgreement', 'text_label' => $txt['admin_agreement'], 'value' => !empty($modSettings['force_gdpr']) ? 1 : $modSettings['requireAgreement'], 'disabled' => !empty($modSettings['force_gdpr'])),
+			array('warning', empty($agreement) ? 'error_no_agreement' : ''),
+			array('check', 'requirePolicyAgreement', 'text_label' => $txt['admin_privacy_policy'], 'value' => !empty($modSettings['force_gdpr']) ? 1 : $modSettings['requirePolicyAgreement'], 'disabled' => !empty($modSettings['force_gdpr'])),
+			array('warning', empty($policy) ? 'error_no_privacy_policy' : ''),
 		'',
 			array('int', 'coppaAge', 'subtext' => $txt['setting_coppaAge_desc'], 'onchange' => 'checkCoppa();'),
 			array('select', 'coppaType', array($txt['setting_coppaType_reject'], $txt['setting_coppaType_approval']), 'onchange' => 'checkCoppa();'),
@@ -284,6 +328,8 @@ function ModifyRegistrationSettings($return_config = false)
 			array('check', 'sfs_enabled', 'subtext' => $txt['setting_sfs_enabled_desc']),
 			array('check', 'sfs_ipcheck', 'subtext' => $txt['setting_sfs_ipcheck_desc']),
 			array('check', 'sfs_usernamecheck', 'subtext' => $txt['setting_sfs_usernamecheck_desc']),
+		'',
+			array('check', 'announcements_default', 'disabled' => empty($modSettings['allow_disableAnnounce']) || !empty($modSettings['force_gdpr']), 'value' => !empty($modSettings['force_gdpr']) ? 0 : (empty($modSettings['allow_disableAnnounce']) ? 1 : !empty($modSettings['announcements_default']))),
 	);
 
 	if ($return_config)
@@ -304,6 +350,16 @@ function ModifyRegistrationSettings($return_config = false)
 		// Post needs to take into account line breaks.
 		$_POST['coppaPost'] = str_replace("\n", '<br />', empty($_POST['coppaPost']) ? '' : $_POST['coppaPost']);
 
+		// GDPR requires these settings to have certain values
+		if (!empty($modSettings['force_gdpr']))
+		{
+			$_POST['requireAgreement'] = 1;
+			$_POST['requirePolicyAgreement'] = 1;
+			$_POST['announcements_default'] = 0;
+		}
+		elseif (empty($modSettings['allow_disableAnnounce']))
+			$_POST['announcements_default'] = 1;
+
 		saveDBSettings($config_vars);
 
 		redirectexit('action=admin;area=regcenter;sa=settings');
@@ -332,4 +388,65 @@ function ModifyRegistrationSettings($return_config = false)
 	prepareDBSettingContext($config_vars);
 }
 
-?>
\ No newline at end of file
+// Sure, you can sell my personal info for profit (...or not)
+function EditPrivacyPolicy()
+{
+	global $txt, $boarddir, $context, $modSettings, $smcFunc, $user_info;
+
+	$context['force_gdpr'] = !empty($modSettings['force_gdpr']);
+
+	// By default, edit the current language's policy
+	$context['current_policy_lang'] = $user_info['language'];
+
+	// We need a policy for every language
+	getLanguages();
+
+	foreach ($context['languages'] as $lang)
+	{
+		$context['editable_policies'][$lang['filename']] = $lang['name'];
+
+		// Are we editing this one?
+		if (isset($_POST['policy_lang']) && $_POST['policy_lang'] == $lang['filename'])
+			$context['current_policy_lang'] = $lang['filename'];
+	}
+
+	$context['policy'] = empty($modSettings['policy_' . $context['current_policy_lang']]) ? '' : $modSettings['policy_' . $context['current_policy_lang']];
+
+	if (isset($_POST['policy']))
+	{
+		checkSession();
+
+		// Make sure there are no creepy-crawlies in it
+		$policy_text = $smcFunc['htmlspecialchars'](str_replace("\r", '', $_POST['policy']));
+
+		$policy_settings = array(
+			'policy_' . $context['current_policy_lang'] => $policy_text,
+		);
+
+		if ($policy_text != $context['policy'] && (!isset($_POST['minor_edit']) || !empty($modSettings['force_gdpr'])))
+		{
+			$policy_settings['policy_updated_' . $context['current_policy_lang']] = time();
+
+			// Writing it counts as agreeing to it, right?
+			$smcFunc['db_insert']('replace',
+				'{db_prefix}themes',
+				array('id_member' => 'int', 'id_theme' => 'int', 'variable' => 'string', 'value' => 'string'),
+				array($user_info['id'], 1, 'policy_accepted', time()),
+				array('id_member', 'id_theme', 'variable')
+			);
+			logAction('policy_updated', array('language' => $context['editable_policies'][$context['current_policy_lang']]), 'admin');
+			logAction('policy_accepted', array('applicator' => $user_info['id']), 'user');
+		}
+
+		updateSettings($policy_settings);
+
+		$context['policy'] = $policy_text;
+	}
+
+	$context['policy_info'] = sprintf($txt['admin_agreement_info'], empty($modSettings['policy_updated_' . $context['current_policy_lang']]) ? $txt['never'] : timeformat($modSettings['policy_updated_' . $context['current_policy_lang']]));
+
+	$context['sub_template'] = 'edit_privacy_policy';
+	$context['page_title'] = $txt['privacy_policy'];
+}
+
+?>
diff --git a/Sources/ManageScheduledTasks.php b/Sources/ManageScheduledTasks.php
index f80e192..2e336d9 100644
--- a/Sources/ManageScheduledTasks.php
+++ b/Sources/ManageScheduledTasks.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -457,9 +457,10 @@ function TaskLog()
 					'value' => $txt['scheduled_log_time_run'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return timeformat($rowData[\'time_run\'], true);
-					'),
+					'function' => function($rowData)
+					{
+						return timeformat($rowData['time_run'], true);
+					},
 				),
 				'sort' => array(
 					'default' => 'lst.id_log DESC',
diff --git a/Sources/ManageSearch.php b/Sources/ManageSearch.php
index 9bf176c..00c8468 100644
--- a/Sources/ManageSearch.php
+++ b/Sources/ManageSearch.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -219,7 +219,7 @@ function EditSearchMethod()
 			array(
 			)
 		);
-		$context['fulltext_index'] = '';
+		$context['fulltext_index'] = array();
 		if ($request !== false || $smcFunc['db_num_rows']($request) != 0)
 		{
 			while ($row = $smcFunc['db_fetch_assoc']($request))
diff --git a/Sources/ManageSearchEngines.php b/Sources/ManageSearchEngines.php
index 1015d1e..70b841b 100644
--- a/Sources/ManageSearchEngines.php
+++ b/Sources/ManageSearchEngines.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -216,11 +216,10 @@ function ViewSpiders()
 					'value' => $txt['spider_name'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl;
-
-						return sprintf(\'<a href="%1$s?action=admin;area=sengines;sa=editspiders;sid=%2$d">%3$s</a>\', $scripturl, $rowData[\'id_spider\'], htmlspecialchars($rowData[\'spider_name\']));
-					'),
+					'function' => function($rowData) use ($scripturl)
+					{
+						return sprintf('<a href="%1$s?action=admin;area=sengines;sa=editspiders;sid=%2$d">%3$s</a>', $scripturl, $rowData['id_spider'], htmlspecialchars($rowData['spider_name']));
+					},
 				),
 				'sort' => array(
 					'default' => 'spider_name',
@@ -232,11 +231,10 @@ function ViewSpiders()
 					'value' => $txt['spider_last_seen'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt;
-
-						return isset($context[\'spider_last_seen\'][$rowData[\'id_spider\']]) ? timeformat($context[\'spider_last_seen\'][$rowData[\'id_spider\']]) : $txt[\'spider_last_never\'];
-					'),
+					'function' => function($rowData) use ($context, $txt)
+					{
+						return isset($context['spider_last_seen'][$rowData['id_spider']]) ? timeformat($context['spider_last_seen'][$rowData['id_spider']]) : $txt['spider_last_never'];
+					},
 				),
 			),
 			'user_agent' => array(
@@ -686,9 +684,10 @@ function SpiderLogs()
 					'value' => $txt['spider_time'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return timeformat($rowData[\'log_time\']);
-					'),
+					'function' => function($rowData)
+					{
+						return timeformat($rowData['log_time']);
+					},
 				),
 				'sort' => array(
 					'default' => 'sl.id_hit DESC',
diff --git a/Sources/ManageServer.php b/Sources/ManageServer.php
index 6aa0be6..e9246cb 100644
--- a/Sources/ManageServer.php
+++ b/Sources/ManageServer.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -206,6 +206,8 @@ function ModifyGeneralSettings($return_config = false)
 {
 	global $scripturl, $context, $txt;
 
+	loadLanguage('Install');
+
 	/* If you're writing a mod, it's a bad idea to add things here....
 	For each option:
 		variable name, description, type (constant), size/possible values, helptext.
@@ -223,6 +225,12 @@ function ModifyGeneralSettings($return_config = false)
 		array('enableCompressedOutput', $txt['enableCompressedOutput'], 'db', 'check', null, 'enableCompressedOutput'),
 		array('disableTemplateEval', $txt['disableTemplateEval'], 'db', 'check', null, 'disableTemplateEval'),
 		array('disableHostnameLookup', $txt['disableHostnameLookup'], 'db', 'check', null, 'disableHostnameLookup'),
+		'',
+		array('image_proxy_enabled', $txt['image_proxy_enabled'], 'file', 'check', null, 'image_proxy_enabled', 'subtext' => $txt['image_proxy_enabled_desc']),
+		array('image_proxy_secret', $txt['image_proxy_secret'], 'file', 'text', 30, 'image_proxy_secret', 'subtext' => $txt['image_proxy_secret_desc']),
+		array('image_proxy_maxsize', $txt['image_proxy_maxsize'], 'file', 'int', null, 'image_proxy_maxsize', 'postinput' => $txt['image_proxy_maxsize_postinput'], 'subtext' => $txt['image_proxy_maxsize_desc']),
+		'',
+		array('enable_sm_stats', $txt['install_settings_stats'], 'db', 'check', null),
 	);
 
 	if ($return_config)
@@ -235,6 +243,16 @@ function ModifyGeneralSettings($return_config = false)
 	// Saving settings?
 	if (isset($_REQUEST['save']))
 	{
+		// Are we saving the stat collection?
+		if (!empty($_POST['enable_sm_stats']) && empty($modSettings['sm_stats_key']))
+		{
+			$registerSMStats = registerSMStats();
+
+			// Failed to register, disable it again.
+			if (empty($registerSMStats))
+				$_POST['enable_sm_stats'] = 0;
+		}
+
 		saveSettings($config_vars);
 		redirectexit('action=admin;area=serversettings;sa=general;' . $context['session_var'] . '=' . $context['session_id']);
 	}
@@ -295,7 +313,7 @@ function ModifyDatabaseSettings($return_config = false)
 // This function basically edits anything which is configuration and stored in the database, except for caching.
 function ModifyCookieSettings($return_config = false)
 {
-	global $context, $scripturl, $txt, $sourcedir, $modSettings, $cookiename, $user_settings;
+	global $context, $scripturl, $txt, $sourcedir, $modSettings, $cookiename, $cookie_no_auth_secret, $user_settings;
 
 	// Define the variables we want to edit.
 	$config_vars = array(
@@ -305,6 +323,7 @@ function ModifyCookieSettings($return_config = false)
 		array('localCookies', $txt['localCookies'], 'db', 'check', false, 'localCookies'),
 		array('globalCookies', $txt['globalCookies'], 'db', 'check', false, 'globalCookies'),
 		array('secureCookies', $txt['secureCookies'], 'db', 'check', false, 'secureCookies',  'disabled' => !isset($_SERVER['HTTPS']) || !(strtolower($_SERVER['HTTPS']) == 'on' || strtolower($_SERVER['HTTPS']) == '1')),
+		array('cookie_no_auth_secret', $txt['cookie_no_auth_secret'], 'db', 'check', false, 'cookie_no_auth_secret'),
 		'',
 		// Sessions
 		array('databaseSession_enable', $txt['databaseSession_enable'], 'db', 'check', false, 'databaseSession_enable'),
@@ -524,7 +543,7 @@ function AddLanguage()
 		$context['smf_search_term'] = htmlspecialchars(trim($_POST['smf_add']));
 
 		// We're going to use this URL.
-		$url = 'http://download.simplemachines.org/fetch_language.php?version=' . urlencode(strtr($forum_version, array('SMF ' => '')));
+		$url = 'https://download.simplemachines.org/fetch_language.php?version=' . urlencode(strtr($forum_version, array('SMF ' => '')));
 
 		// Load the class file and stick it into an array.
 		loadClassFile('Class-Package.php');
@@ -606,7 +625,7 @@ function DownloadLanguage()
 		// Otherwise, go go go!
 		elseif (!empty($install_files))
 		{
-			$archive_content = read_tgz_file('http://download.simplemachines.org/fetch_language.php?version=' . urlencode(strtr($forum_version, array('SMF ' => ''))) . ';fetch=' . urlencode($_GET['did']), $boarddir, false, true, $install_files);
+			$archive_content = read_tgz_file('https://download.simplemachines.org/fetch_language.php?version=' . urlencode(strtr($forum_version, array('SMF ' => ''))) . ';fetch=' . urlencode($_GET['did']), $boarddir, false, true, $install_files);
 			// Make sure the files aren't stuck in the cache.
 			package_flush_cache();
 			$context['install_complete'] = sprintf($txt['languages_download_complete_desc'], $scripturl . '?action=admin;area=languages');
@@ -617,7 +636,7 @@ function DownloadLanguage()
 
 	// Open up the old china.
 	if (!isset($archive_content))
-		$archive_content = read_tgz_file('http://download.simplemachines.org/fetch_language.php?version=' . urlencode(strtr($forum_version, array('SMF ' => ''))) . ';fetch=' . urlencode($_GET['did']), null);
+		$archive_content = read_tgz_file('https://download.simplemachines.org/fetch_language.php?version=' . urlencode(strtr($forum_version, array('SMF ' => ''))) . ';fetch=' . urlencode($_GET['did']), null);
 
 	if (empty($archive_content))
 		fatal_error($txt['add_language_error_no_response']);
@@ -841,10 +860,10 @@ function DownloadLanguage()
 		'id' => 'lang_main_files_list',
 		'title' => $txt['languages_download_main_files'],
 		'get_items' => array(
-			'function' => create_function('', '
-				global $context;
-				return $context[\'files\'][\'lang\'];
-			'),
+			'function' => function() use ($context)
+			{
+				return $context['files']['lang'];
+			},
 		),
 		'columns' => array(
 			'name' => array(
@@ -852,11 +871,10 @@ function DownloadLanguage()
 					'value' => $txt['languages_download_filename'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt;
-
-						return \'<strong>\' . $rowData[\'name\'] . \'</strong><br /><span class="smalltext">\' . $txt[\'languages_download_dest\'] . \': \' . $rowData[\'destination\'] . \'</span>\' . ($rowData[\'version_compare\'] == \'older\' ? \'<br />\' . $txt[\'languages_download_older\'] : \'\');
-					'),
+					'function' => function($rowData) use ($context, $txt)
+					{
+						return '<strong>' . $rowData['name'] . '</strong><br /><span class="smalltext">' . $txt['languages_download_dest'] . ': ' . $rowData['destination'] . '</span>' . ($rowData['version_compare'] == 'older' ? '<br />' . $txt['languages_download_older'] : '');
+					},
 				),
 			),
 			'writable' => array(
@@ -864,11 +882,10 @@ function DownloadLanguage()
 					'value' => $txt['languages_download_writable'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
-						return \'<span style="color: \' . ($rowData[\'writable\'] ? \'green\' : \'red\') . \';">\' . ($rowData[\'writable\'] ? $txt[\'yes\'] : $txt[\'no\']) . \'</span>\';
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return '<span style="color: ' . ($rowData['writable'] ? 'green' : 'red') . ';">' . ($rowData['writable'] ? $txt['yes'] : $txt['no']) . '</span>';
+					},
 					'style' => 'text-align: center',
 				),
 			),
@@ -877,11 +894,10 @@ function DownloadLanguage()
 					'value' => $txt['languages_download_version'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
-						return \'<span style="color: \' . ($rowData[\'version_compare\'] == \'older\' ? \'red\' : ($rowData[\'version_compare\'] == \'same\' ? \'orange\' : \'green\')) . \';">\' . $rowData[\'version\'] . \'</span>\';
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return '<span style="color: ' . ($rowData['version_compare'] == 'older' ? 'red' : ($rowData['version_compare'] == 'same' ? 'orange' : 'green')) . ';">' . $rowData['version'] . '</span>';
+					},
 				),
 			),
 			'exists' => array(
@@ -889,11 +905,10 @@ function DownloadLanguage()
 					'value' => $txt['languages_download_exists'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
-						return $rowData[\'exists\'] ? ($rowData[\'exists\'] == \'same\' ? $txt[\'languages_download_exists_same\'] : $txt[\'languages_download_exists_different\']) : $txt[\'no\'];
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return $rowData['exists'] ? ($rowData['exists'] == 'same' ? $txt['languages_download_exists_same'] : $txt['languages_download_exists_different']) : $txt['no'];
+					},
 				),
 			),
 			'copy' => array(
@@ -901,9 +916,10 @@ function DownloadLanguage()
 					'value' => $txt['languages_download_copy'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return \'<input type="checkbox" name="copy_file[]" value="\' . $rowData[\'generaldest\'] . \'" \' . ($rowData[\'default_copy\'] ? \'checked="checked"\' : \'\') . \' class="input_check" />\';
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return '<input type="checkbox" name="copy_file[]" value="' . $rowData['generaldest'] . '" ' . ($rowData['default_copy'] ? 'checked="checked"' : '') . ' class="input_check" />';
+					},
 					'style' => 'text-align: center; width: 4%;',
 				),
 			),
@@ -970,9 +986,10 @@ function ModifyLanguages()
 					'value' => $txt['languages_default'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return \'<input type="radio" name="def_language" value="\' . $rowData[\'id\'] . \'" \' . ($rowData[\'default\'] ? \'checked="checked"\' : \'\') . \' onclick="highlightSelected(\\\'list_language_list_\' . $rowData[\'id\'] . \'\\\');" class="input_radio" />\';
-					'),
+					'function' => function($rowData)
+					{
+						return '<input type="radio" name="def_language" value="' . $rowData['id'] . '" ' . ($rowData['default'] ? 'checked="checked"' : '') . ' onclick="highlightSelected(\'list_language_list_' . $rowData['id'] . '\');" class="input_radio" />';
+					},
 					'style' => 'text-align: center; width: 8%;',
 				),
 			),
@@ -981,11 +998,10 @@ function ModifyLanguages()
 					'value' => $txt['languages_lang_name'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl, $context;
-
-						return sprintf(\'<a href="%1$s?action=admin;area=languages;sa=editlang;lid=%2$s">%3$s</a>\', $scripturl, $rowData[\'id\'], $rowData[\'name\']);
-					'),
+					'function' => function($rowData) use ($scripturl, $context)
+					{
+						return sprintf('<a href="%1$s?action=admin;area=languages;sa=editlang;lid=%2$s">%3$s</a>', $scripturl, $rowData['id'], $rowData['name']);
+					},
 				),
 			),
 			'character_set' => array(
@@ -1581,7 +1597,7 @@ function cleanLangString($string, $to_display = true)
 		for ($i = 0; $i < strlen($string); $i++)
 		{
 			// Handle ecapes first.
-			if ($string{$i} == '\\')
+			if ($string[$i] == '\\')
 			{
 				// Toggle the escape.
 				$is_escape = !$is_escape;
@@ -1590,15 +1606,15 @@ function cleanLangString($string, $to_display = true)
 					continue;
 			}
 			// Special case - parsed string with line break etc?
-			elseif (($string{$i} == 'n' || $string{$i} == 't') && $in_string == 2 && $is_escape)
+			elseif (($string[$i] == 'n' || $string[$i] == 't') && $in_string == 2 && $is_escape)
 			{
 				// Put the escape back...
-				$new_string .= $string{$i} == 'n' ? "\n" : "\t";
+				$new_string .= $string[$i] == 'n' ? "\n" : "\t";
 				$is_escape = false;
 				continue;
 			}
 			// Have we got a single quote?
-			elseif ($string{$i} == '\'')
+			elseif ($string[$i] == '\'')
 			{
 				// Already in a parsed string, or escaped in a linear string, means we print it - otherwise something special.
 				if ($in_string != 2 && ($in_string != 1 || !$is_escape))
@@ -1615,7 +1631,7 @@ function cleanLangString($string, $to_display = true)
 				}
 			}
 			// Otherwise a double quote?
-			elseif ($string{$i} == '"')
+			elseif ($string[$i] == '"')
 			{
 				// Already in a single quote string, or escaped in a parsed string, means we print it - otherwise something special.
 				if ($in_string != 1 && ($in_string != 2 || !$is_escape))
@@ -1632,10 +1648,10 @@ function cleanLangString($string, $to_display = true)
 				}
 			}
 			// A join/space outside of a string is simply removed.
-			elseif ($in_string == 0 && (empty($string{$i}) || $string{$i} == '.'))
+			elseif ($in_string == 0 && (empty($string[$i]) || $string[$i] == '.'))
 				continue;
 			// Start of a variable?
-			elseif ($in_string == 0 && $string{$i} == '$')
+			elseif ($in_string == 0 && $string[$i] == '$')
 			{
 				// Find the whole of it!
 				preg_match('~([\$A-Za-z0-9\'\[\]_-]+)~', substr($string, $i), $matches);
@@ -1658,7 +1674,7 @@ function cleanLangString($string, $to_display = true)
 			}
 
 			// Actually add the character to the string!
-			$new_string .= $string{$i};
+			$new_string .= $string[$i];
 			// If anything was escaped it ain't any longer!
 			$is_escape = false;
 		}
@@ -1675,20 +1691,20 @@ function cleanLangString($string, $to_display = true)
 		for ($i = 0; $i < strlen($string); $i++)
 		{
 			// Handle line breaks!
-			if ($string{$i} == "\n" || $string{$i} == "\t")
+			if ($string[$i] == "\n" || $string[$i] == "\t")
 			{
 				// Are we in a string? Is it the right type?
 				if ($in_string == 1)
 				{
 					// Change type!
-					$new_string .= '\' . "\\' . ($string{$i} == "\n" ? 'n' : 't');
+					$new_string .= '\' . "\\' . ($string[$i] == "\n" ? 'n' : 't');
 					$in_string = 2;
 				}
 				elseif ($in_string == 2)
-					$new_string .= '\\' . ($string{$i} == "\n" ? 'n' : 't');
+					$new_string .= '\\' . ($string[$i] == "\n" ? 'n' : 't');
 				// Otherwise start one off - joining if required.
 				else
-					$new_string .= ($new_string ? ' . ' : '') . '"\\' . ($string{$i} == "\n" ? 'n' : 't');
+					$new_string .= ($new_string ? ' . ' : '') . '"\\' . ($string[$i] == "\n" ? 'n' : 't');
 
 				continue;
 			}
@@ -1707,7 +1723,7 @@ function cleanLangString($string, $to_display = true)
 			}
 
 			// Is this a variable?
-			if ($string{$i} == '{' && $string{$i + 1} == '%' && $string{$i + 2} == '$')
+			if ($string[$i] == '{' && $string[$i + 1] == '%' && $string[$i + 2] == '$')
 			{
 				// Grab the variable.
 				preg_match('~\{%([\$A-Za-z0-9\'\[\]_-]+)%\}~', substr($string, $i), $matches);
@@ -1726,10 +1742,10 @@ function cleanLangString($string, $to_display = true)
 				continue;
 			}
 			// Is this a lt sign?
-			elseif ($string{$i} == '<')
+			elseif ($string[$i] == '<')
 			{
 				// Probably HTML?
-				if ($string{$i + 1} != ' ')
+				if ($string[$i + 1] != ' ')
 					$in_html = true;
 				// Assume we need an entity...
 				else
@@ -1739,7 +1755,7 @@ function cleanLangString($string, $to_display = true)
 				}
 			}
 			// What about gt?
-			elseif ($string{$i} == '>')
+			elseif ($string[$i] == '>')
 			{
 				// Will it be HTML?
 				if ($in_html)
@@ -1752,10 +1768,10 @@ function cleanLangString($string, $to_display = true)
 				}
 			}
 			// Is it a slash? If so escape it...
-			if ($string{$i} == '\\')
+			if ($string[$i] == '\\')
 				$new_string .= '\\';
 			// The infamous double quote?
-			elseif ($string{$i} == '"')
+			elseif ($string[$i] == '"')
 			{
 				// If we're in HTML we leave it as a quote - otherwise we entity it.
 				if (!$in_html)
@@ -1765,14 +1781,14 @@ function cleanLangString($string, $to_display = true)
 				}
 			}
 			// A single quote?
-			elseif ($string{$i} == '\'')
+			elseif ($string[$i] == '\'')
 			{
 				// Must be in a string so escape it.
 				$new_string .= '\\';
 			}
 
 			// Finally add the character to the string!
-			$new_string .= $string{$i};
+			$new_string .= $string[$i];
 		}
 
 		// If we ended as a string then close it off.
@@ -1812,7 +1828,9 @@ function prepareServerSettingsContext(&$config_vars)
 				'invalid' => false,
 				'javascript' => '',
 				'preinput' => '',
-				'postinput' => '',
+				'postinput' => isset($config_var['postinput']) ? $config_var['postinput'] : '',
+				'subtext' => isset($config_var['subtext']) ? $config_var['subtext'] : '',
+				'needs_default' => !empty($config_var['needs_default']) || in_array($config_var[0], array('db_persist', 'db_error_send', 'maintenance', 'image_proxy_enabled')) ? true : false,
 			);
 		}
 	}
@@ -2005,14 +2023,18 @@ function saveSettings(&$config_vars)
 		'webmaster_email',
 		'db_name', 'db_user', 'db_server', 'db_prefix', 'ssi_db_user',
 		'boarddir', 'sourcedir', 'cachedir',
+		'image_proxy_secret',
 	);
 	// All the numeric variables.
 	$config_ints = array(
+		'cache_enable',
+		'image_proxy_maxsize',
 	);
 	// All the checkboxes.
 	$config_bools = array(
 		'db_persist', 'db_error_send',
-		'maintenance',
+		'maintenance', 'image_proxy_enabled',
+		'cookie_no_auth_secret',
 	);
 
 	// Now sort everything into a big array, and figure out arrays and etc.
@@ -2036,7 +2058,7 @@ function saveSettings(&$config_vars)
 	{
 		if (!empty($_POST[$key]))
 			$new_settings[$key] = '1';
-		else
+		elseif (isset($_POST[$key]))
 			$new_settings[$key] = '0';
 	}
 
@@ -2134,4 +2156,54 @@ function saveDBSettings(&$config_vars)
 	}
 }
 
+
+/**
+ * Registers the site with the Simple Machines Stat collection. This function
+ * purposely does not use updateSettings.php as it will be called shortly after
+ * this process completes by the saveSettings() function.
+ *
+ * @see Stats.php SMStats() for more information.
+ * @link https://www.simplemachines.org/about/stats.php for more info.
+ *
+ */
+function registerSMStats()
+{
+	global $modSettings, $boardurl, $smcFunc;
+
+	// Already have a key?  Can't register again.
+	if (!empty($modSettings['sm_stats_key']))
+		return true;
+
+	$fp = @fsockopen('www.simplemachines.org', 80, $errno, $errstr);
+	if ($fp)
+	{
+		$out = 'GET /smf/stats/register_stats.php?site=' . base64_encode($boardurl) . ' HTTP/1.1' . "\r\n";
+		$out .= 'Host: www.simplemachines.org' . "\r\n";
+		$out .= 'Connection: Close' . "\r\n\r\n";
+		fwrite($fp, $out);
+
+		$return_data = '';
+		while (!feof($fp))
+			$return_data .= fgets($fp, 128);
+
+		fclose($fp);
+
+		// Get the unique site ID.
+		preg_match('~SITE-ID:\s(\w{10})~', $return_data, $ID);
+
+		if (!empty($ID[1]))
+		{
+			$smcFunc['db_insert']('replace',
+				'{db_prefix}settings',
+				array('variable' => 'string', 'value' => 'string'),
+				array('sm_stats_key', $ID[1]),
+				array('variable')
+			);
+			return true;
+		}
+	}
+
+	return false;
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/ManageSettings.php b/Sources/ManageSettings.php
index 6d75dbd..1bd8df3 100644
--- a/Sources/ManageSettings.php
+++ b/Sources/ManageSettings.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.6
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -83,9 +83,11 @@ function loadGeneralSettingParameters($subActions = array(), $defaultAction = ''
 
 	$context['sub_template'] = 'show_settings';
 
-	// By default do the basic settings.
-	$_REQUEST['sa'] = isset($_REQUEST['sa']) && isset($subActions[$_REQUEST['sa']]) ? $_REQUEST['sa'] : (!empty($defaultAction) ? $defaultAction : array_pop(array_keys($subActions)));
-	$context['sub_action'] = $_REQUEST['sa'];
+	// If no fallback was specified, use the first subaction.
+	$defaultAction = !empty($defaultAction) ? $defaultAction : key($subActions);
+
+	// I want...
+	$_REQUEST['sa'] = isset($_REQUEST['sa'], $subActions[$_REQUEST['sa']]) ? $_REQUEST['sa'] : $defaultAction;
 }
 
 // This function passes control through to the relevant tab.
@@ -202,6 +204,7 @@ function ModifyModSettings()
 function ModifyCoreFeatures($return_config = false)
 {
 	global $txt, $scripturl, $context, $settings, $sc, $modSettings;
+	global $language;
 
 	/* This is an array of all the features that can be enabled/disabled - each option can have the following:
 		title		- Text title of this item (If standard string does not exist).
@@ -222,25 +225,27 @@ function ModifyCoreFeatures($return_config = false)
 		// cp = custom profile fields.
 		'cp' => array(
 			'url' => 'action=admin;area=featuresettings;sa=profile',
-			'save_callback' => create_function('$value', '
+			'save_callback' => function($value)
+			{
 				global $smcFunc;
 				if (!$value)
 				{
-					$smcFunc[\'db_query\'](\'\', \'
+					$smcFunc['db_query']('', '
 						UPDATE {db_prefix}custom_fields
-						SET active = 0\');
+						SET active = 0');
 				}
-			'),
-			'setting_callback' => create_function('$value', '
+			},
+			'setting_callback' => function($value)
+			{
 				if (!$value)
 					return array(
-						\'disabled_profile_fields\' => \'\',
-						\'registration_fields\' => \'\',
-						\'displayFields\' => \'\',
+						'disabled_profile_fields' => '',
+						'registration_fields' => '',
+						'displayFields' => '',
 					);
 				else
 					return array();
-			'),
+			},
 		),
 		// k = karma.
 		'k' => array(
@@ -259,20 +264,21 @@ function ModifyCoreFeatures($return_config = false)
 		// pm = post moderation.
 		'pm' => array(
 			'url' => 'action=admin;area=permissions;sa=postmod',
-			'setting_callback' => create_function('$value', '
+			'setting_callback' => function($value)
+			{
 				global $sourcedir;
 
 				// Cant use warning post moderation if disabled!
 				if (!$value)
 				{
-					require_once($sourcedir . \'/PostModeration.php\');
+					require_once($sourcedir . '/PostModeration.php');
 					approveAllData();
 
-					return array(\'warning_moderate\' => 0);
+					return array('warning_moderate' => 0);
 				}
 				else
 					return array();
-			'),
+			},
 		),
 		// ps = Paid Subscriptions.
 		'ps' => array(
@@ -280,27 +286,28 @@ function ModifyCoreFeatures($return_config = false)
 			'settings' => array(
 				'paid_enabled' => 1,
 			),
-			'setting_callback' => create_function('$value', '
+			'setting_callback' => function($value)
+			{
 				global $smcFunc, $sourcedir;
 
 				// Set the correct disabled value for scheduled task.
-				$smcFunc[\'db_query\'](\'\', \'
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}scheduled_tasks
 					SET disabled = {int:disabled}
-					WHERE task = {string:task}\',
+					WHERE task = {string:task}',
 					array(
-						\'disabled\' => $value ? 0 : 1,
-						\'task\' => \'paid_subscriptions\',
+						'disabled' => $value ? 0 : 1,
+						'task' => 'paid_subscriptions',
 					)
 				);
 
 				// Should we calculate next trigger?
 				if ($value)
 				{
-					require_once($sourcedir . \'/ScheduledTasks.php\');
-					CalculateNextTrigger(\'paid_subscriptions\');
+					require_once($sourcedir . '/ScheduledTasks.php');
+					CalculateNextTrigger('paid_subscriptions');
 				}
-			'),
+			},
 		),
 		// rg = report generator.
 		'rg' => array(
@@ -309,32 +316,33 @@ function ModifyCoreFeatures($return_config = false)
 		// w = warning.
 		'w' => array(
 			'url' => 'action=admin;area=securitysettings;sa=moderation',
-			'setting_callback' => create_function('$value', '
+			'setting_callback' => function($value)
+			{
 				global $modSettings;
-				list ($modSettings[\'warning_enable\'], $modSettings[\'user_limit\'], $modSettings[\'warning_decrement\']) = explode(\',\', $modSettings[\'warning_settings\']);
-				$warning_settings = ($value ? 1 : 0) . \',\' . $modSettings[\'user_limit\'] . \',\' . $modSettings[\'warning_decrement\'];
+				list ($modSettings['warning_enable'], $modSettings['user_limit'], $modSettings['warning_decrement']) = explode(',', $modSettings['warning_settings']);
+				$warning_settings = ($value ? 1 : 0) . ',' . $modSettings['user_limit'] . ',' . $modSettings['warning_decrement'];
 				if (!$value)
 				{
 					$returnSettings = array(
-						\'warning_watch\' => 0,
-						\'warning_moderate\' => 0,
-						\'warning_mute\' => 0,
+						'warning_watch' => 0,
+						'warning_moderate' => 0,
+						'warning_mute' => 0,
 					);
 				}
-				elseif (empty($modSettings[\'warning_enable\']) && $value)
+				elseif (empty($modSettings['warning_enable']) && $value)
 				{
 					$returnSettings = array(
-						\'warning_watch\' => 10,
-						\'warning_moderate\' => 35,
-						\'warning_mute\' => 60,
+						'warning_watch' => 10,
+						'warning_moderate' => 35,
+						'warning_mute' => 60,
 					);
 				}
 				else
 					$returnSettings = array();
 
-				$returnSettings[\'warning_settings\'] = $warning_settings;
+				$returnSettings['warning_settings'] = $warning_settings;
 				return $returnSettings;
-			'),
+			},
 		),
 		// Search engines
 		'sp' => array(
@@ -342,16 +350,50 @@ function ModifyCoreFeatures($return_config = false)
 			'settings' => array(
 				'spider_mode' => 1,
 			),
-			'setting_callback' => create_function('$value', '
+			'setting_callback' => function($value)
+			{
 				// Turn off the spider group if disabling.
 				if (!$value)
-					return array(\'spider_group\' => 0, \'show_spider_online\' => 0);
-			'),
-			'on_save' => create_function('', '
+					return array('spider_group' => 0, 'show_spider_online' => 0);
+			},
+			'on_save' => function()
+			{
 				global $sourcedir, $modSettings;
-				require_once($sourcedir . \'/ManageSearchEngines.php\');
+				require_once($sourcedir . '/ManageSearchEngines.php');
 				recacheSpiderNames();
-			'),
+			},
+		),
+		// Quick setting to toggle into GDPR compliance
+		'gdpr' => array(
+			'url' => 'action=admin;area=regcenter;sa=policy',
+			'settings' => array(
+				'force_gdpr' => 1,
+				// DEVELOPERS: Add values to toggle here
+			),
+			'setting_callback' => function($value)
+			{
+				global $modSettings;
+
+				$returnSettings = array();
+
+				if ($value)
+				{
+					$returnSettings['requireAgreement'] = 1;
+					$returnSettings['requirePolicyAgreement'] = 1;
+					$returnSettings['allow_disableAnnounce'] = 1;
+					$returnSettings['announcements_default'] = 0;
+					$returnSettings['notify_tokens'] = 1;
+				}
+
+				return $returnSettings;
+			},
+			'save_callback' => function($value)
+			{
+				global $modSettings, $language, $context;
+
+				if ($value && empty($modSettings['policy_' . $language]))
+					redirectexit('action=admin;area=regcenter;sa=policy;' . $context['session_var'] . '=' . $context['session_id']);
+			},
 		),
 	);
 
@@ -442,6 +484,8 @@ function ModifyCoreFeatures($return_config = false)
 	if ($context['is_new_install'])
 		updateSettings(array('admin_features' => ''));
 
+	$context['show_privacy_policy_warning'] = empty($modSettings['policy_' . $language]);
+
 	$context['sub_template'] = 'core_features';
 	$context['page_title'] = $txt['core_settings_title'];
 }
@@ -481,7 +525,8 @@ function ModifyBasicSettings($return_config = false)
 			array('check', 'hitStats'),
 		'',
 			// Option-ish things... miscellaneous sorta.
-			array('check', 'allow_disableAnnounce'),
+			array('check', 'allow_disableAnnounce', 'disabled' => !empty($modSettings['force_gdpr'])),
+			array('check', 'notify_tokens', 'disabled' => !empty($modSettings['force_gdpr'])),
 			array('check', 'disallow_sendBody'),
 	);
 
@@ -508,6 +553,13 @@ function ModifyBasicSettings($return_config = false)
 		if (isset($_POST['lastActive']))
 			$_POST['lastActive'] = min((int) $_POST['lastActive'], 1440);
 
+		// GDPR requires these settings to always be true
+		if (!empty($modSettings['force_gdpr']))
+		{
+			$_POST['allow_disableAnnounce'] = 1;
+			$_POST['notify_tokens'] = 1;
+		}
+
 		saveDBSettings($config_vars);
 
 		writeLog();
@@ -1332,11 +1384,12 @@ function ShowCustomProfiles()
 					'value' => $txt['custom_edit_active'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						$isChecked = $rowData[\'disabled\'] ? \'\' : \' checked="checked"\';
-						$onClickHandler = $rowData[\'can_show_register\'] ? sprintf(\'onclick="document.getElementById(\\\'reg_%1$s\\\').disabled = !this.checked;"\', $rowData[\'id\']) : \'\';
-						return sprintf(\'<input type="checkbox" name="active[]" id="active_%1$s" value="%1$s" class="input_check"%2$s%3$s />\', $rowData[\'id\'], $isChecked, $onClickHandler);
-					'),
+					'function' => function($rowData)
+					{
+						$isChecked = $rowData['disabled'] ? '' : ' checked';
+						$onClickHandler = $rowData['can_show_register'] ? sprintf(' onclick="document.getElementById(\'reg_%1$s\').disabled = !this.checked;"', $rowData['id']) : '';
+						return sprintf('<input type="checkbox" name="active[]" id="active_%1$s" value="%1$s" %2$s%3$s>', $rowData['id'], $isChecked, $onClickHandler);
+					},
 					'style' => 'width: 20%; text-align: center;',
 				),
 			),
@@ -1345,11 +1398,12 @@ function ShowCustomProfiles()
 					'value' => $txt['custom_edit_registration'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						$isChecked = $rowData[\'on_register\'] && !$rowData[\'disabled\'] ? \' checked="checked"\' : \'\';
-						$isDisabled = $rowData[\'can_show_register\'] ? \'\' : \' disabled="disabled"\';
-						return sprintf(\'<input type="checkbox" name="reg[]" id="reg_%1$s" value="%1$s" class="input_check"%2$s%3$s />\', $rowData[\'id\'], $isChecked, $isDisabled);
-					'),
+					'function' => function($rowData)
+					{
+						$isChecked = $rowData['on_register'] && !$rowData['disabled'] ? ' checked' : '';
+						$isDisabled = $rowData['can_show_register'] ? '' : ' disabled';
+						return sprintf('<input type="checkbox" name="reg[]" id="reg_%1$s" value="%1$s" %2$s%3$s>', $rowData['id'], $isChecked, $isDisabled);
+					},
 					'style' => 'width: 20%; text-align: center;',
 				),
 			),
@@ -1391,11 +1445,10 @@ function ShowCustomProfiles()
 					'style' => 'text-align: left;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl;
-
-						return sprintf(\'<a href="%1$s?action=admin;area=featuresettings;sa=profileedit;fid=%2$d">%3$s</a><div class="smalltext">%4$s</div>\', $scripturl, $rowData[\'id_field\'], $rowData[\'field_name\'], $rowData[\'field_desc\']);
-					'),
+					'function' => function($rowData) use ($scripturl)
+					{
+						return sprintf('<a href="%1$s?action=admin;area=featuresettings;sa=profileedit;fid=%2$d">%3$s</a><div class="smalltext">%4$s</div>', $scripturl, $rowData['id_field'], $rowData['field_name'], $rowData['field_desc']);
+					},
 					'style' => 'width: 62%;',
 				),
 				'sort' => array(
@@ -1409,12 +1462,11 @@ function ShowCustomProfiles()
 					'style' => 'text-align: left;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
-						$textKey = sprintf(\'custom_profile_type_%1$s\', $rowData[\'field_type\']);
+					'function' => function($rowData) use ($txt)
+					{
+						$textKey = sprintf('custom_profile_type_%1$s', $rowData['field_type']);
 						return isset($txt[$textKey]) ? $txt[$textKey] : $textKey;
-					'),
+					},
 					'style' => 'width: 15%;',
 				),
 				'sort' => array(
@@ -1427,11 +1479,10 @@ function ShowCustomProfiles()
 					'value' => $txt['custom_profile_active'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
-						return $rowData[\'active\'] ? $txt[\'yes\'] : $txt[\'no\'];
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return $rowData['active'] ? $txt['yes'] : $txt['no'];
+					},
 					'style' => 'width: 8%; text-align: center;',
 				),
 				'sort' => array(
@@ -1444,11 +1495,12 @@ function ShowCustomProfiles()
 					'value' => $txt['custom_profile_placement'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
+					'function' => function($rowData)
+					{
+						global $txt, $context;
 
-						return $txt[\'custom_profile_placement_\' . (empty($rowData[\'placement\']) ? \'standard\' : ($rowData[\'placement\'] == 1 ? \'withicons\' : \'abovesignature\'))];
-					'),
+						return $txt['custom_profile_placement_' . (empty($rowData['placement']) ? 'standard' : ($rowData['placement'] == 1 ? 'withicons' : 'abovesignature'))];
+					},
 					'style' => 'width: 8%; text-align: center;',
 				),
 				'sort' => array(
diff --git a/Sources/ManageSmileys.php b/Sources/ManageSmileys.php
index 4d6e080..b7b5e11 100644
--- a/Sources/ManageSmileys.php
+++ b/Sources/ManageSmileys.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -371,9 +371,10 @@ function EditSmileySets()
 					'value' => $txt['smiley_sets_default'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return $rowData[\'selected\'] ? \'<strong>*</strong>\' : \'\';
-					'),
+					'function' => function($rowData)
+					{
+						return $rowData['selected'] ? '<strong>*</strong>' : '';
+					},
 					'style' => 'text-align: center;',
 				),
 				'sort' => array(
@@ -430,9 +431,10 @@ function EditSmileySets()
 					'value' => '<input type="checkbox" onclick="invertAll(this, this.form);" class="input_check" />',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return $rowData[\'id\'] == 0 ? \'\' : sprintf(\'<input type="checkbox" name="smiley_set[%1$d]" class="input_check" />\', $rowData[\'id\']);
-					'),
+					'function' => function($rowData)
+					{
+						return $rowData['id'] == 0 ? '' : sprintf('<input type="checkbox" name="smiley_set[%1$d]" class="input_check" />', $rowData['id']);
+					},
 					'style' => 'text-align: center',
 				),
 			),
@@ -952,16 +954,15 @@ function EditSmileys()
 						'value' => $txt['smileys_location'],
 					),
 					'data' => array(
-						'function' => create_function('$rowData', '
-							global $txt;
-
-							if (empty($rowData[\'hidden\']))
-								return $txt[\'smileys_location_form\'];
-							elseif ($rowData[\'hidden\'] == 1)
-								return $txt[\'smileys_location_hidden\'];
+						'function' => function($rowData) use ($txt)
+						{
+							if (empty($rowData['hidden']))
+								return $txt['smileys_location_form'];
+							elseif ($rowData['hidden'] == 1)
+								return $txt['smileys_location_hidden'];
 							else
-								return $txt[\'smileys_location_popup\'];
-						'),
+								return $txt['smileys_location_popup'];
+						},
 						'class' => 'windowbg',
 					),
 					'sort' => array(
@@ -974,24 +975,24 @@ function EditSmileys()
 						'value' => $txt['smileys_description'],
 					),
 					'data' => array(
-						'function' => create_function('$rowData', empty($modSettings['smileys_dir']) || !is_dir($modSettings['smileys_dir']) ? '
-							return htmlspecialchars($rowData[\'description\']);
-						' : '
-							global $context, $txt, $modSettings;
+						'function' => function($rowData) use ($modSettings, $context, $txt)
+						{
+							if (empty($modSettings['smileys_dir']) || !is_dir($modSettings['smileys_dir']))
+								return htmlspecialchars($rowData['description']);
 
 							// Check if there are smileys missing in some sets.
 							$missing_sets = array();
-							foreach ($context[\'smiley_sets\'] as $smiley_set)
-								if (!file_exists(sprintf(\'%1$s/%2$s/%3$s\', $modSettings[\'smileys_dir\'], $smiley_set[\'path\'], $rowData[\'filename\'])))
-									$missing_sets[] = $smiley_set[\'path\'];
+							foreach ($context['smiley_sets'] as $smiley_set)
+								if (!file_exists(sprintf('%1$s/%2$s/%3$s', $modSettings['smileys_dir'], $smiley_set['path'], $rowData['filename'])))
+									$missing_sets[] = $smiley_set['path'];
 
-							$description = htmlspecialchars($rowData[\'description\']);
+							$description = htmlspecialchars($rowData['description']);
 
 							if (!empty($missing_sets))
-								$description .= sprintf(\'<br /><span class="smalltext"><strong>%1$s:</strong> %2$s</span>\', $txt[\'smileys_not_found_in_set\'], implode(\', \', $missing_sets));
+								$description .= sprintf('<br /><span class="smalltext"><strong>%1$s:</strong> %2$s</span>', $txt['smileys_not_found_in_set'], implode(', ', $missing_sets));
 
 							return $description;
-						'),
+						},
 						'class' => 'windowbg',
 					),
 					'sort' => array(
@@ -1613,12 +1614,11 @@ function EditMessageIcons()
 		'columns' => array(
 			'icon' => array(
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $settings;
-
-						$images_url = $settings[file_exists(sprintf(\'%1$s/images/post/%2$s.gif\', $settings[\'theme_dir\'], $rowData[\'filename\'])) ? \'actual_images_url\' : \'default_images_url\'];
-						return sprintf(\'<img src="%1$s/post/%2$s.gif" alt="%3$s" />\', $images_url, $rowData[\'filename\'], htmlspecialchars($rowData[\'title\']));
-					'),
+					'function' => function($rowData) use ($settings)
+					{
+						$images_url = $settings[file_exists(sprintf('%1$s/images/post/%2$s.gif', $settings['theme_dir'], $rowData['filename'])) ? 'actual_images_url' : 'default_images_url'];
+						return sprintf('<img src="%1$s/post/%2$s.gif" alt="%3$s" />', $images_url, $rowData['filename'], htmlspecialchars($rowData['title']));
+					},
 				),
 				'style' => 'text-align: center;',
 			),
@@ -1649,11 +1649,10 @@ function EditMessageIcons()
 					'value' => $txt['icons_board'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
-						return empty($rowData[\'board_name\']) ? $txt[\'icons_edit_icons_all_boards\'] : $rowData[\'board_name\'];
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return empty($rowData['board_name']) ? $txt['icons_edit_icons_all_boards'] : $rowData['board_name'];
+					},
 				),
 			),
 			'modify' => array(
diff --git a/Sources/Memberlist.php b/Sources/Memberlist.php
index 27a7480..89a5f64 100644
--- a/Sources/Memberlist.php
+++ b/Sources/Memberlist.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -438,7 +438,7 @@ function MLSearch()
 	{
 		$_POST['search'] = trim(isset($_GET['search']) ? $_GET['search'] : $_POST['search']);
 
-		if (!get_magic_quotes_gpc())
+		if (!(version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc() != 0))
 		{
 			// Escape things just in case...
 			if (isset($_GET['fields']))
diff --git a/Sources/ModerationCenter.php b/Sources/ModerationCenter.php
index a0a6454..9ae21b5 100644
--- a/Sources/ModerationCenter.php
+++ b/Sources/ModerationCenter.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -1143,11 +1143,10 @@ function ViewWatchedUsers()
 					'value' => $txt['mc_watched_users_warning'],
 				),
 				'data' => array(
-					'function' => create_function('$member', '
-						global $scripturl;
-
-						return allowedTo(\'issue_warning\') ? \'<a href="\' . $scripturl . \'?action=profile;area=issuewarning;u=\' . $member[\'id\'] . \'">\' . $member[\'warning\'] . \'%</a>\' : $member[\'warning\'] . \'%\';
-					'),
+					'function' => function($member) use ($scripturl)
+					{
+						return allowedTo('issue_warning') ? '<a href="' . $scripturl . '?action=profile;area=issuewarning;u=' . $member['id'] . '">' . $member['warning'] . '%</a>' : $member['warning'] . '%';
+					},
 				),
 				'sort' => array(
 					'default' => 'warning',
@@ -1189,14 +1188,13 @@ function ViewWatchedUsers()
 					'value' => $txt['mc_watched_users_last_post'],
 				),
 				'data' => array(
-					'function' => create_function('$member', '
-						global $scripturl;
-
-						if ($member[\'last_post_id\'])
-							return \'<a href="\' . $scripturl . \'?msg=\' . $member[\'last_post_id\'] . \'">\' . $member[\'last_post\'] . \'</a>\';
+					'function' => function($member) use ($scripturl)
+					{
+						if ($member['last_post_id'])
+							return '<a href="' . $scripturl . '?msg=' . $member['last_post_id'] . '">' . $member['last_post'] . '</a>';
 						else
-							return $member[\'last_post\'];
-					'),
+							return $member['last_post'];
+					},
 				),
 			),
 		),
@@ -1225,9 +1223,10 @@ function ViewWatchedUsers()
 		$listOptions['columns'] = array(
 			'posts' => array(
 				'data' => array(
-					'function' => create_function('$post', '
+					'function' => function($post)
+					{
 						return template_user_watch_post_callback($post);
-					'),
+					},
 				),
 			),
 		);
@@ -1446,6 +1445,7 @@ function ViewWarnings()
 function ViewWarningLog()
 {
 	global $smcFunc, $modSettings, $context, $txt, $scripturl, $sourcedir;
+	global $settings;
 
 	// Setup context as always.
 	$context['page_title'] = $txt['mc_warning_log_title'];
@@ -1509,22 +1509,18 @@ function ViewWarningLog()
 					'value' => $txt['profile_warning_previous_reason'],
 				),
 				'data' => array(
-					'function' => create_function('$warning', '
-						global $scripturl, $settings, $txt;
-
-						$output = \'
+					'function' => function($rowData) use ($scripturl, $txt, $settings)
+					{
+						$output = '
 							<div class="floatleft">
-								\' . $warning[\'reason\'] . \'
-							</div>\';
-
-						if (!empty($warning[\'id_notice\']))
-							$output .= \'
-							<div class="floatright">
-								<a href="\' . $scripturl . \'?action=moderate;area=notice;nid=\' . $warning[\'id_notice\'] . \'" onclick="window.open(this.href, \\\'\\\', \\\'scrollbars=yes,resizable=yes,width=400,height=250\\\');return false;" target="_blank" class="new_win" title="\' . $txt[\'profile_warning_previous_notice\'] . \'"><img src="\' . $settings[\'default_images_url\'] . \'/filter.gif" alt="\' . $txt[\'profile_warning_previous_notice\'] . \'" /></a>
-							</div>\';
+								' . $rowData['reason'] . '
+							</div>';
 
+						if (!empty($rowData['id_notice']))
+							$output .= '
+								&nbsp;<a href="' . $scripturl . '?action=moderate;area=notice;nid=' . $rowData['id_notice'] . '" onclick="window.open(this.href, \'\', \'scrollbars=yes,resizable=yes,width=400,height=250\');return false;" target="_blank" rel="noopener" class="new_win" title="' . $txt['profile_warning_previous_notice'] . '"><img src="' . $settings['default_images_url'] . '/filter.gif" alt="' . $txt['profile_warning_previous_notice'] . '" /></a>';
 						return $output;
-					'),
+					},
 				),
 			),
 			'points' => array(
@@ -1712,11 +1708,10 @@ function ViewWarningTemplates()
 					'style' => 'width: 4%;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt, $scripturl;
-
-						return \'<input type="checkbox" name="deltpl[]" value="\' . $rowData[\'id_comment\'] . \'" class="input_check" />\';
-					'),
+					'function' => function($rowData)
+					{
+						return '<input type="checkbox" name="deltpl[]" value="' . $rowData['id_comment'] . '">';
+					},
 					'style' => 'text-align: center;',
 				),
 			),
diff --git a/Sources/Modlog.php b/Sources/Modlog.php
index d56f661..25c09a8 100644
--- a/Sources/Modlog.php
+++ b/Sources/Modlog.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -59,6 +59,8 @@ function ViewModlog()
 	$context['displaypage'] = 30;
 	// Amount of hours that must pass before allowed to delete file.
 	$context['hoursdisable'] = 24;
+	// Actions whose log entries cannot be deleted.
+	$context['uneditable_actions'] = !empty($modSettings['force_gdpr']) ? array('agreement_updated', 'policy_updated') : array();
 
 	// Handle deletion...
 	if (isset($_POST['removeall']) && $context['can_delete'])
@@ -68,10 +70,12 @@ function ViewModlog()
 		$smcFunc['db_query']('', '
 			DELETE FROM {db_prefix}log_actions
 			WHERE id_log = {int:moderate_log}
-				AND log_time < {int:twenty_four_hours_wait}',
+				AND log_time < {int:twenty_four_hours_wait}' . (!empty($context['uneditable_actions']) ? '
+				AND action NOT IN ({array_string:uneditable})' : ''),
 			array(
 				'twenty_four_hours_wait' => time() - $context['hoursdisable'] * 3600,
 				'moderate_log' => $context['log_type'],
+				'uneditable' => $context['uneditable_actions'],
 			)
 		);
 	}
@@ -82,11 +86,13 @@ function ViewModlog()
 			DELETE FROM {db_prefix}log_actions
 			WHERE id_log = {int:moderate_log}
 				AND id_action IN ({array_string:delete_actions})
-				AND log_time < {int:twenty_four_hours_wait}',
+				AND log_time < {int:twenty_four_hours_wait}' . (!empty($context['uneditable_actions']) ? '
+				AND action NOT IN ({array_string:uneditable})' : ''),
 			array(
 				'twenty_four_hours_wait' => time() - $context['hoursdisable'] * 3600,
 				'delete_actions' => array_unique($_POST['delete']),
 				'moderate_log' => $context['log_type'],
+				'uneditable' => $context['uneditable_actions'],
 			)
 		);
 	}
@@ -260,9 +266,10 @@ function ViewModlog()
 					'value' => '<input type="checkbox" name="all" class="input_check" onclick="invertAll(this, this.form);" />',
 				),
 				'data' => array(
-					'function' => create_function('$entry', '
-						return \'<input type="checkbox" class="input_check" name="delete[]" value="\' . $entry[\'id\'] . \'"\' . ($entry[\'editable\'] ? \'\' : \' disabled="disabled"\') . \' />\';
-					'),
+					'function' => function($entry)
+					{
+						return '<input type="checkbox" class="input_check" name="delete[]" value="' . $entry['id'] . '"' . ($entry['editable'] ? '' : ' disabled="disabled"') . ' />';
+					},
 					'style' => 'text-align: center;',
 				),
 			),
@@ -279,7 +286,7 @@ function ViewModlog()
 		'additional_rows' => array(
 			array(
 				'position' => 'after_title',
-				'value' => $txt['modlog_' . ($context['log_type'] == 3 ? 'admin' : 'moderation') . '_log_desc'],
+				'value' => $txt['modlog_' . ($context['log_type'] == 3 ? 'admin' : 'moderation') . '_log_desc'] . (!empty($modSettings['force_gdpr']) && $context['log_type'] == 3 ? '<br />' . $txt['modlog_admin_log_gdpr_no_delete'] : ''),
 				'class' => 'smalltext',
 				'style' => 'padding: 2ex;',
 			),
@@ -341,6 +348,8 @@ function list_getModLogEntries($start, $items_per_page, $sort, $query_string = '
 	// Do a little bit of self protection.
 	if (!isset($context['hoursdisable']))
 		$context['hoursdisable'] = 24;
+	if (!isset($context['uneditable_actions']))
+		$context['uneditable_actions'] = array();
 
 	// Can they see the IP address?
 	$seeIP = allowedTo('moderate_forum');
@@ -454,7 +463,7 @@ function list_getModLogEntries($start, $items_per_page, $sort, $query_string = '
 			'moderator_link' => $row['id_member'] ? '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '">' . $row['real_name'] . '</a>' : (empty($row['real_name']) ? ($txt['guest'] . (!empty($row['extra']['member_acted']) ? ' (' . $row['extra']['member_acted'] . ')' : '')) : $row['real_name']),
 			'time' => timeformat($row['log_time']),
 			'timestamp' => forum_time(true, $row['log_time']),
-			'editable' => time() > $row['log_time'] + $context['hoursdisable'] * 3600,
+			'editable' => time() > $row['log_time'] + $context['hoursdisable'] * 3600 && !in_array($row['action'], $context['uneditable_actions']),
 			'extra' => $row['extra'],
 			'action' => $row['action'],
 			'action_text' => isset($row['action_text']) ? $row['action_text'] : '',
@@ -588,7 +597,6 @@ function list_getModLogEntries($start, $items_per_page, $sort, $query_string = '
 	}
 
 	// Do some formatting of the action string.
-	$callback = pregReplaceCurry('list_getModLogEntriesCallback', 3);
 	foreach ($entries as $k => $entry)
 	{
 		// Make any message info links so its easier to go find that message.
@@ -602,18 +610,15 @@ function list_getModLogEntries($start, $items_per_page, $sort, $query_string = '
 
 		if (empty($entries[$k]['action_text']))
 			$entries[$k]['action_text'] = isset($txt['modlog_ac_' . $entry['action']]) ? $txt['modlog_ac_' . $entry['action']] : $entry['action'];
-		$entries[$k]['action_text'] = preg_replace_callback('~\{([A-Za-z\d_]+)\}~i', $callback($entries, $k), $entries[$k]['action_text']);
-
+		$entries[$k]['action_text'] = preg_replace_callback('~\{([A-Za-z\d_]+)\}~i',
+			function($matches) use ($entries, $k)
+			{
+				return isset($entries[$k]['extra'][$matches[1]]) ? $entries[$k]['extra'][$matches[1]] : '';
+			}, $entries[$k]['action_text']);
 	}
 
 	// Back we go!
 	return $entries;
 }
 
-// Mog Log Replacment Callback.
-function list_getModLogEntriesCallback($entries, $key, $matches)
-{
-    return isset($entries[$key]['extra'][$matches[1]]) ? $entries[$key]['extra'][$matches[1]] : '';
-}
-
 ?>
\ No newline at end of file
diff --git a/Sources/News.php b/Sources/News.php
index b5e138e..6f5e1b6 100644
--- a/Sources/News.php
+++ b/Sources/News.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.8
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -65,7 +65,7 @@ function ShowXmlFeed()
 	global $query_this_board, $smcFunc, $forum_version, $cdata_override;
 
 	// If it's not enabled, die.
-	if (empty($modSettings['xmlnews_enable']))
+	if (empty($modSettings['xmlnews_enable']) && (empty($_GET['sa']) || empty($_GET['u']) || $_GET['sa'] !== 'profile' || $_GET['u'] !== $user_info['id']))
 		obExit(false);
 
 	loadLanguage('Stats');
@@ -259,6 +259,19 @@ function ShowXmlFeed()
 	elseif ($xml_format == 'rdf')
 		header('Content-Type: ' . ($context['browser']['is_ie'] ? 'text/xml' : 'application/rdf+xml') . '; charset=' . (empty($context['character_set']) ? 'ISO-8859-1' : $context['character_set']));
 
+	// Descriptive filenames = good
+	$xml_filename = array(preg_replace('/\s+/', '_', $feed_title), $_GET['sa']);
+	if ($_GET['sa'] === 'profile')
+		$xml_filename[] = 'u=' . (isset($_GET['u']) ? (int) $_GET['u'] : $user_info['id']);
+	if (!empty($boards))
+		$xml_filename[] = 'boards=' . implode(',', $boards);
+	elseif (!empty($board))
+		$xml_filename[] = 'board=' . $board;
+	$xml_filename[] = $xml_format;
+	$xml_filename = strtr(un_htmlspecialchars(implode('-', $xml_filename)), '"', '') ;
+
+	header('Content-Disposition: ' . (isset($_GET['download']) ? 'attachment' : 'inline') . '; filename="' . $xml_filename . '.xml"');
+
 	// First, output the xml header.
 	echo '<?xml version="1.0" encoding="', $context['character_set'], '"?' . '>';
 
@@ -313,7 +326,7 @@ function ShowXmlFeed()
 
 	<modified>', gmstrftime('%Y-%m-%dT%H:%M:%SZ'), '</modified>
 	<tagline><![CDATA[', strip_tags($txt['xml_rss_desc']), ']]></tagline>
-	<generator uri="http://www.simplemachines.org" version="', strtr($forum_version, array('SMF' => '')), '">SMF</generator>
+	<generator uri="https://www.simplemachines.org" version="', strtr($forum_version, array('SMF' => '')), '">SMF</generator>
 	<author>
 		<name>', strip_tags($context['forum_name']), '</name>
 	</author>';
@@ -389,13 +402,17 @@ function cdata_parse($data, $ns = '')
 	if (!empty($cdata_override))
 		return $data;
 
+	// Do we even need to do this?
+	if (strpbrk($data, '<>&') == false)
+		return $data;
+
 	$cdata = '<![CDATA[';
 
 	for ($pos = 0, $n = $smcFunc['strlen']($data); $pos < $n; null)
 	{
 		$positions = array(
 			$smcFunc['strpos']($data, '&', $pos),
-			$smcFunc['strpos']($data, ']', $pos),
+			$smcFunc['strpos']($data, ']]>', $pos),
 		);
 		if ($ns != '')
 			$positions[] = $smcFunc['strpos']($data, '<', $pos);
@@ -424,10 +441,10 @@ function cdata_parse($data, $ns = '')
 				$cdata .= ']]><' . $ns . ':' . $smcFunc['substr']($data, $pos + 1, $pos2 - $pos) . '<![CDATA[';
 			$pos = $pos2 + 1;
 		}
-		elseif ($smcFunc['substr']($data, $pos, 1) == ']')
+		elseif ($smcFunc['substr']($data, $pos, 3) == ']]>')
 		{
-			$cdata .= ']]>&#093;<![CDATA[';
-			$pos++;
+			$cdata .= ']]]]><![CDATA[>';
+			$pos = $pos + 3;
 		}
 		elseif ($smcFunc['substr']($data, $pos, 1) == '&')
 		{
@@ -850,7 +867,7 @@ function getXmlRecent($xml_format)
 
 function getXmlProfile($xml_format)
 {
-	global $scripturl, $memberContext, $user_profile, $modSettings, $user_info;
+	global $scripturl, $memberContext, $user_profile, $modSettings, $user_info, $smcFunc, $language;
 
 	// You must input a valid user....
 	if (empty($_GET['u']) || loadMemberData((int) $_GET['u']) === false)
@@ -887,7 +904,7 @@ function getXmlProfile($xml_format)
 			'summary' => cdata_parse(isset($profile['group']) ? $profile['group'] : $profile['post_group']),
 			'author' => array(
 				'name' => $profile['real_name'],
-				'email' => in_array(showEmailAddress(!empty($profile['hide_email']), $profile['id']), array('yes', 'yes_permission_override')) ? $profile['email'] : null,
+				'email' => $user_info['id'] == $profile['id'] || in_array($profile['show_email'], array('yes', 'yes_permission_override')) ? $profile['email'] : null,
 				'uri' => !empty($profile['website']) ? $profile['website']['url'] : ''
 			),
 			'published' => gmstrftime('%Y-%m-%dT%H:%M:%SZ', $user_profile[$profile['id']]['date_registered']),
@@ -903,7 +920,7 @@ function getXmlProfile($xml_format)
 			'link' => $scripturl . '?action=profile;u=' . $profile['id'],
 			'posts' => $profile['posts'],
 			'post-group' => cdata_parse($profile['post_group']),
-			'language' => cdata_parse($profile['language']),
+			'language' => cdata_parse(!empty($profile['language']) ? $profile['language'] : $smcFunc['ucwords'](strtr($language, array('_' => ' ', '-utf8' => '')))),
 			'last-login' => gmdate('D, d M Y H:i:s \G\M\T', $user_profile[$profile['id']]['last_login']),
 			'registered' => gmdate('D, d M Y H:i:s \G\M\T', $user_profile[$profile['id']]['date_registered'])
 		);
@@ -952,7 +969,7 @@ function getXmlProfile($xml_format)
 				'bad' => $profile['karma']['bad']
 			);
 
-		if (in_array($profile['show_email'], array('yes', 'yes_permission_override')))
+		if ($user_info['id'] == $profile['id'] || in_array($profile['show_email'], array('yes', 'yes_permission_override')))
 			$data['email'] = $profile['email'];
 
 		if (!empty($profile['birth_date']) && substr($profile['birth_date'], 0, 4) != '0000')
diff --git a/Sources/Notify.php b/Sources/Notify.php
index c6da2d7..843a586 100644
--- a/Sources/Notify.php
+++ b/Sources/Notify.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -34,6 +34,22 @@ if (!defined('SMF'))
 		- requires the mark_notify permission.
 		- redirects the user back to the board after it is done.
 		- is accessed via ?action=notifyboard.
+
+	void AnnouncementsNotify()
+		- is called to turn off/on notification for newsletters, announcements, etc.
+		- uses the Notify template. (notify_board sub template.)
+		- asks for a sub action (on/off) if none was specified.
+		- shows a success message after it is done.
+		- is accessed via ?action=notifyannoucements.
+
+	void getMemberWithToken(type = '')
+		- verifies a subscribe/unsubscribe token, then returns some basic member info.
+		- the type parameter is used to indicate what sort of notification the token is for.
+		- shows a fatal error message to the user and dies if the token is invalid.
+
+	void createUnsubscribeToken(int memID, string email, type = '', itemID = 0)
+		- builds a subscribe/unsubscribe token.
+		- each token is unique to a member's email and to the thing they want to unsubscribe from
 */
 
 // Turn on/off notifications...
@@ -41,9 +57,21 @@ function Notify()
 {
 	global $scripturl, $txt, $topic, $user_info, $context, $smcFunc;
 
-	// Make sure they aren't a guest or something - guests can't really receive notifications!
-	is_not_guest();
-	isAllowedTo('mark_any_notify');
+	// Are they trying a token-based anonymous request?
+	if (isset($_REQUEST['u']) && isset($_REQUEST['token']))
+	{
+		$member_info = getMemberWithToken('topic');
+		$skipCheckSession = true;
+	}
+	// Otherwise, this is for the current user.
+	else
+	{
+		// Make sure they aren't a guest or something - guests can't really receive notifications!
+		is_not_guest();
+		isAllowedTo('mark_any_notify');
+
+		$member_info = $user_info;
+	}
 
 	// Make sure the topic has been specified.
 	if (empty($topic))
@@ -63,13 +91,19 @@ function Notify()
 				AND id_topic = {int:current_topic}
 			LIMIT 1',
 			array(
-				'current_member' => $user_info['id'],
+				'current_member' => $member_info['id'],
 				'current_topic' => $topic,
 			)
 		);
 		$context['notification_set'] = $smcFunc['db_num_rows']($request) != 0;
 		$smcFunc['db_free_result']($request);
 
+		if ($member_info['id'] !== $user_info['id'])
+			$context['notify_info'] = array(
+				'u' => $member_info['id'],
+				'token' => $_REQUEST['token'],
+			);
+
 		// Set the template variables...
 		$context['topic_href'] = $scripturl . '?topic=' . $topic . '.' . $_REQUEST['start'];
 		$context['start'] = $_REQUEST['start'];
@@ -79,19 +113,21 @@ function Notify()
 	}
 	elseif ($_GET['sa'] == 'on')
 	{
-		checkSession('get');
+		if (empty($skipCheckSession))
+			checkSession('get');
 
 		// Attempt to turn notifications on.
 		$smcFunc['db_insert']('ignore',
 			'{db_prefix}log_notify',
 			array('id_member' => 'int', 'id_topic' => 'int'),
-			array($user_info['id'], $topic),
+			array($member_info['id'], $topic),
 			array('id_member', 'id_topic')
 		);
 	}
 	else
 	{
-		checkSession('get');
+		if (empty($skipCheckSession))
+			checkSession('get');
 
 		// Just turn notifications off.
 		$smcFunc['db_query']('', '
@@ -99,12 +135,22 @@ function Notify()
 			WHERE id_member = {int:current_member}
 				AND id_topic = {int:current_topic}',
 			array(
-				'current_member' => $user_info['id'],
+				'current_member' => $member_info['id'],
 				'current_topic' => $topic,
 			)
 		);
 	}
 
+	// If this request wasn't for the current user, just show a confirmation message.
+	if ($member_info['id'] !== $user_info['id'])
+	{
+		loadTemplate('Notify');
+		$context['page_title'] = $txt['notification'];
+		$context['sub_template'] = 'notify_pref_changed';
+		$context['notify_success_msg'] = sprintf($txt['notifytopic' . ($_GET['sa'] == 'on' ? '_subscribed' : '_unsubscribed')], $member_info['email']);
+		return;
+	}
+
 	// Send them back to the topic.
 	redirectexit('topic=' . $topic . '.' . $_REQUEST['start']);
 }
@@ -113,9 +159,21 @@ function BoardNotify()
 {
 	global $scripturl, $txt, $board, $user_info, $context, $smcFunc;
 
-	// Permissions are an important part of anything ;).
-	is_not_guest();
-	isAllowedTo('mark_notify');
+	// Unsubscribing with a token.
+	if (isset($_REQUEST['u']) && isset($_REQUEST['token']))
+	{
+		$member_info = getMemberWithToken('board');
+		$skipCheckSession = true;
+	}
+	// No token, so try with the current user.
+	else
+	{
+		// Permissions are an important part of anything ;).
+		is_not_guest();
+		isAllowedTo('mark_notify');
+
+		$member_info = $user_info;
+	}
 
 	// You have to specify a board to turn notifications on!
 	if (empty($board))
@@ -136,12 +194,18 @@ function BoardNotify()
 			LIMIT 1',
 			array(
 				'current_board' => $board,
-				'current_member' => $user_info['id'],
+				'current_member' => $member_info['id'],
 			)
 		);
 		$context['notification_set'] = $smcFunc['db_num_rows']($request) != 0;
 		$smcFunc['db_free_result']($request);
 
+		if ($member_info['id'] !== $user_info['id'])
+			$context['notify_info'] = array(
+				'u' => $member_info['id'],
+				'token' => $_REQUEST['token'],
+			);
+
 		// Set the template variables...
 		$context['board_href'] = $scripturl . '?board=' . $board . '.' . $_REQUEST['start'];
 		$context['start'] = $_REQUEST['start'];
@@ -153,20 +217,22 @@ function BoardNotify()
 	// Turn the board level notification on....
 	elseif ($_GET['sa'] == 'on')
 	{
-		checkSession('get');
+		if (empty($skipCheckSession))
+			checkSession('get');
 
 		// Turn notification on.  (note this just blows smoke if it's already on.)
 		$smcFunc['db_insert']('ignore',
 			'{db_prefix}log_notify',
 			array('id_member' => 'int', 'id_board' => 'int'),
-			array($user_info['id'], $board),
+			array($member_info['id'], $board),
 			array('id_member', 'id_board')
 		);
 	}
 	// ...or off?
 	else
 	{
-		checkSession('get');
+		if (empty($skipCheckSession))
+			checkSession('get');
 
 		// Turn notification off for this board.
 		$smcFunc['db_query']('', '
@@ -175,13 +241,117 @@ function BoardNotify()
 				AND id_board = {int:current_board}',
 			array(
 				'current_board' => $board,
-				'current_member' => $user_info['id'],
+				'current_member' => $member_info['id'],
 			)
 		);
 	}
 
+	// Probably a guest, so just show a confirmation message.
+	if ($member_info['id'] !== $user_info['id'])
+	{
+		loadTemplate('Notify');
+		$context['page_title'] = $txt['notification'];
+		$context['sub_template'] = 'notify_pref_changed';
+		$context['notify_success_msg'] = sprintf($txt['notifyboard' . ($_GET['sa'] == 'on' ? '_subscribed' : '_unsubscribed')], $member_info['email']);
+		return;
+	}
+
 	// Back to the board!
 	redirectexit('board=' . $board . '.' . $_REQUEST['start']);
 }
 
+function AnnouncementsNotify()
+{
+	global $scripturl, $txt, $board, $user_info, $context, $smcFunc;
+
+	if (isset($_REQUEST['u']) && isset($_REQUEST['token']))
+	{
+		$member_info = getMemberWithToken('announcements');
+		$skipCheckSession = true;
+	}
+	else
+	{
+		is_not_guest();
+		$member_info = $user_info;
+	}
+
+	loadTemplate('Notify');
+	$context['page_title'] = $txt['notification'];
+
+	// Ask what they want to do.
+	if (empty($_GET['sa']))
+	{
+		$context['sub_template'] = 'notify_announcements';
+
+		if ($member_info['id'] !== $user_info['id'])
+			$context['notify_info'] = array(
+				'u' => $member_info['id'],
+				'token' => $_REQUEST['token'],
+			);
+
+		return;
+	}
+
+	// We don't tolerate imposters around here.
+	if (empty($skipCheckSession))
+		checkSession('get');
+
+	// Update their announcement notification preference.
+	updateMemberData($member_info['id'], array('notify_announcements' => $_GET['sa'] == 'on' ? '1' : '0'));
+
+	$context['sub_template'] = 'notify_pref_changed';
+	$context['notify_success_msg'] = sprintf($txt['notifyannouncements' . ($_GET['sa'] == 'on' ? '_subscribed' : '_unsubscribed')], $member_info['email']);
+}
+
+// Verifies the token, then returns some member info
+function getMemberWithToken($type)
+{
+	global $smcFunc, $board, $topic, $modSettings;
+
+	// Keep it sanitary, folks
+	$id_member = !empty($_REQUEST['u']) ? (int) $_REQUEST['u'] : 0;
+
+	// We can't do anything without these
+	if (empty($id_member) || empty($_REQUEST['token']))
+		fatal_lang_error('unsubscribe_invalid', false);
+
+	// Get the user info we need
+	$request = $smcFunc['db_query']('', '
+		SELECT id_member AS id, email_address AS email
+		FROM {db_prefix}members
+		WHERE id_member = {int:id_member}',
+		array(
+			'id_member' => $id_member,
+		)
+	);
+	if ($smcFunc['db_num_rows']($request) == 0)
+		fatal_lang_error('unsubscribe_invalid', false);
+	$member_info = $smcFunc['db_fetch_assoc']($request);
+	$smcFunc['db_free_result']($request);
+
+	// What token are we expecting?
+	$expected_token = createUnsubscribeToken($member_info['id'], $member_info['email'], $type, in_array($type, array('board', 'topic')) && !empty($$type) ? $$type : 0);
+
+	// Don't do anything if the token they gave is wrong
+	if ($_REQUEST['token'] !== $expected_token)
+		fatal_lang_error('unsubscribe_invalid', false);
+
+	// At this point, we know we have a legitimate unsubscribe request
+	return $member_info;
+}
+
+function createUnsubscribeToken($memID, $email, $type = '', $itemID = 0)
+{
+	$token_items = implode(' ', array($memID, $email, $type, $itemID));
+
+	// When the message is public and the key is secret, an HMAC is the appropriate tool.
+	$token = hash_hmac('sha256', $token_items, get_auth_secret(), true);
+
+	// When using an HMAC, 80 bits (10 bytes) is plenty for security.
+	$token = substr($token, 0, 10);
+
+	// Use base64 (with URL-friendly characters) to make the token shorter.
+	return strtr(base64_encode($token), array('+' => '_', '/' => '-', '=' => ''));
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/Packages.php b/Sources/Packages.php
index 047e9c3..b00c33b 100644
--- a/Sources/Packages.php
+++ b/Sources/Packages.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -426,7 +426,7 @@ function PackageInstallTest()
 
 						$context['theme_actions'][$mod_action['is_custom']]['actions'][$actual_filename] = array(
 							'type' => $txt['execute_modification'],
-							'action' => $smcFunc['htmlspecialchars'](strtr($mod_action['filename'], array($boarddir => '.'))),
+							'action' => $smcFunc['htmlspecialchars'](strtr($mod_action['filename'], array(strtr($boarddir, '\\', '/') => '.'))),
 							'description' => $failed ? $txt['package_action_failure'] : $txt['package_action_success'],
 							'failed' => $failed,
 						);
@@ -435,7 +435,7 @@ function PackageInstallTest()
 					{
 						$context['actions'][$actual_filename] = array(
 							'type' => $txt['execute_modification'],
-							'action' => $smcFunc['htmlspecialchars'](strtr($mod_action['filename'], array($boarddir => '.'))),
+							'action' => $smcFunc['htmlspecialchars'](strtr($mod_action['filename'], array(strtr($boarddir, '\\', '/') => '.'))),
 							'description' => $failed ? $txt['package_action_failure'] : $txt['package_action_success'],
 							'failed' => $failed,
 						);
diff --git a/Sources/PersonalMessage.php b/Sources/PersonalMessage.php
index 50df1fe..7be4db6 100644
--- a/Sources/PersonalMessage.php
+++ b/Sources/PersonalMessage.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -715,7 +715,7 @@ function MessageFolder()
 					AND pmr.deleted = {int:is_deleted}
 					' . $labelQuery . ')') . ($context['sort_by'] == 'name' ? ( '
 				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = {raw:pm_member})') : '') . '
-			WHERE ' . ($context['folder'] == 'sent' ? 'pm.id_member_from = {raw:current_member}
+			WHERE ' . ($context['folder'] == 'sent' ? 'pm.id_member_from = {int:current_member}
 				AND pm.deleted_by_sender = {int:is_deleted}' : '1=1') . (empty($pmsg) ? '' : '
 				AND pm.id_pm = {int:pmsg}') . '
 			ORDER BY ' . ($_GET['sort'] == 'pm.id_pm' && $context['folder'] != 'sent' ? 'pmr.id_pm' : '{raw:sort}') . ($descending ? ' DESC' : ' ASC') . (empty($pmsg) ? '
@@ -936,6 +936,8 @@ function prepareMessageContext($type = 'subject', $reset = false)
 		$_SESSION['pm_selected'] = array();
 	}
 
+	$context['labels'] = !empty($context['labels']) ? (array) $context['labels'] : array();
+
 	// If we're in non-boring view do something exciting!
 	if ($context['display_mode'] != 0 && $subjects_request && $type == 'subject')
 	{
@@ -962,7 +964,7 @@ function prepareMessageContext($type = 'subject', $reset = false)
 			'timestamp' => forum_time(true, $subject['msgtime']),
 			'number_recipients' => count($recipients[$subject['id_pm']]['to']),
 			'labels' => &$context['message_labels'][$subject['id_pm']],
-			'fully_labeled' => count($context['message_labels'][$subject['id_pm']]) == count($context['labels']),
+			'fully_labeled' => (!empty($context['message_labels'][$subject['id_pm']]) ? count($context['message_labels'][$subject['id_pm']]) : 0) == count($context['labels']),
 			'is_replied_to' => &$context['message_replied'][$subject['id_pm']],
 			'is_unread' => &$context['message_unread'][$subject['id_pm']],
 			'is_selected' => !empty($temp_pm_selected) && in_array($subject['id_pm'], $temp_pm_selected),
@@ -1030,7 +1032,7 @@ function prepareMessageContext($type = 'subject', $reset = false)
 		'recipients' => &$recipients[$message['id_pm']],
 		'number_recipients' => count($recipients[$message['id_pm']]['to']),
 		'labels' => &$context['message_labels'][$message['id_pm']],
-		'fully_labeled' => count($context['message_labels'][$message['id_pm']]) == count($context['labels']),
+		'fully_labeled' => (!empty($context['message_labels'][$message['id_pm']]) ? count($context['message_labels'][$message['id_pm']]) : 0) == count($context['labels']),
 		'is_replied_to' => &$context['message_replied'][$message['id_pm']],
 		'is_unread' => &$context['message_unread'][$message['id_pm']],
 		'is_selected' => !empty($temp_pm_selected) && in_array($message['id_pm'], $temp_pm_selected),
@@ -1189,34 +1191,52 @@ function MessageSearch2()
 				unset($possible_users[$k]);
 		}
 
-		// Who matches those criteria?
-		// !!! This doesn't support sent item searching.
-		$request = $smcFunc['db_query']('', '
-			SELECT id_member
-			FROM {db_prefix}members
-			WHERE real_name LIKE {raw:real_name_implode}',
-			array(
-				'real_name_implode' => '\'' . implode('\' OR real_name LIKE \'', $possible_users) . '\'',
-			)
-		);
-		// Simply do nothing if there're too many members matching the criteria.
-		if ($smcFunc['db_num_rows']($request) > $maxMembersToSearch)
-			$userQuery = '';
-		elseif ($smcFunc['db_num_rows']($request) == 0)
+		if (!empty($possible_users))
 		{
-			$userQuery = 'AND pm.id_member_from = 0 AND (pm.from_name LIKE {raw:guest_user_name_implode})';
-			$searchq_parameters['guest_user_name_implode'] = '\'' . implode('\' OR pm.from_name LIKE \'', $possible_users) . '\'';
+			// We need to bring this into the query and do it nice and cleanly.
+			$where_params = array();
+			$where_clause = array();
+			foreach ($possible_users as $k => $v)
+			{
+				$where_params['name_' . $k] = $v;
+				$where_clause[] = '{raw:real_name} LIKE {string:name_' . $k . '}';
+				if (!isset($where_params['real_name']))
+					$where_params['real_name'] = $smcFunc['db_case_sensitive'] ? 'LOWER(real_name)' : 'real_name';
+			}
+
+			// Who matches those criteria?
+			// !!! This doesn't support sent item searching.
+			$request = $smcFunc['db_query']('', '
+				SELECT id_member
+				FROM {db_prefix}members
+				WHERE ' . implode(' OR ', $where_clause),
+				$where_params
+			);
+
+			// Simply do nothing if there're too many members matching the criteria.
+			if ($smcFunc['db_num_rows']($request) > $maxMembersToSearch)
+				$userQuery = '';
+			elseif ($smcFunc['db_num_rows']($request) == 0)
+			{
+				$where_params['real_name'] = 'pm.from_name';
+				$searchq_parameters = array_merge($searchq_parameters, $where_params);
+				$userQuery = 'AND pm.id_member_from = 0 AND (' . implode(' OR ', $where_clause) . ')';
+			}
+			else
+			{
+				$memberlist = array();
+				while ($row = $smcFunc['db_fetch_assoc']($request))
+					$memberlist[] = $row['id_member'];
+
+				$where_params['real_name'] = 'pm.from_name';
+				$searchq_parameters = array_merge($searchq_parameters, $where_params);
+				$searchq_parameters['member_list'] = $memberlist;
+				$userQuery = 'AND (pm.id_member_from IN ({array_int:member_list}) OR (pm.id_member_from = 0 AND (' . implode(' OR ', $where_clause) . ')))';
+			}
+			$smcFunc['db_free_result']($request);
 		}
 		else
-		{
-			$memberlist = array();
-			while ($row = $smcFunc['db_fetch_assoc']($request))
-				$memberlist[] = $row['id_member'];
-			$userQuery = 'AND (pm.id_member_from IN ({array_int:member_list}) OR (pm.id_member_from = 0 AND (pm.from_name LIKE {raw:guest_user_name_implode})))';
-			$searchq_parameters['guest_user_name_implode'] = '\'' . implode('\' OR pm.from_name LIKE \'', $possible_users) . '\'';
-			$searchq_parameters['member_list'] = $memberlist;
-		}
-		$smcFunc['db_free_result']($request);
+			$userQuery = '';
 	}
 
 	// Setup the sorting variables...
@@ -2448,7 +2468,7 @@ function MessageActionsApply()
 				$set = '-1';
 
 			// Check that this string isn't going to be too large for the database.
-			if ($set > 60)
+			if ($smcFunc['strlen']($set) > 60)
 				$updateErrors++;
 			else
 			{
@@ -3210,6 +3230,12 @@ function ManageRules()
 {
 	global $txt, $context, $user_info, $scripturl, $smcFunc;
 
+	// Limit the Criteria and Actions to this.
+	$context['rule_limiters'] = array(
+		'criteria' => 10,
+		'actions' => 10,
+	);
+
 	// The link tree - gotta have this :o
 	$context['linktree'][] = array(
 		'url' => $scripturl . '?action=pm;sa=manrules',
@@ -3253,6 +3279,7 @@ function ManageRules()
 	if (isset($_GET['apply']))
 	{
 		checkSession('get');
+		spamProtection('pm');
 
 		ApplyRules(true);
 		redirectexit('action=pm;sa=manrules');
@@ -3314,6 +3341,7 @@ function ManageRules()
 
 		// Let's do the criteria first - it's also hardest!
 		$criteria = array();
+		$criteriaCount = 0;
 		foreach ($_POST['ruletype'] as $ind => $type)
 		{
 			// Check everything is here...
@@ -3322,6 +3350,10 @@ function ManageRules()
 			elseif ($type != 'bud' && !isset($_POST['ruledef'][$ind]))
 				continue;
 
+			// Too many rules in this rule.
+			if ($criteriaCount++ >= $context['rule_limiters']['criteria'])
+				break;
+
 			// Members need to be found.
 			if ($type == 'mid')
 			{
@@ -3354,12 +3386,17 @@ function ManageRules()
 		$actions = array();
 		$doDelete = 0;
 		$isOr = $_POST['rule_logic'] == 'or' ? 1 : 0;
+		$actionCount = 0;
 		foreach ($_POST['acttype'] as $ind => $type)
 		{
 			// Picking a valid label?
-			if ($type == 'lab' && (!isset($_POST['labdef'][$ind]) || !isset($context['labels'][$_POST['labdef'][$ind] - 1])))
+			if ($type == 'lab' && (!ctype_digit((string) $ind) || !isset($_POST['labdef'][$ind]) || $_POST['labdef'][$ind] == '' || !isset($context['labels'][$_POST['labdef'][$ind] - 1])))
 				continue;
 
+			// Too many actions in this rule.
+			if ($actionCount++ >= $context['rule_limiters']['actions'])
+				break;
+
 			// Record what we're doing.
 			if ($type == 'del')
 				$doDelete = 1;
diff --git a/Sources/Poll.php b/Sources/Poll.php
index 480c022..c0e031f 100644
--- a/Sources/Poll.php
+++ b/Sources/Poll.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -231,12 +231,12 @@ function Vote()
 			FROM {db_prefix}poll_choices
 			WHERE id_poll = {int:id_poll} AND id_choice IN ({array_int:poll_options})',
 			array( 'id_poll' => $row['id_poll'], 'poll_options' => $pollOptions )
-		);	
+		);
 		while ($choice = $smcFunc['db_fetch_assoc']($request))
 		{
 			if ($choice['requires_comment'] == 1)
 				fatal_lang_error('poll_vv_cmt_missing_required', false, array(1+$choice['id_choice'], $choice['label']));
-		}	
+		}
 		$smcFunc['db_free_result']($request);
 	}
 
@@ -265,7 +265,7 @@ function Vote()
 		// Time is stored in case the poll is reset later, plus what they voted for.
 		$_COOKIE['guest_poll_vote'] = empty($_COOKIE['guest_poll_vote']) ? '' : $_COOKIE['guest_poll_vote'];
 		// ;id,timestamp,[vote,vote...]; etc
-		$_COOKIE['guest_poll_vote'] .= ';' . $row['id_poll'] . ',' . time() . ',' . (count($pollOptions) > 1 ? explode(',' . $pollOptions) : $pollOptions[0]);
+		$_COOKIE['guest_poll_vote'] .= ';' . $row['id_poll'] . ',' . time() . ',' . implode(',', $pollOptions);
 
 		// Increase num guest voters count by 1
 		$smcFunc['db_query']('', '
@@ -405,7 +405,7 @@ function EditPoll()
 		$context['poll'] = array(
 			'id' => $pollinfo['id_poll'],
 			'question' => $question,
-			'hide_results' => empty($_POST['poll_hide']) ? 0 : $_POST['poll_hide'],
+			'hide_results' => empty($_POST['poll_hide']) ? 0 : (int) $_POST['poll_hide'],
 			'vvis' => empty($_POST['poll_vvis']) ? 0 : $_POST['poll_vvis'],
 			'vcmt' => empty($_POST['poll_vcmt']) ? 0 : $_POST['poll_vcmt'],
 			'change_vote' => isset($_POST['poll_change_vote']),
@@ -505,7 +505,7 @@ function EditPoll()
 		);
 
 		if ($context['can_moderate_poll'])
-			$context['poll']['expiration'] = $_POST['poll_expire'];
+			$context['poll']['expiration'] = (int) $_POST['poll_expire'];
 
 		// Check the question/option count for errors.
 		if (trim($_POST['question']) == '' && empty($context['poll_error']))
@@ -1013,4 +1013,4 @@ function RemovePoll()
 	redirectexit('topic=' . $topic . '.' . $_REQUEST['start']);
 }
 
-?>
\ No newline at end of file
+?>
diff --git a/Sources/Post.php b/Sources/Post.php
index c113a42..26e125b 100644
--- a/Sources/Post.php
+++ b/Sources/Post.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -244,10 +244,10 @@ function Post()
 		// Set up the poll options.
 		$context['poll_options'] = array(
 			'max_votes' => empty($_POST['poll_max_votes']) ? '1' : max(1, $_POST['poll_max_votes']),
-			'hide' => empty($_POST['poll_hide']) ? 0 : $_POST['poll_hide'],
-			'vvis' => empty($_POST['poll_vvis']) ? 0 : $_POST['poll_vvis'],
-			'vcmt' => empty($_POST['poll_vcmt']) ? 0 : $_POST['poll_vcmt'],
-			'expire' => !isset($_POST['poll_expire']) ? '' : $_POST['poll_expire'],
+			'hide' => empty($_POST['poll_hide']) ? 0 : (int) $_POST['poll_hide'],
+			'vvis' => empty($_POST['poll_vvis']) ? 0 : (int) $_POST['poll_vvis'],
+			'vcmt' => empty($_POST['poll_vcmt']) ? 0 : (int) $_POST['poll_vcmt'],
+			'expire' => !isset($_POST['poll_expire']) ? '' : (int) $_POST['poll_expire'],
 			'change_vote' => isset($_POST['poll_change_vote']),
 			'guest_vote' => isset($_POST['poll_guest_vote']),
 			'guest_vote_enabled' => in_array(-1, $allowedVoteGroups['allowed']),
@@ -453,7 +453,7 @@ function Post()
 				{
 					if (!isset($_REQUEST['email']) || $_REQUEST['email'] == '')
 						$context['post_error']['no_email'] = true;
-					elseif (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $_REQUEST['email']) == 0)
+					elseif (filter_var($_REQUEST['email'], FILTER_VALIDATE_EMAIL) === false)
 						$context['post_error']['bad_email'] = true;
 				}
 			}
@@ -1498,7 +1498,7 @@ function Post2()
 			{
 				if (!allowedTo('moderate_forum') && (!isset($_POST['email']) || $_POST['email'] == ''))
 					$post_errors[] = 'no_email';
-				if (!allowedTo('moderate_forum') && preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $_POST['email']) == 0)
+				if (!allowedTo('moderate_forum') && filter_var($_POST['email'], FILTER_VALIDATE_EMAIL) === false)
 					$post_errors[] = 'bad_email';
 			}
 
@@ -2304,8 +2304,13 @@ function AnnouncementSend()
 				'TOPICSUBJECT' => $context['topic_subject'],
 				'MESSAGE' => $message,
 				'TOPICLINK' => $scripturl . '?topic=' . $topic . '.0',
+				'UNSUBSCRIBELINK' => $scripturl . '?action=notifyannouncements',
 			);
 
+			// Tokens allow people to unsubscribe without logging in
+			if (!empty($modSettings['notify_tokens']))
+				$replacements['UNSUBSCRIBELINK'] .= ';u={UNSUBSCRIBE_ID};token={UNSUBSCRIBE_TOKEN}';
+
 			$emaildata = loadEmailTemplate('new_announcement', $replacements, $cur_language);
 
 			$announcements[$cur_language] = array(
@@ -2322,7 +2327,22 @@ function AnnouncementSend()
 
 	// For each language send a different mail - low priority...
 	foreach ($announcements as $lang => $mail)
-		sendmail($mail['recipients'], $mail['subject'], $mail['body'], null, null, false, 5);
+	{
+		if (!empty($modSettings['notify_tokens']))
+		{
+			foreach ($mail['recipients'] as $member_id => $member_email)
+			{
+				require_once($sourcedir . '/Notify.php');
+				$token = createUnsubscribeToken($member_id, $member_email, 'announcements');
+
+				$body = str_replace(array('{UNSUBSCRIBE_ID}', '{UNSUBSCRIBE_TOKEN}'), array($member_id, $token), $mail['body']);
+
+				sendmail($member_email, $mail['subject'], $body, null, null, false, 5);
+			}
+		}
+		else
+			sendmail($mail['recipients'], $mail['subject'], $mail['body'], null, null, false, 5);
+	}
 
 	$context['percentage_done'] = round(100 * $context['start'] / $modSettings['latestMember'], 1);
 
@@ -2450,6 +2470,15 @@ function notifyMembersBoard(&$topicData)
 			if (!$send_body)
 				unset($replacements['MESSAGE']);
 
+			// Make a token for the unsubscribe link
+			if (!empty($modSettings['notify_tokens']))
+			{
+				require_once($sourcedir . '/Notify.php');
+				$token = createUnsubscribeToken($rowmember['id_member'], $rowmember['email_address'], 'board', $rowmember['id_board']);
+
+				$replacements['UNSUBSCRIBELINK'] .= ';u=' . $rowmember['id_member'] . ';token=' . $token;
+			}
+
 			// Figure out which email to send off
 			$emailtype = '';
 
@@ -2910,4 +2939,4 @@ function strip_html_bbc__preg_callback($matches)
 {
 	return '[html]' . preg_replace('~<br\s?/?' . '>~i', '&lt;br /&gt;<br />', $matches[1]) . '[/html]';
 }
-?>
\ No newline at end of file
+?>
diff --git a/Sources/Profile-Actions.php b/Sources/Profile-Actions.php
index 0366fd4..c7f9aa8 100644
--- a/Sources/Profile-Actions.php
+++ b/Sources/Profile-Actions.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.14
  */
 
 if (!defined('SMF'))
@@ -718,7 +718,7 @@ function subscriptions($memID)
 		$context['gateways'] = array();
 		foreach ($gateways as $id => $gateway)
 		{
-			$fields = $gateways[$id]->fetchGatewayFields($context['sub']['id'] . '+' . $memID, $context['sub'], $context['value'], $period, $scripturl . '?action=profile;u=' . $memID . ';area=subscriptions;sub_id=' . $context['sub']['id'] . ';done');
+			$fields = $gateways[$id]->fetchGatewayFields($context['sub']['id'] . '+' . $memID, $context['sub'], $context['value'], $period, $scripturl . '?action=profile&u=' . $memID . '&area=subscriptions&sub_id=' . $context['sub']['id'] . '&done');
 			if (!empty($fields['form']))
 				$context['gateways'][] = $fields;
 		}
diff --git a/Sources/Profile-Modify.php b/Sources/Profile-Modify.php
index 6d5252a..2b55cf5 100644
--- a/Sources/Profile-Modify.php
+++ b/Sources/Profile-Modify.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -125,7 +125,7 @@ if (!defined('SMF'))
 // This defines every profile field known to man.
 function loadProfileFields($force_reload = false)
 {
-	global $context, $profile_fields, $txt, $scripturl, $modSettings, $user_info, $old_profile, $smcFunc, $cur_profile, $language;
+	global $context, $profile_fields, $txt, $scripturl, $modSettings, $user_info, $old_profile, $smcFunc, $cur_profile, $language, $profile_vars;
 
 	// Don't load this twice!
 	if (!empty($profile_fields) && !$force_reload)
@@ -180,10 +180,11 @@ function loadProfileFields($force_reload = false)
 			'size' => 24,
 			'value' => strtr(empty($cur_profile['aim']) ? '' : $cur_profile['aim'], '+', ' '),
 			'permission' => 'profile_extra',
-			'input_validate' => create_function('&$value', '
-				$value = strtr($value, \' \', \'+\');
+			'input_validate' => function(&$value)
+			{
+				$value = strtr($value, ' ', '+');
 				return true;
-			'),
+			},
 		),
 		'avatar_choice' => array(
 			'type' => 'callback',
@@ -197,56 +198,56 @@ function loadProfileFields($force_reload = false)
 			'type' => 'callback',
 			'callback_func' => 'birthdate',
 			'permission' => 'profile_extra',
-			'preload' => create_function('', '
-				global $cur_profile, $context;
-
+			'preload' => function() use ($cur_profile, &$context)
+			{
 				// Split up the birthdate....
-				list ($uyear, $umonth, $uday) = explode(\'-\', empty($cur_profile[\'birthdate\']) || $cur_profile[\'birthdate\'] == \'0001-01-01\' ? \'0000-00-00\' : $cur_profile[\'birthdate\']);
-				$context[\'member\'][\'birth_date\'] = array(
-					\'year\' => $uyear == \'0004\' ? \'0000\' : $uyear,
-					\'month\' => $umonth,
-					\'day\' => $uday,
+				list ($uyear, $umonth, $uday) = explode('-', empty($cur_profile['birthdate']) || $cur_profile['birthdate'] === '0001-01-01' ? '0000-00-00' : $cur_profile['birthdate']);
+				$context['member']['birth_date'] = array(
+					'year' => $uyear == '0004' ? '0000' : $uyear,
+					'month' => $umonth,
+					'day' => $uday,
 				);
 
 				return true;
-			'),
-			'input_validate' => create_function('&$value', '
-				global $profile_vars, $cur_profile;
+			},
+			'input_validate' => function(&$value)
+			{
+			    global $cur_profile, $profile_vars;
 
-				if (isset($_POST[\'bday2\'], $_POST[\'bday3\']) && $value > 0 && $_POST[\'bday2\'] > 0)
+				if (isset($_POST['bday2'], $_POST['bday3']) && $value > 0 && $_POST['bday2'] > 0)
 				{
 					// Set to blank?
-					if ((int) $_POST[\'bday3\'] == 1 && (int) $_POST[\'bday2\'] == 1 && (int) $value == 1)
-						$value = \'0001-01-01\';
+					if ((int) $_POST['bday3'] == 1 && (int) $_POST['bday2'] == 1 && (int) $value == 1)
+						$value = '0001-01-01';
 					else
-						$value = checkdate($value, $_POST[\'bday2\'], $_POST[\'bday3\'] < 4 ? 4 : $_POST[\'bday3\']) ? sprintf(\'%04d-%02d-%02d\', $_POST[\'bday3\'] < 4 ? 4 : $_POST[\'bday3\'], $_POST[\'bday1\'], $_POST[\'bday2\']) : \'0001-01-01\';
+						$value = checkdate($value, $_POST['bday2'], $_POST['bday3'] < 4 ? 4 : $_POST['bday3']) ? sprintf('%04d-%02d-%02d', $_POST['bday3'] < 4 ? 4 : $_POST['bday3'], $_POST['bday1'], $_POST['bday2']) : '0001-01-01';
 				}
 				else
-					$value = \'0001-01-01\';
+					$value = '0001-01-01';
 
-				$profile_vars[\'birthdate\'] = $value;
-				$cur_profile[\'birthdate\'] = $value;
+				$profile_vars['birthdate'] = $value;
+				$cur_profile['birthdate'] = $value;
 				return false;
-			'),
+			},
 		),
 		// Setting the birthdate the old style way?
 		'birthdate' => array(
 			'type' => 'hidden',
 			'permission' => 'profile_extra',
-			'input_validate' => create_function('&$value', '
-				global $cur_profile;
-				// !!! Should we check for this year and tell them they made a mistake :P? (based on coppa at least?)
-				if (preg_match(\'/(\d{4})[\-\., ](\d{2})[\-\., ](\d{2})/\', $value, $dates) === 1)
+			'input_validate' => function(&$value) use ($cur_profile)
+			{
+				// @todo Should we check for this year and tell them they made a mistake :P? (based on coppa at least?)
+				if (preg_match('/(\d{4})[\-\., ](\d{2})[\-\., ](\d{2})/', $value, $dates) === 1)
 				{
-					$value = checkdate($dates[2], $dates[3], $dates[1] < 4 ? 4 : $dates[1]) ? sprintf(\'%04d-%02d-%02d\', $dates[1] < 4 ? 4 : $dates[1], $dates[2], $dates[3]) : \'0001-01-01\';
+					$value = checkdate($dates[2], $dates[3], $dates[1] < 4 ? 4 : $dates[1]) ? sprintf('%04d-%02d-%02d', $dates[1] < 4 ? 4 : $dates[1], $dates[2], $dates[3]) : '0001-01-01';
 					return true;
 				}
 				else
 				{
-					$value = empty($cur_profile[\'birthdate\']) ? \'0001-01-01\' : $cur_profile[\'birthdate\'];
+					$value = empty($cur_profile['birthdate']) ? '0001-01-01' : $cur_profile['birthdate'];
 					return false;
 				}
-			'),
+			},
 		),
 		'date_registered' => array(
 			'type' => 'text',
@@ -254,23 +255,24 @@ function loadProfileFields($force_reload = false)
 			'label' => $txt['date_registered'],
 			'log_change' => true,
 			'permission' => 'moderate_forum',
-			'input_validate' => create_function('&$value', '
-				global $txt, $user_info, $modSettings, $cur_profile, $context;
-
+			'input_validate' => function(&$value) use ($txt, $user_info, $modSettings, $cur_profile, $context)
+			{
 				// Bad date!  Go try again - please?
-				if (($value = strtotime($value)) === -1)
+				if (($value = strtotime($value)) === false)
 				{
-					$value = $cur_profile[\'date_registered\'];
-					return $txt[\'invalid_registration\'] . \' \' . strftime(\'%d %b %Y \' . (strpos($user_info[\'time_format\'], \'%H\') !== false ? \'%I:%M:%S %p\' : \'%H:%M:%S\'), forum_time(false));
+					$value = $cur_profile['date_registered'];
+					return $txt['invalid_registration'] . ' ' . strftime('%d %b %Y ' . (strpos($user_info['time_format'], '%H') !== false ? '%I:%M:%S %p' : '%H:%M:%S'), forum_time(false));
 				}
-				// As long as it doesn\'t equal "N/A"...
-				elseif ($value != $txt[\'not_applicable\'] && $value != strtotime(strftime(\'%Y-%m-%d\', $cur_profile[\'date_registered\'] + ($user_info[\'time_offset\'] + $modSettings[\'time_offset\']) * 3600)))
-					$value = $value - ($user_info[\'time_offset\'] + $modSettings[\'time_offset\']) * 3600;
+
+				// As long as it doesn't equal "N/A"...
+				elseif ($value != $txt['not_applicable'] && $value != strtotime(strftime('%Y-%m-%d', $cur_profile['date_registered'] + ($user_info['time_offset'] + $modSettings['time_offset']) * 3600)))
+					$value = $value - ($user_info['time_offset'] + $modSettings['time_offset']) * 3600;
+
 				else
-					$value = $cur_profile[\'date_registered\'];
+					$value = $cur_profile['date_registered'];
 
 				return true;
-			'),
+			},
 		),
 		'email_address' => array(
 			'type' => 'text',
@@ -278,26 +280,27 @@ function loadProfileFields($force_reload = false)
 			'subtext' => $txt['valid_email'],
 			'log_change' => true,
 			'permission' => 'profile_identity',
-			'input_validate' => create_function('&$value', '
-				global $context, $old_profile, $context, $profile_vars, $sourcedir, $modSettings;
+			'input_validate' => function(&$value)
+			{
+				global $context, $old_profile, $profile_vars, $sourcedir, $modSettings;
 
-				if (strtolower($value) == strtolower($old_profile[\'email_address\']))
+				if (strtolower($value) == strtolower($old_profile['email_address']))
 					return false;
 
-				$isValid = profileValidateEmail($value, $context[\'id_member\']);
+				$isValid = profileValidateEmail($value, $context['id_member']);
 
 				// Do they need to revalidate? If so schedule the function!
-				if ($isValid === true && !empty($modSettings[\'send_validation_onChange\']) && !allowedTo(\'moderate_forum\'))
+				if ($isValid === true && !empty($modSettings['send_validation_onChange']) && !allowedTo('moderate_forum'))
 				{
-					require_once($sourcedir . \'/Subs-Members.php\');
-					$profile_vars[\'validation_code\'] = generateValidationCode();
-					$profile_vars[\'is_activated\'] = 2;
-					$context[\'profile_execute_on_save\'][] = \'profileSendActivation\';
-					unset($context[\'profile_execute_on_save\'][\'reload_user\']);
+					require_once($sourcedir . '/Subs-Members.php');
+					$profile_vars['validation_code'] = generateValidationCode();
+					$profile_vars['is_activated'] = 2;
+					$context['profile_execute_on_save'][] = 'profileSendActivation';
+					unset($context['profile_execute_on_save']['reload_user']);
 				}
 
 				return $isValid;
-			'),
+			},
 		),
 		'gender' => array(
 			'type' => 'select',
@@ -311,11 +314,12 @@ function loadProfileFields($force_reload = false)
 			'value' => empty($cur_profile['hide_email']) ? true : false,
 			'label' => $txt['allow_user_email'],
 			'permission' => 'profile_identity',
-			'input_validate' => create_function('&$value', '
+			'input_validate' => function(&$value)
+			{
 				$value = $value == 0 ? 1 : 0;
 
 				return true;
-			'),
+			},
 		),
 		'icq' => array(
 			'type' => 'text',
@@ -324,13 +328,14 @@ function loadProfileFields($force_reload = false)
 			'size' => 24,
 			'permission' => 'profile_extra',
 			// Need to make sure ICQ doesn't equal 0.
-			'input_validate' => create_function('&$value', '
+			'input_validate' => function(&$value)
+			{
 				if (empty($value))
-					$value = \'\';
+					$value = '';
 				else
 					$value = (int) $value;
 				return true;
-			'),
+			},
 		),
 		// Selecting group membership is a complicated one so we treat it separate!
 		'id_group' => array(
@@ -346,57 +351,59 @@ function loadProfileFields($force_reload = false)
 			'callback_func' => 'theme_pick',
 			'permission' => 'profile_extra',
 			'enabled' => $modSettings['theme_allow'] || allowedTo('admin_forum'),
-			'preload' => create_function('', '
-				global $smcFunc, $context, $cur_profile, $txt;
-
-				$request = $smcFunc[\'db_query\'](\'\', \'
+			'preload' => function() use ($smcFunc, &$context, $cur_profile, $txt)
+			{
+				$request = $smcFunc['db_query']('', '
 					SELECT value
 					FROM {db_prefix}themes
 					WHERE id_theme = {int:id_theme}
 						AND variable = {string:variable}
-					LIMIT 1\', array(
-						\'id_theme\' => $cur_profile[\'id_theme\'],
-						\'variable\' => \'name\',
+					LIMIT 1', array(
+						'id_theme' => $cur_profile['id_theme'],
+						'variable' => 'name',
 					)
 				);
-				list ($name) = $smcFunc[\'db_fetch_row\']($request);
-				$smcFunc[\'db_free_result\']($request);
+				list ($name) = $smcFunc['db_fetch_row']($request);
+				$smcFunc['db_free_result']($request);
 
-				$context[\'member\'][\'theme\'] = array(
-					\'id\' => $cur_profile[\'id_theme\'],
-					\'name\' => empty($cur_profile[\'id_theme\']) ? $txt[\'theme_forum_default\'] : $name
+				$context['member']['theme'] = array(
+					'id' => $cur_profile['id_theme'],
+					'name' => empty($cur_profile['id_theme']) ? $txt['theme_forum_default'] : $name
 				);
 				return true;
-			'),
-			'input_validate' => create_function('&$value', '
+			},
+			'input_validate' => function(&$value)
+			{
 				$value = (int) $value;
 				return true;
-			'),
+			},
 		),
 		'karma_good' => array(
 			'type' => 'callback',
 			'callback_func' => 'karma_modify',
 			'permission' => 'admin_forum',
 			// Set karma_bad too!
-			'input_validate' => create_function('&$value', '
+			'input_validate' => function(&$value)
+			{
 				global $profile_vars, $cur_profile;
 
 				$value = (int) $value;
-				if (isset($_POST[\'karma_bad\']))
+				if (isset($_POST['karma_bad']))
 				{
-					$profile_vars[\'karma_bad\'] = $_POST[\'karma_bad\'] != \'\' ? (int) $_POST[\'karma_bad\'] : 0;
-					$cur_profile[\'karma_bad\'] = $_POST[\'karma_bad\'] != \'\' ? (int) $_POST[\'karma_bad\'] : 0;
+					$profile_vars['karma_bad'] = $_POST['karma_bad'] != '' ? (int) $_POST['karma_bad'] : 0;
+					$cur_profile['karma_bad'] = $_POST['karma_bad'] != '' ? (int) $_POST['karma_bad'] : 0;
 				}
 				return true;
-			'),
-			'preload' => create_function('', '
+			},
+			'preload' => function()
+			{
 				global $context, $cur_profile;
 
-				$context[\'member\'][\'karma\'][\'good\'] = $cur_profile[\'karma_good\'];
-				$context[\'member\'][\'karma\'][\'bad\'] = $cur_profile[\'karma_bad\'];
+				$context['member']['karma']['good'] = $cur_profile['karma_good'];
+				$context['member']['karma']['bad'] = $cur_profile['karma_bad'];
 
 				return true;
-			'),
+			},
 			'enabled' => !empty($modSettings['karmaMode']),
 		),
 		'lngfile' => array(
@@ -407,24 +414,23 @@ function loadProfileFields($force_reload = false)
 			'preload' => 'profileLoadLanguages',
 			'enabled' => !empty($modSettings['userLanguage']),
 			'value' => empty($cur_profile['lngfile']) ? $language : $cur_profile['lngfile'],
-			'input_validate' => create_function('&$value', '
-				global $context, $cur_profile;
-
+			'input_validate' => function(&$value) use (&$context, $cur_profile)
+			{
 				// Load the languages.
 				profileLoadLanguages();
 
-				if (isset($context[\'profile_languages\'][$value]))
+				if (isset($context['profile_languages'][$value]))
 				{
-					if ($context[\'user\'][\'is_owner\'] && empty($context[\'password_auth_failed\']))
-						$_SESSION[\'language\'] = $value;
+					if ($context['user']['is_owner'] && empty($context['password_auth_failed']))
+						$_SESSION['language'] = $value;
 					return true;
 				}
 				else
 				{
-					$value = $cur_profile[\'lngfile\'];
+					$value = $cur_profile['lngfile'];
 					return false;
 				}
-			'),
+			},
 		),
 		'location' => array(
 			'type' => 'text',
@@ -441,30 +447,31 @@ function loadProfileFields($force_reload = false)
 			'log_change' => true,
 			'permission' => 'profile_identity',
 			'prehtml' => allowedTo('admin_forum') && isset($_GET['changeusername']) ? '<div class="alert">' . $txt['username_warning'] . '</div>' : '',
-			'input_validate' => create_function('&$value', '
+			'input_validate' => function(&$value)
+			{
 				global $sourcedir, $context, $user_info, $cur_profile;
 
-				if (allowedTo(\'admin_forum\'))
+				if (allowedTo('admin_forum'))
 				{
 					// We\'ll need this...
-					require_once($sourcedir . \'/Subs-Auth.php\');
+					require_once($sourcedir . '/Subs-Auth.php');
 
 					// Maybe they are trying to change their password as well?
 					$resetPassword = true;
-					if (isset($_POST[\'passwrd1\']) && $_POST[\'passwrd1\'] != \'\' && isset($_POST[\'passwrd2\']) && $_POST[\'passwrd1\'] == $_POST[\'passwrd2\'] && validatePassword($_POST[\'passwrd1\'], $value, array($cur_profile[\'real_name\'], $user_info[\'username\'], $user_info[\'name\'], $user_info[\'email\'])) == null)
+					if (isset($_POST['passwrd1']) && $_POST['passwrd1'] != '' && isset($_POST['passwrd2']) && $_POST['passwrd1'] == $_POST['passwrd2'] && validatePassword($_POST['passwrd1'], $value, array($cur_profile['real_name'], $user_info['username'], $user_info['name'], $user_info['email'])) == null)
 						$resetPassword = false;
 
 					// Do the reset... this will send them an email too.
 					if ($resetPassword)
-						resetPassword($context[\'id_member\'], $value);
+						resetPassword($context['id_member'], $value);
 					elseif ($value !== null)
 					{
-						validateUsername($context[\'id_member\'], trim(preg_replace(\'~[\t\n\r \x0B\0\' . ($context[\'utf8\'] ? ($context[\'server\'][\'complex_preg_chars\'] ? \'\x{A0}\x{AD}\x{2000}-\x{200F}\x{201F}\x{202F}\x{3000}\x{FEFF}\' : "\xC2\xA0\xC2\xAD\xE2\x80\x80-\xE2\x80\x8F\xE2\x80\x9F\xE2\x80\xAF\xE2\x80\x9F\xE3\x80\x80\xEF\xBB\xBF") : \'\x00-\x08\x0B\x0C\x0E-\x19\xA0\') . \']+~\' . ($context[\'utf8\'] ? \'u\' : \'\'), \' \', $value)));
-						updateMemberData($context[\'id_member\'], array(\'member_name\' => $value));
+						validateUsername($context['id_member'], trim(preg_replace('~[\t\n\r \x0B\0' . ($context['utf8'] ? ($context['server']['complex_preg_chars'] ? '\x{A0}\x{AD}\x{2000}-\x{200F}\x{201F}\x{202F}\x{3000}\x{FEFF}' : "\xC2\xA0\xC2\xAD\xE2\x80\x80-\xE2\x80\x8F\xE2\x80\x9F\xE2\x80\xAF\xE2\x80\x9F\xE3\x80\x80\xEF\xBB\xBF") : '\x00-\x08\x0B\x0C\x0E-\x19\xA0') . ']+~' . ($context['utf8'] ? 'u' : ''), ' ', $value)));
+						updateMemberData($context['id_member'], array('member_name' => $value));
 					}
 				}
 				return false;
-			'),
+			},
 		),
 		'msn' => array(
 			'type' => 'text',
@@ -472,16 +479,17 @@ function loadProfileFields($force_reload = false)
 			'subtext' => $txt['msn_email_address'],
 			'size' => 24,
 			'permission' => 'profile_extra',
-			'input_validate' => create_function('&$value', '
+			'input_validate' => function(&$value)
+			{
 				global $cur_profile;
 				// Make sure the msn one is an email address, not something like \'none\' :P.
-				if ($value != \'\' && preg_match(\'~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\\\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~\', $value) == 0)
+				if ($value != '' && preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\\\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $value) == 0)
 				{
-					$value = $cur_profile[\'msn\'];
+					$value = $cur_profile['msn'];
 					return false;
 				}
 				return true;
-			'),
+			},
 		),
 		'passwrd1' => array(
 			'type' => 'password',
@@ -493,29 +501,30 @@ function loadProfileFields($force_reload = false)
 			'permission' => 'profile_identity',
 			'save_key' => 'passwd',
 			// Note this will only work if passwrd2 also exists!
-			'input_validate' => create_function('&$value', '
+			'input_validate' => function(&$value)
+			{
 				global $sourcedir, $user_info, $smcFunc, $cur_profile;
 
 				// If we didn\'t try it then ignore it!
-				if ($value == \'\')
+				if ($value == '')
 					return false;
 
 				// Do the two entries for the password even match?
-				if (!isset($_POST[\'passwrd2\']) || $value != $_POST[\'passwrd2\'])
-					return \'bad_new_password\';
+				if (!isset($_POST['passwrd2']) || $value != $_POST['passwrd2'])
+					return 'bad_new_password';
 
 				// Let\'s get the validation function into play...
-				require_once($sourcedir . \'/Subs-Auth.php\');
-				$passwordErrors = validatePassword($value, $cur_profile[\'member_name\'], array($cur_profile[\'real_name\'], $user_info[\'username\'], $user_info[\'name\'], $user_info[\'email\']));
+				require_once($sourcedir . '/Subs-Auth.php');
+				$passwordErrors = validatePassword($value, $cur_profile['member_name'], array($cur_profile['real_name'], $user_info['username'], $user_info['name'], $user_info['email']));
 
 				// Were there errors?
 				if ($passwordErrors != null)
-					return \'password_\' . $passwordErrors;
+					return 'password_' . $passwordErrors;
 
 				// Set up the new password variable... ready for storage.
-				$value = sha1(strtolower($cur_profile[\'member_name\']) . un_htmlspecialchars($value));
+				$value = sha1(strtolower($cur_profile['member_name']) . un_htmlspecialchars($value));
 				return true;
-			'),
+			},
 		),
 		'passwrd2' => array(
 			'type' => 'password',
@@ -539,26 +548,28 @@ function loadProfileFields($force_reload = false)
 			'type' => 'callback',
 			'callback_func' => 'pm_settings',
 			'permission' => 'pm_read',
-			'preload' => create_function('', '
+			'preload' => function()
+			{
 				global $context, $cur_profile;
 
-				$context[\'display_mode\'] = $cur_profile[\'pm_prefs\'] & 3;
-				$context[\'send_email\'] = $cur_profile[\'pm_email_notify\'];
-				$context[\'receive_from\'] = !empty($cur_profile[\'pm_receive_from\']) ? $cur_profile[\'pm_receive_from\'] : 0;
+				$context['display_mode'] = $cur_profile['pm_prefs'] & 3;
+				$context['send_email'] = $cur_profile['pm_email_notify'];
+				$context['receive_from'] = !empty($cur_profile['pm_receive_from']) ? $cur_profile['pm_receive_from'] : 0;
 
 				return true;
-			'),
-			'input_validate' => create_function('&$value', '
+			},
+			'input_validate' => function(&$value)
+			{
 				global $cur_profile, $profile_vars;
 
 				// Simple validate and apply the two "sub settings"
 				$value = max(min($value, 2), 0);
 
-				$cur_profile[\'pm_email_notify\'] = $profile_vars[\'pm_email_notify\'] = max(min((int) $_POST[\'pm_email_notify\'], 2), 0);
-				$cur_profile[\'pm_receive_from\'] = $profile_vars[\'pm_receive_from\'] = max(min((int) $_POST[\'pm_receive_from\'], 4), 0);
+				$cur_profile['pm_email_notify'] = $profile_vars['pm_email_notify'] = max(min((int) $_POST['pm_email_notify'], 2), 0);
+				$cur_profile['pm_receive_from'] = $profile_vars['pm_receive_from'] = max(min((int) $_POST['pm_receive_from'], 4), 0);
 
 				return true;
-			'),
+			},
 		),
 		'posts' => array(
 			'type' => 'int',
@@ -566,10 +577,11 @@ function loadProfileFields($force_reload = false)
 			'log_change' => true,
 			'size' => 7,
 			'permission' => 'moderate_forum',
-			'input_validate' => create_function('&$value', '
-				$value = $value != \'\' ? strtr($value, array(\',\' => \'\', \'.\' => \'\', \' \' => \'\')) : 0;
+			'input_validate' => function(&$value)
+			{
+				$value = $value != '' ? strtr($value, array(',' => '', '.' => '', ' ' => '')) : 0;
 				return true;
-			'),
+			},
 		),
 		'real_name' => array(
 			'type' => !empty($modSettings['allow_editDisplayName']) || allowedTo('moderate_forum') ? 'text' : 'label',
@@ -579,23 +591,24 @@ function loadProfileFields($force_reload = false)
 			'input_attr' => array('maxlength="60"'),
 			'permission' => 'profile_identity',
 			'enabled' => !empty($modSettings['allow_editDisplayName']) || allowedTo('moderate_forum'),
-			'input_validate' => create_function('&$value', '
+			'input_validate' => function(&$value)
+			{
 				global $context, $smcFunc, $sourcedir, $cur_profile;
 
-				$value = trim(preg_replace(\'~[\t\n\r \x0B\0\' . ($context[\'utf8\'] ? ($context[\'server\'][\'complex_preg_chars\'] ? \'\x{A0}\x{AD}\x{2000}-\x{200F}\x{201F}\x{202F}\x{3000}\x{FEFF}\' : "\xC2\xA0\xC2\xAD\xE2\x80\x80-\xE2\x80\x8F\xE2\x80\x9F\xE2\x80\xAF\xE2\x80\x9F\xE3\x80\x80\xEF\xBB\xBF") : \'\x00-\x08\x0B\x0C\x0E-\x19\xA0\') . \']+~\' . ($context[\'utf8\'] ? \'u\' : \'\'), \' \', $value));
+				$value = trim(preg_replace('~[\t\n\r \x0B\0' . ($context['utf8'] ? ($context['server']['complex_preg_chars'] ? '\x{A0}\x{AD}\x{2000}-\x{200F}\x{201F}\x{202F}\x{3000}\x{FEFF}' : "\xC2\xA0\xC2\xAD\xE2\x80\x80-\xE2\x80\x8F\xE2\x80\x9F\xE2\x80\xAF\xE2\x80\x9F\xE3\x80\x80\xEF\xBB\xBF") : '\x00-\x08\x0B\x0C\x0E-\x19\xA0') . ']+~' . ($context['utf8'] ? 'u' : ''), ' ', $value));
 
-				if (trim($value) == \'\')
-					return \'no_name\';
-				elseif ($smcFunc[\'strlen\']($value) > 60)
-					return \'name_too_long\';
-				elseif ($cur_profile[\'real_name\'] != $value)
+				if (trim($value) == '')
+					return 'no_name';
+				elseif ($smcFunc['strlen']($value) > 60)
+					return 'name_too_long';
+				elseif ($cur_profile['real_name'] != $value)
 				{
-					require_once($sourcedir . \'/Subs-Members.php\');
-					if (isReservedName($value, $context[\'id_member\']))
-						return \'name_taken\';
+					require_once($sourcedir . '/Subs-Members.php');
+					if (isReservedName($value, $context['id_member']))
+						return 'name_taken';
 				}
 				return true;
-			'),
+			},
 		),
 		'secret_question' => array(
 			'type' => 'text',
@@ -612,10 +625,11 @@ function loadProfileFields($force_reload = false)
 			'postinput' => '<span class="smalltext" style="margin-left: 4ex;"><a href="' . $scripturl . '?action=helpadmin;help=secret_why_blank" onclick="return reqWin(this.href);">' . $txt['secret_why_blank'] . '</a></span>',
 			'value' => '',
 			'permission' => 'profile_identity',
-			'input_validate' => create_function('&$value', '
-				$value = $value != \'\' ? md5($value) : \'\';
+			'input_validate' => function(&$value)
+			{
+				$value = $value != '' ? md5($value) : '';
 				return true;
-			'),
+			},
 		),
 		'signature' => array(
 			'type' => 'callback',
@@ -636,33 +650,35 @@ function loadProfileFields($force_reload = false)
 			'callback_func' => 'smiley_pick',
 			'enabled' => !empty($modSettings['smiley_sets_enable']),
 			'permission' => 'profile_extra',
-			'preload' => create_function('', '
+			'preload' => function()
+			{
 				global $modSettings, $context, $txt, $cur_profile;
 
-				$context[\'member\'][\'smiley_set\'][\'id\'] = empty($cur_profile[\'smiley_set\']) ? \'\' : $cur_profile[\'smiley_set\'];
-				$context[\'smiley_sets\'] = explode(\',\', \'none,,\' . $modSettings[\'smiley_sets_known\']);
-				$set_names = explode("\n", $txt[\'smileys_none\'] . "\n" . $txt[\'smileys_forum_board_default\'] . "\n" . $modSettings[\'smiley_sets_names\']);
-				foreach ($context[\'smiley_sets\'] as $i => $set)
+				$context['member']['smiley_set']['id'] = empty($cur_profile['smiley_set']) ? '' : $cur_profile['smiley_set'];
+				$context['smiley_sets'] = explode(',', 'none,,' . $modSettings['smiley_sets_known']);
+				$set_names = explode("\n", $txt['smileys_none'] . "\n" . $txt['smileys_forum_board_default'] . "\n" . $modSettings['smiley_sets_names']);
+				foreach ($context['smiley_sets'] as $i => $set)
 				{
-					$context[\'smiley_sets\'][$i] = array(
-						\'id\' => htmlspecialchars($set),
-						\'name\' => htmlspecialchars($set_names[$i]),
-						\'selected\' => $set == $context[\'member\'][\'smiley_set\'][\'id\']
+					$context['smiley_sets'][$i] = array(
+						'id' => htmlspecialchars($set),
+						'name' => htmlspecialchars($set_names[$i]),
+						'selected' => $set == $context['member']['smiley_set']['id']
 					);
 
-					if ($context[\'smiley_sets\'][$i][\'selected\'])
-						$context[\'member\'][\'smiley_set\'][\'name\'] = $set_names[$i];
+					if ($context['smiley_sets'][$i]['selected'])
+						$context['member']['smiley_set']['name'] = $set_names[$i];
 				}
 				return true;
-			'),
-			'input_validate' => create_function('&$value', '
+			},
+			'input_validate' => function(&$value)
+			{
 				global $modSettings;
 
-				$smiley_sets = explode(\',\', $modSettings[\'smiley_sets_known\']);
-				if (!in_array($value, $smiley_sets) && $value != \'none\')
-					$value = \'\';
+				$smiley_sets = explode(',', $modSettings['smiley_sets_known']);
+				if (!in_array($value, $smiley_sets) && $value != 'none')
+					$value = '';
 				return true;
-			'),
+			},
 		),
 		// Pretty much a dummy entry - it populates all the theme settings.
 		'theme_settings' => array(
@@ -670,52 +686,54 @@ function loadProfileFields($force_reload = false)
 			'callback_func' => 'theme_settings',
 			'permission' => 'profile_extra',
 			'is_dummy' => true,
-			'preload' => create_function('', '
-				loadLanguage(\'Settings\');
+			'preload' => function()
+			{
+				loadLanguage('Settings');
 				return true;
-			'),
+			},
 		),
 		'time_format' => array(
 			'type' => 'callback',
 			'callback_func' => 'timeformat_modify',
 			'permission' => 'profile_extra',
-			'preload' => create_function('', '
-				global $context, $user_info, $txt, $cur_profile, $modSettings;
-
-				$context[\'easy_timeformats\'] = array(
-					array(\'format\' => \'\', \'title\' => $txt[\'timeformat_default\']),
-					array(\'format\' => \'%B %d, %Y, %I:%M:%S %p\', \'title\' => $txt[\'timeformat_easy1\']),
-					array(\'format\' => \'%B %d, %Y, %H:%M:%S\', \'title\' => $txt[\'timeformat_easy2\']),
-					array(\'format\' => \'%Y-%m-%d, %H:%M:%S\', \'title\' => $txt[\'timeformat_easy3\']),
-					array(\'format\' => \'%d %B %Y, %H:%M:%S\', \'title\' => $txt[\'timeformat_easy4\']),
-					array(\'format\' => \'%d-%m-%Y, %H:%M:%S\', \'title\' => $txt[\'timeformat_easy5\'])
+			'preload' => function() use (&$context, $user_info, $txt, $cur_profile, $modSettings)
+			{
+				$context['easy_timeformats'] = array(
+					array('format' => '', 'title' => $txt['timeformat_default']),
+					array('format' => '%B %d, %Y, %I:%M:%S %p', 'title' => $txt['timeformat_easy1']),
+					array('format' => '%B %d, %Y, %H:%M:%S', 'title' => $txt['timeformat_easy2']),
+					array('format' => '%Y-%m-%d, %H:%M:%S', 'title' => $txt['timeformat_easy3']),
+					array('format' => '%d %B %Y, %H:%M:%S', 'title' => $txt['timeformat_easy4']),
+					array('format' => '%d-%m-%Y, %H:%M:%S', 'title' => $txt['timeformat_easy5'])
 				);
 
-				$context[\'member\'][\'time_format\'] = $cur_profile[\'time_format\'];
-				$context[\'current_forum_time\'] = timeformat(time() - $user_info[\'time_offset\'] * 3600, false);
-				$context[\'current_forum_time_js\'] = strftime(\'%Y,\' . ((int) strftime(\'%m\', time() + $modSettings[\'time_offset\'] * 3600) - 1) . \',%d,%H,%M,%S\', time() + $modSettings[\'time_offset\'] * 3600);
-				$context[\'current_forum_time_hour\'] = (int) strftime(\'%H\', forum_time(false));
+				$context['member']['time_format'] = $cur_profile['time_format'];
+				$context['current_forum_time'] = timeformat(time() - $user_info['time_offset'] * 3600, false);
+				$context['current_forum_time_js'] = strftime('%Y,' . ((int) strftime('%m', time() + $modSettings['time_offset'] * 3600) - 1) . ',%d,%H,%M,%S', time() + $modSettings['time_offset'] * 3600);
+				$context['current_forum_time_hour'] = (int) strftime('%H', forum_time(false));
 				return true;
-			'),
+			},
 		),
 		'time_offset' => array(
 			'type' => 'callback',
 			'callback_func' => 'timeoffset_modify',
 			'permission' => 'profile_extra',
-			'preload' => create_function('', '
+			'preload' => function()
+			{
 				global $context, $cur_profile;
-				$context[\'member\'][\'time_offset\'] = $cur_profile[\'time_offset\'];
+				$context['member']['time_offset'] = $cur_profile['time_offset'];
 				return true;
-			'),
-			'input_validate' => create_function('&$value', '
+			},
+			'input_validate' => function(&$value)
+			{
 				// Validate the time_offset...
-				$value = (float) strtr($value, \',\', \'.\');
+				$value = (float) strtr($value, ',', '.');
 
 				if ($value < -23.5 || $value > 23.5)
-					return \'bad_offset\';
+					return 'bad_offset';
 
 				return true;
-			'),
+			},
 		),
 		'usertitle' => array(
 			'type' => 'text',
@@ -740,14 +758,14 @@ function loadProfileFields($force_reload = false)
 			'size' => 50,
 			'permission' => 'profile_extra',
 			// Fix the URL...
-			'input_validate' => create_function('&$value', '
-
-				if (strlen(trim($value)) > 0 && strpos($value, \'://\') === false)
-					$value = \'http://\' . $value;
-				if (strlen($value) < 8 || (substr($value, 0, 7) !== \'http://\' && substr($value, 0, 8) !== \'https://\'))
-					$value = \'\';
+			'input_validate' => function(&$value)
+			{
+				if (strlen(trim($value)) > 0 && strpos($value, '://') === false)
+					$value = 'http://' . $value;
+				if (strlen($value) < 8 || (substr($value, 0, 7) !== 'http://' && substr($value, 0, 8) !== 'https://'))
+					$value = '';
 				return true;
-			'),
+			},
 			'link_with' => 'website',
 		),
 		'yim' => array(
@@ -1290,7 +1308,7 @@ function makeCustomFieldChanges($memID, $area, $sanitize = true)
 			if ($row['field_type'] == 'text' && !empty($row['mask']) && $row['mask'] != 'none')
 			{
 				//!!! We never error on this - just ignore it at the moment...
-				if ($row['mask'] == 'email' && (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $value) === 0 || strlen($value) > 255))
+				if ($row['mask'] == 'email' && (filter_var($value, FILTER_VALIDATE_EMAIL) === false || strlen($value) > 255))
 					$value = '';
 				elseif ($row['mask'] == 'number')
 				{
@@ -1855,16 +1873,15 @@ function notification($memID)
 					'class' => 'lefttext first_th',
 				),
 				'data' => array(
-					'function' => create_function('$board', '
-						global $settings, $txt;
-
-						$link = $board[\'link\'];
+					'function' => function($board) use ($settings, $txt)
+					{
+						$link = $board['link'];
 
-						if ($board[\'new\'])
-							$link .= \' <a href="\' . $board[\'href\'] . \'"><img src="\' . $settings[\'lang_images_url\'] . \'/new.gif" alt="\' . $txt[\'new\'] . \'" /></a>\';
+						if ($board['new'])
+							$link .= ' <a href="' . $board['href'] . '"><img src="' . $settings['lang_images_url'] . '/new.gif" alt="' . $txt['new'] . '" /></a>';
 
 						return $link;
-					'),
+					},
 				),
 				'sort' => array(
 					'default' => 'name',
@@ -1937,18 +1954,17 @@ function notification($memID)
 					'class' => 'lefttext first_th',
 				),
 				'data' => array(
-					'function' => create_function('$topic', '
-						global $settings, $txt;
-
-						$link = $topic[\'link\'];
+					'function' => function($topic) use ($settings, $txt)
+					{
+						$link = $topic['link'];
 
-						if ($topic[\'new\'])
-							$link .= \' <a href="\' . $topic[\'new_href\'] . \'"><img src="\' . $settings[\'lang_images_url\'] . \'/new.gif" alt="\' . $txt[\'new\'] . \'" /></a>\';
+						if ($topic['new'])
+							$link .= ' <a href="' . $topic['new_href'] . '"><img src="' . $settings['lang_images_url'] . '/new.gif" alt="' . $txt['new'] . '" /></a>';
 
-						$link .= \'<br /><span class="smalltext"><em>\' . $txt[\'in\'] . \' \' . $topic[\'board_link\'] . \'</em></span>\';
+						$link .= '<br /><span class="smalltext"><em>' . $txt['in'] . ' ' . $topic['board_link'] . '</em></span>';
 
 						return $link;
-					'),
+					},
 				),
 				'sort' => array(
 					'default' => 'ms.subject',
@@ -2385,7 +2401,7 @@ function profileLoadSignatureData()
 // Load avatar context data.
 function profileLoadAvatarData()
 {
-	global $context, $cur_profile, $modSettings, $scripturl;
+	global $context, $cur_profile, $modSettings, $scripturl, $boardurl, $image_proxy_enabled;
 
 	$context['avatar_url'] = $modSettings['avatar_url'];
 
@@ -2409,12 +2425,19 @@ function profileLoadAvatarData()
 		);
 		$context['member']['avatar']['href'] = empty($cur_profile['attachment_type']) ? $scripturl . '?action=dlattach;attach=' . $cur_profile['id_attach'] . ';type=avatar' : $modSettings['custom_avatar_url'] . '/' . $cur_profile['filename'];
 	}
-	elseif (stristr($cur_profile['avatar'], 'http://') && $context['member']['avatar']['allow_external'])
+	elseif ((stristr($cur_profile['avatar'], 'http://') || stristr($cur_profile['avatar'], 'https://')) && $context['member']['avatar']['allow_external'])
+	{
 		$context['member']['avatar'] += array(
 			'choice' => 'external',
 			'server_pic' => 'blank.gif',
-			'external' => $cur_profile['avatar']
+			'external' => $cur_profile['avatar'],
+			'external_original' => $cur_profile['avatar']
 		);
+
+		// If we have a proxied imaged, show the original url, not the proxy url.
+		if ($image_proxy_enabled && !empty($cur_profile['avatar_original']) && $cur_profile['avatar_original'] != $cur_profile['avatar'] && stristr($cur_profile['avatar'], $boardurl . '/proxy.php'))
+			$context['member']['avatar']['external_original'] = $cur_profile['avatar_original'];
+	}
 	elseif ($cur_profile['avatar'] != '' && file_exists($modSettings['avatar_directory'] . '/' . $cur_profile['avatar']) && $context['member']['avatar']['allow_server_stored'])
 		$context['member']['avatar'] += array(
 			'choice' => 'server_stored',
@@ -2428,6 +2451,10 @@ function profileLoadAvatarData()
 			'external' => 'http://'
 		);
 
+	// Ensure we have a original external.
+	if (!isset($context['member']['avatar']['external_original']))
+		$context['member']['avatar']['external_original'] = $context['member']['avatar']['external'];
+
 	// Get a list of all the avatars.
 	if ($context['member']['avatar']['allow_server_stored'])
 	{
@@ -2548,6 +2575,7 @@ function profileSaveAvatarData(&$value)
 		return false;
 
 	require_once($sourcedir . '/ManageAttachments.php');
+	require_once($sourcedir . '/Subs-Package.php');
 
 	// We need to know where we're going to be putting it..
 	if (!empty($modSettings['custom_avatar_enabled']))
@@ -2571,13 +2599,11 @@ function profileSaveAvatarData(&$value)
 	}
 
 	$downloadedExternalAvatar = false;
-	if ($value == 'external' && allowedTo('profile_remote_avatar') && strtolower(substr($_POST['userpicpersonal'], 0, 7)) == 'http://' && strlen($_POST['userpicpersonal']) > 7 && !empty($modSettings['avatar_download_external']))
+	if ($value == 'external' && allowedTo('profile_remote_avatar') && (strtolower(substr($_POST['userpicpersonal'], 0, 7)) == 'http://' || strtolower(substr($_POST['userpicpersonal'], 0, 8)) == 'https://') && strlen($_POST['userpicpersonal']) > 7 && !empty($modSettings['avatar_download_external']))
 	{
 		if (!is_writable($uploadDir))
 			fatal_lang_error('attachments_no_write', 'critical');
 
-		require_once($sourcedir . '/Subs-Package.php');
-
 		$url = parse_url($_POST['userpicpersonal']);
 		$contents = fetch_web_data('http://' . $url['host'] . (empty($url['port']) ? '' : ':' . $url['port']) . str_replace(' ', '%20', trim($url['path'])));
 
@@ -2616,7 +2642,7 @@ function profileSaveAvatarData(&$value)
 		// Get rid of their old avatar. (if uploaded.)
 		removeAttachments(array('id_member' => $memID));
 	}
-	elseif ($value == 'external' && allowedTo('profile_remote_avatar') && strtolower(substr($_POST['userpicpersonal'], 0, 7)) == 'http://' && empty($modSettings['avatar_download_external']))
+	elseif ($value == 'external' && allowedTo('profile_remote_avatar') && (strtolower(substr($_POST['userpicpersonal'], 0, 7)) == 'http://' || strtolower(substr($_POST['userpicpersonal'], 0, 8)) == 'https://') && empty($modSettings['avatar_download_external']))
 	{
 		// We need these clean...
 		$cur_profile['id_attach'] = 0;
@@ -2627,11 +2653,14 @@ function profileSaveAvatarData(&$value)
 		removeAttachments(array('id_member' => $memID));
 
 		$profile_vars['avatar'] = str_replace('%20', '', preg_replace('~action(?:=|%3d)(?!dlattach)~i', 'action-', $_POST['userpicpersonal']));
+		$mime_valid = check_mime_type($profile_vars['avatar'], 'image/', true);
 
 		if ($profile_vars['avatar'] == 'http://' || $profile_vars['avatar'] == 'http:///')
 			$profile_vars['avatar'] = '';
 		// Trying to make us do something we'll regret?
-		elseif (substr($profile_vars['avatar'], 0, 7) != 'http://')
+		elseif (substr($profile_vars['avatar'], 0, 7) != 'http://' && substr($profile_vars['avatar'], 0, 8) != 'https://')
+			return 'bad_avatar';
+		elseif (empty($mime_valid))
 			return 'bad_avatar';
 		// Should we check dimensions?
 		elseif (!empty($modSettings['avatar_max_height_external']) || !empty($modSettings['avatar_max_width_external']))
@@ -2677,7 +2706,8 @@ function profileSaveAvatarData(&$value)
 				$_FILES['attachment']['tmp_name'] = $new_filename;
 			}
 
-			$sizes = @getimagesize($_FILES['attachment']['tmp_name']);
+			$mime_valid = check_mime_type($_FILES['attachment']['tmp_name'], 'image/', true);
+			$sizes = empty($mime_valid) ? false : @getimagesize($_FILES['attachment']['tmp_name']);
 
 			// No size, then it's probably not a valid pic.
 			if ($sizes === false)
diff --git a/Sources/Profile-View.php b/Sources/Profile-View.php
index 81cbf85..35535d2 100644
--- a/Sources/Profile-View.php
+++ b/Sources/Profile-View.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -993,7 +993,7 @@ function trackActivity($memID)
 	createList($listOptions);
 
 	// If this is a big forum, or a large posting user, let's limit the search.
-	if ($modSettings['totalMessages'] > 50000 && $user_profile[$memID]['posts'] > 500)
+	if ($modSettings['totalMessages'] > 50000 || $user_profile[$memID]['posts'] > 500)
 	{
 		$request = $smcFunc['db_query']('', '
 			SELECT MAX(id_msg)
@@ -1007,7 +1007,7 @@ function trackActivity($memID)
 		$smcFunc['db_free_result']($request);
 
 		// There's no point worrying ourselves with messages made yonks ago, just get recent ones!
-		$min_msg_member = max(0, $max_msg_member - $user_profile[$memID]['posts'] * 3);
+		$min_msg_member = max(0, $max_msg_member - 50000);
 	}
 
 	// Default to at least the ones we know about.
@@ -1023,8 +1023,10 @@ function trackActivity($memID)
 		WHERE id_member = {int:current_member}
 		' . (isset($min_msg_member) ? '
 			AND id_msg >= {int:min_msg_member} AND id_msg <= {int:max_msg_member}' : '') . '
-		GROUP BY poster_ip',
+		GROUP BY poster_ip
+		LIMIT {int:limit}',
 		array(
+			'limit' => min($user_profile[$memID]['posts'], 500),
 			'current_member' => $memID,
 			'min_msg_member' => !empty($min_msg_member) ? $min_msg_member : 0,
 			'max_msg_member' => !empty($max_msg_member) ? $max_msg_member : 0,
@@ -1454,20 +1456,15 @@ function TrackIP($memID = 0)
 	if ($context['single_ip'])
 	{
 		$context['whois_servers'] = array(
-			'afrinic' => array(
-				'name' => $txt['whois_afrinic'],
-				'url' => 'http://www.afrinic.net/cgi-bin/whois?searchtext=' . $context['ip'],
-				'range' => array(41, 154, 196),
-			),
 			'apnic' => array(
 				'name' => $txt['whois_apnic'],
-				'url' => 'http://wq.apnic.net/apnic-bin/whois.pl?searchtext=' . $context['ip'],
+				'url' => 'https://wq.apnic.net/apnic-bin/whois.pl?searchtext=' . $context['ip'],
 				'range' => array(58, 59, 60, 61, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124,
 					125, 126, 133, 150, 153, 163, 171, 202, 203, 210, 211, 218, 219, 220, 221, 222),
 			),
 			'arin' => array(
 				'name' => $txt['whois_arin'],
-				'url' => 'http://whois.arin.net/rest/ip/' . $context['ip'],
+				'url' => 'https://whois.arin.net/rest/ip/' . $context['ip'],
 				'range' => array(7, 24, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 96, 97, 98, 99,
 					128, 129, 130, 131, 132, 134, 135, 136, 137, 138, 139, 140, 142, 143, 144, 146, 147, 148, 149,
 					152, 155, 156, 157, 158, 159, 160, 161, 162, 164, 165, 166, 167, 168, 169, 170, 172, 173, 174,
@@ -1475,7 +1472,7 @@ function TrackIP($memID = 0)
 			),
 			'lacnic' => array(
 				'name' => $txt['whois_lacnic'],
-				'url' => 'http://lacnic.net/cgi-bin/lacnic/whois?query=' . $context['ip'],
+				'url' => 'https://lacnic.net/cgi-bin/lacnic/whois?query=' . $context['ip'],
 				'range' => array(186, 187, 189, 190, 191, 200, 201),
 			),
 			'ripe' => array(
diff --git a/Sources/Profile.php b/Sources/Profile.php
index f70d191..4b5c416 100644
--- a/Sources/Profile.php
+++ b/Sources/Profile.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.6
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -304,6 +304,14 @@ function ModifyProfile($post_errors = array())
 						'any' => array('moderate_forum'),
 					),
 				),
+				'getprofiledata' => array(
+					'label' => $txt['export_profile_data'],
+					'custom_url' => $scripturl . '?action=.xml;type=smf;download;sa=profile',
+					'permission' => array(
+						'own' => array('profile_view_own'),
+						'any' => array('moderate_forum'),
+					),
+				),
 				'deleteaccount' => array(
 					'label' => $txt['deleteAccount'],
 					'file' => 'Profile-Actions.php',
@@ -568,6 +576,10 @@ function ModifyProfile($post_errors = array())
 		}
 		elseif (!empty($profile_vars))
 		{
+			// Changing the password? Allow only on the approved channel.
+			if ($current_area != 'account')
+				unset($profile_vars['passwd']);
+
 			// If we've changed the password, notify any integration that may be listening in.
 			if (isset($profile_vars['passwd']))
 				call_integration_hook('integrate_reset_pass', array($cur_profile['member_name'], $cur_profile['member_name'], $_POST['passwrd2']));
diff --git a/Sources/QueryString.php b/Sources/QueryString.php
index 77c6cdb..70d0363 100644
--- a/Sources/QueryString.php
+++ b/Sources/QueryString.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.9
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -125,12 +125,12 @@ function cleanRequest()
 		parse_str(preg_replace('/&(\w+)(?=&|$)/', '&$1=', strtr($_SERVER['QUERY_STRING'], array(';?' => '&', ';' => '&', '%00' => '', "\0" => ''))), $_GET);
 
 		// Magic quotes still applies with parse_str - so clean it up.
-		if (function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc() != 0 && empty($modSettings['integrate_magic_quotes']))
+		if (version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc() != 0 && empty($modSettings['integrate_magic_quotes']))
 			$_GET = $removeMagicQuoteFunction($_GET);
 	}
 	elseif (strpos(@ini_get('arg_separator.input'), ';') !== false)
 	{
-		if (function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc() != 0 && empty($modSettings['integrate_magic_quotes']))
+		if (version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc() != 0 && empty($modSettings['integrate_magic_quotes']))
 			$_GET = $removeMagicQuoteFunction($_GET);
 
 		// Search engines will send action=profile%3Bu=1, which confuses PHP.
@@ -179,7 +179,7 @@ function cleanRequest()
 	}
 
 	// If magic quotes is on we have some work...
-	if (function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc() != 0)
+	if (version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc() != 0)
 	{
 		$_ENV = $removeMagicQuoteFunction($_ENV);
 		$_POST = $removeMagicQuoteFunction($_POST);
@@ -483,6 +483,21 @@ function ob_sessrewrite($buffer)
 			$buffer = preg_replace_callback('~"' . preg_quote($scripturl, '/') . '\?((?:c|board|topic)=[^#"]+?)(#[^"]*?)?"~', 'pathinfo_insert__preg_callback', $buffer);
 	}
 
+	// Be nice and try to inject session tokens into login forms since many older themes don't.
+	if ($user_info['is_guest'])
+		$buffer = preg_replace_callback(
+			'~(<form[^<]+action=login2(.+))</form>~iUs' . (!empty($context['utf8']) ? 'u' : ''),
+			function ($m) use ($context)
+			{
+				$repl = '';
+				if (!empty($context['session_var']) && strpos($m[0], $context['session_var']) === false)
+					$repl .= '<input type="hidden" name="' . $context['session_var'] . '" value="' . $context['session_id'] . '"/>';
+
+				return $m[1] . $repl . '</form>';
+			},
+			$buffer
+		);
+
 	// Return the changed buffer.
 	return $buffer;
 }
diff --git a/Sources/Recent.php b/Sources/Recent.php
index d0fd560..8be2cc8 100644
--- a/Sources/Recent.php
+++ b/Sources/Recent.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -85,6 +85,8 @@ function RecentPosts()
 	loadTemplate('Recent');
 	$context['page_title'] = $txt['recent_posts'];
 
+	$_REQUEST['start'] = (int) $_REQUEST['start'];
+
 	if (isset($_REQUEST['start']) && $_REQUEST['start'] > 95)
 		$_REQUEST['start'] = 95;
 
diff --git a/Sources/Register.php b/Sources/Register.php
index 55ba457..cac5c33 100644
--- a/Sources/Register.php
+++ b/Sources/Register.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.7
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -65,13 +65,14 @@ function Register($reg_errors = array())
 	$context['require_agreement'] = !empty($modSettings['requireAgreement']);
 	$context['registration_passed_agreement'] = !empty($_SESSION['registration_agreed']);
 	$context['show_coppa'] = !empty($modSettings['coppaAge']);
+	$context['require_policy_agreement'] = !empty($modSettings['requirePolicyAgreement']);
 
 	// Under age restrictions?
 	if ($context['show_coppa'])
 	{
 		$context['skip_coppa'] = false;
-		$context['coppa_agree_above'] = sprintf($txt['agreement_agree_coppa_above'], $modSettings['coppaAge']);
-		$context['coppa_agree_below'] = sprintf($txt['agreement_agree_coppa_below'], $modSettings['coppaAge']);
+		$context['coppa_agree_above'] = sprintf($txt['agreement' . ($context['require_policy_agreement'] ? '_policy' : '') . '_agree_coppa_above'], $modSettings['coppaAge']);
+		$context['coppa_agree_below'] = sprintf($txt['agreement' . ($context['require_policy_agreement'] ? '_policy' : '') . '_agree_coppa_below'], $modSettings['coppaAge']);
 	}
 
 	// What step are we at?
@@ -141,6 +142,21 @@ function Register($reg_errors = array())
 		}
 	}
 
+	// If you have to agree to the privacy policy, it needs to be loaded from the database.
+	if ($context['require_policy_agreement'])
+	{
+		// Have we got a localized one?
+		if (!empty($modSettings['policy_' . $user_info['language']]))
+			$context['policy'] = parse_bbc($modSettings['policy_' . $user_info['language']]);
+		elseif (!empty($modSettings['policy_' . $language]))
+			$context['policy'] = parse_bbc($modSettings['policy_' . $language]);
+		else
+		{
+			loadLanguage('Errors');
+			$context['policy'] = $txt['error_no_privacy_policy'];
+		}
+	}
+
 	// Any custom fields we want filled in?
 	require_once($sourcedir . '/Profile.php');
 	loadCustomFields(0, 'register');
@@ -200,6 +216,9 @@ function Register($reg_errors = array())
 		);
 	}
 
+	$context['announcements_ask'] = !empty($modSettings['force_gdpr']) || !empty($modSettings['allow_disableAnnounce']);
+	$context['notify_announcements'] = isset($_POST['notify_announcements']) ? (bool) $_POST['notify_announcements'] : !empty($modSettings['announcements_default']);
+
 	// !!! Why isn't this a simple set operation?
 	// Were there any errors?
 	$context['registration_errors'] = array();
@@ -232,7 +251,7 @@ function Register2($verifiedOpenID = false)
 	if (!$verifiedOpenID)
 	{
 		// Well, if you don't agree, you can't register.
-		if (!empty($modSettings['requireAgreement']) && empty($_SESSION['registration_agreed']))
+		if ((!empty($modSettings['requireAgreement']) || !empty($modSettings['requirePolicyAgreement'])) && empty($_SESSION['registration_agreed']))
 			redirectexit();
 
 		// Make sure they came from *somewhere*, have a session.
@@ -373,7 +392,7 @@ function Register2($verifiedOpenID = false)
 	$possible_ints = array_diff($possible_ints, $exclude_fields);
 	$possible_floats = array_diff($possible_floats, $exclude_fields);
 	$possible_bools = array_diff($possible_bools, $exclude_fields);
-	
+
 	// Set the options needed for registration.
 	$regOptions = array(
 		'interface' => 'guest',
@@ -411,6 +430,9 @@ function Register2($verifiedOpenID = false)
 		$_POST['options'] = isset($_POST['options']) ? $_POST['options'] + $_POST['default_options'] : $_POST['default_options'];
 	$regOptions['theme_vars'] = isset($_POST['options']) && is_array($_POST['options']) ? $_POST['options'] : array();
 
+	// Note when they accepted the agreement and privacy policy
+	$regOptions['theme_vars']['agreement_accepted'] = $regOptions['theme_vars']['policy_accepted'] = time();
+
 	// Make sure they are clean, dammit!
 	$regOptions['theme_vars'] = htmlspecialchars__recursive($regOptions['theme_vars']);
 
@@ -452,7 +474,7 @@ function Register2($verifiedOpenID = false)
 			if ($row['field_type'] == 'text' && !empty($row['mask']) && $row['mask'] != 'none')
 			{
 				//!!! We never error on this - just ignore it at the moment...
-				if ($row['mask'] == 'email' && !empty($value) && (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $value) === 0 || strlen($value) > 255))
+				if ($row['mask'] == 'email' && !empty($value) && (filter_var($value, FILTER_VALIDATE_EMAIL) === false || strlen($value) > 255))
 					$custom_field_errors[] = array('custom_field_invalid_email', array($row['field_name']));
 				elseif ($row['mask'] == 'number' && preg_match('~[^\d]~', $value))
 					$custom_field_errors[] = array('custom_field_not_number', array($row['field_name']));
@@ -540,7 +562,7 @@ function Register2($verifiedOpenID = false)
 	}
 	else
 	{
-		call_integration_hook('integrate_activate', array($row['member_name']));
+		call_integration_hook('integrate_activate', array($regOptions['username']));
 
 		setLoginCookie(60 * $modSettings['cookieTime'], $memberID, sha1(sha1(strtolower($regOptions['username']) . $regOptions['password']) . $regOptions['register_vars']['password_salt']));
 
@@ -602,7 +624,7 @@ function Activate()
 			fatal_lang_error('no_access', false);
 
 		// !!! Separate the sprintf?
-		if (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $_POST['new_email']) == 0)
+		if (filter_var($_POST['new_email'], FILTER_VALIDATE_EMAIL) === false)
 			fatal_error(sprintf($txt['valid_email_needed'], htmlspecialchars($_POST['new_email'])), false);
 
 		// Make sure their email isn't banned.
@@ -820,7 +842,7 @@ function VerificationCode()
 		elseif (isset($_REQUEST['letter']))
 		{
 			$_REQUEST['letter'] = (int) $_REQUEST['letter'];
-			if ($_REQUEST['letter'] > 0 && $_REQUEST['letter'] <= strlen($code) && !showLetterImage(strtolower($code{$_REQUEST['letter'] - 1})))
+			if ($_REQUEST['letter'] > 0 && $_REQUEST['letter'] <= strlen($code) && !showLetterImage(strtolower($code[$_REQUEST['letter'] - 1])))
 			{
 				header('Content-Type: image/gif');
 				die("\x47\x49\x46\x38\x39\x61\x01\x00\x01\x00\x80\x00\x00\x00\x00\x00\x00\x00\x00\x21\xF9\x04\x01\x00\x00\x00\x00\x2C\x00\x00\x00\x00\x01\x00\x01\x00\x00\x02\x02\x44\x01\x00\x3B");
diff --git a/Sources/Reminder.php b/Sources/Reminder.php
index 02307d4..9790019 100644
--- a/Sources/Reminder.php
+++ b/Sources/Reminder.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.13
+ * @version 2.0.14
  */
 
 if (!defined('SMF'))
@@ -182,7 +182,7 @@ function RemindPick()
 // Set your new password
 function setPassword()
 {
-	global $txt, $context;
+	global $txt, $context, $smcFunc;
 
 	loadLanguage('Login');
 
@@ -194,7 +194,7 @@ function setPassword()
 	$context += array(
 		'page_title' => $txt['reminder_set_password'],
 		'sub_template' => 'set_password',
-		'code' => $_REQUEST['code'],
+		'code' => $smcFunc['htmlspecialchars']($_REQUEST['code']),
 		'memID' => (int) $_REQUEST['u']
 	);
 }
diff --git a/Sources/RemoveTopic.php b/Sources/RemoveTopic.php
index 9acf575..4dff952 100644
--- a/Sources/RemoveTopic.php
+++ b/Sources/RemoveTopic.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -1206,7 +1206,7 @@ function RestoreTopic()
 }
 
 // Take a load of messages from one place and stick them in a topic.
-function mergePosts($msgs = array(), $from_topic, $target_topic)
+function mergePosts($msgs, $from_topic, $target_topic)
 {
 	global $context, $smcFunc, $modSettings, $sourcedir;
 
diff --git a/Sources/RepairBoards.php b/Sources/RepairBoards.php
index 13acf2c..b2325a6 100644
--- a/Sources/RepairBoards.php
+++ b/Sources/RepairBoards.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -240,68 +240,73 @@ function loadForumTests()
 					LEFT JOIN {db_prefix}topics AS t ON (t.id_topic = m.id_topic)
 				WHERE t.id_topic IS NULL
 				GROUP BY m.id_topic, m.id_board',
-			'fix_processing' => create_function('$row', '
-				global $smcFunc, $salvageBoardID;
+			'fix_processing' => function($row) use ($smcFunc)
+			{
+				global $salvageBoardID;
 
-				// Only if we don\'t have a reasonable idea of where to put it.
-				if ($row[\'id_board\'] == 0)
+				// Only if we don't have a reasonable idea of where to put it.
+				if ($row['id_board'] == 0)
 				{
 					createSalvageArea();
-					$row[\'id_board\'] = (int) $salvageBoardID;
+					$row['id_board'] = (int) $salvageBoardID;
 				}
 
 				// Make sure that no topics claim the first/last message as theirs.
-				$smcFunc[\'db_query\'](\'\', \'
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}topics
 					SET id_first_msg = 0
-					WHERE id_first_msg = {int:id_first_msg}\',
+					WHERE id_first_msg = {int:id_first_msg}',
 					array(
-						\'id_first_msg\' => $row[\'myid_first_msg\'],
+						'id_first_msg' => $row['myid_first_msg'],
 					)
 				);
-				$smcFunc[\'db_query\'](\'\', \'
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}topics
 					SET id_last_msg = 0
-					WHERE id_last_msg = {int:id_last_msg}\',
+					WHERE id_last_msg = {int:id_last_msg}',
 					array(
-						\'id_last_msg\' => $row[\'myid_last_msg\'],
+						'id_last_msg' => $row['myid_last_msg'],
 					)
 				);
 
-				$memberStartedID = (int) getMsgMemberID($row[\'myid_first_msg\']);
-				$memberUpdatedID = (int) getMsgMemberID($row[\'myid_last_msg\']);
+				$memberStartedID = (int) getMsgMemberID($row['myid_first_msg']);
+				$memberUpdatedID = (int) getMsgMemberID($row['myid_last_msg']);
 
-				$smcFunc[\'db_insert\'](\'\',
-					\'{db_prefix}topics\',
+				$smcFunc['db_insert']('',
+					'{db_prefix}topics',
 					array(
-						\'id_board\' => \'int\',
-						\'id_member_started\' => \'int\',
-						\'id_member_updated\' => \'int\',
-						\'id_first_msg\' => \'int\',
-						\'id_last_msg\' => \'int\',
-						\'num_replies\' => \'int\'
+						'id_board' => 'int',
+						'id_member_started' => 'int',
+						'id_member_updated' => 'int',
+						'id_first_msg' => 'int',
+						'id_last_msg' => 'int',
+						'num_replies' => 'int'
 					),
 					array(
-						$row[\'id_board\'],
+						$row['id_board'],
 						$memberStartedID,
 						$memberUpdatedID,
-						$row[\'myid_first_msg\'],
-						$row[\'myid_last_msg\'],
-						$row[\'my_num_replies\']
+						$row['myid_first_msg'],
+						$row['myid_last_msg'],
+						$row['my_num_replies']
 					),
-					array(\'id_topic\')
+					array('id_topic'),
+					1
 				);
 
-				$newTopicID = $smcFunc[\'db_insert_id\']("{db_prefix}topics", \'id_topic\');
+				$newTopicID = $smcFunc['db_insert_id']('{db_prefix}topics', 'id_topic');
 
-				$smcFunc[\'db_query\'](\'\', "
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}messages
-					SET id_topic = $newTopicID, id_board = $row[id_board]
-					WHERE id_topic = $row[id_topic]",
+					SET id_topic = {int:newTopicID}, id_board = {int:board_id}
+					WHERE id_topic = {int:topic_id}',
 					array(
+						'board_id' => $row['id_board'],
+						'topic_id' => $row['id_topic'],
+						'newTopicID' => $newTopicID,
 					)
 				);
-				'),
+			},
 			'force_fix' => array('stats_topics'),
 			'messages' => array('repair_missing_topics', 'id_msg', 'id_topic'),
 		),
@@ -323,23 +328,23 @@ function loadForumTests()
 			// Remove all topics that have zero messages in the messages table.
 			'fix_collect' => array(
 				'index' => 'id_topic',
-				'process' => create_function('$topics', '
-					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+				'process' => function($topics) use ($smcFunc)
+				{
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}topics
-						WHERE id_topic IN ({array_int:topics})",
+						WHERE id_topic IN ({array_int:topics})',
 						array(
-							\'topics\' => $topics
+							'topics' => $topics,
 						)
 					);
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_topics
-						WHERE id_topic IN ({array_int:topics})",
+						WHERE id_topic IN ({array_int:topics})',
 						array(
-							\'topics\' => $topics
+							'topics' => $topics,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_messages', 'id_topic'),
 		),
@@ -356,89 +361,94 @@ function loadForumTests()
 					LEFT JOIN {db_prefix}topics AS t ON (t.id_poll = p.id_poll)
 				WHERE p.id_poll BETWEEN {STEP_LOW} AND {STEP_HIGH}
 					AND t.id_poll IS NULL',
-			'fix_processing' => create_function('$row', '
-				global $smcFunc, $salvageBoardID, $txt;
+			'fix_processing' => function($row) use ($smcFunc)
+			{
+				global $txt, $salvageBoardID;
 
-				// Only if we don\'t have a reasonable idea of where to put it.
-				if ($row[\'id_board\'] == 0)
+				// Only if we don't have a reasonable idea of where to put it.
+				if ($row['id_board'] == 0)
 				{
 					createSalvageArea();
-					$row[\'id_board\'] = (int) $salvageBoardID;
+					$row['id_board'] = (int) $salvageBoardID;
 				}
 
-				$row[\'poster_name\'] = !empty($row[\'poster_name\']) ? $row[\'poster_name\'] : $txt[\'guest\'];
+				$row['poster_name'] = !empty($row['poster_name']) ? $row['poster_name'] : $txt['guest'];
 
-				$smcFunc[\'db_insert\'](\'\',
-					\'{db_prefix}messages\',
+				$smcFunc['db_insert']('',
+					'{db_prefix}messages',
 					array(
-						\'id_board\' => \'int\',
-						\'id_topic\' => \'int\',
-						\'poster_time\' => \'int\',
-						\'id_member\' => \'int\',
-						\'subject\' => \'string-255\',
-						\'poster_name\' => \'string-255\',
-						\'poster_email\' => \'string-255\',
-						\'poster_ip\' => \'string-16\',
-						\'smileys_enabled\' => \'int\',
-						\'body\' => \'string-65534\',
-						\'icon\' => \'string-16\',
-						\'approved\' => \'int\',
+						'id_board' => 'int',
+						'id_topic' => 'int',
+						'poster_time' => 'int',
+						'id_member' => 'int',
+						'subject' => 'string-255',
+						'poster_name' => 'string-255',
+						'poster_email' => 'string-255',
+						'poster_ip' => 'string-16',
+						'smileys_enabled' => 'int',
+						'body' => 'string-65534',
+						'icon' => 'string-16',
+						'approved' => 'int',
 					),
 					array(
-						$row[\'id_board\'],
+						$row['id_board'],
 						0,
 						time(),
-						$row[\'id_member\'],
-						$txt[\'salvaged_poll_topic_name\'],
-						$row[\'poster_name\'],
-						\'\',
-						\'127.0.0.1\',
+						$row['id_member'],
+						$txt['salvaged_poll_topic_name'],
+						$row['poster_name'],
+						'',
+						'127.0.0.1',
 						1,
-						$txt[\'salvaged_poll_message_body\'],
-						\'xx\',
+						$txt['salvaged_poll_message_body'],
+						'xx',
 						1,
 					),
-					array(\'id_topic\')
+					array('id_msg'),
+					1
 				);
 
-				$newMessageID = $smcFunc[\'db_insert_id\']("{db_prefix}messages", \'id_msg\');
+				$newMessageID = $smcFunc['db_insert_id']('{db_prefix}messages', 'id_msg');
 
-				$smcFunc[\'db_insert\'](\'\',
-					\'{db_prefix}topics\',
+				$smcFunc['db_insert']('',
+					'{db_prefix}topics',
 					array(
-						\'id_board\' => \'int\',
-						\'id_poll\' => \'int\',
-						\'id_member_started\' => \'int\',
-						\'id_member_updated\' => \'int\',
-						\'id_first_msg\' => \'int\',
-						\'id_last_msg\' => \'int\',
-						\'num_replies\' => \'int\',
+						'id_board' => 'int',
+						'id_poll' => 'int',
+						'id_member_started' => 'int',
+						'id_member_updated' => 'int',
+						'id_first_msg' => 'int',
+						'id_last_msg' => 'int',
+						'num_replies' => 'int',
 					),
 					array(
-						$row[\'id_board\'],
-						$row[\'id_poll\'],
-						$row[\'id_member\'],
-						$row[\'id_member\'],
+						$row['id_board'],
+						$row['id_poll'],
+						$row['id_member'],
+						$row['id_member'],
 						$newMessageID,
 						$newMessageID,
 						0,
 					),
-					array(\'id_topic\')
+					array('id_topic'),
+					1
 				);
 
-				$newTopicID = $smcFunc[\'db_insert_id\']("{db_prefix}topics", \'id_topic\');
+				$newTopicID = $smcFunc['db_insert_id']('{db_prefix}topics', 'id_topic');
 
-				$smcFunc[\'db_query\'](\'\', "
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}messages
-					SET id_topic = $newTopicID, id_board = $row[id_board]
-					WHERE id_msg = $newMessageID",
+					SET id_topic = {int:newTopicID}, id_board = {int:id_board}
+					WHERE id_msg = {int:newMessageID}',
 					array(
+						'id_board' => $row['id_board'],
+						'newTopicID' => $newTopicID,
+						'newMessageID' => $newMessageID,
 					)
 				);
 
-				updateStats(\'subject\', $newTopicID, $txt[\'salvaged_poll_topic_name\']);
-
-				'),
+				updateStats('subject', $newTopicID, $txt['salvaged_poll_topic_name']);
+			},
 			'force_fix' => array('stats_topics'),
 			'messages' => array('repair_polls_missing_topics', 'id_poll', 'id_topic'),
 		),
@@ -466,45 +476,52 @@ function loadForumTests()
 				WHERE t.id_topic BETWEEN {STEP_LOW} AND {STEP_HIGH}
 				GROUP BY t.id_topic, t.id_first_msg, t.id_last_msg, t.approved, mf.approved
 				ORDER BY t.id_topic',
-			'fix_processing' => create_function('$row', '
-				global $smcFunc;
-				$row[\'firstmsg_approved\'] = (int) $row[\'firstmsg_approved\'];
-				$row[\'myid_first_msg\'] = (int) $row[\'myid_first_msg\'];
-				$row[\'myid_last_msg\'] = (int) $row[\'myid_last_msg\'];
+			'fix_processing' => function($row) use ($smcFunc)
+			{
+				$row['firstmsg_approved'] = (int) $row['firstmsg_approved'];
+				$row['myid_first_msg'] = (int) $row['myid_first_msg'];
+				$row['myid_last_msg'] = (int) $row['myid_last_msg'];
 
 				// Not really a problem?
-				if ($row[\'myid_first_msg\'] == $row[\'myid_first_msg\'] && $row[\'myid_first_msg\'] == $row[\'myid_first_msg\'] && $row[\'approved\'] == $row[\'firstmsg_approved\'])
+				if ($row['id_first_msg'] == $row['myid_first_msg'] && $row['id_first_msg'] == $row['myid_first_msg'] && $row['approved'] == $row['firstmsg_approved'])
 					return false;
 
-				$memberStartedID = (int) getMsgMemberID($row[\'myid_first_msg\']);
-				$memberUpdatedID = (int) getMsgMemberID($row[\'myid_last_msg\']);
+				$memberStartedID = (int) getMsgMemberID($row['myid_first_msg']);
+				$memberUpdatedID = (int) getMsgMemberID($row['myid_last_msg']);
 
-				$smcFunc[\'db_query\'](\'\', "
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}topics
-					SET id_first_msg = $row[myid_first_msg],
-						id_member_started = $memberStartedID, id_last_msg = $row[myid_last_msg],
-						id_member_updated = $memberUpdatedID, approved = $row[firstmsg_approved]
-					WHERE id_topic = $row[id_topic]",
+					SET id_first_msg = {int:myid_first_msg},
+						id_member_started = {int:memberStartedID}, id_last_msg = {int:myid_last_msg},
+						id_member_updated = {int:memberUpdatedID}, approved = {int:firstmsg_approved}
+					WHERE id_topic = {int:topic_id}',
 					array(
+						'myid_first_msg' => $row['myid_first_msg'],
+						'memberStartedID' => $memberStartedID,
+						'myid_last_msg' => $row['myid_last_msg'],
+						'memberUpdatedID' => $memberUpdatedID,
+						'firstmsg_approved' => $row['firstmsg_approved'],
+						'topic_id' => $row['id_topic'],
 					)
 				);
-			'),
-			'message_function' => create_function('$row', '
+			},
+			'message_function' => function($row)
+			{
 				global $txt, $context;
 
 				// A pretend error?
-				if ($row[\'myid_first_msg\'] == $row[\'myid_first_msg\'] && $row[\'myid_first_msg\'] == $row[\'myid_first_msg\'] && $row[\'approved\'] == $row[\'firstmsg_approved\'])
+				if ($row['id_first_msg'] == $row['myid_first_msg'] && $row['id_last_msg'] == $row['myid_last_msg'] && $row['approved'] == $row['firstmsg_approved'])
 					return false;
 
-				if ($row[\'id_first_msg\'] != $row[\'myid_first_msg\'])
-					$context[\'repair_errors\'][] = sprintf($txt[\'repair_stats_topics_1\'], $row[\'id_topic\'], $row[\'id_first_msg\']);
-				if ($row[\'id_last_msg\'] != $row[\'myid_last_msg\'])
-					$context[\'repair_errors\'][] = sprintf($txt[\'repair_stats_topics_2\'], $row[\'id_topic\'], $row[\'id_last_msg\']);
-				if ($row[\'approved\'] != $row[\'firstmsg_approved\'])
-					$context[\'repair_errors\'][] = sprintf($txt[\'repair_stats_topics_5\'], $row[\'id_topic\']);
+				if ($row['id_first_msg'] != $row['myid_first_msg'])
+					$context['repair_errors'][] = sprintf($txt['repair_stats_topics_1'], $row['id_topic'], $row['id_first_msg']);
+				if ($row['id_last_msg'] != $row['myid_last_msg'])
+					$context['repair_errors'][] = sprintf($txt['repair_stats_topics_2'], $row['id_topic'], $row['id_last_msg']);
+				if ($row['approved'] != $row['firstmsg_approved'])
+					$context['repair_errors'][] = sprintf($txt['repair_stats_topics_5'], $row['id_topic']);
 
 				return true;
-			'),
+			},
 		),
 		// Find topics with incorrect num_replies.
 		'stats_topics2' => array(
@@ -524,34 +541,38 @@ function loadForumTests()
 				WHERE t.id_topic BETWEEN {STEP_LOW} AND {STEP_HIGH}
 				GROUP BY t.id_topic, t.num_replies, mf.approved
 				ORDER BY t.id_topic',
-			'fix_processing' => create_function('$row', '
+			'fix_processing' => function($row)
+			{
 				global $smcFunc;
-				$row[\'my_num_replies\'] = (int) $row[\'my_num_replies\'];
+				$row['my_num_replies'] = (int) $row['my_num_replies'];
 
 				// Not really a problem?
-				if ($row[\'my_num_replies\'] == $row[\'num_replies\'])
+				if ($row['my_num_replies'] == $row['num_replies'])
 					return false;
 
-				$smcFunc[\'db_query\'](\'\', "
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}topics
-					SET num_replies = $row[my_num_replies]
-					WHERE id_topic = $row[id_topic]",
+					SET num_replies = {int:my_num_replies}
+					WHERE id_topic = {int:topic_id}',
 					array(
+						'my_num_replies' => $row['my_num_replies'],
+						'topic_id' => $row['id_topic'],
 					)
 				);
-			'),
-			'message_function' => create_function('$row', '
+			},
+			'message_function' => function($row)
+			{
 				global $txt, $context;
 
 				// Just joking?
-				if ($row[\'my_num_replies\'] == $row[\'num_replies\'])
+				if ($row['my_num_replies'] == $row['num_replies'])
 					return false;
 
-				if ($row[\'num_replies\'] != $row[\'my_num_replies\'])
-					$context[\'repair_errors\'][] = sprintf($txt[\'repair_stats_topics_3\'], $row[\'id_topic\'], $row[\'num_replies\']);
+				if ($row['num_replies'] != $row['my_num_replies'])
+					$context['repair_errors'][] = sprintf($txt['repair_stats_topics_3'], $row['id_topic'], $row['num_replies']);
 
 				return true;
-			'),
+			},
 		),
 		// Find topics with incorrect unapproved_posts.
 		'stats_topics3' => array(
@@ -570,18 +591,21 @@ function loadForumTests()
 				GROUP BY t.id_topic, t.unapproved_posts
 				HAVING unapproved_posts != COUNT(mu.id_msg)
 				ORDER BY t.id_topic',
-			'fix_processing' => create_function('$row', '
+			'fix_processing' => function($row)
+			{
 				global $smcFunc;
-				$row[\'my_unapproved_posts\'] = (int) $row[\'my_unapproved_posts\'];
+				$row['my_unapproved_posts'] = (int) $row['my_unapproved_posts'];
 
-				$smcFunc[\'db_query\'](\'\', "
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}topics
-					SET unapproved_posts = $row[my_unapproved_posts]
-					WHERE id_topic = $row[id_topic]",
+					SET unapproved_posts = {int:my_unapproved_posts}
+					WHERE id_topic = {int:topic_id}',
 					array(
+						'my_unapproved_posts' => $row['my_unapproved_posts'],
+						'topic_id' => $row['id_topic'],
 					)
 				);
-			'),
+			},
 			'messages' => array('repair_stats_topics_4', 'id_topic', 'unapproved_posts'),
 		),
 		// Find topics with nonexistent boards.
@@ -607,36 +631,43 @@ function loadForumTests()
 				WHERE b.id_board IS NULL
 					AND t.id_topic BETWEEN {STEP_LOW} AND {STEP_HIGH}
 				GROUP BY t.id_board',
-			'fix_processing' => create_function('$row', '
-				global $smcFunc, $salvageCatID;
+			'fix_processing' => function($row)
+			{
+				global $smcFunc, $salvageCatID, $txt;
 				createSalvageArea();
 
-				$row[\'my_num_topics\'] = (int) $row[\'my_num_topics\'];
-				$row[\'my_num_posts\'] = (int) $row[\'my_num_posts\'];
+				$row['my_num_topics'] = (int) $row['my_num_topics'];
+				$row['my_num_posts'] = (int) $row['my_num_posts'];
 
-				$smcFunc[\'db_insert\'](\'\',
-					\'{db_prefix}boards\',
-					array(\'id_cat\' => \'int\', \'name\' => \'string\', \'description\' => \'string\', \'num_topics\' => \'int\', \'num_posts\' => \'int\', \'member_groups\' => \'string\'),
-					array($salvageCatID, \'Salvaged board\', \'\', $row[\'my_num_topics\'], $row[\'my_num_posts\'], \'1\'),
-					array(\'id_board\')
+				$smcFunc['db_insert']('',
+					'{db_prefix}boards',
+					array('id_cat' => 'int', 'name' => 'string', 'description' => 'string', 'num_topics' => 'int', 'num_posts' => 'int', 'member_groups' => 'string'),
+					array($salvageCatID, $txt['salvaged_board_name'], $txt['salvaged_board_description'], $row['my_num_topics'], $row['my_num_posts'], '1'),
+					array('id_board'),
+					1
 				);
-				$newBoardID = $smcFunc[\'db_insert_id\'](\'{db_prefix}boards\', \'id_board\');
 
-				$smcFunc[\'db_query\'](\'\', "
+				$newBoardID = $smcFunc['db_insert_id']('{db_prefix}boards', 'id_board');
+
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}topics
-					SET id_board = $newBoardID
-					WHERE id_board = $row[id_board]",
+					SET id_board = {int:newBoardID}
+					WHERE id_board = {int:board_id}',
 					array(
+						'newBoardID' => $newBoardID,
+						'board_id' => $row['id_board'],
 					)
 				);
-				$smcFunc[\'db_query\'](\'\', "
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}messages
-					SET id_board = $newBoardID
-					WHERE id_board = $row[id_board]",
+					SET id_board = {int:newBoardID}
+					WHERE id_board = {int:board_id}',
 					array(
+						'newBoardID' => $newBoardID,
+						'board_id' => $row['id_board'],
 					)
 				);
-			'),
+			},
 			'messages' => array('repair_missing_boards', 'id_topic', 'id_board'),
 		),
 		// Find boards with nonexistent categories.
@@ -649,18 +680,20 @@ function loadForumTests()
 				ORDER BY b.id_cat, b.id_board',
 			'fix_collect' => array(
 				'index' => 'id_cat',
-				'process' => create_function('$cats', '
+				'process' => function($cats)
+				{
 					global $smcFunc, $salvageCatID;
 					createSalvageArea();
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						UPDATE {db_prefix}boards
-						SET id_cat = $salvageCatID
-						WHERE id_cat IN ({array_int:categories})",
+						SET id_cat = {int:salvageCatID}
+						WHERE id_cat IN ({array_int:categories})',
 						array(
-							\'categories\' => $cats
+							'salvageCatID' => $salvageCatID,
+							'categories' => $cats,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_categories', 'id_board', 'id_cat'),
 		),
@@ -683,17 +716,19 @@ function loadForumTests()
 			// Last step-make sure all non-guest posters still exist.
 			'fix_collect' => array(
 				'index' => 'id_msg',
-				'process' => create_function('$msgs', '
+				'process' => function($msgs)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						UPDATE {db_prefix}messages
-						SET id_member = 0
-						WHERE id_msg IN ({array_int:msgs})",
+						SET id_member = {int:guest_id}
+						WHERE id_msg IN ({array_int:msgs})',
 						array(
-							\'msgs\' => $msgs
+							'msgs' => $msgs,
+							'guest_id' => 0,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_posters', 'id_msg', 'id_member'),
 		),
@@ -708,18 +743,24 @@ function loadForumTests()
 				ORDER BY b.id_parent, b.id_board',
 			'fix_collect' => array(
 				'index' => 'id_parent',
-				'process' => create_function('$parents', '
+				'process' => function($parents)
+				{
 					global $smcFunc, $salvageBoardID, $salvageCatID;
+
 					createSalvageArea();
-					$smcFunc[\'db_query\'](\'\', "
+					(int) $salvageBoardID;
+
+					$smcFunc['db_query']('', '
 						UPDATE {db_prefix}boards
-						SET id_parent = $salvageBoardID, id_cat = $salvageCatID, child_level = 1
-						WHERE id_parent IN ({array_int:parents})",
+						SET id_parent = {int:salvageBoardID}, id_cat = {int:salvageCatID}, child_level = 1
+						WHERE id_parent IN ({array_int:parents})',
 						array(
-							\'parents\' => $parents
+							'salvageBoardID' => $salvageBoardID,
+							'salvageCatID' => $salvageCatID,
+							'parents' => $parents,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_parents', 'id_board', 'id_parent'),
 		),
@@ -739,17 +780,18 @@ function loadForumTests()
 					AND p.id_poll IS NULL',
 			'fix_collect' => array(
 				'index' => 'id_poll',
-				'process' => create_function('$polls', '
+				'process' => function($polls)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						UPDATE {db_prefix}topics
 						SET id_poll = 0
-						WHERE id_poll IN ({array_int:polls})",
+						WHERE id_poll IN ({array_int:polls})',
 						array(
-							\'polls\' => $polls
+							'polls' => $polls,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_polls', 'id_topic', 'id_poll'),
 		),
@@ -770,17 +812,18 @@ function loadForumTests()
 				ORDER BY cal.id_topic',
 			'fix_collect' => array(
 				'index' => 'id_topic',
-				'process' => create_function('$events', '
+				'process' => function($events)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', \'
+					$smcFunc['db_query']('', '
 						UPDATE {db_prefix}calendar
 						SET id_topic = 0, id_board = 0
-						WHERE id_topic IN ({array_int:events})\',
+						WHERE id_topic IN ({array_int:events})',
 						array(
-							\'events\' => $events
+							'events' => $events,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_calendar_topics', 'id_event', 'id_topic'),
 		),
@@ -799,16 +842,17 @@ function loadForumTests()
 					AND lt.id_member BETWEEN {STEP_LOW} AND {STEP_HIGH}',
 			'fix_collect' => array(
 				'index' => 'id_topic',
-				'process' => create_function('$topics', '
+				'process' => function($topics)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_topics
-						WHERE id_topic IN ({array_int:topics})",
+						WHERE id_topic IN ({array_int:topics})',
 						array(
-							\'topics\' => $topics
+							'topics' => $topics,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_topics', 'id_topic'),
 		),
@@ -828,16 +872,17 @@ function loadForumTests()
 				GROUP BY lt.id_member',
 			'fix_collect' => array(
 				'index' => 'id_member',
-				'process' => create_function('$members', '
+				'process' => function($members)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_topics
-						WHERE id_member IN ({array_int:members})",
+						WHERE id_member IN ({array_int:members})',
 						array(
-							\'members\' => $members
+							'members' => $members,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_topics_members', 'id_member'),
 		),
@@ -857,16 +902,17 @@ function loadForumTests()
 				GROUP BY lb.id_board',
 			'fix_collect' => array(
 				'index' => 'id_board',
-				'process' => create_function('$boards', '
+				'process' => function($boards)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_boards
-						WHERE id_board IN ({array_int:boards})",
+						WHERE id_board IN ({array_int:boards})',
 						array(
-							\'boards\' => $boards
+							'boards' => $boards,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_boards', 'id_board'),
 		),
@@ -886,16 +932,16 @@ function loadForumTests()
 				GROUP BY lb.id_member',
 			'fix_collect' => array(
 				'index' => 'id_member',
-				'process' => create_function('$members', '
-					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+				'process' => function($members) use ($smcFunc)
+				{
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_boards
-						WHERE id_member IN ({array_int:members})",
+						WHERE id_member IN ({array_int:members})',
 						array(
-							\'members\' => $members
+							'members' => $members,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_boards_members', 'id_member'),
 		),
@@ -915,16 +961,16 @@ function loadForumTests()
 				GROUP BY lmr.id_board',
 			'fix_collect' => array(
 				'index' => 'id_board',
-				'process' => create_function('$boards', '
-					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+				'process' => function($boards) use ($smcFunc)
+				{
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_mark_read
-						WHERE id_board IN ({array_int:boards})",
+						WHERE id_board IN ({array_int:boards})',
 						array(
-							\'boards\' => $boards
+							'boards' => $boards,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_mark_read', 'id_board'),
 		),
@@ -944,16 +990,16 @@ function loadForumTests()
 				GROUP BY lmr.id_member',
 			'fix_collect' => array(
 				'index' => 'id_member',
-				'process' => create_function('$members', '
-					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+				'process' => function($members) use ($smcFunc)
+				{
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_mark_read
-						WHERE id_member IN ({array_int:members})",
+						WHERE id_member IN ({array_int:members})',
 						array(
-							\'members\' => $members
+							'members' => $members,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_mark_read_members', 'id_member'),
 		),
@@ -973,16 +1019,16 @@ function loadForumTests()
 				GROUP BY pmr.id_pm',
 			'fix_collect' => array(
 				'index' => 'id_pm',
-				'process' => create_function('$pms', '
-					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+				'process' => function($pms) use ($smcFunc)
+				{
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}pm_recipients
-						WHERE id_pm IN ({array_int:pms})",
+						WHERE id_pm IN ({array_int:pms})',
 						array(
-							\'pms\' => $pms
+							'pms' => $pms,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_pms', 'id_pm'),
 		),
@@ -1003,16 +1049,17 @@ function loadForumTests()
 				GROUP BY pmr.id_member',
 			'fix_collect' => array(
 				'index' => 'id_member',
-				'process' => create_function('$members', '
+				'process' => function($members)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}pm_recipients
-						WHERE id_member IN ({array_int:members})",
+						WHERE id_member IN ({array_int:members})',
 						array(
-							\'members\' => $members
+							'members' => $members,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_recipients', 'id_member'),
 		),
@@ -1032,16 +1079,18 @@ function loadForumTests()
 					AND mem.id_member IS NULL',
 			'fix_collect' => array(
 				'index' => 'id_pm',
-				'process' => create_function('$guestMessages', '
+				'process' => function($guestMessages)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						UPDATE {db_prefix}personal_messages
 						SET id_member_from = 0
-						WHERE id_pm IN ({array_int:guestMessages})",
+						WHERE id_pm IN ({array_int:guestMessages})',
 						array(
-							\'guestMessages\' => $guestMessages
-						));
-				'),
+							'guestMessages' => $guestMessages,
+						)
+					);
+				},
 			),
 			'messages' => array('repair_missing_senders', 'id_pm', 'id_member_from'),
 		),
@@ -1061,16 +1110,16 @@ function loadForumTests()
 				GROUP BY ln.id_member',
 			'fix_collect' => array(
 				'index' => 'id_member',
-				'process' => create_function('$members', '
-					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+				'process' => function($members) use ($smcFunc)
+				{
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_notify
-						WHERE id_member IN ({array_int:members})",
+						WHERE id_member IN ({array_int:members})',
 						array(
-							\'members\' => $members
+							'members' => $members,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_notify_members', 'id_member'),
 		),
@@ -1088,46 +1137,47 @@ function loadForumTests()
 					LEFT JOIN {db_prefix}log_search_subjects AS lss ON (lss.id_topic = t.id_topic)
 				WHERE t.id_topic BETWEEN {STEP_LOW} AND {STEP_HIGH}
 					AND lss.id_topic IS NULL',
-			'fix_full_processing' => create_function('$result', '
+			'fix_full_processing' => function($result)
+			{
 				global $smcFunc;
 
 				$inserts = array();
-				while ($row = $smcFunc[\'db_fetch_assoc\']($result))
+				while ($row = $smcFunc['db_fetch_assoc']($result))
 				{
-					foreach (text2words($row[\'subject\']) as $word)
-						$inserts[] = array($word, $row[\'id_topic\']);
+					foreach (text2words($row['subject']) as $word)
+						$inserts[] = array($word, $row['id_topic']);
 					if (count($inserts) > 500)
 					{
-						$smcFunc[\'db_insert\'](\'ignore\',
-							"{db_prefix}log_search_subjects",
-							array(\'word\' => \'string\', \'id_topic\' => \'int\'),
+						$smcFunc['db_insert']('ignore',
+							'{db_prefix}log_search_subjects',
+							array('word' => 'string', 'id_topic' => 'int'),
 							$inserts,
-							array(\'word\', \'id_topic\')
+							array('word', 'id_topic')
 						);
 						$inserts = array();
 					}
-
 				}
 
 				if (!empty($inserts))
-					$smcFunc[\'db_insert\'](\'ignore\',
-						"{db_prefix}log_search_subjects",
-						array(\'word\' => \'string\', \'id_topic\' => \'int\'),
+					$smcFunc['db_insert']('ignore',
+						'{db_prefix}log_search_subjects',
+						array('word' => 'string', 'id_topic' => 'int'),
 						$inserts,
-						array(\'word\', \'id_topic\')
+						array('word', 'id_topic')
 					);
-			'),
-			'message_function' => create_function('$row', '
+			},
+			'message_function' => function($row)
+			{
 				global $txt, $context;
 
-				if (count(text2words($row[\'subject\'])) != 0)
+				if (count(text2words($row['subject'])) != 0)
 				{
-					$context[\'repair_errors\'][] = sprintf($txt[\'repair_missing_cached_subject\'], $row[\'id_topic\']);
+					$context['repair_errors'][] = sprintf($txt['repair_missing_cached_subject'], $row['id_topic']);
 					return true;
 				}
 
 				return false;
-			'),
+			},
 		),
 		'missing_topic_for_cache' => array(
 			'substeps' => array(
@@ -1144,16 +1194,17 @@ function loadForumTests()
 					AND t.id_topic IS NULL',
 			'fix_collect' => array(
 				'index' => 'id_topic',
-				'process' => create_function('$deleteTopics', '
+				'process' => function($deleteTopics)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_search_subjects
-						WHERE id_topic IN ({array_int:deleteTopics})",
+						WHERE id_topic IN ({array_int:deleteTopics})',
 						array(
-							\'deleteTopics\' => $deleteTopics
+							'deleteTopics' => $deleteTopics,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_topic_for_cache', 'word'),
 		),
@@ -1173,16 +1224,17 @@ function loadForumTests()
 					AND mem.id_member IS NULL',
 			'fix_collect' => array(
 				'index' => 'id_member',
-				'process' => create_function('$members', '
+				'process' => function($members)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_polls
-						WHERE id_member IN ({array_int:members})",
+						WHERE id_member IN ({array_int:members})',
 						array(
-							\'members\' => $members
+							'members' => $members,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_poll_member', 'id_poll', 'id_member'),
 		),
@@ -1201,16 +1253,17 @@ function loadForumTests()
 					AND p.id_poll IS NULL',
 			'fix_collect' => array(
 				'index' => 'id_poll',
-				'process' => create_function('$polls', '
+				'process' => function($polls)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_polls
-						WHERE id_poll IN ({array_int:polls})",
+						WHERE id_poll IN ({array_int:polls})',
 						array(
-							\'polls\' => $polls
+							'polls' => $polls,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_poll_vote', 'id_member', 'id_poll'),
 		),
@@ -1229,16 +1282,17 @@ function loadForumTests()
 					AND lrc.id_report IS NULL',
 			'fix_collect' => array(
 				'index' => 'id_report',
-				'process' => create_function('$reports', '
+				'process' => function($reports)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_reported
-						WHERE id_report IN ({array_int:reports})",
+						WHERE id_report IN ({array_int:reports})',
 						array(
-							\'reports\' => $reports
+							'reports' => $reports,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_report_missing_comments', 'id_report', 'subject'),
 		),
@@ -1257,16 +1311,17 @@ function loadForumTests()
 					AND lr.id_report IS NULL',
 			'fix_collect' => array(
 				'index' => 'id_report',
-				'process' => create_function('$reports', '
+				'process' => function($reports)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_reported_comments
-						WHERE id_report IN ({array_int:reports})",
+						WHERE id_report IN ({array_int:reports})',
 						array(
-							\'reports\' => $reports
+							'reports' => $reports,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_comments_missing_report', 'id_report', 'membername'),
 		),
@@ -1286,16 +1341,17 @@ function loadForumTests()
 				GROUP BY lgr.id_member',
 			'fix_collect' => array(
 				'index' => 'id_member',
-				'process' => create_function('$members', '
+				'process' => function($members)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_group_requests
-						WHERE id_member IN ({array_int:members})",
+						WHERE id_member IN ({array_int:members})',
 						array(
-							\'members\' => $members
+							'members' => $members,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_group_request_missing_member', 'id_member'),
 		),
@@ -1315,16 +1371,17 @@ function loadForumTests()
 				GROUP BY lgr.id_group',
 			'fix_collect' => array(
 				'index' => 'id_group',
-				'process' => create_function('$groups', '
+				'process' => function($groups)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', \'
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_group_requests
-						WHERE id_group IN ({array_int:groups})\',
+						WHERE id_group IN ({array_int:groups})',
 						array(
-							\'groups\' => $groups
+							'groups' => $groups,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_group_request_missing_group', 'id_group'),
 		),
@@ -1346,7 +1403,7 @@ function findForumErrors($do_fix = false)
 
 	// Don't allow the cache to get too full.
 	$db_temp_cache = $db_cache;
-	$db_cache = '';
+	$db_cache = array();
 
 	$context['total_steps'] = count($errorTests);
 
@@ -1503,7 +1560,7 @@ function findForumErrors($do_fix = false)
 			// Free the result.
 			$smcFunc['db_free_result']($request);
 			// Keep memory down.
-			$db_cache = '';
+			$db_cache = array();
 
 			// Are we done yet?
 			if (isset($test['substeps']))
diff --git a/Sources/ScheduledTasks.php b/Sources/ScheduledTasks.php
index e0824a6..6cb05e8 100644
--- a/Sources/ScheduledTasks.php
+++ b/Sources/ScheduledTasks.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.9
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -391,7 +391,7 @@ function scheduled_approval_notification()
 // Do some daily cleaning up.
 function scheduled_daily_maintenance()
 {
-	global $smcFunc, $modSettings, $sourcedir, $db_type;
+	global $smcFunc, $modSettings, $sourcedir, $db_type, $image_proxy_enabled, $cachedir;
 
 	// First clean out the cache.
 	clean_cache();
@@ -491,6 +491,19 @@ function scheduled_daily_maintenance()
 			)
 		);
 
+	// Cleanup old proxied images.
+	if (!empty($image_proxy_enabled) && $handle = opendir($cachedir . '/images'))
+	{
+		while (false !== ($file = readdir($handle)))
+		{
+			// Remove images older than 5 days.
+			if (is_file($cachedir . '/images/' . $file) && !in_array($file, array('index.php', '.htaccess')) && time() - filemtime($cachedir . '/images/' . $file) > 5 * 86400)
+				unlink($cachedir . '/images/' . $file);
+		}
+
+		closedir($handle);
+	}
+
 	// Log we've done it...
 	return true;
 }
@@ -1002,7 +1015,7 @@ function ReduceMailQueue($number = false, $override_limit = false, $force_send =
 				@apache_reset_timeout();
 		}
 		else
-			$result = smtp_mail(array($email['to']), $email['subject'], $email['body'], $email['send_html'] ? $email['headers'] : 'Mime-Version: 1.0' . "\r\n" . $email['headers']);
+			$result = smtp_mail(array($email['to']), $email['subject'], $email['body'], $email['headers']);
 
 		// Hopefully it sent?
 		if (!$result)
@@ -1236,6 +1249,35 @@ function loadEssentialThemeData()
 	}
 
 	loadLanguage('index+Modifications');
+
+	// Also load up some context that is used by routines throughout ScheduledTasks.
+	// These may not be set when AutoTask is called very early in index.php.
+	// When scheduled tasks throw undefined errors, address them here.
+
+	if (!isset($context['server']))
+	{
+		// Copied over from Load.php...
+		// This determines the server... not used in many places, except for login fixing.
+		$context['server'] = array(
+			'is_iis' => isset($_SERVER['SERVER_SOFTWARE']) && strpos($_SERVER['SERVER_SOFTWARE'], 'Microsoft-IIS') !== false,
+			'is_apache' => isset($_SERVER['SERVER_SOFTWARE']) && strpos($_SERVER['SERVER_SOFTWARE'], 'Apache') !== false,
+			'is_lighttpd' => isset($_SERVER['SERVER_SOFTWARE']) && strpos($_SERVER['SERVER_SOFTWARE'], 'lighttpd') !== false,
+			'is_nginx' => isset($_SERVER['SERVER_SOFTWARE']) && strpos($_SERVER['SERVER_SOFTWARE'], 'nginx') !== false,
+			'is_cgi' => isset($_SERVER['SERVER_SOFTWARE']) && strpos(php_sapi_name(), 'cgi') !== false,
+			'is_windows' => strpos(PHP_OS, 'WIN') === 0,
+			'iso_case_folding' => ord(strtolower(chr(138))) === 154,
+			'complex_preg_chars' => @version_compare(PHP_VERSION, '4.3.3') != -1,
+		);
+	}
+
+	if (!isset($context['utf8']))
+	{
+		// Copied over from Load.php...
+		// Set the character set from the template.
+		$context['character_set'] = empty($modSettings['global_character_set']) ? (empty($txt['lang_character_set']) ? 'ISO-8859-1' : $txt['lang_character_set']) : $modSettings['global_character_set'];
+		$context['utf8'] = $context['character_set'] === 'UTF-8' && (strpos(strtolower(PHP_OS), 'win') === false || @version_compare(PHP_VERSION, '4.2.3') != -1);
+		$context['right_to_left'] = !empty($txt['lang_rtl']);
+	}
 }
 
 function scheduled_fetchSMfiles()
@@ -1273,7 +1315,7 @@ function scheduled_fetchSMfiles()
 	foreach ($js_files as $ID_FILE => $file)
 	{
 		// Create the url
-		$server = empty($file['path']) || substr($file['path'], 0, 7) != 'http://' ? 'http://www.simplemachines.org' : '';
+		$server = empty($file['path']) || !in_array(parse_url($file['path'], PHP_URL_SCHEME), array('http', 'https')) ? 'https://www.simplemachines.org' : '';
 		$url = $server . (!empty($file['path']) ? $file['path'] : $file['path']) . $file['filename'] . (!empty($file['parameters']) ? '?' . $file['parameters'] : '');
 
 		// Get the file
diff --git a/Sources/Search.php b/Sources/Search.php
index 62cbd6b..66ee60a 100644
--- a/Sources/Search.php
+++ b/Sources/Search.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.9
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -1667,7 +1667,7 @@ function PlushSearch2()
 					else
 						$_SESSION['search_cache']['num_results'] += $smcFunc['db_affected_rows']();
 				}
-				else
+				elseif ($_SESSION['search_cache']['num_results'] == -1)
 					$_SESSION['search_cache']['num_results'] = 0;
 			}
 		}
diff --git a/Sources/SearchAPI-Custom.php b/Sources/SearchAPI-Custom.php
index e719582..0e4a0cd 100644
--- a/Sources/SearchAPI-Custom.php
+++ b/Sources/SearchAPI-Custom.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.15
  */
 
 if (!defined('SMF'))
@@ -109,7 +109,7 @@ class custom_search
 
 		// Excluded phrases don't benefit from being split into subwords.
 		if (count($subwords) > 1 && $isExcluded)
-			continue;
+			return;
 		else
 		{
 			foreach ($subwords as $subword)
diff --git a/Sources/SearchAPI-Fulltext.php b/Sources/SearchAPI-Fulltext.php
index 11ea37a..a55bef9 100644
--- a/Sources/SearchAPI-Fulltext.php
+++ b/Sources/SearchAPI-Fulltext.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -113,7 +113,7 @@ class fulltext_search
 	// Do we have to do some work with the words we are searching for to prepare them?
 	public function prepareIndexes($word, &$wordsSearch, &$wordsExclude, $isExcluded)
 	{
-		global $modSettings;
+		global $modSettings, $smcFunc;
 
 		$subwords = text2words($word, null, false);
 
@@ -168,8 +168,8 @@ class fulltext_search
 		if (empty($modSettings['search_simple_fulltext']))
 			foreach ($words['words'] as $regularWord)
 			{
-				$query_where[] = 'm.body' . (in_array($regularWord, $query_params['excluded_words']) ? ' NOT' : '') . (empty($modSettings['search_match_words']) || $no_regexp ? ' LIKE ' : 'RLIKE') . '{string:complex_body_' . $count . '}';
-				$query_params['complex_body_' . $count++] = empty($modSettings['search_match_words']) || $no_regexp ? '%' . strtr($regularWord, array('_' => '\\_', '%' => '\\%')) . '%' : '[[:<:]]' . addcslashes(preg_replace(array('/([\[\]$.+*?|{}()])/'), array('[$1]'), $regularWord), '\\\'') . '[[:>:]]';
+				$query_where[] = 'm.body' . (in_array($regularWord, $query_params['excluded_words']) ? ' NOT' : '') . (empty($modSettings['search_match_words']) || $search_data['no_regexp'] ? ' LIKE ' : 'RLIKE') . '{string:complex_body_' . $count . '}';
+				$query_params['complex_body_' . $count++] = empty($modSettings['search_match_words']) || $search_data['no_regexp'] ? '%' . strtr($regularWord, array('_' => '\\_', '%' => '\\%')) . '%' : '[[:<:]]' . addcslashes(preg_replace(array('/([\[\]$.+*?|{}()])/'), array('[$1]'), $regularWord), '\\\'') . '[[:>:]]';
 			}
 
 		if ($query_params['user_query'])
@@ -188,15 +188,15 @@ class fulltext_search
 		if (!empty($query_params['excluded_phrases']) && empty($modSettings['search_force_index']))
 			foreach ($query_params['excluded_phrases'] as $phrase)
 			{
-				$query_where[] = 'subject NOT ' . (empty($modSettings['search_match_words']) || $no_regexp ? ' LIKE ' : 'RLIKE') . '{string:exclude_subject_phrase_' . $count . '}';
-				$query_params['exclude_subject_phrase_' . $count++] = empty($modSettings['search_match_words']) || $no_regexp ? '%' . strtr($phrase, array('_' => '\\_', '%' => '\\%')) . '%' : '[[:<:]]' . addcslashes(preg_replace(array('/([\[\]$.+*?|{}()])/'), array('[$1]'), $phrase), '\\\'') . '[[:>:]]';
+				$query_where[] = 'subject NOT ' . (empty($modSettings['search_match_words']) || $search_data['no_regexp'] ? ' LIKE ' : 'RLIKE') . '{string:exclude_subject_phrase_' . $count . '}';
+				$query_params['exclude_subject_phrase_' . $count++] = empty($modSettings['search_match_words']) || $search_data['no_regexp'] ? '%' . strtr($phrase, array('_' => '\\_', '%' => '\\%')) . '%' : '[[:<:]]' . addcslashes(preg_replace(array('/([\[\]$.+*?|{}()])/'), array('[$1]'), $phrase), '\\\'') . '[[:>:]]';
 			}
 		$count = 0;
 		if (!empty($query_params['excluded_subject_words']) && empty($modSettings['search_force_index']))
 			foreach ($query_params['excluded_subject_words'] as $excludedWord)
 			{
-				$query_where[] = 'subject NOT ' . (empty($modSettings['search_match_words']) || $no_regexp ? ' LIKE ' : 'RLIKE') . '{string:exclude_subject_words_' . $count . '}';
-				$query_params['exclude_subject_words_' . $count++] = empty($modSettings['search_match_words']) || $no_regexp ? '%' . strtr($excludedWord, array('_' => '\\_', '%' => '\\%')) . '%' : '[[:<:]]' . addcslashes(preg_replace(array('/([\[\]$.+*?|{}()])/'), array('[$1]'), $excludedWord), '\\\'') . '[[:>:]]';
+				$query_where[] = 'subject NOT ' . (empty($modSettings['search_match_words']) || $search_data['no_regexp'] ? ' LIKE ' : 'RLIKE') . '{string:exclude_subject_words_' . $count . '}';
+				$query_params['exclude_subject_words_' . $count++] = empty($modSettings['search_match_words']) || $search_data['no_regexp'] ? '%' . strtr($excludedWord, array('_' => '\\_', '%' => '\\%')) . '%' : '[[:<:]]' . addcslashes(preg_replace(array('/([\[\]$.+*?|{}()])/'), array('[$1]'), $excludedWord), '\\\'') . '[[:>:]]';
 			}
 
 		if (!empty($modSettings['search_simple_fulltext']))
diff --git a/Sources/Security.php b/Sources/Security.php
index a6392b9..8d3aa10 100644
--- a/Sources/Security.php
+++ b/Sources/Security.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.3
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -101,7 +101,7 @@ if (!defined('SMF'))
 */
 
 // Check if the user is who he/she says he is
-function validateSession()
+function validateSession($force = false)
 {
 	global $modSettings, $sourcedir, $user_info, $sc, $user_settings;
 
@@ -112,7 +112,7 @@ function validateSession()
 	$refreshTime = isset($_GET['xml']) ? 4200 : 3600;
 
 	// Is the security option off?  Or are they already logged in?
-	if (!empty($modSettings['securityDisable']) || (!empty($_SESSION['admin_time']) && $_SESSION['admin_time'] + $refreshTime >= time()))
+	if (!$force && (!empty($modSettings['securityDisable']) || (!empty($_SESSION['admin_time']) && $_SESSION['admin_time'] + $refreshTime >= time())))
 		return;
 
 	require_once($sourcedir . '/Subs-Auth.php');
@@ -820,6 +820,11 @@ function allowedTo($permission, $boards = null)
 	if (empty($user_info))
 		return false;
 
+	// Calling this before permissions have not been set up properly?
+	// Assume a denial, since we don't know if you can do anything yet.
+	if (!isset($user_info['permissions']))
+		return false;
+
 	// Administrators are supermen :P.
 	if ($user_info['is_admin'])
 		return true;
diff --git a/Sources/SendTopic.php b/Sources/SendTopic.php
index 13accec..30db718 100644
--- a/Sources/SendTopic.php
+++ b/Sources/SendTopic.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.15
  */
 
 if (!defined('SMF'))
@@ -127,7 +127,7 @@ function SendTopic()
 		fatal_lang_error('no_name', false);
 	if (!isset($_POST['y_email']) || $_POST['y_email'] == '')
 		fatal_lang_error('no_email', false);
-	if (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $_POST['y_email']) == 0)
+	if (filter_var($_POST['y_email'], FILTER_VALIDATE_EMAIL) === false)
 		fatal_lang_error('email_invalid_character', false);
 
 	// The receiver should be valid to.
@@ -135,7 +135,7 @@ function SendTopic()
 		fatal_lang_error('no_name', false);
 	if (!isset($_POST['r_email']) || $_POST['r_email'] == '')
 		fatal_lang_error('no_email', false);
-	if (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $_POST['r_email']) == 0)
+	if (filter_var($_POST['r_email'], FILTER_VALIDATE_EMAIL) === false)
 		fatal_lang_error('email_invalid_character', false);
 
 	// Emails don't like entities...
@@ -244,7 +244,7 @@ function CustomEmail()
 				fatal_lang_error('no_name', false);
 			if (empty($_POST['y_email']))
 				fatal_lang_error('no_email', false);
-			if (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $_POST['y_email']) == 0)
+			if (filter_var($_POST['y_email'], FILTER_VALIDATE_EMAIL) === false)
 				fatal_lang_error('email_invalid_character', false);
 
 			$from_name = trim($_POST['y_name']);
@@ -385,7 +385,7 @@ function ReportToModerator2()
 		$_POST['email'] = !isset($_POST['email']) ? '' : trim($_POST['email']);
 		if ($_POST['email'] === '')
 			$post_errors[] = 'no_email';
-		elseif (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $_POST['email']) == 0)
+		elseif (filter_var($_POST['email'], FILTER_VALIDATE_EMAIL) === false)
 			$post_errors[] = 'bad_email';
 
 		isBannedEmail($_POST['email'], 'cannot_post', sprintf($txt['you_are_post_banned'], $txt['guest_title']));
diff --git a/Sources/SplitTopics.php b/Sources/SplitTopics.php
index 89c8f7a..bca9f56 100644
--- a/Sources/SplitTopics.php
+++ b/Sources/SplitTopics.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.14
  */
 
 // Original module by Mach8 - We'll never forget you.
@@ -186,7 +186,7 @@ function SplitIndex()
 	// Basic template information....
 	$context['message'] = array(
 		'id' => $_GET['at'],
-		'subject' => $_REQUEST['subname']
+		'subject' => $smcFunc['htmlspecialchars']($_REQUEST['subname']),
 	);
 	$context['sub_template'] = 'ask';
 	$context['page_title'] = $txt['split'];
diff --git a/Sources/Stats.php b/Sources/Stats.php
index 91713f1..19b96bf 100644
--- a/Sources/Stats.php
+++ b/Sources/Stats.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.15
  */
 
 if (!defined('SMF'))
@@ -742,12 +742,20 @@ function SMStats()
 {
 	global $modSettings, $user_info, $forum_version, $sourcedir;
 
+	// Is this the old settings (upgrade failure)?
+	if (!empty($modSettings['allow_sm_stats']))
+	{
+		$modSettings['enable_sm_stats'] = 1;
+		$modSettings['sm_stats_key'] = $modSettings['allow_sm_stats'];
+		unset($modSettings['allow_sm_stats']);
+	}
+
 	// First, is it disabled?
-	if (empty($modSettings['allow_sm_stats']))
+	if (empty($modSettings['enable_sm_stats']) || empty($modSettings['sm_stats_key']))
 		die();
 
 	// Are we saying who we are, and are we right? (OR an admin)
-	if (!$user_info['is_admin'] && (!isset($_GET['sid']) || $_GET['sid'] != $modSettings['allow_sm_stats']))
+	if (!$user_info['is_admin'] && (!isset($_GET['sid']) || $_GET['sid'] != $modSettings['sm_stats_key']))
 		die();
 
 	// Verify the referer...
@@ -764,14 +772,14 @@ function SMStats()
 
 	// Get the actual stats.
 	$stats_to_send = array(
-		'UID' => $modSettings['allow_sm_stats'],
+		'UID' => $modSettings['sm_stats_key'],
 		'time_added' => time(),
 		'members' => $modSettings['totalMembers'],
 		'messages' => $modSettings['totalMessages'],
 		'topics' => $modSettings['totalTopics'],
 		'boards' => 0,
 		'php_version' => $serverVersions['php']['version'],
-		'database_type' => strtolower($serverVersions['db_server']['title']),
+		'database_type' => strtolower($serverVersions['db_engine']['version']),
 		'database_version' => $serverVersions['db_server']['version'],
 		'smf_version' => $forum_version,
 		'smfd_version' => $modSettings['smfVersion'],
@@ -798,9 +806,9 @@ function SMStats()
 			$out = 'POST /smf/stats/collect_stats.php HTTP/1.1' . "\r\n";
 			$out .= 'Host: www.simplemachines.org' . "\r\n";
 			$out .= 'Content-Type: application/x-www-form-urlencoded' . "\r\n";
+			$out .= 'Connection: Close' . "\r\n";
 			$out .= 'Content-Length: ' . $length . "\r\n\r\n";
 			$out .= $stats_to_send . "\r\n";
-			$out .= 'Connection: Close' . "\r\n\r\n";
 			fwrite($fp, $out);
 			fclose($fp);
 		}
diff --git a/Sources/Subs-Admin.php b/Sources/Subs-Admin.php
index 51dcc0e..b9f1994 100644
--- a/Sources/Subs-Admin.php
+++ b/Sources/Subs-Admin.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -76,6 +76,9 @@ function getServerVersions($checkFor)
 			trigger_error('getServerVersions(): you need to be connected to the database in order to get its server version', E_USER_NOTICE);
 		else
 		{
+			$versions['db_engine'] = array('title' => sprintf($txt['database_server'], $smcFunc['db_title']), 'version' => '');
+			$versions['db_engine']['version'] = $smcFunc['db_get_engine']();
+
 			$versions['db_server'] = array('title' => sprintf($txt['support_versions_db'], $smcFunc['db_title']), 'version' => '');
 			$versions['db_server']['version'] = $smcFunc['db_get_version']();
 		}
@@ -322,51 +325,7 @@ function updateSettingsFile($config_vars)
 	if (count($settingsArray) < 12)
 		return;
 
-	// Try to avoid a few pitfalls:
-	// like a possible race condition,
-	// or a failure to write at low diskspace
-
-	// Check before you act: if cache is enabled, we can do a simple test
-	// Can we even write things on this filesystem?
-	if ((empty($cachedir) || !file_exists($cachedir)) && file_exists($boarddir . '/cache'))
-		$cachedir = $boarddir . '/cache';
-	$test_fp = @fopen($cachedir . '/settings_update.tmp', "w+");
-	if ($test_fp)
-	{
-		fclose($test_fp);
-
-		$test_fp = @fopen($cachedir . '/settings_update.tmp', 'r+');
-		$written_bytes = fwrite($test_fp, "test");
-		fclose($test_fp);
-		@unlink($cachedir . '/settings_update.tmp');
-
-		if ($written_bytes !== strlen("test"))
-		{
-			// Oops. Low disk space, perhaps. Don't mess with Settings.php then.
-			// No means no. :P
-			return;
-		}
-	}
-
-	// Protect me from what I want! :P
-	clearstatcache();
-	if (filemtime($boarddir . '/Settings.php') === $last_settings_change)
-	{
-		// You asked for it...
-		// Blank out the file - done to fix a oddity with some servers.
-		$fp = @fopen($boarddir . '/Settings.php', 'w');
-
-		// Is it even writable, though?
-		if ($fp)
-		{
-			fclose($fp);
-
-			$fp = fopen($boarddir . '/Settings.php', 'r+');
-			foreach ($settingsArray as $line)
-				fwrite($fp, strtr($line, "\r", ''));
-			fclose($fp);
-		}
-	}
+	safe_file_write($boarddir . '/Settings.php', strtr(implode('', $settingsArray), "\r", ''), $boarddir . '/Settings_bak.php', $last_settings_change);
 }
 
 function updateAdminPreferences()
@@ -514,13 +473,15 @@ function updateLastDatabaseError()
 	$data = preg_replace('~\$db_last_error = \d+;~', '$db_last_error = ' . time() . ';', $data);
 
 	// Open the backup file for writing
-	if ($fp = @fopen($file, 'w'))
+	if ($fp = @fopen($file, 'c'))
 	{
 		// Reset the file buffer.
 		set_file_buffer($fp, 0);
 
 		// Update the file.
 		$t = flock($fp, LOCK_EX);
+		ftruncate($fp, 0);
+		rewind($fp);
 		$bytes = fwrite($fp, $data);
 		flock($fp, LOCK_UN);
 		fclose($fp);
@@ -547,4 +508,228 @@ function updateLastDatabaseError()
 	return false;
 }
 
+/**
+ * Writes data to a file, optionally making a backup, while avoiding race conditions.
+ *
+ * @param string $file The filepath of the file where the data should be written.
+ * @param string $data The data to be written to $file.
+ * @param string $backup_file The filepath where the backup should be saved. Default null.
+ * @param int $mtime If modification time of $file is more recent than this Unix timestamp, the write operation will abort. Defaults to time that the script started execution.
+ * @param bool $append If true, the data will be appended instead of overwriting the existing content of the file. Default false.
+ * @return bool Whether the write operation succeeded or not.
+ */
+function safe_file_write($file, $data, $backup_file = null, $mtime = null, $append = false)
+{
+	// Sanity checks.
+	if (!file_exists($file) && !is_dir(dirname($file)))
+		return false;
+
+	if (!is_int($mtime))
+		$mtime = $_SERVER['REQUEST_TIME'];
+
+	$temp_dir = sm_temp_dir();
+
+	// Our temp files.
+	$temp_sfile = tempnam($temp_dir, pathinfo($file, PATHINFO_FILENAME) . '.');
+
+	if (!empty($backup_file))
+		$temp_bfile = tempnam($temp_dir, pathinfo($backup_file, PATHINFO_FILENAME) . '.');
+
+	// We need write permissions.
+	$failed = false;
+	foreach (array($file, $backup_file) as $sf)
+	{
+		if (empty($sf))
+			continue;
+
+		if (!file_exists($sf))
+			touch($sf);
+		elseif (!is_file($sf))
+			$failed = true;
+
+		if (!$failed && !is_writable($sf))
+		{
+			foreach (array(0644, 0664, 0666) as $mode)
+			{
+				$failed = !@chmod($sf, $mode);
+				if (!$failed)
+					break;
+			}
+		}
+	}
+
+	// Now let's see if writing to a temp file succeeds.
+	if (!$failed && file_put_contents($temp_sfile, $data, LOCK_EX) !== strlen($data))
+		$failed = true;
+
+	// Tests passed, so it's time to do the job.
+	if (!$failed)
+	{
+		// Back up the backup, just in case.
+		if (file_exists($backup_file))
+			$temp_bfile_saved = @copy($backup_file, $temp_bfile);
+
+		// Make sure no one changed the file while we weren't looking.
+		clearstatcache();
+		if (filemtime($file) <= $mtime)
+		{
+			// Attempt to open the file.
+			$sfhandle = @fopen($file, 'c');
+
+			// Let's do this thing!
+			if ($sfhandle !== false)
+			{
+				// Immediately get a lock.
+				flock($sfhandle, LOCK_EX);
+
+				// Make sure the backup works before we do anything more.
+				$temp_sfile_saved = @copy($file, $temp_sfile);
+
+				// Now write our data to the file.
+				if ($temp_sfile_saved)
+				{
+					if (empty($append))
+					{
+						ftruncate($sfhandle, 0);
+						rewind($sfhandle);
+					}
+
+					$failed = fwrite($sfhandle, $data) !== strlen($data);
+				}
+				else
+					$failed = true;
+
+				// If writing failed, put everything back the way it was.
+				if ($failed)
+				{
+					if (!empty($temp_sfile_saved))
+						@rename($temp_sfile, $file);
+
+					if (!empty($temp_bfile_saved))
+						@rename($temp_bfile, $backup_file);
+				}
+				// It worked, so make our temp backup the new permanent backup.
+				elseif (!empty($backup_file))
+					@rename($temp_sfile, $backup_file);
+
+				// And we're done.
+				flock($sfhandle, LOCK_UN);
+				fclose($sfhandle);
+			}
+		}
+	}
+
+	// We're done with these.
+	@unlink($temp_sfile);
+	@unlink($temp_bfile);
+
+	if ($failed)
+		return false;
+
+	// Even though on normal installations the filemtime should invalidate any cached version
+	// it seems that there are times it might not. So let's MAKE it dump the cache.
+	if (function_exists('opcache_invalidate'))
+		opcache_invalidate($file, true);
+
+	return true;
+}
+
+/**
+ * Locates the most appropriate temp directory.
+ *
+ * Systems using `open_basedir` restrictions may receive errors with
+ * `sys_get_temp_dir()` due to misconfigurations on servers. Other
+ * cases sys_temp_dir may not be set to a safe value. Additionally
+ * `sys_get_temp_dir` may use a readonly directory. This attempts to
+ * find a working temp directory that is accessible under the
+ * restrictions and is writable to the web service account.
+ *
+ * Directories checked against `open_basedir`:
+ *
+ * - `sys_get_temp_dir()`
+ * - `upload_tmp_dir`
+ * - `session.save_path`
+ * - `cachedir`
+ *
+ * @return string
+*/
+function sm_temp_dir()
+{
+	global $cachedir;
+
+	static $temp_dir = null;
+
+	// Already did this.
+	if (!empty($temp_dir))
+		return $temp_dir;
+
+	// Temp Directory options order.
+	$temp_dir_options = array(
+		0 => 'sys_get_temp_dir',
+		1 => 'upload_tmp_dir',
+		2 => 'session.save_path',
+		3 => 'cachedir'
+	);
+
+	// Determine if we should detect a restriction and what restrictions that may be.
+	$open_base_dir = ini_get('open_basedir');
+	$restriction = !empty($open_base_dir) ? explode(':', $open_base_dir) : false;
+
+	// Prevent any errors as we search.
+	$old_error_reporting = error_reporting(0);
+
+	// Search for a working temp directory.
+	foreach ($temp_dir_options as $id_temp => $temp_option)
+	{
+		switch ($temp_option) {
+			case 'cachedir':
+				$possible_temp = rtrim($cachedir, '/');
+				break;
+
+			case 'session.save_path':
+				$possible_temp = rtrim(ini_get('session.save_path'), '/');
+				break;
+
+			case 'upload_tmp_dir':
+				$possible_temp = rtrim(ini_get('upload_tmp_dir'), '/');
+				break;
+
+			default:
+				$possible_temp = sys_get_temp_dir();
+				break;
+		}
+
+		// Check if we have a restriction preventing this from working.
+		if ($restriction)
+		{
+			foreach ($restriction as $dir)
+			{
+				if (strpos($possible_temp, $dir) !== false && is_writable($possible_temp))
+				{
+					$temp_dir = $possible_temp;
+					break;
+				}
+			}
+		}
+		// No restrictions, but need to check for writable status.
+		elseif (is_writable($possible_temp))
+		{
+			$temp_dir = $possible_temp;
+			break;
+		}
+	}
+
+	// Fall back to sys_get_temp_dir even though it won't work, so we have something.
+	if (empty($temp_dir))
+		$temp_dir = sys_get_temp_dir();
+
+	// Fix the path.
+	$temp_dir = substr($temp_dir, -1) === '/' ? $temp_dir : $temp_dir . '/';
+
+	// Put things back.
+	error_reporting($old_error_reporting);
+
+	return $temp_dir;
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/Subs-Auth.php b/Sources/Subs-Auth.php
index f1a2dfa..34a7953 100644
--- a/Sources/Subs-Auth.php
+++ b/Sources/Subs-Auth.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.11
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -102,7 +102,7 @@ if (!defined('SMF'))
 // Actually set the login cookie...
 function setLoginCookie($cookie_length, $id, $password = '')
 {
-	global $cookiename, $boardurl, $modSettings;
+	global $cookiename, $cookie_no_auth_secret, $boardurl, $modSettings;
 
 	// If changing state force them to re-address some permission caching.
 	$_SESSION['mc']['time'] = 0;
@@ -121,6 +121,11 @@ function setLoginCookie($cookie_length, $id, $password = '')
 		}
 	}
 
+	// Ensure the cookie can't be forged.
+	// Note: $cookie_no_auth_secret is a fallback that will be removed in future versions!
+	if ($password !== '' && empty($cookie_no_auth_secret))
+		$password = hash_hmac('sha1', $password, get_auth_secret());
+
 	// Get the data and path to set it on.
 	$data = serialize(empty($id) ? array(0, '', 0) : array($id, $password, time() + $cookie_length, $cookie_state));
 	$cookie_url = url_parts(!empty($modSettings['localCookies']), !empty($modSettings['globalCookies']));
@@ -360,6 +365,7 @@ function findMembers($names, $use_wildcards = false, $buddies_only = false, $max
 		$names = explode(',', $names);
 
 	$maybe_email = false;
+	$names_list = array();
 	foreach ($names as $i => $name)
 	{
 		// Trim, and fix wildcards for each name.
@@ -372,6 +378,9 @@ function findMembers($names, $use_wildcards = false, $buddies_only = false, $max
 			$names[$i] = strtr($names[$i], array('%' => '\%', '_' => '\_', '*' => '%', '?' => '_', '\'' => '&#039;'));
 		else
 			$names[$i] = strtr($names[$i], array('\'' => '&#039;'));
+
+		$names_list[] = '{string:lookup_name_' . $i . '}';
+		$where_params['lookup_name_' . $i] = $names[$i];
 	}
 
 	// What are we using to compare?
@@ -393,22 +402,23 @@ function findMembers($names, $use_wildcards = false, $buddies_only = false, $max
 	$member_name = $smcFunc['db_case_sensitive'] ? 'LOWER(member_name)' : 'member_name';
 	$real_name = $smcFunc['db_case_sensitive'] ? 'LOWER(real_name)' : 'real_name';
 
+	// Searches.
+	$member_name_search = $member_name . ' ' . $comparison . ' ' . implode( ' OR ' . $member_name . ' ' . $comparison . ' ', $names_list);
+	$real_name_search = $real_name . ' ' . $comparison . ' ' . implode( ' OR ' . $real_name . ' ' . $comparison . ' ', $names_list);
+
 	// Search by username, display name, and email address.
 	$request = $smcFunc['db_query']('', '
 		SELECT id_member, member_name, real_name, email_address, hide_email
 		FROM {db_prefix}members
-		WHERE ({raw:member_name_search}
-			OR {raw:real_name_search} {raw:email_condition})
+		WHERE (' . $member_name_search . '
+			OR ' . $real_name_search . ' ' . $email_condition . ')
 			' . ($buddies_only ? 'AND id_member IN ({array_int:buddy_list})' : '') . '
 			AND is_activated IN (1, 11)
 		LIMIT {int:limit}',
-		array(
+		array_merge($where_params, array(
 			'buddy_list' => $user_info['buddies'],
-			'member_name_search' => $member_name . ' ' . $comparison . ' \'' . implode( '\' OR ' . $member_name . ' ' . $comparison . ' \'', $names) . '\'',
-			'real_name_search' => $real_name . ' ' . $comparison . ' \'' . implode( '\' OR ' . $real_name . ' ' . $comparison . ' \'', $names) . '\'',
-			'email_condition' => $email_condition,
 			'limit' => $max,
-		)
+		))
 	);
 	while ($row = $smcFunc['db_fetch_assoc']($request))
 	{
@@ -531,7 +541,8 @@ function RequestMembers()
 
 		if (preg_match('~&#\d+;~', $row['real_name']) != 0)
 		{
-			$fixchar = create_function('$n', '
+			$fixchar = function($n)
+			{
 				if ($n < 128)
 					return chr($n);
 				elseif ($n < 2048)
@@ -539,7 +550,8 @@ function RequestMembers()
 				elseif ($n < 65536)
 					return chr(224 | $n >> 12) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);
 				else
-					return chr(240 | $n >> 18) . chr(128 | $n >> 12 & 63) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);');
+					return chr(240 | $n >> 18) . chr(128 | $n >> 12 & 63) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);
+			};
 
 			$row['real_name'] = preg_replace_callback('~&#(\d+);~', 'fixchar__callback', $row['real_name']);
 		}
diff --git a/Sources/Subs-BoardIndex.php b/Sources/Subs-BoardIndex.php
index ab18d7e..e4dc5dd 100644
--- a/Sources/Subs-BoardIndex.php
+++ b/Sources/Subs-BoardIndex.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -87,7 +87,7 @@ function getBoardIndex($boardIndexOptions)
 	// Find all boards and categories, as well as related information.  This will be sorted by the natural order of boards and categories, which we control.
 	$result_boards = $smcFunc['db_query']('boardindex_fetch_boards', '
 		SELECT' . ($boardIndexOptions['include_categories'] ? '
-			c.id_cat, c.name AS cat_name,' : '') . '
+			c.id_cat, c.name AS cat_name, cat_order,' : '') . '
 			b.id_board, b.name AS board_name, b.description,
 			CASE WHEN b.redirect != {string:blank_string} THEN 1 ELSE 0 END AS is_redirect,
 			b.num_posts, b.num_topics, b.unapproved_posts, b.unapproved_topics, b.id_parent,
@@ -140,6 +140,7 @@ function getBoardIndex($boardIndexOptions)
 				$categories[$row_board['id_cat']] = array(
 					'id' => $row_board['id_cat'],
 					'name' => $row_board['cat_name'],
+					'order' => $row_board['cat_order'],
 					'is_collapsed' => isset($row_board['can_collapse']) && $row_board['can_collapse'] == 1 && $row_board['is_collapsed'] > 0,
 					'can_collapse' => isset($row_board['can_collapse']) && $row_board['can_collapse'] == 1,
 					'collapse_href' => isset($row_board['can_collapse']) ? $scripturl . '?action=collapse;c=' . $row_board['id_cat'] . ';sa=' . ($row_board['is_collapsed'] > 0 ? 'expand;' : 'collapse;') . (isset($context['single_cats']) ? 'c_redirect=' . (is_array($_REQUEST['c']) ? implode(',', $_REQUEST['c']) : $_REQUEST['c']) . ';' : '') . $context['session_var'] . '=' . $context['session_id'] . '#c' . $row_board['id_cat'] : '',
@@ -366,7 +367,21 @@ function getBoardIndex($boardIndexOptions)
 	if (!empty($boardIndexOptions['set_latest_post']) && !empty($latest_post['ref']))
 		$context['latest_post'] = $latest_post['ref'];
 
+	// Sort the categories, maintaining index association.
+	// Don't do it in the query, that would use a temporary table and be very slow.
+	if ($boardIndexOptions['include_categories'])
+		uasort($categories, 'cmpBoardIndex');
+
 	return $boardIndexOptions['include_categories'] ? $categories : $this_category;
 }
 
+function cmpBoardIndex($a, $b)
+{
+	if ($a['order'] == $b['order'])
+	{
+		return 0;
+	}
+	return ($a['order'] < $b['order']) ? -1 : 1;
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/Subs-Boards.php b/Sources/Subs-Boards.php
index 5500dc1..9f2ff14 100644
--- a/Sources/Subs-Boards.php
+++ b/Sources/Subs-Boards.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.15
  */
 
 if (!defined('SMF'))
@@ -415,7 +415,7 @@ function MarkRead()
 			);
 			if ($smcFunc['db_num_rows']($result) > 0)
 			{
-				$logBoardInserts = '';
+				$logBoardInserts = array();
 				while ($row = $smcFunc['db_fetch_assoc']($result))
 					$logBoardInserts[] = array($modSettings['maxMsgID'], $user_info['id'], $row['id_board']);
 
diff --git a/Sources/Subs-Compat.php b/Sources/Subs-Compat.php
index 0810058..3ad9d7e 100644
--- a/Sources/Subs-Compat.php
+++ b/Sources/Subs-Compat.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -97,7 +97,7 @@ function sha1_smf($str)
 	$blks = array_pad(array(), $nblk * 16, 0);
 
 	for ($i = 0; $i < strlen($str); $i++)
-		$blks[$i >> 2] |= ord($str{$i}) << (24 - ($i % 4) * 8);
+		$blks[$i >> 2] |= ord($str[$i]) << (24 - ($i % 4) * 8);
 
 	$blks[$i >> 2] |= 0x80 << (24 - ($i % 4) * 8);
 
diff --git a/Sources/Subs-Db-mysql.php b/Sources/Subs-Db-mysql.php
index 6db12a6..602acc2 100644
--- a/Sources/Subs-Db-mysql.php
+++ b/Sources/Subs-Db-mysql.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.9
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -24,7 +24,17 @@ if (!defined('SMF'))
 // Initialize the database settings
 function smf_db_initiate($db_server, $db_name, $db_user, $db_passwd, $db_prefix, $db_options = array())
 {
-	global $smcFunc, $mysql_set_mode;
+	global $smcFunc, $mysql_set_mode, $sourcedir;
+
+	// Check for MySQLi first...
+	// !!! This driver does not work on PHP < 5.4.0.
+	if (function_exists('mysqli_connect') && version_compare(PHP_VERSION, '5.4') >= 0)
+	{
+		$db = new SMF_DB_MySQLi;
+
+		// Delegate control over to the new database driver.
+		return $db->initiate($db_server, $db_name, $db_user, $db_passwd, $db_prefix, $db_options);
+	}
 
 	// Map some database specific functions, only do this once.
 	if (!isset($smcFunc['db_fetch_assoc']) || $smcFunc['db_fetch_assoc'] != 'mysql_fetch_assoc')
@@ -50,6 +60,8 @@ function smf_db_initiate($db_server, $db_name, $db_user, $db_passwd, $db_prefix,
 			'db_sybase' => false,
 			'db_case_sensitive' => false,
 			'db_escape_wildcard_string' => 'smf_db_escape_wildcard_string',
+			'db_connect_error' => 'mysql_connect_error',
+			'db_connect_errno' => 'mysql_connect_errno',
 		);
 
 	if (!empty($db_options['persist']))
@@ -230,7 +242,13 @@ function smf_db_quote($db_string, $db_values, $connection = null)
 function smf_db_query($identifier, $db_string, $db_values = array(), $connection = null)
 {
 	global $db_cache, $db_count, $db_connection, $db_show_debug, $time_start;
-	global $db_unbuffered, $db_callback, $modSettings;
+	global $db_unbuffered, $db_callback, $modSettings, $smcFunc;
+
+	// Check for MySQLi first...
+	// !!! This driver does not work on PHP < 5.4.0.
+	// !!! This passthrough is needed for the search functions.
+	if (function_exists('mysqli_connect') && version_compare(PHP_VERSION, '5.4') >= 0)
+		return $smcFunc['db_query']($identifier, $db_string, $db_values, $connection);
 
 	// Comments that are allowed in a query are preg_removed.
 	static $allowed_comments_from = array(
@@ -617,7 +635,7 @@ function smf_db_error($db_string, $connection = null)
 }
 
 // Insert some data...
-function smf_db_insert($method = 'replace', $table, $columns, $data, $keys, $disable_trans = false, $connection = null)
+function smf_db_insert($method, $table, $columns, $data, $keys, $disable_trans = false, $connection = null)
 {
 	global $smcFunc, $db_connection, $db_prefix;
 
@@ -734,4 +752,847 @@ function smf_db_escape_wildcard_string($string, $translate_human_wildcards=false
 
 	return strtr($string, $replacements);
 }
+class SMF_DB_MySQLi
+{
+	/**
+	 *  Maps the implementations in this file ($this->function_name)
+	 *  to the $smcFunc['db_function_name'] variable.
+	 *
+	 * @param string $db_server
+	 * @param string $db_name
+	 * @param string $db_user
+	 * @param string $db_passwd
+	 * @param string $db_prefix
+	 * @param array $db_options
+	 * @return null
+	 */
+	public function initiate($db_server, $db_name, $db_user, $db_passwd, $db_prefix, $db_options = array())
+	{
+		global $smcFunc, $mysql_set_mode;
+
+		// Map some database specific functions, only do this once.
+		if (!isset($smcFunc['db_fetch_assoc']) || $smcFunc['db_fetch_assoc'] != 'mysqli_fetch_assoc')
+			$smcFunc += array(
+				'db_query'                  => array($this, 'query'),
+				'db_quote'                  => array($this, 'quote'),
+				'db_fetch_assoc'            => 'mysqli_fetch_assoc',
+				'db_fetch_row'              => 'mysqli_fetch_row',
+				'db_free_result'            => 'mysqli_free_result',
+				'db_insert'                 => array($this, 'insert'),
+				'db_insert_id'              => array($this, 'insert_id'),
+				'db_num_rows'               => 'mysqli_num_rows',
+				'db_data_seek'              => 'mysqli_data_seek',
+				'db_num_fields'             => 'mysqli_num_fields',
+				'db_escape_string'          => 'addslashes',
+				'db_unescape_string'        => 'stripslashes',
+				'db_server_info'            => array($this, 'get_server_info'),
+				'db_affected_rows'          => array($this, 'affected_rows'),
+				'db_transaction'            => array($this, 'transaction'),
+				'db_error'                  => array($this, 'show_error'),
+				'db_select_db'              => array($this, 'select'),
+				'db_title'                  => 'MySQL',
+				'db_sybase'                 => false,
+				'db_case_sensitive'         => false,
+				'db_escape_wildcard_string' => array($this, 'escape_wildcard_string'),
+				'db_connect_error'          => 'mysqli_connect_error',
+				'db_connect_errno'          => 'mysqli_connect_errno',
+			);
+
+		// This was the default prior to PHP 8.1, and all our code assumes it.
+		mysqli_report(MYSQLI_REPORT_OFF);
+
+		if (!empty($db_options['persist']))
+			$connection = @mysqli_connect('p:' . $db_server, $db_user, $db_passwd);
+		else
+			$connection = @mysqli_connect($db_server, $db_user, $db_passwd);
+
+		// Something's wrong, show an error if its fatal (which we assume it is)
+		if (!$connection)
+		{
+			if (!empty($db_options['non_fatal']))
+				return null;
+			else
+				db_fatal_error();
+		}
+
+		// Select the database, unless told not to
+		if (empty($db_options['dont_select_db']) && !@mysqli_select_db($connection, $db_name) && empty($db_options['non_fatal']))
+			db_fatal_error();
+
+		// This makes it possible to have SMF automatically change the sql_mode and autocommit if needed.
+		if (isset($mysql_set_mode) && $mysql_set_mode === true)
+			$smcFunc['db_query']('', 'SET sql_mode = \'\', AUTOCOMMIT = 1',
+			array(),
+			$connection
+		);
+
+		return $connection;
+	}
+
+	/**
+	 * Wrap mysqli_select_db so the connection does not need to be specified
+	 *
+	 * @param string &database
+	 * @param object $connection
+	 */
+	public function select($database, $connection = null)
+	{
+		global $db_connection;
+
+		return mysqli_select_db($connection === null ? $db_connection : $connection, $database);
+	}
+
+	/**
+	 * Wrap mysqli_get_server_info so the connection does not need to be specified
+	 *
+	 * @param object $connection
+	 */
+	public function get_server_info($connection = null)
+	{
+		global $db_connection;
+
+		return mysqli_get_server_info($connection === null ? $db_connection : $connection);
+	}
+
+	/**
+	 * Callback for preg_replace_callback on the query.
+	 * It allows to replace on the fly a few pre-defined strings, for convenience ('query_see_board', 'query_wanna_see_board'), with
+	 * their current values from $user_info.
+	 * In addition, it performs checks and sanitization on the values sent to the database.
+	 *
+	 * @param $matches
+	 */
+	private function replacement__callback($matches)
+	{
+		global $db_callback, $user_info, $db_prefix;
+
+		list ($values, $connection) = $db_callback;
+		if (!is_object($connection))
+			db_fatal_error();
+
+		if ($matches[1] === 'db_prefix')
+			return $db_prefix;
+
+		if ($matches[1] === 'query_see_board')
+			return $user_info['query_see_board'];
+
+		if ($matches[1] === 'query_wanna_see_board')
+			return $user_info['query_wanna_see_board'];
+
+		if (!isset($matches[2]))
+			$this->error_backtrace('Invalid value inserted or no type specified.', '', E_USER_ERROR, __FILE__, __LINE__);
+
+		if (!isset($values[$matches[2]]))
+			$this->error_backtrace('The database value you\'re trying to insert does not exist: ' . htmlspecialchars($matches[2]), '', E_USER_ERROR, __FILE__, __LINE__);
+
+		$replacement = $values[$matches[2]];
+
+		switch ($matches[1])
+		{
+			case 'int':
+				if (!is_numeric($replacement) || (string) $replacement !== (string) (int) $replacement)
+					$this->error_backtrace('Wrong value type sent to the database. Integer expected. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+				return (string) (int) $replacement;
+			break;
+
+			case 'string':
+			case 'text':
+				return sprintf('\'%1$s\'', mysqli_real_escape_string($connection, $replacement));
+			break;
+
+			case 'array_int':
+				if (is_array($replacement))
+				{
+					if (empty($replacement))
+						$this->error_backtrace('Database error, given array of integer values is empty. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+
+					foreach ($replacement as $key => $value)
+					{
+						if (!is_numeric($value) || (string) $value !== (string) (int) $value)
+							$this->error_backtrace('Wrong value type sent to the database. Array of integers expected. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+
+						$replacement[$key] = (string) (int) $value;
+					}
+
+					return implode(', ', $replacement);
+				}
+				else
+					$this->error_backtrace('Wrong value type sent to the database. Array of integers expected. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+
+			break;
+
+			case 'array_string':
+				if (is_array($replacement))
+				{
+					if (empty($replacement))
+						$this->error_backtrace('Database error, given array of string values is empty. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+
+					foreach ($replacement as $key => $value)
+						$replacement[$key] = sprintf('\'%1$s\'', mysqli_real_escape_string($connection, $value));
+
+					return implode(', ', $replacement);
+				}
+				else
+					$this->error_backtrace('Wrong value type sent to the database. Array of strings expected. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+			break;
+
+			case 'date':
+				if (preg_match('~^(\d{4})-([0-1]?\d)-([0-3]?\d)$~', $replacement, $date_matches) === 1)
+					return sprintf('\'%04d-%02d-%02d\'', $date_matches[1], $date_matches[2], $date_matches[3]);
+				else
+					$this->error_backtrace('Wrong value type sent to the database. Date expected. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+			break;
+
+			case 'float':
+				if (!is_numeric($replacement))
+					$this->error_backtrace('Wrong value type sent to the database. Floating point number expected. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+				return (string) (float) $replacement;
+			break;
+
+			case 'identifier':
+				// Backticks inside identifiers are supported as of MySQL 4.1. We don't need them for SMF.
+				return '`' . strtr($replacement, array('`' => '', '.' => '')) . '`';
+			break;
+
+			case 'raw':
+				return $replacement;
+			break;
+
+			default:
+				$this->error_backtrace('Undefined type used in the database query. (' . $matches[1] . ':' . $matches[2] . ')', '', false, __FILE__, __LINE__);
+			break;
+		}
+	}
+
+	/**
+	 * Just like the db_query, escape and quote a string, but not executing the query.
+	 *
+	 * @param string $db_string
+	 * @param array $db_values
+	 * @param object $connection = null
+	 */
+	public function quote($db_string, $db_values, $connection = null)
+	{
+		global $db_callback, $db_connection;
+
+		// Only bother if there's something to replace.
+		if (strpos($db_string, '{') !== false)
+		{
+			// This is needed by the callback function.
+			$db_callback = array($db_values, $connection === null ? $db_connection : $connection);
+
+			// Do the quoting and escaping
+			$db_string = preg_replace_callback('~{([a-z_]+)(?::([a-zA-Z0-9_-]+))?}~', array($this, 'replacement__callback'), $db_string);
+
+			// Clear this global variable.
+			$db_callback = array();
+		}
+
+		return $db_string;
+	}
+
+	/**
+	 * Do a query.  Takes care of errors too.
+	 *
+	 * @param string $identifier
+	 * @param string $db_string
+	 * @param array $db_values = array()
+	 * @param object $connection = null
+	 */
+	public function query($identifier, $db_string, $db_values = array(), $connection = null)
+	{
+		global $db_cache, $db_count, $db_connection, $db_show_debug, $time_start;
+		global $db_unbuffered, $db_persist, $db_callback, $modSettings;
+
+		// Comments that are allowed in a query are preg_removed.
+		static $allowed_comments_from = array(
+			'~\s+~s',
+			'~/\*!40001 SQL_NO_CACHE \*/~',
+			'~/\*!40000 USE INDEX \([A-Za-z\_]+?\) \*/~',
+			'~/\*!40100 ON DUPLICATE KEY UPDATE id_msg = \d+ \*/~',
+		);
+		static $allowed_comments_to = array(
+			' ',
+			'',
+			'',
+			'',
+		);
+
+		// Decide which connection to use.
+		$connection = $connection === null ? $db_connection : $connection;
+
+		// Special queries that need processing.
+		$replacements = array(
+			'alter_table_boards' => array(
+				'~(.+)~' => '',
+			),
+			'boardindex_fetch_boards' => array(
+				'~(.)$~' => '$1 ORDER BY b.board_order',
+			),
+			'messageindex_fetch_boards' => array(
+				'~(.)$~' => '$1 ORDER BY b.board_order',
+			),
+			'order_by_board_order' => array(
+				'~(.)$~' => '$1 ORDER BY b.board_order',
+			),
+		);
+
+		if (isset($replacements[$identifier]))
+			$db_string = preg_replace(array_keys($replacements[$identifier]), array_values($replacements[$identifier]), $db_string);
+
+		if (trim($db_string) == '')
+			return false;
+
+		// Get a connection if we are shutting down, sometimes the link is closed before sessions are written
+		if (!is_object($connection))
+		{
+			global $db_server, $db_user, $db_passwd, $db_name, $db_show_debug, $ssi_db_user, $ssi_db_passwd;
+
+			// Are we in SSI mode?  If so try that username and password first
+			if (SMF == 'SSI' && !empty($ssi_db_user) && !empty($ssi_db_passwd))
+			{
+				if (empty($db_persist))
+					$db_connection = @mysqli_connect($db_server, $ssi_db_user, $ssi_db_passwd);
+				else
+					$db_connection = @mysqli_connect('p:' . $db_server, $ssi_db_user, $ssi_db_passwd);
+			}
+			// Fall back to the regular username and password if need be
+			if (!$db_connection)
+			{
+				if (empty($db_persist))
+					$db_connection = @mysqli_connect($db_server, $db_user, $db_passwd);
+				else
+					$db_connection = @mysqli_connect('p:' . $db_server, $db_user, $db_passwd);
+			}
+
+			if (!$db_connection || !@mysqli_select_db($db_connection, $db_name))
+				$db_connection = false;
+
+			$connection = $db_connection;
+		}
+
+		// One more query....
+		$db_count = !isset($db_count) ? 1 : $db_count + 1;
+
+		if (empty($modSettings['disableQueryCheck']) && strpos($db_string, '\'') !== false && empty($db_values['security_override']))
+			$this->error_backtrace('Hacking attempt...', 'Illegal character (\') used in query...', true, __FILE__, __LINE__);
+
+		// Use "ORDER BY null" to prevent Mysql doing filesorts for Group By clauses without an Order By
+		if (strpos($db_string, 'GROUP BY') !== false && strpos($db_string, 'ORDER BY') === false && preg_match('~^\s+SELECT~i', $db_string))
+		{
+			// Add before LIMIT
+			if ($pos = strpos($db_string, 'LIMIT '))
+				$db_string = substr($db_string, 0, $pos) . "\t\t\tORDER BY null\n" . substr($db_string, $pos, strlen($db_string));
+			else
+				// Append it.
+				$db_string .= "\n\t\t\tORDER BY null";
+		}
+
+		if (empty($db_values['security_override']) && (!empty($db_values) || strpos($db_string, '{db_prefix}') !== false))
+		{
+			// Pass some values to the global space for use in the callback function.
+			$db_callback = array($db_values, $connection);
+
+			// Inject the values passed to this function.
+			$db_string = preg_replace_callback('~{([a-z_]+)(?::([a-zA-Z0-9_-]+))?}~', array($this, 'replacement__callback'), $db_string);
+
+			// This shouldn't be residing in global space any longer.
+			$db_callback = array();
+		}
+
+		// Debugging.
+		if (isset($db_show_debug) && $db_show_debug === true)
+		{
+			// Get the file and line number this function was called.
+			list ($file, $line) = $this->error_backtrace('', '', 'return', __FILE__, __LINE__);
+
+			// Initialize $db_cache if not already initialized.
+			if (!isset($db_cache))
+				$db_cache = array();
+
+			if (!empty($_SESSION['debug_redirect']))
+			{
+				$db_cache = array_merge($_SESSION['debug_redirect'], $db_cache);
+				$db_count = count($db_cache) + 1;
+				$_SESSION['debug_redirect'] = array();
+			}
+
+			// Don't overload it.
+			$st = microtime();
+			$db_cache[$db_count]['q'] = $db_count < 50 ? $db_string : '...';
+			$db_cache[$db_count]['f'] = $file;
+			$db_cache[$db_count]['l'] = $line;
+			$db_cache[$db_count]['s'] = array_sum(explode(' ', $st)) - array_sum(explode(' ', $time_start));
+		}
+
+		// First, we clean strings out of the query, reduce whitespace, lowercase, and trim - so we can check it over.
+		if (empty($modSettings['disableQueryCheck']))
+		{
+			$clean = '';
+			$old_pos = 0;
+			$pos = -1;
+			while (true)
+			{
+				$pos = strpos($db_string, '\'', $pos + 1);
+				if ($pos === false)
+					break;
+				$clean .= substr($db_string, $old_pos, $pos - $old_pos);
+
+				while (true)
+				{
+					$pos1 = strpos($db_string, '\'', $pos + 1);
+					$pos2 = strpos($db_string, '\\', $pos + 1);
+					if ($pos1 === false)
+						break;
+					elseif ($pos2 == false || $pos2 > $pos1)
+					{
+						$pos = $pos1;
+						break;
+					}
+
+					$pos = $pos2 + 1;
+				}
+				$clean .= ' %s ';
+
+				$old_pos = $pos + 1;
+			}
+			$clean .= substr($db_string, $old_pos);
+			$clean = trim(strtolower(preg_replace($allowed_comments_from, $allowed_comments_to, $clean)));
+
+			// We don't use UNION in SMF, at least so far.  But it's useful for injections.
+			if (strpos($clean, 'union') !== false && preg_match('~(^|[^a-z])union($|[^[a-z])~s', $clean) != 0)
+				$fail = true;
+			// Comments?  We don't use comments in our queries, we leave 'em outside!
+			elseif (strpos($clean, '/*') > 2 || strpos($clean, '--') !== false || strpos($clean, ';') !== false)
+				$fail = true;
+			// Trying to change passwords, slow us down, or something?
+			elseif (strpos($clean, 'sleep') !== false && preg_match('~(^|[^a-z])sleep($|[^[_a-z])~s', $clean) != 0)
+				$fail = true;
+			elseif (strpos($clean, 'benchmark') !== false && preg_match('~(^|[^a-z])benchmark($|[^[a-z])~s', $clean) != 0)
+				$fail = true;
+			// Sub selects?  We don't use those either.
+			elseif (preg_match('~\([^)]*?select~s', $clean) != 0)
+				$fail = true;
+
+			if (!empty($fail) && function_exists('log_error'))
+				$this->error_backtrace('Hacking attempt...', 'Hacking attempt...' . "\n" . $db_string, E_USER_ERROR, __FILE__, __LINE__);
+		}
+
+		if (empty($db_unbuffered))
+			$ret = @mysqli_query($connection, $db_string);
+		else
+			$ret = @mysqli_query($connection, $db_string, MYSQLI_USE_RESULT);
+
+		if ($ret === false && empty($db_values['db_error_skip']))
+			$ret = $this->error($db_string, $connection);
+
+		// Debugging.
+		if (isset($db_show_debug) && $db_show_debug === true)
+			$db_cache[$db_count]['t'] = array_sum(explode(' ', microtime())) - array_sum(explode(' ', $st));
+
+		return $ret;
+	}
+
+	/**
+	 * affected_rows
+	 * @param object $connection
+	 */
+	public function affected_rows($connection = null)
+	{
+		global $db_connection;
+
+		return mysqli_affected_rows($connection === null ? $db_connection : $connection);
+	}
+
+	/**
+	 * insert_id
+	 *
+	 * @param string $table
+	 * @param string $field = null
+	 * @param object $connection = null
+	 */
+	public function insert_id($table, $field = null, $connection = null)
+	{
+		global $db_connection, $db_prefix;
+
+		$table = str_replace('{db_prefix}', $db_prefix, $table);
+
+		// MySQL doesn't need the table or field information.
+		return mysqli_insert_id($connection === null ? $db_connection : $connection);
+	}
+
+	/**
+	 * Do a transaction.
+	 *
+	 * @param string $type - the step to perform (i.e. 'begin', 'commit', 'rollback')
+	 * @param object $connection = null
+	 */
+	public function transaction($type = 'commit', $connection = null)
+	{
+		global $db_connection;
+
+		// Decide which connection to use
+		$connection = $connection === null ? $db_connection : $connection;
+
+		if ($type == 'begin')
+			return @mysqli_query($connection, 'BEGIN');
+		elseif ($type == 'rollback')
+			return @mysqli_query($connection, 'ROLLBACK');
+		elseif ($type == 'commit')
+			return @mysqli_query($connection, 'COMMIT');
+
+		return false;
+	}
+
+	/**
+	 * Database error!
+	 *
+	 * @param object $connection = null
+	 */
+	public function show_error($connection = null)
+	{
+		global $db_connection;
+
+		// Decide which connection to use
+		$connection = $connection === null ? $db_connection : $connection;
+
+		// This is the error message...
+		return mysqli_errno($connection);
+	}
+
+	/**
+	 * Database error!
+	 * Backtrace, log, try to fix.
+	 *
+	 * @param string $db_string
+	 * @param object $connection = null
+	 */
+	private function error($db_string, $connection = null)
+	{
+		global $txt, $context, $sourcedir, $webmaster_email, $modSettings;
+		global $forum_version, $db_connection, $db_last_error, $db_persist;
+		global $db_server, $db_user, $db_passwd, $db_name, $db_show_debug, $ssi_db_user, $ssi_db_passwd;
+		global $smcFunc;
+
+		// Get the file and line numbers.
+		list ($file, $line) = $this->error_backtrace('', '', 'return', __FILE__, __LINE__);
+
+		// Decide which connection to use
+		$connection = $connection === null ? $db_connection : $connection;
+
+		// This is the error message...
+		$query_error = mysqli_error($connection);
+		$query_errno = mysqli_errno($connection);
+
+		// Error numbers:
+		//    1016: Can't open file '....MYI'
+		//    1030: Got error ??? from table handler.
+		//    1034: Incorrect key file for table.
+		//    1035: Old key file for table.
+		//    1205: Lock wait timeout exceeded.
+		//    1213: Deadlock found.
+		//    2006: Server has gone away.
+		//    2013: Lost connection to server during query.
+
+		// Log the error.
+		if ($query_errno != 1213 && $query_errno != 1205 && function_exists('log_error'))
+			log_error($txt['database_error'] . ': ' . $query_error . (!empty($modSettings['enableErrorQueryLogging']) ? "\n\n$db_string" : ''), 'database', $file, $line);
+
+		// Database error auto fixing ;).
+		if (function_exists('cache_get_data') && (!isset($modSettings['autoFixDatabase']) || $modSettings['autoFixDatabase'] == '1'))
+		{
+			// Force caching on, just for the error checking.
+			$old_cache = @$modSettings['cache_enable'];
+			$modSettings['cache_enable'] = '1';
+
+			if (($temp = cache_get_data('db_last_error', 600)) !== null)
+				$db_last_error = max(@$db_last_error, $temp);
+
+			if (@$db_last_error < time() - 3600 * 24 * 3)
+			{
+				// We know there's a problem... but what?  Try to auto detect.
+				if ($query_errno == 1030 && strpos($query_error, ' 127 ') !== false)
+				{
+					preg_match_all('~(?:[\n\r]|^)[^\']+?(?:FROM|JOIN|UPDATE|TABLE) ((?:[^\n\r(]+?(?:, )?)*)~s', $db_string, $matches);
+
+					$fix_tables = array();
+					foreach ($matches[1] as $tables)
+					{
+						$tables = array_unique(explode(',', $tables));
+						foreach ($tables as $table)
+						{
+							// Now, it's still theoretically possible this could be an injection.  So backtick it!
+							if (trim($table) != '')
+								$fix_tables[] = '`' . strtr(trim($table), array('`' => '')) . '`';
+						}
+					}
+
+					$fix_tables = array_unique($fix_tables);
+				}
+				// Table crashed.  Let's try to fix it.
+				elseif ($query_errno == 1016)
+				{
+					if (preg_match('~\'([^\.\']+)~', $query_error, $match) != 0)
+						$fix_tables = array('`' . $match[1] . '`');
+				}
+				// Indexes crashed.  Should be easy to fix!
+				elseif ($query_errno == 1034 || $query_errno == 1035)
+				{
+					preg_match('~\'([^\']+?)\'~', $query_error, $match);
+					$fix_tables = array('`' . $match[1] . '`');
+				}
+			}
+
+			// Check for errors like 145... only fix it once every three days, and send an email. (can't use empty because it might not be set yet...)
+			if (!empty($fix_tables))
+			{
+				// Subs-Admin.php for updateSettingsFile(), Subs-Post.php for sendmail().
+				require_once($sourcedir . '/Subs-Admin.php');
+				require_once($sourcedir . '/Subs-Post.php');
+
+				// Make a note of the REPAIR...
+				cache_put_data('db_last_error', time(), 600);
+				if (($temp = cache_get_data('db_last_error', 600)) === null)
+					updateSettingsFile(array('db_last_error' => time()));
+
+				// Attempt to find and repair the broken table.
+				foreach ($fix_tables as $table)
+					$smcFunc['db_query']('', "
+						REPAIR TABLE $table", false, false);
+
+				// And send off an email!
+				sendmail($webmaster_email, $txt['database_error'], $txt['tried_to_repair']);
+
+				$modSettings['cache_enable'] = $old_cache;
+
+				// Try the query again...?
+				$ret = $smcFunc['db_query']('', $db_string, false, false);
+				if ($ret !== false)
+					return $ret;
+			}
+			else
+				$modSettings['cache_enable'] = $old_cache;
+
+			// Check for the "lost connection" or "deadlock found" errors - and try it just one more time.
+			if (in_array($query_errno, array(1205, 1213, 2006, 2013)))
+			{
+				if (in_array($query_errno, array(2006, 2013)) && $db_connection == $connection)
+				{
+					// Are we in SSI mode?  If so try that username and password first
+					if (SMF == 'SSI' && !empty($ssi_db_user) && !empty($ssi_db_passwd))
+					{
+						if (empty($db_persist))
+							$db_connection = @mysqli_connect($db_server, $ssi_db_user, $ssi_db_passwd);
+						else
+							$db_connection = @mysqli_connect('p:' . $db_server, $ssi_db_user, $ssi_db_passwd);
+					}
+					// Fall back to the regular username and password if need be
+					if (!$db_connection)
+					{
+						if (empty($db_persist))
+							$db_connection = @mysqli_connect($db_server, $db_user, $db_passwd);
+						else
+							$db_connection = @mysqli_connect('p:' . $db_server, $db_user, $db_passwd);
+					}
+
+					if (!$db_connection || !@mysqli_select_db($db_connection, $db_name))
+						$db_connection = false;
+				}
+
+				if ($db_connection)
+				{
+					// Try a deadlock more than once more.
+					for ($n = 0; $n < 4; $n++)
+					{
+						$ret = $smcFunc['db_query']('', $db_string, false, false);
+
+						$new_errno = mysqli_errno($db_connection);
+						if ($ret !== false || in_array($new_errno, array(1205, 1213)))
+							break;
+					}
+
+					// If it failed again, shucks to be you... we're not trying it over and over.
+					if ($ret !== false)
+						return $ret;
+				}
+			}
+			// Are they out of space, perhaps?
+			elseif ($query_errno == 1030 && (strpos($query_error, ' -1 ') !== false || strpos($query_error, ' 28 ') !== false || strpos($query_error, ' 12 ') !== false))
+			{
+				if (!isset($txt))
+					$query_error .= ' - check database storage space.';
+				else
+				{
+					if (!isset($txt['mysql_error_space']))
+						loadLanguage('Errors');
+
+					$query_error .= !isset($txt['mysql_error_space']) ? ' - check database storage space.' : $txt['mysql_error_space'];
+				}
+			}
+		}
+
+		// Nothing's defined yet... just die with it.
+		if (empty($context) || empty($txt))
+			die($query_error);
+
+		// Show an error message, if possible.
+		$context['error_title'] = $txt['database_error'];
+		if (allowedTo('admin_forum'))
+			$context['error_message'] = nl2br($query_error) . '<br />' . $txt['file'] . ': ' . $file . '<br />' . $txt['line'] . ': ' . $line;
+		else
+			$context['error_message'] = $txt['try_again'];
+
+		// A database error is often the sign of a database in need of upgrade.  Check forum versions, and if not identical suggest an upgrade... (not for Demo/CVS versions!)
+		if (allowedTo('admin_forum') && !empty($forum_version) && $forum_version != 'SMF ' . @$modSettings['smfVersion'] && strpos($forum_version, 'Demo') === false && strpos($forum_version, 'CVS') === false)
+			$context['error_message'] .= '<br /><br />' . sprintf($txt['database_error_versions'], $forum_version, $modSettings['smfVersion']);
+
+		if (allowedTo('admin_forum') && isset($db_show_debug) && $db_show_debug === true)
+		{
+			$context['error_message'] .= '<br /><br />' . nl2br($db_string);
+		}
+
+		// It's already been logged... don't log it again.
+		fatal_error($context['error_message'], false);
+	}
+
+	/**
+	 * insert
+	 *
+	 * @param string $method - options 'replace', 'ignore', 'insert'
+	 * @param $table
+	 * @param $columns
+	 * @param $data
+	 * @param $keys
+	 * @param bool $disable_trans = false
+	 * @param object $connection = null
+	 */
+	public function insert($method, $table, $columns, $data, $keys, $disable_trans = false, $connection = null)
+	{
+		global $smcFunc, $db_connection, $db_prefix;
+
+		$connection = $connection === null ? $db_connection : $connection;
+
+		// With nothing to insert, simply return.
+		if (empty($data))
+			return;
+
+		// Replace the prefix holder with the actual prefix.
+		$table = str_replace('{db_prefix}', $db_prefix, $table);
+
+		// Inserting data as a single row can be done as a single array.
+		if (!is_array($data[array_rand($data)]))
+			$data = array($data);
+
+		// Create the mold for a single row insert.
+		$insertData = '(';
+		foreach ($columns as $columnName => $type)
+		{
+			// Are we restricting the length?
+			if (strpos($type, 'string-') !== false)
+				$insertData .= sprintf('SUBSTRING({string:%1$s}, 1, ' . substr($type, 7) . '), ', $columnName);
+			else
+				$insertData .= sprintf('{%1$s:%2$s}, ', $type, $columnName);
+		}
+		$insertData = substr($insertData, 0, -2) . ')';
+
+		// Create an array consisting of only the columns.
+		$indexed_columns = array_keys($columns);
+
+		// Here's where the variables are injected to the query.
+		$insertRows = array();
+		foreach ($data as $dataRow)
+			$insertRows[] = $this->quote($insertData, array_combine($indexed_columns, $dataRow), $connection);
+
+		// Determine the method of insertion.
+		$queryTitle = $method == 'replace' ? 'REPLACE' : ($method == 'ignore' ? 'INSERT IGNORE' : 'INSERT');
+
+		// Do the insert.
+		$smcFunc['db_query']('', '
+			' . $queryTitle . ' INTO ' . $table . '(`' . implode('`, `', $indexed_columns) . '`)
+			VALUES
+				' . implode(',
+				', $insertRows),
+			array(
+				'security_override' => true,
+				'db_error_skip' => $table === $db_prefix . 'log_errors',
+			),
+			$connection
+		);
+	}
+
+	/**
+	 * This function tries to work out additional error information from a back trace.
+	 *
+	 * @param $error_message
+	 * @param $log_message
+	 * @param $error_type
+	 * @param $file
+	 * @param $line
+	 */
+	private function error_backtrace($error_message, $log_message = '', $error_type = false, $file = null, $line = null)
+	{
+		if (empty($log_message))
+			$log_message = $error_message;
+
+		foreach (debug_backtrace() as $step)
+		{
+			// Found it?
+			if (!method_exists($this, $step['function']) && strpos($step['function'], 'query') === false && !in_array(substr($step['function'], 0, 7), array('smf_db_', 'preg_re', 'db_erro', 'call_us')) && strpos($step['function'], '__') !== 0)
+			{
+				$log_message .= '<br />Function: ' . $step['function'];
+				break;
+			}
+
+			if (isset($step['line']))
+			{
+				$file = $step['file'];
+				$line = $step['line'];
+			}
+		}
+
+		// A special case - we want the file and line numbers for debugging.
+		if ($error_type == 'return')
+			return array($file, $line);
+
+		// Is always a critical error.
+		if (function_exists('log_error'))
+			log_error($log_message, 'critical', $file, $line);
+
+		if (function_exists('fatal_error'))
+		{
+			fatal_error($error_message, false);
+
+			// Cannot continue...
+			exit;
+		}
+		elseif ($error_type)
+			trigger_error($error_message . ($line !== null ? '<em>(' . basename($file) . '-' . $line . ')</em>' : ''), $error_type);
+		else
+			trigger_error($error_message . ($line !== null ? '<em>(' . basename($file) . '-' . $line . ')</em>' : ''));
+	}
+
+	/**
+	 * Escape the LIKE wildcards so that they match the character and not the wildcard.
+	 *
+	 * @param $string
+	 * @param bool $translate_human_wildcards = false, if true, turns human readable wildcards into SQL wildcards.
+	 */
+	public function escape_wildcard_string($string, $translate_human_wildcards=false)
+	{
+		$replacements = array(
+			'%' => '\%',
+			'_' => '\_',
+			'\\' => '\\\\',
+		);
+
+		if ($translate_human_wildcards)
+			$replacements += array(
+				'*' => '%',
+			);
+
+		return strtr($string, $replacements);
+	}
+}
+
+
 ?>
\ No newline at end of file
diff --git a/Sources/Subs-Db-postgresql.php b/Sources/Subs-Db-postgresql.php
index 5591ed3..8e72eed 100644
--- a/Sources/Subs-Db-postgresql.php
+++ b/Sources/Subs-Db-postgresql.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.4
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -50,6 +50,8 @@ function smf_db_initiate($db_server, $db_name, $db_user, $db_passwd, &$db_prefix
 			'db_sybase' => true,
 			'db_case_sensitive' => true,
 			'db_escape_wildcard_string' => 'smf_db_escape_wildcard_string',
+			'db_connect_error' => 'smf_db_connect_error',
+			'db_connect_errno' => 'smf_db_connect_errno',
 		);
 
 	if (!empty($db_options['persist']))
@@ -389,7 +391,7 @@ function smf_db_query($identifier, $db_string, $db_values = array(), $connection
 				$pos2 = strpos($db_string, '\\', $pos + 1);
 				if ($pos1 === false)
 					break;
-				elseif ($pos2 == false || $pos2 > $pos1)
+				elseif ($pos2 === false || $pos2 > $pos1)
 				{
 					$pos = $pos1;
 					break;
@@ -581,7 +583,7 @@ function smf_db_unescape_string($string)
 }
 
 // For inserting data in a special way...
-function smf_db_insert($method = 'replace', $table, $columns, $data, $keys, $disable_trans = false, $connection = null)
+function smf_db_insert($method, $table, $columns, $data, $keys, $disable_trans = false, $connection = null)
 {
 	global $db_replace_result, $db_in_transact, $smcFunc, $db_connection, $db_prefix;
 
@@ -754,4 +756,26 @@ function smf_db_escape_wildcard_string($string, $translate_human_wildcards=false
 	return strtr($string, $replacements);
 }
 
+/**
+ * Function to emulate mysqli_connect_error.
+ * Since pg doesn't have such a function, just return an empty string.
+ *
+ * @return string connection error message
+ */
+function smf_db_connect_error()
+{
+	return '';
+}
+
+/**
+ * Function to emulate mysqli_connect_errno.
+ * Since pg doesn't have such a function, just return an empty string.
+ *
+ * @return string connection error number
+ */
+function smf_db_connect_errno()
+{
+	return '';
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/Subs-Db-sqlite.php b/Sources/Subs-Db-sqlite.php
index 99bb9b4..e0657e8 100644
--- a/Sources/Subs-Db-sqlite.php
+++ b/Sources/Subs-Db-sqlite.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -494,7 +494,7 @@ function smf_db_error($db_string, $connection = null)
 }
 
 // Insert some data...
-function smf_db_insert($method = 'replace', $table, $columns, $data, $keys, $disable_trans = false, $connection = null)
+function smf_db_insert($method, $table, $columns, $data, $keys, $disable_trans = false, $connection = null)
 {
 	global $db_in_transact, $db_connection, $smcFunc, $db_prefix;
 
@@ -710,8 +710,9 @@ function smf_udf_locate($find, $string)
 // This is used to replace RLIKE.
 function smf_udf_regexp($exp, $search)
 {
-	if (preg_match($exp, $match))
+	if (preg_match($exp, $search))
 		return 1;
+
 	return 0;
 }
 
diff --git a/Sources/Subs-Editor.php b/Sources/Subs-Editor.php
index 2cfa4f0..8f6ddb4 100644
--- a/Sources/Subs-Editor.php
+++ b/Sources/Subs-Editor.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.11
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -897,7 +897,7 @@ function fetchTagAttributes($text)
 	for ($i = 0; $i < strlen($text); $i++)
 	{
 		// We're either moving from the key to the attribute or we're in a string and this is fine.
-		if ($text{$i} == '=')
+		if ($text[$i] == '=')
 		{
 			if ($tag_state == 0)
 				$tag_state = 1;
@@ -905,7 +905,7 @@ function fetchTagAttributes($text)
 				$value .= '=';
 		}
 		// A space is either moving from an attribute back to a potential key or in a string is fine.
-		elseif ($text{$i} == ' ')
+		elseif ($text[$i] == ' ')
 		{
 			if ($tag_state == 2)
 				$value .= ' ';
@@ -917,7 +917,7 @@ function fetchTagAttributes($text)
 			}
 		}
 		// A quote?
-		elseif ($text{$i} == '"')
+		elseif ($text[$i] == '"')
 		{
 			// Must be either going into or out of a string.
 			if ($tag_state == 1)
@@ -929,9 +929,9 @@ function fetchTagAttributes($text)
 		else
 		{
 			if ($tag_state == 0)
-				$key .= $text{$i};
+				$key .= $text[$i];
 			else
-				$value .= $text{$i};
+				$value .= $text[$i];
 		}
 	}
 
diff --git a/Sources/Subs-Graphics.php b/Sources/Subs-Graphics.php
index 6ab1be2..4ce1b69 100644
--- a/Sources/Subs-Graphics.php
+++ b/Sources/Subs-Graphics.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.19
  */
 
 // TrueType fonts supplied by www.LarabieFonts.com
@@ -269,8 +269,9 @@ function checkImageContents($fileName, $extensiveCheck = false)
 		// Though not exhaustive lists, better safe than sorry.
 		if (!empty($extensiveCheck))
 		{
-			// Paranoid check. Some like it that way.
-			if (preg_match('~(iframe|\\<\\?|\\<%|html|eval|body|script\W|[CF]WS[\x01-\x0C])~i', $prev_chunk . $cur_chunk) === 1)
+			// Paranoid check.  Use this if you have reason to distrust your host's security config.
+			// Will result in MANY false positives, and is not suitable for photography sites.
+			if (preg_match('~(iframe|\\<\\?|\\<%|html|eval|body|script\W|(?-i)[CFZ]WS[\x01-\x0E])~i', $prev_chunk . $cur_chunk) === 1)
 			{
 				fclose($fp);
 				return false;
@@ -278,8 +279,9 @@ function checkImageContents($fileName, $extensiveCheck = false)
 		}
 		else
 		{
-			// Check for potential infection
-			if (preg_match('~(iframe|(?<!cellTextIs)html|eval|body|script\W|[CF]WS[\x01-\x0C])~i', $prev_chunk . $cur_chunk) === 1)
+			// Check for potential infection - focus on clues for inline php & flash.
+			// Will result in significantly fewer false positives than the paranoid check.
+			if (preg_match('~(\\<\\?php\s|(?-i)[CFZ]WS[\x01-\x0E])~i', $prev_chunk . $cur_chunk) === 1)
 			{
 				fclose($fp);
 				return false;
@@ -333,6 +335,10 @@ function resizeImageFile($source, $destination, $max_width, $max_height, $prefer
 	{
 		$fileContents = fetch_web_data($source);
 
+		$mime_valid = check_mime_type($fileContents, implode('|', array_map('image_type_to_mime_type', array_keys($default_formats))));
+		if (empty($mime_valid))
+			return false;
+
 		fwrite($fp_destination, $fileContents);
 		fclose($fp_destination);
 
@@ -340,6 +346,10 @@ function resizeImageFile($source, $destination, $max_width, $max_height, $prefer
 	}
 	elseif ($fp_destination)
 	{
+		$mime_valid = check_mime_type($source, implode('|', array_map('image_type_to_mime_type', array_keys($default_formats))), true);
+		if (empty($mime_valid))
+			return false;
+
 		$sizes = @getimagesize($source);
 
 		$fp_source = fopen($source, 'rb');
@@ -354,7 +364,7 @@ function resizeImageFile($source, $destination, $max_width, $max_height, $prefer
 		fclose($fp_destination);
 	}
 	// We can't get to the file.
-	else
+	if (empty($sizes))
 		$sizes = array(-1, -1, -1);
 
 	// Gif? That might mean trouble if gif support is not available.
@@ -527,9 +537,9 @@ if (!function_exists('imagecreatefrombmp'))
 		$n = 0;
 		for ($j = 0; $j < $palette_size; $j++)
 		{
-			$b = ord($palettedata{$j++});
-			$g = ord($palettedata{$j++});
-			$r = ord($palettedata{$j++});
+			$b = ord($palettedata[$j++]);
+			$g = ord($palettedata[$j++]);
+			$r = ord($palettedata[$j++]);
 
 			$palette[$n++] = imagecolorallocate($dst_img, $r, $g, $b);
 		}
@@ -550,9 +560,9 @@ if (!function_exists('imagecreatefrombmp'))
 				$x = 0;
 				for ($j = 0; $j < $scan_line_size; $x++)
 				{
-					$b = ord($scan_line{$j++});
-					$g = ord($scan_line{$j++});
-					$r = ord($scan_line{$j++});
+					$b = ord($scan_line[$j++]);
+					$g = ord($scan_line[$j++]);
+					$r = ord($scan_line[$j++]);
 					$j++;
 
 					$color = imagecolorexact($dst_img, $r, $g, $b);
@@ -573,9 +583,9 @@ if (!function_exists('imagecreatefrombmp'))
 				$x = 0;
 				for ($j = 0; $j < $scan_line_size; $x++)
 				{
-					$b = ord($scan_line{$j++});
-					$g = ord($scan_line{$j++});
-					$r = ord($scan_line{$j++});
+					$b = ord($scan_line[$j++]);
+					$g = ord($scan_line[$j++]);
+					$r = ord($scan_line[$j++]);
 
 					$color = imagecolorexact($dst_img, $r, $g, $b);
 					if ($color == -1)
@@ -595,8 +605,8 @@ if (!function_exists('imagecreatefrombmp'))
 				$x = 0;
 				for ($j = 0; $j < $scan_line_size; $x++)
 				{
-					$b1 = ord($scan_line{$j++});
-					$b2 = ord($scan_line{$j++});
+					$b1 = ord($scan_line[$j++]);
+					$b2 = ord($scan_line[$j++]);
 
 					$word = $b2 * 256 + $b1;
 
@@ -622,14 +632,14 @@ if (!function_exists('imagecreatefrombmp'))
 			{
 				$x = 0;
 				for ($j = 0; $j < $scan_line_size; $x++)
-					imagesetpixel($dst_img, $x, $y, $palette[ord($scan_line{$j++})]);
+					imagesetpixel($dst_img, $x, $y, $palette[ord($scan_line[$j++])]);
 			}
 			elseif ($info['bits'] == 4)
 			{
 				$x = 0;
 				for ($j = 0; $j < $scan_line_size; $x++)
 				{
-					$byte = ord($scan_line{$j++});
+					$byte = ord($scan_line[$j++]);
 
 					imagesetpixel($dst_img, $x, $y, $palette[(int) ($byte / 16)]);
 					if (++$x < $info['width'])
@@ -786,7 +796,7 @@ function showCodeImage($code)
 	for ($i = 0; $i < strlen($code); $i++)
 	{
 		$characters[$i] = array(
-			'id' => $code{$i},
+			'id' => $code[$i],
 			'font' => array_rand($font_list),
 		);
 
diff --git a/Sources/Subs-Members.php b/Sources/Subs-Members.php
index da12573..838f6be 100644
--- a/Sources/Subs-Members.php
+++ b/Sources/Subs-Members.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -516,7 +516,7 @@ function registerMember(&$regOptions, $return_errors = false)
 		$reg_errors[] = array('lang', 'username_reserved', 'general', array($txt['guest_title']));
 
 	// !!! Separate the sprintf?
-	if (empty($regOptions['email']) || preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,15})$~', $regOptions['email']) === 0 || strlen($regOptions['email']) > 255)
+	if (empty($regOptions['email']) || filter_var($regOptions['email'], FILTER_VALIDATE_EMAIL) === false || strlen($regOptions['email']) > 255)
 		$reg_errors[] = array('lang', 'profile_error_bad_email');
 
 	if (!empty($regOptions['check_reserved_name']) && isReservedName($regOptions['username'], 0, false))
@@ -792,6 +792,18 @@ function registerMember(&$regOptions, $return_errors = false)
 		);
 	}
 
+	// Since they're not a user yet, user_info is incomplete, which breaks logging.
+	// Fill in enough gaps for logging to be successful.
+	if (empty($user_info['id']))
+		$user_info['id'] = $memberID;
+	if (empty($user_info['username']))
+		$user_info['username'] = $regOptions['username'];
+
+	// Log their acceptance of the agreement and privacy policy, for future reference.
+	foreach (array('agreement_accepted', 'policy_accepted') as $key)
+		if (!empty($theme_vars[$key]))
+			logAction($key, array('applicator' => $memberID), 'user');
+
 	// If it's enabled, increase the registrations for today.
 	trackStats(array('registers' => '+'));
 
@@ -900,12 +912,17 @@ function isReservedName($name, $current_ID_MEMBER = 0, $is_name = true, $fatal =
 	global $user_info, $modSettings, $smcFunc, $context;
 
 	// No cheating with entities please.
-	$replaceEntities = create_function('$string', '
-		$num = substr($string, 0, 1) === \'x\' ? hexdec(substr($string, 1)) : (int) $string;
-		if ($num === 0x202E || $num === 0x202D) return \'\'; if (in_array($num, array(0x22, 0x26, 0x27, 0x3C, 0x3E))) return \'&#\' . $num . \';\';' .
-		(empty($context['utf8']) ? 'return $num < 0x20 ? \'\' : ($num < 0x80 ? chr($num) : \'&#\' . $string . \';\');' : '
-		return $num < 0x20 || $num > 0x10FFFF || ($num >= 0xD800 && $num <= 0xDFFF) ? \'\' : ($num < 0x80 ? chr($num) : ($num < 0x800 ? chr(192 | $num >> 6) . chr(128 | $num & 63) : ($num < 0x10000 ? chr(224 | $num >> 12) . chr(128 | $num >> 6 & 63) . chr(128 | $num & 63) : chr(240 | $num >> 18) . chr(128 | $num >> 12 & 63) . chr(128 | $num >> 6 & 63) . chr(128 | $num & 63))));')
-	);
+	$replaceEntities = function($string) use ($context)
+	{
+		$num = substr($string, 0, 1) === 'x' ? hexdec(substr($string, 1)) : (int) $string;
+		if ($num === 0x202E || $num === 0x202D)
+			return '';
+		if (in_array($num, array(0x22, 0x26, 0x27, 0x3C, 0x3E)))
+			return '&#' . $num . ';';
+		if (empty($context['utf8']))
+			return $num < 0x20 ? '' : ($num < 0x80 ? chr($num) : '&#' . $string . ';');
+		return $num < 0x20 || $num > 0x10FFFF || ($num >= 0xD800 && $num <= 0xDFFF) ? '' : ($num < 0x80 ? chr($num) : ($num < 0x800 ? chr(192 | $num >> 6) . chr(128 | $num & 63) : ($num < 0x10000 ? chr(224 | $num >> 12) . chr(128 | $num >> 6 & 63) . chr(128 | $num & 63) : chr(240 | $num >> 18) . chr(128 | $num >> 12 & 63) . chr(128 | $num >> 6 & 63) . chr(128 | $num & 63))));
+	};
 
 	$name = preg_replace_callback('~(&#(\d{1,7}|x[0-9a-fA-F]{1,6});)~', 'replaceEntities__callback', $name);
 	$checkName = $smcFunc['strtolower']($name);
diff --git a/Sources/Subs-Package.php b/Sources/Subs-Package.php
index aaef19e..bb15d6b 100644
--- a/Sources/Subs-Package.php
+++ b/Sources/Subs-Package.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.10
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -227,14 +227,14 @@ function read_tgz_data($data, $destination, $single_file = false, $overwrite = f
 	$flags = $flags['f'];
 
 	$offset = 10;
-	$octdec = array('mode', 'uid', 'gid', 'size', 'mtime', 'checksum', 'type');
+	$octdec = array('mode', 'uid', 'gid', 'size', 'mtime', 'checksum');
 
 	// "Read" the filename and comment. // !!! Might be mussed.
 	if ($flags & 12)
 	{
-		while ($flags & 8 && $data{$offset++} != "\0")
+		while ($flags & 8 && $data[$offset++] != "\0")
 			continue;
-		while ($flags & 4 && $data{$offset++} != "\0")
+		while ($flags & 4 && $data[$offset++] != "\0")
 			continue;
 	}
 
@@ -270,14 +270,14 @@ function read_tgz_data($data, $destination, $single_file = false, $overwrite = f
 				$current[$k] = trim($v);
 		}
 
-		if ($current['type'] == 5 && substr($current['filename'], -1) != '/')
+		if ($current['type'] == '5' && substr($current['filename'], -1) != '/')
 			$current['filename'] .= '/';
 
 		$checksum = 256;
 		for ($i = 0; $i < 148; $i++)
-			$checksum += ord($header{$i});
+			$checksum += ord($header[$i]);
 		for ($i = 156; $i < 512; $i++)
-			$checksum += ord($header{$i});
+			$checksum += ord($header[$i]);
 
 		if ($current['checksum'] != $checksum)
 			break;
@@ -536,7 +536,7 @@ function getPackageInfo($gzfilename)
 	global $boarddir;
 
 	// Extract package-info.xml from downloaded file. (*/ is used because it could be in any directory.)
-	if (strpos($gzfilename, 'http://') !== false)
+	if (strpos($gzfilename, 'http://') !== false || strpos($gzfilename, 'https://') !== false)
 		$packageInfo = read_tgz_data(fetch_web_data($gzfilename, '', true), '*/package-info.xml', true);
 	else
 	{
@@ -567,7 +567,7 @@ function getPackageInfo($gzfilename)
 
 	$package = $packageInfo->to_array();
 	$package = htmlspecialchars__recursive($package);
-	$package['xml'] = $packageInfo;	
+	$package['xml'] = $packageInfo;
 	$package['filename'] = $gzfilename;
 
 	// Don't want to mess with code...
@@ -680,12 +680,11 @@ function create_chmod_control($chmodFiles = array(), $chmodOptions = array(), $r
 						'value' => $txt['package_restore_permissions_cur_status'],
 					),
 					'data' => array(
-						'function' => create_function('$rowData', '
-							global $txt;
-
-							$formatTxt = $rowData[\'result\'] == \'\' || $rowData[\'result\'] == \'skipped\' ? $txt[\'package_restore_permissions_pre_change\'] : $txt[\'package_restore_permissions_post_change\'];
-							return sprintf($formatTxt, $rowData[\'cur_perms\'], $rowData[\'new_perms\'], $rowData[\'writable_message\']);
-						'),
+						'function' => function($rowData) use ($txt)
+						{
+							$formatTxt = $rowData['result'] == '' || $rowData['result'] == 'skipped' ? $txt['package_restore_permissions_pre_change'] : $txt['package_restore_permissions_post_change'];
+							return sprintf($formatTxt, $rowData['cur_perms'], $rowData['new_perms'], $rowData['writable_message']);
+						},
 						'class' => 'smalltext',
 					),
 				),
@@ -708,11 +707,10 @@ function create_chmod_control($chmodFiles = array(), $chmodOptions = array(), $r
 						'value' => $txt['package_restore_permissions_result'],
 					),
 					'data' => array(
-						'function' => create_function('$rowData', '
-							global $txt;
-
-							return $txt[\'package_restore_permissions_action_\' . $rowData[\'result\']];
-						'),
+						'function' => function($rowData) use ($txt)
+						{
+							return $txt['package_restore_permissions_action_' . $rowData['result']];
+						},
 						'class' => 'smalltext',
 					),
 				),
@@ -1504,7 +1502,7 @@ function compareVersions($version1, $version2)
 			'minor' => !empty($parts[2]) ? (int) $parts[2] : 0,
 			'patch' => !empty($parts[3]) ? (int) $parts[3] : 0,
 			'type' => empty($parts[4]) ? 'stable' : $parts[4],
-			'type_major' => !empty($parts[6]) ? (int) $parts[5] : 0,
+			'type_major' => !empty($parts[5]) ? (int) $parts[5] : 0,
 			'type_minor' => !empty($parts[6]) ? (int) $parts[6] : 0,
 			'dev' => !empty($parts[7]),
 		);
@@ -1582,8 +1580,9 @@ function deltree($dir, $delete_dir = true)
 		if ($delete_dir && isset($package_ftp))
 		{
 			$ftp_file = strtr($dir, array($_SESSION['pack_ftp']['root'] => ''));
-			if (!is_writable($dir . '/' . $entryname))
+			if (!is_writable($dir . '/' . $ftp_file))
 				$package_ftp->chmod($ftp_file, 0777);
+
 			$package_ftp->unlink($ftp_file);
 		}
 
@@ -1796,12 +1795,19 @@ function parseModification($file, $testing = true, $undo = false, $theme_paths =
 	// This is needed to hold the long paths, as they can vary...
 	$long_changes = array();
 
+	// Translate everything to unix dir separators for comparisons during parsing
+	foreach ($theme_paths as $id => $theme)
+		$theme_paths[$id]['theme_dir'] = strtr($theme_paths[$id]['theme_dir'], '\\', '/');
+
 	// First, we need to build the list of all the files likely to get changed.
 	foreach ($files as $file)
 	{
 		// What is the filename we're currently on?
 		$filename = parse_path(trim($file->fetch('@name')));
 
+		// Xlate it to unix style for comparisons...
+		$filename = strtr($filename, '\\', '/');
+
 		// Now, we need to work out whether this is even a template file...
 		foreach ($theme_paths as $id => $theme)
 		{
@@ -1850,6 +1856,9 @@ function parseModification($file, $testing = true, $undo = false, $theme_paths =
 			1 => parse_path(trim($file->fetch('@name'))),
 		);
 
+		// Translate to unix dir separators for comparisons during parsing
+		$files_to_change[1] = strtr($files_to_change[1], '\\', '/');
+
 		// Sometimes though, we have some additional files for other themes, if we have add them to the mix.
 		if (isset($custom_themes_add[$files_to_change[1]]))
 			$files_to_change += $custom_themes_add[$files_to_change[1]];
@@ -2704,7 +2713,7 @@ function package_crypt($pass)
 		$salt .= session_id();
 
 	for ($i = 0; $i < $n; $i++)
-		$pass{$i} = chr(ord($pass{$i}) ^ (ord($salt{$i}) - 32));
+		$pass[$i] = chr(ord($pass[$i]) ^ (ord($salt[$i]) - 32));
 
 	return $pass;
 }
@@ -2715,7 +2724,7 @@ function package_create_backup($id = 'backup')
 
 	$files = array();
 
-	$base_files = array('index.php', 'SSI.php', 'agreement.txt', 'ssi_examples.php', 'ssi_examples.shtml');
+	$base_files = array('index.php', 'SSI.php', 'agreement.txt', 'proxy.php', 'ssi_examples.php', 'ssi_examples.shtml', 'subscriptions.php');
 	foreach ($base_files as $file)
 	{
 		if (file_exists($boarddir . '/' . $file))
@@ -2743,11 +2752,8 @@ function package_create_backup($id = 'backup')
 		$dirs[$row['value']] = empty($_REQUEST['use_full_paths']) ? 'Themes/' . basename($row['value']) . '/' : strtr($row['value'] . '/', '\\', '/');
 	$smcFunc['db_free_result']($request);
 
-	while (!empty($dirs))
+	foreach ($dirs as $dir => $dest)
 	{
-		list ($dir, $dest) = each($dirs);
-		unset($dirs[$dir]);
-
 		$listing = @dir($dir);
 		if (!$listing)
 			continue;
@@ -2819,7 +2825,7 @@ function package_create_backup($id = 'backup')
 
 		$checksum = 256;
 		for ($i = 0; $i < 512; $i++)
-			$checksum += ord($current{$i});
+			$checksum += ord($current[$i]);
 
 		$fwrite($output, substr($current, 0, 148) . pack('a8', decoct($checksum)) . substr($current, 156, 511));
 
@@ -2894,8 +2900,22 @@ function fetch_web_data($url, $post_data = '', $keep_alive = false, $redirection
 		$ftp->check_response(226);
 		$ftp->close();
 	}
-// This is more likely; a standard HTTP URL.
+	// More likely a standard HTTP/s URL, first try to use cURL if available
+	elseif (isset($match[1]) && substr($match[1], 0, 4) === 'http' && function_exists('curl_init'))
+	{
+		// Include the file containing the curl_fetch_web_data class.
+		loadClassFile('Class-CurlFetchWeb.php');
+
+		$fetch_data = new curl_fetch_web_data();
+		$fetch_data->get_url_data($url, $post_data);
 
+		// no errors and a 200 result, then we have a good dataset, well we at least have data ;)
+		if ($fetch_data->result('code') == 200 && !$fetch_data->result('error'))
+			$data = $fetch_data->result('body');
+		else
+			return false;
+	}
+	// Fallback to sockets.
 	elseif (isset($match[1]) && $match[1] == 'http')
 	{
 		if ($keep_alive && $match[3] == $keep_alive_dom)
@@ -3022,4 +3042,46 @@ if (!function_exists('smf_crc32'))
 	}
 }
 
-?>
\ No newline at end of file
+// Checks whether a file or data retrieved by fetch_web_data has the expected MIME type.
+// Returns 1 if the detected MIME type matches the pattern, 0 if it doesn't, or 2 if we can't check.
+function check_mime_type($data, $type_pattern, $is_path = false)
+{
+	// On Windows, the Fileinfo extension may not be enabled by default.
+	if (!extension_loaded('fileinfo'))
+	{
+		// Maybe we can load it dynamically?
+		$loaded = false;
+		$safe = ini_get('safe_mode');
+		$dl_ok = ini_get('enable_dl');
+		if (empty($safe) && !empty($dl_ok) && function_exists('dl'))
+			$loaded = @dl(((PHP_SHLIB_SUFFIX === 'dll') ? 'php_' : '') . 'fileinfo.' . PHP_SHLIB_SUFFIX);
+
+		// Oh well. We tried.
+		if (!$loaded)
+			return 2;
+	}
+
+	// Just some nice, simple data to analyze.
+	if (empty($is_path))
+		$mime_type = finfo_buffer(finfo_open(FILEINFO_MIME), $data);
+
+	// A file, or maybe a URL?
+	else
+	{
+		// Local file.
+		if (file_exists($data))
+			$mime_type = mime_content_type($data);
+
+		// URL.
+		elseif (url_exists($data))
+			$mime_type = finfo_buffer(finfo_open(FILEINFO_MIME), fetch_web_data($data));
+
+		// Non-existent files obviously don't have the right MIME type.
+		else
+			return 0;
+	}
+
+	return (int) @preg_match('~' . $type_pattern . '~', $mime_type);
+}
+
+?>
diff --git a/Sources/Subs-Post.php b/Sources/Subs-Post.php
index 63e9acf..5a2647b 100644
--- a/Sources/Subs-Post.php
+++ b/Sources/Subs-Post.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.13
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -236,7 +236,10 @@ function preparsecode(&$message, $previewing = false)
 				{
 					static $htmlfunc = null;
 					if ($htmlfunc === null)
-						$htmlfunc = create_function('$m', 'return \'[html]\' . strtr(un_htmlspecialchars("$m[1]"), array("\n" => \'&#13;\', \'  \' => \' &#32;\', \'[\' => \'&#91;\', \']\' => \'&#93;\')) . \'[/html]\';');
+						$htmlfunc = function($m)
+						{
+							return '[html]' . strtr(un_htmlspecialchars("$m[1]"), array("\n" => '&#13;', '  ' => ' &#32;', '[' => '&#91;', ']' => '&#93;')) . '[/html]';
+						};
 					$parts[$i] = preg_replace_callback('~\[html\](.+?)\[/html\]~is', $htmlfunc, $parts[$i]);
 				}
 
@@ -1248,7 +1251,8 @@ function mimespecialchars($string, $with_charset = true, $hotmail_fix = false, $
 					$string = $newstring;
 			}
 
-			$fixchar = create_function('$n', '
+			$fixchar = function($n)
+			{
 				if ($n < 128)
 					return chr($n);
 				elseif ($n < 2048)
@@ -1256,7 +1260,8 @@ function mimespecialchars($string, $with_charset = true, $hotmail_fix = false, $
 				elseif ($n < 65536)
 					return chr(224 | $n >> 12) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);
 				else
-					return chr(240 | $n >> 18) . chr(128 | $n >> 12 & 63) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);');
+					return chr(240 | $n >> 18) . chr(128 | $n >> 12 & 63) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);
+			};
 
 			$string = preg_replace_callback('~&#(\d{3,8});~', 'fixchar__callback', $string);
 
@@ -1350,12 +1355,21 @@ function smtp_mail($mail_to_array, $subject, $message, $headers)
 	if (!server_parse(null, $socket, '220'))
 		return false;
 
+	// Start off by using the stored mail server.
+	$helo = $modSettings['smtp_host'];
+
+	// Try and determine this server's name.
+	if (function_exists('gethostname') && gethostname() !== false)
+		$helo = gethostname();
+	elseif (function_exists('php_uname'))
+		$helo = php_uname('n');
+	elseif (!empty($_SERVER['SERVER_NAME']))
+		$helo = $_SERVER['SERVER_NAME'];
+
 	if ($modSettings['mail_type'] == 1 && $modSettings['smtp_username'] != '' && $modSettings['smtp_password'] != '')
 	{
-		// !!! These should send the CURRENT server's name, not the mail server's!
-
 		// EHLO could be understood to mean encrypted hello...
-		if (server_parse('EHLO ' . $modSettings['smtp_host'], $socket, null) == '250')
+		if (server_parse('EHLO ' . $helo, $socket, null) == '250')
 		{
 			if (!server_parse('AUTH LOGIN', $socket, '334'))
 				return false;
@@ -1366,13 +1380,13 @@ function smtp_mail($mail_to_array, $subject, $message, $headers)
 			if (!server_parse($modSettings['smtp_password'], $socket, '235'))
 				return false;
 		}
-		elseif (!server_parse('HELO ' . $modSettings['smtp_host'], $socket, '250'))
+		elseif (!server_parse('HELO ' . $helo, $socket, '250'))
 			return false;
 	}
 	else
 	{
 		// Just say "helo".
-		if (!server_parse('HELO ' . $modSettings['smtp_host'], $socket, '250'))
+		if (!server_parse('HELO ' . $helo, $socket, '250'))
 			return false;
 	}
 
@@ -1432,6 +1446,8 @@ function server_parse($message, $socket, $response)
 	while (substr($server_response, 3, 1) != ' ')
 		if (!($server_response = fgets($socket, 256)))
 		{
+			loadLanguage('index');
+
 			// !!! Change this message to reflect that it may mean bad user/password/server issues/etc.
 			log_error($txt['smtp_bad_response']);
 			return false;
@@ -1442,6 +1458,8 @@ function server_parse($message, $socket, $response)
 
 	if (substr($server_response, 0, 3) != $response)
 	{
+		loadLanguage('index');
+
 		log_error($txt['smtp_error'] . $server_response);
 		return false;
 	}
@@ -1667,6 +1685,15 @@ function sendNotifications($topics, $type, $exclude = array(), $members_only = a
 			'UNSUBSCRIBELINK' => $scripturl . '?action=notify;topic=' . $row['id_topic'] . '.0',
 		);
 
+		// Make a token for the unsubscribe link
+		if (!empty($modSettings['notify_tokens']))
+		{
+			require_once($sourcedir . '/Notify.php');
+			$token = createUnsubscribeToken($row['id_member'], $row['email_address'], 'topic', $row['id_topic']);
+
+			$replacements['UNSUBSCRIBELINK'] .= ';u=' . $row['id_member'] . ';token=' . $token;
+		}
+
 		if ($type == 'remove')
 			unset($replacements['TOPICLINK'], $replacements['UNSUBSCRIBELINK']);
 		// Do they want the body of the message sent too?
@@ -2113,7 +2140,7 @@ function createAttachment(&$attachmentOptions)
 			if (!empty($size['mime']))
 				$attachmentOptions['mime_type'] = $size['mime'];
 			// Otherwise a valid one?
-			elseif (isset($validImageTypes[$size[2]]))
+			elseif (!empty($size[2]) && isset($validImageTypes[$size[2]]))
 				$attachmentOptions['mime_type'] = 'image/' . $validImageTypes[$size[2]];
 		}
 	}
@@ -2268,7 +2295,7 @@ function createAttachment(&$attachmentOptions)
 		{
 			if (!empty($size['mime']))
 				$attachmentOptions['mime_type'] = $size['mime'];
-			elseif (isset($validImageTypes[$size[2]]))
+			elseif (!empty($size[2]) && isset($validImageTypes[$size[2]]))
 				$attachmentOptions['mime_type'] = 'image/' . $validImageTypes[$size[2]];
 		}
 
@@ -2299,7 +2326,7 @@ function createAttachment(&$attachmentOptions)
 
 	// Security checks for images
 	// Do we have an image? If yes, we need to check it out!
-	if (isset($validImageTypes[$size[2]]))
+	if (!empty($size[2]) && isset($validImageTypes[$size[2]]))
 	{
 		if (!checkImageContents($attachmentOptions['destination'], !empty($modSettings['attachment_image_paranoid'])))
 		{
@@ -2325,7 +2352,7 @@ function createAttachment(&$attachmentOptions)
 				// Let's update the image information
 				// !!! This is becoming a mess: we keep coming back and update the database,
 				//  instead of getting it right the first time.
-				if (isset($validImageTypes[$size[2]]))
+				if (!empty($size[2]) && isset($validImageTypes[$size[2]]))
 				{
 					$attachmentOptions['mime_type'] = 'image/' . $validImageTypes[$size[2]];
 					$smcFunc['db_query']('', '
@@ -2357,7 +2384,7 @@ function createAttachment(&$attachmentOptions)
 
 			if (!empty($size['mime']))
 				$thumb_mime = $size['mime'];
-			elseif (isset($validImageTypes[$size[2]]))
+			elseif (!empty($size[2]) && isset($validImageTypes[$size[2]]))
 				$thumb_mime = 'image/' . $validImageTypes[$size[2]];
 			// Lord only knows how this happened...
 			else
@@ -2924,6 +2951,15 @@ function sendApprovalNotifications(&$topicData)
 				'UNSUBSCRIBELINK' => $scripturl . '?action=notify;topic=' . $row['id_topic'] . '.0',
 			);
 
+			// Make a token for the unsubscribe link
+			if (!empty($modSettings['notify_tokens']))
+			{
+				require_once($sourcedir . '/Notify.php');
+				$token = createUnsubscribeToken($row['id_member'], $row['email_address'], 'topic', $row['id_topic']);
+
+				$replacements['UNSUBSCRIBELINK'] .= ';u=' . $row['id_member'] . ';token=' . $token;
+			}
+
 			$message_type = 'notification_reply';
 			// Do they want the body of the message sent too?
 			if (!empty($row['notify_send_body']) && empty($modSettings['disallow_sendBody']))
diff --git a/Sources/Subs-Sound.php b/Sources/Subs-Sound.php
index a71a436..6323cbf 100644
--- a/Sources/Subs-Sound.php
+++ b/Sources/Subs-Sound.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -36,7 +36,8 @@ function createWaveFile($word)
 	cache_put_data('wave_file/' . $user_info['ip2'], $ip2 ? $ip2 + 1 : 1, 20);
 
 	// Fixate randomization for this word.
-	mt_srand(end(unpack('n', md5($word . session_id()))));
+	$unpacked = unpack('n', md5($word . session_id()));
+	mt_srand(end($unpacked));
 
 	// Try to see if there's a sound font in the user's language.
 	if (file_exists($settings['default_theme_dir'] . '/fonts/sound/a.' . $user_info['language'] . '.wav'))
@@ -57,23 +58,23 @@ function createWaveFile($word)
 	$sound_word = '';
 	for ($i = 0; $i < strlen($word); $i++)
 	{
-		$sound_letter = implode('', file($settings['default_theme_dir'] . '/fonts/sound/' . $word{$i} . '.' . $sound_language . '.wav'));
+		$sound_letter = implode('', file($settings['default_theme_dir'] . '/fonts/sound/' . $word[$i] . '.' . $sound_language . '.wav'));
 		if (strpos($sound_letter, 'data') === false)
 			return false;
 
 		$sound_letter = substr($sound_letter, strpos($sound_letter, 'data') + 8);
-		switch ($word{$i} === 's' ? 0 : mt_rand(0, 2))
+		switch ($word[$i] === 's' ? 0 : mt_rand(0, 2))
 		{
 			case 0:
 				for ($j = 0, $n = strlen($sound_letter); $j < $n; $j++)
 					for ($k = 0, $m = round(mt_rand(15, 25) / 10); $k < $m; $k++)
-						$sound_word .= $word{$i} === 's' ? $sound_letter{$j} : chr(mt_rand(max(ord($sound_letter{$j}) - 1, 0x00), min(ord($sound_letter{$j}) + 1, 0xFF)));
+						$sound_word .= $word[$i] === 's' ? $sound_letter[$j] : chr(mt_rand(max(ord($sound_letter[$j]) - 1, 0x00), min(ord($sound_letter[$j]) + 1, 0xFF)));
 			break;
 
 			case 1:
 				for ($j = 0, $n = strlen($sound_letter) - 1; $j < $n; $j += 2)
-					$sound_word .= (mt_rand(0, 3) == 0 ? '' : $sound_letter{$j}) . (mt_rand(0, 3) === 0 ? $sound_letter{$j + 1} : $sound_letter{$j}) . (mt_rand(0, 3) === 0 ? $sound_letter{$j} : $sound_letter{$j + 1}) . $sound_letter{$j + 1} . (mt_rand(0, 3) == 0 ? $sound_letter{$j + 1} : '');
-				$sound_word .= str_repeat($sound_letter{$n}, 2);
+					$sound_word .= (mt_rand(0, 3) == 0 ? '' : $sound_letter[$j]) . (mt_rand(0, 3) === 0 ? $sound_letter[$j + 1] : $sound_letter[$j]) . (mt_rand(0, 3) === 0 ? $sound_letter[$j] : $sound_letter[$j + 1]) . $sound_letter[$j + 1] . (mt_rand(0, 3) == 0 ? $sound_letter[$j + 1] : '');
+				$sound_word .= str_repeat($sound_letter[$n], 2);
 			break;
 
 			case 2:
@@ -83,7 +84,7 @@ function createWaveFile($word)
 					if (mt_rand(0, 10) === 0)
 						$shift += mt_rand(-3, 3);
 					for ($k = 0, $m = round(mt_rand(15, 25) / 10); $k < $m; $k++)
-						$sound_word .= chr(min(max(ord($sound_letter{$j}) + $shift, 0x00), 0xFF));
+						$sound_word .= chr(min(max(ord($sound_letter[$j]) + $shift, 0x00), 0xFF));
 				}
 			break;
 
diff --git a/Sources/Subs.php b/Sources/Subs.php
index b8314dc..6cecb60 100644
--- a/Sources/Subs.php
+++ b/Sources/Subs.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.13
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -1090,41 +1090,36 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'type' => 'unparsed_content',
 				'content' => '<div class="codeheader">' . $txt['code'] . ': <a href="javascript:void(0);" onclick="return smfSelectText(this);" class="codeoperation">' . $txt['code_select'] . '</a></div>' . ($context['browser']['is_gecko'] || $context['browser']['is_opera'] ? '<pre style="margin: 0; padding: 0;">' : '') . '<code class="bbc_code">$1</code>' . ($context['browser']['is_gecko'] || $context['browser']['is_opera'] ? '</pre>' : ''),
 				// !!! Maybe this can be simplified?
-				'validate' => isset($disabled['code']) ? null : create_function('&$tag, &$data, $disabled', '
-					global $context;
-
-					if (!isset($disabled[\'code\']))
+				'validate' => isset($disabled['code']) ? null : function(&$tag, &$data, $disabled) use ($context)
+				{
+					if (!isset($disabled['code']))
 					{
-						$php_parts = preg_split(\'~(&lt;\?php|\?&gt;)~\', $data, -1, PREG_SPLIT_DELIM_CAPTURE);
+						$php_parts = preg_split('~(&lt;\?php|\?&gt;)~', $data, -1, PREG_SPLIT_DELIM_CAPTURE);
 
 						for ($php_i = 0, $php_n = count($php_parts); $php_i < $php_n; $php_i++)
 						{
 							// Do PHP code coloring?
-							if ($php_parts[$php_i] != \'&lt;?php\')
+							if ($php_parts[$php_i] != '&lt;?php')
 								continue;
 
-							$php_string = \'\';
-							while ($php_i + 1 < count($php_parts) && $php_parts[$php_i] != \'?&gt;\')
+							$php_string = '';
+							while ($php_i + 1 < count($php_parts) && $php_parts[$php_i] != '?&gt;')
 							{
 								$php_string .= $php_parts[$php_i];
-								$php_parts[$php_i++] = \'\';
+								$php_parts[$php_i++] = '';
 							}
 							$php_parts[$php_i] = highlight_php_code($php_string . $php_parts[$php_i]);
 						}
 
 						// Fix the PHP code stuff...
-						$data = str_replace("<pre style=\"display: inline;\">\t</pre>", "\t", implode(\'\', $php_parts));
-
-						// Older browsers are annoying, aren\'t they?
-						if ($context[\'browser\'][\'is_ie4\'] || $context[\'browser\'][\'is_ie5\'] || $context[\'browser\'][\'is_ie5.5\'])
-							$data = str_replace("\t", "<pre style=\"display: inline;\">\t</pre>", $data);
-						else
-							$data = str_replace("\t", "<span style=\"white-space: pre;\">\t</span>", $data);
+						$data = str_replace("<pre style=\"display: inline;\">\t</pre>", "\t", implode('', $php_parts));
+						$data = str_replace("\t", "<span style=\"white-space: pre;\">\t</span>", $data);
 
 						// Recent Opera bug requiring temporary fix. &nsbp; is needed before </code> to avoid broken selection.
-						if ($context[\'browser\'][\'is_opera\'])
-							$data .= \'&nbsp;\';
-					}'),
+						if (!empty($context['browser']['is_opera']))
+							$data .= '&nbsp;';
+					}
+				},
 				'block_level' => true,
 			),
 			array(
@@ -1132,41 +1127,36 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'type' => 'unparsed_equals_content',
 				'content' => '<div class="codeheader">' . $txt['code'] . ': ($2) <a href="#" onclick="return smfSelectText(this);" class="codeoperation">' . $txt['code_select'] . '</a></div>' . ($context['browser']['is_gecko'] || $context['browser']['is_opera'] ? '<pre style="margin: 0; padding: 0;">' : '') . '<code class="bbc_code">$1</code>' . ($context['browser']['is_gecko'] || $context['browser']['is_opera'] ? '</pre>' : ''),
 				// !!! Maybe this can be simplified?
-				'validate' => isset($disabled['code']) ? null : create_function('&$tag, &$data, $disabled', '
-					global $context;
-
-					if (!isset($disabled[\'code\']))
+				'validate' => isset($disabled['code']) ? null : function(&$tag, &$data, $disabled) use ($context)
+				{
+					if (!isset($disabled['code']))
 					{
-						$php_parts = preg_split(\'~(&lt;\?php|\?&gt;)~\', $data[0], -1, PREG_SPLIT_DELIM_CAPTURE);
+						$php_parts = preg_split('~(&lt;\?php|\?&gt;)~', $data[0], -1, PREG_SPLIT_DELIM_CAPTURE);
 
 						for ($php_i = 0, $php_n = count($php_parts); $php_i < $php_n; $php_i++)
 						{
 							// Do PHP code coloring?
-							if ($php_parts[$php_i] != \'&lt;?php\')
+							if ($php_parts[$php_i] != '&lt;?php')
 								continue;
 
-							$php_string = \'\';
-							while ($php_i + 1 < count($php_parts) && $php_parts[$php_i] != \'?&gt;\')
+							$php_string = '';
+							while ($php_i + 1 < count($php_parts) && $php_parts[$php_i] != '?&gt;')
 							{
 								$php_string .= $php_parts[$php_i];
-								$php_parts[$php_i++] = \'\';
+								$php_parts[$php_i++] = '';
 							}
 							$php_parts[$php_i] = highlight_php_code($php_string . $php_parts[$php_i]);
 						}
 
 						// Fix the PHP code stuff...
-						$data[0] = str_replace("<pre style=\"display: inline;\">\t</pre>", "\t", implode(\'\', $php_parts));
-
-						// Older browsers are annoying, aren\'t they?
-						if ($context[\'browser\'][\'is_ie4\'] || $context[\'browser\'][\'is_ie5\'] || $context[\'browser\'][\'is_ie5.5\'])
-							$data[0] = str_replace("\t", "<pre style=\"display: inline;\">\t</pre>", $data[0]);
-						else
-							$data[0] = str_replace("\t", "<span style=\"white-space: pre;\">\t</span>", $data[0]);
+						$data[0] = str_replace("<pre style=\"display: inline;\">\t</pre>", "\t", implode('', $php_parts));
+						$data[0] = str_replace("\t", "<span style=\"white-space: pre;\">\t</span>", $data[0]);
 
 						// Recent Opera bug requiring temporary fix. &nsbp; is needed before </code> to avoid broken selection.
-						if ($context[\'browser\'][\'is_opera\'])
-							$data[0] .= \'&nbsp;\';
-					}'),
+						if (!empty($context['browser']['is_opera']))
+							$data[0] .= '&nbsp;';
+					}
+				},
 				'block_level' => true,
 			),
 			array(
@@ -1181,7 +1171,10 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'type' => 'unparsed_content',
 				'content' => '<a href="mailto:$1" class="bbc_email">$1</a>',
 				// !!! Should this respect guest_hideContacts?
-				'validate' => create_function('&$tag, &$data, $disabled', '$data = strtr($data, array(\'<br />\' => \'\'));'),
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					$data = strtr($data, array('<br>' => ''));
+				},
 			),
 			array(
 				'tag' => 'email',
@@ -1196,14 +1189,15 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'tag' => 'flash',
 				'type' => 'unparsed_commas_content',
 				'test' => '\d+,\d+\]',
-				'content' => ($context['browser']['is_ie'] && !$context['browser']['is_mac_ie'] ? '<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="$2" height="$3"><param name="movie" value="$1" /><param name="play" value="true" /><param name="loop" value="true" /><param name="quality" value="high" /><param name="AllowScriptAccess" value="never" /><embed src="$1" width="$2" height="$3" play="true" loop="true" quality="high" AllowScriptAccess="never" /><noembed><a href="$1" target="_blank" class="new_win">$1</a></noembed></object>' : '<embed type="application/x-shockwave-flash" src="$1" width="$2" height="$3" play="true" loop="true" quality="high" AllowScriptAccess="never" /><noembed><a href="$1" target="_blank" class="new_win">$1</a></noembed>'),
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					if (isset($disabled[\'url\']))
-						$tag[\'content\'] = \'$1\';
-					elseif (strpos($data[0], \'http://\') !== 0 && strpos($data[0], \'https://\') !== 0)
-						$data[0] = \'http://\' . $data[0];
-				'),
-				'disabled_content' => '<a href="$1" target="_blank" class="new_win">$1</a>',
+				'content' => ($context['browser']['is_ie'] && !$context['browser']['is_mac_ie'] ? '<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="$2" height="$3"><param name="movie" value="$1" /><param name="play" value="true" /><param name="loop" value="true" /><param name="quality" value="high" /><param name="AllowScriptAccess" value="never" /><embed src="$1" width="$2" height="$3" play="true" loop="true" quality="high" AllowScriptAccess="never" /><noembed><a href="$1" target="_blank" rel="noopener noreferrer" class="bbc_link bbc_flash_disabled new_win">$1</a></noembed></object>' : '<embed type="application/x-shockwave-flash" src="$1" width="$2" height="$3" play="true" loop="true" quality="high" AllowScriptAccess="never" /><noembed><a href="$1" target="_blank" rel="noopener noreferrer" class="bbc_link bbc_flash_disabled new_win">$1</a></noembed>'),
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					if (isset($disabled['url']))
+						$tag['content'] = '$1';
+					elseif (strpos($data[0], 'http://') !== 0 && strpos($data[0], 'https://') !== 0)
+						$data[0] = 'http://' . $data[0];
+				},
+				'disabled_content' => '<a href="$1" target="_blank" rel="noopener noreferrer" class="bbc_link bbc_flash_disabled new_win">$1</a>',
 			),
 			array(
 				'tag' => 'font',
@@ -1222,22 +1216,24 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 			array(
 				'tag' => 'ftp',
 				'type' => 'unparsed_content',
-				'content' => '<a href="$1" class="bbc_ftp new_win" target="_blank">$1</a>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					$data = strtr($data, array(\'<br />\' => \'\'));
-					if (strpos($data, \'ftp://\') !== 0 && strpos($data, \'ftps://\') !== 0)
-						$data = \'ftp://\' . $data;
-				'),
+				'content' => '<a href="$1" class="bbc_ftp new_win" target="_blank" rel="noopener noreferrer">$1</a>',
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					$data = strtr($data, array('<br />' => ''));
+					if (strpos($data, 'ftp://') !== 0 && strpos($data, 'ftps://') !== 0)
+						$data = 'ftp://' . $data;
+				},
 			),
 			array(
 				'tag' => 'ftp',
 				'type' => 'unparsed_equals',
-				'before' => '<a href="$1" class="bbc_ftp new_win" target="_blank">',
+				'before' => '<a href="$1" class="bbc_ftp new_win" target="_blank" rel="noopener noreferrer">',
 				'after' => '</a>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					if (strpos($data, \'ftp://\') !== 0 && strpos($data, \'ftps://\') !== 0)
-						$data = \'ftp://\' . $data;
-				'),
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					if (strpos($data, 'ftp://') !== 0 && strpos($data, 'ftps://') !== 0)
+						$data = 'ftp://' . $data;
+				},
 				'disallow_children' => array('email', 'ftp', 'url', 'iurl'),
 				'disabled_after' => ' ($1)',
 			),
@@ -1280,45 +1276,53 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 					'height' => array('optional' => true, 'value' => ' height="$1"', 'match' => '(\d+)'),
 				),
 				'content' => '<img src="$1" alt="{alt}"{width}{height} class="bbc_img resized" />',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					$data = strtr($data, array(\'<br />\' => \'\'));
-					if (strpos($data, \'http://\') !== 0 && strpos($data, \'https://\') !== 0)
-						$data = \'http://\' . $data;
-				'),
+				'validate' => function (&$tag, &$data, $disabled)
+				{
+					$data = strtr($data, array('<br>' => ''));
+					if (strpos($data, 'http://') !== 0 && strpos($data, 'https://') !== 0)
+						$data = 'http://' . $data;
+
+					$data = get_proxied_url($data);
+				},
 				'disabled_content' => '($1)',
 			),
 			array(
 				'tag' => 'img',
 				'type' => 'unparsed_content',
 				'content' => '<img src="$1" alt="" class="bbc_img" />',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					$data = strtr($data, array(\'<br />\' => \'\'));
-					if (strpos($data, \'http://\') !== 0 && strpos($data, \'https://\') !== 0)
-						$data = \'http://\' . $data;
-				'),
+				'validate' => function (&$tag, &$data, $disabled)
+				{
+					$data = strtr($data, array('<br>' => ''));
+					if (strpos($data, 'http://') !== 0 && strpos($data, 'https://') !== 0)
+						$data = 'http://' . $data;
+
+					$data = get_proxied_url($data);
+				},
 				'disabled_content' => '($1)',
 			),
 			array(
 				'tag' => 'iurl',
 				'type' => 'unparsed_content',
 				'content' => '<a href="$1" class="bbc_link">$1</a>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					$data = strtr($data, array(\'<br />\' => \'\'));
-					if (strpos($data, \'http://\') !== 0 && strpos($data, \'https://\') !== 0)
-						$data = \'http://\' . $data;
-				'),
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					$data = strtr($data, array('<br />' => ''));
+					if (strpos($data, 'http://') !== 0 && strpos($data, 'https://') !== 0)
+						$data = 'http://' . $data;
+				},
 			),
 			array(
 				'tag' => 'iurl',
 				'type' => 'unparsed_equals',
 				'before' => '<a href="$1" class="bbc_link">',
 				'after' => '</a>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					if (substr($data, 0, 1) == \'#\')
-						$data = \'#post_\' . substr($data, 1);
-					elseif (strpos($data, \'http://\') !== 0 && strpos($data, \'https://\') !== 0)
-						$data = \'http://\' . $data;
-				'),
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					if (substr($data, 0, 1) == '#')
+						$data = '#post_' . substr($data, 1);
+					elseif (strpos($data, 'http://') !== 0 && strpos($data, 'https://') !== 0)
+						$data = 'http://' . $data;
+				},
 				'disallow_children' => array('email', 'ftp', 'url', 'iurl'),
 				'disabled_after' => ' ($1)',
 			),
@@ -1389,14 +1393,16 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'tag' => 'php',
 				'type' => 'unparsed_content',
 				'content' => '<span class="phpcode">$1</span>',
-				'validate' => isset($disabled['php']) ? null : create_function('&$tag, &$data, $disabled', '
-					if (!isset($disabled[\'php\']))
+				'validate' => isset($disabled['php']) ? null : function(&$tag, &$data, $disabled)
+				{
+					if (!isset($disabled['php']))
 					{
-						$add_begin = substr(trim($data), 0, 5) != \'&lt;?\';
-						$data = highlight_php_code($add_begin ? \'&lt;?php \' . $data . \'?&gt;\' : $data);
+						$add_begin = substr(trim($data), 0, 5) != '&lt;?';
+						$data = highlight_php_code($add_begin ? '&lt;?php ' . $data . '?&gt;' : $data);
 						if ($add_begin)
-							$data = preg_replace(array(\'~^(.+?)&lt;\?.{0,40}?php(?:&nbsp;|\s)~\', \'~\?&gt;((?:</(font|span)>)*)$~\'), \'$1\', $data, 2);
-					}'),
+							$data = preg_replace(array('~^(.+?)&lt;\?.{0,40}?php(?:&nbsp;|\s)~', '~\?&gt;((?:</(font|span)>)*)$~'), '$1', $data, 2);
+					}
+				},
 				'block_level' => false,
 				'disabled_content' => '$1',
 			),
@@ -1478,27 +1484,31 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'test' => '[#0-9a-zA-Z\-]{3,12},(left|right|top|bottom|[0123]\d{0,2})\]',
 				'before' => $context['browser']['is_ie'] ? '<span style="display: inline-block; filter: Shadow(color=$1, direction=$2); height: 1.2em;">' : '<span style="text-shadow: $1 $2">',
 				'after' => '</span>',
-				'validate' => $context['browser']['is_ie'] ? create_function('&$tag, &$data, $disabled', '
-					if ($data[1] == \'left\')
+				'validate' => $context['browser']['is_ie'] ? function(&$tag, &$data, $disabled)
+				{
+					if ($data[1] == 'left')
 						$data[1] = 270;
-					elseif ($data[1] == \'right\')
+					elseif ($data[1] == 'right')
 						$data[1] = 90;
-					elseif ($data[1] == \'top\')
+					elseif ($data[1] == 'top')
 						$data[1] = 0;
-					elseif ($data[1] == \'bottom\')
+					elseif ($data[1] == 'bottom')
 						$data[1] = 180;
 					else
-						$data[1] = (int) $data[1];') : create_function('&$tag, &$data, $disabled', '
-					if ($data[1] == \'top\' || (is_numeric($data[1]) && $data[1] < 50))
-						$data[1] = \'0 -2px 1px\';
-					elseif ($data[1] == \'right\' || (is_numeric($data[1]) && $data[1] < 100))
-						$data[1] = \'2px 0 1px\';
-					elseif ($data[1] == \'bottom\' || (is_numeric($data[1]) && $data[1] < 190))
-						$data[1] = \'0 2px 1px\';
-					elseif ($data[1] == \'left\' || (is_numeric($data[1]) && $data[1] < 280))
-						$data[1] = \'-2px 0 1px\';
+						$data[1] = (int) $data[1];
+				} : function(&$tag, &$data, $disabled)
+				{
+					if ($data[1] == 'top' || (is_numeric($data[1]) && $data[1] < 50))
+						$data[1] = '0 -2px 1px';
+					elseif ($data[1] == 'right' || (is_numeric($data[1]) && $data[1] < 100))
+						$data[1] = '2px 0 1px';
+					elseif ($data[1] == 'bottom' || (is_numeric($data[1]) && $data[1] < 190))
+						$data[1] = '0 2px 1px';
+					elseif ($data[1] == 'left' || (is_numeric($data[1]) && $data[1] < 280))
+						$data[1] = '-2px 0 1px';
 					else
-						$data[1] = \'1px 1px 1px\';'),
+						$data[1] = '1px 1px 1px';
+				},
 			),
 			array(
 				'tag' => 'size',
@@ -1513,10 +1523,11 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'test' => '[1-7]\]',
 				'before' => '<span style="font-size: $1;" class="bbc_size">',
 				'after' => '</span>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
+				'validate' => function(&$tag, &$data, $disabled)
+				{
 					$sizes = array(1 => 0.7, 2 => 1.0, 3 => 1.35, 4 => 1.45, 5 => 2.0, 6 => 2.65, 7 => 3.95);
-					$data = $sizes[$data] . \'em\';'
-				),
+					$data = $sizes[$data] . 'em';
+				},
 			),
 			array(
 				'tag' => 'sub',
@@ -1550,11 +1561,13 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'tag' => 'time',
 				'type' => 'unparsed_content',
 				'content' => '$1',
-				'validate' => create_function('&$tag, &$data, $disabled', '
+				'validate' => function(&$tag, &$data, $disabled)
+				{
 					if (is_numeric($data))
 						$data = timeformat($data);
 					else
-						$tag[\'content\'] = \'[time]$1[/time]\';'),
+						$tag['content'] = '[time]$1[/time]';
+				},
 			),
 			array(
 				'tag' => 'tr',
@@ -1580,22 +1593,23 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 			array(
 				'tag' => 'url',
 				'type' => 'unparsed_content',
-				'content' => '<a href="$1" class="bbc_link" target="_blank">$1</a>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					$data = strtr($data, array(\'<br />\' => \'\'));
-					if (strpos($data, \'http://\') !== 0 && strpos($data, \'https://\') !== 0)
-						$data = \'http://\' . $data;
-				'),
+				'content' => '<a href="$1" class="bbc_link" target="_blank" rel="noopener noreferrer">$1</a>',
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					if (strpos($data, 'http://') !== 0 && strpos($data, 'https://') !== 0)
+						$data = 'http://' . $data;
+				},
 			),
 			array(
 				'tag' => 'url',
 				'type' => 'unparsed_equals',
-				'before' => '<a href="$1" class="bbc_link" target="_blank">',
+				'before' => '<a href="$1" class="bbc_link" target="_blank" rel="noopener noreferrer">',
 				'after' => '</a>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					if (strpos($data, \'http://\') !== 0 && strpos($data, \'https://\') !== 0)
-						$data = \'http://\' . $data;
-				'),
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					if (strpos($data, 'http://') !== 0 && strpos($data, 'https://') !== 0)
+						$data = 'http://' . $data;
+				},
 				'disallow_children' => array('email', 'ftp', 'url', 'iurl'),
 				'disabled_after' => ' ($1)',
 			),
@@ -1877,7 +1891,7 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 					}
 
 					// Next, emails...
-					if (!isset($disabled['email']) && strpos($data, '@') !== false && strpos($data, '[email') === false)
+					if (!isset($disabled['email']) && filter_var($data, FILTER_VALIDATE_EMAIL) !== false && strpos($data, '[email') === false)
 					{
 						$data = preg_replace('~(?<=[\?\s' . $non_breaking_space . '\[\]()*\\\;>]|^)([\w\-\.]{1,80}@[\w\-]+\.[\w\-\.]+[\w\-])(?=[?,\s' . $non_breaking_space . '\[\]()*\\\]|$|<br />|&nbsp;|&gt;|&lt;|&quot;|&#039;|\.(?:\.|;|&nbsp;|\s|$|<br />))~' . ($context['utf8'] ? 'u' : ''), '[email]$1[/email]', $data);
 						$data = preg_replace('~(?<=<br />)([\w\-\.]{1,80}@[\w\-]+\.[\w\-\.]+[\w\-])(?=[?\.,;\s' . $non_breaking_space . '\[\]()*\\\]|$|<br />|&nbsp;|&gt;|&lt;|&quot;|&#039;)~' . ($context['utf8'] ? 'u' : ''), '[email]$1[/email]', $data);
@@ -2551,23 +2565,6 @@ function parsesmileys(&$message)
 	$message = preg_replace_callback($smileyPregSearch, 'smileyPregReplaceCallback', $message);
 }
 
-// This allows use to do delayed argument binding and bring in the replacement variables for some preg replacements.
-function pregReplaceCurry($func, $arity)
-{
-	return create_function('', "
-		\$args = func_get_args();
-		if(count(\$args) >= $arity)
-			return call_user_func_array('$func', \$args);
-		\$args = var_export(\$args, 1);
-		return create_function('','
-			\$a = func_get_args();
-			\$z = ' . \$args . ';
-			\$a = array_merge(\$z,\$a);
-			return call_user_func_array(\'$func\', \$a);
-		');
-	");
-}
-
 // Our callback that does the actual smiley replacements.
 function smileyPregReplaceCallback($matches)
 {
@@ -2606,7 +2603,9 @@ function highlight_php_code($code)
 // Put this user in the online log.
 function writeLog($force = false)
 {
-	global $user_info, $user_settings, $context, $modSettings, $settings, $topic, $board, $smcFunc, $sourcedir;
+	global $user_info, $user_settings, $context, $modSettings, $settings, $topic, $board, $smcFunc, $sourcedir, $remember_old_url;
+
+	$remember_old_url = true;
 
 	// If we are showing who is viewing a topic, let's see if we are, and force an update if so - to make it accurate.
 	if (!empty($settings['display_who_viewing']) && ($topic || $board))
@@ -2798,7 +2797,7 @@ function redirectexit($setLocation = '', $refresh = false)
 // Ends execution.  Takes care of template loading and remembering the previous URL.
 function obExit($header = null, $do_footer = null, $from_index = false, $from_fatal_error = false)
 {
-	global $context, $settings, $modSettings, $txt, $smcFunc;
+	global $context, $settings, $modSettings, $txt, $smcFunc, $remember_old_url;
 	static $header_done = false, $footer_done = false, $level = 0, $has_fatal_error = false;
 
 	// Attempt to prevent a recursive loop.
@@ -2828,6 +2827,20 @@ function obExit($header = null, $do_footer = null, $from_index = false, $from_fa
 
 		// Start up the session URL fixer.
 		ob_start('ob_sessrewrite');
+		ob_start(function ($buffer) {
+			global $context;
+			if (!$context['user']['is_guest'])
+				return $buffer;
+
+			return preg_replace_callback('~(<form[^<]+action=login2(.+))</form>~iUs' . (!empty($context['utf8']) ? 'u' : ''), function($m) use ($context) {
+				$repl = '';
+
+				if (strpos($m[0], $context['session_var']) === false)
+					$repl .= '<input type="hidden" name="' . $context['session_var'] . '" value="' . $context['session_id'] . '"/>';
+
+				return $m[1] . $repl . '</form>';
+			}, $buffer);
+		});
 
 		if (!empty($settings['output_buffers']) && is_string($settings['output_buffers']))
 			$buffers = explode(',', $settings['output_buffers']);
@@ -2879,7 +2892,8 @@ function obExit($header = null, $do_footer = null, $from_index = false, $from_fa
 	}
 
 	// Remember this URL in case someone doesn't like sending HTTP_REFERER.
-	if (strpos($_SERVER['REQUEST_URL'], 'action=dlattach') === false && strpos($_SERVER['REQUEST_URL'], 'action=viewsmfile') === false)
+	// !!! $remember_old_url is set in writeLog().
+	if (!empty($remember_old_url))
 		$_SESSION['old_url'] = $_SERVER['REQUEST_URL'];
 
 	// For session check verfication.... don't switch browsers...
@@ -2969,7 +2983,9 @@ function logAction($action, $extra = array(), $log_type = 'moderate')
 	}
 
 	// No point in doing anything else, if the log isn't even enabled.
-	if (empty($modSettings['modlog_enabled']) || !isset($log_types[$log_type]))
+	// ...except in certain special cases:
+	$always_log = !empty($modSettings['force_gdpr']) ? array('agreement_accepted', 'policy_accepted', 'agreement_updated', 'policy_updated') : array();
+	if ((empty($modSettings['modlog_enabled']) && !in_array($action, $always_log)) || !isset($log_types[$log_type]))
 		return false;
 
 	if (isset($extra['member']) && !is_numeric($extra['member']))
@@ -3218,7 +3234,7 @@ function determineTopicClass(&$topic_context)
 function setupThemeContext($forceload = false)
 {
 	global $modSettings, $user_info, $scripturl, $context, $settings, $options, $txt, $maintenance;
-	global $user_settings, $smcFunc;
+	global $user_settings, $smcFunc, $boardurl, $image_proxy_enabled, $image_proxy_secret;
 	static $loaded = false;
 
 	// Under SSI this function can be called more then once.  That can cause some problems.
@@ -3271,9 +3287,9 @@ function setupThemeContext($forceload = false)
 		if ($user_info['avatar']['url'] == '' && !empty($user_info['avatar']['id_attach']))
 			$context['user']['avatar']['href'] = $user_info['avatar']['custom_dir'] ? $modSettings['custom_avatar_url'] . '/' . $user_info['avatar']['filename'] : $scripturl . '?action=dlattach;attach=' . $user_info['avatar']['id_attach'] . ';type=avatar';
 		// Full URL?
-		elseif (substr($user_info['avatar']['url'], 0, 7) == 'http://')
+		elseif (substr($user_info['avatar']['url'], 0, 7) == 'http://' || substr($user_info['avatar']['url'], 0, 8) == 'https://')
 		{
-			$context['user']['avatar']['href'] = $user_info['avatar']['url'];
+			$context['user']['avatar']['href'] = get_proxied_url($user_info['avatar']['url']);
 
 			if ($modSettings['avatar_action_too_large'] == 'option_html_resize' || $modSettings['avatar_action_too_large'] == 'option_js_resize')
 			{
@@ -3395,18 +3411,6 @@ function template_header()
 	{
 		header('Expires: Mon, 26 Jul 1997 05:00:00 GMT');
 		header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT');
-
-		// Are we debugging the template/html content?
-		if (!isset($_REQUEST['xml']) && isset($_GET['debug']) && !$context['browser']['is_ie'] && !WIRELESS)
-			header('Content-Type: application/xhtml+xml');
-		elseif (!isset($_REQUEST['xml']) && !WIRELESS)
-			header('Content-Type: text/html; charset=' . (empty($context['character_set']) ? 'ISO-8859-1' : $context['character_set']));
-
-		// Are we debugging the template/html content?
-		if (!isset($_REQUEST['xml']) && isset($_GET['debug']) && !$context['browser']['is_ie'] && !WIRELESS)
-			header('Content-Type: application/xhtml+xml');
-		elseif (!isset($_REQUEST['xml']) && !WIRELESS)
-			header('Content-Type: text/html; charset=' . (empty($context['character_set']) ? 'ISO-8859-1' : $context['character_set']));
 	}
 
 	header('Content-Type: text/' . (isset($_REQUEST['xml']) ? 'xml' : 'html') . '; charset=' . (empty($context['character_set']) ? 'ISO-8859-1' : $context['character_set']));
@@ -3490,7 +3494,7 @@ function template_header()
 // Show the copyright...
 function theme_copyright($get_it = false)
 {
-	global $forum_copyright, $context, $boardurl, $forum_version, $txt, $modSettings;
+	global $forum_copyright, $context, $scripturl, $forum_version, $txt, $modSettings;
 
 	// Don't display copyright for things like SSI.
 	if (!isset($forum_version))
@@ -3499,6 +3503,11 @@ function theme_copyright($get_it = false)
 	// Put in the version...
 	$forum_copyright = sprintf($forum_copyright, $forum_version);
 
+	// It feels icky putting this here, but it's the only good way to do this without
+	// requiring all custom themes to be updated in order to comply with the GDPR.
+	if (!empty($modSettings['force_gdpr']))
+		$forum_copyright .= ' | <a id="button_agreement" href="' . $scripturl . '?action=agreement"><span>' . $txt['terms_and_policies'] . '</span></a>';
+
 	echo '
 			<span class="smalltext" style="display: inline; visibility: visible; font-family: Verdana, Arial, sans-serif;">' . $forum_copyright . '
 			</span>';
@@ -3816,6 +3825,10 @@ function text2words($text, $max_chars = 20, $encrypt = false)
 {
 	global $smcFunc, $context;
 
+	// Upgrader may be working on old DBs...
+	if (!isset($context['utf8']))
+		$context['utf8'] = false;
+
 	// Step 1: Remove entities/things we don't consider words:
 	$words = preg_replace('~(?:[\x0B\0' . ($context['utf8'] ? ($context['server']['complex_preg_chars'] ? '\x{A0}' : "\xC2\xA0") : '\xA0') . '\t\r\s\n(){}\\[\\]<>!@$%^*.,:+=`\~\?/\\\\]+|&(?:amp|lt|gt|quot);)+~' . ($context['utf8'] ? 'u' : ''), ' ', strtr($text, array('<br />' => ' ')));
 
@@ -3836,7 +3849,7 @@ function text2words($text, $max_chars = 20, $encrypt = false)
 				$encrypted = substr(crypt($word, 'uk'), 2, $max_chars);
 				$total = 0;
 				for ($i = 0; $i < $max_chars; $i++)
-					$total += $possible_chars[ord($encrypted{$i})] * pow(63, $i);
+					$total += $possible_chars[ord($encrypted[$i])] * pow(63, $i);
 				$returned_ints[] = $max_chars == 4 ? min($total, 16777215) : $total;
 			}
 		}
@@ -4203,7 +4216,8 @@ function setupMenuContext()
 	elseif ($context['current_action'] == 'groups' && $context['allow_moderation_center'])
 		$current_action = 'moderate';
 
-	$context['menu_buttons'][$current_action]['active_button'] = true;
+	if (isset($context['menu_buttons'][$current_action]))
+		$context['menu_buttons'][$current_action]['active_button'] = true;
 
 	if (!$user_info['is_guest'] && $context['user']['unread_messages'] > 0 && isset($context['menu_buttons']['pm']))
 	{
@@ -4220,7 +4234,7 @@ function smf_seed_generator()
 	// Never existed?
 	if (empty($modSettings['rand_seed']))
 	{
-		$modSettings['rand_seed'] = microtime() * 1000000;
+		$modSettings['rand_seed'] = (double) microtime() * 1000000;
 		updateSettings(array('rand_seed' => $modSettings['rand_seed']));
 	}
 
@@ -4380,6 +4394,30 @@ function fixchar__callback($matches)
 		return chr(($num >> 18) + 240) . chr((($num >> 12) & 63) + 128) . chr((($num >> 6) & 63) + 128) . chr(($num & 63) + 128);
 }
 
+/**
+ * Converts html entities to utf8 equivalents
+ * special db wrapper for mysql based on the limitation of mysql/mb3
+ *
+ * Callback function for preg_replace_callback
+ * Uses capture group 1 in the supplied array
+ * Does basic checks to keep characters inside a viewable range.
+ *
+ * @param array $matches An array of matches (relevant info should be the 2nd item in the array)
+ * @return string The fixed string or return the old when limitation of mysql is hit
+ */
+function fixchardb__callback($matches)
+{
+	global $db_type;
+	if (!isset($matches[1]))
+		return '';
+	$num = $matches[1][0] === 'x' ? hexdec(substr($matches[1], 1)) : (int) $matches[1];
+	// it's to big for mb3?
+	if ($num > 0xFFFF && $db_type == 'mysql')
+		return $matches[0];
+	else
+		return fixchar__callback($matches);
+}
+
 // Strips out invalid html entities, replaces others with html style &#123; codes.
 function entity_fix__callback($matches)
 {
@@ -4702,4 +4740,41 @@ function safe_unserialize($str)
 
 	return $out;
 }
-?>
\ No newline at end of file
+
+/**
+ * Gets the appropriate URL to use for images (or whatever) when using SSL
+ *
+ * The returned URL may or may not be a proxied URL, depending on the situation.
+ * Mods can implement alternative proxies using the 'integrate_proxy' hook.
+ *
+ * @param string $url The original URL of the requested resource
+ * @return string The URL to use
+ */
+function get_proxied_url($url)
+{
+	global $boardurl, $image_proxy_enabled, $image_proxy_secret, $user_info;
+
+	// Only use the proxy if enabled, and never for robots
+	if (empty($image_proxy_enabled) || !empty($user_info['possibly_robot']))
+		return $url;
+
+	$parsedurl = parse_url($url);
+
+	// Don't bother with HTTPS URLs, schemeless URLs, or obviously invalid URLs
+	if (empty($parsedurl['scheme']) || empty($parsedurl['host']) || empty($parsedurl['path']) || $parsedurl['scheme'] === 'https')
+		return $url;
+
+	// We don't need to proxy our own resources
+	if ($parsedurl['host'] === parse_url($boardurl, PHP_URL_HOST))
+		return strtr($url, array('http://' => 'https://'));
+
+	// By default, use SMF's own image proxy script
+	$proxied_url = strtr($boardurl, array('http://' => 'https://')) . '/proxy.php?request=' . urlencode($url) . '&hash=' . hash_hmac('sha1', $url, $image_proxy_secret);
+
+	// Allow mods to easily implement an alternative proxy
+	call_integration_hook('integrate_proxy', array($url, &$proxied_url));
+
+	return $proxied_url;
+}
+
+?>
diff --git a/Sources/Themes.php b/Sources/Themes.php
index 6241198..dd63040 100644
--- a/Sources/Themes.php
+++ b/Sources/Themes.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.13
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -1064,13 +1064,14 @@ function PickTheme()
 		// Change a specific member's theme.
 		else
 		{
-			if (isset($_GET['th']) && $_GET['th'] == 0)
-				$_GET['th'] = $modSettings['theme_guests'];
-
+			// An identifier of zero means that the user wants the forum default theme.
 			updateMemberData((int) $_REQUEST['u'], array('id_theme' => (int) $_GET['th']));
 
 			if (!empty($_GET['vrt']))
 			{
+				// Set the identifier to the forum default.
+				if (isset($_GET['th']) && $_GET['th'] == 0)
+					$_GET['th'] = $modSettings['theme_guests'];
 				$smcFunc['db_insert']('replace',
 					'{db_prefix}themes',
 					array('id_theme' => 'int', 'id_member' => 'int', 'variable' => 'string-255', 'value' => 'string-65534'),
@@ -1409,7 +1410,7 @@ function ThemeInstall()
 	<!-- Author: your email address or contact information. The name attribute is optional. -->
 	<author name="Simple Machines">info@simplemachines.org</author>
 	<!-- Website... where to get updates and more information. -->
-	<website>http://www.simplemachines.org/</website>
+	<website>https://www.simplemachines.org/</website>
 	<!-- Template layers to use, defaults to "html,body". -->
 	<layers>' . (empty($theme_layers) ? 'html,body' : $theme_layers) . '</layers>
 	<!-- Templates to load on startup. Default is "index". -->
diff --git a/Sources/Who.php b/Sources/Who.php
index 0129ff3..016ea9d 100644
--- a/Sources/Who.php
+++ b/Sources/Who.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -530,6 +530,11 @@ function Credits($in_admin = false)
 				array(
 					'title' => $txt['credits_groups_ps'],
 					'members' => array(
+						'Aleksi &quot;Lex&quot; Kilpinen',
+						// Former Project Managers
+						'Michele &quot;Illori&quot; Davis',
+						'Jessica &quot;Suki&quot; Gonz&aacute;lez',
+						'Will &quot;Kindred&quot; Wagner',
 						'Michael &quot;Oldiesmann&quot; Eshom',
 						'Amacythe',
 						'Jeremy &quot;SleePy&quot; Darwood',
@@ -539,14 +544,27 @@ function Credits($in_admin = false)
 				array(
 					'title' => $txt['credits_groups_dev'],
 					'members' => array(
+						// Lead Developer
+						'Jon &quot;Sesquipedalian&quot; Stovell',
+						// Developers
+						'Jessica &quot;Suki&quot; Gonz&aacute;lez',
+						'John &quot;live627&quot; Rayes',
+						'Oscar &quot;Ozp&quot; Rydhé',
+						'Shawn Bulen',
+
+						// Former Developers
 						'Norv',
 						'Aaron van Geffen',
 						'Antechinus',
 						'Bjoern &quot;Bloc&quot; Kristiansen',
+						'Colin Schoen',
+						'emanuele',
 						'Hendrik Jan &quot;Compuart&quot; Visser',
+						'Jeremy &quot;SleePy&quot; Darwood',
 						'Juan &quot;JayBachatero&quot; Hernandez',
 						'Karl &quot;RegularExpression&quot; Benson',
 						$user_info['is_admin'] ? 'Matt &quot;Grudge&quot; Wolf': 'Grudge',
+						'Michael &quot;Oldiesmann&quot; Eshom',
 						'Michael &quot;Thantos&quot; Miller',
 						'Selman &quot;[SiNaN]&quot; Eser',
 						'Theodore &quot;Orstio&quot; Hildebrandt',
@@ -557,26 +575,40 @@ function Credits($in_admin = false)
 				array(
 					'title' => $txt['credits_groups_support'],
 					'members' => array(
+						// Lead Support Specialist
+						'Will &quot;Kindred&quot; Wagner',
+						// Support Specialists
+						'lurkalot',
+						'shadav',
+						'Steve',
+
+						// Former Support Specialists
+						'Aleksi &quot;Lex&quot; Kilpinen',
 						'JimM',
 						'Adish &quot;(F.L.A.M.E.R)&quot; Patel',
 						'Aleksi &quot;Lex&quot; Kilpinen',
 						'Ben Scott',
 						'Bigguy',
+						'br360',
 						'CapadY',
+						'Chalky',
 						'Chas Large',
 						'Duncan85',
 						'Eliana Tamerin',
 						'Fiery',
+						'Gary M. Gadsdon',
+						'GigaWatt',
 						'gbsothere',
 						'Harro',
 						'Huw',
 						'Jan-Olof &quot;Owdy&quot; Eriksson',
 						'Jeremy &quot;jerm&quot; Strike',
-						'Jessica &quot;Miss All Sunday&quot; Gonzales',
+						'Justyne',
 						'K@',
 						'Kevin &quot;greyknight17&quot; Hou',
 						'KGIII',
 						'Kill Em All',
+						'margarett',
 						'Mattitude',
 						'Mashby',
 						'Mick G.',
@@ -592,31 +624,45 @@ function Credits($in_admin = false)
 						'S-Ace',
 						'Wade &quot;s&eta;&sigma;&omega;&quot; Poulsen',
 						'xenovanis',
+						'ziycon',
 					),
 				),
 				array(
 					'title' => $txt['credits_groups_customize'],
 					'members' => array(
+						// Lead Customizer
+						'Gary M. Gadsdon',
+						// Customizers
+						'Diego Andr&eacute;s',
+						'Jonathan &quot;vbgamer45&quot; Valentin',
+						'Mick.',
+
+						// Former Customizers
 						'Brad &quot;IchBin&trade;&quot; Grow',
 						'&#12487;&#12451;&#12531;1031',
 						'Brannon &quot;B&quot; Hall',
 						'Bryan &quot;Runic&quot; Deakin',
+						'Bugo',
 						'Bulakbol',
 						'Colin &quot;Shadow82x&quot; Blaber',
 						'Daniel15',
 						'Eren Yasarkurt',
-						'Gary M. Gadsdon',
+						'Gwenwyfar',
 						'Jason &quot;JBlaze&quot; Clemons',
 						'Jerry',
-						'Jonathan &quot;vbgamer45&quot; Valentin',
+						'Joker&trade;',
 						'Kays',
 						'Killer Possum',
 						'Kirby',
 						'Matt &quot;SlammedDime&quot; Zuba',
 						'Matthew &quot;Labradoodle-360&quot; Kerle',
+						'NanoSector',
+						'nend',
 						'Nibogo',
 						'Niko',
 						'Peter &quot;Arantor&quot; Spicer',
+						'Ricky.',
+						'Sami &quot;SychO&quot; Mazouz',
 						'snork13',
 						'Spuds',
 						'Steven &quot;Fustrate&quot; Hoffman',
@@ -626,8 +672,15 @@ function Credits($in_admin = false)
 				array(
 					'title' => $txt['credits_groups_docs'],
 					'members' => array(
+						// Doc Coordinator
+						'Michele &quot;Illori&quot; Davis',
+						// Doc Writers
+						'Irisado',
+
+						// Former Doc Writers
 						'Joshua &quot;groundup&quot; Dickerson',
 						'AngellinaBelle',
+						'Chainy',
 						'Daniel Diehl',
 						'Dannii Willis',
 						'emanuele',
@@ -640,17 +693,30 @@ function Credits($in_admin = false)
 				array(
 					'title' => $txt['credits_groups_marketing'],
 					'members' => array(
-						'Kindred',
+						// Marketing Coordinator
+
+						// Marketing
+
+						// Former Marketing
+						'Will &quot;Kindred&quot; Wagner',
 						'Marcus &quot;c&sigma;&sigma;&#1082;&iota;&#1108; &#1084;&sigma;&eta;&#1109;&#1090;&#1108;&#1103;&quot; Forsberg',
 						'Ralph &quot;[n3rve]&quot; Otowo',
 						'rickC',
 						'Tony Reid',
+						'Mert &quot;Antes&quot; Al&#x0131;nbay',
 					),
 				),
 				array(
 					'title' => $txt['credits_groups_internationalizers'],
 					'members' => array(
+						// Lead Localizer
+						'Nikola &quot;Dzonny&quot; Novaković',
+						// Localizers
+						'Francisco &quot;d3vcho&quot; Domínguez',
+						'm4z',
+						// Former Localizers
 						'Relyana',
+						'Robert.',
 						'Akyhne',
 						'GravuTrad',
 					),
@@ -659,7 +725,8 @@ function Credits($in_admin = false)
 					'title' => $txt['credits_groups_servers'],
 					'members' => array(
 						'Derek Schwab',
-						'Liroy &quot;CoreISP&quot; van Hoewijk',
+						'Michael Johnson',
+						'Liroy van Hoewijk',
 					),
 				),
 			),
@@ -716,6 +783,15 @@ function Credits($in_admin = false)
 					'David Recordon',
 				),
 			),
+			array(
+				'title' => $txt['credits_in_memoriam'],
+				'members' => array(
+					'Crip',
+					'K@',
+					'metallica48423',
+					'Paul_Pauline',
+				),
+			),
 		),
 	);
 
diff --git a/Themes/core/Display.template.php b/Themes/core/Display.template.php
index cf74eca..16cd8e3 100644
--- a/Themes/core/Display.template.php
+++ b/Themes/core/Display.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 function template_main()
@@ -395,7 +395,7 @@ function template_main()
 				// Don't show an icon if they haven't specified a website.
 				if ($message['member']['website']['url'] != '' && !isset($context['disabled_fields']['website']))
 					echo '
-								<li><a href="', $message['member']['website']['url'], '" title="' . $message['member']['website']['title'] . '" target="_blank" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $message['member']['website']['title'] . '" border="0" />' : $txt['www']), '</a></li>';
+								<li><a href="', $message['member']['website']['url'], '" title="' . $message['member']['website']['title'] . '" target="_blank" rel="noopener noreferrer" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $message['member']['website']['title'] . '" border="0" />' : $txt['www']), '</a></li>';
 
 				// Don't show the email address if they want it hidden.
 				if (in_array($message['member']['show_email'], array('yes', 'yes_permission_override', 'no_through_forum')))
diff --git a/Themes/core/Memberlist.template.php b/Themes/core/Memberlist.template.php
index 4aebdfe..7bd05b5 100644
--- a/Themes/core/Memberlist.template.php
+++ b/Themes/core/Memberlist.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // Displays a sortable listing of all members registered on the forum.
@@ -82,7 +82,7 @@ function template_main()
 
 		if (!isset($context['disabled_fields']['website']))
 			echo '
-					<td align="center" class="windowbg">', $member['website']['url'] != '' ? '<a href="' . $member['website']['url'] . '" target="_blank" class="new_win"><img src="' . $settings['images_url'] . '/www.gif" alt="' . $member['website']['title'] . '" title="' . $member['website']['title'] . '" /></a>' : '', '</td>';
+					<td align="center" class="windowbg">', $member['website']['url'] != '' ? '<a href="' . $member['website']['url'] . '" target="_blank" rel="noopener noreferrer" class="new_win"><img src="' . $settings['images_url'] . '/www.gif" alt="' . $member['website']['title'] . '" title="' . $member['website']['title'] . '" /></a>' : '', '</td>';
 
 		// ICQ?
 		if (!isset($context['disabled_fields']['icq']))
diff --git a/Themes/core/PersonalMessage.template.php b/Themes/core/PersonalMessage.template.php
index 83cf05c..99e7876 100644
--- a/Themes/core/PersonalMessage.template.php
+++ b/Themes/core/PersonalMessage.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.2
+ * @version 2.0.16
  */
 
 // This is the main sidebar for the personal messages section.
@@ -322,7 +322,7 @@ function template_folder()
 				// Don't show an icon if they haven't specified a website.
 				if ($message['member']['website']['url'] != '' && !isset($context['disabled_fields']['website']))
 					echo '
-								<li><a href="', $message['member']['website']['url'], '" title="' . $message['member']['website']['title'] . '" target="_blank" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $message['member']['website']['title'] . '" border="0" />' : $txt['www']), '</a></li>';
+								<li><a href="', $message['member']['website']['url'], '" title="' . $message['member']['website']['title'] . '" target="_blank" rel="noopener noreferrer" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $message['member']['website']['title'] . '" border="0" />' : $txt['www']), '</a></li>';
 
 				// Don't show the email address if they want it hidden.
 				if (in_array($message['member']['show_email'], array('yes', 'yes_permission_override', 'no_through_forum')))
diff --git a/Themes/core/index.template.php b/Themes/core/index.template.php
index 3415afb..f5a080e 100644
--- a/Themes/core/index.template.php
+++ b/Themes/core/index.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 /*	This template is, perhaps, the most important template in the theme. It
@@ -288,7 +288,7 @@ function template_body_above()
 					<input type="text" name="openid_identifier" id="openid_url" size="25" class="input_text openid_login" />';
 
 		echo '
-					<input type="hidden" name="hash_passwrd" value="" />
+					<input type="hidden" name="hash_passwrd" value="" /><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
 				</form>';
 	}
 
diff --git a/Themes/core/theme_info.xml b/Themes/core/theme_info.xml
index ee49be0..bf7ac1a 100644
--- a/Themes/core/theme_info.xml
+++ b/Themes/core/theme_info.xml
@@ -5,7 +5,7 @@
 	<!-- Author: your email address or contact information.  The name attribute is optional. -->
 	<author name="Simple Machines">info@simplemachines.org</author>
 	<!-- Website... where to get updates and more information. -->
-	<website>http://www.simplemachines.org/</website>
+	<website>https://www.simplemachines.org/</website>
 	<!-- Template layers to use, defaults to "html,body". -->
 	<layers>html,body</layers>
 	<!-- Templates to load on startup.  Default is "index". -->
diff --git a/Themes/default/Admin.template.php b/Themes/default/Admin.template.php
index 3a5fd9c..e80bb67 100644
--- a/Themes/default/Admin.template.php
+++ b/Themes/default/Admin.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // This is the administration center home.
@@ -886,8 +886,14 @@ function template_show_settings()
 
 				// Show a check box.
 				if ($config_var['type'] == 'check')
+				{
+					if (!empty($config_var['needs_default']))
+						echo '
+							<input type="hidden" name="', $config_var['name'], '" value="0" />';
+
 					echo '
 							<input type="checkbox"', $javascript, $disabled, ' name="', $config_var['name'], '" id="', $config_var['name'], '"', ($config_var['value'] ? ' checked="checked"' : ''), ' value="1" class="input_check" />';
+				}
 				// Escape (via htmlspecialchars.) the text box.
 				elseif ($config_var['type'] == 'password')
 					echo '
@@ -1358,8 +1364,15 @@ function template_core_features()
 			// Change the image, alternative text and the title.
 			document.getElementById("switch_" + itemID).src = \'', $settings['images_url'], '/admin/switch_\' + (itemValueHandle.value == 1 ? \'on\' : \'off\') + \'.png\';
 			document.getElementById("switch_" + itemID).alt = itemValueHandle.value == 1 ? \'', $txt['core_settings_switch_off'], '\' : \'', $txt['core_settings_switch_on'], '\';
-			document.getElementById("switch_" + itemID).title = itemValueHandle.value == 1 ? \'', $txt['core_settings_switch_off'], '\' : \'', $txt['core_settings_switch_on'], '\';
+			document.getElementById("switch_" + itemID).title = itemValueHandle.value == 1 ? \'', $txt['core_settings_switch_off'], '\' : \'', $txt['core_settings_switch_on'], '\';';
 
+	if (!empty($context['show_privacy_policy_warning']))
+		echo '
+			if (itemID == "gdpr" && itemValueHandle.value == 1) {
+				alert("' . $txt['core_settings_privacy_policy_warning'] . '");
+			}';
+
+	echo '
 			// Don\'t reload.
 			return false;
 		}
diff --git a/Themes/default/Agreement.template.php b/Themes/default/Agreement.template.php
new file mode 100644
index 0000000..ec5e5a1
--- /dev/null
+++ b/Themes/default/Agreement.template.php
@@ -0,0 +1,95 @@
+<?php
+
+/**
+ * Simple Machines Forum (SMF)
+ *
+ * @package SMF
+ * @author Simple Machines
+ * @copyright 2018 Simple Machines
+ * @license http://www.simplemachines.org/about/smf/license.php BSD
+ *
+ * @version 2.0.16
+ */
+
+// The main sub template - show the agreement and/or privacy policy
+function template_main()
+{
+	global $context, $scripturl, $txt;
+
+	if (!empty($context['accept_doc']))
+		echo '
+	<form action="', $scripturl, '?action=acceptagreement;doc=', $context['accept_doc'], '" method="post">';
+
+	if (!empty($context['agreement']))
+	{
+		echo '
+		<div class="cat_bar">
+			<h3 class="catbg">', $txt['agreement' . ($context['can_accept_agreement'] ? '_updated' : '')], '</h3>
+		</div>';
+
+		if ($context['can_accept_agreement'])
+		{
+			echo '
+		<p class="description">
+			', $txt['agreement_updated_desc'], '
+		</p>';
+		}
+		elseif (!empty($context['agreement_accepted_date']))
+		{
+			echo '
+		<p class="description">
+			', sprintf($txt['agreement_accepted'], timeformat($context['agreement_accepted_date'], false)), '
+		</p>';
+		}
+
+		echo '
+		<span class="upperframe"><span></span></span>
+		<div class="roundframe">
+			<div>', $context['agreement'], '</div>
+		</div>
+		<span class="lowerframe"><span></span></span>';
+	}
+
+	if (!empty($context['policy']))
+	{
+		if (!empty($context['agreement']))
+			echo '<br />';
+
+		echo '
+		<div class="cat_bar">
+			<h3 class="catbg">', $txt['privacy_policy' . ($context['can_accept_privacy_policy'] ? '_updated' : '')], '</h3>
+		</div>';
+
+		if ($context['can_accept_privacy_policy'])
+		{
+			echo '
+		<p class="description">
+			', $txt['privacy_policy_updated_desc'], '
+		</p>';
+		}
+		elseif (!empty($context['privacy_policy_accepted_date']))
+		{
+			echo '
+		<p class="description">
+			', sprintf($txt['privacy_policy_accepted'], timeformat($context['privacy_policy_accepted_date'], false)), '
+		</p>';
+		}
+
+		echo '
+		<span class="upperframe"><span></span></span>
+		<div class="roundframe">
+			<div>', $context['policy'], '</div>
+		</div>
+		<span class="lowerframe"><span></span></span>';
+	}
+
+	if (!empty($context['accept_doc']))
+		echo '
+		<div id="confirm_buttons">
+			<input type="submit" value="', $txt['agree'], '" class="button_submit" />
+			<input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
+		</div>
+	</form>';
+}
+
+?>
\ No newline at end of file
diff --git a/Themes/default/Display.template.php b/Themes/default/Display.template.php
index 268d6f8..7cb345f 100644
--- a/Themes/default/Display.template.php
+++ b/Themes/default/Display.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 function template_main()
@@ -375,7 +375,7 @@ function template_main()
 				// Don't show an icon if they haven't specified a website.
 				if ($message['member']['website']['url'] != '' && !isset($context['disabled_fields']['website']))
 					echo '
-										<li><a href="', $message['member']['website']['url'], '" title="' . $message['member']['website']['title'] . '" target="_blank" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $message['member']['website']['title'] . '" />' : $txt['www']), '</a></li>';
+										<li><a href="', $message['member']['website']['url'], '" title="' . $message['member']['website']['title'] . '" target="_blank" rel="noopener noreferrer" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $message['member']['website']['title'] . '" />' : $txt['www']), '</a></li>';
 
 				// Don't show the email address if they want it hidden.
 				if (in_array($message['member']['show_email'], array('yes', 'yes_permission_override', 'no_through_forum')))
diff --git a/Themes/default/Login.template.php b/Themes/default/Login.template.php
index 4c2f997..b25e3ae 100644
--- a/Themes/default/Login.template.php
+++ b/Themes/default/Login.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // This is just the basic "login" form.
@@ -69,7 +69,7 @@ function template_login()
 	echo '
 				</dl>
 				<p><input type="submit" value="', $txt['login'], '" class="button_submit" /></p>
-				<p class="smalltext"><a href="', $scripturl, '?action=reminder">', $txt['forgot_your_password'], '</a></p>
+				<p class="smalltext"><a href="', $scripturl, '?action=reminder">', $txt['forgot_your_password'], '</a></p><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
 				<input type="hidden" name="hash_passwrd" value="" />
 			</div>
 			<span class="lowerframe"><span></span></span>
@@ -136,10 +136,10 @@ function template_kick_guest()
 					<dd><input type="checkbox" name="cookieneverexp" class="input_check" onclick="this.form.cookielength.disabled = this.checked;" /></dd>
 				</dl>
 				<p class="centertext"><input type="submit" value="', $txt['login'], '" class="button_submit" /></p>
-				<p class="centertext smalltext"><a href="', $scripturl, '?action=reminder">', $txt['forgot_your_password'], '</a></p>
+				<p class="centertext smalltext"><a href="', $scripturl, '?action=reminder">', $txt['forgot_your_password'], '</a></p><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
 			</div>
 			<span class="lowerframe"><span></span></span>
-			<input type="hidden" name="hash_passwrd" value="" />
+			<input type="hidden" name="hash_passwrd" value="" /><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
 		</div>
 	</form>';
 
@@ -185,7 +185,7 @@ function template_maintenance()
 			<p class="centertext"><input type="submit" value="', $txt['login'], '" class="button_submit" /></p>
 		</div>
 		<span class="lowerframe"><span></span></span>
-		<input type="hidden" name="hash_passwrd" value="" />
+		<input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" /><input type="hidden" name="hash_passwrd" value="" />
 	</div>
 </form>';
 }
diff --git a/Themes/default/ManageNews.template.php b/Themes/default/ManageNews.template.php
index aa12029..cbc4294 100644
--- a/Themes/default/ManageNews.template.php
+++ b/Themes/default/ManageNews.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // Form for editing current news on the site.
@@ -80,7 +80,7 @@ function template_edit_news()
 
 function template_email_members()
 {
-	global $context, $settings, $options, $txt, $scripturl;
+	global $context, $settings, $options, $txt, $scripturl, $modSettings;
 
 	// This is some javascript for the simple/advanced toggling stuff.
 	echo '
@@ -143,14 +143,19 @@ function template_email_members()
 			<div class="windowbg2" id="advanced_settings_div" style="display: none;">
 				<span class="topslice"><span></span></span>
 				<div class="content">
-					<dl class="settings">
+					<dl class="settings">';
+
+	if (empty($modSettings['force_gdpr']))
+		echo '
 						<dt>
 							<strong>', $txt['admin_news_select_email'], ':</strong><br />
 							<span class="smalltext">', $txt['admin_news_select_email_desc'], '</span>
 						</dt>
 						<dd>
 							<textarea name="emails" rows="5" cols="30" style="' . ($context['browser']['is_ie8'] ? 'width: 635px; max-width: 98%; min-width: 98%' : 'width: 98%') . ';"></textarea>
-						</dd>
+						</dd>';
+
+	echo '
 						<dt>
 							<strong>', $txt['admin_news_select_members'], ':</strong><br />
 							<span class="smalltext">', $txt['admin_news_select_members_desc'], '</span>
@@ -184,7 +189,10 @@ function template_email_members()
 							<input type="text" name="exclude_members" id="exclude_members" value="" size="30" class="input_text" />
 							<span id="exclude_members_container"></span>
 						</dd>
-					</dl>
+					</dl>';
+
+	if (empty($modSettings['force_gdpr']))
+		echo '
 					<hr class="bordercolor" />
 					<dl class="settings">
 						<dt>
@@ -194,7 +202,10 @@ function template_email_members()
 						<dd>
 							<input type="checkbox" name="email_force" id="email_force" value="1" class="input_check" />
 						</dd>
-					</dl><br class="clear" />
+					</dl>';
+
+	echo '
+					<br class="clear" />
 				</div>
 				<span class="botslice"><span></span></span>
 			</div>
diff --git a/Themes/default/Memberlist.template.php b/Themes/default/Memberlist.template.php
index 0b5f717..aff8828 100644
--- a/Themes/default/Memberlist.template.php
+++ b/Themes/default/Memberlist.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // Displays a sortable listing of all members registered on the forum.
@@ -82,7 +82,7 @@ function template_main()
 
 		if (!isset($context['disabled_fields']['website']))
 			echo '
-					<td class="windowbg">', $member['website']['url'] != '' ? '<a href="' . $member['website']['url'] . '" target="_blank" class="new_win"><img src="' . $settings['images_url'] . '/www.gif" alt="' . $member['website']['title'] . '" title="' . $member['website']['title'] . '" /></a>' : '', '</td>';
+					<td class="windowbg">', $member['website']['url'] != '' ? '<a href="' . $member['website']['url'] . '" target="_blank" rel="noopener noreferrer" class="new_win"><img src="' . $settings['images_url'] . '/www.gif" alt="' . $member['website']['title'] . '" title="' . $member['website']['title'] . '" /></a>' : '', '</td>';
 
 		// ICQ?
 		if (!isset($context['disabled_fields']['icq']))
diff --git a/Themes/default/Notify.template.php b/Themes/default/Notify.template.php
index b397355..4ff834b 100644
--- a/Themes/default/Notify.template.php
+++ b/Themes/default/Notify.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 function template_main()
@@ -24,7 +24,7 @@ function template_main()
 		<div class="roundframe centertext">
 			<p>', $context['notification_set'] ? $txt['notify_deactivate'] : $txt['notify_request'], '</p>
 			<p>
-				<strong><a href="', $scripturl, '?action=notify;sa=', $context['notification_set'] ? 'off' : 'on', ';topic=', $context['current_topic'], '.', $context['start'], ';', $context['session_var'], '=', $context['session_id'], '">', $txt['yes'], '</a> - <a href="', $context['topic_href'], '">', $txt['no'], '</a></strong>
+				<strong><a href="', $scripturl, '?action=notify;sa=', $context['notification_set'] ? 'off' : 'on', ';topic=', $context['current_topic'], '.', $context['start'], ';', (!empty($context['notify_info']['token']) ? 'u=' . $context['notify_info']['u'] . ';token=' . $context['notify_info']['token'] : $context['session_var'] . '=' . $context['session_id']), '">', $txt['yes'], '</a> - <a href="', $context['topic_href'], '">', $txt['no'], '</a></strong>
 			</p>
 		</div>
 		<span class="lowerframe"><span></span></span>';
@@ -44,10 +44,47 @@ function template_notify_board()
 		<div class="roundframe centertext">
 			<p>', $context['notification_set'] ? $txt['notifyboard_turnoff'] : $txt['notifyboard_turnon'], '</p>
 			<p>
-				<strong><a href="', $scripturl, '?action=notifyboard;sa=', $context['notification_set'] ? 'off' : 'on', ';board=', $context['current_board'], '.', $context['start'], ';', $context['session_var'], '=', $context['session_id'], '">', $txt['yes'], '</a> - <a href="', $context['board_href'], '">', $txt['no'], '</a></strong>
+				<strong><a href="', $scripturl, '?action=notifyboard;sa=', $context['notification_set'] ? 'off' : 'on', ';board=', $context['current_board'], '.', $context['start'], ';', (!empty($context['notify_info']['token']) ? 'u=' . $context['notify_info']['u'] . ';token=' . $context['notify_info']['token'] : $context['session_var'] . '=' . $context['session_id']), '">', $txt['yes'], '</a> - <a href="', $context['board_href'], '">', $txt['no'], '</a></strong>
 			</p>
 		</div>
 		<span class="lowerframe"><span></span></span>';
 }
 
+function template_notify_announcements()
+{
+	global $context, $settings, $options, $txt, $scripturl;
+
+	echo '
+		<div class="cat_bar">
+			<h3 class="catbg">
+				<span class="ie6_header floatleft"><img src="', $settings['images_url'], '/email_sm.gif" alt="" class="icon" />', $txt['notify'], '</span>
+			</h3>
+		</div>
+		<span class="upperframe"><span></span></span>
+		<div class="roundframe centertext">
+			<p>', $txt['notifyannouncements_prompt'], '</p>
+			<p>
+				<strong><a href="', $scripturl, '?action=notifyannouncements;sa=on;', (!empty($context['notify_info']['token']) ? 'u=' . $context['notify_info']['u'] . ';token=' . $context['notify_info']['token'] : $context['session_var'] . '=' . $context['session_id']), '">', $txt['yes'], '</a> - <a href="', $scripturl, '?action=notifyannouncements;sa=off;', (!empty($context['notify_info']['token']) ? 'u=' . $context['notify_info']['u'] . ';token=' . $context['notify_info']['token'] : $context['session_var'] . '=' . $context['session_id']), '">', $txt['no'], '</a></strong>
+			</p>
+		</div>
+		<span class="lowerframe"><span></span></span>';
+}
+
+function template_notify_pref_changed()
+{
+	global $context, $settings, $options, $txt, $scripturl;
+
+	echo '
+		<div class="cat_bar">
+			<h3 class="catbg">
+				<span class="ie6_header floatleft"><img src="', $settings['images_url'], '/email_sm.gif" alt="" class="icon" />', $txt['notify'], '</span>
+			</h3>
+		</div>
+		<span class="upperframe"><span></span></span>
+		<div class="roundframe centertext">
+			<p>', $context['notify_success_msg'], '</p>
+		</div>
+		<span class="lowerframe"><span></span></span>';
+}
+
 ?>
\ No newline at end of file
diff --git a/Themes/default/PersonalMessage.template.php b/Themes/default/PersonalMessage.template.php
index 6ff12f1..720f8d9 100644
--- a/Themes/default/PersonalMessage.template.php
+++ b/Themes/default/PersonalMessage.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // This is the main sidebar for the personal messages section.
@@ -1440,7 +1440,9 @@ function template_add_rule()
 						if (document.forms.addrule.elements[i].id.substr(0, 8) == "ruletype")
 							criteriaNum++;
 				}
-				criteriaNum++
+
+				if (criteriaNum++ >= ', $context['rule_limiters']['criteria'], ')
+					return false;
 
 				setOuterHTML(document.getElementById("criteriaAddHere"), \'<br /><select name="ruletype[\' + criteriaNum + \']" id="ruletype\' + criteriaNum + \'" onchange="updateRuleDef(\' + criteriaNum + \'); rebuildRuleDesc();"><option value="">', addslashes($txt['pm_rule_criteria_pick']), ':<\' + \'/option><option value="mid">', addslashes($txt['pm_rule_mid']), '<\' + \'/option><option value="gid">', addslashes($txt['pm_rule_gid']), '<\' + \'/option><option value="sub">', addslashes($txt['pm_rule_sub']), '<\' + \'/option><option value="msg">', addslashes($txt['pm_rule_msg']), '<\' + \'/option><option value="bud">', addslashes($txt['pm_rule_bud']), '<\' + \'/option><\' + \'/select>&nbsp;<span id="defdiv\' + criteriaNum + \'" style="display: none;"><input type="text" name="ruledef[\' + criteriaNum + \']" id="ruledef\' + criteriaNum + \'" onkeyup="rebuildRuleDesc();" value="" class="input_text" /><\' + \'/span><span id="defseldiv\' + criteriaNum + \'" style="display: none;"><select name="ruledefgroup[\' + criteriaNum + \']" id="ruledefgroup\' + criteriaNum + \'" onchange="rebuildRuleDesc();"><option value="">', addslashes($txt['pm_rule_sel_group']), '<\' + \'/option>';
 
@@ -1448,6 +1450,9 @@ function template_add_rule()
 		echo '<option value="', $id, '">', strtr($group, array("'" => "\'")), '<\' + \'/option>';
 
 	echo '<\' + \'/select><\' + \'/span><span id="criteriaAddHere"><\' + \'/span>\');
+
+				if (criteriaNum + 1 > ', $context['rule_limiters']['criteria'], ')
+					document.getElementById(\'addonjs1\').style.display = \'none\';
 			}
 
 			function addActionOption()
@@ -1458,7 +1463,8 @@ function template_add_rule()
 						if (document.forms.addrule.elements[i].id.substr(0, 7) == "acttype")
 							actionNum++;
 				}
-				actionNum++
+				if (actionNum++ >= ', $context['rule_limiters']['actions'], ')
+					return false;
 
 				setOuterHTML(document.getElementById("actionAddHere"), \'<br /><select name="acttype[\' + actionNum + \']" id="acttype\' + actionNum + \'" onchange="updateActionDef(\' + actionNum + \'); rebuildRuleDesc();"><option value="">', addslashes($txt['pm_rule_sel_action']), ':<\' + \'/option><option value="lab">', addslashes($txt['pm_rule_label']), '<\' + \'/option><option value="del">', addslashes($txt['pm_rule_delete']), '<\' + \'/option><\' + \'/select>&nbsp;<span id="labdiv\' + actionNum + \'" style="display: none;"><select name="labdef[\' + actionNum + \']" id="labdef\' + actionNum + \'" onchange="rebuildRuleDesc();"><option value="">', addslashes($txt['pm_rule_sel_label']), '<\' + \'/option>';
 
@@ -1467,6 +1473,9 @@ function template_add_rule()
 			echo '<option value="', ($label['id'] + 1), '">', addslashes($label['name']), '<\' + \'/option>';
 
 	echo '<\' + \'/select><\' + \'/span><span id="actionAddHere"><\' + \'/span>\');
+
+				if (actionNum + 1 > ', $context['rule_limiters']['actions'], ')
+					document.getElementById(\'addonjs2\').style.display = \'none\';
 			}
 
 			function updateRuleDef(optNum)
@@ -1736,8 +1745,12 @@ function template_add_rule()
 			document.getElementById("removeonjs1").style.display = "none";
 			document.getElementById("removeonjs2").style.display = "none";';
 
-	echo '
-			document.getElementById("addonjs1").style.display = "";
+	if (count($context['rule']['criteria']) <= $context['rule_limiters']['criteria'])
+		echo '
+			document.getElementById("addonjs1").style.display = "";';
+
+	if (count($context['rule']['actions']) <= $context['rule_limiters']['actions'])
+		echo '
 			document.getElementById("addonjs2").style.display = "";';
 
 	echo '
diff --git a/Themes/default/Profile.template.php b/Themes/default/Profile.template.php
index 15b3bdf..89f4a1a 100644
--- a/Themes/default/Profile.template.php
+++ b/Themes/default/Profile.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // Template for the profile side bar - goes before any other profile template.
@@ -72,7 +72,7 @@ function template_summary()
 	// Don't show an icon if they haven't specified a website.
 	if ($context['member']['website']['url'] !== '' && !isset($context['disabled_fields']['website']))
 		echo '
-					<li><a href="', $context['member']['website']['url'], '" title="' . $context['member']['website']['title'] . '" target="_blank" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $context['member']['website']['title'] . '" />' : $txt['www']), '</a></li>';
+					<li><a href="', $context['member']['website']['url'], '" title="' . $context['member']['website']['title'] . '" target="_blank" rel="noopener noreferrer" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $context['member']['website']['title'] . '" />' : $txt['www']), '</a></li>';
 
 	// Are there any custom profile fields for the summary?
 	if (!empty($context['custom_fields']))
@@ -2762,7 +2762,7 @@ function template_profile_avatar_select()
 		echo '
 								<div id="avatar_external">
 									<div class="smalltext">', $txt['avatar_by_url'], '</div>
-									<input type="text" name="userpicpersonal" size="45" value="', $context['member']['avatar']['external'], '" onfocus="selectRadioByName(document.forms.creator.avatar_choice, \'external\');" onchange="if (typeof(previewExternalAvatar) != \'undefined\') previewExternalAvatar(this.value);" class="input_text" />
+									<input type="text" name="userpicpersonal" size="45" value="', $context['member']['avatar']['external_original'], '" onfocus="selectRadioByName(document.forms.creator.avatar_choice, \'external\');" onchange="if (typeof(previewExternalAvatar) != \'undefined\') previewExternalAvatar(this.value);" class="input_text" />
 								</div>';
 	}
 
diff --git a/Themes/default/Register.template.php b/Themes/default/Register.template.php
index 3497cac..f9b5b9e 100644
--- a/Themes/default/Register.template.php
+++ b/Themes/default/Register.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // Before showing users a registration form, show them the registration agreement.
@@ -16,15 +16,31 @@ function template_registration_agreement()
 	global $context, $settings, $options, $scripturl, $txt, $modSettings;
 
 	echo '
-		<form action="', $scripturl, '?action=register" method="post" accept-charset="', $context['character_set'], '" id="registration">
+		<form action="', $scripturl, '?action=register" method="post" accept-charset="', $context['character_set'], '" id="registration">';
+
+	if (!empty($context['agreement']))
+		echo '
 			<div class="cat_bar">
 				<h3 class="catbg">', $txt['registration_agreement'], '</h3>
 			</div>
 			<span class="upperframe"><span></span></span>
 			<div class="roundframe">
-				<p>', $context['agreement'], '</p>
+				<div>', $context['agreement'], '</div>
+			</div>
+			<span class="lowerframe"><span></span></span>';
+
+	if (!empty($context['policy']))
+		echo '
+			<div class="cat_bar">
+				<h3 class="catbg">', $txt['privacy_policy'], '</h3>
+			</div>
+			<span class="upperframe"><span></span></span>
+			<div class="roundframe">
+				<div>', $context['policy'], '</div>
 			</div>
-			<span class="lowerframe"><span></span></span>
+			<span class="lowerframe"><span></span></span>';
+
+	echo '
 			<div id="confirm_buttons">';
 
 	// Age restriction in effect?
@@ -34,7 +50,7 @@ function template_registration_agreement()
 				<input type="submit" name="accept_agreement_coppa" value="', $context['coppa_agree_below'], '" class="button_submit" />';
 	else
 		echo '
-				<input type="submit" name="accept_agreement" value="', $txt['agreement_agree'], '" class="button_submit" />';
+				<input type="submit" name="accept_agreement" value="', $txt['agreement' . ($context['require_policy_agreement'] ? '_policy' : '') . '_agree'], '" class="button_submit" />';
 
 	echo '
 			</div>
@@ -209,6 +225,15 @@ function template_registration_form()
 
 	}
 
+	if (!empty($context['announcements_ask']))
+		echo '
+					<dl class="register_form" id="notify_announcements_group">
+						<dt><strong><label for="notify_announcements">', $txt['notify_announcements'], ':</label></strong></dt>
+						<dd>
+							<input type="checkbox" name="notify_announcements" id="notify_announcements" tabindex="', $context['tabindex']++, '" class="input_check"', (!empty($context['notify_announcements']) ? ' checked="checked"' : ''), ' />
+						</dd>
+					</dl>';
+
 	echo '
 				</fieldset>
 				<span class="botslice"><span></span></span>
@@ -598,6 +623,20 @@ function template_admin_register()
 					<dd>
 						<input type="checkbox" name="emailActivate" id="emailActivate_check" tabindex="', $context['tabindex']++, '"', !empty($modSettings['registration_method']) && $modSettings['registration_method'] == 1 ? ' checked="checked"' : '', ' onclick="onCheckChange();" class="input_check" />
 					</dd>
+					<dt>
+						<strong><label for="requireAgreement">', $txt['admin_register_require_agreement'], ':</label></strong>
+					</dt>
+					<dd>
+						<input type="checkbox" name="requireAgreement" id="requireAgreement_check" tabindex="', $context['tabindex']++, '"', !empty($modSettings['requireAgreement']) || !empty($modSettings['force_gdpr']) ? ' checked="checked"' : '', !empty($modSettings['force_gdpr']) ? ' disabled="disabled"' : '', ' class="input_check" />', !empty($modSettings['force_gdpr']) ? '
+						<input type="hidden" name="requireAgreement" value=1>' : '', '
+					</dd>
+					<dt>
+						<strong><label for="requirePolicyAgreement">', $txt['admin_register_require_policy'], ':</label></strong>
+					</dt>
+					<dd>
+						<input type="checkbox" name="requirePolicyAgreement" id="requirePolicyAgreement_check" tabindex="', $context['tabindex']++, '"', !empty($modSettings['requirePolicyAgreement']) || !empty($modSettings['force_gdpr']) ? ' checked="checked"' : '', !empty($modSettings['force_gdpr']) ? ' disabled="disabled"' : '', ' class="input_check" />', !empty($modSettings['force_gdpr']) ? '
+						<input type="hidden" name="requirePolicyAgreement" value=1>' : '', '
+					</dd>
 				</dl>
 				<div class="righttext">
 					<input type="submit" name="regSubmit" value="', $txt['register'], '" tabindex="', $context['tabindex']++, '" class="button_submit" />
@@ -664,14 +703,24 @@ function template_edit_agreement()
 					<p class="agreement">
 						<textarea cols="70" rows="20" name="agreement" id="agreement">', $context['agreement'], '</textarea>
 					</p>
-					<p>
-						<label for="requireAgreement"><input type="checkbox" name="requireAgreement" id="requireAgreement"', $context['require_agreement'] ? ' checked="checked"' : '', ' tabindex="', $context['tabindex']++, '" value="1" class="input_check" /> ', $txt['admin_agreement'], '.</label>
-					</p>
-					<div class="righttext">
-						<input type="submit" value="', $txt['save'], '" tabindex="', $context['tabindex']++, '" class="button_submit" />
+					<div class="information">
+						<span>', $context['agreement_info'], '</span>
+					</div>
+					<div class="righttext">', empty($context['force_gdpr']) ? '
+						<label for="minor_edit"><input type="checkbox" value="" id="minor_edit" name="minor_edit" tabindex="' . $context['tabindex']++ . '" class="input_check" /> ' . $txt['admin_agreement_minor_edit'] . '</label>' : '', '
+						<input type="submit" value="', $txt['save'], '" tabindex="', $context['tabindex']++, '" class="button_submit" onclick="return resetAgreementConfirm()" />
 						<input type="hidden" name="agree_lang" value="', $context['current_agreement'], '" />
 						<input type="hidden" name="sa" value="agreement" />
 						<input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
+						<script>
+							function resetAgreementConfirm()
+							{
+								if (document.getElementById("minor_edit").checked)
+									return true;
+								else if (document.getElementById(\'agreement\').value != ' . JavaScriptEscape(un_htmlspecialchars($context['agreement'])) . ')
+									return confirm(' . JavaScriptEscape($txt['reset_agreement_desc']) . ');
+							}
+						</script>
 					</div>
 				</form>
 			</div>
@@ -712,4 +761,78 @@ function template_edit_reserved_words()
 		<br class="clear" />';
 }
 
+// Form for editing the privacy policy shown to people registering to the forum.
+function template_edit_privacy_policy()
+{
+	global $context, $settings, $options, $scripturl, $txt;
+
+	// Just a big box to edit the text file ;).
+	echo '
+		<div class="cat_bar">
+			<h3 class="catbg">', $txt['privacy_policy'], '</h3>
+		</div>';
+
+	echo '
+		<div class="windowbg2" id="privacy_policy">
+			<span class="topslice"><span></span></span>
+			<div class="content">';
+
+	// Is there more than one language to choose from?
+	if (count($context['editable_policies']) > 1)
+	{
+		echo '
+				<div class="information">
+					<form action="', $scripturl, '?action=admin;area=regcenter" id="change_policy" method="post" accept-charset="', $context['character_set'], '" style="display: inline;">
+						<strong>', $txt['admin_agreement_select_language'], ':</strong>&nbsp;
+						<select name="policy_lang" onchange="document.getElementById(\'change_policy\').submit();" tabindex="', $context['tabindex']++, '">';
+
+		foreach ($context['editable_policies'] as $lang => $name)
+			echo '
+							<option value="', $lang, '" ', $context['current_policy_lang'] == $lang ? 'selected="selected"' : '', '>', $name, '</option>';
+
+		echo '
+						</select>
+						<div class="righttext">
+							<input type="hidden" name="sa" value="policy" />
+							<input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
+							<input type="submit" name="change" value="', $txt['admin_agreement_select_language_change'], '" tabindex="', $context['tabindex']++, '" class="button_submit" />
+						</div>
+					</form>
+				</div>';
+	}
+
+	echo '
+				<form action="', $scripturl, '?action=admin;area=regcenter" method="post" accept-charset="', $context['character_set'], '">';
+
+	// Show the actual policy in an oversized text box.
+	echo '
+					<p class="policy">
+						<textarea cols="70" rows="20" name="policy" id="agreement">', $context['policy'], '</textarea>
+					</p>
+					<div class="information">
+						<span>', $context['policy_info'], '</span>
+					</div>
+					<div class="righttext">', empty($context['force_gdpr']) ? '
+						<label for="minor_edit"><input type="checkbox" value="" id="minor_edit" name="minor_edit" tabindex="' . $context['tabindex']++ . '" class="input_check" /> ' . $txt['admin_agreement_minor_edit'] . '</label>' : '', '
+						<input type="submit" value="', $txt['save'], '" tabindex="', $context['tabindex']++, '" class="button_submit" onclick="return resetPolicyConfirm()" />
+						<input type="hidden" name="policy_lang" value="', $context['current_policy_lang'], '" />
+						<input type="hidden" name="sa" value="policy" />
+						<input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
+						<script>
+							function resetPolicyConfirm()
+							{
+								if (document.getElementById("minor_edit").checked)
+									return true;
+								else if (document.getElementById(\'agreement\').value != ' . JavaScriptEscape(un_htmlspecialchars($context['policy'])) . ')
+									return confirm(' . JavaScriptEscape($txt['reset_privacy_policy_desc']) . ');
+							}
+						</script>
+					</div>
+				</form>
+			</div>
+			<span class="botslice"><span></span></span>
+		</div>
+		<br class="clear" />';
+}
+
 ?>
\ No newline at end of file
diff --git a/Themes/default/Search.template.php b/Themes/default/Search.template.php
index 64979bb..a0e4770 100644
--- a/Themes/default/Search.template.php
+++ b/Themes/default/Search.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.10
+ * @version 2.0.18
  */
 
 function template_main()
@@ -305,7 +305,7 @@ function template_results()
 
 			echo '
 			<div class="search_results_posts">
-			<div class="', $message['alternate'] == 0 ? 'windowbg' : 'windowbg2', ' core_posts">
+			<div class="', empty($message['alternate']) ? 'windowbg' : 'windowbg2', ' core_posts">
 				<span class="topslice"><span></span></span>
 				<div class="content flow_auto">';
 
diff --git a/Themes/default/Wireless.template.php b/Themes/default/Wireless.template.php
index c830fac..a32ea04 100644
--- a/Themes/default/Wireless.template.php
+++ b/Themes/default/Wireless.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // This is the header for WAP 1.1 output. You can view it with ?wap in the URL.
@@ -26,7 +26,7 @@ function template_wap_above()
 // This is the board index (main page) in WAP 1.1.
 function template_wap_boardindex()
 {
-	global $context, $settings, $options, $scripturl;
+	global $context, $settings, $options, $scripturl, $txt;
 
 	// This is the "main" card...
 	echo '
@@ -62,6 +62,24 @@ function template_wap_boardindex()
 		echo '
 	</card>';
 	}
+
+	echo '
+	<card>
+		<p', $txt['wireless_options'], '</p>';
+	if ($context['user']['is_guest'])
+		echo '
+		<p><a href="', $scripturl, '?action=login;wap">', $txt['wireless_options_login'], '</a></p>';
+	else
+	{
+		if ($context['allow_pm'])
+			echo '
+			<p><a href="', $scripturl, '?action=pm;wap">', empty($context['user']['unread_messages']) ? $txt['wireless_pm_inbox'] : sprintf($txt['wireless_pm_inbox_new'], $context['user']['unread_messages']), '</a></p>';
+		echo '
+		<p><a href="', $scripturl, '?action=unread;wap">', $txt['wireless_recent_unread_posts'], '</a></p>
+		<p><a href="', $scripturl, '?action=unreadreplies;wap">', $txt['wireless_recent_unread_replies'], '</a></p>
+		<p><a href="', $scripturl, '?action=logout;', $context['session_var'], '=', $context['session_id'], ';wap">', $txt['wireless_options_logout'], '</a></p>
+	</card>';
+	}
 }
 
 // This is the message index (list of topics in a board) for WAP 1.1.
@@ -174,6 +192,7 @@ function template_wap_login()
 				<postfield name="user" value="$user" />
 				<postfield name="passwrd" value="$passwrd" />
 				<postfield name="cookieneverexp" value="1" />
+				<postfield name="', $context['session_var'], '" value="', $context['session_id'], '" />
 			</go>
 		</do></p>
 	</card>';
@@ -476,7 +495,7 @@ function template_imode_login()
 				<tr><td><input type="text" name="openid_identifier" class="input_text openid_login" size="17" /></td></tr>';
 
 	echo '
-				<tr><td><input type="submit" value="', $txt['login'], '" class="button_submit" /><input type="hidden" name="cookieneverexp" value="1" /></td></tr>
+				<tr><td><input type="submit" value="', $txt['login'], '" class="button_submit" /><input type="hidden" name="cookieneverexp" value="1" /><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" /></td></tr>
 				<tr bgcolor="#b6dbff"><td>', $txt['wireless_navigation'], '</td></tr>
 				<tr><td>[0] <a href="', $scripturl, '?imode" accesskey="0">', $txt['wireless_navigation_up'], '</a></td></tr>
 			</table>
@@ -1074,7 +1093,7 @@ function template_wap2_login()
 			<p class="windowbg"><input type="text" name="openid_identifier" class="input_text openid_login" size="17" /></p>';
 
 	echo '
-			<p class="windowbg"><input type="submit" value="', $txt['login'], '" class="button_submit" /><input type="hidden" name="cookieneverexp" value="1" /></p>
+			<p class="windowbg"><input type="submit" value="', $txt['login'], '" class="button_submit" /><input type="hidden" name="cookieneverexp" value="1" /><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" /></p>
 			<p class="catbg">', $txt['wireless_navigation'], '</p>
 			<p class="windowbg">[0] <a href="', $scripturl, '?wap2" accesskey="0">', $txt['wireless_navigation_up'], '</a></p>
 		</form>';
diff --git a/Themes/default/Xml.template.php b/Themes/default/Xml.template.php
index e7e46a4..56edc9b 100644
--- a/Themes/default/Xml.template.php
+++ b/Themes/default/Xml.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 function template_sendbody()
@@ -139,7 +139,7 @@ function template_stats()
 	echo '<', '?xml version="1.0" encoding="', $context['character_set'], '"?', '>
 <smf>';
 	foreach ($context['yearly'] as $year)
-		foreach ($year['months'] as $month);
+		foreach ($year['months'] as $month)
 		{
 			echo '
 	<month id="', $month['date']['year'], $month['date']['month'], '">';
diff --git a/Themes/default/index.template.php b/Themes/default/index.template.php
index 821d814..0258469 100644
--- a/Themes/default/index.template.php
+++ b/Themes/default/index.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.19
  */
 
 /*	This template is, perhaps, the most important template in the theme. It
@@ -147,12 +147,6 @@ function template_html_above()
 		echo '
 	<link rel="alternate" type="application/rss+xml" title="', $context['forum_name_html_safe'], ' - ', $txt['rss'], '" href="', $scripturl, '?type=rss;action=.xml" />';
 
-	// If we're viewing a topic, these should be the previous and next topics, respectively.
-	if (!empty($context['current_topic']))
-		echo '
-	<link rel="prev" href="', $scripturl, '?topic=', $context['current_topic'], '.0;prev_next=prev" />
-	<link rel="next" href="', $scripturl, '?topic=', $context['current_topic'], '.0;prev_next=next" />';
-
 	// If we're in a board, or a topic for that matter, the index will be the board's index.
 	if (!empty($context['current_board']))
 		echo '
@@ -241,7 +235,7 @@ function template_body_above()
 					<br /><input type="text" name="openid_identifier" id="openid_url" size="25" class="input_text openid_login" />';
 
 		echo '
-					<input type="hidden" name="hash_passwrd" value="" />
+					<input type="hidden" name="hash_passwrd" value="" /><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
 				</form>';
 	}
 
diff --git a/Themes/default/languages/Admin.english.php b/Themes/default/languages/Admin.english.php
index 1b1cb14..c665b53 100644
--- a/Themes/default/languages/Admin.english.php
+++ b/Themes/default/languages/Admin.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Admin
+// Version: 2.0.16; Admin
 
 global $settings, $scripturl;
 
@@ -41,13 +41,18 @@ $txt['admin_smfpackage'] = 'SMF Package';
 $txt['admin_maintenance'] = 'Maintenance';
 $txt['admin_image_text'] = 'Show buttons as images instead of text';
 $txt['admin_credits'] = 'Credits';
-$txt['admin_agreement'] = 'Show and require agreement letter when registering';
+$txt['admin_agreement'] = 'Require new members to accept the registration agreement';
+$txt['admin_agreement_minor_edit'] = 'This is a minor edit';
+$txt['reset_agreement_desc'] = 'This will force all members to re-read and accept the registration agreement in order to continue using the forum.';
+$txt['admin_privacy_policy'] = 'Require new members to accept the privacy policy';
+$txt['reset_privacy_policy_desc'] = 'This will force all members to re-read and accept the privacy policy in order to continue using the forum.';
+$txt['admin_agreement_info'] = 'Last updated: %1$s.';
 $txt['admin_agreement_default'] = 'Default';
 $txt['admin_agreement_select_language'] = 'Language to edit';
 $txt['admin_agreement_select_language_change'] = 'Change';
 $txt['admin_delete_members'] = 'Delete Selected Members';
 $txt['admin_repair'] = 'Repair All Boards and Topics';
-$txt['admin_main_welcome'] = 'This is your &quot;%1$s&quot;.  From here, you can edit settings, maintain your forum, view logs, install packages, manage themes, and many other things.<div style="margin-top: 1ex;">If you have any trouble, please look at the &quot;Support &amp; Credits&quot; page.  If the information there doesn\'t help you, feel free to <a href="http://www.simplemachines.org/community/index.php" target="_blank" class="new_win">look to us for help</a> with the problem.</div>You may also find answers to your questions or problems by clicking the <img src="' . $settings['images_url'] . '/helptopics.gif" alt="%2$s" title="%3$s" /> symbols for more information on the related functions.';
+$txt['admin_main_welcome'] = 'This is your &quot;%1$s&quot;.  From here, you can edit settings, maintain your forum, view logs, install packages, manage themes, and many other things.<div style="margin-top: 1ex;">If you have any trouble, please look at the &quot;Support &amp; Credits&quot; page.  If the information there doesn\'t help you, feel free to <a href="https://www.simplemachines.org/community/index.php" target="_blank" class="new_win">look to us for help</a> with the problem.</div>You may also find answers to your questions or problems by clicking the <img src="' . $settings['images_url'] . '/helptopics.gif" alt="%2$s" title="%3$s" /> symbols for more information on the related functions.';
 $txt['admin_news_desc'] = 'Please place one news item per box. BBC tags, such as <span title="Are you bold?">[b]</span>, <span title="I tall icks!!">[i]</span> and <span title="Brackets are great, no?">[u]</span> are allowed in your news, as well as smileys. Clear a news item\'s text box to remove it.';
 $txt['administrators'] = 'Forum Administrators';
 $txt['admin_reserved_desc'] = 'Reserved names will keep members from registering certain usernames or using these words in their displayed names. Choose the options you wish to use from the bottom before submitting.';
@@ -68,6 +73,8 @@ $txt['database_password'] = 'Database Password';
 $txt['database_name'] = 'Database Name';
 $txt['registration_agreement'] = 'Registration Agreement';
 $txt['registration_agreement_desc'] = 'This agreement is shown when a user registers an account on this forum and has to be accepted before users can continue registration.';
+$txt['privacy_policy'] = 'Privacy Policy';
+$txt['privacy_policy_desc'] = 'This privacy policy describes the promises you make to your users regarding how you will use their personal data. It is shown when a user registers an account on this forum and has to be accepted before the user can continue registration.';
 $txt['database_prefix'] = 'Database Tables Prefix';
 $txt['errors_list'] = 'Listing of forum errors';
 $txt['errors_found'] = 'The following errors are fouling up your forum';
@@ -103,7 +110,7 @@ $txt['remove_all'] = 'Remove All';
 $txt['approve_new_members'] = 'Admin must approve all new members';
 $txt['agreement_not_writable'] = 'Warning - agreement.txt is not writable, any changes you make will NOT be saved.';
 
-$txt['version_check_desc'] = 'This shows you the versions of your installation\'s files versus those of the latest version. If any of these files are out of date, you should download and upgrade to the latest version at <a href="http://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.';
+$txt['version_check_desc'] = 'This shows you the versions of your installation\'s files versus those of the latest version. If any of these files are out of date, you should download and upgrade to the latest version at <a href="https://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.';
 $txt['version_check_more'] = '(more detailed)';
 
 $txt['lfyi'] = 'You are unable to connect to simplemachines.org\'s latest news file.';
diff --git a/Themes/default/languages/Agreement.english.php b/Themes/default/languages/Agreement.english.php
new file mode 100644
index 0000000..89369db
--- /dev/null
+++ b/Themes/default/languages/Agreement.english.php
@@ -0,0 +1,15 @@
+<?php
+// Version: 2.0.16; Agreement
+
+$txt['agreement'] = 'Registration Agreement';
+$txt['agreement_updated'] = 'Updated Registration Agreement';
+$txt['agreement_updated_desc'] = 'You must accept the terms of the registration agreement in order to continue using the forum.';
+$txt['agreement_accepted'] = 'You accepted the terms of this agreement on %1$s.';
+$txt['privacy_policy'] = 'Privacy Policy';
+$txt['privacy_policy_updated'] = 'Updated Privacy Policy';
+$txt['privacy_policy_updated_desc'] = 'You must accept the terms of the privacy policy in order to continue using the forum.';
+$txt['privacy_policy_accepted'] = 'You accepted the terms of this privacy policy on %1$s.';
+$txt['agreement_and_privacy_policy'] = 'Registration Agreement and Privacy Policy';
+$txt['agree'] = 'I Agree';
+
+?>
\ No newline at end of file
diff --git a/Themes/default/languages/EmailTemplates.english.php b/Themes/default/languages/EmailTemplates.english.php
index bade6a4..7ced1ba 100644
--- a/Themes/default/languages/EmailTemplates.english.php
+++ b/Themes/default/languages/EmailTemplates.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; EmailTemplates
+// Version: 2.0.16; EmailTemplates
 
 // Since all of these strings are being used in emails, numeric entities should be used.
 
@@ -215,17 +215,21 @@ Should you have any problems with the activation, please visit {ACTIVATIONLINKWI
 				TOPICSUBJECT: The subject of the topic being announced.
 				MESSAGE: The message body of the first post of the announced topic.
 				TOPICLINK: A link to the topic being announced.
+				UNSUBSCRIBELINK: Link to unsubscribe from announcements.
 			@description:
 
 		*/
 		'subject' => 'New announcement: {TOPICSUBJECT}',
 		'body' => '{MESSAGE}
 
-To unsubscribe from these announcements, login to the forum and uncheck "Receive forum announcements and important notifications by email." in your profile.
-
 You can view the full announcement by following this link:
 {TOPICLINK}
 
+To unsubscribe from these announcements, follow this link:
+{UNSUBSCRIBELINK}
+
+For more control over the email notifications you receive, login to the forum and go to the Notification area in your profile.
+
 {REGARDS}',
 	),
 	'notify_boards_once_body' => array(
@@ -993,7 +997,7 @@ $birthdayEmails = array(
 We here at {FORUMNAME} would like to wish you a happy birthday.  May this day and the year to follow be full of joy.
 
 {REGARDS}',
-		'author' => '<a href="http://www.simplemachines.org/community/?action=profile;u=2676">Thantos</a>',
+		'author' => '<a href="https://www.simplemachines.org/community/?action=profile;u=2676">Thantos</a>',
 	),
 	'karlbenson1' => array(
 		'subject' => 'On your Birthday...',
@@ -1012,7 +1016,7 @@ We would like to wish you a very special birthday.
 {REGARDS}
 
 //:: This message was automatically generated :://',
-		'author' => '<a href="http://www.simplemachines.org/community/?action=profile;u=63186">karlbenson</a>',
+		'author' => '<a href="https://www.simplemachines.org/community/?action=profile;u=63186">karlbenson</a>',
 	),
 	'nite0859' => array(
 		'subject' => 'Happy Birthday!',
@@ -1022,7 +1026,7 @@ Even though today is your birthday, {REALNAME}, we would like to remind you that
 
 Best Wishes,
 The Staff of {FORUMNAME}',
-		'author' => '<a href="http://www.simplemachines.org/community/?action=profile;u=46625">nite0859</a>',
+		'author' => '<a href="https://www.simplemachines.org/community/?action=profile;u=46625">nite0859</a>',
 	),
 	'zwaldowski' => array(
 		'subject' => 'Birthday Wishes to {REALNAME}',
@@ -1031,7 +1035,7 @@ The Staff of {FORUMNAME}',
 Another year in your life has passed.  We at {FORUMNAME} hope it has been filled with happiness, and wish you luck in the coming one.
 
 {REGARDS}',
-		'author' => '<a href="http://www.simplemachines.org/community/?action=profile;u=72038">zwaldowski</a>',
+		'author' => '<a href="https://www.simplemachines.org/community/?action=profile;u=72038">zwaldowski</a>',
 	),
 	'geezmo' => array(
 		'subject' => 'Happy birthday, {REALNAME}!',
@@ -1046,7 +1050,7 @@ You\'re now a year older but we hope you\'re a lot happier than last year.
 Enjoy your day today, {REALNAME}!
 
 - From your {FORUMNAME} family',
-		'author' => '<a href="http://www.simplemachines.org/community/?action=profile;u=48671">geezmo</a>',
+		'author' => '<a href="https://www.simplemachines.org/community/?action=profile;u=48671">geezmo</a>',
 	),
 	'karlbenson2' => array(
 		'subject' => 'Your Birthday Greeting',
@@ -1056,7 +1060,7 @@ Have lots of birthday cake and fun, and tell us what you have done.
 We hope this message brought you cheer, and make it last, until same time same place, next year.
 
 {REGARDS}',
-		'author' => '<a href="http://www.simplemachines.org/community/?action=profile;u=63186">karlbenson</a>',
+		'author' => '<a href="https://www.simplemachines.org/community/?action=profile;u=63186">karlbenson</a>',
 	),
 );
 ?>
\ No newline at end of file
diff --git a/Themes/default/languages/Errors.english.php b/Themes/default/languages/Errors.english.php
index 233e65f..4e6e40b 100644
--- a/Themes/default/languages/Errors.english.php
+++ b/Themes/default/languages/Errors.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Errors
+// Version: 2.0.16; Errors
 
 global $scripturl, $modSettings;
 
@@ -403,6 +403,14 @@ $txt['restore_not_found'] = 'The following messages could not be restored; the o
 
 $txt['error_invalid_dir'] = 'The directory you entered is invalid.';
 
-$txt['error_sqlite_optimizing'] = 'Sqlite is optimizing the database, the forum can not be accessed until it has finished.  Please try refreshing this page momentarily.';$txt['filter_boards_notint'] = 'Please fill in only integer values seperated by commas!';
+$txt['error_sqlite_optimizing'] = 'Sqlite is optimizing the database, the forum can not be accessed until it has finished.  Please try refreshing this page momentarily.';
 
-?>
\ No newline at end of file
+// Registration Agreement
+$txt['error_no_agreement'] = 'There is no registration agreement to display!';
+$txt['error_no_privacy_policy'] = 'A privacy policy has not been created for this forum.';
+
+// Unsubscribe
+$txt['unsubscribe_invalid'] = 'The unsubscribe link that brought you here does not appear to be valid.';
+
+$txt['filter_boards_notint'] = 'Please fill in only integer values seperated by commas!';
+?>
diff --git a/Themes/default/languages/Help.english.php b/Themes/default/languages/Help.english.php
index 4cce814..c406fce 100644
--- a/Themes/default/languages/Help.english.php
+++ b/Themes/default/languages/Help.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Help
+// Version: 2.0.19; Help
 
 global $helptxt;
 
@@ -141,7 +141,7 @@ $helptxt['time_format'] = '<strong>Time Format</strong><br />
 	<em>* Does not work on Windows-based servers.</em></span>';
 
 $helptxt['live_news'] = '<strong>Live announcements</strong><br />
-	This box shows recently updated announcements from <a href="http://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.
+	This box shows recently updated announcements from <a href="https://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.
 	You should check here every now and then for updates, new releases, and important information from Simple Machines.';
 
 $helptxt['registrations'] = '<strong>Registration Management</strong><br />
@@ -281,7 +281,9 @@ $helptxt['databaseSession_loose'] = 'Turning this on will decrease the bandwidth
 $helptxt['databaseSession_lifetime'] = 'This is the number of seconds for sessions to last after they haven\'t been accessed.  If a session is not accessed for too long, it is said to have &quot;timed out&quot;.  Anything higher than 2400 is recommended.';
 $helptxt['enableErrorLogging'] = 'This will log any errors, like a failed login, so you can see what went wrong.';
 $helptxt['enableErrorQueryLogging'] = 'This will include the full query sent to the database in the error log.  Requires error logging to be turned on.<br /><br /><strong>Note:  This will affect the ability to filter the error log by the error message.</strong>';
-$helptxt['allow_disableAnnounce'] = 'This will allow users to opt out of notification of topics you announce by checking the &quot;announce topic&quot; checkbox when posting.';
+$helptxt['allow_disableAnnounce'] = 'This will allow users to opt out of notification of topics you announce by checking the &quot;announce topic&quot; checkbox when posting.<br /><br />This setting must be enabled in order to comply with the rules of the <a href="https://ec.europa.eu/info/law/law-topic/data-protection_en" class="bbc_link">GDPR</a>.';
+$helptxt['announcements_default'] = 'This simply controls whether the the checkbox on the registration form starts as checked or unchecked.<br /><br />This setting must be disabled in order to comply with the rules of the <a href="https://ec.europa.eu/info/law/law-topic/data-protection_en" class="bbc_link">GDPR</a>.';
+$helptxt['notify_tokens'] = 'When this setting is enabled, the unsubscribe link included in every notification email includes a unique token to identify an unsubscribe request as legitimate. Without this, users must instead log into the forum to verify their identities before being allowed to unsubscribe.<br /><br />This setting must be enabled in order to comply with the rules of the <a href="https://ec.europa.eu/info/law/law-topic/data-protection_en" class="bbc_link">GDPR</a>.';
 $helptxt['disallow_sendBody'] = 'This option removes the option to receive the text of replies and posts in notification emails.<br /><br />Often, members will reply to the notification email, which in most cases means the webmaster receives the reply.';
 $helptxt['compactTopicPagesEnable'] = 'This will just show a selection of the number of pages.<br /><em>Example:</em>
 		&quot;3&quot; to display: 1 ... 4 [5] 6 ... 9 <br />
@@ -361,6 +363,7 @@ $helptxt['globalCookies'] = 'Makes log in cookies available across subdomains.
 	And your forum is at http://forum.simplemachines.org/,<br />
 	Using this option will allow you to access the forum\'s cookie on your site.  Do not enable this if there are other subdomains (like hacker.simplemachines.org) not controlled by you.';
 $helptxt['secureCookies'] = 'Enabling this option will force the cookies created for users on your forum to be marked as secure. Only enable this option if you are using HTTPS throughout your site as it will break cookie handling otherwise!';
+$helptxt['cookie_no_auth_secret'] = 'This option forces SMF to use a weaker form of authentication for login cookies. It should only be enabled if you need backwards compatibility with login integration mods that have not yet been updated to support SMF 2.0.16 and higher.';
 $helptxt['securityDisable'] = 'This <em>disables</em> the additional password check for the administration section. This is not recommended!';
 $helptxt['securityDisable_why'] = 'This is your current password. (the same one you use to login.)<br /><br />Having to type this helps ensure that you want to do whatever administration you are doing, and that it is <strong>you</strong> doing it.';
 $helptxt['emailmembers'] = 'In this message you can use a few &quot;variables&quot;.  These are:<br />
@@ -454,6 +457,9 @@ $helptxt['password_strength'] = 'This setting determines the strength required f
 		<li><strong>High:</strong> As for medium, except the password must also contain a mixture of upper and lower case letters, and at least one number.</li>
 	</ul>';
 
+$helptxt['requireAgreement'] = 'This setting must be enabled in order to comply with the rules of the <a href="https://ec.europa.eu/info/law/law-topic/data-protection_en" class="bbc_link">GDPR</a>.';
+$helptxt['requirePolicyAgreement'] = 'This setting must be enabled in order to comply with the rules of the <a href="https://ec.europa.eu/info/law/law-topic/data-protection_en" class="bbc_link">GDPR</a>.';
+
 $helptxt['coppaAge'] = 'The value specified in this box will determine the minimum age that new members must be to be granted immediate access to the forums.
 	On registration they will be prompted to confirm whether they are over this age, and if not will either have their application rejected or suspended awaiting parental approval - dependant on the type of restriction chosen.
 	If a value of 0 is chosen for this setting then all other age restriction settings shall be ignored.';
@@ -474,9 +480,9 @@ $helptxt['allow_hideOnline'] = 'With this option enabled all members will be abl
 $helptxt['make_email_viewable'] = 'If this option is enabled instead of users email addresses being hidden to normal members and guests they will be publicly viewable on the forum. Enabling this will put your users at greater risk of being victims of spam as a result of email harvesters visiting your forum. Note this setting does not override the user setting for hiding their email address from users. Enabling this setting is <strong>not</strong> recommended.';
 $helptxt['meta_keywords'] = 'These keywords are sent in the output of every page to indicate to search engines (etc) the key content of your site. They should be a comma separated list of words, and should not use HTML.';
 
-$helptxt['latest_support'] = 'This panel shows you some of the most common problems and questions on your server configuration. Don\'t worry, this information isn\'t logged or anything.<br /><br />If this stays as &quot;Retrieving support information...&quot;, your computer probably cannot connect to <a href="http://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.';
-$helptxt['latest_packages'] = 'Here you can see some of the most popular and some random packages or mods, with quick and easy installations.<br /><br />If this section doesn\'t show up, your computer probably cannot connect to <a href="http://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.';
-$helptxt['latest_themes'] = 'This area shows a few of the latest and most popular themes from <a href="http://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.  It may not show up properly if your computer can\'t find <a href="http://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>, though.';
+$helptxt['latest_support'] = 'This panel shows you some of the most common problems and questions on your server configuration. Don\'t worry, this information isn\'t logged or anything.<br /><br />If this stays as &quot;Retrieving support information...&quot;, your computer probably cannot connect to <a href="https://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.';
+$helptxt['latest_packages'] = 'Here you can see some of the most popular and some random packages or mods, with quick and easy installations.<br /><br />If this section doesn\'t show up, your computer probably cannot connect to <a href="https://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.';
+$helptxt['latest_themes'] = 'This area shows a few of the latest and most popular themes from <a href="https://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.  It may not show up properly if your computer can\'t find <a href="https://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>, though.';
 
 $helptxt['secret_why_blank'] = 'For your security, your password and the answer to your secret question are encrypted so that the SMF software will never tell you, or anyone else, what they are.';
 $helptxt['moderator_why_missing'] = 'Since moderation is done on a board-by-board basis, you have to make members moderators from the <a href="javascript:window.open(\'%1$s?action=admin;area=manageboards\'); self.close();">board management interface</a>.';
@@ -606,4 +612,7 @@ $helptxt['gpbp_threshold'] = 'Depending on each user\'s Theme and Layout configu
 $helptxt['gpbp_display_respect'] = 'Respect is the sum of all received votes. Negative votes substract from this value.';
 
 
-?>
\ No newline at end of file
+$helptxt['image_proxy_enabled'] = 'Whether to enable the image proxy';
+$helptxt['image_proxy_secret'] = 'Keep this a secret, protects your forum from hotlinking images. Change it in order to render current hotlinked images useless';
+$helptxt['image_proxy_maxsize'] = 'Maximum image size that the image proxy will cache: bigger images will be not be cached. Cached images are stored in your SMF cache folder, so make sure you have enough free space.';
+?>
diff --git a/Themes/default/languages/Install.english.php b/Themes/default/languages/Install.english.php
index ced98ca..ba0e677 100644
--- a/Themes/default/languages/Install.english.php
+++ b/Themes/default/languages/Install.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Install
+// Version: 2.0.16; Install
 
 // These should be the same as those in index.language.php.
 $txt['lang_character_set'] = 'ISO-8859-1';
@@ -17,7 +17,7 @@ $txt['smf_installer'] = 'SMF Installer';
 $txt['installer_language'] = 'Language';
 $txt['installer_language_set'] = 'Set';
 $txt['congratulations'] = 'Congratulations, the installation process is complete!';
-$txt['congratulations_help'] = 'If at any time you need support, or SMF fails to work properly, please remember that <a href="http://www.simplemachines.org/community/index.php" target="_blank">help is available</a> if you need it.';
+$txt['congratulations_help'] = 'If at any time you need support, or SMF fails to work properly, please remember that <a href="https://www.simplemachines.org/community/index.php" target="_blank">help is available</a> if you need it.';
 $txt['still_writable'] = 'Your installation directory is still writable.  It\'s a good idea to chmod it so that it is not writable for security reasons.';
 $txt['delete_installer'] = 'Click here to delete this install.php file now.';
 $txt['delete_installer_maybe'] = '<em>(doesn\'t work on all servers.)</em>';
@@ -32,7 +32,7 @@ $txt['user_refresh_install'] = 'Forum Refreshed';
 $txt['user_refresh_install_desc'] = 'While installing, the installer found that (with the details you provided) one or more of the tables this installer might create already existed.<br />Any missing tables in your installation have been recreated with the default data, but no data was deleted from existing tables.';
 
 $txt['default_topic_subject'] = 'Welcome to SMF!';
-$txt['default_topic_message'] = 'Welcome to Simple Machines Forum!<br /><br />We hope you enjoy using your forum.&nbsp; If you have any problems, please feel free to [url=http://www.simplemachines.org/community/index.php]ask us for assistance[/url].<br /><br />Thanks!<br />Simple Machines';
+$txt['default_topic_message'] = 'Welcome to Simple Machines Forum!<br /><br />We hope you enjoy using your forum.&nbsp; If you have any problems, please feel free to [url=https://www.simplemachines.org/community/index.php]ask us for assistance[/url].<br /><br />Thanks!<br />Simple Machines';
 $txt['default_board_name'] = 'General Discussion';
 $txt['default_board_description'] = 'Feel free to talk about anything and everything in this board.';
 $txt['default_category_name'] = 'General Category';
@@ -106,7 +106,7 @@ $txt['install_settings_utf8_title'] = 'Use UTF-8 as default character set';
 $txt['install_settings_utf8_info'] = 'This feature lets both the database and the forum use an international character set, UTF-8. This can be useful when working with multiple languages that use different character sets.';
 $txt['install_settings_stats'] = 'Allow Stat Collection';
 $txt['install_settings_stats_title'] = 'Allow Simple Machines to Collect Basic Stats Monthly';
-$txt['install_settings_stats_info'] = 'If enabled, this will allow Simple Machines to visit your site once a month to collect basic statistics. This will help us make decisions as to which configurations to optimize the software for. For more information please visit our <a href="http://www.simplemachines.org/about/stats.php" target="_blank">info page</a>.';
+$txt['install_settings_stats_info'] = 'If enabled, this will allow Simple Machines to visit your site once a month to collect basic statistics. This will help us make decisions as to which configurations to optimize the software for. For more information please visit our <a href="https://www.simplemachines.org/about/stats.php" target="_blank">info page</a>.';
 $txt['install_settings_proceed'] = 'Proceed';
 
 $txt['db_settings'] = 'Database Server Settings';
@@ -126,7 +126,7 @@ $txt['db_settings_database_file'] = 'Database filename';
 $txt['db_settings_database_file_info'] = 'This is the name of the file in which to store the SMF data. We recommend you use the randomly generated name for this and set the path of this file to be outside of the public area of your webserver.';
 $txt['db_settings_prefix'] = 'Table prefix';
 $txt['db_settings_prefix_info'] = 'The prefix for every table in the database.  <strong>Do not install two forums with the same prefix!</strong><br />This value allows for multiple installations in one database.';
-$txt['db_sqlite_warning'] = 'Only recommended for small, low volume and/or intranet-type forums';
+$txt['db_sqlite_warning'] = 'Only recommended for small, low volume and/or intranet-type forums. In future versions, this will be removed!';
 $txt['db_populate'] = 'Populated Database';
 $txt['db_populate_info'] = 'Your settings have now been saved and the database has been populated with all the data required to get your forum up and running. Summary of population:';
 $txt['db_populate_info2'] = 'Click &quot;Continue&quot; to progress to the admin account creation page.';
@@ -190,14 +190,14 @@ $txt['error_user_settings_query'] = 'A database error occurred while trying to c
 $txt['error_subs_missing'] = 'Unable to find the Sources/Subs.php file.  Please make sure it was uploaded properly, and then try again.';
 $txt['error_db_alter_priv'] = 'The database account you specified does not have permission to ALTER, CREATE, and/or DROP tables in the database; this is necessary for SMF to function properly.';
 $txt['error_versions_do_not_match'] = 'The installer has detected another version of SMF already installed with the specified information.  If you are trying to upgrade, you should use the upgrader, not the installer.<br /><br />Otherwise, you may wish to use different information, or create a backup and then delete the data currently in the database.';
-$txt['error_mod_security'] = 'The installer has detected the mod_security module is installed on your web server. Mod_security will block submitted forms even before SMF gets a say in anything. SMF has a built-in security scanner that will work more effectively than mod_security and that won\'t block submitted forms.<br /><br /><a href="http://www.simplemachines.org/redirect/mod_security">More information about disabling mod_security</a>';
-$txt['error_mod_security_no_write'] = 'The installer has detected the mod_security module is installed on your web server. Mod_security will block submitted forms even before SMF gets a say in anything. SMF has a built-in security scanner that will work more effectively than mod_security and that won\'t block submitted forms.<br /><br /><a href="http://www.simplemachines.org/redirect/mod_security">More information about disabling mod_security</a><br /><br />Alternatively, you may wish to use your ftp client to chmod .htaccess in the forum directory to be writable (777), and then refresh this page.';
+$txt['error_mod_security'] = 'The installer has detected the mod_security module is installed on your web server. Mod_security will block submitted forms even before SMF gets a say in anything. SMF has a built-in security scanner that will work more effectively than mod_security and that won\'t block submitted forms.<br /><br /><a href="https://www.simplemachines.org/redirect/mod_security">More information about disabling mod_security</a>';
+$txt['error_mod_security_no_write'] = 'The installer has detected the mod_security module is installed on your web server. Mod_security will block submitted forms even before SMF gets a say in anything. SMF has a built-in security scanner that will work more effectively than mod_security and that won\'t block submitted forms.<br /><br /><a href="https://www.simplemachines.org/redirect/mod_security">More information about disabling mod_security</a><br /><br />Alternatively, you may wish to use your ftp client to chmod .htaccess in the forum directory to be writable (777), and then refresh this page.';
 $txt['error_utf8_version'] = 'The current version of your database doesn\'t support the use of the UTF-8 character set. You can still install SMF without any problems, but only with UTF-8 support unchecked. If you would like to switch over to UTF-8 in the future (e.g. after the database server of your forum has been upgraded to version >= %1$s), you can convert your forum to UTF-8 through the admin panel.';
 $txt['error_valid_email_needed'] = 'You have not entered a valid email address.';
-$txt['error_already_installed'] = 'The installer has detected that you already have SMF installed. It is strongly advised that you do <strong>not</strong> try to overwrite an existing installation - continuing with installation <strong>may result in the loss or corruption of existing data</strong>.<br /><br />If you wish to upgrade please visit the <a href="http://www.simplemachines.org">Simple Machines Website</a> and download the latest <em>upgrade</em> package.<br /><br />If you wish to overwrite your existing installation, including all data, it\'s recommended that you delete the existing database tables and replace Settings.php and try again.';
+$txt['error_already_installed'] = 'The installer has detected that you already have SMF installed. It is strongly advised that you do <strong>not</strong> try to overwrite an existing installation - continuing with installation <strong>may result in the loss or corruption of existing data</strong>.<br /><br />If you wish to upgrade please visit the <a href="https://www.simplemachines.org">Simple Machines Website</a> and download the latest <em>upgrade</em> package.<br /><br />If you wish to overwrite your existing installation, including all data, it\'s recommended that you delete the existing database tables and replace Settings.php and try again.';
 $txt['error_warning_notice'] = 'Warning!';
 $txt['error_script_outdated'] = 'This install script is out of date! The current version of SMF is %1$s but this install script is for %2$s.<br /><br />
-	It is recommended that you visit the <a href="http://www.simplemachines.org">Simple Machines</a> website to ensure you are installing the latest version.';
+	It is recommended that you visit the <a href="https://www.simplemachines.org">Simple Machines</a> website to ensure you are installing the latest version.';
 $txt['error_db_filename'] = 'You must enter a name for the database file name for SQLite.';
 $txt['error_db_prefix_numeric'] = 'The selected database type does not support the use of numeric prefixes.';
 $txt['error_invalid_characters_username'] = 'Invalid character used in Username.';
@@ -227,9 +227,9 @@ $txt['upgrade_paused_overload'] = 'This upgrade has been paused to avoid overloa
 
 $txt['upgrade_ready_proceed'] = 'Thank you for choosing to upgrade to SMF %1$s. All files appear to be in place, and we\'re ready to proceed.';
 
-$txt['upgrade_error_script_js'] = 'The upgrade script cannot find script.js or it is out of date. Make sure your theme paths are correct. You can download a setting checker tool from the <a href="http://www.simplemachines.org">Simple Machines Website</a>';
+$txt['upgrade_error_script_js'] = 'The upgrade script cannot find script.js or it is out of date. Make sure your theme paths are correct. You can download a setting checker tool from the <a href="https://www.simplemachines.org">Simple Machines Website</a>';
 
 $txt['upgrade_warning_lots_data'] = 'This upgrade script has detected that your forum contains a lot of data which needs upgrading. This process may take quite some time depending on your server and forum size, and for very large forums (~300,000 messages) may take several hours to complete.';
-$txt['upgrade_warning_out_of_date'] = 'This upgrade script is out of date! The current version of SMF is <em id="smfVersion" style="white-space: nowrap;">??</em> but this upgrade script is for <em id="yourVersion" style="white-space: nowrap;">%1$s</em>.<br /><br />It is recommended that you visit the <a href="http://www.simplemachines.org">Simple Machines</a> website to ensure you are upgrading to the latest version.';
+$txt['upgrade_warning_out_of_date'] = 'This upgrade script is out of date! The current version of SMF is <em id="smfVersion" style="white-space: nowrap;">??</em> but this upgrade script is for <em id="yourVersion" style="white-space: nowrap;">%1$s</em>.<br /><br />It is recommended that you visit the <a href="https://www.simplemachines.org">Simple Machines</a> website to ensure you are upgrading to the latest version.';
 
 ?>
\ No newline at end of file
diff --git a/Themes/default/languages/Login.english.php b/Themes/default/languages/Login.english.php
index d21d092..e09dc63 100644
--- a/Themes/default/languages/Login.english.php
+++ b/Themes/default/languages/Login.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Login
+// Version: 2.0.16; Login
 
 global $context;
 
@@ -8,6 +8,10 @@ $txt['registration_agreement'] = 'Registration Agreement';
 $txt['agreement_agree'] = 'I accept the terms of the agreement.';
 $txt['agreement_agree_coppa_above'] = 'I accept the terms of the agreement and I am at least %1$d years old.';
 $txt['agreement_agree_coppa_below'] = 'I accept the terms of the agreement and I am younger than %1$d years old.';
+$txt['privacy_policy'] = 'Privacy Policy';
+$txt['agreement_policy_agree'] = 'I accept the terms of the agreement and privacy policy.';
+$txt['agreement_policy_agree_coppa_above'] = 'I accept the terms of the agreement and privacy policy, and I am at least %1$d years old.';
+$txt['agreement_policy_agree_coppa_below'] = 'I accept the terms of the agreement and privacy policy, and I am younger than %1$d years old.';
 
 // Registration form.
 $txt['registration_form'] = 'Registration Form';
@@ -95,6 +99,8 @@ $txt['setting_coppaPost_desc'] = 'Only applies if age restriction is in place';
 $txt['setting_coppaFax'] = 'Fax number to which approval forms should be faxed';
 $txt['setting_coppaPhone'] = 'Contact number for parents to contact with age restriction queries';
 
+$txt['setting_announcements_default'] = 'Enable "' . $txt['notify_announcements'] . '" by default.';
+
 $txt['admin_register'] = 'Registration of new member';
 $txt['admin_register_desc'] = 'From here you can register new members into the forum, and if desired, email them their details.';
 $txt['admin_register_username'] = 'New Username';
@@ -110,6 +116,8 @@ $txt['admin_register_group'] = 'Primary Membergroup';
 $txt['admin_register_group_desc'] = 'Primary membergroup new member will belong to';
 $txt['admin_register_group_none'] = '(no primary membergroup)';
 $txt['admin_register_done'] = 'Member %1$s has been registered successfully!';
+$txt['admin_register_require_agreement'] = 'Require user to accept the registration agreement';
+$txt['admin_register_require_policy'] = 'Require user to accept the privacy policy';
 
 $txt['coppa_title'] = 'Age Restricted Forum';
 $txt['coppa_after_registration'] = 'Thank you for registering with ' . $context['forum_name_html_safe'] . '.<br /><br />Because you fall under the age of {MINIMUM_AGE}, it is a legal requirement
diff --git a/Themes/default/languages/ManageSettings.english.php b/Themes/default/languages/ManageSettings.english.php
index b7859c9..b978522 100644
--- a/Themes/default/languages/ManageSettings.english.php
+++ b/Themes/default/languages/ManageSettings.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; ManageSettings
+// Version: 2.0.19; ManageSettings
 
 global $scripturl;
 
@@ -47,12 +47,14 @@ $txt['cookieTime'] = 'Default login cookies length (in minutes)';
 $txt['localCookies'] = 'Enable local storage of cookies<div class="smalltext">(SSI won\'t work well with this on.)</div>';
 $txt['globalCookies'] = 'Use subdomain independent cookies<div class="smalltext">(turn off local cookies first!)</div>';
 $txt['secureCookies'] = 'Force cookies to be secure<div class="smalltext">(This only applies if you are using HTTPS - don\'t use otherwise!)</div>';
+$txt['cookie_no_auth_secret'] = 'Use basic cookie authentication';
 $txt['securityDisable'] = 'Disable administration security';
 $txt['send_validation_onChange'] = 'Require reactivation after email change';
 $txt['approveAccountDeletion'] = 'Require admin approval when member deletes account';
 $txt['autoOptMaxOnline'] = 'Maximum users online when optimizing<div class="smalltext">(0 for no max.)</div>';
 $txt['autoFixDatabase'] = 'Automatically fix broken tables';
 $txt['allow_disableAnnounce'] = 'Allow users to disable announcements';
+$txt['notify_tokens'] = 'Use token-based unsubscribe links in notification emails<div class="smalltext">Allows users to unsubscribe without logging in.</div>';
 $txt['disallow_sendBody'] = 'Don\'t allow post text in notifications';
 $txt['queryless_urls'] = 'Search engine friendly URLs<div class="smalltext"><strong>Apache/Lighttpd only!</strong></div>';
 $txt['max_image_width'] = 'Max width of posted pictures (0 = disable)';
@@ -77,6 +79,13 @@ $txt['disableHostnameLookup'] = 'Disable hostname lookups';
 $txt['who_enabled'] = 'Enable who\'s online list';
 $txt['make_email_viewable'] = 'Allow viewable email addresses';
 $txt['meta_keywords'] = 'Meta keywords associated with forum<div class="smalltext">For search engines. Leave blank for default.</div>';
+$txt['image_proxy_enabled'] = 'Enable Image Proxy';
+$txt['image_proxy_enabled_desc'] = 'This will proxy images posted within <b>[img]</b> tags.</b>';
+$txt['image_proxy_secret'] = 'Image Proxy Secret';
+$txt['image_proxy_secret_desc'] = 'This should be unique to your site. Be sure to keep it a secret.';
+$txt['image_proxy_maxsize'] = 'Maximum file size of images to cache';
+$txt['image_proxy_maxsize_postinput'] = 'KB';
+$txt['image_proxy_maxsize_desc'] = 'Images above this threshold are still shown.';
 
 $txt['karmaMode'] = 'Karma mode';
 $txt['karma_options'] = 'Disable karma|Enable karma total|Enable karma positive/negative';
@@ -292,6 +301,9 @@ $txt['core_settings_item_sp'] = 'Search Engine Tracking';
 $txt['core_settings_item_sp_desc'] = 'Enabling this feature will allow administrators to track search engines as they index your forum.';
 $txt['core_settings_item_w'] = 'Warning System';
 $txt['core_settings_item_w_desc'] = 'This functionality allows administrators and moderators to issue warnings to users; it also includes advanced functionality for automatically removing user rights as their warning level increases. Note to take full advantage of this function &quot;Post Moderation&quot; should be enabled.';
+$txt['core_settings_item_gdpr'] = 'GDPR Compliance';
+$txt['core_settings_item_gdpr_desc'] = 'Enabling this feature will configure a number of settings on your forum to make it compliant with the European Union\'s <a href="https://ec.europa.eu/info/law/law-topic/data-protection_en" class="bbc_link">General Data Protection Regulation</a>.';
+$txt['core_settings_privacy_policy_warning'] = 'The GDPR requires you to have a privacy policy for your forum. After you enable this setting, you will be take to a page where you can create one.';
 $txt['core_settings_switch_on'] = 'Click to Enable';
 $txt['core_settings_switch_off'] = 'Click to Disable';
 $txt['core_settings_enabled'] = 'Enabled';
diff --git a/Themes/default/languages/Modlog.english.php b/Themes/default/languages/Modlog.english.php
index dd19970..b225d3d 100644
--- a/Themes/default/languages/Modlog.english.php
+++ b/Themes/default/languages/Modlog.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Modlog
+// Version: 2.0.16; Modlog
 
 global $scripturl;
 
@@ -52,6 +52,7 @@ $txt['modlog_ac_ban_trigger_hostname'] = ' <em>Hostname:</em> {hostname}';
 $txt['modlog_admin_log'] = 'Administration Log';
 $txt['modlog_admin_log_desc'] = 'Below is a list of administration actions which have been logged on your forum.<br /><strong>Please note:</strong> Entries cannot be removed from this log until they are at least twenty-four hours old.';
 $txt['modlog_admin_log_no_entries_found'] = 'There are currently no administration log entries.';
+$txt['modlog_admin_log_gdpr_no_delete'] = '<strong>Also note:</strong> Entries for updates to the registration agreement and privacy policy cannot be removed from this log while the GDPR Compliance setting is enabled.';
 
 // Admin type strings.
 $txt['modlog_ac_upgrade'] = 'Upgraded the forum to version {version}';
@@ -70,6 +71,9 @@ $txt['modlog_ac_added_to_group'] = 'Added &quot;{member}&quot; to the &quot;{gro
 $txt['modlog_ac_removed_from_group'] = 'Removed &quot;{member}&quot; from the &quot;{group}&quot; group';
 $txt['modlog_ac_removed_all_groups'] = 'Removed &quot;{member}&quot; from all groups';
 
+$txt['modlog_ac_agreement_updated'] = 'Updated the {language} registration agreement';
+$txt['modlog_ac_policy_updated'] = 'Updated the {language} privacy policy';
+
 $txt['modlog_ac_remind_member'] = 'Sent out a reminder to &quot;{member}&quot; to activate their account';
 $txt['modlog_ac_approve_member'] = 'Approved/Activated the account of &quot;{member}&quot;';
 $txt['modlog_ac_newsletter'] = 'Sent Newsletter';
diff --git a/Themes/default/languages/Profile.english.php b/Themes/default/languages/Profile.english.php
index 2cdf006..5ab0680 100644
--- a/Themes/default/languages/Profile.english.php
+++ b/Themes/default/languages/Profile.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Profile
+// Version: 2.0.18; Profile
 
 global $scripturl, $context;
 
@@ -290,7 +290,6 @@ $txt['display_quick_mod_check'] = 'checkboxes.';
 $txt['display_quick_mod_image'] = 'icons.';
 
 $txt['whois_title'] = 'Look up IP on a regional whois-server';
-$txt['whois_afrinic'] = 'AfriNIC (Africa)';
 $txt['whois_apnic'] = 'APNIC (Asia Pacific region)';
 $txt['whois_arin'] = 'ARIN (North America, a portion of the Caribbean and sub-Saharan Africa)';
 $txt['whois_lacnic'] = 'LACNIC (Latin American and Caribbean region)';
@@ -471,4 +470,10 @@ $txt['filter_boards'] = 'Filter to certain boards:';
 $txt['current_filtered_boards'] = 'Currently viewing by boards:';
 $txt['filter_boards_submit'] = 'Filter';
 
+// Registration Agreement
+$txt['trackEdit_action_agreement_accepted'] = 'Accepted the registration agreement';
+$txt['trackEdit_action_policy_accepted'] = 'Accepted the privacy policy';
+
+$txt['export_profile_data'] = 'Download profile data';
+
 ?>
\ No newline at end of file
diff --git a/Themes/default/languages/Who.english.php b/Themes/default/languages/Who.english.php
index 84148b1..01f0723 100644
--- a/Themes/default/languages/Who.english.php
+++ b/Themes/default/languages/Who.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Who
+// Version: 2.0.16; Who
 
 global $scripturl, $context;
 
@@ -150,6 +150,7 @@ $txt['credits_groups_beta'] = 'Beta Testers';
 $txt['credits_beta_message'] = 'The invaluable few who tirelessly find bugs, provide feedback, and drive the developers crazier.';
 $txt['credits_groups_founder'] = 'Founding Father of SMF';
 $txt['credits_groups_orignal_pm'] = 'Original Project Managers';
+$txt['credits_in_memoriam'] = 'In loving memory of';
 
 // List of people who have made more than a token contribution to this translation. (blank for English)
 $txt['translation_credits'] = array();
diff --git a/Themes/default/languages/index.english.php b/Themes/default/languages/index.english.php
index f13087b..dd7ea6f 100644
--- a/Themes/default/languages/index.english.php
+++ b/Themes/default/languages/index.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0.12; index
+// Version: 2.0.18; index
 
 global $forum_copyright, $forum_version, $webmaster_email, $scripturl, $context, $boardurl;
 
@@ -106,6 +106,7 @@ $txt['admin_login'] = 'Administration Login';
 // Use numeric entities in the below string.
 $txt['topic'] = 'Topic';
 $txt['help'] = 'Help';
+$txt['terms_and_policies'] = 'Terms and Policies';
 $txt['notify'] = 'Notify';
 $txt['unnotify'] = 'Unnotify';
 $txt['notify_request'] = 'Do you want a notification email if someone replies to this topic?';
@@ -436,7 +437,7 @@ $txt['go_up'] = 'Go Up';
 $txt['go_down'] = 'Go Down';
 
 $forum_copyright = '<a href="' . $scripturl . '?action=credits" title="Simple Machines Forum" target="_blank" class="new_win">%1$s</a> |
- <a href="http://www.simplemachines.org/about/smf/license.php" title="License" target="_blank" class="new_win">SMF &copy; 2016</a>, <a href="http://www.simplemachines.org" title="Simple Machines" target="_blank" class="new_win">Simple Machines</a>';
+ <a href="https://www.simplemachines.org/about/smf/license.php" title="License" target="_blank" class="new_win">SMF &copy; 2021</a>, <a href="https://www.simplemachines.org" title="Simple Machines" target="_blank" class="new_win">Simple Machines</a>';
 
 $txt['birthdays'] = 'Birthdays:';
 $txt['events'] = 'Events:';
@@ -619,6 +620,19 @@ $txt['approve_members_waiting'] = 'awaiting approval.';
 
 $txt['notifyboard_turnon'] = 'Do you want a notification email when someone posts a new topic in this board?';
 $txt['notifyboard_turnoff'] = 'Are you sure you do not want to receive new topic notifications for this board?';
+$txt['notifyboard_subscribed'] = '%1$s has been subscribed to new topic notifications for this board.';
+$txt['notifyboard_unsubscribed'] = '%1$s has been unsubscribed from new topic notifications for this board.';
+
+$txt['notifytopic_subscribed'] = '%1$s has been subscribed to new reply notifications for this topic.';
+$txt['notifytopic_unsubscribed'] = '%1$s has been unsubscribed from new reply notifications for this topic.';
+
+$txt['notify_announcements'] = 'Allow the administrators to send me important news by email';
+$txt['notifyannouncements_prompt'] = 'Do you want to receive forum newsletters, announcements and important notifications by email?';
+$txt['notifyannouncements_subscribed'] = '%1$s has been subscribed to forum newsletters, announcements and important notifications.';
+$txt['notifyannouncements_unsubscribed'] = '%1$s has been unsubscribed from forum newsletters, announcements and important notifications.';
+
+$txt['unsubscribe_announcements_plain'] = 'To unsubscribe from forum newsletters, announcements and important notifications, follow this link:<br />%1$s';
+$txt['unsubscribe_announcements_html'] = '<span style="font-size:small"><a href="%1$s">Unsubscribe</a> from forum newsletters, announcements and important notifications.</span>';
 
 $txt['activate_code'] = 'Your activation code is';
 
diff --git a/Themes/default/scripts/script.js b/Themes/default/scripts/script.js
index e45c7c1..789b65d 100644
--- a/Themes/default/scripts/script.js
+++ b/Themes/default/scripts/script.js
@@ -144,17 +144,26 @@ String.prototype.php_to8bit = function ()
 	{
 		var n, sReturn = '';
 
+		// Recode from UTF16 (native .js) to UTF8
 		for (var i = 0, iTextLen = this.length; i < iTextLen; i++)
 		{
+			// Below xFFFF, UTF16 simply = the code points
 			n = this.charCodeAt(i);
 			if (n < 128)
-				sReturn += String.fromCharCode(n)
+				sReturn += String.fromCharCode(n);
 			else if (n < 2048)
 				sReturn += String.fromCharCode(192 | n >> 6) + String.fromCharCode(128 | n & 63);
-			else if (n < 65536)
-				sReturn += String.fromCharCode(224 | n >> 12) + String.fromCharCode(128 | n >> 6 & 63) + String.fromCharCode(128 | n & 63);
-			else
+			// 0xD800 - 0xDBFF
+			else if (n >= 55296 && n <= 56319)
+			{
+				// In this range, this is the beginning of a surrogate pair, where 4-byte utf8 chars are
+				n = 65536 + ((n & 1023) << 10) + (this.charCodeAt(i + 1) & 1023);
 				sReturn += String.fromCharCode(240 | n >> 18) + String.fromCharCode(128 | n >> 12 & 63) + String.fromCharCode(128 | n >> 6 & 63) + String.fromCharCode(128 | n & 63);
+				// Skip next char, already used...
+				i++;
+			}
+			else
+				sReturn += String.fromCharCode(224 | n >> 12) + String.fromCharCode(128 | n >> 6 & 63) + String.fromCharCode(128 | n & 63);
 		}
 
 		return sReturn;
@@ -1360,7 +1369,11 @@ function smfSelectText(oCurElement, bActOnElement)
 	{
 		var oCurSelection = window.getSelection();
 		// Safari is special!
-		if (oCurSelection.setBaseAndExtent)
+		if (oCurSelection.selectAllChildren)
+		{
+			oCurSelection.selectAllChildren(oCodeArea);
+		}
+		else if (oCurSelection.setBaseAndExtent)
 		{
 			var oLastChild = oCodeArea.lastChild;
 			oCurSelection.setBaseAndExtent(oCodeArea, 0, oLastChild, 'innerText' in oLastChild ? oLastChild.innerText.length : oLastChild.textContent.length);
diff --git a/index.php b/index.php
index e794bca..df4d64a 100644
--- a/index.php
+++ b/index.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.13
+ * @version 2.0.19
  */
 
 /*	This, as you have probably guessed, is the crux on which SMF functions.
@@ -22,12 +22,12 @@
 	with the URL index.php?action=action-in-url.  Relatively simple, no?
 */
 
-$forum_version = 'SMF 2.0.13';
+$forum_version = 'SMF 2.0.19';
 @ini_set('memory_limit', '128M');
 
 // Get everything started up...
 define('SMF', 1);
-if (function_exists('set_magic_quotes_runtime'))
+if (version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('set_magic_quotes_runtime'))
 	@set_magic_quotes_runtime(0);
 error_reporting(defined('E_STRICT') ? E_ALL | E_STRICT : E_ALL);
 $time_start = microtime();
@@ -65,6 +65,9 @@ if (!empty($maintenance) && $maintenance == 2)
 // Create a variable to store some SMF specific functions in.
 $smcFunc = array();
 
+// Register an error handler.
+set_error_handler('error_handler');
+
 // Initate the database connection and define some database functions to use.
 loadDatabase();
 
@@ -107,8 +110,25 @@ if (!headers_sent())
 	header('X-Content-Type-Options: nosniff');
 }
 
-// Register an error handler.
-set_error_handler('error_handler');
+// Quickly catch random exceptions.
+set_exception_handler(function ($e) use ($db_show_debug)
+{
+	$error_type = 'general';
+
+	// PHP 7 converts fatal errors to special Throwable types. Log them as such.
+	if (is_a($e, 'Error'))
+		$error_type = 'critical';
+
+	if (isset($db_show_debug) && $db_show_debug === true && allowedTo('admin_forum'))
+	{
+		// Only log the message; the rest (such as the stack trace) is just fluff in the log.
+		log_error($e->getMessage(), $error_type);
+
+		fatal_error(nl2br($e), false);
+	}
+	else
+		fatal_error($e->getMessage(), $error_type);
+});
 
 // Start the session. (assuming it hasn't already been.)
 loadSession();
@@ -255,6 +275,8 @@ function smf_main()
 
 	// Here's the monstrous $_REQUEST['action'] array - $_REQUEST['action'] => array($file, $function).
 	$actionArray = array(
+		'agreement' => array('Agreement.php', 'Agreement'),
+		'acceptagreement' => array('Agreement.php', 'AcceptAgreement'),
 		'activate' => array('Register.php', 'Activate'),
 		'admin' => array('Admin.php', 'AdminMain'),
 		'announce' => array('Post.php', 'AnnounceTopic'),
@@ -298,6 +320,7 @@ function smf_main()
 		'movetopic2' => array('MoveTopic.php', 'MoveTopic2'),
 		'notify' => array('Notify.php', 'Notify'),
 		'notifyboard' => array('Notify.php', 'BoardNotify'),
+		'notifyannouncements' => array('Notify.php', 'AnnouncementsNotify'),
 		'openidreturn' => array('Subs-OpenID.php', 'smf_openID_return'),
 		'pm' => array('PersonalMessage.php', 'MessageMain'),
 		'post' => array('Post.php', 'Post'),
diff --git a/proxy.php b/proxy.php
index 8f4b3b7..0810303 100644
--- a/proxy.php
+++ b/proxy.php
@@ -10,7 +10,7 @@
  * @copyright 2016 Simple Machines and individual contributors
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.14
+ * @version 2.0.19
  */
 
 define('SMF', 'proxy');
@@ -67,26 +67,31 @@ class ProxyServer
 
 		// Try to create the image cache directory if it doesn't exist
 		if (!file_exists($this->cache))
+		{
 			if (!mkdir($this->cache) || !copy(dirname($this->cache) . '/index.php', $this->cache . '/index.php'))
 				return false;
+		}
+
+		// Basic sanity check
+		$_GET['request'] = filter_var($_GET['request'], FILTER_VALIDATE_URL);
 
+		// We aren't going anywhere without these
 		if (empty($_GET['hash']) || empty($_GET['request']))
 			return false;
 
 		$hash = $_GET['hash'];
 		$request = $_GET['request'];
 
-		if (md5($request . $this->secret) != $hash)
+		if (hash_hmac('sha1', $request, $this->secret) != $hash)
 			return false;
 
 		// Attempt to cache the request if it doesn't exist
-		if (!$this->isCached($request)) {
+		if (!$this->isCached($request))
 			return $this->cacheImage($request);
-		}
 
 		return true;
 	}
-	
+
 
 	/**
 	 * Serves the request
@@ -102,17 +107,14 @@ class ProxyServer
 
 		// Did we get an error when trying to fetch the image
 		$response = $this->checkRequest();
-		if (is_int($response)) {
+		if (!$response)
+		{
 			// Throw a 404
-			header('HTTP/1.0 404 Not Found');
+			header('HTTP/1.1 404 Not Found');
 			exit;
 		}
-		// Right, image not cached? Simply redirect, then.
-		if (!$response) {
-			header('Location: ' . $request, false, 301);
-		}
 
-		// Is the cache expired?
+		// Is the cache expired? Try to refresh it.
 		if (!$cached || time() - $cached['time'] > (5 * 86400))
 		{
 			@unlink($cached_file);
@@ -126,15 +128,30 @@ class ProxyServer
 		if ($contentParts[0] != 'image')
 			exit;
 
+		// Check whether the ETag was sent back, and cache based on that...
+		$eTag = '"' . substr(sha1($request) . $cached['time'], 0, 64) . '"';
+		if (!empty($_SERVER['HTTP_IF_NONE_MATCH']) && strpos($_SERVER['HTTP_IF_NONE_MATCH'], $eTag) !== false)
+		{
+			header('HTTP/1.1 304 Not Modified');
+			exit;
+		}
+
 		header('Content-type: ' . $cached['content_type']);
 		header('Content-length: ' . $cached['size']);
+
+		// Add some caching
+		header('Cache-control: public');
+		header('Expires: ' . gmdate('D, d M Y H:i:s', time() + 525600 * 60) . ' GMT');
+		header('Last-Modified: ' . gmdate('D, d M Y H:i:s', filemtime($cached_file)) . ' GMT');
+		header('ETag: ' . $eTag);
+
 		echo base64_decode($cached['body']);
 	}
 
 	/**
 	 * Returns the request's hashed filepath
 	 *
-	 * @access public
+	 * @access protected
 	 * @param string $request The request to get the path for
 	 * @return string The hashed filepath for the specified request
 	 */
@@ -160,43 +177,66 @@ class ProxyServer
 	 *
 	 * @access protected
 	 * @param string $request The image to cache/validate
-	 * @return bool|int Whether the specified image was cached or error code when accessing
+	 * @return bool|null Whether the specified image was cached; null if not found or not an image.
 	 */
 	protected function cacheImage($request)
 	{
+		$request_url = $request;
+
 		$dest = $this->getCachedPath($request);
 		$curl = new curl_fetch_web_data(array(CURLOPT_BINARYTRANSFER => 1));
 		$request = $curl->get_url_data($request);
 		$responseCode = $request->result('code');
 		$response = $request->result();
-		
-		if (empty($response)) {
-			return false;
-		}
-		
-		if ($responseCode != 200) {
-			return $request->result('code');
-		}
+
+		if (empty($response) || $responseCode != 200)
+			$this->redirectexit($request_url);
 
 		$headers = $response['headers'];
 
+		// What kind of file did they give us?
+		if (function_exists('finfo_open'))
+		{
+			$finfo = finfo_open(FILEINFO_MIME_TYPE);
+			$headers['content-type'] = finfo_buffer($finfo, $response['body']);
+			finfo_close($finfo);
+		}
+
+		// SVG needs a little extra care
+		if (in_array($headers['content-type'], array('text/plain', 'text/xml')) && strtolower(pathinfo(parse_url($request_url, PHP_URL_PATH), PATHINFO_EXTENSION)) == 'svg' && strpos($response['body'], '<svg') !== false && strpos($response['body'], '</svg>') !== false)
+			$headers['content-type'] = 'image/svg+xml';
+
 		// Make sure the url is returning an image
 		$contentParts = explode('/', !empty($headers['content-type']) ? $headers['content-type'] : '');
 		if ($contentParts[0] != 'image')
-			return false;
+			$this->redirectexit($request_url);
 
 		// Validate the filesize
 		if ($response['size'] > ($this->maxSize * 1024))
-			return false;
+			$this->redirectexit($request_url);
 
 		return file_put_contents($dest, json_encode(array(
 			'content_type' => $headers['content-type'],
 			'size' => $response['size'],
 			'time' => time(),
 			'body' => base64_encode($response['body']),
-		)));
+		))) !== false;
+	}
+
+	/**
+	 * A helper function to redirect a request
+	 *
+	 * @access private
+	 * @param string $request
+	 */
+	private function redirectexit($request)
+	{
+		header('Location: ' . un_htmlspecialchars($request), false, 301);
+		exit;
 	}
 }
 
 $proxy = new ProxyServer();
 $proxy->serve();
+
+?>
diff --git a/ssi_examples.php b/ssi_examples.php
index 1aca176..116f7d0 100644
--- a/ssi_examples.php
+++ b/ssi_examples.php
@@ -4,9 +4,9 @@
  * Simple Machines Forum (SMF)
  *
  * @package SMF
- * @author Simple Machines http://www.simplemachines.org
+ * @author Simple Machines https://www.simplemachines.org
  * @copyright 2011 Simple Machines
- * @license http://www.simplemachines.org/about/smf/license.php BSD
+ * @license https://www.simplemachines.org/about/smf/license.php BSD
  *
  * @version 2.0
  */
@@ -44,10 +44,10 @@ template_ssi_above();
 			<h2>Some notes on usage</h2>
 			<p>All the functions have an output method parameter.  This can either be &quot;echo&quot; (the default) or &quot;array&quot;</p>
 			<p>If it is &quot;echo&quot;, the function will act normally - otherwise, it will return an array containing information about the requested task. For example, it might return a list of topics for ssi_recentTopics.</p>
-			<p onclick="if (getInnerHTML(this).indexOf('Bird') == -1) setInnerHTML(this, getInnerHTML(this) + '<br /><img src=&quot;http://www.simplemachines.org/images/chocobo.jpg&quot; title=&quot;Bird-san&quot; alt=&quot;Chocobo!&quot; />'); return false;">This functionality can be used to allow you to present the information in any way you wish.</p>
+			<p onclick="if (getInnerHTML(this).indexOf('Bird') == -1) setInnerHTML(this, getInnerHTML(this) + '<br /><img src=&quot;https://www.simplemachines.org/images/chocobo.jpg&quot; title=&quot;Bird-san&quot; alt=&quot;Chocobo!&quot; />'); return false;">This functionality can be used to allow you to present the information in any way you wish.</p>
 
 			<h2>Additional Guides &amp; FAQ</h2>
-			<p>Need more information on using SSI.php? Check out <a href="http://docs.simplemachines.org/index.php?topic=400.0">Using SSI.php article</a> or <a href="http://www.simplemachines.org/community/index.php?topic=14906.0">the SSI FAQ</a>.</p>
+			<p>Need more information on using SSI.php? Check out <a href="https://docs.simplemachines.org/index.php?topic=400.0">Using SSI.php article</a> or <a href="https://www.simplemachines.org/community/index.php?topic=14906.0">the SSI FAQ</a>.</p>
 
 			<div id="sidenav" class="windowbg">
 				<span class="topslice"><span></span></span>
@@ -547,7 +547,7 @@ function template_ssi_below()
 				</div>
 			</div></div>
 			<div id="footer_section"><div class="frame">
-				<div class="smalltext"><a href="http://www.simplemachines.org">Simple Machines Forum</a></div>
+				<div class="smalltext"><a href="https://www.simplemachines.org">Simple Machines Forum</a></div>
 			</div></div>
 		</div>
 	</body>
@@ -683,4 +683,4 @@ unset($topics);
 	return $result;
 }
 
-?>
\ No newline at end of file
+?>
diff --git a/ssi_examples.shtml b/ssi_examples.shtml
index 0e93ab2..697f106 100644
--- a/ssi_examples.shtml
+++ b/ssi_examples.shtml
@@ -150,7 +150,7 @@
 		<br />
 		<br />
 		<span style="font-size: smaller;">
-			<a href="http://www.simplemachines.org/" title="Free Forum Software" target="_blank">SMF &copy; 2006&ndash;2010, Simple Machines LLC</a>
+			<a href="https://www.simplemachines.org/" title="Free Forum Software" target="_blank">SMF &copy; 2006&ndash;2010, Simple Machines LLC</a>
 		</span>
 		<br />
 		<br />
@@ -159,4 +159,4 @@
 		</span>
 
 	</body>
-</html>
\ No newline at end of file
+</html>
