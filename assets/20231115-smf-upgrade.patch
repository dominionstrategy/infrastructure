diff --git a/SSI.php b/SSI.php
index 31e0960..020fd06 100644
--- a/SSI.php
+++ b/SSI.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.10
+ * @version 2.0.18
  */
 
 // Don't do anything if SMF is already loaded.
@@ -23,10 +23,12 @@ global $boardurl, $boarddir, $sourcedir, $webmaster_email, $cookiename;
 global $db_server, $db_name, $db_user, $db_prefix, $db_persist, $db_error_send, $db_last_error;
 global $db_connection, $modSettings, $context, $sc, $user_info, $topic, $board, $txt;
 global $smcFunc, $ssi_db_user, $scripturl, $ssi_db_passwd, $db_passwd, $cachedir;
+global $image_proxy_enabled, $image_proxy_secret, $image_proxy_maxsize;
+global $auth_secret, $cookie_no_auth_secret;
 
 // Remember the current configuration so it can be set back.
-$ssi_magic_quotes_runtime = function_exists('get_magic_quotes_gpc') && get_magic_quotes_runtime();
-if (function_exists('set_magic_quotes_runtime'))
+$ssi_magic_quotes_runtime = version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('get_magic_quotes_gpc') && get_magic_quotes_runtime();
+if (version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('set_magic_quotes_runtime'))
 	@set_magic_quotes_runtime(0);
 $time_start = microtime();
 
@@ -42,7 +44,7 @@ require_once(dirname(__FILE__) . '/Settings.php');
 if ((empty($cachedir) || !file_exists($cachedir)) && file_exists($boarddir . '/cache'))
 	$cachedir = $boarddir . '/cache';
 
-$ssi_error_reporting = error_reporting(defined('E_STRICT') ? E_ALL | E_STRICT : E_ALL);
+$ssi_error_reporting = error_reporting((defined('E_STRICT') ? E_ALL | E_STRICT : E_ALL) & ~E_DEPRECATED);
 /* Set this to one of three values depending on what you want to happen in the case of a fatal error.
 	false:	Default, will just load the error sub template and die - not putting any theme layers around it.
 	true:	Will load the error sub template AND put the SMF layers around it (Not useful if on total custom pages).
@@ -186,7 +188,7 @@ elseif (basename($_SERVER['PHP_SELF']) == 'SSI.php')
 	die(sprintf($txt['ssi_not_direct'], $user_info['is_admin'] ? '\'' . addslashes(__FILE__) . '\'' : '\'SSI.php\''));
 
 error_reporting($ssi_error_reporting);
-if (function_exists('set_magic_quotes_runtime'))
+if (version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('set_magic_quotes_runtime'))
 	@set_magic_quotes_runtime($ssi_magic_quotes_runtime);
 
 return true;
@@ -1028,7 +1030,7 @@ function ssi_login($redirect_to = '', $output_method = 'echo')
 
 	echo '<tr>
 					<td><input type="hidden" name="cookielength" value="-1" /></td>
-					<td><input type="submit" value="', $txt['login'], '" class="button_submit" /></td>
+					<td><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" /><input type="submit" value="', $txt['login'], '" class="button_submit" /></td>
 				</tr>
 			</table>
 		</form>';
@@ -1083,7 +1085,7 @@ function ssi_recentPoll($topPollInstead = false, $output_method = 'echo')
 	$smcFunc['db_free_result']($request);
 
 	// This user has voted on all the polls.
-	if ($row === false)
+	if (empty($row))
 		return array();
 
 	// If this is a guest who's voted we'll through ourselves to show poll to show the results.
diff --git a/Sources/Admin.php b/Sources/Admin.php
index 6e4894a..5272baa 100644
--- a/Sources/Admin.php
+++ b/Sources/Admin.php
@@ -9,7 +9,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -350,6 +350,7 @@ function AdminMain()
 					'subsections' => array(
 						'register' => array($txt['admin_browse_register_new'], 'moderate_forum'),
 						'agreement' => array($txt['registration_agreement'], 'admin_forum'),
+						'policy' => array($txt['privacy_policy'], 'admin_forum'),
 						'reservednames' => array($txt['admin_reserved_set'], 'admin_forum'),
 						'settings' => array($txt['settings'], 'admin_forum'),
 					),
@@ -617,18 +618,18 @@ function AdminHome()
 
 	// Lastly, fill in the blanks in the support resources paragraphs.
 	$txt['support_resources_p1'] = sprintf($txt['support_resources_p1'],
-		'http://wiki.simplemachines.org/',
-		'http://wiki.simplemachines.org/smf/features2',
-		'http://wiki.simplemachines.org/smf/options2',
-		'http://wiki.simplemachines.org/smf/themes2',
-		'http://wiki.simplemachines.org/smf/packages2'
+		'https://wiki.simplemachines.org/',
+		'https://wiki.simplemachines.org/smf/features2',
+		'https://wiki.simplemachines.org/smf/options2',
+		'https://wiki.simplemachines.org/smf/themes2',
+		'https://wiki.simplemachines.org/smf/packages2'
 	);
 	$txt['support_resources_p2'] = sprintf($txt['support_resources_p2'],
-		'http://www.simplemachines.org/community/',
-		'http://www.simplemachines.org/redirect/english_support',
-		'http://www.simplemachines.org/redirect/international_support_boards',
-		'http://www.simplemachines.org/redirect/smf_support',
-		'http://www.simplemachines.org/redirect/customize_support'
+		'https://www.simplemachines.org/community/',
+		'https://www.simplemachines.org/redirect/english_support',
+		'https://www.simplemachines.org/redirect/international_support_boards',
+		'https://www.simplemachines.org/redirect/smf_support',
+		'https://www.simplemachines.org/redirect/customize_support'
 	);
 }
 
@@ -727,7 +728,7 @@ function AdminSearchInternal()
 	// Load a lot of language files.
 	$language_files = array(
 		'Help', 'ManageMail', 'ManageSettings', 'ManageCalendar', 'ManageBoards', 'ManagePaid', 'ManagePermissions', 'Search',
-		'Login', 'ManageSmileys',
+		'Login', 'ManageSmileys', 'Install',
 	);
 	loadLanguage(implode('+', $language_files));
 
@@ -812,7 +813,7 @@ function AdminSearchInternal()
 
 		foreach ($config_vars as $var)
 			if (!empty($var[1]) && !in_array($var[0], array('permissions', 'switch')))
-				$search_data['settings'][] = array($var[(isset($var[2]) && in_array($var[2], array('file', 'db'))) ? 0 : 1], $setting_area[1]);
+				$search_data['settings'][] = array($var[(isset($var[2]) && in_array($var[2], array('file', 'db'))) ? 0 : 1], $setting_area[1], 'alttxt' => (isset($var[2]) && in_array($var[2], array('file', 'db'))) || isset($var[3]) ? (in_array($var[2], array('file', 'db')) ? $var[1] : $var[3]) : '');
 	}
 
 	$context['page_title'] = $txt['admin_search_results'];
@@ -840,14 +841,14 @@ function AdminSearchInternal()
 			if ($found)
 			{
 				// Format the name - and remove any descriptions the entry may have.
-				$name = isset($txt[$found]) ? $txt[$found] : (isset($txt['setting_' . $found]) ? $txt['setting_' . $found] : $found);
+				$name = isset($txt[$found]) ? $txt[$found] : (isset($txt['setting_' . $found]) ? $txt['setting_' . $found] : (!empty($item['alttxt']) ? $item['alttxt'] : $found));
 				$name = preg_replace('~<(?:div|span)\sclass="smalltext">.+?</(?:div|span)>~', '', $name);
 
 				$context['search_results'][] = array(
 					'url' => (substr($item[1], 0, 4) == 'area' ? $scripturl . '?action=admin;' . $item[1] : $item[1]) . ';' . $context['session_var'] . '=' . $context['session_id'] . ((substr($item[1], 0, 4) == 'area' && $section == 'settings' ? '#' . $item[0][0] : '')),
 					'name' => $name,
 					'type' => $section,
-					'help' => shorten_subject(isset($item[2]) ? strip_tags($helptxt[$item2]) : (isset($helptxt[$found]) ? strip_tags($helptxt[$found]) : ''), 255),
+					'help' => shorten_subject(isset($item[2]) ? strip_tags($helptxt[$item[2]]) : (isset($helptxt[$found]) ? strip_tags($helptxt[$found]) : ''), 255),
 				);
 			}
 		}
diff --git a/Sources/Agreement.php b/Sources/Agreement.php
new file mode 100644
index 0000000..7ffe0f8
--- /dev/null
+++ b/Sources/Agreement.php
@@ -0,0 +1,223 @@
+<?php
+
+/**
+ * Simple Machines Forum (SMF)
+ *
+ * @package SMF
+ * @author Simple Machines
+ * @copyright 2018 Simple Machines
+ * @license http://www.simplemachines.org/about/smf/license.php BSD
+ *
+ * @version 2.0.18
+ */
+
+if (!defined('SMF'))
+	die('Hacking attempt...');
+
+/*	The purpose of this file is to show the user an updated registration
+	agreement, and get them to agree to it.
+
+	bool prepareAgreementContext()
+		// !!!
+
+	bool canRequireAgreement()
+		// !!!
+
+	bool canRequirePrivacyPolicy()
+		// !!!
+
+	void Agreement()
+		- Show the new registration agreement
+
+	void AcceptAgreement()
+		- Called when they actually accept the agreement
+		- Save the date of the current agreement to the members database table
+		- Redirect back to wherever they came from
+*/
+
+function prepareAgreementContext()
+{
+	global $boarddir, $context, $modSettings, $user_info, $language;
+
+	if ($context['show_agreement'])
+	{
+		// Grab the agreement.
+		// Have we got a localized one?
+		if (file_exists($boarddir . '/agreement.' . $user_info['language'] . '.txt'))
+			$context['agreement_file'] = $boarddir . '/agreement.' . $user_info['language'] . '.txt';
+		elseif (file_exists($boarddir . '/agreement.txt'))
+			$context['agreement_file'] = $boarddir . '/agreement.txt';
+
+		if (!empty($context['agreement_file']))
+		{
+			$cache_id = strtr($context['agreement_file'], array($boarddir => '', '.txt' => '', '.' => '_'));
+			$context['agreement'] = parse_bbc(file_get_contents($context['agreement_file']), true, $cache_id);
+		}
+
+		// An agreement file must be present and its text cannot be empty.
+		if (empty($context['agreement']))
+		{
+			if ($_REQUEST['sa'] == 'both')
+				$context['show_agreement'] = false;
+			else
+				fatal_lang_error('no_agreement', false);
+		}
+	}
+
+	if ($context['show_privacy_policy'])
+	{
+		// Have we got a localized policy?
+		if (!empty($modSettings['policy_' . $user_info['language']]))
+			$context['policy'] = parse_bbc($modSettings['policy_' . $user_info['language']]);
+		elseif (!empty($modSettings['policy_' . $language]))
+			$context['policy'] = parse_bbc($modSettings['policy_' . $language]);
+		// Then I guess we've got nothing
+		elseif ($_REQUEST['sa'] == 'both')
+			$context['show_privacy_policy'] = false;
+		else
+			fatal_lang_error('error_no_privacy_policy', false);
+	}
+
+	// Nothing to show? That's no good.
+	if (!$context['show_agreement'] && !$context['show_privacy_policy'])
+		fatal_lang_error('no_agreement', false);
+}
+
+function canRequireAgreement()
+{
+	global $modSettings, $options, $user_info, $context;
+
+	// Guests can't agree
+	if ($user_info['is_guest'] || empty($modSettings['requireAgreement']))
+		return false;
+
+	$agreement_lang = strpos($context['agreement_file'], 'agreement.' . $user_info['language'] . '.txt') !== false ? $user_info['language'] : 'default';
+
+	if (empty($modSettings['agreement_updated_' . $agreement_lang]))
+		return false;
+
+	$context['agreement_accepted_date'] = empty($options['agreement_accepted']) ? 0 : $options['agreement_accepted'];
+
+	// A new timestamp means that there are new changes to the registration agreement and must therefore be shown.
+	return empty($options['agreement_accepted']) || $modSettings['agreement_updated_' . $agreement_lang] > $options['agreement_accepted'];
+}
+
+function canRequirePrivacyPolicy()
+{
+	global $modSettings, $options, $user_info, $language, $context;
+
+	if ($user_info['is_guest'] || empty($modSettings['requirePolicyAgreement']))
+		return false;
+
+	$policy_lang = !empty($modSettings['policy_' . $user_info['language']]) ? $user_info['language'] : $language;
+
+	if (empty($modSettings['policy_updated_' . $policy_lang]))
+		return false;
+
+	$context['privacy_policy_accepted_date'] = empty($options['policy_accepted']) ? 0 : $options['policy_accepted'];
+
+	return empty($options['policy_accepted']) || $modSettings['policy_updated_' . $policy_lang] > $options['policy_accepted'];
+}
+
+// Let's tell them there's a new agreement
+function Agreement()
+{
+	global $context, $scripturl, $txt;
+
+	// Keep it sanitary
+	if (!isset($_REQUEST['sa']) || !in_array($_REQUEST['sa'], array('agreement', 'policy')))
+		$_REQUEST['sa'] = 'both';
+
+	// Now, what do we actually want to show?
+	$context['show_agreement'] = in_array($_REQUEST['sa'], array('agreement', 'both'));
+	$context['show_privacy_policy'] = in_array($_REQUEST['sa'], array('policy', 'both'));
+
+	prepareAgreementContext();
+
+	// What, if anything, do they need to accept?
+	$context['can_accept_agreement'] = $context['show_agreement'] && canRequireAgreement();
+	$context['can_accept_privacy_policy'] = $context['show_privacy_policy'] && canRequirePrivacyPolicy();
+
+	// The form will need to tell us what they are accepting
+	if ($context['can_accept_agreement'] && $context['can_accept_privacy_policy'])
+		$context['accept_doc'] = 'both';
+	elseif ($context['can_accept_agreement'])
+		$context['accept_doc'] = 'agreement';
+	elseif ($context['can_accept_privacy_policy'])
+		$context['accept_doc'] = 'policy';
+
+	loadLanguage('Agreement');
+	loadTemplate('Agreement');
+
+	if ($context['show_agreement'] && $context['show_privacy_policy'])
+		$page_title = $txt['agreement_and_privacy_policy'];
+	elseif ($context['show_agreement'])
+		$page_title = $txt['agreement'];
+	elseif ($context['show_privacy_policy'])
+		$page_title = $txt['privacy_policy'];
+
+	if (isset($_SESSION['old_url']))
+		$_SESSION['redirect_url'] = $_SESSION['old_url'];
+	$context['page_title'] = $page_title;
+	$context['linktree'][] = array(
+		'url' => $scripturl . '?action=agreement',
+		'name' => $txt['agreement_and_privacy_policy'],
+	);
+
+	if ($_REQUEST['sa'] !== 'both')
+		$context['linktree'][] = array(
+			'url' => $scripturl . '?action=agreement;sa=' . $_REQUEST['sa'],
+			'name' => $context['page_title'],
+		);
+}
+
+// I solemly swear to no longer chase squirrels.
+function AcceptAgreement()
+{
+	global $smcFunc, $user_info, $context;
+
+	// No funny business allowed
+	if (!isset($_REQUEST['doc']) || !in_array($_REQUEST['doc'], array('agreement', 'policy', 'both')))
+		redirectexit('action=agreement');
+
+	// Zero in on the agreement for this...
+	$context['show_agreement'] = in_array($_REQUEST['doc'], array('agreement', 'both'));
+	$context['show_privacy_policy'] = in_array($_REQUEST['doc'], array('policy', 'both'));
+
+	prepareAgreementContext();
+
+	// Can they agree to what they are trying to agree to?
+	if ($context['show_agreement'] && !canRequireAgreement())
+		redirectexit('action=agreement');
+	if ($context['show_privacy_policy'] && !canRequirePrivacyPolicy())
+		redirectexit('action=agreement');
+
+	checkSession();
+
+	if (in_array($_REQUEST['doc'], array('agreement', 'both')))
+	{
+		$smcFunc['db_insert']('replace',
+			'{db_prefix}themes',
+			array('id_member' => 'int', 'id_theme' => 'int', 'variable' => 'string', 'value' => 'string'),
+			array($user_info['id'], 1, 'agreement_accepted', time()),
+			array('id_member', 'id_theme', 'variable')
+		);
+		logAction('agreement_accepted', array('applicator' => $user_info['id']), 'user');
+	}
+
+	if (in_array($_REQUEST['doc'], array('policy', 'both')))
+	{
+		$smcFunc['db_insert']('replace',
+			'{db_prefix}themes',
+			array('id_member' => 'int', 'id_theme' => 'int', 'variable' => 'string', 'value' => 'string'),
+			array($user_info['id'], 1, 'policy_accepted', time()),
+			array('id_member', 'id_theme', 'variable')
+		);
+		logAction('policy_accepted', array('applicator' => $user_info['id']), 'user');
+	}
+
+	// Redirect back to chasing those squirrels, er, viewing those memes.
+	redirectexit(!empty($_SESSION['redirect_url']) ? $_SESSION['redirect_url'] : '');
+}
+
+?>
\ No newline at end of file
diff --git a/Sources/Class-CurlFetchWeb.php b/Sources/Class-CurlFetchWeb.php
index 8df7707..44d2d40 100644
--- a/Sources/Class-CurlFetchWeb.php
+++ b/Sources/Class-CurlFetchWeb.php
@@ -7,7 +7,7 @@
  * @copyright 2017 Simple Machines and individual contributors
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.14
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -303,7 +303,7 @@ class curl_fetch_web_data
 
 		// set proper headers only
 		if (isset($temp[0]) && isset($temp[1]))
-			$this->headers[strtolower($temp[0])] = strtolower(trim($temp[1]));
+			$this->headers[strtolower($temp[0])] = trim($temp[1]);
 
 		// return the length of what was passed unless you want a Failed writing header error ;)
 		return strlen($header);
diff --git a/Sources/Class-Graphics.php b/Sources/Class-Graphics.php
index 0550ecc..a36851a 100644
--- a/Sources/Class-Graphics.php
+++ b/Sources/Class-Graphics.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 /*	Gif Util copyright 2003 by Yamasoft (S/C). All rights reserved.
@@ -219,7 +219,7 @@ class gif_lzw_compression
 			if ($count)
 			{
 				for ($i = 0; $i < $count; $i++)
-					$this->Buf[2 + $i] = ord($data{$i});
+					$this->Buf[2 + $i] = ord($data[$i]);
 
 				$data = substr($data, $count);
 			}
@@ -643,7 +643,7 @@ class gif_file
 			{
 				// Is this in the proper range?  If so, get the specific pixel data...
 				if ($x >= $header->m_nLeft && $y >= $header->m_nTop && $x < ($header->m_nLeft + $header->m_nWidth) && $y < ($header->m_nTop + $header->m_nHeight))
-					$bmp .= $data{$i};
+					$bmp .= $data[$i];
 				// Otherwise, this is background...
 				else
 					$bmp .= chr($background_color);
diff --git a/Sources/DbExtra-mysql.php b/Sources/DbExtra-mysql.php
index 22601a8..2ef92e7 100644
--- a/Sources/DbExtra-mysql.php
+++ b/Sources/DbExtra-mysql.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -61,6 +61,7 @@ function db_extra_init()
 			'db_table_sql' => 'smf_db_table_sql',
 			'db_list_tables' => 'smf_db_list_tables',
 			'db_get_version' => 'smf_db_get_version',
+			'db_get_engine' => 'smf_db_get_engine',
 		);
 }
 
@@ -415,7 +416,7 @@ function smf_db_table_sql($tableName)
 		// Ensure the columns are in proper order.
 		ksort($columns);
 
-		$schema_create .= ',' . $crlf . ' ' . $keyname . ' (' . implode($columns, ', ') . ')';
+		$schema_create .= ',' . $crlf . ' ' . $keyname . ' (' . implode(', ', $columns) . ')';
 	}
 
 	// Now just get the comment and type... (MyISAM, etc.)
@@ -451,4 +452,35 @@ function smf_db_get_version()
 	return $ver;
 }
 
+/**
+ * Figures out if we are using MySQL, Percona or MariaDB
+ *
+ * @return string The database engine we are using
+*/
+function smf_db_get_engine()
+{
+	global $smcFunc;
+	static $db_type;
+
+	if (!empty($db_type))
+		return $db_type;
+
+	$request = $smcFunc['db_query']('', 'SELECT @@version_comment');
+	list ($comment) = $smcFunc['db_fetch_row']($request);
+	$smcFunc['db_free_result']($request);
+
+	// Skip these if we don't have a comment.
+	if (!empty($comment))
+	{
+		if (stripos($comment, 'percona') !== false)
+			return 'Percona';
+		if (stripos($comment, 'mariadb') !== false)
+			return 'MariaDB';
+	}
+	else
+		return 'fail';
+
+	return 'MySQL';
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/DbExtra-postgresql.php b/Sources/DbExtra-postgresql.php
index 2f5271f..d25b05a 100644
--- a/Sources/DbExtra-postgresql.php
+++ b/Sources/DbExtra-postgresql.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.15
  */
 
 if (!defined('SMF'))
@@ -61,6 +61,7 @@ function db_extra_init()
 			'db_table_sql' => 'smf_db_table_sql',
 			'db_list_tables' => 'smf_db_list_tables',
 			'db_get_version' => 'smf_db_get_version',
+			'db_get_engine' => 'smf_db_get_engine',
 		);
 }
 
@@ -325,4 +326,14 @@ function smf_db_get_version()
 	return $ver;
 }
 
+/**
+ * Return PostgreSQL
+ *
+ * @return string The database engine we are using
+*/
+function smf_db_get_engine()
+{
+	return 'PostgreSQL';
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/DbExtra-sqlite.php b/Sources/DbExtra-sqlite.php
index 4964a22..6efdb4a 100644
--- a/Sources/DbExtra-sqlite.php
+++ b/Sources/DbExtra-sqlite.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.15
  */
 
 if (!defined('SMF'))
@@ -62,6 +62,7 @@ function db_extra_init()
 			'db_list_tables' => 'smf_db_list_tables',
 			'db_get_backup' => 'smf_db_get_backup',
 			'db_get_version' => 'smf_db_get_version',
+			'db_get_engine' => 'smf_db_get_engine',
 		);
 }
 
@@ -343,4 +344,14 @@ function smf_db_get_backup()
 	obExit(false);
 }
 
+/**
+ * Return SQLite
+ *
+ * @return string The database engine we are using
+*/
+function smf_db_get_engine()
+{
+	return 'SQLite';
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/DbPackages-mysql.php b/Sources/DbPackages-mysql.php
index 6847d3a..2dfd9eb 100644
--- a/Sources/DbPackages-mysql.php
+++ b/Sources/DbPackages-mysql.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.15
  */
 
 if (!defined('SMF'))
@@ -132,7 +132,7 @@ function smf_db_create_table($table_name, $columns, $indexes = array(), $paramet
 		list ($type, $size) = $smcFunc['db_calculate_type']($column['type'], $column['size']);
 
 		// Allow unsigned integers (mysql only)
-		$unsigned = in_array($type, array('int', 'tinyint', 'smallint', 'mediumint', 'bigint', 'float')) && !empty($column_info['unsigned']) ? 'unsigned ' : '';
+		$unsigned = in_array($type, array('int', 'tinyint', 'smallint', 'mediumint', 'bigint', 'float')) && !empty($column['unsigned']) ? 'unsigned ' : '';
 
 		if ($size !== null)
 			$type = $type . '(' . $size . ')';
diff --git a/Sources/Display.php b/Sources/Display.php
index 345b36b..5a38ebd 100644
--- a/Sources/Display.php
+++ b/Sources/Display.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -734,9 +734,9 @@ img_gpbp_up=new Image;img_gpbp_up.src="' . $settings['images_url'] . '/gpbp'.$gp
 			'has_voted' => !empty($pollinfo['has_voted']),
 			'starter' => array(
 				'id' => $pollinfo['id_member'],
-				'name' => $row['poster_name'],
+				'name' => $pollinfo['poster_name'],
 				'href' => $pollinfo['id_member'] == 0 ? '' : $scripturl . '?action=profile;u=' . $pollinfo['id_member'],
-				'link' => $pollinfo['id_member'] == 0 ? $row['poster_name'] : '<a href="' . $scripturl . '?action=profile;u=' . $pollinfo['id_member'] . '">' . $row['poster_name'] . '</a>'
+				'link' => $pollinfo['id_member'] == 0 ? $pollinfo['poster_name'] : '<a href="' . $scripturl . '?action=profile;u=' . $pollinfo['id_member'] . '">' . $pollinfo['poster_name'] . '</a>'
 			)
 		);
 
@@ -1493,9 +1493,10 @@ function Download()
 
 	// Convert the file to UTF-8, cuz most browsers dig that.
 	$utf8name = !$context['utf8'] && function_exists('iconv') ? iconv($context['character_set'], 'UTF-8', $real_filename) : (!$context['utf8'] && function_exists('mb_convert_encoding') ? mb_convert_encoding($real_filename, 'UTF-8', $context['character_set']) : $real_filename);
-	$fixchar = create_function('$n', '
+	$fixchar = function($n)
+	{
 		if ($n < 32)
-			return \'\';
+			return '';
 		elseif ($n < 128)
 			return chr($n);
 		elseif ($n < 2048)
@@ -1503,7 +1504,8 @@ function Download()
 		elseif ($n < 65536)
 			return chr(224 | $n >> 12) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);
 		else
-			return chr(240 | $n >> 18) . chr(128 | $n >> 12 & 63) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);');
+			return chr(240 | $n >> 18) . chr(128 | $n >> 12 & 63) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);
+	};
 
 	$disposition = !isset($_REQUEST['image']) ? 'attachment' : 'inline';
 
@@ -1536,11 +1538,11 @@ function Download()
 	if (!empty($modSettings['attachmentRecodeLineEndings']) && !isset($_REQUEST['image']) && in_array($file_ext, array('txt', 'css', 'htm', 'html', 'php', 'xml')))
 	{
 		if (strpos($_SERVER['HTTP_USER_AGENT'], 'Windows') !== false)
-			$callback = create_function('$buffer', 'return preg_replace(\'~[\r]?\n~\', "\r\n", $buffer);');
+			$callback = function($buffer){return preg_replace('~[\r]?\n~', "\r\n", $buffer);};
 		elseif (strpos($_SERVER['HTTP_USER_AGENT'], 'Mac') !== false)
-			$callback = create_function('$buffer', 'return preg_replace(\'~[\r]?\n~\', "\r", $buffer);');
+			$callback = function($buffer){return preg_replace('~[\r]?\n~', "\r", $buffer);};
 		else
-			$callback = create_function('$buffer', 'return preg_replace(\'~[\r]?\n~\', "\n", $buffer);');
+			$callback = function($buffer){return preg_replace('~[\r]?\n~', "\n", $buffer);};
 	}
 
 	// Since we don't do output compression for files this large...
diff --git a/Sources/Errors.php b/Sources/Errors.php
index 5f80b70..af85687 100644
--- a/Sources/Errors.php
+++ b/Sources/Errors.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.4
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -203,9 +203,22 @@ function error_handler($error_level, $error_string, $file, $line)
 {
 	global $settings, $modSettings, $db_show_debug;
 
-	// Ignore errors if we're ignoring them or they are strict notices from PHP 5 (which cannot be solved without breaking PHP 4.)
-	if (error_reporting() == 0 || (defined('E_STRICT') && $error_level == E_STRICT && (empty($modSettings['enableErrorLogging']) || $modSettings['enableErrorLogging'] != 2)))
-		return;
+	// Error was suppressed with the @-operator.
+	if (error_reporting() == 0)
+		return true;
+
+	// Ignore errors that should should not be logged.
+	$error_match = error_reporting() & $error_level;
+	if (empty($error_match) || empty($modSettings['enableErrorLogging']))
+		return false;
+
+	// Send these notices introduced by PHP 7.2 to where the sun don't shine!
+	if (strpos($error_string, 'create_function()') !== false)
+		return true;
+
+	// Also ignore these deprecation warnings introduced in PHP 8.1.
+	if (defined('PHP_VERSION_ID') && PHP_VERSION_ID >= 80100 && strpos($error_string, 'strftime()') !== false)
+		return true;
 
 	if (strpos($file, 'eval()') !== false && !empty($settings['current_include_filename']))
 	{
diff --git a/Sources/Groups.php b/Sources/Groups.php
index e1a0625..e48b7c3 100644
--- a/Sources/Groups.php
+++ b/Sources/Groups.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -194,16 +194,15 @@ function GroupList()
 					'value' => $txt['name'],
 				),
 				'data' => array(
-					'function' => create_function('$group', '
-						global $scripturl, $context;
-
-						$output = \'<a href="\' . $scripturl . \'?action=\' . $context[\'current_action\'] . (isset($context[\'admin_area\']) ? \';area=\' . $context[\'admin_area\'] : \'\') . \';sa=members;group=\' . $group[\'id\'] . \'" \' . ($group[\'color\'] ? \'style="color: \' . $group[\'color\'] . \';"\' : \'\') . \'>\' . $group[\'name\'] . \'</a>\';
+					'function' => function($group) use ($scripturl, $context)
+					{
+						$output = '<a href="' . $scripturl . '?action=' . $context['current_action'] . (isset($context['admin_area']) ? ';area=' . $context['admin_area'] : '') . ';sa=members;group=' . $group['id'] . '" ' . ($group['color'] ? 'style="color: ' . $group['color'] . ';"' : '') . '>' . $group['name'] . '</a>';
 
-						if ($group[\'desc\'])
-							$output .= \'<div class="smalltext">\' . $group[\'desc\'] . \'</div>\';
+						if ($group['desc'])
+							$output .= '<div class="smalltext">' . $group['desc'] . '</div>';
 
 						return $output;
-					'),
+					},
 					'style' => 'width: 50%;',
 				),
 			),
@@ -220,11 +219,10 @@ function GroupList()
 					'value' => $txt['moderators'],
 				),
 				'data' => array(
-					'function' => create_function('$group', '
-						global $txt;
-
-						return empty($group[\'moderators\']) ? \'<em>\' . $txt[\'membergroups_new_copy_none\'] . \'</em>\' : implode(\', \', $group[\'moderators\']);
-					'),
+					'function' => function($group) use ($txt)
+					{
+						return empty($group['moderators']) ? '<em>' . $txt['membergroups_new_copy_none'] . '</em>' : implode(', ', $group['moderators']);
+					},
 				),
 			),
 			'members' => array(
@@ -456,6 +454,10 @@ function MembergroupMembers()
 	{
 		checkSession();
 
+		// Only proven admins can remove admins.
+		if ($context['group']['id'] == 1)
+			validateSession();
+
 		// Make sure we're dealing with integers only.
 		foreach ($_REQUEST['rem'] as $key => $group)
 			$_REQUEST['rem'][$key] = (int) $group;
@@ -468,6 +470,10 @@ function MembergroupMembers()
 	{
 		checkSession();
 
+		// Demand an admin password before adding new admins -- every time, no matter what.
+		if ($context['group']['id'] == 1)
+			validateSession(true);
+
 		$member_query = array();
 		$member_parameters = array();
 
diff --git a/Sources/Help.php b/Sources/Help.php
index 2896e60..163de32 100644
--- a/Sources/Help.php
+++ b/Sources/Help.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -41,7 +41,7 @@ function ShowHelp()
 	loadLanguage('Manual');
 
 	// We need to know where our wiki is.
-	$context['wiki_url'] = 'http://wiki.simplemachines.org/smf';
+	$context['wiki_url'] = 'https://wiki.simplemachines.org/smf';
 
 	// Sections were are going to link...
 	$context['manual_sections'] = array(
diff --git a/Sources/Load.php b/Sources/Load.php
index e563df5..6c023dc 100644
--- a/Sources/Load.php
+++ b/Sources/Load.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -160,71 +160,96 @@ function reloadSettings()
 		if (empty($modSettings['defaultMaxMembers']) || $modSettings['defaultMaxMembers'] <= 0 || $modSettings['defaultMaxMembers'] > 999)
 			$modSettings['defaultMaxMembers'] = 30;
 
+		// Covers null and !isset cases
+		if (empty($modSettings['requirePolicyAgreement']))
+			$modSettings['requirePolicyAgreement'] = 0;
+
 		if (!empty($modSettings['cache_enable']))
 			cache_put_data('modSettings', $modSettings, 90);
 	}
 
 	// UTF-8 in regular expressions is unsupported on PHP(win) versions < 4.2.3.
-	$utf8 = (empty($modSettings['global_character_set']) ? $txt['lang_character_set'] : $modSettings['global_character_set']) === 'UTF-8' && (strpos(strtolower(PHP_OS), 'win') === false || @version_compare(PHP_VERSION, '4.2.3') != -1);
+	$utf8 = (empty($modSettings['global_character_set']) ? (!empty($txt['lang_character_set']) ? $txt['lang_character_set'] : '') : $modSettings['global_character_set']) === 'UTF-8' && (strpos(strtolower(PHP_OS), 'win') === false || @version_compare(PHP_VERSION, '4.2.3') != -1);
 
 	// Set a list of common functions.
-	$ent_list = empty($modSettings['disableEntityCheck']) ? '&(#\d{1,7}|quot|amp|lt|gt|nbsp);' : '&(#021|quot|amp|lt|gt|nbsp);';
-	$ent_check = empty($modSettings['disableEntityCheck']) ? array('preg_replace_callback(\'~(&#(\d{1,7}|x[0-9a-fA-F]{1,6});)~\', \'entity_fix__callback\', ', ')') : array('', '');
+	$ent_list = empty($modSettings['disableEntityCheck']) ? '&(?>#\d{1,7}|quot|amp|lt|gt|nbsp);' : '&(?>#021|quot|amp|lt|gt|nbsp);';
+	$ent_check = empty($modSettings['disableEntityCheck']) ? function($string, $double = false)
+		{
+			$string = preg_replace_callback('~(&' . (!empty($double) ? '(?:amp;)?' : '') . '#(\d{1,7}|x[0-9a-fA-F]{1,6});)~', 'entity_fix__callback', $string);
+			return $string;
+		} : function($string)
+		{
+			return $string;
+		};
+	$fix_utf8mb4 = function($string) use ($utf8, $smcFunc)
+	{
+		if (!$utf8)
+			return $string;
+
+		$i = 0;
+		$len = strlen($string);
+		$new_string = '';
+		while ($i < $len)
+		{
+			$ord = ord($string[$i]);
+			if ($ord < 128)
+			{
+				$new_string .= $string[$i];
+				$i++;
+			}
+			elseif ($ord < 224)
+			{
+				$new_string .= $string[$i] . $string[$i + 1];
+				$i += 2;
+			}
+			elseif ($ord < 240)
+			{
+				$new_string .= $string[$i] . $string[$i + 1] . $string[$i + 2];
+				$i += 3;
+			}
+			elseif ($ord < 248)
+			{
+				// Magic happens.
+				$val = (ord($string[$i]) & 0x07) << 18;
+				$val += (ord($string[$i + 1]) & 0x3F) << 12;
+				$val += (ord($string[$i + 2]) & 0x3F) << 6;
+				$val += (ord($string[$i + 3]) & 0x3F);
+				$new_string .= '&#' . $val . ';';
+				$i += 4;
+			}
+		}
+		return $new_string;
+	};
 
 	// Preg_replace can handle complex characters only for higher PHP versions.
 	$space_chars = $utf8 ? (@version_compare(PHP_VERSION, '4.3.3') != -1 ? '\x{A0}\x{AD}\x{2000}-\x{200F}\x{201F}\x{202F}\x{3000}\x{FEFF}' : "\xC2\xA0\xC2\xAD\xE2\x80\x80-\xE2\x80\x8F\xE2\x80\x9F\xE2\x80\xAF\xE2\x80\x9F\xE3\x80\x80\xEF\xBB\xBF") : '\x00-\x08\x0B\x0C\x0E-\x19\xA0';
 
 	$smcFunc += array(
-		'entity_fix' => create_function('$string', '
-			$num = substr($string, 0, 1) === \'x\' ? hexdec(substr($string, 1)) : (int) $string;
-			return $num < 0x20 || $num > 0x10FFFF || ($num >= 0xD800 && $num <= 0xDFFF) || $num === 0x202E || $num === 0x202D ? \'\' : \'&#\' . $num . \';\';'),
-		'htmlspecialchars' => create_function('$string, $quote_style = ENT_COMPAT, $charset = \'ISO-8859-1\'', '
-			global $smcFunc;
-			return ' . ($utf8 ? '$smcFunc[\'fix_utf8mb4\'](' : '') . strtr($ent_check[0], array('&' => '&amp;')) . 'htmlspecialchars($string, $quote_style, ' . ($utf8 ? '\'UTF-8\'' : '$charset') . ')' . $ent_check[1] . ($utf8 ? ')' : '') . ';'),
-		'fix_utf8mb4' => create_function('$string', '
-			$i = 0;
-			$len = strlen($string);
-			$new_string = \'\';
-			while ($i < $len)
-			{
-				$ord = ord($string[$i]);
-				if ($ord < 128)
-				{
-					$new_string .= $string[$i];
-					$i++;
-				}
-				elseif ($ord < 224)
-				{
-					$new_string .= $string[$i] . $string[$i+1];
-					$i += 2;
-				}
-				elseif ($ord < 240)
-				{
-					$new_string .= $string[$i] . $string[$i+1] . $string[$i+2];
-					$i += 3;
-				}
-				elseif ($ord < 248)
-				{
-					// Magic happens.
-					$val = (ord($string[$i]) & 0x07) << 18;
-					$val += (ord($string[$i+1]) & 0x3F) << 12;
-					$val += (ord($string[$i+2]) & 0x3F) << 6;
-					$val += (ord($string[$i+3]) & 0x3F);
-					$new_string .= \'&#\' . $val . \';\';
-					$i += 4;
-				}
-			}
-			return $new_string;'),
-		'htmltrim' => create_function('$string', '
-			global $smcFunc;
-			return preg_replace(\'~^(?:[ \t\n\r\x0B\x00' . $space_chars . ']|&nbsp;)+|(?:[ \t\n\r\x0B\x00' . $space_chars . ']|&nbsp;)+$~' . ($utf8 ? 'u' : '') . '\', \'\', ' . implode('$string', $ent_check) . ');'),
-		'strlen' => create_function('$string', '
-			global $smcFunc;
-			return strlen(preg_replace(\'~' . $ent_list . ($utf8 ? '|.~u' : '~') . '\', \'_\', ' . implode('$string', $ent_check) . '));'),
-		'strpos' => create_function('$haystack, $needle, $offset = 0', '
-			global $smcFunc;
-			$haystack_arr = preg_split(\'~(&#' . (empty($modSettings['disableEntityCheck']) ? '\d{1,7}' : '021') . ';|&quot;|&amp;|&lt;|&gt;|&nbsp;|.)~' . ($utf8 ? 'u' : '') . '\', ' . implode('$haystack', $ent_check) . ', -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
-			$haystack_size = count($haystack_arr);
+		'entity_fix' => function($string)
+		{
+			$num = $string[0] === 'x' ? hexdec(substr($string, 1)) : (int) $string;
+			return $num < 0x20 || $num > 0x10FFFF || ($num >= 0xD800 && $num <= 0xDFFF) || $num === 0x202E || $num === 0x202D ? '' : '&#' . $num . ';';
+		},
+		'htmlspecialchars' => function($string, $quote_style = ENT_COMPAT, $charset = 'ISO-8859-1') use ($ent_check, $utf8, $fix_utf8mb4)
+		{
+			return $fix_utf8mb4($ent_check(htmlspecialchars($string, $quote_style, $utf8 ? 'UTF-8' : $charset), true));
+		},
+		'fix_utf8mb4' => $fix_utf8mb4,
+		'htmltrim' => function($string) use ($utf8, $ent_check)
+		{
+			// Preg_replace space characters depend on the character set in use
+			$space_chars = $utf8 ? '\p{Z}\p{C}' : '\x00-\x20\x80-\xA0';
+
+			return preg_replace('~^(?:[' . $space_chars . ']|&nbsp;)+|(?:[' . $space_chars . ']|&nbsp;)+$~' . ($utf8 ? 'u' : ''), '', $ent_check($string));
+		},
+		'strlen' => function($string) use ($ent_list, $utf8, $ent_check)
+		{
+			return strlen(preg_replace('~' . $ent_list . ($utf8 ? '|.~u' : '~'), '_', $ent_check($string)));
+		},
+		'strpos' => function($haystack, $needle, $offset = 0) use ($utf8, $ent_check, $ent_list, $modSettings)
+		{
+			$haystack_arr = preg_split('~(' . $ent_list . '|.)~' . ($utf8 ? 'u' : ''), $ent_check($haystack), -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
+
 			if (strlen($needle) === 1)
 			{
 				$result = array_search($needle, array_slice($haystack_arr, $offset));
@@ -232,11 +257,11 @@ function reloadSettings()
 			}
 			else
 			{
-				$needle_arr = preg_split(\'~(&#' . (empty($modSettings['disableEntityCheck']) ? '\d{1,7}' : '021') . ';|&quot;|&amp;|&lt;|&gt;|&nbsp;|.)~' . ($utf8 ? 'u' : '') . '\',  ' . implode('$needle', $ent_check) . ', -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
+				$needle_arr = preg_split('~(' . $ent_list . '|.)~' . ($utf8 ? 'u' : '') . '', $ent_check($needle), -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
 				$needle_size = count($needle_arr);
 
 				$result = array_search($needle_arr[0], array_slice($haystack_arr, $offset));
-				while (is_int($result))
+				while ((int) $result === $result)
 				{
 					$offset += $result;
 					if (array_slice($haystack_arr, $offset, $needle_size) === $needle_arr)
@@ -244,38 +269,55 @@ function reloadSettings()
 					$result = array_search($needle_arr[0], array_slice($haystack_arr, ++$offset));
 				}
 				return false;
-			}'),
-		'substr' => create_function('$string, $start, $length = null', '
-			global $smcFunc;
-			$ent_arr = preg_split(\'~(&#' . (empty($modSettings['disableEntityCheck']) ? '\d{1,7}' : '021') . ';|&quot;|&amp;|&lt;|&gt;|&nbsp;|.)~' . ($utf8 ? 'u' : '') . '\', ' . implode('$string', $ent_check) . ', -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
-			return $length === null ? implode(\'\', array_slice($ent_arr, $start)) : implode(\'\', array_slice($ent_arr, $start, $length));'),
-		'strtolower' => $utf8 ? (function_exists('mb_strtolower') ? create_function('$string', '
-			return mb_strtolower($string, \'UTF-8\');') : create_function('$string', '
-			global $sourcedir;
-			require_once($sourcedir . \'/Subs-Charset.php\');
-			return utf8_strtolower($string);')) : 'strtolower',
-		'strtoupper' => $utf8 ? (function_exists('mb_strtoupper') ? create_function('$string', '
-			return mb_strtoupper($string, \'UTF-8\');') : create_function('$string', '
+			}
+		},
+		'substr' => function($string, $start, $length = null) use ($utf8, $ent_check, $ent_list, $modSettings)
+		{
+			$ent_arr = preg_split('~(' . $ent_list . '|.)~' . ($utf8 ? 'u' : '') . '', $ent_check($string), -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
+			return $length === null ? implode('', array_slice($ent_arr, $start)) : implode('', array_slice($ent_arr, $start, $length));
+		},
+		'strtolower' => $utf8 ? function($string) use ($sourcedir)
+		{
+			if (!function_exists('mb_strtolower'))
+			{
+				require_once($sourcedir . '/Subs-Charset.php');
+				return utf8_strtolower($string);
+			}
+
+			return mb_strtolower($string, 'UTF-8');
+		} : 'strtolower',
+		'strtoupper' => $utf8 ? function($string)
+		{
 			global $sourcedir;
-			require_once($sourcedir . \'/Subs-Charset.php\');
-			return utf8_strtoupper($string);')) : 'strtoupper',
-		'truncate' => create_function('$string, $length', (empty($modSettings['disableEntityCheck']) ? '
-			global $smcFunc;
-			$string = ' . implode('$string', $ent_check) . ';' : '') . '
-			preg_match(\'~^(' . $ent_list . '|.){\' . $smcFunc[\'strlen\'](substr($string, 0, $length)) . \'}~'.  ($utf8 ? 'u' : '') . '\', $string, $matches);
+
+			if (!function_exists('mb_strtolower'))
+			{
+				require_once($sourcedir . '/Subs-Charset.php');
+				return utf8_strtoupper($string);
+			}
+
+			return mb_strtoupper($string, 'UTF-8');
+		} : 'strtoupper',
+		'truncate' => function($string, $length) use ($utf8, $ent_check, $ent_list, &$smcFunc)
+		{
+			$string = $ent_check($string);
+			preg_match('~^(' . $ent_list . '|.){' . $smcFunc['strlen'](substr($string, 0, $length)) . '}~' . ($utf8 ? 'u' : ''), $string, $matches);
 			$string = $matches[0];
 			while (strlen($string) > $length)
-				$string = preg_replace(\'~(?:' . $ent_list . '|.)$~'.  ($utf8 ? 'u' : '') . '\', \'\', $string);
-			return $string;'),
-		'ucfirst' => $utf8 ? create_function('$string', '
-			global $smcFunc;
-			return $smcFunc[\'strtoupper\']($smcFunc[\'substr\']($string, 0, 1)) . $smcFunc[\'substr\']($string, 1);') : 'ucfirst',
-		'ucwords' => $utf8 ? create_function('$string', '
-			global $smcFunc;
-			$words = preg_split(\'~([\s\r\n\t]+)~\', $string, -1, PREG_SPLIT_DELIM_CAPTURE);
+				$string = preg_replace('~(?:' . $ent_list . '|.)$~' . ($utf8 ? 'u' : ''), '', $string);
+			return $string;
+		},
+		'ucfirst' => $utf8 ? function($string) use (&$smcFunc)
+		{
+			return $smcFunc['strtoupper']($smcFunc['substr']($string, 0, 1)) . $smcFunc['substr']($string, 1);
+		} : 'ucfirst',
+		'ucwords' => $utf8 ? function($string) use (&$smcFunc)
+		{
+			$words = preg_split('~([\s\r\n\t]+)~', $string, -1, PREG_SPLIT_DELIM_CAPTURE);
 			for ($i = 0, $n = count($words); $i < $n; $i += 2)
-				$words[$i] = $smcFunc[\'ucfirst\']($words[$i]);
-			return implode(\'\', $words);') : 'ucwords',
+				$words[$i] = $smcFunc['ucfirst']($words[$i]);
+			return implode('', $words);
+		} : 'ucwords',
 	);
 
 	// Setting the timezone is a requirement for some functions in PHP >= 5.1.
@@ -335,6 +377,8 @@ function loadUserSettings()
 {
 	global $modSettings, $user_settings, $sourcedir, $smcFunc;
 	global $cookiename, $user_info, $language;
+	global $boardurl, $image_proxy_enabled, $image_proxy_secret;
+	global $cookie_no_auth_secret;
 
 	// Check first the integration, then the cookie, and last the session.
 	if (count($integration_ids = call_integration_hook('integrate_verify_user')) > 0)
@@ -391,6 +435,9 @@ function loadUserSettings()
 			$user_settings = $smcFunc['db_fetch_assoc']($request);
 			$smcFunc['db_free_result']($request);
 
+			if (!empty($user_settings['avatar']))
+				$user_settings['avatar'] = get_proxied_url($user_settings['avatar']);
+
 			if (!empty($modSettings['cache_enable']) && $modSettings['cache_enable'] >= 2)
 				cache_put_data('user_settings-' . $id_member, $user_settings, 60);
 		}
@@ -403,7 +450,7 @@ function loadUserSettings()
 				$check = true;
 			// SHA-1 passwords should be 40 characters long.
 			elseif (strlen($password) == 40)
-				$check = sha1($user_settings['passwd'] . $user_settings['password_salt']) == $password;
+				$check = empty($cookie_no_auth_secret) ? hash_hmac('sha1', sha1($user_settings['passwd'] . $user_settings['password_salt']), get_auth_secret()) == $password : sha1($user_settings['passwd'] . $user_settings['password_salt']) == $password;
 			else
 				$check = false;
 
@@ -709,7 +756,7 @@ function loadBoard()
 				'posts_count' => empty($row['count_posts']),
 				'cur_topic_approved' => empty($topic) || $row['approved'],
 				'cur_topic_starter' => empty($topic) ? 0 : $row['id_member_started'],
-				
+
 				'gpbp_enabled' => !empty($row['enable_gpbp']),
 			);
 
@@ -974,6 +1021,7 @@ function loadPermissions()
 function loadMemberData($users, $is_name = false, $set = 'normal')
 {
 	global $user_profile, $modSettings, $board_info, $smcFunc;
+	global $boardurl, $image_proxy_enabled, $image_proxy_secret, $user_info;
 	// Can't just look for no users :P.
 	if (empty($users))
 		return false;
@@ -1035,7 +1083,7 @@ function loadMemberData($users, $is_name = false, $set = 'normal')
 			CASE WHEN mem.id_group = 0 OR mg.stars = {string:blank_string} THEN pg.stars ELSE mg.stars END AS stars, mem.password_salt, mem.pm_prefs';
 
 		$select_columns .= ',
-			mem.gpbp_respect';		
+			mem.gpbp_respect';
 
 		$select_tables = '
 			LEFT JOIN {db_prefix}log_online AS lo ON (lo.id_member = mem.id_member)
@@ -1068,6 +1116,14 @@ function loadMemberData($users, $is_name = false, $set = 'normal')
 		$new_loaded_ids = array();
 		while ($row = $smcFunc['db_fetch_assoc']($request))
 		{
+			// If the image proxy is enabled, we still want the original URL when they're editing the profile...
+			if (isset($row['avatar']))
+				$row['avatar_original'] = $row['avatar'];
+
+			// Take care of proxying avatar if required, do this here for maximum reach
+			if (!empty($row['avatar']))
+				$row['avatar'] = get_proxied_url($row['avatar']);
+
 			$new_loaded_ids[] = $row['id_member'];
 			$loaded_ids[] = $row['id_member'];
 			$row['options'] = array();
@@ -1216,9 +1272,9 @@ function loadMemberContext($user, $display_custom_fields = false)
 		'location' => $profile['location'],
 		'icq' => $profile['icq'] != '' && (empty($modSettings['guest_hideContacts']) || !$user_info['is_guest']) ? array(
 			'name' => $profile['icq'],
-			'href' => 'http://www.icq.com/whitepages/about_me.php?uin=' . $profile['icq'],
-			'link' => '<a class="icq new_win" href="http://www.icq.com/whitepages/about_me.php?uin=' . $profile['icq'] . '" target="_blank" title="' . $txt['icq_title'] . ' - ' . $profile['icq'] . '"><img src="http://status.icq.com/online.gif?img=5&amp;icq=' . $profile['icq'] . '" alt="' . $txt['icq_title'] . ' - ' . $profile['icq'] . '" width="18" height="18" /></a>',
-			'link_text' => '<a class="icq extern" href="http://www.icq.com/whitepages/about_me.php?uin=' . $profile['icq'] . '" title="' . $txt['icq_title'] . ' - ' . $profile['icq'] . '">' . $profile['icq'] . '</a>',
+			'href' => 'https://www.icq.com/whitepages/about_me.php?uin=' . $profile['icq'],
+			'link' => '<a class="icq new_win" href="https://www.icq.com/whitepages/about_me.php?uin=' . $profile['icq'] . '" target="_blank" title="' . $txt['icq_title'] . ' - ' . $profile['icq'] . '"><img src="https://status.icq.com/online.gif?img=5&amp;icq=' . $profile['icq'] . '" alt="' . $txt['icq_title'] . ' - ' . $profile['icq'] . '" width="18" height="18" /></a>',
+			'link_text' => '<a class="icq extern" href="https://www.icq.com/whitepages/about_me.php?uin=' . $profile['icq'] . '" title="' . $txt['icq_title'] . ' - ' . $profile['icq'] . '">' . $profile['icq'] . '</a>',
 		) : array('name' => '', 'add' => '', 'href' => '', 'link' => '', 'link_text' => ''),
 		'aim' => $profile['aim'] != '' && (empty($modSettings['guest_hideContacts']) || !$user_info['is_guest']) ? array(
 			'name' => $profile['aim'],
@@ -1228,22 +1284,23 @@ function loadMemberContext($user, $display_custom_fields = false)
 		) : array('name' => '', 'href' => '', 'link' => '', 'link_text' => ''),
 		'yim' => $profile['yim'] != '' && (empty($modSettings['guest_hideContacts']) || !$user_info['is_guest']) ? array(
 			'name' => $profile['yim'],
-			'href' => 'http://edit.yahoo.com/config/send_webmesg?.target=' . urlencode($profile['yim']),
-			'link' => '<a class="yim" href="http://edit.yahoo.com/config/send_webmesg?.target=' . urlencode($profile['yim']) . '" title="' . $txt['yim_title'] . ' - ' . $profile['yim'] . '"><img src="http://opi.yahoo.com/online?u=' . urlencode($profile['yim']) . '&amp;m=g&amp;t=0" alt="' . $txt['yim_title'] . ' - ' . $profile['yim'] . '" /></a>',
-			'link_text' => '<a class="yim" href="http://edit.yahoo.com/config/send_webmesg?.target=' . urlencode($profile['yim']) . '" title="' . $txt['yim_title'] . ' - ' . $profile['yim'] . '">' . $profile['yim'] . '</a>'		) : array('name' => '', 'href' => '', 'link' => '', 'link_text' => ''),
+			'href' => 'https://edit.yahoo.com/config/send_webmesg?.target=' . urlencode($profile['yim']),
+			'link' => '<a class="yim" href="https://edit.yahoo.com/config/send_webmesg?.target=' . urlencode($profile['yim']) . '" title="' . $txt['yim_title'] . ' - ' . $profile['yim'] . '"><img src="https://opi.yahoo.com/online?u=' . urlencode($profile['yim']) . '&amp;m=g&amp;t=0" alt="' . $txt['yim_title'] . ' - ' . $profile['yim'] . '" /></a>',
+			'link_text' => '<a class="yim" href="https://edit.yahoo.com/config/send_webmesg?.target=' . urlencode($profile['yim']) . '" title="' . $txt['yim_title'] . ' - ' . $profile['yim'] . '">' . $profile['yim'] . '</a>'
+		) : array('name' => '', 'href' => '', 'link' => '', 'link_text' => ''),
 		'msn' => $profile['msn'] !='' && (empty($modSettings['guest_hideContacts']) || !$user_info['is_guest']) ? array(
 			'name' => $profile['msn'],
-			'href' => 'http://members.msn.com/' . $profile['msn'],
-			'link' => '<a class="msn new_win" href="http://members.msn.com/' . $profile['msn'] . '" title="' . $txt['msn_title'] . ' - ' . $profile['msn'] . '"><img src="' . $settings['images_url'] . '/msntalk.gif" alt="' . $txt['msn_title'] . ' - ' . $profile['msn'] . '" /></a>',
-			'link_text' => '<a class="msn new_win" href="http://members.msn.com/' . $profile['msn'] . '" title="' . $txt['msn_title'] . ' - ' . $profile['msn'] . '">' . $profile['msn'] . '</a>'
+			'href' => 'https://members.msn.com/' . $profile['msn'],
+			'link' => '<a class="msn new_win" href="https://members.msn.com/' . $profile['msn'] . '" title="' . $txt['msn_title'] . ' - ' . $profile['msn'] . '"><img src="' . $settings['images_url'] . '/msntalk.gif" alt="' . $txt['msn_title'] . ' - ' . $profile['msn'] . '" /></a>',
+			'link_text' => '<a class="msn new_win" href="https://members.msn.com/' . $profile['msn'] . '" title="' . $txt['msn_title'] . ' - ' . $profile['msn'] . '">' . $profile['msn'] . '</a>'
 		) : array('name' => '', 'href' => '', 'link' => '', 'link_text' => ''),
 		'real_posts' => $profile['posts'],
 		'posts' => $profile['posts'] > 500000 ? $txt['geek'] : comma_format($profile['posts']),
 				'avatar' => array(
 			'name' => $profile['avatar'],
-			'image' => $profile['avatar'] == '' ? ($profile['id_attach'] > 0 ? '<img class="avatar" src="' . (empty($profile['attachment_type']) ? $scripturl . '?action=dlattach;attach=' . $profile['id_attach'] . ';type=avatar' : $modSettings['custom_avatar_url'] . '/' . $profile['filename']) . '" alt="" />' : '') : (stristr($profile['avatar'], 'http://') ? '<img class="avatar" src="' . $profile['avatar'] . '"' . $avatar_width . $avatar_height . ' alt="" />' : '<img class="avatar" src="' . $modSettings['avatar_url'] . '/' . htmlspecialchars($profile['avatar']) . '" alt="" />'),
-			'href' => $profile['avatar'] == '' ? ($profile['id_attach'] > 0 ? (empty($profile['attachment_type']) ? $scripturl . '?action=dlattach;attach=' . $profile['id_attach'] . ';type=avatar' : $modSettings['custom_avatar_url'] . '/' . $profile['filename']) : '') : (stristr($profile['avatar'], 'http://') ? $profile['avatar'] : $modSettings['avatar_url'] . '/' . $profile['avatar']),
-			'url' => $profile['avatar'] == '' ? '' : (stristr($profile['avatar'], 'http://') ? $profile['avatar'] : $modSettings['avatar_url'] . '/' . $profile['avatar'])
+			'image' => $profile['avatar'] == '' ? ($profile['id_attach'] > 0 ? '<img class="avatar" src="' . (empty($profile['attachment_type']) ? $scripturl . '?action=dlattach;attach=' . $profile['id_attach'] . ';type=avatar' : $modSettings['custom_avatar_url'] . '/' . $profile['filename']) . '" alt="" />' : '') : ((stristr($profile['avatar'], 'http://') || stristr($profile['avatar'], 'https://')) ? '<img class="avatar" src="' . $profile['avatar'] . '"' . $avatar_width . $avatar_height . ' alt="" />' : '<img class="avatar" src="' . $modSettings['avatar_url'] . '/' . htmlspecialchars($profile['avatar']) . '" alt="" />'),
+			'href' => $profile['avatar'] == '' ? ($profile['id_attach'] > 0 ? (empty($profile['attachment_type']) ? $scripturl . '?action=dlattach;attach=' . $profile['id_attach'] . ';type=avatar' : $modSettings['custom_avatar_url'] . '/' . $profile['filename']) : '') : ((stristr($profile['avatar'], 'http://') || stristr($profile['avatar'], 'https://')) ? $profile['avatar'] : $modSettings['avatar_url'] . '/' . $profile['avatar']),
+			'url' => $profile['avatar'] == '' ? '' : ((stristr($profile['avatar'], 'http://') || stristr($profile['avatar'], 'https://')) ? $profile['avatar'] : $modSettings['avatar_url'] . '/' . $profile['avatar'])
 		),
 		'last_login' => empty($profile['last_login']) ? $txt['never'] : timeformat($profile['last_login']),
 		'last_login_timestamp' => empty($profile['last_login']) ? 0 : forum_time(0, $profile['last_login']),
@@ -1512,6 +1569,36 @@ function loadTheme($id_theme = 0, $initialize = true)
 	if (!$initialize)
 		return;
 
+	// Perhaps we've changed the agreement or privacy policy? Only redirect if:
+	// 1. They're not a guest or admin
+	// 2. This isn't called from SSI
+	// 3. This isn't an XML request
+	// 4. They're not trying to do any of the following actions:
+	// 4a. View or accept the agreement and/or policy
+	// 4b. Login or logout
+	// 4c. Get a feed (RSS, ATOM, etc.)
+	if (!$user_info['is_guest'] && !$user_info['is_admin'] && SMF != 'SSI' && !isset($_REQUEST['xml']) && (!isset($_REQUEST['action']) || !in_array($_REQUEST['action'], array('agreement', 'acceptagreement', 'login2', 'logout', '.xml'))))
+	{
+		$agreement_lang = !empty($modSettings['agreement_updated_' . $user_info['language']]) ? $user_info['language'] : 'default';
+		$policy_lang = !empty($modSettings['policy_' . $user_info['language']]) ? $user_info['language'] : $language;
+
+		// Do they need to accept the latest registration agreement?
+		if (!empty($modSettings['requireAgreement']) && !empty($modSettings['agreement_updated_' . $agreement_lang]) && (empty($options['agreement_accepted']) || $modSettings['agreement_updated_' . $agreement_lang] > $options['agreement_accepted']))
+		{
+			$agreement_subaction = 'agreement';
+		}
+
+		// Do they need to consent to the latest privacy policy?
+		if (!empty($modSettings['requirePolicyAgreement']) && !empty($modSettings['policy_updated_' . $policy_lang]) && (empty($options['policy_accepted']) || $modSettings['policy_updated_' . $policy_lang] > $options['policy_accepted']))
+		{
+			$agreement_subaction = !empty($agreement_subaction) ? 'both' : 'policy';
+		}
+
+		// Send them to the right place
+		if (!empty($agreement_subaction))
+			redirectexit('action=agreement;sa=' . $agreement_subaction);
+	}
+
 	// Check to see if they're accessing it from the wrong place.
 	if (isset($_SERVER['HTTP_HOST']) || isset($_SERVER['SERVER_NAME']))
 	{
@@ -1544,7 +1631,9 @@ function loadTheme($id_theme = 0, $initialize = true)
 				redirectexit('wwwRedirect');
 			else
 			{
-				list ($k, $v) = each($_GET);
+				reset($_GET);
+				$k = key($_GET);
+				$v = $_GET[$k];
 
 				if ($k != 'wwwRedirect')
 					redirectexit('wwwRedirect;' . $k . '=' . $v);
@@ -2424,6 +2513,11 @@ function loadSession()
 		// Use database sessions? (they don't work in 4.1.x!)
 		if (!empty($modSettings['databaseSession_enable']) && @version_compare(PHP_VERSION, '4.2.0') != -1)
 		{
+			@ini_set('session.serialize_handler', 'php_serialize');
+
+			if (ini_get('session.serialize_handler') != 'php_serialize')
+				@ini_set('session.serialize_handler', 'php');
+
 			session_set_save_handler('sessionOpen', 'sessionClose', 'sessionRead', 'sessionWrite', 'sessionDestroy', 'sessionGC');
 			@ini_set('session.gc_probability', '1');
 		}
@@ -2489,8 +2583,7 @@ function sessionRead($session_id)
 	list ($sess_data) = $smcFunc['db_fetch_row']($result);
 	$smcFunc['db_free_result']($result);
 
-return $sess_data;
-
+	return $sess_data != null ? $sess_data : '';
 }
 
 function sessionWrite($session_id, $data)
@@ -2521,7 +2614,7 @@ array($session_id, $data, time()),
 			array('session_id')
 		);
 
-	return $result;
+	return true;
 }
 
 function sessionDestroy($session_id)
@@ -2531,14 +2624,16 @@ function sessionDestroy($session_id)
 	if (preg_match('~^[A-Za-z0-9,-]{16,32}$~', $session_id) == 0)
 		return false;
 
-// Just delete the row...
-	return $smcFunc['db_query']('', '
+	// Just delete the row...
+	$smcFunc['db_query']('', '
 		DELETE FROM {db_prefix}sessions
 		WHERE session_id = {string:session_id}',
 		array(
 			'session_id' => $session_id,
 		)
 	);
+
+	return true;
 }
 
 function sessionGC($max_lifetime)
@@ -2550,13 +2645,15 @@ function sessionGC($max_lifetime)
 		$max_lifetime = max($modSettings['databaseSession_lifetime'], 60);
 
 	// Clean up ;).
-	return $smcFunc['db_query']('', '
+	$smcFunc['db_query']('', '
 		DELETE FROM {db_prefix}sessions
 		WHERE last_update < {int:last_update}',
 		array(
 			'last_update' => time() - $max_lifetime,
 		)
 	);
+
+	return $smcFunc['db_affected_rows']() != 0;
 }
 
 // Load up a database connection.
@@ -2776,9 +2873,16 @@ function cache_get_data($key, $ttl = 120)
 	elseif (function_exists('xcache_get') && ini_get('xcache.var_size') > 0)
 		$value = xcache_get($key);
 	// Otherwise it's SMF data!
-	elseif (file_exists($cachedir . '/data_' . $key . '.php') && filesize($cachedir . '/data_' . $key . '.php') > 10)
+	elseif (file_exists($cachedir . '/data_' . $key . '.php'))
 	{
+		// Turns out that include does not honor locking, but we need it to.
+		// This can be accomplished by placing a small wrapper around it:
+		$tmp = fopen($cachedir . '/data_' . $key . '.php', 'rb');
+		@flock($tmp, LOCK_SH);
 		@include($cachedir . '/data_' . $key . '.php');
+		@flock($tmp, LOCK_UN);
+		fclose($tmp);
+
 		if (!empty($expired) && isset($value))
 		{
 			@unlink($cachedir . '/data_' . $key . '.php');
@@ -2819,4 +2923,34 @@ function get_memcached_server($level = 3)
 		get_memcached_server($level - 1);
 }
 
-?>
\ No newline at end of file
+function get_auth_secret()
+{
+	global $auth_secret, $sourcedir;
+
+	if (empty($auth_secret))
+	{
+		// Best.
+		if (function_exists('random_bytes'))
+			$auth_secret = bin2hex(random_bytes(32));
+
+		// Equally good, if installed.
+		elseif (function_exists('mcrypt_create_iv'))
+			$auth_secret = bin2hex(mcrypt_create_iv(32));
+
+		// Good enough.
+		elseif (function_exists('openssl_random_pseudo_bytes'))
+			$auth_secret = bin2hex(openssl_random_pseudo_bytes(32));
+
+		// Less than ideal, but we're out of options.
+		else
+			$auth_secret = hash('sha256', mt_rand());
+
+		// It is important to store this in Settings.php, not the database.
+		require_once($sourcedir . '/Subs-Admin.php');
+		updateSettingsFile(array('auth_secret' => '\'' . $auth_secret . '\''));
+	}
+
+	return $auth_secret;
+}
+
+?>
diff --git a/Sources/LogInOut.php b/Sources/LogInOut.php
index a651463..c382183 100644
--- a/Sources/LogInOut.php
+++ b/Sources/LogInOut.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.13
+ * @version 2.0.14
  */
 
 if (!defined('SMF'))
@@ -139,6 +139,7 @@ function Login2()
 		redirectexit();
 
 	// Are you guessing with a script?
+	checkSession('post');
 	spamProtection('login');
 
 	// Set the login_url if it's not already set (but careful not to send us to an attachment).
@@ -352,7 +353,7 @@ function Login2()
 			$other_passwords[] = sha1($user_settings['password_salt'] . sha1($user_settings['password_salt'] . sha1($_POST['passwrd'])));
 
 			// Perhaps we converted to UTF-8 and have a valid password being hashed differently.
-			if ($context['character_set'] == 'utf8' && !empty($modSettings['previousCharacterSet']) && $modSettings['previousCharacterSet'] != 'utf8')
+			if ($context['character_set'] == 'UTF-8' && !empty($modSettings['previousCharacterSet']) && $modSettings['previousCharacterSet'] != 'utf8')
 			{
 				// Try iconv first, for no particular reason.
 				if (function_exists('iconv'))
diff --git a/Sources/ManageAttachments.php b/Sources/ManageAttachments.php
index 227afee..dae53e2 100644
--- a/Sources/ManageAttachments.php
+++ b/Sources/ManageAttachments.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -327,37 +327,36 @@ function BrowseFiles()
 					'value' => $txt['attachment_name'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $modSettings, $context, $scripturl;
-
-						$link = \'<a href="\';
+					'function' => function($rowData) use ($modSettings, $context, $scripturl)
+					{
+						$link = '<a href="';
 
 						// In case of a custom avatar URL attachments have a fixed directory.
-						if ($rowData[\'attachment_type\'] == 1)
-							$link .= sprintf(\'%1$s/%2$s\', $modSettings[\'custom_avatar_url\'], $rowData[\'filename\']);
+						if ($rowData['attachment_type'] == 1)
+							$link .= sprintf('%1$s/%2$s', $modSettings['custom_avatar_url'], $rowData['filename']);
 
 						// By default avatars are downloaded almost as attachments.
-						elseif ($context[\'browse_type\'] == \'avatars\')
-							$link .= sprintf(\'%1$s?action=dlattach;type=avatar;attach=%2$d\', $scripturl, $rowData[\'id_attach\']);
+						elseif ($context['browse_type'] == 'avatars')
+							$link .= sprintf('%1$s?action=dlattach;type=avatar;attach=%2$d', $scripturl, $rowData['id_attach']);
 
 						// Normal attachments are always linked to a topic ID.
 						else
-							$link .= sprintf(\'%1$s?action=dlattach;topic=%2$d.0;attach=%3$d\', $scripturl, $rowData[\'id_topic\'], $rowData[\'id_attach\']);
+							$link .= sprintf('%1$s?action=dlattach;topic=%2$d.0;attach=%3$d', $scripturl, $rowData['id_topic'], $rowData['id_attach']);
 
-						$link .= \'"\';
+						$link .= '"';
 
-						// Show a popup on click if it\'s a picture and we know its dimensions.
-						if (!empty($rowData[\'width\']) && !empty($rowData[\'height\']))
-							$link .= sprintf(\' onclick="return reqWin(this.href\' . ($rowData[\'attachment_type\'] == 1 ? \'\' : \' + \\\';image\\\'\') . \', %1$d, %2$d, true);"\', $rowData[\'width\'] + 20, $rowData[\'height\'] + 20);
+						// Show a popup on click if it's a picture and we know its dimensions.
+						if (!empty($rowData['width']) && !empty($rowData['height']))
+							$link .= sprintf(' onclick="return reqWin(this.href' . ($rowData['attachment_type'] == 1 ? '' : '+ \';image\'') . ', %1$d, %2$d, true);"', $rowData['width'] + 20, $rowData['height'] + 20);
 
-						$link .= sprintf(\'>%1$s</a>\', preg_replace(\'~&amp;#(\\\\d{1,7}|x[0-9a-fA-F]{1,6});~\', \'&#\\\\1;\', htmlspecialchars($rowData[\'filename\'])));
+						$link .= sprintf('>%1$s</a>', preg_replace('~&amp;#(\\\\d{1,7}|x[0-9a-fA-F]{1,6});~', '&#\\\\1;', htmlspecialchars($rowData['filename'])));
 
 						// Show the dimensions.
-						if (!empty($rowData[\'width\']) && !empty($rowData[\'height\']))
-							$link .= sprintf(\' <span class="smalltext">%1$dx%2$d</span>\', $rowData[\'width\'], $rowData[\'height\']);
+						if (!empty($rowData['width']) && !empty($rowData['height']))
+							$link .= sprintf(' <span class="smalltext">%1$dx%2$d</span>', $rowData['width'], $rowData['height']);
 
 						return $link;
-					'),
+					},
 				),
 				'sort' => array(
 					'default' => 'a.filename',
@@ -369,11 +368,10 @@ function BrowseFiles()
 					'value' => $txt['attachment_file_size'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData','
-						global $txt;
-
-						return sprintf(\'%1$s%2$s\', round($rowData[\'size\'] / 1024, 2), $txt[\'kilobyte\']);
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return sprintf('%1$s%2$s', round($rowData['size'] / 1024, 2), $txt['kilobyte']);
+					},
 					'class' => 'windowbg',
 				),
 				'sort' => array(
@@ -386,17 +384,16 @@ function BrowseFiles()
 					'value' => $context['browse_type'] == 'avatars' ? $txt['attachment_manager_member'] : $txt['posted_by'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl;
-
+					'function' => function($rowData) use ($scripturl)
+					{
 						// In case of an attachment, return the poster of the attachment.
-						if (empty($rowData[\'id_member\']))
-							return htmlspecialchars($rowData[\'poster_name\']);
+						if (empty($rowData['id_member']))
+							return htmlspecialchars($rowData['poster_name']);
 
 						// Otherwise it must be an avatar, return the link to the owner of it.
 						else
-							return sprintf(\'<a href="%1$s?action=profile;u=%2$d">%3$s</a>\', $scripturl, $rowData[\'id_member\'], $rowData[\'poster_name\']);
-					'),
+							return sprintf('<a href="%1$s?action=profile;u=%2$d">%3$s</a>', $scripturl, $rowData['id_member'], $rowData['poster_name']);
+					},
 				),
 				'sort' => array(
 					'default' => 'mem.real_name',
@@ -408,18 +405,17 @@ function BrowseFiles()
 					'value' => $context['browse_type'] == 'avatars' ? $txt['attachment_manager_last_active'] : $txt['date'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt, $context, $scripturl;
-
+					'function' => function($rowData) use ($txt, $context, $scripturl)
+					{
 						// The date the message containing the attachment was posted or the owner of the avatar was active.
-						$date = empty($rowData[\'poster_time\']) ? $txt[\'never\'] : timeformat($rowData[\'poster_time\']);
+						$date = empty($rowData['poster_time']) ? $txt['never'] : timeformat($rowData['poster_time']);
 
 						// Add a link to the topic in case of an attachment.
-						if ($context[\'browse_type\'] !== \'avatars\')
-							$date .= sprintf(\'<br />%1$s <a href="%2$s?topic=%3$d.msg%4$d#msg%4$d">%5$s</a>\', $txt[\'in\'], $scripturl, $rowData[\'id_topic\'], $rowData[\'id_msg\'], $rowData[\'subject\']);
+						if ($context['browse_type'] !== 'avatars')
+							$date .= sprintf('<br />%1$s <a href="%2$s?topic=%3$d.msg%4$d#msg%4$d">%5$s</a>', $txt['in'], $scripturl, $rowData['id_topic'], $rowData['id_msg'], $rowData['subject']);
 
 						return $date;
-						'),
+					},
 					'class' => 'windowbg',
 				),
 				'sort' => array(
@@ -432,11 +428,10 @@ function BrowseFiles()
 					'value' => $txt['downloads'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData','
-						global $txt;
-
-						return comma_format($rowData[\'downloads\']);
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return comma_format($rowData['downloads']);
+					},
 					'class' => 'windowbg',
 				),
 				'sort' => array(
@@ -1673,9 +1668,10 @@ function ManageAttachmentPaths()
 					'value' => $txt['attach_current_dir'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return \'<input type="radio" name="current_dir" value="\' . $rowData[\'id\'] . \'" \' . ($rowData[\'current\'] ? \'checked="checked"\' : \'\') . \' class="input_radio" />\';
-					'),
+					'function' => function($rowData)
+					{
+						return '<input type="radio" name="current_dir" value="' . $rowData['id'] . '" ' . ($rowData['current'] ? 'checked="checked"' : '') . ' class="input_radio" />';
+					},
 					'style' => 'text-align: center; width: 15%;',
 				),
 			),
@@ -1684,9 +1680,10 @@ function ManageAttachmentPaths()
 					'value' => $txt['attach_path'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return \'<input type="text" size="30" name="dirs[\' . $rowData[\'id\'] . \']" value="\' . $rowData[\'path\'] . \'" class="input_text" style="width: 100%" />\';
-					'),
+					'function' => function($rowData)
+					{
+						return '<input type="text" size="30" name="dirs[' . $rowData['id'] . ']" value="' . $rowData['path'] . '" class="input_text" style="width: 100%" />';
+					},
 					'style' => 'text-align: center; width: 30%;',
 				),
 			),
diff --git a/Sources/ManageBans.php b/Sources/ManageBans.php
index 48e38d9..0f97daa 100644
--- a/Sources/ManageBans.php
+++ b/Sources/ManageBans.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -240,11 +240,10 @@ function BanList()
 					'value' => $txt['ban_added'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context;
-
-						return timeformat($rowData[\'ban_time\'], empty($context[\'ban_time_format\']) ? true : $context[\'ban_time_format\']);
-					'),
+					'function' => function($rowData) use ($context)
+					{
+						return timeformat($rowData['ban_time'], empty($context['ban_time_format']) ? true : $context['ban_time_format']);
+					},
 				),
 				'sort' => array(
 					'default' => 'bg.ban_time',
@@ -256,21 +255,20 @@ function BanList()
 					'value' => $txt['ban_expires'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
+					'function' => function($rowData) use ($txt)
+					{
 						// This ban never expires...whahaha.
-						if ($rowData[\'expire_time\'] === null)
-							return $txt[\'never\'];
+						if ($rowData['expire_time'] === null)
+							return $txt['never'];
 
 						// This ban has already expired.
-						elseif ($rowData[\'expire_time\'] < time())
-							return sprintf(\'<span style="color: red">%1$s</span>\', $txt[\'ban_expired\']);
+						elseif ($rowData['expire_time'] < time())
+							return sprintf('<span style="color: red">%1$s</span>', $txt['ban_expired']);
 
 						// Still need to wait a few days for this ban to expire.
 						else
-							return sprintf(\'%1$d&nbsp;%2$s\', ceil(($rowData[\'expire_time\'] - time()) / (60 * 60 * 24)), $txt[\'ban_days\']);
-					'),
+							return sprintf('%1$d&nbsp;%2$s', ceil(($rowData['expire_time'] - time()) / (60 * 60 * 24)), $txt['ban_days']);
+					},
 				),
 				'sort' => array(
 					'default' => 'IFNULL(bg.expire_time, 1=1) DESC, bg.expire_time DESC',
@@ -1216,19 +1214,20 @@ function BanBrowseTriggers()
 	if ($context['selected_entity'] === 'ip')
 	{
 		$listOptions['columns']['banned_entity']['data'] = array(
-			'function' => create_function('$rowData', '
+			'function' => function($rowData)
+			{
 				return range2ip(array(
-					$rowData[\'ip_low1\'],
-					$rowData[\'ip_low2\'],
-					$rowData[\'ip_low3\'],
-					$rowData[\'ip_low4\']
+					$rowData['ip_low1'],
+					$rowData['ip_low2'],
+					$rowData['ip_low3'],
+					$rowData['ip_low4']
 				), array(
-					$rowData[\'ip_high1\'],
-					$rowData[\'ip_high2\'],
-					$rowData[\'ip_high3\'],
-					$rowData[\'ip_high4\']
+					$rowData['ip_high1'],
+					$rowData['ip_high2'],
+					$rowData['ip_high3'],
+					$rowData['ip_high4']
 				));
-			'),
+			},
 		);
 		$listOptions['columns']['banned_entity']['sort'] = array(
 			'default' => 'bi.ip_low1, bi.ip_high1, bi.ip_low2, bi.ip_high2, bi.ip_low3, bi.ip_high3, bi.ip_low4, bi.ip_high4',
@@ -1238,10 +1237,10 @@ function BanBrowseTriggers()
 	elseif ($context['selected_entity'] === 'hostname')
 	{
 		$listOptions['columns']['banned_entity']['data'] = array(
-			'function' => create_function('$rowData', '
-				global $smcFunc;
-				return strtr($smcFunc[\'htmlspecialchars\']($rowData[\'hostname\']), array(\'%\' => \'*\'));
-			'),
+			'function' => function($rowData) use ($smcFunc)
+			{
+				return strtr($smcFunc['htmlspecialchars']($rowData['hostname']), array('%' => '*'));
+			},
 		);
 		$listOptions['columns']['banned_entity']['sort'] = array(
 			'default' => 'bi.hostname',
@@ -1251,10 +1250,10 @@ function BanBrowseTriggers()
 	elseif ($context['selected_entity'] === 'email')
 	{
 		$listOptions['columns']['banned_entity']['data'] = array(
-			'function' => create_function('$rowData', '
-				global $smcFunc;
-				return strtr($smcFunc[\'htmlspecialchars\']($rowData[\'email_address\']), array(\'%\' => \'*\'));
-			'),
+			'function' => function($rowData) use ($smcFunc)
+			{
+				return strtr($smcFunc['htmlspecialchars']($rowData['email_address']), array('%' => '*'));
+			},
 		);
 		$listOptions['columns']['banned_entity']['sort'] = array(
 			'default' => 'bi.email_address',
@@ -1445,9 +1444,10 @@ function BanLog()
 					'value' => $txt['ban_log_date'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return timeformat($rowData[\'log_time\']);
-					'),
+					'function' => function($rowData)
+					{
+						return timeformat($rowData['log_time']);
+					},
 				),
 				'sort' => array(
 					'default' => 'lb.log_time DESC',
diff --git a/Sources/ManageCalendar.php b/Sources/ManageCalendar.php
index a2ae4f3..96f738a 100644
--- a/Sources/ManageCalendar.php
+++ b/Sources/ManageCalendar.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -111,15 +111,14 @@ function ModifyHolidays()
 					'value' => $txt['date'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
+					'function' => function($rowData) use ($txt)
+					{
 						// Recurring every year or just a single year?
-						$year = $rowData[\'year\'] == \'0004\' ? sprintf(\'(%1$s)\', $txt[\'every_year\']) : $rowData[\'year\'];
+						$year = $rowData['year'] == '0004' ? sprintf('(%1$s)', $txt['every_year']) : $rowData['year'];
 
 						// Construct the date.
-						return sprintf(\'%1$d %2$s %3$s\', $rowData[\'day\'], $txt[\'months\'][(int) $rowData[\'month\']], $year);
-					'),
+						return sprintf('%1$d %2$s %3$s', $rowData['day'], $txt['months'][(int) $rowData['month']], $year);
+					},
 					'class' => 'windowbg',
 				),
 				'sort' => array(
diff --git a/Sources/ManageErrors.php b/Sources/ManageErrors.php
index 93fc9bd..47c4ed4 100644
--- a/Sources/ManageErrors.php
+++ b/Sources/ManageErrors.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.4
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -126,7 +126,7 @@ function ViewErrorLog()
 	for ($i = 0; $row = $smcFunc['db_fetch_assoc']($request); $i ++)
 	{
 		$search_message = preg_replace('~&lt;span class=&quot;remove&quot;&gt;(.+?)&lt;/span&gt;~', '%', $smcFunc['db_escape_wildcard_string']($row['message']));
-		if ($search_message == $filter['value']['sql'])
+		if (isset($filter) && $search_message == $filter['value']['sql'])
 			$search_message = $smcFunc['db_escape_wildcard_string']($row['message']);
 		$show_message = strtr(strtr(preg_replace('~&lt;span class=&quot;remove&quot;&gt;(.+?)&lt;/span&gt;~', '$1', $row['message']), array("\r" => '', '<br />' => "\n", '<' => '&lt;', '>' => '&gt;', '"' => '&quot;')), array("\n" => '<br />'));
 
diff --git a/Sources/ManageMail.php b/Sources/ManageMail.php
index 9b8b027..f325259 100644
--- a/Sources/ManageMail.php
+++ b/Sources/ManageMail.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -121,10 +121,10 @@ function BrowseMailQueue()
 					'value' => $txt['mailqueue_subject'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $smcFunc;
-						return $smcFunc[\'strlen\']($rowData[\'subject\']) > 50 ? sprintf(\'%1$s...\', htmlspecialchars($smcFunc[\'substr\']($rowData[\'subject\'], 0, 47))) : htmlspecialchars($rowData[\'subject\']);
-					'),
+					'function' => function($rowData) use ($smcFunc)
+					{
+						return $smcFunc['strlen']($rowData['subject']) > 50 ? sprintf('%1$s...', $smcFunc['htmlspecialchars']($smcFunc['substr']($rowData['subject'], 0, 47))) : $smcFunc['htmlspecialchars']($rowData['subject']);
+					},
 					'class' => 'smalltext',
 				),
 				'sort' => array(
@@ -155,15 +155,14 @@ function BrowseMailQueue()
 					'value' => $txt['mailqueue_priority'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
+					'function' => function($rowData) use ($txt)
+					{
 						// We probably have a text label with your priority.
-						$txtKey = sprintf(\'mq_mpriority_%1$s\', $rowData[\'priority\']);
+						$txtKey = sprintf('mq_mpriority_%1$s', $rowData['priority']);
 
 						// But if not, revert to priority 0.
-						return isset($txt[$txtKey]) ? $txt[$txtKey] : $txt[\'mq_mpriority_1\'];
-					'),
+						return isset($txt[$txtKey]) ? $txt[$txtKey] : $txt['mq_mpriority_1'];
+					},
 					'class' => 'smalltext',
 				),
 				'sort' => array(
@@ -176,9 +175,10 @@ function BrowseMailQueue()
 					'value' => $txt['mailqueue_age'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return time_since(time() - $rowData[\'time_sent\']);
-					'),
+					'function' => function($rowData)
+					{
+						return time_since(time() - $rowData['time_sent']);
+					},
 					'class' => 'smalltext',
 				),
 				'sort' => array(
@@ -191,9 +191,10 @@ function BrowseMailQueue()
 					'value' => '<input type="checkbox" onclick="invertAll(this, this.form);" class="input_check" />',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return \'<input type="checkbox" name="delete[]" value="\' . $rowData[\'id_mail\'] . \'" class="input_check" />\';
-					'),
+					'function' => function($rowData)
+					{
+						return '<input type="checkbox" name="delete[]" value="' . $rowData['id_mail'] . '">';
+					},
 					'class' => 'smalltext',
 				),
 			),
diff --git a/Sources/ManageMaintenance.php b/Sources/ManageMaintenance.php
index 634206a..8caa2ad 100644
--- a/Sources/ManageMaintenance.php
+++ b/Sources/ManageMaintenance.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.7
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -778,11 +778,6 @@ function ConvertEntities()
 	);
 	$context['num_tables'] = count($tables);
 
-	// This function will do the conversion later on.
-	$entity_replace = create_function('$string', '
-		$num = substr($string, 0, 1) === \'x\' ? hexdec(substr($string, 1)) : (int) $string;
-		return $num < 0x20 || $num > 0x10FFFF || ($num >= 0xD800 && $num <= 0xDFFF) ? \'\' : ($num < 0x80 ? \'&#\' . $num . \';\' : ($num < 0x800 ? chr(192 | $num >> 6) . chr(128 | $num & 63) : ($num < 0x10000 ? chr(224 | $num >> 12) . chr(128 | $num >> 6 & 63) . chr(128 | $num & 63) : chr(240 | $num >> 18) . chr(128 | $num >> 12 & 63) . chr(128 | $num >> 6 & 63) . chr(128 | $num & 63))));');
-
 	// Loop through all tables that need converting.
 	for (; $context['table'] < $context['num_tables']; $context['table']++)
 	{
@@ -830,20 +825,20 @@ function ConvertEntities()
 		if (empty($primary_key) || empty($columns))
 			continue;
 
-		// Get the maximum value for the primary key.
+		// Get the count of records.
 		$request = $smcFunc['db_query']('', '
-			SELECT MAX(' . $primary_key . ')
+			SELECT COUNT(*)
 			FROM {db_prefix}' . $cur_table,
 			array(
 			)
 		);
-		list($max_value) = $smcFunc['db_fetch_row']($request);
+		list($rec_count) = $smcFunc['db_fetch_row']($request);
 		$smcFunc['db_free_result']($request);
 
-		if (empty($max_value))
+		if (empty($rec_count))
 			continue;
 
-		while ($context['start'] <= $max_value)
+		while ($context['start'] <= $rec_count)
 		{
 			// Retrieve a list of rows that has at least one entity to convert.
 			$request = $smcFunc['db_query']('', '
@@ -869,7 +864,7 @@ function ConvertEntities()
 					if ($column_name !== $primary_key && strpos($column_value, '&#') !== false)
 					{
 						$changes[] = $column_name . ' = {string:changes_' . $column_name . '}';
-						$insertion_variables['changes_' . $column_name] = preg_replace_callback('~&#(\d{1,7}|x[0-9a-fA-F]{1,6});~', 'fixchar__callback', $column_value);
+						$insertion_variables['changes_' . $column_name] = preg_replace_callback('~&#(\d{1,7}|x[0-9a-fA-F]{1,6});~', 'fixchardb__callback', $column_value);
 					}
 
 				$where = array();
@@ -897,7 +892,7 @@ function ConvertEntities()
 			if (time() - $context['start_time'] > 10)
 			{
 				// Calculate an approximation of the percentage done.
-				$context['continue_percent'] = round(100 * ($context['table'] + ($context['start'] / $max_value)) / $context['num_tables'], 1);
+				$context['continue_percent'] = round(100 * ($context['table'] + ($context['start'] / $rec_count)) / $context['num_tables'], 1);
 				$context['continue_get_data'] = '?action=admin;area=maintain;sa=database;activity=convertentities;table=' . $context['table'] . ';start=' . $context['start'] . ';' . $context['session_var'] . '=' . $context['session_id'];
 				return;
 			}
diff --git a/Sources/ManageMembergroups.php b/Sources/ManageMembergroups.php
index 80f64e5..80067ec 100644
--- a/Sources/ManageMembergroups.php
+++ b/Sources/ManageMembergroups.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.7
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -131,26 +131,25 @@ function MembergroupIndex()
 					'value' => $txt['membergroups_name'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl;
-
+					'function' => function($rowData) use ($scripturl)
+					{
 						// Since the moderator group has no explicit members, no link is needed.
-						if ($rowData[\'id_group\'] == 3)
-							$group_name = $rowData[\'group_name\'];
+						if ($rowData['id_group'] == 3)
+							$group_name = $rowData['group_name'];
 						else
 						{
-							$color_style = empty($rowData[\'online_color\']) ? \'\' : sprintf(\' style="color: %1$s;"\', $rowData[\'online_color\']);
-							$group_name = sprintf(\'<a href="%1$s?action=admin;area=membergroups;sa=members;group=%2$d"%3$s>%4$s</a>\', $scripturl, $rowData[\'id_group\'], $color_style, $rowData[\'group_name\']);
+							$color_style = empty($rowData['online_color']) ? '' : sprintf(' style="color: %1$s;"', $rowData['online_color']);
+							$group_name = sprintf('<a href="%1$s?action=admin;area=membergroups;sa=members;group=%2$d"%3$s>%4$s</a>', $scripturl, $rowData['id_group'], $color_style, $rowData['group_name']);
 						}
 
 						// Add a help option for moderator and administrator.
-						if ($rowData[\'id_group\'] == 1)
-							$group_name .= sprintf(\' (<a href="%1$s?action=helpadmin;help=membergroup_administrator" onclick="return reqWin(this.href);">?</a>)\', $scripturl);
-						elseif ($rowData[\'id_group\'] == 3)
-							$group_name .= sprintf(\' (<a href="%1$s?action=helpadmin;help=membergroup_moderator" onclick="return reqWin(this.href);">?</a>)\', $scripturl);
+						if ($rowData['id_group'] == 1)
+							$group_name .= sprintf(' (<a href="%1$s?action=helpadmin;help=membergroup_administrator" onclick="return reqWin(this.href);">?</a>)', $scripturl);
+						elseif ($rowData['id_group'] == 3)
+							$group_name .= sprintf(' (<a href="%1$s?action=helpadmin;help=membergroup_moderator" onclick="return reqWin(this.href);">?</a>)', $scripturl);
 
 						return $group_name;
-					'),
+					},
 				),
 				'sort' => array(
 					'default' => 'CASE WHEN id_group < 4 THEN id_group ELSE 4 END, group_name',
@@ -162,23 +161,21 @@ function MembergroupIndex()
 					'value' => $txt['membergroups_stars'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $settings;
-
-						$stars = explode(\'#\', $rowData[\'stars\']);
+					'function' => function($rowData) use ($settings)
+					{
+						$stars = explode('#', $rowData['stars']);
 
 						// In case no stars are setup, return with nothing
 						if (empty($stars[0]) || empty($stars[1]))
-							return \'\';
+							return '';
 
 						// Otherwise repeat the image a given number of times.
 						else
 						{
-							$image = sprintf(\'<img src="%1$s/%2$s" alt="*" />\', $settings[\'images_url\'], $stars[1]);
+							$image = sprintf('<img src="%1$s/%2$s" alt="*" />', $settings['images_url'], $stars[1]);
 							return str_repeat($image, $stars[0]);
 						}
-					'),
-
+					},
 				),
 				'sort' => array(
 					'default' => 'stars',
@@ -190,12 +187,11 @@ function MembergroupIndex()
 					'value' => $txt['membergroups_members_top'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
+					'function' => function($rowData) use ($txt)
+					{
 						// No explicit members for the moderator group.
-						return $rowData[\'id_group\'] == 3 ? $txt[\'membergroups_guests_na\'] : $rowData[\'num_members\'];
-					'),
+						return $rowData['id_group'] == 3 ? $txt['membergroups_guests_na'] : $rowData['num_members'];
+					},
 					'style' => 'text-align: center',
 				),
 				'sort' => array(
@@ -252,12 +248,11 @@ function MembergroupIndex()
 					'value' => $txt['membergroups_name'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl;
-
-						$colorStyle = empty($rowData[\'online_color\']) ? \'\' : sprintf(\' style="color: %1$s;"\', $rowData[\'online_color\']);
-						return sprintf(\'<a href="%1$s?action=moderate;area=viewgroups;sa=members;group=%2$d"%3$s>%4$s</a>\', $scripturl, $rowData[\'id_group\'], $colorStyle, $rowData[\'group_name\']);
-					'),
+					'function' => function($rowData) use ($scripturl)
+					{
+						$colorStyle = empty($rowData['online_color']) ? '' : sprintf(' style="color: %1$s;"', $rowData['online_color']);
+						return sprintf('<a href="%1$s?action=moderate;area=viewgroups;sa=members;group=%2$d"%3$s>%4$s</a>', $scripturl, $rowData['id_group'], $colorStyle, $rowData['group_name']);
+					},
 				),
 				'sort' => array(
 					'default' => 'group_name',
@@ -269,19 +264,18 @@ function MembergroupIndex()
 					'value' => $txt['membergroups_stars'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $settings;
-
-						$stars = explode(\'#\', $rowData[\'stars\']);
+					'function' => function($rowData) use ($settings)
+					{
+						$stars = explode('#', $rowData['stars']);
 
 						if (empty($stars[0]) || empty($stars[1]))
-							return \'\';
+							return '';
 						else
 						{
-							$star_image = sprintf(\'<img src="%1$s/%2$s" alt="*" />\', $settings[\'images_url\'], $stars[1]);
+							$star_image = sprintf('<img src="%1$s/%2$s" alt="*" />', $settings['images_url'], $stars[1]);
 							return str_repeat($star_image, $stars[0]);
 						}
-					'),
+					},
 				),
 				'sort' => array(
 					'default' => 'CASE WHEN id_group < 4 THEN id_group ELSE 4 END, stars',
diff --git a/Sources/ManageMembers.php b/Sources/ManageMembers.php
index 6d34cf4..4823b94 100644
--- a/Sources/ManageMembers.php
+++ b/Sources/ManageMembers.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.11
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -198,8 +198,18 @@ function ViewMemberlist()
 		}
 	}
 
-	if ($context['sub_action'] == 'query' && !empty($_REQUEST['params']) && empty($_POST))
-		$_POST += safe_unserialize(base64_decode($_REQUEST['params']));
+	if ($context['sub_action'] == 'query' && empty($_POST))
+	{
+		if (!empty($_REQUEST['params']))
+		{
+			$_POST += safe_unserialize(base64_decode($_REQUEST['params']));
+		}
+		elseif ($context['browser']['is_ie'] && !empty($_SESSION['params']))
+		{
+			$_POST += $_SESSION['params'];
+			unset($_SESSION['params']);
+		}
+	}
 
 	// Check input after a member search has been submitted.
 	if ($context['sub_action'] == 'query')
@@ -424,7 +434,14 @@ function ViewMemberlist()
 		$where = empty($query_parts) ? '1' : implode('
 			AND ', $query_parts);
 
-		$search_params = base64_encode(serialize($_POST));
+		if ($context['browser']['is_ie'])
+		{
+			// Cache the results in the session and avoid IE's 2083 character limit.
+			$_SESSION['params'] = $_POST;
+			$search_params = null;
+		}
+		else
+			$search_params = base64_encode(serialize($_POST));
 	}
 	else
 		$search_params = null;
@@ -547,35 +564,34 @@ function ViewMemberlist()
 					'value' => $txt['viewmembers_online'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
+					'function' => function($rowData) use ($txt)
+					{
 						// Calculate number of days since last online.
-						if (empty($rowData[\'last_login\']))
-							$difference = $txt[\'never\'];
+						if (empty($rowData['last_login']))
+							$difference = $txt['never'];
 						else
 						{
-							$num_days_difference = jeffsdatediff($rowData[\'last_login\']);
+							$num_days_difference = jeffsdatediff($rowData['last_login']);
 
 							// Today.
 							if (empty($num_days_difference))
-								$difference = $txt[\'viewmembers_today\'];
+								$difference = $txt['viewmembers_today'];
 
 							// Yesterday.
 							elseif ($num_days_difference == 1)
-								$difference = sprintf(\'1 %1$s\', $txt[\'viewmembers_day_ago\']);
+								$difference = sprintf('1 %1$s', $txt['viewmembers_day_ago']);
 
 							// X days ago.
 							else
-								$difference = sprintf(\'%1$d %2$s\', $num_days_difference, $txt[\'viewmembers_days_ago\']);
+								$difference = sprintf('%1$d %2$s', $num_days_difference, $txt['viewmembers_days_ago']);
 						}
 
-						// Show it in italics if they\'re not activated...
-						if ($rowData[\'is_activated\'] % 10 != 1)
-							$difference = sprintf(\'<em title="%1$s">%2$s</em>\', $txt[\'not_activated\'], $difference);
+						// Show it in italics if they're not activated...
+						if ($rowData['is_activated'] % 10 != 1)
+							$difference = sprintf('<em title="%1$s">%2$s</em>', $txt['not_activated'], $difference);
 
 						return $difference;
-					'),
+					},
 				),
 				'sort' => array(
 					'default' => 'last_login DESC',
@@ -599,11 +615,10 @@ function ViewMemberlist()
 					'value' => '<input type="checkbox" onclick="invertAll(this, this.form);" class="input_check" />',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $user_info;
-
-						return \'<input type="checkbox" name="delete[]" value="\' . $rowData[\'id_member\'] . \'" class="input_check" \' . ($rowData[\'id_member\'] == $user_info[\'id\'] || $rowData[\'id_group\'] == 1 || in_array(1, explode(\',\', $rowData[\'additional_groups\'])) ? \'disabled="disabled"\' : \'\') . \' />\';
-					'),
+					'function' => function($rowData) use ($user_info)
+					{
+						return '<input type="checkbox" name="delete[]" value="' . $rowData['id_member'] . '" class="input_check" ' . ($rowData['id_member'] == $user_info['id'] || $rowData['id_group'] == 1 || in_array(1, explode(',', $rowData['additional_groups'])) ? 'disabled="disabled"' : '') . ' />';
+					},
 					'class' => 'windowbg',
 					'style' => 'text-align: center',
 				),
@@ -893,11 +908,10 @@ function MembersAwaitingActivation()
 					'value' => $txt['hostname'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $modSettings;
-
-						return host_from_ip($rowData[\'member_ip\']);
-					'),
+					'function' => function($rowData)
+					{
+						return host_from_ip($rowData['member_ip']);
+					},
 					'class' => 'smalltext',
 				),
 			),
@@ -906,9 +920,10 @@ function MembersAwaitingActivation()
 					'value' => $txt['date_registered'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return timeformat($rowData[\'date_registered\']);
-					'),
+					'function' => function($rowData)
+					{
+						return timeformat($rowData['date_registered']);
+					},
 				),
 				'sort' => array(
 					'default' => 'date_registered DESC',
@@ -922,19 +937,18 @@ function MembersAwaitingActivation()
 					'style' => 'width: 20%',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl, $txt;
-
+					'function' => function($rowData) use ($scripturl, $txt)
+					{
 						$member_links = array();
-						foreach ($rowData[\'duplicate_members\'] as $member)
+						foreach ($rowData['duplicate_members'] as $member)
 						{
-							if ($member[\'id\'])
-								$member_links[] = \'<a href="\' . $scripturl . \'?action=profile;u=\' . $member[\'id\'] . \'" \' . (!empty($member[\'is_banned\']) ? \'style="color: red;"\' : \'\') . \'>\' . $member[\'name\'] . \'</a>\';
+							if ($member['id'])
+								$member_links[] = '<a href="' . $scripturl . '?action=profile;u=' . $member['id'] . '" ' . (!empty($member['is_banned']) ? 'style="color: red;"' : '') . '>' . $member['name'] . '</a>';
 							else
-								$member_links[] = $member[\'name\'] . \' (\' . $txt[\'guest\'] . \')\';
+								$member_links[] = $member['name'] . ' (' . $txt['guest'] . ')';
 						}
-						return implode (\', \', $member_links);
-					'),
+						return implode (', ', $member_links);
+					},
 					'class' => 'smalltext',
 				),
 			),
diff --git a/Sources/ManageNews.php b/Sources/ManageNews.php
index 8d0eb8b..04c74f6 100644
--- a/Sources/ManageNews.php
+++ b/Sources/ManageNews.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.10
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -520,13 +520,13 @@ function SendMailing($clean_only = false)
 		}
 	}
 	// Finally - emails!
-	if (!empty($_POST['emails']))
+	if (!empty($_POST['emails']) && empty($modSettings['force_gdpr']))
 	{
 		$addressed = array_unique(explode(';', strtr($_POST['emails'], array("\n" => ';', "\r" => ';', ',' => ';'))));
 		foreach ($addressed as $curmem)
 		{
 			$curmem = trim($curmem);
-			if ($curmem != '' && preg_match('~^[0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $curmem) !== 0)
+			if ($curmem != '' && filter_var($curmem, FILTER_VALIDATE_EMAIL) !== false)
 				$context['recipients']['emails'][$curmem] = $curmem;
 		}
 	}
@@ -541,6 +541,14 @@ function SendMailing($clean_only = false)
 	$context['subject'] = htmlspecialchars($_POST['subject']);
 	$context['message'] = htmlspecialchars($_POST['message']);
 
+	// Include an unsubscribe link if necessary.
+	if (!$context['send_pm'] && !empty($modSettings['notify_tokens']))
+	{
+		require_once($sourcedir . '/Notify.php');
+		$include_unsubscribe = true;
+		$_POST['message'] .= "\n\n" . '{$member.unsubscribe}';
+	}
+
 	// Prepare the message for sending it as HTML
 	if (!$context['send_pm'] && !empty($_POST['send_html']))
 	{
@@ -594,7 +602,8 @@ function SendMailing($clean_only = false)
 		'{$member.email}',
 		'{$member.link}',
 		'{$member.id}',
-		'{$member.name}'
+		'{$member.name}',
+		'{$member.unsubscribe}',
 	);
 
 	// If we still have emails, do them first!
@@ -612,11 +621,15 @@ function SendMailing($clean_only = false)
 		if ($context['send_pm'])
 			continue;
 
+		// Non-members can't subscribe or unsubscribe from anything...
+		$unsubscribe_link = '';
+
 		$to_member = array(
 			$email,
 			!empty($_POST['send_html']) ? '<a href="mailto:' . $email . '">' . $email . '</a>' : $email,
 			'??',
-			$email
+			$email,
+			$unsubscribe_link,
 		);
 
 		sendmail($email, str_replace($from_member, $to_member, $_POST['subject']), str_replace($from_member, $to_member, $_POST['message']), null, null, !empty($_POST['send_html']), 5);
@@ -671,7 +684,7 @@ function SendMailing($clean_only = false)
 		}
 
 		// Force them to have it?
-		if (empty($context['email_force']))
+		if (empty($context['email_force']) || !empty($modSettings['force_gdpr']))
 			$sendQuery .= ' AND mem.notify_announcements = {int:notify_announcements}';
 
 		// Get the smelly people - note we respect the id_member range as it gives us a quicker query.
@@ -714,6 +727,14 @@ function SendMailing($clean_only = false)
 			// We might need this
 			$cleanMemberName = empty($_POST['send_html']) || $context['send_pm'] ? un_htmlspecialchars($row['real_name']) : $row['real_name'];
 
+			if (!empty($include_unsubscribe))
+			{
+				$token = createUnsubscribeToken($row['id_member'], $row['email_address'], 'announcements');
+				$unsubscribe_link = sprintf($txt['unsubscribe_announcements_' . (!empty($_POST['send_html']) ? 'html' : 'plain')], $scripturl . '?action=notifyannouncements;u=' . $row['id_member'] . ';token=' . $token);
+			}
+			else
+				$unsubscribe_link = '';
+
 			// Replace the member-dependant variables
 			$message = str_replace($from_member,
 				array(
@@ -721,6 +742,7 @@ function SendMailing($clean_only = false)
 					!empty($_POST['send_html']) ? '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '">' . $cleanMemberName . '</a>' : ($context['send_pm'] ? '[url=' . $scripturl . '?action=profile;u=' . $row['id_member'] . ']' . $cleanMemberName . '[/url]' : $cleanMemberName),
 					$row['id_member'],
 					$cleanMemberName,
+					$unsubscribe_link,
 				), $_POST['message']);
 
 			$subject = str_replace($from_member,
diff --git a/Sources/ManagePaid.php b/Sources/ManagePaid.php
index 5e4443b..2ed869b 100644
--- a/Sources/ManagePaid.php
+++ b/Sources/ManagePaid.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -237,16 +237,16 @@ function ViewSubscriptions()
 		'items_per_page' => 20,
 		'base_href' => $scripturl . '?action=admin;area=paidsubscribe;sa=view',
 		'get_items' => array(
-			'function' => create_function('', '
-				global $context;
-				return $context[\'subscriptions\'];
-			'),
+			'function' => function() use ($context)
+			{
+				return $context['subscriptions'];
+			},
 		),
 		'get_count' => array(
-			'function' => create_function('', '
-				global $context;
-				return count($context[\'subscriptions\']);
-			'),
+			'function' => function() use ($context)
+			{
+				return count($context['subscriptions']);
+			},
 		),
 		'no_items_label' => $txt['paid_none_yet'],
 		'columns' => array(
@@ -256,11 +256,10 @@ function ViewSubscriptions()
 					'style' => 'text-align: left; width: 35%;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl;
-
-						return sprintf(\'<a href="%1$s?action=admin;area=paidsubscribe;sa=viewsub;sid=%2$s">%3$s</a>\', $scripturl, $rowData[\'id\'], $rowData[\'name\']);
-					'),
+					'function' => function($rowData) use ($scripturl)
+					{
+						return sprintf('<a href="%1$s?action=admin;area=paidsubscribe;sa=viewsub;sid=%2$s">%3$s</a>', $scripturl, $rowData['id'], $rowData['name']);
+					},
 				),
 			),
 			'cost' => array(
@@ -269,11 +268,10 @@ function ViewSubscriptions()
 					'style' => 'text-align: left;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt;
-
-						return $rowData[\'flexible\'] ? \'<em>\' . $txt[\'flexible\'] . \'</em>\' : $rowData[\'cost\'] . \' / \' . $rowData[\'length\'];
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return $rowData['flexible'] ? '<em>' . $txt['flexible'] . '</em>' : $rowData['cost'] . ' / ' . $rowData['length'];
+					},
 				),
 			),
 			'pending' => array(
@@ -309,31 +307,28 @@ function ViewSubscriptions()
 					'value' => $txt['paid_is_active'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt;
-
-						return \'<span style="color: \' . ($rowData[\'active\'] ? \'green\' : \'red\') . \'">\' . ($rowData[\'active\'] ? $txt[\'yes\'] : $txt[\'no\']) . \'</span>\';
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return '<span style="color: ' . ($rowData['active'] ? 'green' : 'red') . '">' . ($rowData['active'] ? $txt['yes'] : $txt['no']) . '</span>';
+					},
 					'style' => 'text-align: center;',
 				),
 			),
 			'modify' => array(
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt, $scripturl;
-
-						return \'<a href="\' . $scripturl . \'?action=admin;area=paidsubscribe;sa=modify;sid=\' . $rowData[\'id\'] . \'">\' . $txt[\'modify\'] . \'</a>\';
-					'),
+					'function' => function($rowData) use ($txt, $scripturl)
+					{
+						return '<a href="' . $scripturl . '?action=admin;area=paidsubscribe;sa=modify;sid=' . $rowData['id'] . '">' . $txt['modify'] . '</a>';
+					},
 					'style' => 'text-align: center;',
 				),
 			),
 			'delete' => array(
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt, $scripturl;
-
-						return \'<a href="\' . $scripturl . \'?action=admin;area=paidsubscribe;sa=modify;delete;sid=\' . $rowData[\'id\'] . \'">\' . $txt[\'delete\'] . \'</a>\';
-					'),
+					'function' => function($rowData) use ($scripturl, $txt)
+					{
+						return '<a href="' . $scripturl . '?action=admin;area=paidsubscribe;sa=modify;delete;sid=' . $rowData['id'] . '">' . $txt['delete'] . '</a>';
+					},
 					'style' => 'text-align: center;',
 				),
 			),
@@ -672,11 +667,10 @@ function ViewSubscribedUsers()
 					'style' => 'text-align: left; width: 20%;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt, $scripturl;
-
-						return $rowData[\'id_member\'] == 0 ? $txt[\'guest\'] : \'<a href="\' . $scripturl . \'?action=profile;u=\' . $rowData[\'id_member\'] . \'">\' . $rowData[\'name\'] . \'</a>\';
-					'),
+					'function' => function($rowData) use ($context, $txt, $scripturl)
+					{
+						return $rowData['id_member'] == 0 ? $txt['guest'] : '<a href="' . $scripturl . '?action=profile;u=' . $rowData['id_member'] . '">' . $rowData['name'] . '</a>';
+					},
 				),
 				'sort' => array(
 					'default' => 'name',
@@ -742,11 +736,10 @@ function ViewSubscribedUsers()
 					'style' => 'width: 10%;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt, $scripturl;
-
-						return \'<a href="\' . $scripturl . \'?action=admin;area=paidsubscribe;sa=modifyuser;lid=\' . $rowData[\'id\'] . \'">\' . $txt[\'modify\'] . \'</a>\';
-					'),
+					'function' => function($rowData) use ($txt, $scripturl)
+					{
+						return '<a href="' . $scripturl . '?action=admin;area=paidsubscribe;sa=modifyuser;lid=' . $rowData['id'] . '">' . $txt['modify'] . '</a>';
+					},
 					'style' => 'text-align: center;',
 				),
 			),
@@ -755,11 +748,10 @@ function ViewSubscribedUsers()
 					'style' => 'width: 4%;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt, $scripturl;
-
-						return \'<input type="checkbox" name="delsub[\' . $rowData[\'id\'] . \']" class="input_check" />\';
-					'),
+					'function' => function($rowData)
+					{
+						return '<input type="checkbox" name="delsub[' . $rowData['id'] . ']" class="input_check" />';
+					},
 					'style' => 'text-align: center;',
 				),
 			),
diff --git a/Sources/ManageRegistration.php b/Sources/ManageRegistration.php
index 764a662..d917d47 100644
--- a/Sources/ManageRegistration.php
+++ b/Sources/ManageRegistration.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -64,6 +64,7 @@ function RegCenter()
 	$subActions = array(
 		'register' => array('AdminRegister', 'moderate_forum'),
 		'agreement' => array('EditAgreement', 'admin_forum'),
+		'policy' => array('EditPrivacyPolicy', 'admin_forum'),
 		'reservednames' => array('SetReserve', 'admin_forum'),
 		'settings' => array('ModifyRegistrationSettings', 'admin_forum'),
 	);
@@ -91,6 +92,9 @@ function RegCenter()
 			'agreement' => array(
 				'description' => $txt['registration_agreement_desc'],
 			),
+			'policy' => array(
+				'description' => $txt['privacy_policy_desc'],
+			),
 			'reservednames' => array(
 				'description' => $txt['admin_reserved_desc'],
 			),
@@ -107,7 +111,7 @@ function RegCenter()
 // This function allows the admin to register a new member by hand.
 function AdminRegister()
 {
-	global $txt, $context, $sourcedir, $scripturl, $smcFunc;
+	global $txt, $context, $sourcedir, $scripturl, $smcFunc, $modSettings;
 
 	if (!empty($_POST['regSubmit']))
 	{
@@ -131,6 +135,12 @@ function AdminRegister()
 			'memberGroup' => empty($_POST['group']) || !allowedTo('manage_membergroups') ? 0 : (int) $_POST['group'],
 		);
 
+		if (empty($_POST['requireAgreement']) && empty($modSettings['force_gdpr']))
+			$regOptions['theme_vars']['agreement_accepted'] = time();
+
+		if (empty($_POST['requirePolicyAgreement']) && empty($modSettings['force_gdpr']))
+			$regOptions['theme_vars']['policy_accepted'] = time();
+
 		require_once($sourcedir . '/Subs-Members.php');
 		$memberID = registerMember($regOptions);
 		if (!empty($memberID))
@@ -182,7 +192,9 @@ function AdminRegister()
 // I hereby agree not to be a lazy bum.
 function EditAgreement()
 {
-	global $txt, $boarddir, $context, $modSettings, $smcFunc, $settings;
+	global $txt, $boarddir, $context, $modSettings, $smcFunc, $user_info;
+
+	$context['force_gdpr'] = !empty($modSettings['force_gdpr']);
 
 	// By default we look at agreement.txt.
 	$context['current_agreement'] = '';
@@ -207,7 +219,11 @@ function EditAgreement()
 		}
 	}
 
-	if (isset($_POST['agreement']))
+	$agreement_lang = empty($context['current_agreement']) ? 'default' : substr($context['current_agreement'], 1);
+
+	$context['agreement'] = file_exists($boarddir . '/agreement' . $context['current_agreement'] . '.txt') ? str_replace("\r", '', file_get_contents($boarddir . '/agreement' . $context['current_agreement'] . '.txt')) : '';
+
+	if (isset($_POST['agreement']) && str_replace("\r", '', $_POST['agreement']) != $context['agreement'])
 	{
 		checkSession();
 
@@ -216,12 +232,30 @@ function EditAgreement()
 		fwrite($fp, str_replace("\r", '', $_POST['agreement']));
 		fclose($fp);
 
-		updateSettings(array('requireAgreement' => !empty($_POST['requireAgreement'])));
+		if (!isset($_POST['minor_edit']) || !empty($modSettings['force_gdpr']))
+		{
+			$agreement_settings['agreement_updated_' . $agreement_lang] = time();
+
+			// Writing it counts as agreeing to it, right?
+			$smcFunc['db_insert']('replace',
+				'{db_prefix}themes',
+				array('id_member' => 'int', 'id_theme' => 'int', 'variable' => 'string', 'value' => 'string'),
+				array($user_info['id'], 1, 'agreement_accepted', time()),
+				array('id_member', 'id_theme', 'variable')
+			);
+			logAction('agreement_updated', array('language' => $context['editable_agreements'][$context['current_agreement']]), 'admin');
+			logAction('agreement_accepted', array('applicator' => $user_info['id']), 'user');
+
+			updateSettings($agreement_settings);
+		}
+
+		$context['agreement'] = str_replace("\r", '', $_POST['agreement']);
 	}
 
-	$context['agreement'] = file_exists($boarddir . '/agreement' . $context['current_agreement'] . '.txt') ? htmlspecialchars(file_get_contents($boarddir . '/agreement' . $context['current_agreement'] . '.txt')) : '';
+	$context['agreement_info'] = sprintf($txt['admin_agreement_info'], empty($modSettings['agreement_updated_' . $agreement_lang]) ? $txt['never'] : timeformat($modSettings['agreement_updated_' . $agreement_lang]));
+
+	$context['agreement'] = $smcFunc['htmlspecialchars']($context['agreement']);
 	$context['warning'] = is_writable($boarddir . '/agreement' . $context['current_agreement'] . '.txt') ? '' : $txt['agreement_not_writable'];
-	$context['require_agreement'] = !empty($modSettings['requireAgreement']);
 
 	$context['sub_template'] = 'edit_agreement';
 	$context['page_title'] = $txt['registration_agreement'];
@@ -265,15 +299,25 @@ function SetReserve()
 function ModifyRegistrationSettings($return_config = false)
 {
 	global $txt, $context, $scripturl, $modSettings, $sourcedir;
+	global $language, $boarddir;
 
 	// This is really quite wanting.
 	require_once($sourcedir . '/ManageServer.php');
 
+	// Do we have at least default versions of the agreement and privacy policy?
+	$agreement = file_exists($boarddir . '/agreement.' . $language . '.txt') || file_exists($boarddir . '/agreement.txt');
+	$policy = !empty($modSettings['policy_' . $language]);
+
 	$config_vars = array(
 			array('select', 'registration_method', array($txt['setting_registration_standard'], $txt['setting_registration_activate'], $txt['setting_registration_approval'], $txt['setting_registration_disabled'])),
 			array('check', 'enableOpenID'),
 			array('check', 'notify_new_registration'),
 			array('check', 'send_welcomeEmail'),
+		'',
+			array('check', 'requireAgreement', 'text_label' => $txt['admin_agreement'], 'value' => !empty($modSettings['force_gdpr']) ? 1 : $modSettings['requireAgreement'], 'disabled' => !empty($modSettings['force_gdpr'])),
+			array('warning', empty($agreement) ? 'error_no_agreement' : ''),
+			array('check', 'requirePolicyAgreement', 'text_label' => $txt['admin_privacy_policy'], 'value' => !empty($modSettings['force_gdpr']) ? 1 : $modSettings['requirePolicyAgreement'], 'disabled' => !empty($modSettings['force_gdpr'])),
+			array('warning', empty($policy) ? 'error_no_privacy_policy' : ''),
 		'',
 			array('int', 'coppaAge', 'subtext' => $txt['setting_coppaAge_desc'], 'onchange' => 'checkCoppa();'),
 			array('select', 'coppaType', array($txt['setting_coppaType_reject'], $txt['setting_coppaType_approval']), 'onchange' => 'checkCoppa();'),
@@ -284,6 +328,8 @@ function ModifyRegistrationSettings($return_config = false)
 			array('check', 'sfs_enabled', 'subtext' => $txt['setting_sfs_enabled_desc']),
 			array('check', 'sfs_ipcheck', 'subtext' => $txt['setting_sfs_ipcheck_desc']),
 			array('check', 'sfs_usernamecheck', 'subtext' => $txt['setting_sfs_usernamecheck_desc']),
+		'',
+			array('check', 'announcements_default', 'disabled' => empty($modSettings['allow_disableAnnounce']) || !empty($modSettings['force_gdpr']), 'value' => !empty($modSettings['force_gdpr']) ? 0 : (empty($modSettings['allow_disableAnnounce']) ? 1 : !empty($modSettings['announcements_default']))),
 	);
 
 	if ($return_config)
@@ -304,6 +350,16 @@ function ModifyRegistrationSettings($return_config = false)
 		// Post needs to take into account line breaks.
 		$_POST['coppaPost'] = str_replace("\n", '<br />', empty($_POST['coppaPost']) ? '' : $_POST['coppaPost']);
 
+		// GDPR requires these settings to have certain values
+		if (!empty($modSettings['force_gdpr']))
+		{
+			$_POST['requireAgreement'] = 1;
+			$_POST['requirePolicyAgreement'] = 1;
+			$_POST['announcements_default'] = 0;
+		}
+		elseif (empty($modSettings['allow_disableAnnounce']))
+			$_POST['announcements_default'] = 1;
+
 		saveDBSettings($config_vars);
 
 		redirectexit('action=admin;area=regcenter;sa=settings');
@@ -332,4 +388,65 @@ function ModifyRegistrationSettings($return_config = false)
 	prepareDBSettingContext($config_vars);
 }
 
-?>
\ No newline at end of file
+// Sure, you can sell my personal info for profit (...or not)
+function EditPrivacyPolicy()
+{
+	global $txt, $boarddir, $context, $modSettings, $smcFunc, $user_info;
+
+	$context['force_gdpr'] = !empty($modSettings['force_gdpr']);
+
+	// By default, edit the current language's policy
+	$context['current_policy_lang'] = $user_info['language'];
+
+	// We need a policy for every language
+	getLanguages();
+
+	foreach ($context['languages'] as $lang)
+	{
+		$context['editable_policies'][$lang['filename']] = $lang['name'];
+
+		// Are we editing this one?
+		if (isset($_POST['policy_lang']) && $_POST['policy_lang'] == $lang['filename'])
+			$context['current_policy_lang'] = $lang['filename'];
+	}
+
+	$context['policy'] = empty($modSettings['policy_' . $context['current_policy_lang']]) ? '' : $modSettings['policy_' . $context['current_policy_lang']];
+
+	if (isset($_POST['policy']))
+	{
+		checkSession();
+
+		// Make sure there are no creepy-crawlies in it
+		$policy_text = $smcFunc['htmlspecialchars'](str_replace("\r", '', $_POST['policy']));
+
+		$policy_settings = array(
+			'policy_' . $context['current_policy_lang'] => $policy_text,
+		);
+
+		if ($policy_text != $context['policy'] && (!isset($_POST['minor_edit']) || !empty($modSettings['force_gdpr'])))
+		{
+			$policy_settings['policy_updated_' . $context['current_policy_lang']] = time();
+
+			// Writing it counts as agreeing to it, right?
+			$smcFunc['db_insert']('replace',
+				'{db_prefix}themes',
+				array('id_member' => 'int', 'id_theme' => 'int', 'variable' => 'string', 'value' => 'string'),
+				array($user_info['id'], 1, 'policy_accepted', time()),
+				array('id_member', 'id_theme', 'variable')
+			);
+			logAction('policy_updated', array('language' => $context['editable_policies'][$context['current_policy_lang']]), 'admin');
+			logAction('policy_accepted', array('applicator' => $user_info['id']), 'user');
+		}
+
+		updateSettings($policy_settings);
+
+		$context['policy'] = $policy_text;
+	}
+
+	$context['policy_info'] = sprintf($txt['admin_agreement_info'], empty($modSettings['policy_updated_' . $context['current_policy_lang']]) ? $txt['never'] : timeformat($modSettings['policy_updated_' . $context['current_policy_lang']]));
+
+	$context['sub_template'] = 'edit_privacy_policy';
+	$context['page_title'] = $txt['privacy_policy'];
+}
+
+?>
diff --git a/Sources/ManageScheduledTasks.php b/Sources/ManageScheduledTasks.php
index f80e192..2e336d9 100644
--- a/Sources/ManageScheduledTasks.php
+++ b/Sources/ManageScheduledTasks.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -457,9 +457,10 @@ function TaskLog()
 					'value' => $txt['scheduled_log_time_run'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return timeformat($rowData[\'time_run\'], true);
-					'),
+					'function' => function($rowData)
+					{
+						return timeformat($rowData['time_run'], true);
+					},
 				),
 				'sort' => array(
 					'default' => 'lst.id_log DESC',
diff --git a/Sources/ManageSearch.php b/Sources/ManageSearch.php
index 9bf176c..00c8468 100644
--- a/Sources/ManageSearch.php
+++ b/Sources/ManageSearch.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -219,7 +219,7 @@ function EditSearchMethod()
 			array(
 			)
 		);
-		$context['fulltext_index'] = '';
+		$context['fulltext_index'] = array();
 		if ($request !== false || $smcFunc['db_num_rows']($request) != 0)
 		{
 			while ($row = $smcFunc['db_fetch_assoc']($request))
diff --git a/Sources/ManageSearchEngines.php b/Sources/ManageSearchEngines.php
index 1015d1e..70b841b 100644
--- a/Sources/ManageSearchEngines.php
+++ b/Sources/ManageSearchEngines.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -216,11 +216,10 @@ function ViewSpiders()
 					'value' => $txt['spider_name'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl;
-
-						return sprintf(\'<a href="%1$s?action=admin;area=sengines;sa=editspiders;sid=%2$d">%3$s</a>\', $scripturl, $rowData[\'id_spider\'], htmlspecialchars($rowData[\'spider_name\']));
-					'),
+					'function' => function($rowData) use ($scripturl)
+					{
+						return sprintf('<a href="%1$s?action=admin;area=sengines;sa=editspiders;sid=%2$d">%3$s</a>', $scripturl, $rowData['id_spider'], htmlspecialchars($rowData['spider_name']));
+					},
 				),
 				'sort' => array(
 					'default' => 'spider_name',
@@ -232,11 +231,10 @@ function ViewSpiders()
 					'value' => $txt['spider_last_seen'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt;
-
-						return isset($context[\'spider_last_seen\'][$rowData[\'id_spider\']]) ? timeformat($context[\'spider_last_seen\'][$rowData[\'id_spider\']]) : $txt[\'spider_last_never\'];
-					'),
+					'function' => function($rowData) use ($context, $txt)
+					{
+						return isset($context['spider_last_seen'][$rowData['id_spider']]) ? timeformat($context['spider_last_seen'][$rowData['id_spider']]) : $txt['spider_last_never'];
+					},
 				),
 			),
 			'user_agent' => array(
@@ -686,9 +684,10 @@ function SpiderLogs()
 					'value' => $txt['spider_time'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return timeformat($rowData[\'log_time\']);
-					'),
+					'function' => function($rowData)
+					{
+						return timeformat($rowData['log_time']);
+					},
 				),
 				'sort' => array(
 					'default' => 'sl.id_hit DESC',
diff --git a/Sources/ManageServer.php b/Sources/ManageServer.php
index 6aa0be6..e9246cb 100644
--- a/Sources/ManageServer.php
+++ b/Sources/ManageServer.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -206,6 +206,8 @@ function ModifyGeneralSettings($return_config = false)
 {
 	global $scripturl, $context, $txt;
 
+	loadLanguage('Install');
+
 	/* If you're writing a mod, it's a bad idea to add things here....
 	For each option:
 		variable name, description, type (constant), size/possible values, helptext.
@@ -223,6 +225,12 @@ function ModifyGeneralSettings($return_config = false)
 		array('enableCompressedOutput', $txt['enableCompressedOutput'], 'db', 'check', null, 'enableCompressedOutput'),
 		array('disableTemplateEval', $txt['disableTemplateEval'], 'db', 'check', null, 'disableTemplateEval'),
 		array('disableHostnameLookup', $txt['disableHostnameLookup'], 'db', 'check', null, 'disableHostnameLookup'),
+		'',
+		array('image_proxy_enabled', $txt['image_proxy_enabled'], 'file', 'check', null, 'image_proxy_enabled', 'subtext' => $txt['image_proxy_enabled_desc']),
+		array('image_proxy_secret', $txt['image_proxy_secret'], 'file', 'text', 30, 'image_proxy_secret', 'subtext' => $txt['image_proxy_secret_desc']),
+		array('image_proxy_maxsize', $txt['image_proxy_maxsize'], 'file', 'int', null, 'image_proxy_maxsize', 'postinput' => $txt['image_proxy_maxsize_postinput'], 'subtext' => $txt['image_proxy_maxsize_desc']),
+		'',
+		array('enable_sm_stats', $txt['install_settings_stats'], 'db', 'check', null),
 	);
 
 	if ($return_config)
@@ -235,6 +243,16 @@ function ModifyGeneralSettings($return_config = false)
 	// Saving settings?
 	if (isset($_REQUEST['save']))
 	{
+		// Are we saving the stat collection?
+		if (!empty($_POST['enable_sm_stats']) && empty($modSettings['sm_stats_key']))
+		{
+			$registerSMStats = registerSMStats();
+
+			// Failed to register, disable it again.
+			if (empty($registerSMStats))
+				$_POST['enable_sm_stats'] = 0;
+		}
+
 		saveSettings($config_vars);
 		redirectexit('action=admin;area=serversettings;sa=general;' . $context['session_var'] . '=' . $context['session_id']);
 	}
@@ -295,7 +313,7 @@ function ModifyDatabaseSettings($return_config = false)
 // This function basically edits anything which is configuration and stored in the database, except for caching.
 function ModifyCookieSettings($return_config = false)
 {
-	global $context, $scripturl, $txt, $sourcedir, $modSettings, $cookiename, $user_settings;
+	global $context, $scripturl, $txt, $sourcedir, $modSettings, $cookiename, $cookie_no_auth_secret, $user_settings;
 
 	// Define the variables we want to edit.
 	$config_vars = array(
@@ -305,6 +323,7 @@ function ModifyCookieSettings($return_config = false)
 		array('localCookies', $txt['localCookies'], 'db', 'check', false, 'localCookies'),
 		array('globalCookies', $txt['globalCookies'], 'db', 'check', false, 'globalCookies'),
 		array('secureCookies', $txt['secureCookies'], 'db', 'check', false, 'secureCookies',  'disabled' => !isset($_SERVER['HTTPS']) || !(strtolower($_SERVER['HTTPS']) == 'on' || strtolower($_SERVER['HTTPS']) == '1')),
+		array('cookie_no_auth_secret', $txt['cookie_no_auth_secret'], 'db', 'check', false, 'cookie_no_auth_secret'),
 		'',
 		// Sessions
 		array('databaseSession_enable', $txt['databaseSession_enable'], 'db', 'check', false, 'databaseSession_enable'),
@@ -524,7 +543,7 @@ function AddLanguage()
 		$context['smf_search_term'] = htmlspecialchars(trim($_POST['smf_add']));
 
 		// We're going to use this URL.
-		$url = 'http://download.simplemachines.org/fetch_language.php?version=' . urlencode(strtr($forum_version, array('SMF ' => '')));
+		$url = 'https://download.simplemachines.org/fetch_language.php?version=' . urlencode(strtr($forum_version, array('SMF ' => '')));
 
 		// Load the class file and stick it into an array.
 		loadClassFile('Class-Package.php');
@@ -606,7 +625,7 @@ function DownloadLanguage()
 		// Otherwise, go go go!
 		elseif (!empty($install_files))
 		{
-			$archive_content = read_tgz_file('http://download.simplemachines.org/fetch_language.php?version=' . urlencode(strtr($forum_version, array('SMF ' => ''))) . ';fetch=' . urlencode($_GET['did']), $boarddir, false, true, $install_files);
+			$archive_content = read_tgz_file('https://download.simplemachines.org/fetch_language.php?version=' . urlencode(strtr($forum_version, array('SMF ' => ''))) . ';fetch=' . urlencode($_GET['did']), $boarddir, false, true, $install_files);
 			// Make sure the files aren't stuck in the cache.
 			package_flush_cache();
 			$context['install_complete'] = sprintf($txt['languages_download_complete_desc'], $scripturl . '?action=admin;area=languages');
@@ -617,7 +636,7 @@ function DownloadLanguage()
 
 	// Open up the old china.
 	if (!isset($archive_content))
-		$archive_content = read_tgz_file('http://download.simplemachines.org/fetch_language.php?version=' . urlencode(strtr($forum_version, array('SMF ' => ''))) . ';fetch=' . urlencode($_GET['did']), null);
+		$archive_content = read_tgz_file('https://download.simplemachines.org/fetch_language.php?version=' . urlencode(strtr($forum_version, array('SMF ' => ''))) . ';fetch=' . urlencode($_GET['did']), null);
 
 	if (empty($archive_content))
 		fatal_error($txt['add_language_error_no_response']);
@@ -841,10 +860,10 @@ function DownloadLanguage()
 		'id' => 'lang_main_files_list',
 		'title' => $txt['languages_download_main_files'],
 		'get_items' => array(
-			'function' => create_function('', '
-				global $context;
-				return $context[\'files\'][\'lang\'];
-			'),
+			'function' => function() use ($context)
+			{
+				return $context['files']['lang'];
+			},
 		),
 		'columns' => array(
 			'name' => array(
@@ -852,11 +871,10 @@ function DownloadLanguage()
 					'value' => $txt['languages_download_filename'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt;
-
-						return \'<strong>\' . $rowData[\'name\'] . \'</strong><br /><span class="smalltext">\' . $txt[\'languages_download_dest\'] . \': \' . $rowData[\'destination\'] . \'</span>\' . ($rowData[\'version_compare\'] == \'older\' ? \'<br />\' . $txt[\'languages_download_older\'] : \'\');
-					'),
+					'function' => function($rowData) use ($context, $txt)
+					{
+						return '<strong>' . $rowData['name'] . '</strong><br /><span class="smalltext">' . $txt['languages_download_dest'] . ': ' . $rowData['destination'] . '</span>' . ($rowData['version_compare'] == 'older' ? '<br />' . $txt['languages_download_older'] : '');
+					},
 				),
 			),
 			'writable' => array(
@@ -864,11 +882,10 @@ function DownloadLanguage()
 					'value' => $txt['languages_download_writable'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
-						return \'<span style="color: \' . ($rowData[\'writable\'] ? \'green\' : \'red\') . \';">\' . ($rowData[\'writable\'] ? $txt[\'yes\'] : $txt[\'no\']) . \'</span>\';
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return '<span style="color: ' . ($rowData['writable'] ? 'green' : 'red') . ';">' . ($rowData['writable'] ? $txt['yes'] : $txt['no']) . '</span>';
+					},
 					'style' => 'text-align: center',
 				),
 			),
@@ -877,11 +894,10 @@ function DownloadLanguage()
 					'value' => $txt['languages_download_version'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
-						return \'<span style="color: \' . ($rowData[\'version_compare\'] == \'older\' ? \'red\' : ($rowData[\'version_compare\'] == \'same\' ? \'orange\' : \'green\')) . \';">\' . $rowData[\'version\'] . \'</span>\';
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return '<span style="color: ' . ($rowData['version_compare'] == 'older' ? 'red' : ($rowData['version_compare'] == 'same' ? 'orange' : 'green')) . ';">' . $rowData['version'] . '</span>';
+					},
 				),
 			),
 			'exists' => array(
@@ -889,11 +905,10 @@ function DownloadLanguage()
 					'value' => $txt['languages_download_exists'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
-						return $rowData[\'exists\'] ? ($rowData[\'exists\'] == \'same\' ? $txt[\'languages_download_exists_same\'] : $txt[\'languages_download_exists_different\']) : $txt[\'no\'];
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return $rowData['exists'] ? ($rowData['exists'] == 'same' ? $txt['languages_download_exists_same'] : $txt['languages_download_exists_different']) : $txt['no'];
+					},
 				),
 			),
 			'copy' => array(
@@ -901,9 +916,10 @@ function DownloadLanguage()
 					'value' => $txt['languages_download_copy'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return \'<input type="checkbox" name="copy_file[]" value="\' . $rowData[\'generaldest\'] . \'" \' . ($rowData[\'default_copy\'] ? \'checked="checked"\' : \'\') . \' class="input_check" />\';
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return '<input type="checkbox" name="copy_file[]" value="' . $rowData['generaldest'] . '" ' . ($rowData['default_copy'] ? 'checked="checked"' : '') . ' class="input_check" />';
+					},
 					'style' => 'text-align: center; width: 4%;',
 				),
 			),
@@ -970,9 +986,10 @@ function ModifyLanguages()
 					'value' => $txt['languages_default'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return \'<input type="radio" name="def_language" value="\' . $rowData[\'id\'] . \'" \' . ($rowData[\'default\'] ? \'checked="checked"\' : \'\') . \' onclick="highlightSelected(\\\'list_language_list_\' . $rowData[\'id\'] . \'\\\');" class="input_radio" />\';
-					'),
+					'function' => function($rowData)
+					{
+						return '<input type="radio" name="def_language" value="' . $rowData['id'] . '" ' . ($rowData['default'] ? 'checked="checked"' : '') . ' onclick="highlightSelected(\'list_language_list_' . $rowData['id'] . '\');" class="input_radio" />';
+					},
 					'style' => 'text-align: center; width: 8%;',
 				),
 			),
@@ -981,11 +998,10 @@ function ModifyLanguages()
 					'value' => $txt['languages_lang_name'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl, $context;
-
-						return sprintf(\'<a href="%1$s?action=admin;area=languages;sa=editlang;lid=%2$s">%3$s</a>\', $scripturl, $rowData[\'id\'], $rowData[\'name\']);
-					'),
+					'function' => function($rowData) use ($scripturl, $context)
+					{
+						return sprintf('<a href="%1$s?action=admin;area=languages;sa=editlang;lid=%2$s">%3$s</a>', $scripturl, $rowData['id'], $rowData['name']);
+					},
 				),
 			),
 			'character_set' => array(
@@ -1581,7 +1597,7 @@ function cleanLangString($string, $to_display = true)
 		for ($i = 0; $i < strlen($string); $i++)
 		{
 			// Handle ecapes first.
-			if ($string{$i} == '\\')
+			if ($string[$i] == '\\')
 			{
 				// Toggle the escape.
 				$is_escape = !$is_escape;
@@ -1590,15 +1606,15 @@ function cleanLangString($string, $to_display = true)
 					continue;
 			}
 			// Special case - parsed string with line break etc?
-			elseif (($string{$i} == 'n' || $string{$i} == 't') && $in_string == 2 && $is_escape)
+			elseif (($string[$i] == 'n' || $string[$i] == 't') && $in_string == 2 && $is_escape)
 			{
 				// Put the escape back...
-				$new_string .= $string{$i} == 'n' ? "\n" : "\t";
+				$new_string .= $string[$i] == 'n' ? "\n" : "\t";
 				$is_escape = false;
 				continue;
 			}
 			// Have we got a single quote?
-			elseif ($string{$i} == '\'')
+			elseif ($string[$i] == '\'')
 			{
 				// Already in a parsed string, or escaped in a linear string, means we print it - otherwise something special.
 				if ($in_string != 2 && ($in_string != 1 || !$is_escape))
@@ -1615,7 +1631,7 @@ function cleanLangString($string, $to_display = true)
 				}
 			}
 			// Otherwise a double quote?
-			elseif ($string{$i} == '"')
+			elseif ($string[$i] == '"')
 			{
 				// Already in a single quote string, or escaped in a parsed string, means we print it - otherwise something special.
 				if ($in_string != 1 && ($in_string != 2 || !$is_escape))
@@ -1632,10 +1648,10 @@ function cleanLangString($string, $to_display = true)
 				}
 			}
 			// A join/space outside of a string is simply removed.
-			elseif ($in_string == 0 && (empty($string{$i}) || $string{$i} == '.'))
+			elseif ($in_string == 0 && (empty($string[$i]) || $string[$i] == '.'))
 				continue;
 			// Start of a variable?
-			elseif ($in_string == 0 && $string{$i} == '$')
+			elseif ($in_string == 0 && $string[$i] == '$')
 			{
 				// Find the whole of it!
 				preg_match('~([\$A-Za-z0-9\'\[\]_-]+)~', substr($string, $i), $matches);
@@ -1658,7 +1674,7 @@ function cleanLangString($string, $to_display = true)
 			}
 
 			// Actually add the character to the string!
-			$new_string .= $string{$i};
+			$new_string .= $string[$i];
 			// If anything was escaped it ain't any longer!
 			$is_escape = false;
 		}
@@ -1675,20 +1691,20 @@ function cleanLangString($string, $to_display = true)
 		for ($i = 0; $i < strlen($string); $i++)
 		{
 			// Handle line breaks!
-			if ($string{$i} == "\n" || $string{$i} == "\t")
+			if ($string[$i] == "\n" || $string[$i] == "\t")
 			{
 				// Are we in a string? Is it the right type?
 				if ($in_string == 1)
 				{
 					// Change type!
-					$new_string .= '\' . "\\' . ($string{$i} == "\n" ? 'n' : 't');
+					$new_string .= '\' . "\\' . ($string[$i] == "\n" ? 'n' : 't');
 					$in_string = 2;
 				}
 				elseif ($in_string == 2)
-					$new_string .= '\\' . ($string{$i} == "\n" ? 'n' : 't');
+					$new_string .= '\\' . ($string[$i] == "\n" ? 'n' : 't');
 				// Otherwise start one off - joining if required.
 				else
-					$new_string .= ($new_string ? ' . ' : '') . '"\\' . ($string{$i} == "\n" ? 'n' : 't');
+					$new_string .= ($new_string ? ' . ' : '') . '"\\' . ($string[$i] == "\n" ? 'n' : 't');
 
 				continue;
 			}
@@ -1707,7 +1723,7 @@ function cleanLangString($string, $to_display = true)
 			}
 
 			// Is this a variable?
-			if ($string{$i} == '{' && $string{$i + 1} == '%' && $string{$i + 2} == '$')
+			if ($string[$i] == '{' && $string[$i + 1] == '%' && $string[$i + 2] == '$')
 			{
 				// Grab the variable.
 				preg_match('~\{%([\$A-Za-z0-9\'\[\]_-]+)%\}~', substr($string, $i), $matches);
@@ -1726,10 +1742,10 @@ function cleanLangString($string, $to_display = true)
 				continue;
 			}
 			// Is this a lt sign?
-			elseif ($string{$i} == '<')
+			elseif ($string[$i] == '<')
 			{
 				// Probably HTML?
-				if ($string{$i + 1} != ' ')
+				if ($string[$i + 1] != ' ')
 					$in_html = true;
 				// Assume we need an entity...
 				else
@@ -1739,7 +1755,7 @@ function cleanLangString($string, $to_display = true)
 				}
 			}
 			// What about gt?
-			elseif ($string{$i} == '>')
+			elseif ($string[$i] == '>')
 			{
 				// Will it be HTML?
 				if ($in_html)
@@ -1752,10 +1768,10 @@ function cleanLangString($string, $to_display = true)
 				}
 			}
 			// Is it a slash? If so escape it...
-			if ($string{$i} == '\\')
+			if ($string[$i] == '\\')
 				$new_string .= '\\';
 			// The infamous double quote?
-			elseif ($string{$i} == '"')
+			elseif ($string[$i] == '"')
 			{
 				// If we're in HTML we leave it as a quote - otherwise we entity it.
 				if (!$in_html)
@@ -1765,14 +1781,14 @@ function cleanLangString($string, $to_display = true)
 				}
 			}
 			// A single quote?
-			elseif ($string{$i} == '\'')
+			elseif ($string[$i] == '\'')
 			{
 				// Must be in a string so escape it.
 				$new_string .= '\\';
 			}
 
 			// Finally add the character to the string!
-			$new_string .= $string{$i};
+			$new_string .= $string[$i];
 		}
 
 		// If we ended as a string then close it off.
@@ -1812,7 +1828,9 @@ function prepareServerSettingsContext(&$config_vars)
 				'invalid' => false,
 				'javascript' => '',
 				'preinput' => '',
-				'postinput' => '',
+				'postinput' => isset($config_var['postinput']) ? $config_var['postinput'] : '',
+				'subtext' => isset($config_var['subtext']) ? $config_var['subtext'] : '',
+				'needs_default' => !empty($config_var['needs_default']) || in_array($config_var[0], array('db_persist', 'db_error_send', 'maintenance', 'image_proxy_enabled')) ? true : false,
 			);
 		}
 	}
@@ -2005,14 +2023,18 @@ function saveSettings(&$config_vars)
 		'webmaster_email',
 		'db_name', 'db_user', 'db_server', 'db_prefix', 'ssi_db_user',
 		'boarddir', 'sourcedir', 'cachedir',
+		'image_proxy_secret',
 	);
 	// All the numeric variables.
 	$config_ints = array(
+		'cache_enable',
+		'image_proxy_maxsize',
 	);
 	// All the checkboxes.
 	$config_bools = array(
 		'db_persist', 'db_error_send',
-		'maintenance',
+		'maintenance', 'image_proxy_enabled',
+		'cookie_no_auth_secret',
 	);
 
 	// Now sort everything into a big array, and figure out arrays and etc.
@@ -2036,7 +2058,7 @@ function saveSettings(&$config_vars)
 	{
 		if (!empty($_POST[$key]))
 			$new_settings[$key] = '1';
-		else
+		elseif (isset($_POST[$key]))
 			$new_settings[$key] = '0';
 	}
 
@@ -2134,4 +2156,54 @@ function saveDBSettings(&$config_vars)
 	}
 }
 
+
+/**
+ * Registers the site with the Simple Machines Stat collection. This function
+ * purposely does not use updateSettings.php as it will be called shortly after
+ * this process completes by the saveSettings() function.
+ *
+ * @see Stats.php SMStats() for more information.
+ * @link https://www.simplemachines.org/about/stats.php for more info.
+ *
+ */
+function registerSMStats()
+{
+	global $modSettings, $boardurl, $smcFunc;
+
+	// Already have a key?  Can't register again.
+	if (!empty($modSettings['sm_stats_key']))
+		return true;
+
+	$fp = @fsockopen('www.simplemachines.org', 80, $errno, $errstr);
+	if ($fp)
+	{
+		$out = 'GET /smf/stats/register_stats.php?site=' . base64_encode($boardurl) . ' HTTP/1.1' . "\r\n";
+		$out .= 'Host: www.simplemachines.org' . "\r\n";
+		$out .= 'Connection: Close' . "\r\n\r\n";
+		fwrite($fp, $out);
+
+		$return_data = '';
+		while (!feof($fp))
+			$return_data .= fgets($fp, 128);
+
+		fclose($fp);
+
+		// Get the unique site ID.
+		preg_match('~SITE-ID:\s(\w{10})~', $return_data, $ID);
+
+		if (!empty($ID[1]))
+		{
+			$smcFunc['db_insert']('replace',
+				'{db_prefix}settings',
+				array('variable' => 'string', 'value' => 'string'),
+				array('sm_stats_key', $ID[1]),
+				array('variable')
+			);
+			return true;
+		}
+	}
+
+	return false;
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/ManageSettings.php b/Sources/ManageSettings.php
index 6d75dbd..1bd8df3 100644
--- a/Sources/ManageSettings.php
+++ b/Sources/ManageSettings.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.6
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -83,9 +83,11 @@ function loadGeneralSettingParameters($subActions = array(), $defaultAction = ''
 
 	$context['sub_template'] = 'show_settings';
 
-	// By default do the basic settings.
-	$_REQUEST['sa'] = isset($_REQUEST['sa']) && isset($subActions[$_REQUEST['sa']]) ? $_REQUEST['sa'] : (!empty($defaultAction) ? $defaultAction : array_pop(array_keys($subActions)));
-	$context['sub_action'] = $_REQUEST['sa'];
+	// If no fallback was specified, use the first subaction.
+	$defaultAction = !empty($defaultAction) ? $defaultAction : key($subActions);
+
+	// I want...
+	$_REQUEST['sa'] = isset($_REQUEST['sa'], $subActions[$_REQUEST['sa']]) ? $_REQUEST['sa'] : $defaultAction;
 }
 
 // This function passes control through to the relevant tab.
@@ -202,6 +204,7 @@ function ModifyModSettings()
 function ModifyCoreFeatures($return_config = false)
 {
 	global $txt, $scripturl, $context, $settings, $sc, $modSettings;
+	global $language;
 
 	/* This is an array of all the features that can be enabled/disabled - each option can have the following:
 		title		- Text title of this item (If standard string does not exist).
@@ -222,25 +225,27 @@ function ModifyCoreFeatures($return_config = false)
 		// cp = custom profile fields.
 		'cp' => array(
 			'url' => 'action=admin;area=featuresettings;sa=profile',
-			'save_callback' => create_function('$value', '
+			'save_callback' => function($value)
+			{
 				global $smcFunc;
 				if (!$value)
 				{
-					$smcFunc[\'db_query\'](\'\', \'
+					$smcFunc['db_query']('', '
 						UPDATE {db_prefix}custom_fields
-						SET active = 0\');
+						SET active = 0');
 				}
-			'),
-			'setting_callback' => create_function('$value', '
+			},
+			'setting_callback' => function($value)
+			{
 				if (!$value)
 					return array(
-						\'disabled_profile_fields\' => \'\',
-						\'registration_fields\' => \'\',
-						\'displayFields\' => \'\',
+						'disabled_profile_fields' => '',
+						'registration_fields' => '',
+						'displayFields' => '',
 					);
 				else
 					return array();
-			'),
+			},
 		),
 		// k = karma.
 		'k' => array(
@@ -259,20 +264,21 @@ function ModifyCoreFeatures($return_config = false)
 		// pm = post moderation.
 		'pm' => array(
 			'url' => 'action=admin;area=permissions;sa=postmod',
-			'setting_callback' => create_function('$value', '
+			'setting_callback' => function($value)
+			{
 				global $sourcedir;
 
 				// Cant use warning post moderation if disabled!
 				if (!$value)
 				{
-					require_once($sourcedir . \'/PostModeration.php\');
+					require_once($sourcedir . '/PostModeration.php');
 					approveAllData();
 
-					return array(\'warning_moderate\' => 0);
+					return array('warning_moderate' => 0);
 				}
 				else
 					return array();
-			'),
+			},
 		),
 		// ps = Paid Subscriptions.
 		'ps' => array(
@@ -280,27 +286,28 @@ function ModifyCoreFeatures($return_config = false)
 			'settings' => array(
 				'paid_enabled' => 1,
 			),
-			'setting_callback' => create_function('$value', '
+			'setting_callback' => function($value)
+			{
 				global $smcFunc, $sourcedir;
 
 				// Set the correct disabled value for scheduled task.
-				$smcFunc[\'db_query\'](\'\', \'
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}scheduled_tasks
 					SET disabled = {int:disabled}
-					WHERE task = {string:task}\',
+					WHERE task = {string:task}',
 					array(
-						\'disabled\' => $value ? 0 : 1,
-						\'task\' => \'paid_subscriptions\',
+						'disabled' => $value ? 0 : 1,
+						'task' => 'paid_subscriptions',
 					)
 				);
 
 				// Should we calculate next trigger?
 				if ($value)
 				{
-					require_once($sourcedir . \'/ScheduledTasks.php\');
-					CalculateNextTrigger(\'paid_subscriptions\');
+					require_once($sourcedir . '/ScheduledTasks.php');
+					CalculateNextTrigger('paid_subscriptions');
 				}
-			'),
+			},
 		),
 		// rg = report generator.
 		'rg' => array(
@@ -309,32 +316,33 @@ function ModifyCoreFeatures($return_config = false)
 		// w = warning.
 		'w' => array(
 			'url' => 'action=admin;area=securitysettings;sa=moderation',
-			'setting_callback' => create_function('$value', '
+			'setting_callback' => function($value)
+			{
 				global $modSettings;
-				list ($modSettings[\'warning_enable\'], $modSettings[\'user_limit\'], $modSettings[\'warning_decrement\']) = explode(\',\', $modSettings[\'warning_settings\']);
-				$warning_settings = ($value ? 1 : 0) . \',\' . $modSettings[\'user_limit\'] . \',\' . $modSettings[\'warning_decrement\'];
+				list ($modSettings['warning_enable'], $modSettings['user_limit'], $modSettings['warning_decrement']) = explode(',', $modSettings['warning_settings']);
+				$warning_settings = ($value ? 1 : 0) . ',' . $modSettings['user_limit'] . ',' . $modSettings['warning_decrement'];
 				if (!$value)
 				{
 					$returnSettings = array(
-						\'warning_watch\' => 0,
-						\'warning_moderate\' => 0,
-						\'warning_mute\' => 0,
+						'warning_watch' => 0,
+						'warning_moderate' => 0,
+						'warning_mute' => 0,
 					);
 				}
-				elseif (empty($modSettings[\'warning_enable\']) && $value)
+				elseif (empty($modSettings['warning_enable']) && $value)
 				{
 					$returnSettings = array(
-						\'warning_watch\' => 10,
-						\'warning_moderate\' => 35,
-						\'warning_mute\' => 60,
+						'warning_watch' => 10,
+						'warning_moderate' => 35,
+						'warning_mute' => 60,
 					);
 				}
 				else
 					$returnSettings = array();
 
-				$returnSettings[\'warning_settings\'] = $warning_settings;
+				$returnSettings['warning_settings'] = $warning_settings;
 				return $returnSettings;
-			'),
+			},
 		),
 		// Search engines
 		'sp' => array(
@@ -342,16 +350,50 @@ function ModifyCoreFeatures($return_config = false)
 			'settings' => array(
 				'spider_mode' => 1,
 			),
-			'setting_callback' => create_function('$value', '
+			'setting_callback' => function($value)
+			{
 				// Turn off the spider group if disabling.
 				if (!$value)
-					return array(\'spider_group\' => 0, \'show_spider_online\' => 0);
-			'),
-			'on_save' => create_function('', '
+					return array('spider_group' => 0, 'show_spider_online' => 0);
+			},
+			'on_save' => function()
+			{
 				global $sourcedir, $modSettings;
-				require_once($sourcedir . \'/ManageSearchEngines.php\');
+				require_once($sourcedir . '/ManageSearchEngines.php');
 				recacheSpiderNames();
-			'),
+			},
+		),
+		// Quick setting to toggle into GDPR compliance
+		'gdpr' => array(
+			'url' => 'action=admin;area=regcenter;sa=policy',
+			'settings' => array(
+				'force_gdpr' => 1,
+				// DEVELOPERS: Add values to toggle here
+			),
+			'setting_callback' => function($value)
+			{
+				global $modSettings;
+
+				$returnSettings = array();
+
+				if ($value)
+				{
+					$returnSettings['requireAgreement'] = 1;
+					$returnSettings['requirePolicyAgreement'] = 1;
+					$returnSettings['allow_disableAnnounce'] = 1;
+					$returnSettings['announcements_default'] = 0;
+					$returnSettings['notify_tokens'] = 1;
+				}
+
+				return $returnSettings;
+			},
+			'save_callback' => function($value)
+			{
+				global $modSettings, $language, $context;
+
+				if ($value && empty($modSettings['policy_' . $language]))
+					redirectexit('action=admin;area=regcenter;sa=policy;' . $context['session_var'] . '=' . $context['session_id']);
+			},
 		),
 	);
 
@@ -442,6 +484,8 @@ function ModifyCoreFeatures($return_config = false)
 	if ($context['is_new_install'])
 		updateSettings(array('admin_features' => ''));
 
+	$context['show_privacy_policy_warning'] = empty($modSettings['policy_' . $language]);
+
 	$context['sub_template'] = 'core_features';
 	$context['page_title'] = $txt['core_settings_title'];
 }
@@ -481,7 +525,8 @@ function ModifyBasicSettings($return_config = false)
 			array('check', 'hitStats'),
 		'',
 			// Option-ish things... miscellaneous sorta.
-			array('check', 'allow_disableAnnounce'),
+			array('check', 'allow_disableAnnounce', 'disabled' => !empty($modSettings['force_gdpr'])),
+			array('check', 'notify_tokens', 'disabled' => !empty($modSettings['force_gdpr'])),
 			array('check', 'disallow_sendBody'),
 	);
 
@@ -508,6 +553,13 @@ function ModifyBasicSettings($return_config = false)
 		if (isset($_POST['lastActive']))
 			$_POST['lastActive'] = min((int) $_POST['lastActive'], 1440);
 
+		// GDPR requires these settings to always be true
+		if (!empty($modSettings['force_gdpr']))
+		{
+			$_POST['allow_disableAnnounce'] = 1;
+			$_POST['notify_tokens'] = 1;
+		}
+
 		saveDBSettings($config_vars);
 
 		writeLog();
@@ -1332,11 +1384,12 @@ function ShowCustomProfiles()
 					'value' => $txt['custom_edit_active'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						$isChecked = $rowData[\'disabled\'] ? \'\' : \' checked="checked"\';
-						$onClickHandler = $rowData[\'can_show_register\'] ? sprintf(\'onclick="document.getElementById(\\\'reg_%1$s\\\').disabled = !this.checked;"\', $rowData[\'id\']) : \'\';
-						return sprintf(\'<input type="checkbox" name="active[]" id="active_%1$s" value="%1$s" class="input_check"%2$s%3$s />\', $rowData[\'id\'], $isChecked, $onClickHandler);
-					'),
+					'function' => function($rowData)
+					{
+						$isChecked = $rowData['disabled'] ? '' : ' checked';
+						$onClickHandler = $rowData['can_show_register'] ? sprintf(' onclick="document.getElementById(\'reg_%1$s\').disabled = !this.checked;"', $rowData['id']) : '';
+						return sprintf('<input type="checkbox" name="active[]" id="active_%1$s" value="%1$s" %2$s%3$s>', $rowData['id'], $isChecked, $onClickHandler);
+					},
 					'style' => 'width: 20%; text-align: center;',
 				),
 			),
@@ -1345,11 +1398,12 @@ function ShowCustomProfiles()
 					'value' => $txt['custom_edit_registration'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						$isChecked = $rowData[\'on_register\'] && !$rowData[\'disabled\'] ? \' checked="checked"\' : \'\';
-						$isDisabled = $rowData[\'can_show_register\'] ? \'\' : \' disabled="disabled"\';
-						return sprintf(\'<input type="checkbox" name="reg[]" id="reg_%1$s" value="%1$s" class="input_check"%2$s%3$s />\', $rowData[\'id\'], $isChecked, $isDisabled);
-					'),
+					'function' => function($rowData)
+					{
+						$isChecked = $rowData['on_register'] && !$rowData['disabled'] ? ' checked' : '';
+						$isDisabled = $rowData['can_show_register'] ? '' : ' disabled';
+						return sprintf('<input type="checkbox" name="reg[]" id="reg_%1$s" value="%1$s" %2$s%3$s>', $rowData['id'], $isChecked, $isDisabled);
+					},
 					'style' => 'width: 20%; text-align: center;',
 				),
 			),
@@ -1391,11 +1445,10 @@ function ShowCustomProfiles()
 					'style' => 'text-align: left;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $scripturl;
-
-						return sprintf(\'<a href="%1$s?action=admin;area=featuresettings;sa=profileedit;fid=%2$d">%3$s</a><div class="smalltext">%4$s</div>\', $scripturl, $rowData[\'id_field\'], $rowData[\'field_name\'], $rowData[\'field_desc\']);
-					'),
+					'function' => function($rowData) use ($scripturl)
+					{
+						return sprintf('<a href="%1$s?action=admin;area=featuresettings;sa=profileedit;fid=%2$d">%3$s</a><div class="smalltext">%4$s</div>', $scripturl, $rowData['id_field'], $rowData['field_name'], $rowData['field_desc']);
+					},
 					'style' => 'width: 62%;',
 				),
 				'sort' => array(
@@ -1409,12 +1462,11 @@ function ShowCustomProfiles()
 					'style' => 'text-align: left;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
-						$textKey = sprintf(\'custom_profile_type_%1$s\', $rowData[\'field_type\']);
+					'function' => function($rowData) use ($txt)
+					{
+						$textKey = sprintf('custom_profile_type_%1$s', $rowData['field_type']);
 						return isset($txt[$textKey]) ? $txt[$textKey] : $textKey;
-					'),
+					},
 					'style' => 'width: 15%;',
 				),
 				'sort' => array(
@@ -1427,11 +1479,10 @@ function ShowCustomProfiles()
 					'value' => $txt['custom_profile_active'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
-						return $rowData[\'active\'] ? $txt[\'yes\'] : $txt[\'no\'];
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return $rowData['active'] ? $txt['yes'] : $txt['no'];
+					},
 					'style' => 'width: 8%; text-align: center;',
 				),
 				'sort' => array(
@@ -1444,11 +1495,12 @@ function ShowCustomProfiles()
 					'value' => $txt['custom_profile_placement'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
+					'function' => function($rowData)
+					{
+						global $txt, $context;
 
-						return $txt[\'custom_profile_placement_\' . (empty($rowData[\'placement\']) ? \'standard\' : ($rowData[\'placement\'] == 1 ? \'withicons\' : \'abovesignature\'))];
-					'),
+						return $txt['custom_profile_placement_' . (empty($rowData['placement']) ? 'standard' : ($rowData['placement'] == 1 ? 'withicons' : 'abovesignature'))];
+					},
 					'style' => 'width: 8%; text-align: center;',
 				),
 				'sort' => array(
diff --git a/Sources/ManageSmileys.php b/Sources/ManageSmileys.php
index 4d6e080..b7b5e11 100644
--- a/Sources/ManageSmileys.php
+++ b/Sources/ManageSmileys.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -371,9 +371,10 @@ function EditSmileySets()
 					'value' => $txt['smiley_sets_default'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return $rowData[\'selected\'] ? \'<strong>*</strong>\' : \'\';
-					'),
+					'function' => function($rowData)
+					{
+						return $rowData['selected'] ? '<strong>*</strong>' : '';
+					},
 					'style' => 'text-align: center;',
 				),
 				'sort' => array(
@@ -430,9 +431,10 @@ function EditSmileySets()
 					'value' => '<input type="checkbox" onclick="invertAll(this, this.form);" class="input_check" />',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						return $rowData[\'id\'] == 0 ? \'\' : sprintf(\'<input type="checkbox" name="smiley_set[%1$d]" class="input_check" />\', $rowData[\'id\']);
-					'),
+					'function' => function($rowData)
+					{
+						return $rowData['id'] == 0 ? '' : sprintf('<input type="checkbox" name="smiley_set[%1$d]" class="input_check" />', $rowData['id']);
+					},
 					'style' => 'text-align: center',
 				),
 			),
@@ -952,16 +954,15 @@ function EditSmileys()
 						'value' => $txt['smileys_location'],
 					),
 					'data' => array(
-						'function' => create_function('$rowData', '
-							global $txt;
-
-							if (empty($rowData[\'hidden\']))
-								return $txt[\'smileys_location_form\'];
-							elseif ($rowData[\'hidden\'] == 1)
-								return $txt[\'smileys_location_hidden\'];
+						'function' => function($rowData) use ($txt)
+						{
+							if (empty($rowData['hidden']))
+								return $txt['smileys_location_form'];
+							elseif ($rowData['hidden'] == 1)
+								return $txt['smileys_location_hidden'];
 							else
-								return $txt[\'smileys_location_popup\'];
-						'),
+								return $txt['smileys_location_popup'];
+						},
 						'class' => 'windowbg',
 					),
 					'sort' => array(
@@ -974,24 +975,24 @@ function EditSmileys()
 						'value' => $txt['smileys_description'],
 					),
 					'data' => array(
-						'function' => create_function('$rowData', empty($modSettings['smileys_dir']) || !is_dir($modSettings['smileys_dir']) ? '
-							return htmlspecialchars($rowData[\'description\']);
-						' : '
-							global $context, $txt, $modSettings;
+						'function' => function($rowData) use ($modSettings, $context, $txt)
+						{
+							if (empty($modSettings['smileys_dir']) || !is_dir($modSettings['smileys_dir']))
+								return htmlspecialchars($rowData['description']);
 
 							// Check if there are smileys missing in some sets.
 							$missing_sets = array();
-							foreach ($context[\'smiley_sets\'] as $smiley_set)
-								if (!file_exists(sprintf(\'%1$s/%2$s/%3$s\', $modSettings[\'smileys_dir\'], $smiley_set[\'path\'], $rowData[\'filename\'])))
-									$missing_sets[] = $smiley_set[\'path\'];
+							foreach ($context['smiley_sets'] as $smiley_set)
+								if (!file_exists(sprintf('%1$s/%2$s/%3$s', $modSettings['smileys_dir'], $smiley_set['path'], $rowData['filename'])))
+									$missing_sets[] = $smiley_set['path'];
 
-							$description = htmlspecialchars($rowData[\'description\']);
+							$description = htmlspecialchars($rowData['description']);
 
 							if (!empty($missing_sets))
-								$description .= sprintf(\'<br /><span class="smalltext"><strong>%1$s:</strong> %2$s</span>\', $txt[\'smileys_not_found_in_set\'], implode(\', \', $missing_sets));
+								$description .= sprintf('<br /><span class="smalltext"><strong>%1$s:</strong> %2$s</span>', $txt['smileys_not_found_in_set'], implode(', ', $missing_sets));
 
 							return $description;
-						'),
+						},
 						'class' => 'windowbg',
 					),
 					'sort' => array(
@@ -1613,12 +1614,11 @@ function EditMessageIcons()
 		'columns' => array(
 			'icon' => array(
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $settings;
-
-						$images_url = $settings[file_exists(sprintf(\'%1$s/images/post/%2$s.gif\', $settings[\'theme_dir\'], $rowData[\'filename\'])) ? \'actual_images_url\' : \'default_images_url\'];
-						return sprintf(\'<img src="%1$s/post/%2$s.gif" alt="%3$s" />\', $images_url, $rowData[\'filename\'], htmlspecialchars($rowData[\'title\']));
-					'),
+					'function' => function($rowData) use ($settings)
+					{
+						$images_url = $settings[file_exists(sprintf('%1$s/images/post/%2$s.gif', $settings['theme_dir'], $rowData['filename'])) ? 'actual_images_url' : 'default_images_url'];
+						return sprintf('<img src="%1$s/post/%2$s.gif" alt="%3$s" />', $images_url, $rowData['filename'], htmlspecialchars($rowData['title']));
+					},
 				),
 				'style' => 'text-align: center;',
 			),
@@ -1649,11 +1649,10 @@ function EditMessageIcons()
 					'value' => $txt['icons_board'],
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $txt;
-
-						return empty($rowData[\'board_name\']) ? $txt[\'icons_edit_icons_all_boards\'] : $rowData[\'board_name\'];
-					'),
+					'function' => function($rowData) use ($txt)
+					{
+						return empty($rowData['board_name']) ? $txt['icons_edit_icons_all_boards'] : $rowData['board_name'];
+					},
 				),
 			),
 			'modify' => array(
diff --git a/Sources/Memberlist.php b/Sources/Memberlist.php
index 27a7480..89a5f64 100644
--- a/Sources/Memberlist.php
+++ b/Sources/Memberlist.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -438,7 +438,7 @@ function MLSearch()
 	{
 		$_POST['search'] = trim(isset($_GET['search']) ? $_GET['search'] : $_POST['search']);
 
-		if (!get_magic_quotes_gpc())
+		if (!(version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc() != 0))
 		{
 			// Escape things just in case...
 			if (isset($_GET['fields']))
diff --git a/Sources/ModerationCenter.php b/Sources/ModerationCenter.php
index a0a6454..9ae21b5 100644
--- a/Sources/ModerationCenter.php
+++ b/Sources/ModerationCenter.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -1143,11 +1143,10 @@ function ViewWatchedUsers()
 					'value' => $txt['mc_watched_users_warning'],
 				),
 				'data' => array(
-					'function' => create_function('$member', '
-						global $scripturl;
-
-						return allowedTo(\'issue_warning\') ? \'<a href="\' . $scripturl . \'?action=profile;area=issuewarning;u=\' . $member[\'id\'] . \'">\' . $member[\'warning\'] . \'%</a>\' : $member[\'warning\'] . \'%\';
-					'),
+					'function' => function($member) use ($scripturl)
+					{
+						return allowedTo('issue_warning') ? '<a href="' . $scripturl . '?action=profile;area=issuewarning;u=' . $member['id'] . '">' . $member['warning'] . '%</a>' : $member['warning'] . '%';
+					},
 				),
 				'sort' => array(
 					'default' => 'warning',
@@ -1189,14 +1188,13 @@ function ViewWatchedUsers()
 					'value' => $txt['mc_watched_users_last_post'],
 				),
 				'data' => array(
-					'function' => create_function('$member', '
-						global $scripturl;
-
-						if ($member[\'last_post_id\'])
-							return \'<a href="\' . $scripturl . \'?msg=\' . $member[\'last_post_id\'] . \'">\' . $member[\'last_post\'] . \'</a>\';
+					'function' => function($member) use ($scripturl)
+					{
+						if ($member['last_post_id'])
+							return '<a href="' . $scripturl . '?msg=' . $member['last_post_id'] . '">' . $member['last_post'] . '</a>';
 						else
-							return $member[\'last_post\'];
-					'),
+							return $member['last_post'];
+					},
 				),
 			),
 		),
@@ -1225,9 +1223,10 @@ function ViewWatchedUsers()
 		$listOptions['columns'] = array(
 			'posts' => array(
 				'data' => array(
-					'function' => create_function('$post', '
+					'function' => function($post)
+					{
 						return template_user_watch_post_callback($post);
-					'),
+					},
 				),
 			),
 		);
@@ -1446,6 +1445,7 @@ function ViewWarnings()
 function ViewWarningLog()
 {
 	global $smcFunc, $modSettings, $context, $txt, $scripturl, $sourcedir;
+	global $settings;
 
 	// Setup context as always.
 	$context['page_title'] = $txt['mc_warning_log_title'];
@@ -1509,22 +1509,18 @@ function ViewWarningLog()
 					'value' => $txt['profile_warning_previous_reason'],
 				),
 				'data' => array(
-					'function' => create_function('$warning', '
-						global $scripturl, $settings, $txt;
-
-						$output = \'
+					'function' => function($rowData) use ($scripturl, $txt, $settings)
+					{
+						$output = '
 							<div class="floatleft">
-								\' . $warning[\'reason\'] . \'
-							</div>\';
-
-						if (!empty($warning[\'id_notice\']))
-							$output .= \'
-							<div class="floatright">
-								<a href="\' . $scripturl . \'?action=moderate;area=notice;nid=\' . $warning[\'id_notice\'] . \'" onclick="window.open(this.href, \\\'\\\', \\\'scrollbars=yes,resizable=yes,width=400,height=250\\\');return false;" target="_blank" class="new_win" title="\' . $txt[\'profile_warning_previous_notice\'] . \'"><img src="\' . $settings[\'default_images_url\'] . \'/filter.gif" alt="\' . $txt[\'profile_warning_previous_notice\'] . \'" /></a>
-							</div>\';
+								' . $rowData['reason'] . '
+							</div>';
 
+						if (!empty($rowData['id_notice']))
+							$output .= '
+								&nbsp;<a href="' . $scripturl . '?action=moderate;area=notice;nid=' . $rowData['id_notice'] . '" onclick="window.open(this.href, \'\', \'scrollbars=yes,resizable=yes,width=400,height=250\');return false;" target="_blank" rel="noopener" class="new_win" title="' . $txt['profile_warning_previous_notice'] . '"><img src="' . $settings['default_images_url'] . '/filter.gif" alt="' . $txt['profile_warning_previous_notice'] . '" /></a>';
 						return $output;
-					'),
+					},
 				),
 			),
 			'points' => array(
@@ -1712,11 +1708,10 @@ function ViewWarningTemplates()
 					'style' => 'width: 4%;',
 				),
 				'data' => array(
-					'function' => create_function('$rowData', '
-						global $context, $txt, $scripturl;
-
-						return \'<input type="checkbox" name="deltpl[]" value="\' . $rowData[\'id_comment\'] . \'" class="input_check" />\';
-					'),
+					'function' => function($rowData)
+					{
+						return '<input type="checkbox" name="deltpl[]" value="' . $rowData['id_comment'] . '">';
+					},
 					'style' => 'text-align: center;',
 				),
 			),
diff --git a/Sources/Modlog.php b/Sources/Modlog.php
index d56f661..25c09a8 100644
--- a/Sources/Modlog.php
+++ b/Sources/Modlog.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -59,6 +59,8 @@ function ViewModlog()
 	$context['displaypage'] = 30;
 	// Amount of hours that must pass before allowed to delete file.
 	$context['hoursdisable'] = 24;
+	// Actions whose log entries cannot be deleted.
+	$context['uneditable_actions'] = !empty($modSettings['force_gdpr']) ? array('agreement_updated', 'policy_updated') : array();
 
 	// Handle deletion...
 	if (isset($_POST['removeall']) && $context['can_delete'])
@@ -68,10 +70,12 @@ function ViewModlog()
 		$smcFunc['db_query']('', '
 			DELETE FROM {db_prefix}log_actions
 			WHERE id_log = {int:moderate_log}
-				AND log_time < {int:twenty_four_hours_wait}',
+				AND log_time < {int:twenty_four_hours_wait}' . (!empty($context['uneditable_actions']) ? '
+				AND action NOT IN ({array_string:uneditable})' : ''),
 			array(
 				'twenty_four_hours_wait' => time() - $context['hoursdisable'] * 3600,
 				'moderate_log' => $context['log_type'],
+				'uneditable' => $context['uneditable_actions'],
 			)
 		);
 	}
@@ -82,11 +86,13 @@ function ViewModlog()
 			DELETE FROM {db_prefix}log_actions
 			WHERE id_log = {int:moderate_log}
 				AND id_action IN ({array_string:delete_actions})
-				AND log_time < {int:twenty_four_hours_wait}',
+				AND log_time < {int:twenty_four_hours_wait}' . (!empty($context['uneditable_actions']) ? '
+				AND action NOT IN ({array_string:uneditable})' : ''),
 			array(
 				'twenty_four_hours_wait' => time() - $context['hoursdisable'] * 3600,
 				'delete_actions' => array_unique($_POST['delete']),
 				'moderate_log' => $context['log_type'],
+				'uneditable' => $context['uneditable_actions'],
 			)
 		);
 	}
@@ -260,9 +266,10 @@ function ViewModlog()
 					'value' => '<input type="checkbox" name="all" class="input_check" onclick="invertAll(this, this.form);" />',
 				),
 				'data' => array(
-					'function' => create_function('$entry', '
-						return \'<input type="checkbox" class="input_check" name="delete[]" value="\' . $entry[\'id\'] . \'"\' . ($entry[\'editable\'] ? \'\' : \' disabled="disabled"\') . \' />\';
-					'),
+					'function' => function($entry)
+					{
+						return '<input type="checkbox" class="input_check" name="delete[]" value="' . $entry['id'] . '"' . ($entry['editable'] ? '' : ' disabled="disabled"') . ' />';
+					},
 					'style' => 'text-align: center;',
 				),
 			),
@@ -279,7 +286,7 @@ function ViewModlog()
 		'additional_rows' => array(
 			array(
 				'position' => 'after_title',
-				'value' => $txt['modlog_' . ($context['log_type'] == 3 ? 'admin' : 'moderation') . '_log_desc'],
+				'value' => $txt['modlog_' . ($context['log_type'] == 3 ? 'admin' : 'moderation') . '_log_desc'] . (!empty($modSettings['force_gdpr']) && $context['log_type'] == 3 ? '<br />' . $txt['modlog_admin_log_gdpr_no_delete'] : ''),
 				'class' => 'smalltext',
 				'style' => 'padding: 2ex;',
 			),
@@ -341,6 +348,8 @@ function list_getModLogEntries($start, $items_per_page, $sort, $query_string = '
 	// Do a little bit of self protection.
 	if (!isset($context['hoursdisable']))
 		$context['hoursdisable'] = 24;
+	if (!isset($context['uneditable_actions']))
+		$context['uneditable_actions'] = array();
 
 	// Can they see the IP address?
 	$seeIP = allowedTo('moderate_forum');
@@ -454,7 +463,7 @@ function list_getModLogEntries($start, $items_per_page, $sort, $query_string = '
 			'moderator_link' => $row['id_member'] ? '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member'] . '">' . $row['real_name'] . '</a>' : (empty($row['real_name']) ? ($txt['guest'] . (!empty($row['extra']['member_acted']) ? ' (' . $row['extra']['member_acted'] . ')' : '')) : $row['real_name']),
 			'time' => timeformat($row['log_time']),
 			'timestamp' => forum_time(true, $row['log_time']),
-			'editable' => time() > $row['log_time'] + $context['hoursdisable'] * 3600,
+			'editable' => time() > $row['log_time'] + $context['hoursdisable'] * 3600 && !in_array($row['action'], $context['uneditable_actions']),
 			'extra' => $row['extra'],
 			'action' => $row['action'],
 			'action_text' => isset($row['action_text']) ? $row['action_text'] : '',
@@ -588,7 +597,6 @@ function list_getModLogEntries($start, $items_per_page, $sort, $query_string = '
 	}
 
 	// Do some formatting of the action string.
-	$callback = pregReplaceCurry('list_getModLogEntriesCallback', 3);
 	foreach ($entries as $k => $entry)
 	{
 		// Make any message info links so its easier to go find that message.
@@ -602,18 +610,15 @@ function list_getModLogEntries($start, $items_per_page, $sort, $query_string = '
 
 		if (empty($entries[$k]['action_text']))
 			$entries[$k]['action_text'] = isset($txt['modlog_ac_' . $entry['action']]) ? $txt['modlog_ac_' . $entry['action']] : $entry['action'];
-		$entries[$k]['action_text'] = preg_replace_callback('~\{([A-Za-z\d_]+)\}~i', $callback($entries, $k), $entries[$k]['action_text']);
-
+		$entries[$k]['action_text'] = preg_replace_callback('~\{([A-Za-z\d_]+)\}~i',
+			function($matches) use ($entries, $k)
+			{
+				return isset($entries[$k]['extra'][$matches[1]]) ? $entries[$k]['extra'][$matches[1]] : '';
+			}, $entries[$k]['action_text']);
 	}
 
 	// Back we go!
 	return $entries;
 }
 
-// Mog Log Replacment Callback.
-function list_getModLogEntriesCallback($entries, $key, $matches)
-{
-    return isset($entries[$key]['extra'][$matches[1]]) ? $entries[$key]['extra'][$matches[1]] : '';
-}
-
 ?>
\ No newline at end of file
diff --git a/Sources/News.php b/Sources/News.php
index b5e138e..6f5e1b6 100644
--- a/Sources/News.php
+++ b/Sources/News.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.8
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -65,7 +65,7 @@ function ShowXmlFeed()
 	global $query_this_board, $smcFunc, $forum_version, $cdata_override;
 
 	// If it's not enabled, die.
-	if (empty($modSettings['xmlnews_enable']))
+	if (empty($modSettings['xmlnews_enable']) && (empty($_GET['sa']) || empty($_GET['u']) || $_GET['sa'] !== 'profile' || $_GET['u'] !== $user_info['id']))
 		obExit(false);
 
 	loadLanguage('Stats');
@@ -259,6 +259,19 @@ function ShowXmlFeed()
 	elseif ($xml_format == 'rdf')
 		header('Content-Type: ' . ($context['browser']['is_ie'] ? 'text/xml' : 'application/rdf+xml') . '; charset=' . (empty($context['character_set']) ? 'ISO-8859-1' : $context['character_set']));
 
+	// Descriptive filenames = good
+	$xml_filename = array(preg_replace('/\s+/', '_', $feed_title), $_GET['sa']);
+	if ($_GET['sa'] === 'profile')
+		$xml_filename[] = 'u=' . (isset($_GET['u']) ? (int) $_GET['u'] : $user_info['id']);
+	if (!empty($boards))
+		$xml_filename[] = 'boards=' . implode(',', $boards);
+	elseif (!empty($board))
+		$xml_filename[] = 'board=' . $board;
+	$xml_filename[] = $xml_format;
+	$xml_filename = strtr(un_htmlspecialchars(implode('-', $xml_filename)), '"', '') ;
+
+	header('Content-Disposition: ' . (isset($_GET['download']) ? 'attachment' : 'inline') . '; filename="' . $xml_filename . '.xml"');
+
 	// First, output the xml header.
 	echo '<?xml version="1.0" encoding="', $context['character_set'], '"?' . '>';
 
@@ -313,7 +326,7 @@ function ShowXmlFeed()
 
 	<modified>', gmstrftime('%Y-%m-%dT%H:%M:%SZ'), '</modified>
 	<tagline><![CDATA[', strip_tags($txt['xml_rss_desc']), ']]></tagline>
-	<generator uri="http://www.simplemachines.org" version="', strtr($forum_version, array('SMF' => '')), '">SMF</generator>
+	<generator uri="https://www.simplemachines.org" version="', strtr($forum_version, array('SMF' => '')), '">SMF</generator>
 	<author>
 		<name>', strip_tags($context['forum_name']), '</name>
 	</author>';
@@ -389,13 +402,17 @@ function cdata_parse($data, $ns = '')
 	if (!empty($cdata_override))
 		return $data;
 
+	// Do we even need to do this?
+	if (strpbrk($data, '<>&') == false)
+		return $data;
+
 	$cdata = '<![CDATA[';
 
 	for ($pos = 0, $n = $smcFunc['strlen']($data); $pos < $n; null)
 	{
 		$positions = array(
 			$smcFunc['strpos']($data, '&', $pos),
-			$smcFunc['strpos']($data, ']', $pos),
+			$smcFunc['strpos']($data, ']]>', $pos),
 		);
 		if ($ns != '')
 			$positions[] = $smcFunc['strpos']($data, '<', $pos);
@@ -424,10 +441,10 @@ function cdata_parse($data, $ns = '')
 				$cdata .= ']]><' . $ns . ':' . $smcFunc['substr']($data, $pos + 1, $pos2 - $pos) . '<![CDATA[';
 			$pos = $pos2 + 1;
 		}
-		elseif ($smcFunc['substr']($data, $pos, 1) == ']')
+		elseif ($smcFunc['substr']($data, $pos, 3) == ']]>')
 		{
-			$cdata .= ']]>&#093;<![CDATA[';
-			$pos++;
+			$cdata .= ']]]]><![CDATA[>';
+			$pos = $pos + 3;
 		}
 		elseif ($smcFunc['substr']($data, $pos, 1) == '&')
 		{
@@ -850,7 +867,7 @@ function getXmlRecent($xml_format)
 
 function getXmlProfile($xml_format)
 {
-	global $scripturl, $memberContext, $user_profile, $modSettings, $user_info;
+	global $scripturl, $memberContext, $user_profile, $modSettings, $user_info, $smcFunc, $language;
 
 	// You must input a valid user....
 	if (empty($_GET['u']) || loadMemberData((int) $_GET['u']) === false)
@@ -887,7 +904,7 @@ function getXmlProfile($xml_format)
 			'summary' => cdata_parse(isset($profile['group']) ? $profile['group'] : $profile['post_group']),
 			'author' => array(
 				'name' => $profile['real_name'],
-				'email' => in_array(showEmailAddress(!empty($profile['hide_email']), $profile['id']), array('yes', 'yes_permission_override')) ? $profile['email'] : null,
+				'email' => $user_info['id'] == $profile['id'] || in_array($profile['show_email'], array('yes', 'yes_permission_override')) ? $profile['email'] : null,
 				'uri' => !empty($profile['website']) ? $profile['website']['url'] : ''
 			),
 			'published' => gmstrftime('%Y-%m-%dT%H:%M:%SZ', $user_profile[$profile['id']]['date_registered']),
@@ -903,7 +920,7 @@ function getXmlProfile($xml_format)
 			'link' => $scripturl . '?action=profile;u=' . $profile['id'],
 			'posts' => $profile['posts'],
 			'post-group' => cdata_parse($profile['post_group']),
-			'language' => cdata_parse($profile['language']),
+			'language' => cdata_parse(!empty($profile['language']) ? $profile['language'] : $smcFunc['ucwords'](strtr($language, array('_' => ' ', '-utf8' => '')))),
 			'last-login' => gmdate('D, d M Y H:i:s \G\M\T', $user_profile[$profile['id']]['last_login']),
 			'registered' => gmdate('D, d M Y H:i:s \G\M\T', $user_profile[$profile['id']]['date_registered'])
 		);
@@ -952,7 +969,7 @@ function getXmlProfile($xml_format)
 				'bad' => $profile['karma']['bad']
 			);
 
-		if (in_array($profile['show_email'], array('yes', 'yes_permission_override')))
+		if ($user_info['id'] == $profile['id'] || in_array($profile['show_email'], array('yes', 'yes_permission_override')))
 			$data['email'] = $profile['email'];
 
 		if (!empty($profile['birth_date']) && substr($profile['birth_date'], 0, 4) != '0000')
diff --git a/Sources/Notify.php b/Sources/Notify.php
index c6da2d7..843a586 100644
--- a/Sources/Notify.php
+++ b/Sources/Notify.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -34,6 +34,22 @@ if (!defined('SMF'))
 		- requires the mark_notify permission.
 		- redirects the user back to the board after it is done.
 		- is accessed via ?action=notifyboard.
+
+	void AnnouncementsNotify()
+		- is called to turn off/on notification for newsletters, announcements, etc.
+		- uses the Notify template. (notify_board sub template.)
+		- asks for a sub action (on/off) if none was specified.
+		- shows a success message after it is done.
+		- is accessed via ?action=notifyannoucements.
+
+	void getMemberWithToken(type = '')
+		- verifies a subscribe/unsubscribe token, then returns some basic member info.
+		- the type parameter is used to indicate what sort of notification the token is for.
+		- shows a fatal error message to the user and dies if the token is invalid.
+
+	void createUnsubscribeToken(int memID, string email, type = '', itemID = 0)
+		- builds a subscribe/unsubscribe token.
+		- each token is unique to a member's email and to the thing they want to unsubscribe from
 */
 
 // Turn on/off notifications...
@@ -41,9 +57,21 @@ function Notify()
 {
 	global $scripturl, $txt, $topic, $user_info, $context, $smcFunc;
 
-	// Make sure they aren't a guest or something - guests can't really receive notifications!
-	is_not_guest();
-	isAllowedTo('mark_any_notify');
+	// Are they trying a token-based anonymous request?
+	if (isset($_REQUEST['u']) && isset($_REQUEST['token']))
+	{
+		$member_info = getMemberWithToken('topic');
+		$skipCheckSession = true;
+	}
+	// Otherwise, this is for the current user.
+	else
+	{
+		// Make sure they aren't a guest or something - guests can't really receive notifications!
+		is_not_guest();
+		isAllowedTo('mark_any_notify');
+
+		$member_info = $user_info;
+	}
 
 	// Make sure the topic has been specified.
 	if (empty($topic))
@@ -63,13 +91,19 @@ function Notify()
 				AND id_topic = {int:current_topic}
 			LIMIT 1',
 			array(
-				'current_member' => $user_info['id'],
+				'current_member' => $member_info['id'],
 				'current_topic' => $topic,
 			)
 		);
 		$context['notification_set'] = $smcFunc['db_num_rows']($request) != 0;
 		$smcFunc['db_free_result']($request);
 
+		if ($member_info['id'] !== $user_info['id'])
+			$context['notify_info'] = array(
+				'u' => $member_info['id'],
+				'token' => $_REQUEST['token'],
+			);
+
 		// Set the template variables...
 		$context['topic_href'] = $scripturl . '?topic=' . $topic . '.' . $_REQUEST['start'];
 		$context['start'] = $_REQUEST['start'];
@@ -79,19 +113,21 @@ function Notify()
 	}
 	elseif ($_GET['sa'] == 'on')
 	{
-		checkSession('get');
+		if (empty($skipCheckSession))
+			checkSession('get');
 
 		// Attempt to turn notifications on.
 		$smcFunc['db_insert']('ignore',
 			'{db_prefix}log_notify',
 			array('id_member' => 'int', 'id_topic' => 'int'),
-			array($user_info['id'], $topic),
+			array($member_info['id'], $topic),
 			array('id_member', 'id_topic')
 		);
 	}
 	else
 	{
-		checkSession('get');
+		if (empty($skipCheckSession))
+			checkSession('get');
 
 		// Just turn notifications off.
 		$smcFunc['db_query']('', '
@@ -99,12 +135,22 @@ function Notify()
 			WHERE id_member = {int:current_member}
 				AND id_topic = {int:current_topic}',
 			array(
-				'current_member' => $user_info['id'],
+				'current_member' => $member_info['id'],
 				'current_topic' => $topic,
 			)
 		);
 	}
 
+	// If this request wasn't for the current user, just show a confirmation message.
+	if ($member_info['id'] !== $user_info['id'])
+	{
+		loadTemplate('Notify');
+		$context['page_title'] = $txt['notification'];
+		$context['sub_template'] = 'notify_pref_changed';
+		$context['notify_success_msg'] = sprintf($txt['notifytopic' . ($_GET['sa'] == 'on' ? '_subscribed' : '_unsubscribed')], $member_info['email']);
+		return;
+	}
+
 	// Send them back to the topic.
 	redirectexit('topic=' . $topic . '.' . $_REQUEST['start']);
 }
@@ -113,9 +159,21 @@ function BoardNotify()
 {
 	global $scripturl, $txt, $board, $user_info, $context, $smcFunc;
 
-	// Permissions are an important part of anything ;).
-	is_not_guest();
-	isAllowedTo('mark_notify');
+	// Unsubscribing with a token.
+	if (isset($_REQUEST['u']) && isset($_REQUEST['token']))
+	{
+		$member_info = getMemberWithToken('board');
+		$skipCheckSession = true;
+	}
+	// No token, so try with the current user.
+	else
+	{
+		// Permissions are an important part of anything ;).
+		is_not_guest();
+		isAllowedTo('mark_notify');
+
+		$member_info = $user_info;
+	}
 
 	// You have to specify a board to turn notifications on!
 	if (empty($board))
@@ -136,12 +194,18 @@ function BoardNotify()
 			LIMIT 1',
 			array(
 				'current_board' => $board,
-				'current_member' => $user_info['id'],
+				'current_member' => $member_info['id'],
 			)
 		);
 		$context['notification_set'] = $smcFunc['db_num_rows']($request) != 0;
 		$smcFunc['db_free_result']($request);
 
+		if ($member_info['id'] !== $user_info['id'])
+			$context['notify_info'] = array(
+				'u' => $member_info['id'],
+				'token' => $_REQUEST['token'],
+			);
+
 		// Set the template variables...
 		$context['board_href'] = $scripturl . '?board=' . $board . '.' . $_REQUEST['start'];
 		$context['start'] = $_REQUEST['start'];
@@ -153,20 +217,22 @@ function BoardNotify()
 	// Turn the board level notification on....
 	elseif ($_GET['sa'] == 'on')
 	{
-		checkSession('get');
+		if (empty($skipCheckSession))
+			checkSession('get');
 
 		// Turn notification on.  (note this just blows smoke if it's already on.)
 		$smcFunc['db_insert']('ignore',
 			'{db_prefix}log_notify',
 			array('id_member' => 'int', 'id_board' => 'int'),
-			array($user_info['id'], $board),
+			array($member_info['id'], $board),
 			array('id_member', 'id_board')
 		);
 	}
 	// ...or off?
 	else
 	{
-		checkSession('get');
+		if (empty($skipCheckSession))
+			checkSession('get');
 
 		// Turn notification off for this board.
 		$smcFunc['db_query']('', '
@@ -175,13 +241,117 @@ function BoardNotify()
 				AND id_board = {int:current_board}',
 			array(
 				'current_board' => $board,
-				'current_member' => $user_info['id'],
+				'current_member' => $member_info['id'],
 			)
 		);
 	}
 
+	// Probably a guest, so just show a confirmation message.
+	if ($member_info['id'] !== $user_info['id'])
+	{
+		loadTemplate('Notify');
+		$context['page_title'] = $txt['notification'];
+		$context['sub_template'] = 'notify_pref_changed';
+		$context['notify_success_msg'] = sprintf($txt['notifyboard' . ($_GET['sa'] == 'on' ? '_subscribed' : '_unsubscribed')], $member_info['email']);
+		return;
+	}
+
 	// Back to the board!
 	redirectexit('board=' . $board . '.' . $_REQUEST['start']);
 }
 
+function AnnouncementsNotify()
+{
+	global $scripturl, $txt, $board, $user_info, $context, $smcFunc;
+
+	if (isset($_REQUEST['u']) && isset($_REQUEST['token']))
+	{
+		$member_info = getMemberWithToken('announcements');
+		$skipCheckSession = true;
+	}
+	else
+	{
+		is_not_guest();
+		$member_info = $user_info;
+	}
+
+	loadTemplate('Notify');
+	$context['page_title'] = $txt['notification'];
+
+	// Ask what they want to do.
+	if (empty($_GET['sa']))
+	{
+		$context['sub_template'] = 'notify_announcements';
+
+		if ($member_info['id'] !== $user_info['id'])
+			$context['notify_info'] = array(
+				'u' => $member_info['id'],
+				'token' => $_REQUEST['token'],
+			);
+
+		return;
+	}
+
+	// We don't tolerate imposters around here.
+	if (empty($skipCheckSession))
+		checkSession('get');
+
+	// Update their announcement notification preference.
+	updateMemberData($member_info['id'], array('notify_announcements' => $_GET['sa'] == 'on' ? '1' : '0'));
+
+	$context['sub_template'] = 'notify_pref_changed';
+	$context['notify_success_msg'] = sprintf($txt['notifyannouncements' . ($_GET['sa'] == 'on' ? '_subscribed' : '_unsubscribed')], $member_info['email']);
+}
+
+// Verifies the token, then returns some member info
+function getMemberWithToken($type)
+{
+	global $smcFunc, $board, $topic, $modSettings;
+
+	// Keep it sanitary, folks
+	$id_member = !empty($_REQUEST['u']) ? (int) $_REQUEST['u'] : 0;
+
+	// We can't do anything without these
+	if (empty($id_member) || empty($_REQUEST['token']))
+		fatal_lang_error('unsubscribe_invalid', false);
+
+	// Get the user info we need
+	$request = $smcFunc['db_query']('', '
+		SELECT id_member AS id, email_address AS email
+		FROM {db_prefix}members
+		WHERE id_member = {int:id_member}',
+		array(
+			'id_member' => $id_member,
+		)
+	);
+	if ($smcFunc['db_num_rows']($request) == 0)
+		fatal_lang_error('unsubscribe_invalid', false);
+	$member_info = $smcFunc['db_fetch_assoc']($request);
+	$smcFunc['db_free_result']($request);
+
+	// What token are we expecting?
+	$expected_token = createUnsubscribeToken($member_info['id'], $member_info['email'], $type, in_array($type, array('board', 'topic')) && !empty($$type) ? $$type : 0);
+
+	// Don't do anything if the token they gave is wrong
+	if ($_REQUEST['token'] !== $expected_token)
+		fatal_lang_error('unsubscribe_invalid', false);
+
+	// At this point, we know we have a legitimate unsubscribe request
+	return $member_info;
+}
+
+function createUnsubscribeToken($memID, $email, $type = '', $itemID = 0)
+{
+	$token_items = implode(' ', array($memID, $email, $type, $itemID));
+
+	// When the message is public and the key is secret, an HMAC is the appropriate tool.
+	$token = hash_hmac('sha256', $token_items, get_auth_secret(), true);
+
+	// When using an HMAC, 80 bits (10 bytes) is plenty for security.
+	$token = substr($token, 0, 10);
+
+	// Use base64 (with URL-friendly characters) to make the token shorter.
+	return strtr(base64_encode($token), array('+' => '_', '/' => '-', '=' => ''));
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/Packages.php b/Sources/Packages.php
index 047e9c3..b00c33b 100644
--- a/Sources/Packages.php
+++ b/Sources/Packages.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -426,7 +426,7 @@ function PackageInstallTest()
 
 						$context['theme_actions'][$mod_action['is_custom']]['actions'][$actual_filename] = array(
 							'type' => $txt['execute_modification'],
-							'action' => $smcFunc['htmlspecialchars'](strtr($mod_action['filename'], array($boarddir => '.'))),
+							'action' => $smcFunc['htmlspecialchars'](strtr($mod_action['filename'], array(strtr($boarddir, '\\', '/') => '.'))),
 							'description' => $failed ? $txt['package_action_failure'] : $txt['package_action_success'],
 							'failed' => $failed,
 						);
@@ -435,7 +435,7 @@ function PackageInstallTest()
 					{
 						$context['actions'][$actual_filename] = array(
 							'type' => $txt['execute_modification'],
-							'action' => $smcFunc['htmlspecialchars'](strtr($mod_action['filename'], array($boarddir => '.'))),
+							'action' => $smcFunc['htmlspecialchars'](strtr($mod_action['filename'], array(strtr($boarddir, '\\', '/') => '.'))),
 							'description' => $failed ? $txt['package_action_failure'] : $txt['package_action_success'],
 							'failed' => $failed,
 						);
diff --git a/Sources/PersonalMessage.php b/Sources/PersonalMessage.php
index 50df1fe..7be4db6 100644
--- a/Sources/PersonalMessage.php
+++ b/Sources/PersonalMessage.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -715,7 +715,7 @@ function MessageFolder()
 					AND pmr.deleted = {int:is_deleted}
 					' . $labelQuery . ')') . ($context['sort_by'] == 'name' ? ( '
 				LEFT JOIN {db_prefix}members AS mem ON (mem.id_member = {raw:pm_member})') : '') . '
-			WHERE ' . ($context['folder'] == 'sent' ? 'pm.id_member_from = {raw:current_member}
+			WHERE ' . ($context['folder'] == 'sent' ? 'pm.id_member_from = {int:current_member}
 				AND pm.deleted_by_sender = {int:is_deleted}' : '1=1') . (empty($pmsg) ? '' : '
 				AND pm.id_pm = {int:pmsg}') . '
 			ORDER BY ' . ($_GET['sort'] == 'pm.id_pm' && $context['folder'] != 'sent' ? 'pmr.id_pm' : '{raw:sort}') . ($descending ? ' DESC' : ' ASC') . (empty($pmsg) ? '
@@ -936,6 +936,8 @@ function prepareMessageContext($type = 'subject', $reset = false)
 		$_SESSION['pm_selected'] = array();
 	}
 
+	$context['labels'] = !empty($context['labels']) ? (array) $context['labels'] : array();
+
 	// If we're in non-boring view do something exciting!
 	if ($context['display_mode'] != 0 && $subjects_request && $type == 'subject')
 	{
@@ -962,7 +964,7 @@ function prepareMessageContext($type = 'subject', $reset = false)
 			'timestamp' => forum_time(true, $subject['msgtime']),
 			'number_recipients' => count($recipients[$subject['id_pm']]['to']),
 			'labels' => &$context['message_labels'][$subject['id_pm']],
-			'fully_labeled' => count($context['message_labels'][$subject['id_pm']]) == count($context['labels']),
+			'fully_labeled' => (!empty($context['message_labels'][$subject['id_pm']]) ? count($context['message_labels'][$subject['id_pm']]) : 0) == count($context['labels']),
 			'is_replied_to' => &$context['message_replied'][$subject['id_pm']],
 			'is_unread' => &$context['message_unread'][$subject['id_pm']],
 			'is_selected' => !empty($temp_pm_selected) && in_array($subject['id_pm'], $temp_pm_selected),
@@ -1030,7 +1032,7 @@ function prepareMessageContext($type = 'subject', $reset = false)
 		'recipients' => &$recipients[$message['id_pm']],
 		'number_recipients' => count($recipients[$message['id_pm']]['to']),
 		'labels' => &$context['message_labels'][$message['id_pm']],
-		'fully_labeled' => count($context['message_labels'][$message['id_pm']]) == count($context['labels']),
+		'fully_labeled' => (!empty($context['message_labels'][$message['id_pm']]) ? count($context['message_labels'][$message['id_pm']]) : 0) == count($context['labels']),
 		'is_replied_to' => &$context['message_replied'][$message['id_pm']],
 		'is_unread' => &$context['message_unread'][$message['id_pm']],
 		'is_selected' => !empty($temp_pm_selected) && in_array($message['id_pm'], $temp_pm_selected),
@@ -1189,34 +1191,52 @@ function MessageSearch2()
 				unset($possible_users[$k]);
 		}
 
-		// Who matches those criteria?
-		// !!! This doesn't support sent item searching.
-		$request = $smcFunc['db_query']('', '
-			SELECT id_member
-			FROM {db_prefix}members
-			WHERE real_name LIKE {raw:real_name_implode}',
-			array(
-				'real_name_implode' => '\'' . implode('\' OR real_name LIKE \'', $possible_users) . '\'',
-			)
-		);
-		// Simply do nothing if there're too many members matching the criteria.
-		if ($smcFunc['db_num_rows']($request) > $maxMembersToSearch)
-			$userQuery = '';
-		elseif ($smcFunc['db_num_rows']($request) == 0)
+		if (!empty($possible_users))
 		{
-			$userQuery = 'AND pm.id_member_from = 0 AND (pm.from_name LIKE {raw:guest_user_name_implode})';
-			$searchq_parameters['guest_user_name_implode'] = '\'' . implode('\' OR pm.from_name LIKE \'', $possible_users) . '\'';
+			// We need to bring this into the query and do it nice and cleanly.
+			$where_params = array();
+			$where_clause = array();
+			foreach ($possible_users as $k => $v)
+			{
+				$where_params['name_' . $k] = $v;
+				$where_clause[] = '{raw:real_name} LIKE {string:name_' . $k . '}';
+				if (!isset($where_params['real_name']))
+					$where_params['real_name'] = $smcFunc['db_case_sensitive'] ? 'LOWER(real_name)' : 'real_name';
+			}
+
+			// Who matches those criteria?
+			// !!! This doesn't support sent item searching.
+			$request = $smcFunc['db_query']('', '
+				SELECT id_member
+				FROM {db_prefix}members
+				WHERE ' . implode(' OR ', $where_clause),
+				$where_params
+			);
+
+			// Simply do nothing if there're too many members matching the criteria.
+			if ($smcFunc['db_num_rows']($request) > $maxMembersToSearch)
+				$userQuery = '';
+			elseif ($smcFunc['db_num_rows']($request) == 0)
+			{
+				$where_params['real_name'] = 'pm.from_name';
+				$searchq_parameters = array_merge($searchq_parameters, $where_params);
+				$userQuery = 'AND pm.id_member_from = 0 AND (' . implode(' OR ', $where_clause) . ')';
+			}
+			else
+			{
+				$memberlist = array();
+				while ($row = $smcFunc['db_fetch_assoc']($request))
+					$memberlist[] = $row['id_member'];
+
+				$where_params['real_name'] = 'pm.from_name';
+				$searchq_parameters = array_merge($searchq_parameters, $where_params);
+				$searchq_parameters['member_list'] = $memberlist;
+				$userQuery = 'AND (pm.id_member_from IN ({array_int:member_list}) OR (pm.id_member_from = 0 AND (' . implode(' OR ', $where_clause) . ')))';
+			}
+			$smcFunc['db_free_result']($request);
 		}
 		else
-		{
-			$memberlist = array();
-			while ($row = $smcFunc['db_fetch_assoc']($request))
-				$memberlist[] = $row['id_member'];
-			$userQuery = 'AND (pm.id_member_from IN ({array_int:member_list}) OR (pm.id_member_from = 0 AND (pm.from_name LIKE {raw:guest_user_name_implode})))';
-			$searchq_parameters['guest_user_name_implode'] = '\'' . implode('\' OR pm.from_name LIKE \'', $possible_users) . '\'';
-			$searchq_parameters['member_list'] = $memberlist;
-		}
-		$smcFunc['db_free_result']($request);
+			$userQuery = '';
 	}
 
 	// Setup the sorting variables...
@@ -2448,7 +2468,7 @@ function MessageActionsApply()
 				$set = '-1';
 
 			// Check that this string isn't going to be too large for the database.
-			if ($set > 60)
+			if ($smcFunc['strlen']($set) > 60)
 				$updateErrors++;
 			else
 			{
@@ -3210,6 +3230,12 @@ function ManageRules()
 {
 	global $txt, $context, $user_info, $scripturl, $smcFunc;
 
+	// Limit the Criteria and Actions to this.
+	$context['rule_limiters'] = array(
+		'criteria' => 10,
+		'actions' => 10,
+	);
+
 	// The link tree - gotta have this :o
 	$context['linktree'][] = array(
 		'url' => $scripturl . '?action=pm;sa=manrules',
@@ -3253,6 +3279,7 @@ function ManageRules()
 	if (isset($_GET['apply']))
 	{
 		checkSession('get');
+		spamProtection('pm');
 
 		ApplyRules(true);
 		redirectexit('action=pm;sa=manrules');
@@ -3314,6 +3341,7 @@ function ManageRules()
 
 		// Let's do the criteria first - it's also hardest!
 		$criteria = array();
+		$criteriaCount = 0;
 		foreach ($_POST['ruletype'] as $ind => $type)
 		{
 			// Check everything is here...
@@ -3322,6 +3350,10 @@ function ManageRules()
 			elseif ($type != 'bud' && !isset($_POST['ruledef'][$ind]))
 				continue;
 
+			// Too many rules in this rule.
+			if ($criteriaCount++ >= $context['rule_limiters']['criteria'])
+				break;
+
 			// Members need to be found.
 			if ($type == 'mid')
 			{
@@ -3354,12 +3386,17 @@ function ManageRules()
 		$actions = array();
 		$doDelete = 0;
 		$isOr = $_POST['rule_logic'] == 'or' ? 1 : 0;
+		$actionCount = 0;
 		foreach ($_POST['acttype'] as $ind => $type)
 		{
 			// Picking a valid label?
-			if ($type == 'lab' && (!isset($_POST['labdef'][$ind]) || !isset($context['labels'][$_POST['labdef'][$ind] - 1])))
+			if ($type == 'lab' && (!ctype_digit((string) $ind) || !isset($_POST['labdef'][$ind]) || $_POST['labdef'][$ind] == '' || !isset($context['labels'][$_POST['labdef'][$ind] - 1])))
 				continue;
 
+			// Too many actions in this rule.
+			if ($actionCount++ >= $context['rule_limiters']['actions'])
+				break;
+
 			// Record what we're doing.
 			if ($type == 'del')
 				$doDelete = 1;
diff --git a/Sources/Poll.php b/Sources/Poll.php
index 480c022..c0e031f 100644
--- a/Sources/Poll.php
+++ b/Sources/Poll.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -231,12 +231,12 @@ function Vote()
 			FROM {db_prefix}poll_choices
 			WHERE id_poll = {int:id_poll} AND id_choice IN ({array_int:poll_options})',
 			array( 'id_poll' => $row['id_poll'], 'poll_options' => $pollOptions )
-		);	
+		);
 		while ($choice = $smcFunc['db_fetch_assoc']($request))
 		{
 			if ($choice['requires_comment'] == 1)
 				fatal_lang_error('poll_vv_cmt_missing_required', false, array(1+$choice['id_choice'], $choice['label']));
-		}	
+		}
 		$smcFunc['db_free_result']($request);
 	}
 
@@ -265,7 +265,7 @@ function Vote()
 		// Time is stored in case the poll is reset later, plus what they voted for.
 		$_COOKIE['guest_poll_vote'] = empty($_COOKIE['guest_poll_vote']) ? '' : $_COOKIE['guest_poll_vote'];
 		// ;id,timestamp,[vote,vote...]; etc
-		$_COOKIE['guest_poll_vote'] .= ';' . $row['id_poll'] . ',' . time() . ',' . (count($pollOptions) > 1 ? explode(',' . $pollOptions) : $pollOptions[0]);
+		$_COOKIE['guest_poll_vote'] .= ';' . $row['id_poll'] . ',' . time() . ',' . implode(',', $pollOptions);
 
 		// Increase num guest voters count by 1
 		$smcFunc['db_query']('', '
@@ -405,7 +405,7 @@ function EditPoll()
 		$context['poll'] = array(
 			'id' => $pollinfo['id_poll'],
 			'question' => $question,
-			'hide_results' => empty($_POST['poll_hide']) ? 0 : $_POST['poll_hide'],
+			'hide_results' => empty($_POST['poll_hide']) ? 0 : (int) $_POST['poll_hide'],
 			'vvis' => empty($_POST['poll_vvis']) ? 0 : $_POST['poll_vvis'],
 			'vcmt' => empty($_POST['poll_vcmt']) ? 0 : $_POST['poll_vcmt'],
 			'change_vote' => isset($_POST['poll_change_vote']),
@@ -505,7 +505,7 @@ function EditPoll()
 		);
 
 		if ($context['can_moderate_poll'])
-			$context['poll']['expiration'] = $_POST['poll_expire'];
+			$context['poll']['expiration'] = (int) $_POST['poll_expire'];
 
 		// Check the question/option count for errors.
 		if (trim($_POST['question']) == '' && empty($context['poll_error']))
@@ -1013,4 +1013,4 @@ function RemovePoll()
 	redirectexit('topic=' . $topic . '.' . $_REQUEST['start']);
 }
 
-?>
\ No newline at end of file
+?>
diff --git a/Sources/Post.php b/Sources/Post.php
index c113a42..26e125b 100644
--- a/Sources/Post.php
+++ b/Sources/Post.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -244,10 +244,10 @@ function Post()
 		// Set up the poll options.
 		$context['poll_options'] = array(
 			'max_votes' => empty($_POST['poll_max_votes']) ? '1' : max(1, $_POST['poll_max_votes']),
-			'hide' => empty($_POST['poll_hide']) ? 0 : $_POST['poll_hide'],
-			'vvis' => empty($_POST['poll_vvis']) ? 0 : $_POST['poll_vvis'],
-			'vcmt' => empty($_POST['poll_vcmt']) ? 0 : $_POST['poll_vcmt'],
-			'expire' => !isset($_POST['poll_expire']) ? '' : $_POST['poll_expire'],
+			'hide' => empty($_POST['poll_hide']) ? 0 : (int) $_POST['poll_hide'],
+			'vvis' => empty($_POST['poll_vvis']) ? 0 : (int) $_POST['poll_vvis'],
+			'vcmt' => empty($_POST['poll_vcmt']) ? 0 : (int) $_POST['poll_vcmt'],
+			'expire' => !isset($_POST['poll_expire']) ? '' : (int) $_POST['poll_expire'],
 			'change_vote' => isset($_POST['poll_change_vote']),
 			'guest_vote' => isset($_POST['poll_guest_vote']),
 			'guest_vote_enabled' => in_array(-1, $allowedVoteGroups['allowed']),
@@ -453,7 +453,7 @@ function Post()
 				{
 					if (!isset($_REQUEST['email']) || $_REQUEST['email'] == '')
 						$context['post_error']['no_email'] = true;
-					elseif (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $_REQUEST['email']) == 0)
+					elseif (filter_var($_REQUEST['email'], FILTER_VALIDATE_EMAIL) === false)
 						$context['post_error']['bad_email'] = true;
 				}
 			}
@@ -1498,7 +1498,7 @@ function Post2()
 			{
 				if (!allowedTo('moderate_forum') && (!isset($_POST['email']) || $_POST['email'] == ''))
 					$post_errors[] = 'no_email';
-				if (!allowedTo('moderate_forum') && preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $_POST['email']) == 0)
+				if (!allowedTo('moderate_forum') && filter_var($_POST['email'], FILTER_VALIDATE_EMAIL) === false)
 					$post_errors[] = 'bad_email';
 			}
 
@@ -2304,8 +2304,13 @@ function AnnouncementSend()
 				'TOPICSUBJECT' => $context['topic_subject'],
 				'MESSAGE' => $message,
 				'TOPICLINK' => $scripturl . '?topic=' . $topic . '.0',
+				'UNSUBSCRIBELINK' => $scripturl . '?action=notifyannouncements',
 			);
 
+			// Tokens allow people to unsubscribe without logging in
+			if (!empty($modSettings['notify_tokens']))
+				$replacements['UNSUBSCRIBELINK'] .= ';u={UNSUBSCRIBE_ID};token={UNSUBSCRIBE_TOKEN}';
+
 			$emaildata = loadEmailTemplate('new_announcement', $replacements, $cur_language);
 
 			$announcements[$cur_language] = array(
@@ -2322,7 +2327,22 @@ function AnnouncementSend()
 
 	// For each language send a different mail - low priority...
 	foreach ($announcements as $lang => $mail)
-		sendmail($mail['recipients'], $mail['subject'], $mail['body'], null, null, false, 5);
+	{
+		if (!empty($modSettings['notify_tokens']))
+		{
+			foreach ($mail['recipients'] as $member_id => $member_email)
+			{
+				require_once($sourcedir . '/Notify.php');
+				$token = createUnsubscribeToken($member_id, $member_email, 'announcements');
+
+				$body = str_replace(array('{UNSUBSCRIBE_ID}', '{UNSUBSCRIBE_TOKEN}'), array($member_id, $token), $mail['body']);
+
+				sendmail($member_email, $mail['subject'], $body, null, null, false, 5);
+			}
+		}
+		else
+			sendmail($mail['recipients'], $mail['subject'], $mail['body'], null, null, false, 5);
+	}
 
 	$context['percentage_done'] = round(100 * $context['start'] / $modSettings['latestMember'], 1);
 
@@ -2450,6 +2470,15 @@ function notifyMembersBoard(&$topicData)
 			if (!$send_body)
 				unset($replacements['MESSAGE']);
 
+			// Make a token for the unsubscribe link
+			if (!empty($modSettings['notify_tokens']))
+			{
+				require_once($sourcedir . '/Notify.php');
+				$token = createUnsubscribeToken($rowmember['id_member'], $rowmember['email_address'], 'board', $rowmember['id_board']);
+
+				$replacements['UNSUBSCRIBELINK'] .= ';u=' . $rowmember['id_member'] . ';token=' . $token;
+			}
+
 			// Figure out which email to send off
 			$emailtype = '';
 
@@ -2910,4 +2939,4 @@ function strip_html_bbc__preg_callback($matches)
 {
 	return '[html]' . preg_replace('~<br\s?/?' . '>~i', '&lt;br /&gt;<br />', $matches[1]) . '[/html]';
 }
-?>
\ No newline at end of file
+?>
diff --git a/Sources/Profile-Actions.php b/Sources/Profile-Actions.php
index 0366fd4..c7f9aa8 100644
--- a/Sources/Profile-Actions.php
+++ b/Sources/Profile-Actions.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.14
  */
 
 if (!defined('SMF'))
@@ -718,7 +718,7 @@ function subscriptions($memID)
 		$context['gateways'] = array();
 		foreach ($gateways as $id => $gateway)
 		{
-			$fields = $gateways[$id]->fetchGatewayFields($context['sub']['id'] . '+' . $memID, $context['sub'], $context['value'], $period, $scripturl . '?action=profile;u=' . $memID . ';area=subscriptions;sub_id=' . $context['sub']['id'] . ';done');
+			$fields = $gateways[$id]->fetchGatewayFields($context['sub']['id'] . '+' . $memID, $context['sub'], $context['value'], $period, $scripturl . '?action=profile&u=' . $memID . '&area=subscriptions&sub_id=' . $context['sub']['id'] . '&done');
 			if (!empty($fields['form']))
 				$context['gateways'][] = $fields;
 		}
diff --git a/Sources/Profile-Modify.php b/Sources/Profile-Modify.php
index 6d5252a..2b55cf5 100644
--- a/Sources/Profile-Modify.php
+++ b/Sources/Profile-Modify.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -125,7 +125,7 @@ if (!defined('SMF'))
 // This defines every profile field known to man.
 function loadProfileFields($force_reload = false)
 {
-	global $context, $profile_fields, $txt, $scripturl, $modSettings, $user_info, $old_profile, $smcFunc, $cur_profile, $language;
+	global $context, $profile_fields, $txt, $scripturl, $modSettings, $user_info, $old_profile, $smcFunc, $cur_profile, $language, $profile_vars;
 
 	// Don't load this twice!
 	if (!empty($profile_fields) && !$force_reload)
@@ -180,10 +180,11 @@ function loadProfileFields($force_reload = false)
 			'size' => 24,
 			'value' => strtr(empty($cur_profile['aim']) ? '' : $cur_profile['aim'], '+', ' '),
 			'permission' => 'profile_extra',
-			'input_validate' => create_function('&$value', '
-				$value = strtr($value, \' \', \'+\');
+			'input_validate' => function(&$value)
+			{
+				$value = strtr($value, ' ', '+');
 				return true;
-			'),
+			},
 		),
 		'avatar_choice' => array(
 			'type' => 'callback',
@@ -197,56 +198,56 @@ function loadProfileFields($force_reload = false)
 			'type' => 'callback',
 			'callback_func' => 'birthdate',
 			'permission' => 'profile_extra',
-			'preload' => create_function('', '
-				global $cur_profile, $context;
-
+			'preload' => function() use ($cur_profile, &$context)
+			{
 				// Split up the birthdate....
-				list ($uyear, $umonth, $uday) = explode(\'-\', empty($cur_profile[\'birthdate\']) || $cur_profile[\'birthdate\'] == \'0001-01-01\' ? \'0000-00-00\' : $cur_profile[\'birthdate\']);
-				$context[\'member\'][\'birth_date\'] = array(
-					\'year\' => $uyear == \'0004\' ? \'0000\' : $uyear,
-					\'month\' => $umonth,
-					\'day\' => $uday,
+				list ($uyear, $umonth, $uday) = explode('-', empty($cur_profile['birthdate']) || $cur_profile['birthdate'] === '0001-01-01' ? '0000-00-00' : $cur_profile['birthdate']);
+				$context['member']['birth_date'] = array(
+					'year' => $uyear == '0004' ? '0000' : $uyear,
+					'month' => $umonth,
+					'day' => $uday,
 				);
 
 				return true;
-			'),
-			'input_validate' => create_function('&$value', '
-				global $profile_vars, $cur_profile;
+			},
+			'input_validate' => function(&$value)
+			{
+			    global $cur_profile, $profile_vars;
 
-				if (isset($_POST[\'bday2\'], $_POST[\'bday3\']) && $value > 0 && $_POST[\'bday2\'] > 0)
+				if (isset($_POST['bday2'], $_POST['bday3']) && $value > 0 && $_POST['bday2'] > 0)
 				{
 					// Set to blank?
-					if ((int) $_POST[\'bday3\'] == 1 && (int) $_POST[\'bday2\'] == 1 && (int) $value == 1)
-						$value = \'0001-01-01\';
+					if ((int) $_POST['bday3'] == 1 && (int) $_POST['bday2'] == 1 && (int) $value == 1)
+						$value = '0001-01-01';
 					else
-						$value = checkdate($value, $_POST[\'bday2\'], $_POST[\'bday3\'] < 4 ? 4 : $_POST[\'bday3\']) ? sprintf(\'%04d-%02d-%02d\', $_POST[\'bday3\'] < 4 ? 4 : $_POST[\'bday3\'], $_POST[\'bday1\'], $_POST[\'bday2\']) : \'0001-01-01\';
+						$value = checkdate($value, $_POST['bday2'], $_POST['bday3'] < 4 ? 4 : $_POST['bday3']) ? sprintf('%04d-%02d-%02d', $_POST['bday3'] < 4 ? 4 : $_POST['bday3'], $_POST['bday1'], $_POST['bday2']) : '0001-01-01';
 				}
 				else
-					$value = \'0001-01-01\';
+					$value = '0001-01-01';
 
-				$profile_vars[\'birthdate\'] = $value;
-				$cur_profile[\'birthdate\'] = $value;
+				$profile_vars['birthdate'] = $value;
+				$cur_profile['birthdate'] = $value;
 				return false;
-			'),
+			},
 		),
 		// Setting the birthdate the old style way?
 		'birthdate' => array(
 			'type' => 'hidden',
 			'permission' => 'profile_extra',
-			'input_validate' => create_function('&$value', '
-				global $cur_profile;
-				// !!! Should we check for this year and tell them they made a mistake :P? (based on coppa at least?)
-				if (preg_match(\'/(\d{4})[\-\., ](\d{2})[\-\., ](\d{2})/\', $value, $dates) === 1)
+			'input_validate' => function(&$value) use ($cur_profile)
+			{
+				// @todo Should we check for this year and tell them they made a mistake :P? (based on coppa at least?)
+				if (preg_match('/(\d{4})[\-\., ](\d{2})[\-\., ](\d{2})/', $value, $dates) === 1)
 				{
-					$value = checkdate($dates[2], $dates[3], $dates[1] < 4 ? 4 : $dates[1]) ? sprintf(\'%04d-%02d-%02d\', $dates[1] < 4 ? 4 : $dates[1], $dates[2], $dates[3]) : \'0001-01-01\';
+					$value = checkdate($dates[2], $dates[3], $dates[1] < 4 ? 4 : $dates[1]) ? sprintf('%04d-%02d-%02d', $dates[1] < 4 ? 4 : $dates[1], $dates[2], $dates[3]) : '0001-01-01';
 					return true;
 				}
 				else
 				{
-					$value = empty($cur_profile[\'birthdate\']) ? \'0001-01-01\' : $cur_profile[\'birthdate\'];
+					$value = empty($cur_profile['birthdate']) ? '0001-01-01' : $cur_profile['birthdate'];
 					return false;
 				}
-			'),
+			},
 		),
 		'date_registered' => array(
 			'type' => 'text',
@@ -254,23 +255,24 @@ function loadProfileFields($force_reload = false)
 			'label' => $txt['date_registered'],
 			'log_change' => true,
 			'permission' => 'moderate_forum',
-			'input_validate' => create_function('&$value', '
-				global $txt, $user_info, $modSettings, $cur_profile, $context;
-
+			'input_validate' => function(&$value) use ($txt, $user_info, $modSettings, $cur_profile, $context)
+			{
 				// Bad date!  Go try again - please?
-				if (($value = strtotime($value)) === -1)
+				if (($value = strtotime($value)) === false)
 				{
-					$value = $cur_profile[\'date_registered\'];
-					return $txt[\'invalid_registration\'] . \' \' . strftime(\'%d %b %Y \' . (strpos($user_info[\'time_format\'], \'%H\') !== false ? \'%I:%M:%S %p\' : \'%H:%M:%S\'), forum_time(false));
+					$value = $cur_profile['date_registered'];
+					return $txt['invalid_registration'] . ' ' . strftime('%d %b %Y ' . (strpos($user_info['time_format'], '%H') !== false ? '%I:%M:%S %p' : '%H:%M:%S'), forum_time(false));
 				}
-				// As long as it doesn\'t equal "N/A"...
-				elseif ($value != $txt[\'not_applicable\'] && $value != strtotime(strftime(\'%Y-%m-%d\', $cur_profile[\'date_registered\'] + ($user_info[\'time_offset\'] + $modSettings[\'time_offset\']) * 3600)))
-					$value = $value - ($user_info[\'time_offset\'] + $modSettings[\'time_offset\']) * 3600;
+
+				// As long as it doesn't equal "N/A"...
+				elseif ($value != $txt['not_applicable'] && $value != strtotime(strftime('%Y-%m-%d', $cur_profile['date_registered'] + ($user_info['time_offset'] + $modSettings['time_offset']) * 3600)))
+					$value = $value - ($user_info['time_offset'] + $modSettings['time_offset']) * 3600;
+
 				else
-					$value = $cur_profile[\'date_registered\'];
+					$value = $cur_profile['date_registered'];
 
 				return true;
-			'),
+			},
 		),
 		'email_address' => array(
 			'type' => 'text',
@@ -278,26 +280,27 @@ function loadProfileFields($force_reload = false)
 			'subtext' => $txt['valid_email'],
 			'log_change' => true,
 			'permission' => 'profile_identity',
-			'input_validate' => create_function('&$value', '
-				global $context, $old_profile, $context, $profile_vars, $sourcedir, $modSettings;
+			'input_validate' => function(&$value)
+			{
+				global $context, $old_profile, $profile_vars, $sourcedir, $modSettings;
 
-				if (strtolower($value) == strtolower($old_profile[\'email_address\']))
+				if (strtolower($value) == strtolower($old_profile['email_address']))
 					return false;
 
-				$isValid = profileValidateEmail($value, $context[\'id_member\']);
+				$isValid = profileValidateEmail($value, $context['id_member']);
 
 				// Do they need to revalidate? If so schedule the function!
-				if ($isValid === true && !empty($modSettings[\'send_validation_onChange\']) && !allowedTo(\'moderate_forum\'))
+				if ($isValid === true && !empty($modSettings['send_validation_onChange']) && !allowedTo('moderate_forum'))
 				{
-					require_once($sourcedir . \'/Subs-Members.php\');
-					$profile_vars[\'validation_code\'] = generateValidationCode();
-					$profile_vars[\'is_activated\'] = 2;
-					$context[\'profile_execute_on_save\'][] = \'profileSendActivation\';
-					unset($context[\'profile_execute_on_save\'][\'reload_user\']);
+					require_once($sourcedir . '/Subs-Members.php');
+					$profile_vars['validation_code'] = generateValidationCode();
+					$profile_vars['is_activated'] = 2;
+					$context['profile_execute_on_save'][] = 'profileSendActivation';
+					unset($context['profile_execute_on_save']['reload_user']);
 				}
 
 				return $isValid;
-			'),
+			},
 		),
 		'gender' => array(
 			'type' => 'select',
@@ -311,11 +314,12 @@ function loadProfileFields($force_reload = false)
 			'value' => empty($cur_profile['hide_email']) ? true : false,
 			'label' => $txt['allow_user_email'],
 			'permission' => 'profile_identity',
-			'input_validate' => create_function('&$value', '
+			'input_validate' => function(&$value)
+			{
 				$value = $value == 0 ? 1 : 0;
 
 				return true;
-			'),
+			},
 		),
 		'icq' => array(
 			'type' => 'text',
@@ -324,13 +328,14 @@ function loadProfileFields($force_reload = false)
 			'size' => 24,
 			'permission' => 'profile_extra',
 			// Need to make sure ICQ doesn't equal 0.
-			'input_validate' => create_function('&$value', '
+			'input_validate' => function(&$value)
+			{
 				if (empty($value))
-					$value = \'\';
+					$value = '';
 				else
 					$value = (int) $value;
 				return true;
-			'),
+			},
 		),
 		// Selecting group membership is a complicated one so we treat it separate!
 		'id_group' => array(
@@ -346,57 +351,59 @@ function loadProfileFields($force_reload = false)
 			'callback_func' => 'theme_pick',
 			'permission' => 'profile_extra',
 			'enabled' => $modSettings['theme_allow'] || allowedTo('admin_forum'),
-			'preload' => create_function('', '
-				global $smcFunc, $context, $cur_profile, $txt;
-
-				$request = $smcFunc[\'db_query\'](\'\', \'
+			'preload' => function() use ($smcFunc, &$context, $cur_profile, $txt)
+			{
+				$request = $smcFunc['db_query']('', '
 					SELECT value
 					FROM {db_prefix}themes
 					WHERE id_theme = {int:id_theme}
 						AND variable = {string:variable}
-					LIMIT 1\', array(
-						\'id_theme\' => $cur_profile[\'id_theme\'],
-						\'variable\' => \'name\',
+					LIMIT 1', array(
+						'id_theme' => $cur_profile['id_theme'],
+						'variable' => 'name',
 					)
 				);
-				list ($name) = $smcFunc[\'db_fetch_row\']($request);
-				$smcFunc[\'db_free_result\']($request);
+				list ($name) = $smcFunc['db_fetch_row']($request);
+				$smcFunc['db_free_result']($request);
 
-				$context[\'member\'][\'theme\'] = array(
-					\'id\' => $cur_profile[\'id_theme\'],
-					\'name\' => empty($cur_profile[\'id_theme\']) ? $txt[\'theme_forum_default\'] : $name
+				$context['member']['theme'] = array(
+					'id' => $cur_profile['id_theme'],
+					'name' => empty($cur_profile['id_theme']) ? $txt['theme_forum_default'] : $name
 				);
 				return true;
-			'),
-			'input_validate' => create_function('&$value', '
+			},
+			'input_validate' => function(&$value)
+			{
 				$value = (int) $value;
 				return true;
-			'),
+			},
 		),
 		'karma_good' => array(
 			'type' => 'callback',
 			'callback_func' => 'karma_modify',
 			'permission' => 'admin_forum',
 			// Set karma_bad too!
-			'input_validate' => create_function('&$value', '
+			'input_validate' => function(&$value)
+			{
 				global $profile_vars, $cur_profile;
 
 				$value = (int) $value;
-				if (isset($_POST[\'karma_bad\']))
+				if (isset($_POST['karma_bad']))
 				{
-					$profile_vars[\'karma_bad\'] = $_POST[\'karma_bad\'] != \'\' ? (int) $_POST[\'karma_bad\'] : 0;
-					$cur_profile[\'karma_bad\'] = $_POST[\'karma_bad\'] != \'\' ? (int) $_POST[\'karma_bad\'] : 0;
+					$profile_vars['karma_bad'] = $_POST['karma_bad'] != '' ? (int) $_POST['karma_bad'] : 0;
+					$cur_profile['karma_bad'] = $_POST['karma_bad'] != '' ? (int) $_POST['karma_bad'] : 0;
 				}
 				return true;
-			'),
-			'preload' => create_function('', '
+			},
+			'preload' => function()
+			{
 				global $context, $cur_profile;
 
-				$context[\'member\'][\'karma\'][\'good\'] = $cur_profile[\'karma_good\'];
-				$context[\'member\'][\'karma\'][\'bad\'] = $cur_profile[\'karma_bad\'];
+				$context['member']['karma']['good'] = $cur_profile['karma_good'];
+				$context['member']['karma']['bad'] = $cur_profile['karma_bad'];
 
 				return true;
-			'),
+			},
 			'enabled' => !empty($modSettings['karmaMode']),
 		),
 		'lngfile' => array(
@@ -407,24 +414,23 @@ function loadProfileFields($force_reload = false)
 			'preload' => 'profileLoadLanguages',
 			'enabled' => !empty($modSettings['userLanguage']),
 			'value' => empty($cur_profile['lngfile']) ? $language : $cur_profile['lngfile'],
-			'input_validate' => create_function('&$value', '
-				global $context, $cur_profile;
-
+			'input_validate' => function(&$value) use (&$context, $cur_profile)
+			{
 				// Load the languages.
 				profileLoadLanguages();
 
-				if (isset($context[\'profile_languages\'][$value]))
+				if (isset($context['profile_languages'][$value]))
 				{
-					if ($context[\'user\'][\'is_owner\'] && empty($context[\'password_auth_failed\']))
-						$_SESSION[\'language\'] = $value;
+					if ($context['user']['is_owner'] && empty($context['password_auth_failed']))
+						$_SESSION['language'] = $value;
 					return true;
 				}
 				else
 				{
-					$value = $cur_profile[\'lngfile\'];
+					$value = $cur_profile['lngfile'];
 					return false;
 				}
-			'),
+			},
 		),
 		'location' => array(
 			'type' => 'text',
@@ -441,30 +447,31 @@ function loadProfileFields($force_reload = false)
 			'log_change' => true,
 			'permission' => 'profile_identity',
 			'prehtml' => allowedTo('admin_forum') && isset($_GET['changeusername']) ? '<div class="alert">' . $txt['username_warning'] . '</div>' : '',
-			'input_validate' => create_function('&$value', '
+			'input_validate' => function(&$value)
+			{
 				global $sourcedir, $context, $user_info, $cur_profile;
 
-				if (allowedTo(\'admin_forum\'))
+				if (allowedTo('admin_forum'))
 				{
 					// We\'ll need this...
-					require_once($sourcedir . \'/Subs-Auth.php\');
+					require_once($sourcedir . '/Subs-Auth.php');
 
 					// Maybe they are trying to change their password as well?
 					$resetPassword = true;
-					if (isset($_POST[\'passwrd1\']) && $_POST[\'passwrd1\'] != \'\' && isset($_POST[\'passwrd2\']) && $_POST[\'passwrd1\'] == $_POST[\'passwrd2\'] && validatePassword($_POST[\'passwrd1\'], $value, array($cur_profile[\'real_name\'], $user_info[\'username\'], $user_info[\'name\'], $user_info[\'email\'])) == null)
+					if (isset($_POST['passwrd1']) && $_POST['passwrd1'] != '' && isset($_POST['passwrd2']) && $_POST['passwrd1'] == $_POST['passwrd2'] && validatePassword($_POST['passwrd1'], $value, array($cur_profile['real_name'], $user_info['username'], $user_info['name'], $user_info['email'])) == null)
 						$resetPassword = false;
 
 					// Do the reset... this will send them an email too.
 					if ($resetPassword)
-						resetPassword($context[\'id_member\'], $value);
+						resetPassword($context['id_member'], $value);
 					elseif ($value !== null)
 					{
-						validateUsername($context[\'id_member\'], trim(preg_replace(\'~[\t\n\r \x0B\0\' . ($context[\'utf8\'] ? ($context[\'server\'][\'complex_preg_chars\'] ? \'\x{A0}\x{AD}\x{2000}-\x{200F}\x{201F}\x{202F}\x{3000}\x{FEFF}\' : "\xC2\xA0\xC2\xAD\xE2\x80\x80-\xE2\x80\x8F\xE2\x80\x9F\xE2\x80\xAF\xE2\x80\x9F\xE3\x80\x80\xEF\xBB\xBF") : \'\x00-\x08\x0B\x0C\x0E-\x19\xA0\') . \']+~\' . ($context[\'utf8\'] ? \'u\' : \'\'), \' \', $value)));
-						updateMemberData($context[\'id_member\'], array(\'member_name\' => $value));
+						validateUsername($context['id_member'], trim(preg_replace('~[\t\n\r \x0B\0' . ($context['utf8'] ? ($context['server']['complex_preg_chars'] ? '\x{A0}\x{AD}\x{2000}-\x{200F}\x{201F}\x{202F}\x{3000}\x{FEFF}' : "\xC2\xA0\xC2\xAD\xE2\x80\x80-\xE2\x80\x8F\xE2\x80\x9F\xE2\x80\xAF\xE2\x80\x9F\xE3\x80\x80\xEF\xBB\xBF") : '\x00-\x08\x0B\x0C\x0E-\x19\xA0') . ']+~' . ($context['utf8'] ? 'u' : ''), ' ', $value)));
+						updateMemberData($context['id_member'], array('member_name' => $value));
 					}
 				}
 				return false;
-			'),
+			},
 		),
 		'msn' => array(
 			'type' => 'text',
@@ -472,16 +479,17 @@ function loadProfileFields($force_reload = false)
 			'subtext' => $txt['msn_email_address'],
 			'size' => 24,
 			'permission' => 'profile_extra',
-			'input_validate' => create_function('&$value', '
+			'input_validate' => function(&$value)
+			{
 				global $cur_profile;
 				// Make sure the msn one is an email address, not something like \'none\' :P.
-				if ($value != \'\' && preg_match(\'~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\\\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~\', $value) == 0)
+				if ($value != '' && preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\\\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $value) == 0)
 				{
-					$value = $cur_profile[\'msn\'];
+					$value = $cur_profile['msn'];
 					return false;
 				}
 				return true;
-			'),
+			},
 		),
 		'passwrd1' => array(
 			'type' => 'password',
@@ -493,29 +501,30 @@ function loadProfileFields($force_reload = false)
 			'permission' => 'profile_identity',
 			'save_key' => 'passwd',
 			// Note this will only work if passwrd2 also exists!
-			'input_validate' => create_function('&$value', '
+			'input_validate' => function(&$value)
+			{
 				global $sourcedir, $user_info, $smcFunc, $cur_profile;
 
 				// If we didn\'t try it then ignore it!
-				if ($value == \'\')
+				if ($value == '')
 					return false;
 
 				// Do the two entries for the password even match?
-				if (!isset($_POST[\'passwrd2\']) || $value != $_POST[\'passwrd2\'])
-					return \'bad_new_password\';
+				if (!isset($_POST['passwrd2']) || $value != $_POST['passwrd2'])
+					return 'bad_new_password';
 
 				// Let\'s get the validation function into play...
-				require_once($sourcedir . \'/Subs-Auth.php\');
-				$passwordErrors = validatePassword($value, $cur_profile[\'member_name\'], array($cur_profile[\'real_name\'], $user_info[\'username\'], $user_info[\'name\'], $user_info[\'email\']));
+				require_once($sourcedir . '/Subs-Auth.php');
+				$passwordErrors = validatePassword($value, $cur_profile['member_name'], array($cur_profile['real_name'], $user_info['username'], $user_info['name'], $user_info['email']));
 
 				// Were there errors?
 				if ($passwordErrors != null)
-					return \'password_\' . $passwordErrors;
+					return 'password_' . $passwordErrors;
 
 				// Set up the new password variable... ready for storage.
-				$value = sha1(strtolower($cur_profile[\'member_name\']) . un_htmlspecialchars($value));
+				$value = sha1(strtolower($cur_profile['member_name']) . un_htmlspecialchars($value));
 				return true;
-			'),
+			},
 		),
 		'passwrd2' => array(
 			'type' => 'password',
@@ -539,26 +548,28 @@ function loadProfileFields($force_reload = false)
 			'type' => 'callback',
 			'callback_func' => 'pm_settings',
 			'permission' => 'pm_read',
-			'preload' => create_function('', '
+			'preload' => function()
+			{
 				global $context, $cur_profile;
 
-				$context[\'display_mode\'] = $cur_profile[\'pm_prefs\'] & 3;
-				$context[\'send_email\'] = $cur_profile[\'pm_email_notify\'];
-				$context[\'receive_from\'] = !empty($cur_profile[\'pm_receive_from\']) ? $cur_profile[\'pm_receive_from\'] : 0;
+				$context['display_mode'] = $cur_profile['pm_prefs'] & 3;
+				$context['send_email'] = $cur_profile['pm_email_notify'];
+				$context['receive_from'] = !empty($cur_profile['pm_receive_from']) ? $cur_profile['pm_receive_from'] : 0;
 
 				return true;
-			'),
-			'input_validate' => create_function('&$value', '
+			},
+			'input_validate' => function(&$value)
+			{
 				global $cur_profile, $profile_vars;
 
 				// Simple validate and apply the two "sub settings"
 				$value = max(min($value, 2), 0);
 
-				$cur_profile[\'pm_email_notify\'] = $profile_vars[\'pm_email_notify\'] = max(min((int) $_POST[\'pm_email_notify\'], 2), 0);
-				$cur_profile[\'pm_receive_from\'] = $profile_vars[\'pm_receive_from\'] = max(min((int) $_POST[\'pm_receive_from\'], 4), 0);
+				$cur_profile['pm_email_notify'] = $profile_vars['pm_email_notify'] = max(min((int) $_POST['pm_email_notify'], 2), 0);
+				$cur_profile['pm_receive_from'] = $profile_vars['pm_receive_from'] = max(min((int) $_POST['pm_receive_from'], 4), 0);
 
 				return true;
-			'),
+			},
 		),
 		'posts' => array(
 			'type' => 'int',
@@ -566,10 +577,11 @@ function loadProfileFields($force_reload = false)
 			'log_change' => true,
 			'size' => 7,
 			'permission' => 'moderate_forum',
-			'input_validate' => create_function('&$value', '
-				$value = $value != \'\' ? strtr($value, array(\',\' => \'\', \'.\' => \'\', \' \' => \'\')) : 0;
+			'input_validate' => function(&$value)
+			{
+				$value = $value != '' ? strtr($value, array(',' => '', '.' => '', ' ' => '')) : 0;
 				return true;
-			'),
+			},
 		),
 		'real_name' => array(
 			'type' => !empty($modSettings['allow_editDisplayName']) || allowedTo('moderate_forum') ? 'text' : 'label',
@@ -579,23 +591,24 @@ function loadProfileFields($force_reload = false)
 			'input_attr' => array('maxlength="60"'),
 			'permission' => 'profile_identity',
 			'enabled' => !empty($modSettings['allow_editDisplayName']) || allowedTo('moderate_forum'),
-			'input_validate' => create_function('&$value', '
+			'input_validate' => function(&$value)
+			{
 				global $context, $smcFunc, $sourcedir, $cur_profile;
 
-				$value = trim(preg_replace(\'~[\t\n\r \x0B\0\' . ($context[\'utf8\'] ? ($context[\'server\'][\'complex_preg_chars\'] ? \'\x{A0}\x{AD}\x{2000}-\x{200F}\x{201F}\x{202F}\x{3000}\x{FEFF}\' : "\xC2\xA0\xC2\xAD\xE2\x80\x80-\xE2\x80\x8F\xE2\x80\x9F\xE2\x80\xAF\xE2\x80\x9F\xE3\x80\x80\xEF\xBB\xBF") : \'\x00-\x08\x0B\x0C\x0E-\x19\xA0\') . \']+~\' . ($context[\'utf8\'] ? \'u\' : \'\'), \' \', $value));
+				$value = trim(preg_replace('~[\t\n\r \x0B\0' . ($context['utf8'] ? ($context['server']['complex_preg_chars'] ? '\x{A0}\x{AD}\x{2000}-\x{200F}\x{201F}\x{202F}\x{3000}\x{FEFF}' : "\xC2\xA0\xC2\xAD\xE2\x80\x80-\xE2\x80\x8F\xE2\x80\x9F\xE2\x80\xAF\xE2\x80\x9F\xE3\x80\x80\xEF\xBB\xBF") : '\x00-\x08\x0B\x0C\x0E-\x19\xA0') . ']+~' . ($context['utf8'] ? 'u' : ''), ' ', $value));
 
-				if (trim($value) == \'\')
-					return \'no_name\';
-				elseif ($smcFunc[\'strlen\']($value) > 60)
-					return \'name_too_long\';
-				elseif ($cur_profile[\'real_name\'] != $value)
+				if (trim($value) == '')
+					return 'no_name';
+				elseif ($smcFunc['strlen']($value) > 60)
+					return 'name_too_long';
+				elseif ($cur_profile['real_name'] != $value)
 				{
-					require_once($sourcedir . \'/Subs-Members.php\');
-					if (isReservedName($value, $context[\'id_member\']))
-						return \'name_taken\';
+					require_once($sourcedir . '/Subs-Members.php');
+					if (isReservedName($value, $context['id_member']))
+						return 'name_taken';
 				}
 				return true;
-			'),
+			},
 		),
 		'secret_question' => array(
 			'type' => 'text',
@@ -612,10 +625,11 @@ function loadProfileFields($force_reload = false)
 			'postinput' => '<span class="smalltext" style="margin-left: 4ex;"><a href="' . $scripturl . '?action=helpadmin;help=secret_why_blank" onclick="return reqWin(this.href);">' . $txt['secret_why_blank'] . '</a></span>',
 			'value' => '',
 			'permission' => 'profile_identity',
-			'input_validate' => create_function('&$value', '
-				$value = $value != \'\' ? md5($value) : \'\';
+			'input_validate' => function(&$value)
+			{
+				$value = $value != '' ? md5($value) : '';
 				return true;
-			'),
+			},
 		),
 		'signature' => array(
 			'type' => 'callback',
@@ -636,33 +650,35 @@ function loadProfileFields($force_reload = false)
 			'callback_func' => 'smiley_pick',
 			'enabled' => !empty($modSettings['smiley_sets_enable']),
 			'permission' => 'profile_extra',
-			'preload' => create_function('', '
+			'preload' => function()
+			{
 				global $modSettings, $context, $txt, $cur_profile;
 
-				$context[\'member\'][\'smiley_set\'][\'id\'] = empty($cur_profile[\'smiley_set\']) ? \'\' : $cur_profile[\'smiley_set\'];
-				$context[\'smiley_sets\'] = explode(\',\', \'none,,\' . $modSettings[\'smiley_sets_known\']);
-				$set_names = explode("\n", $txt[\'smileys_none\'] . "\n" . $txt[\'smileys_forum_board_default\'] . "\n" . $modSettings[\'smiley_sets_names\']);
-				foreach ($context[\'smiley_sets\'] as $i => $set)
+				$context['member']['smiley_set']['id'] = empty($cur_profile['smiley_set']) ? '' : $cur_profile['smiley_set'];
+				$context['smiley_sets'] = explode(',', 'none,,' . $modSettings['smiley_sets_known']);
+				$set_names = explode("\n", $txt['smileys_none'] . "\n" . $txt['smileys_forum_board_default'] . "\n" . $modSettings['smiley_sets_names']);
+				foreach ($context['smiley_sets'] as $i => $set)
 				{
-					$context[\'smiley_sets\'][$i] = array(
-						\'id\' => htmlspecialchars($set),
-						\'name\' => htmlspecialchars($set_names[$i]),
-						\'selected\' => $set == $context[\'member\'][\'smiley_set\'][\'id\']
+					$context['smiley_sets'][$i] = array(
+						'id' => htmlspecialchars($set),
+						'name' => htmlspecialchars($set_names[$i]),
+						'selected' => $set == $context['member']['smiley_set']['id']
 					);
 
-					if ($context[\'smiley_sets\'][$i][\'selected\'])
-						$context[\'member\'][\'smiley_set\'][\'name\'] = $set_names[$i];
+					if ($context['smiley_sets'][$i]['selected'])
+						$context['member']['smiley_set']['name'] = $set_names[$i];
 				}
 				return true;
-			'),
-			'input_validate' => create_function('&$value', '
+			},
+			'input_validate' => function(&$value)
+			{
 				global $modSettings;
 
-				$smiley_sets = explode(\',\', $modSettings[\'smiley_sets_known\']);
-				if (!in_array($value, $smiley_sets) && $value != \'none\')
-					$value = \'\';
+				$smiley_sets = explode(',', $modSettings['smiley_sets_known']);
+				if (!in_array($value, $smiley_sets) && $value != 'none')
+					$value = '';
 				return true;
-			'),
+			},
 		),
 		// Pretty much a dummy entry - it populates all the theme settings.
 		'theme_settings' => array(
@@ -670,52 +686,54 @@ function loadProfileFields($force_reload = false)
 			'callback_func' => 'theme_settings',
 			'permission' => 'profile_extra',
 			'is_dummy' => true,
-			'preload' => create_function('', '
-				loadLanguage(\'Settings\');
+			'preload' => function()
+			{
+				loadLanguage('Settings');
 				return true;
-			'),
+			},
 		),
 		'time_format' => array(
 			'type' => 'callback',
 			'callback_func' => 'timeformat_modify',
 			'permission' => 'profile_extra',
-			'preload' => create_function('', '
-				global $context, $user_info, $txt, $cur_profile, $modSettings;
-
-				$context[\'easy_timeformats\'] = array(
-					array(\'format\' => \'\', \'title\' => $txt[\'timeformat_default\']),
-					array(\'format\' => \'%B %d, %Y, %I:%M:%S %p\', \'title\' => $txt[\'timeformat_easy1\']),
-					array(\'format\' => \'%B %d, %Y, %H:%M:%S\', \'title\' => $txt[\'timeformat_easy2\']),
-					array(\'format\' => \'%Y-%m-%d, %H:%M:%S\', \'title\' => $txt[\'timeformat_easy3\']),
-					array(\'format\' => \'%d %B %Y, %H:%M:%S\', \'title\' => $txt[\'timeformat_easy4\']),
-					array(\'format\' => \'%d-%m-%Y, %H:%M:%S\', \'title\' => $txt[\'timeformat_easy5\'])
+			'preload' => function() use (&$context, $user_info, $txt, $cur_profile, $modSettings)
+			{
+				$context['easy_timeformats'] = array(
+					array('format' => '', 'title' => $txt['timeformat_default']),
+					array('format' => '%B %d, %Y, %I:%M:%S %p', 'title' => $txt['timeformat_easy1']),
+					array('format' => '%B %d, %Y, %H:%M:%S', 'title' => $txt['timeformat_easy2']),
+					array('format' => '%Y-%m-%d, %H:%M:%S', 'title' => $txt['timeformat_easy3']),
+					array('format' => '%d %B %Y, %H:%M:%S', 'title' => $txt['timeformat_easy4']),
+					array('format' => '%d-%m-%Y, %H:%M:%S', 'title' => $txt['timeformat_easy5'])
 				);
 
-				$context[\'member\'][\'time_format\'] = $cur_profile[\'time_format\'];
-				$context[\'current_forum_time\'] = timeformat(time() - $user_info[\'time_offset\'] * 3600, false);
-				$context[\'current_forum_time_js\'] = strftime(\'%Y,\' . ((int) strftime(\'%m\', time() + $modSettings[\'time_offset\'] * 3600) - 1) . \',%d,%H,%M,%S\', time() + $modSettings[\'time_offset\'] * 3600);
-				$context[\'current_forum_time_hour\'] = (int) strftime(\'%H\', forum_time(false));
+				$context['member']['time_format'] = $cur_profile['time_format'];
+				$context['current_forum_time'] = timeformat(time() - $user_info['time_offset'] * 3600, false);
+				$context['current_forum_time_js'] = strftime('%Y,' . ((int) strftime('%m', time() + $modSettings['time_offset'] * 3600) - 1) . ',%d,%H,%M,%S', time() + $modSettings['time_offset'] * 3600);
+				$context['current_forum_time_hour'] = (int) strftime('%H', forum_time(false));
 				return true;
-			'),
+			},
 		),
 		'time_offset' => array(
 			'type' => 'callback',
 			'callback_func' => 'timeoffset_modify',
 			'permission' => 'profile_extra',
-			'preload' => create_function('', '
+			'preload' => function()
+			{
 				global $context, $cur_profile;
-				$context[\'member\'][\'time_offset\'] = $cur_profile[\'time_offset\'];
+				$context['member']['time_offset'] = $cur_profile['time_offset'];
 				return true;
-			'),
-			'input_validate' => create_function('&$value', '
+			},
+			'input_validate' => function(&$value)
+			{
 				// Validate the time_offset...
-				$value = (float) strtr($value, \',\', \'.\');
+				$value = (float) strtr($value, ',', '.');
 
 				if ($value < -23.5 || $value > 23.5)
-					return \'bad_offset\';
+					return 'bad_offset';
 
 				return true;
-			'),
+			},
 		),
 		'usertitle' => array(
 			'type' => 'text',
@@ -740,14 +758,14 @@ function loadProfileFields($force_reload = false)
 			'size' => 50,
 			'permission' => 'profile_extra',
 			// Fix the URL...
-			'input_validate' => create_function('&$value', '
-
-				if (strlen(trim($value)) > 0 && strpos($value, \'://\') === false)
-					$value = \'http://\' . $value;
-				if (strlen($value) < 8 || (substr($value, 0, 7) !== \'http://\' && substr($value, 0, 8) !== \'https://\'))
-					$value = \'\';
+			'input_validate' => function(&$value)
+			{
+				if (strlen(trim($value)) > 0 && strpos($value, '://') === false)
+					$value = 'http://' . $value;
+				if (strlen($value) < 8 || (substr($value, 0, 7) !== 'http://' && substr($value, 0, 8) !== 'https://'))
+					$value = '';
 				return true;
-			'),
+			},
 			'link_with' => 'website',
 		),
 		'yim' => array(
@@ -1290,7 +1308,7 @@ function makeCustomFieldChanges($memID, $area, $sanitize = true)
 			if ($row['field_type'] == 'text' && !empty($row['mask']) && $row['mask'] != 'none')
 			{
 				//!!! We never error on this - just ignore it at the moment...
-				if ($row['mask'] == 'email' && (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $value) === 0 || strlen($value) > 255))
+				if ($row['mask'] == 'email' && (filter_var($value, FILTER_VALIDATE_EMAIL) === false || strlen($value) > 255))
 					$value = '';
 				elseif ($row['mask'] == 'number')
 				{
@@ -1855,16 +1873,15 @@ function notification($memID)
 					'class' => 'lefttext first_th',
 				),
 				'data' => array(
-					'function' => create_function('$board', '
-						global $settings, $txt;
-
-						$link = $board[\'link\'];
+					'function' => function($board) use ($settings, $txt)
+					{
+						$link = $board['link'];
 
-						if ($board[\'new\'])
-							$link .= \' <a href="\' . $board[\'href\'] . \'"><img src="\' . $settings[\'lang_images_url\'] . \'/new.gif" alt="\' . $txt[\'new\'] . \'" /></a>\';
+						if ($board['new'])
+							$link .= ' <a href="' . $board['href'] . '"><img src="' . $settings['lang_images_url'] . '/new.gif" alt="' . $txt['new'] . '" /></a>';
 
 						return $link;
-					'),
+					},
 				),
 				'sort' => array(
 					'default' => 'name',
@@ -1937,18 +1954,17 @@ function notification($memID)
 					'class' => 'lefttext first_th',
 				),
 				'data' => array(
-					'function' => create_function('$topic', '
-						global $settings, $txt;
-
-						$link = $topic[\'link\'];
+					'function' => function($topic) use ($settings, $txt)
+					{
+						$link = $topic['link'];
 
-						if ($topic[\'new\'])
-							$link .= \' <a href="\' . $topic[\'new_href\'] . \'"><img src="\' . $settings[\'lang_images_url\'] . \'/new.gif" alt="\' . $txt[\'new\'] . \'" /></a>\';
+						if ($topic['new'])
+							$link .= ' <a href="' . $topic['new_href'] . '"><img src="' . $settings['lang_images_url'] . '/new.gif" alt="' . $txt['new'] . '" /></a>';
 
-						$link .= \'<br /><span class="smalltext"><em>\' . $txt[\'in\'] . \' \' . $topic[\'board_link\'] . \'</em></span>\';
+						$link .= '<br /><span class="smalltext"><em>' . $txt['in'] . ' ' . $topic['board_link'] . '</em></span>';
 
 						return $link;
-					'),
+					},
 				),
 				'sort' => array(
 					'default' => 'ms.subject',
@@ -2385,7 +2401,7 @@ function profileLoadSignatureData()
 // Load avatar context data.
 function profileLoadAvatarData()
 {
-	global $context, $cur_profile, $modSettings, $scripturl;
+	global $context, $cur_profile, $modSettings, $scripturl, $boardurl, $image_proxy_enabled;
 
 	$context['avatar_url'] = $modSettings['avatar_url'];
 
@@ -2409,12 +2425,19 @@ function profileLoadAvatarData()
 		);
 		$context['member']['avatar']['href'] = empty($cur_profile['attachment_type']) ? $scripturl . '?action=dlattach;attach=' . $cur_profile['id_attach'] . ';type=avatar' : $modSettings['custom_avatar_url'] . '/' . $cur_profile['filename'];
 	}
-	elseif (stristr($cur_profile['avatar'], 'http://') && $context['member']['avatar']['allow_external'])
+	elseif ((stristr($cur_profile['avatar'], 'http://') || stristr($cur_profile['avatar'], 'https://')) && $context['member']['avatar']['allow_external'])
+	{
 		$context['member']['avatar'] += array(
 			'choice' => 'external',
 			'server_pic' => 'blank.gif',
-			'external' => $cur_profile['avatar']
+			'external' => $cur_profile['avatar'],
+			'external_original' => $cur_profile['avatar']
 		);
+
+		// If we have a proxied imaged, show the original url, not the proxy url.
+		if ($image_proxy_enabled && !empty($cur_profile['avatar_original']) && $cur_profile['avatar_original'] != $cur_profile['avatar'] && stristr($cur_profile['avatar'], $boardurl . '/proxy.php'))
+			$context['member']['avatar']['external_original'] = $cur_profile['avatar_original'];
+	}
 	elseif ($cur_profile['avatar'] != '' && file_exists($modSettings['avatar_directory'] . '/' . $cur_profile['avatar']) && $context['member']['avatar']['allow_server_stored'])
 		$context['member']['avatar'] += array(
 			'choice' => 'server_stored',
@@ -2428,6 +2451,10 @@ function profileLoadAvatarData()
 			'external' => 'http://'
 		);
 
+	// Ensure we have a original external.
+	if (!isset($context['member']['avatar']['external_original']))
+		$context['member']['avatar']['external_original'] = $context['member']['avatar']['external'];
+
 	// Get a list of all the avatars.
 	if ($context['member']['avatar']['allow_server_stored'])
 	{
@@ -2548,6 +2575,7 @@ function profileSaveAvatarData(&$value)
 		return false;
 
 	require_once($sourcedir . '/ManageAttachments.php');
+	require_once($sourcedir . '/Subs-Package.php');
 
 	// We need to know where we're going to be putting it..
 	if (!empty($modSettings['custom_avatar_enabled']))
@@ -2571,13 +2599,11 @@ function profileSaveAvatarData(&$value)
 	}
 
 	$downloadedExternalAvatar = false;
-	if ($value == 'external' && allowedTo('profile_remote_avatar') && strtolower(substr($_POST['userpicpersonal'], 0, 7)) == 'http://' && strlen($_POST['userpicpersonal']) > 7 && !empty($modSettings['avatar_download_external']))
+	if ($value == 'external' && allowedTo('profile_remote_avatar') && (strtolower(substr($_POST['userpicpersonal'], 0, 7)) == 'http://' || strtolower(substr($_POST['userpicpersonal'], 0, 8)) == 'https://') && strlen($_POST['userpicpersonal']) > 7 && !empty($modSettings['avatar_download_external']))
 	{
 		if (!is_writable($uploadDir))
 			fatal_lang_error('attachments_no_write', 'critical');
 
-		require_once($sourcedir . '/Subs-Package.php');
-
 		$url = parse_url($_POST['userpicpersonal']);
 		$contents = fetch_web_data('http://' . $url['host'] . (empty($url['port']) ? '' : ':' . $url['port']) . str_replace(' ', '%20', trim($url['path'])));
 
@@ -2616,7 +2642,7 @@ function profileSaveAvatarData(&$value)
 		// Get rid of their old avatar. (if uploaded.)
 		removeAttachments(array('id_member' => $memID));
 	}
-	elseif ($value == 'external' && allowedTo('profile_remote_avatar') && strtolower(substr($_POST['userpicpersonal'], 0, 7)) == 'http://' && empty($modSettings['avatar_download_external']))
+	elseif ($value == 'external' && allowedTo('profile_remote_avatar') && (strtolower(substr($_POST['userpicpersonal'], 0, 7)) == 'http://' || strtolower(substr($_POST['userpicpersonal'], 0, 8)) == 'https://') && empty($modSettings['avatar_download_external']))
 	{
 		// We need these clean...
 		$cur_profile['id_attach'] = 0;
@@ -2627,11 +2653,14 @@ function profileSaveAvatarData(&$value)
 		removeAttachments(array('id_member' => $memID));
 
 		$profile_vars['avatar'] = str_replace('%20', '', preg_replace('~action(?:=|%3d)(?!dlattach)~i', 'action-', $_POST['userpicpersonal']));
+		$mime_valid = check_mime_type($profile_vars['avatar'], 'image/', true);
 
 		if ($profile_vars['avatar'] == 'http://' || $profile_vars['avatar'] == 'http:///')
 			$profile_vars['avatar'] = '';
 		// Trying to make us do something we'll regret?
-		elseif (substr($profile_vars['avatar'], 0, 7) != 'http://')
+		elseif (substr($profile_vars['avatar'], 0, 7) != 'http://' && substr($profile_vars['avatar'], 0, 8) != 'https://')
+			return 'bad_avatar';
+		elseif (empty($mime_valid))
 			return 'bad_avatar';
 		// Should we check dimensions?
 		elseif (!empty($modSettings['avatar_max_height_external']) || !empty($modSettings['avatar_max_width_external']))
@@ -2677,7 +2706,8 @@ function profileSaveAvatarData(&$value)
 				$_FILES['attachment']['tmp_name'] = $new_filename;
 			}
 
-			$sizes = @getimagesize($_FILES['attachment']['tmp_name']);
+			$mime_valid = check_mime_type($_FILES['attachment']['tmp_name'], 'image/', true);
+			$sizes = empty($mime_valid) ? false : @getimagesize($_FILES['attachment']['tmp_name']);
 
 			// No size, then it's probably not a valid pic.
 			if ($sizes === false)
diff --git a/Sources/Profile-View.php b/Sources/Profile-View.php
index 81cbf85..35535d2 100644
--- a/Sources/Profile-View.php
+++ b/Sources/Profile-View.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -993,7 +993,7 @@ function trackActivity($memID)
 	createList($listOptions);
 
 	// If this is a big forum, or a large posting user, let's limit the search.
-	if ($modSettings['totalMessages'] > 50000 && $user_profile[$memID]['posts'] > 500)
+	if ($modSettings['totalMessages'] > 50000 || $user_profile[$memID]['posts'] > 500)
 	{
 		$request = $smcFunc['db_query']('', '
 			SELECT MAX(id_msg)
@@ -1007,7 +1007,7 @@ function trackActivity($memID)
 		$smcFunc['db_free_result']($request);
 
 		// There's no point worrying ourselves with messages made yonks ago, just get recent ones!
-		$min_msg_member = max(0, $max_msg_member - $user_profile[$memID]['posts'] * 3);
+		$min_msg_member = max(0, $max_msg_member - 50000);
 	}
 
 	// Default to at least the ones we know about.
@@ -1023,8 +1023,10 @@ function trackActivity($memID)
 		WHERE id_member = {int:current_member}
 		' . (isset($min_msg_member) ? '
 			AND id_msg >= {int:min_msg_member} AND id_msg <= {int:max_msg_member}' : '') . '
-		GROUP BY poster_ip',
+		GROUP BY poster_ip
+		LIMIT {int:limit}',
 		array(
+			'limit' => min($user_profile[$memID]['posts'], 500),
 			'current_member' => $memID,
 			'min_msg_member' => !empty($min_msg_member) ? $min_msg_member : 0,
 			'max_msg_member' => !empty($max_msg_member) ? $max_msg_member : 0,
@@ -1454,20 +1456,15 @@ function TrackIP($memID = 0)
 	if ($context['single_ip'])
 	{
 		$context['whois_servers'] = array(
-			'afrinic' => array(
-				'name' => $txt['whois_afrinic'],
-				'url' => 'http://www.afrinic.net/cgi-bin/whois?searchtext=' . $context['ip'],
-				'range' => array(41, 154, 196),
-			),
 			'apnic' => array(
 				'name' => $txt['whois_apnic'],
-				'url' => 'http://wq.apnic.net/apnic-bin/whois.pl?searchtext=' . $context['ip'],
+				'url' => 'https://wq.apnic.net/apnic-bin/whois.pl?searchtext=' . $context['ip'],
 				'range' => array(58, 59, 60, 61, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124,
 					125, 126, 133, 150, 153, 163, 171, 202, 203, 210, 211, 218, 219, 220, 221, 222),
 			),
 			'arin' => array(
 				'name' => $txt['whois_arin'],
-				'url' => 'http://whois.arin.net/rest/ip/' . $context['ip'],
+				'url' => 'https://whois.arin.net/rest/ip/' . $context['ip'],
 				'range' => array(7, 24, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 96, 97, 98, 99,
 					128, 129, 130, 131, 132, 134, 135, 136, 137, 138, 139, 140, 142, 143, 144, 146, 147, 148, 149,
 					152, 155, 156, 157, 158, 159, 160, 161, 162, 164, 165, 166, 167, 168, 169, 170, 172, 173, 174,
@@ -1475,7 +1472,7 @@ function TrackIP($memID = 0)
 			),
 			'lacnic' => array(
 				'name' => $txt['whois_lacnic'],
-				'url' => 'http://lacnic.net/cgi-bin/lacnic/whois?query=' . $context['ip'],
+				'url' => 'https://lacnic.net/cgi-bin/lacnic/whois?query=' . $context['ip'],
 				'range' => array(186, 187, 189, 190, 191, 200, 201),
 			),
 			'ripe' => array(
diff --git a/Sources/Profile.php b/Sources/Profile.php
index f70d191..4b5c416 100644
--- a/Sources/Profile.php
+++ b/Sources/Profile.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.6
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -304,6 +304,14 @@ function ModifyProfile($post_errors = array())
 						'any' => array('moderate_forum'),
 					),
 				),
+				'getprofiledata' => array(
+					'label' => $txt['export_profile_data'],
+					'custom_url' => $scripturl . '?action=.xml;type=smf;download;sa=profile',
+					'permission' => array(
+						'own' => array('profile_view_own'),
+						'any' => array('moderate_forum'),
+					),
+				),
 				'deleteaccount' => array(
 					'label' => $txt['deleteAccount'],
 					'file' => 'Profile-Actions.php',
@@ -568,6 +576,10 @@ function ModifyProfile($post_errors = array())
 		}
 		elseif (!empty($profile_vars))
 		{
+			// Changing the password? Allow only on the approved channel.
+			if ($current_area != 'account')
+				unset($profile_vars['passwd']);
+
 			// If we've changed the password, notify any integration that may be listening in.
 			if (isset($profile_vars['passwd']))
 				call_integration_hook('integrate_reset_pass', array($cur_profile['member_name'], $cur_profile['member_name'], $_POST['passwrd2']));
diff --git a/Sources/QueryString.php b/Sources/QueryString.php
index 77c6cdb..70d0363 100644
--- a/Sources/QueryString.php
+++ b/Sources/QueryString.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.9
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -125,12 +125,12 @@ function cleanRequest()
 		parse_str(preg_replace('/&(\w+)(?=&|$)/', '&$1=', strtr($_SERVER['QUERY_STRING'], array(';?' => '&', ';' => '&', '%00' => '', "\0" => ''))), $_GET);
 
 		// Magic quotes still applies with parse_str - so clean it up.
-		if (function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc() != 0 && empty($modSettings['integrate_magic_quotes']))
+		if (version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc() != 0 && empty($modSettings['integrate_magic_quotes']))
 			$_GET = $removeMagicQuoteFunction($_GET);
 	}
 	elseif (strpos(@ini_get('arg_separator.input'), ';') !== false)
 	{
-		if (function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc() != 0 && empty($modSettings['integrate_magic_quotes']))
+		if (version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc() != 0 && empty($modSettings['integrate_magic_quotes']))
 			$_GET = $removeMagicQuoteFunction($_GET);
 
 		// Search engines will send action=profile%3Bu=1, which confuses PHP.
@@ -179,7 +179,7 @@ function cleanRequest()
 	}
 
 	// If magic quotes is on we have some work...
-	if (function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc() != 0)
+	if (version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc() != 0)
 	{
 		$_ENV = $removeMagicQuoteFunction($_ENV);
 		$_POST = $removeMagicQuoteFunction($_POST);
@@ -483,6 +483,21 @@ function ob_sessrewrite($buffer)
 			$buffer = preg_replace_callback('~"' . preg_quote($scripturl, '/') . '\?((?:c|board|topic)=[^#"]+?)(#[^"]*?)?"~', 'pathinfo_insert__preg_callback', $buffer);
 	}
 
+	// Be nice and try to inject session tokens into login forms since many older themes don't.
+	if ($user_info['is_guest'])
+		$buffer = preg_replace_callback(
+			'~(<form[^<]+action=login2(.+))</form>~iUs' . (!empty($context['utf8']) ? 'u' : ''),
+			function ($m) use ($context)
+			{
+				$repl = '';
+				if (!empty($context['session_var']) && strpos($m[0], $context['session_var']) === false)
+					$repl .= '<input type="hidden" name="' . $context['session_var'] . '" value="' . $context['session_id'] . '"/>';
+
+				return $m[1] . $repl . '</form>';
+			},
+			$buffer
+		);
+
 	// Return the changed buffer.
 	return $buffer;
 }
diff --git a/Sources/Recent.php b/Sources/Recent.php
index d0fd560..8be2cc8 100644
--- a/Sources/Recent.php
+++ b/Sources/Recent.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -85,6 +85,8 @@ function RecentPosts()
 	loadTemplate('Recent');
 	$context['page_title'] = $txt['recent_posts'];
 
+	$_REQUEST['start'] = (int) $_REQUEST['start'];
+
 	if (isset($_REQUEST['start']) && $_REQUEST['start'] > 95)
 		$_REQUEST['start'] = 95;
 
diff --git a/Sources/Register.php b/Sources/Register.php
index 55ba457..cac5c33 100644
--- a/Sources/Register.php
+++ b/Sources/Register.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.7
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -65,13 +65,14 @@ function Register($reg_errors = array())
 	$context['require_agreement'] = !empty($modSettings['requireAgreement']);
 	$context['registration_passed_agreement'] = !empty($_SESSION['registration_agreed']);
 	$context['show_coppa'] = !empty($modSettings['coppaAge']);
+	$context['require_policy_agreement'] = !empty($modSettings['requirePolicyAgreement']);
 
 	// Under age restrictions?
 	if ($context['show_coppa'])
 	{
 		$context['skip_coppa'] = false;
-		$context['coppa_agree_above'] = sprintf($txt['agreement_agree_coppa_above'], $modSettings['coppaAge']);
-		$context['coppa_agree_below'] = sprintf($txt['agreement_agree_coppa_below'], $modSettings['coppaAge']);
+		$context['coppa_agree_above'] = sprintf($txt['agreement' . ($context['require_policy_agreement'] ? '_policy' : '') . '_agree_coppa_above'], $modSettings['coppaAge']);
+		$context['coppa_agree_below'] = sprintf($txt['agreement' . ($context['require_policy_agreement'] ? '_policy' : '') . '_agree_coppa_below'], $modSettings['coppaAge']);
 	}
 
 	// What step are we at?
@@ -141,6 +142,21 @@ function Register($reg_errors = array())
 		}
 	}
 
+	// If you have to agree to the privacy policy, it needs to be loaded from the database.
+	if ($context['require_policy_agreement'])
+	{
+		// Have we got a localized one?
+		if (!empty($modSettings['policy_' . $user_info['language']]))
+			$context['policy'] = parse_bbc($modSettings['policy_' . $user_info['language']]);
+		elseif (!empty($modSettings['policy_' . $language]))
+			$context['policy'] = parse_bbc($modSettings['policy_' . $language]);
+		else
+		{
+			loadLanguage('Errors');
+			$context['policy'] = $txt['error_no_privacy_policy'];
+		}
+	}
+
 	// Any custom fields we want filled in?
 	require_once($sourcedir . '/Profile.php');
 	loadCustomFields(0, 'register');
@@ -200,6 +216,9 @@ function Register($reg_errors = array())
 		);
 	}
 
+	$context['announcements_ask'] = !empty($modSettings['force_gdpr']) || !empty($modSettings['allow_disableAnnounce']);
+	$context['notify_announcements'] = isset($_POST['notify_announcements']) ? (bool) $_POST['notify_announcements'] : !empty($modSettings['announcements_default']);
+
 	// !!! Why isn't this a simple set operation?
 	// Were there any errors?
 	$context['registration_errors'] = array();
@@ -232,7 +251,7 @@ function Register2($verifiedOpenID = false)
 	if (!$verifiedOpenID)
 	{
 		// Well, if you don't agree, you can't register.
-		if (!empty($modSettings['requireAgreement']) && empty($_SESSION['registration_agreed']))
+		if ((!empty($modSettings['requireAgreement']) || !empty($modSettings['requirePolicyAgreement'])) && empty($_SESSION['registration_agreed']))
 			redirectexit();
 
 		// Make sure they came from *somewhere*, have a session.
@@ -373,7 +392,7 @@ function Register2($verifiedOpenID = false)
 	$possible_ints = array_diff($possible_ints, $exclude_fields);
 	$possible_floats = array_diff($possible_floats, $exclude_fields);
 	$possible_bools = array_diff($possible_bools, $exclude_fields);
-	
+
 	// Set the options needed for registration.
 	$regOptions = array(
 		'interface' => 'guest',
@@ -411,6 +430,9 @@ function Register2($verifiedOpenID = false)
 		$_POST['options'] = isset($_POST['options']) ? $_POST['options'] + $_POST['default_options'] : $_POST['default_options'];
 	$regOptions['theme_vars'] = isset($_POST['options']) && is_array($_POST['options']) ? $_POST['options'] : array();
 
+	// Note when they accepted the agreement and privacy policy
+	$regOptions['theme_vars']['agreement_accepted'] = $regOptions['theme_vars']['policy_accepted'] = time();
+
 	// Make sure they are clean, dammit!
 	$regOptions['theme_vars'] = htmlspecialchars__recursive($regOptions['theme_vars']);
 
@@ -452,7 +474,7 @@ function Register2($verifiedOpenID = false)
 			if ($row['field_type'] == 'text' && !empty($row['mask']) && $row['mask'] != 'none')
 			{
 				//!!! We never error on this - just ignore it at the moment...
-				if ($row['mask'] == 'email' && !empty($value) && (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $value) === 0 || strlen($value) > 255))
+				if ($row['mask'] == 'email' && !empty($value) && (filter_var($value, FILTER_VALIDATE_EMAIL) === false || strlen($value) > 255))
 					$custom_field_errors[] = array('custom_field_invalid_email', array($row['field_name']));
 				elseif ($row['mask'] == 'number' && preg_match('~[^\d]~', $value))
 					$custom_field_errors[] = array('custom_field_not_number', array($row['field_name']));
@@ -540,7 +562,7 @@ function Register2($verifiedOpenID = false)
 	}
 	else
 	{
-		call_integration_hook('integrate_activate', array($row['member_name']));
+		call_integration_hook('integrate_activate', array($regOptions['username']));
 
 		setLoginCookie(60 * $modSettings['cookieTime'], $memberID, sha1(sha1(strtolower($regOptions['username']) . $regOptions['password']) . $regOptions['register_vars']['password_salt']));
 
@@ -602,7 +624,7 @@ function Activate()
 			fatal_lang_error('no_access', false);
 
 		// !!! Separate the sprintf?
-		if (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $_POST['new_email']) == 0)
+		if (filter_var($_POST['new_email'], FILTER_VALIDATE_EMAIL) === false)
 			fatal_error(sprintf($txt['valid_email_needed'], htmlspecialchars($_POST['new_email'])), false);
 
 		// Make sure their email isn't banned.
@@ -820,7 +842,7 @@ function VerificationCode()
 		elseif (isset($_REQUEST['letter']))
 		{
 			$_REQUEST['letter'] = (int) $_REQUEST['letter'];
-			if ($_REQUEST['letter'] > 0 && $_REQUEST['letter'] <= strlen($code) && !showLetterImage(strtolower($code{$_REQUEST['letter'] - 1})))
+			if ($_REQUEST['letter'] > 0 && $_REQUEST['letter'] <= strlen($code) && !showLetterImage(strtolower($code[$_REQUEST['letter'] - 1])))
 			{
 				header('Content-Type: image/gif');
 				die("\x47\x49\x46\x38\x39\x61\x01\x00\x01\x00\x80\x00\x00\x00\x00\x00\x00\x00\x00\x21\xF9\x04\x01\x00\x00\x00\x00\x2C\x00\x00\x00\x00\x01\x00\x01\x00\x00\x02\x02\x44\x01\x00\x3B");
diff --git a/Sources/Reminder.php b/Sources/Reminder.php
index 02307d4..9790019 100644
--- a/Sources/Reminder.php
+++ b/Sources/Reminder.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.13
+ * @version 2.0.14
  */
 
 if (!defined('SMF'))
@@ -182,7 +182,7 @@ function RemindPick()
 // Set your new password
 function setPassword()
 {
-	global $txt, $context;
+	global $txt, $context, $smcFunc;
 
 	loadLanguage('Login');
 
@@ -194,7 +194,7 @@ function setPassword()
 	$context += array(
 		'page_title' => $txt['reminder_set_password'],
 		'sub_template' => 'set_password',
-		'code' => $_REQUEST['code'],
+		'code' => $smcFunc['htmlspecialchars']($_REQUEST['code']),
 		'memID' => (int) $_REQUEST['u']
 	);
 }
diff --git a/Sources/RemoveTopic.php b/Sources/RemoveTopic.php
index 9acf575..4dff952 100644
--- a/Sources/RemoveTopic.php
+++ b/Sources/RemoveTopic.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -1206,7 +1206,7 @@ function RestoreTopic()
 }
 
 // Take a load of messages from one place and stick them in a topic.
-function mergePosts($msgs = array(), $from_topic, $target_topic)
+function mergePosts($msgs, $from_topic, $target_topic)
 {
 	global $context, $smcFunc, $modSettings, $sourcedir;
 
diff --git a/Sources/RepairBoards.php b/Sources/RepairBoards.php
index 13acf2c..b2325a6 100644
--- a/Sources/RepairBoards.php
+++ b/Sources/RepairBoards.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -240,68 +240,73 @@ function loadForumTests()
 					LEFT JOIN {db_prefix}topics AS t ON (t.id_topic = m.id_topic)
 				WHERE t.id_topic IS NULL
 				GROUP BY m.id_topic, m.id_board',
-			'fix_processing' => create_function('$row', '
-				global $smcFunc, $salvageBoardID;
+			'fix_processing' => function($row) use ($smcFunc)
+			{
+				global $salvageBoardID;
 
-				// Only if we don\'t have a reasonable idea of where to put it.
-				if ($row[\'id_board\'] == 0)
+				// Only if we don't have a reasonable idea of where to put it.
+				if ($row['id_board'] == 0)
 				{
 					createSalvageArea();
-					$row[\'id_board\'] = (int) $salvageBoardID;
+					$row['id_board'] = (int) $salvageBoardID;
 				}
 
 				// Make sure that no topics claim the first/last message as theirs.
-				$smcFunc[\'db_query\'](\'\', \'
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}topics
 					SET id_first_msg = 0
-					WHERE id_first_msg = {int:id_first_msg}\',
+					WHERE id_first_msg = {int:id_first_msg}',
 					array(
-						\'id_first_msg\' => $row[\'myid_first_msg\'],
+						'id_first_msg' => $row['myid_first_msg'],
 					)
 				);
-				$smcFunc[\'db_query\'](\'\', \'
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}topics
 					SET id_last_msg = 0
-					WHERE id_last_msg = {int:id_last_msg}\',
+					WHERE id_last_msg = {int:id_last_msg}',
 					array(
-						\'id_last_msg\' => $row[\'myid_last_msg\'],
+						'id_last_msg' => $row['myid_last_msg'],
 					)
 				);
 
-				$memberStartedID = (int) getMsgMemberID($row[\'myid_first_msg\']);
-				$memberUpdatedID = (int) getMsgMemberID($row[\'myid_last_msg\']);
+				$memberStartedID = (int) getMsgMemberID($row['myid_first_msg']);
+				$memberUpdatedID = (int) getMsgMemberID($row['myid_last_msg']);
 
-				$smcFunc[\'db_insert\'](\'\',
-					\'{db_prefix}topics\',
+				$smcFunc['db_insert']('',
+					'{db_prefix}topics',
 					array(
-						\'id_board\' => \'int\',
-						\'id_member_started\' => \'int\',
-						\'id_member_updated\' => \'int\',
-						\'id_first_msg\' => \'int\',
-						\'id_last_msg\' => \'int\',
-						\'num_replies\' => \'int\'
+						'id_board' => 'int',
+						'id_member_started' => 'int',
+						'id_member_updated' => 'int',
+						'id_first_msg' => 'int',
+						'id_last_msg' => 'int',
+						'num_replies' => 'int'
 					),
 					array(
-						$row[\'id_board\'],
+						$row['id_board'],
 						$memberStartedID,
 						$memberUpdatedID,
-						$row[\'myid_first_msg\'],
-						$row[\'myid_last_msg\'],
-						$row[\'my_num_replies\']
+						$row['myid_first_msg'],
+						$row['myid_last_msg'],
+						$row['my_num_replies']
 					),
-					array(\'id_topic\')
+					array('id_topic'),
+					1
 				);
 
-				$newTopicID = $smcFunc[\'db_insert_id\']("{db_prefix}topics", \'id_topic\');
+				$newTopicID = $smcFunc['db_insert_id']('{db_prefix}topics', 'id_topic');
 
-				$smcFunc[\'db_query\'](\'\', "
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}messages
-					SET id_topic = $newTopicID, id_board = $row[id_board]
-					WHERE id_topic = $row[id_topic]",
+					SET id_topic = {int:newTopicID}, id_board = {int:board_id}
+					WHERE id_topic = {int:topic_id}',
 					array(
+						'board_id' => $row['id_board'],
+						'topic_id' => $row['id_topic'],
+						'newTopicID' => $newTopicID,
 					)
 				);
-				'),
+			},
 			'force_fix' => array('stats_topics'),
 			'messages' => array('repair_missing_topics', 'id_msg', 'id_topic'),
 		),
@@ -323,23 +328,23 @@ function loadForumTests()
 			// Remove all topics that have zero messages in the messages table.
 			'fix_collect' => array(
 				'index' => 'id_topic',
-				'process' => create_function('$topics', '
-					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+				'process' => function($topics) use ($smcFunc)
+				{
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}topics
-						WHERE id_topic IN ({array_int:topics})",
+						WHERE id_topic IN ({array_int:topics})',
 						array(
-							\'topics\' => $topics
+							'topics' => $topics,
 						)
 					);
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_topics
-						WHERE id_topic IN ({array_int:topics})",
+						WHERE id_topic IN ({array_int:topics})',
 						array(
-							\'topics\' => $topics
+							'topics' => $topics,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_messages', 'id_topic'),
 		),
@@ -356,89 +361,94 @@ function loadForumTests()
 					LEFT JOIN {db_prefix}topics AS t ON (t.id_poll = p.id_poll)
 				WHERE p.id_poll BETWEEN {STEP_LOW} AND {STEP_HIGH}
 					AND t.id_poll IS NULL',
-			'fix_processing' => create_function('$row', '
-				global $smcFunc, $salvageBoardID, $txt;
+			'fix_processing' => function($row) use ($smcFunc)
+			{
+				global $txt, $salvageBoardID;
 
-				// Only if we don\'t have a reasonable idea of where to put it.
-				if ($row[\'id_board\'] == 0)
+				// Only if we don't have a reasonable idea of where to put it.
+				if ($row['id_board'] == 0)
 				{
 					createSalvageArea();
-					$row[\'id_board\'] = (int) $salvageBoardID;
+					$row['id_board'] = (int) $salvageBoardID;
 				}
 
-				$row[\'poster_name\'] = !empty($row[\'poster_name\']) ? $row[\'poster_name\'] : $txt[\'guest\'];
+				$row['poster_name'] = !empty($row['poster_name']) ? $row['poster_name'] : $txt['guest'];
 
-				$smcFunc[\'db_insert\'](\'\',
-					\'{db_prefix}messages\',
+				$smcFunc['db_insert']('',
+					'{db_prefix}messages',
 					array(
-						\'id_board\' => \'int\',
-						\'id_topic\' => \'int\',
-						\'poster_time\' => \'int\',
-						\'id_member\' => \'int\',
-						\'subject\' => \'string-255\',
-						\'poster_name\' => \'string-255\',
-						\'poster_email\' => \'string-255\',
-						\'poster_ip\' => \'string-16\',
-						\'smileys_enabled\' => \'int\',
-						\'body\' => \'string-65534\',
-						\'icon\' => \'string-16\',
-						\'approved\' => \'int\',
+						'id_board' => 'int',
+						'id_topic' => 'int',
+						'poster_time' => 'int',
+						'id_member' => 'int',
+						'subject' => 'string-255',
+						'poster_name' => 'string-255',
+						'poster_email' => 'string-255',
+						'poster_ip' => 'string-16',
+						'smileys_enabled' => 'int',
+						'body' => 'string-65534',
+						'icon' => 'string-16',
+						'approved' => 'int',
 					),
 					array(
-						$row[\'id_board\'],
+						$row['id_board'],
 						0,
 						time(),
-						$row[\'id_member\'],
-						$txt[\'salvaged_poll_topic_name\'],
-						$row[\'poster_name\'],
-						\'\',
-						\'127.0.0.1\',
+						$row['id_member'],
+						$txt['salvaged_poll_topic_name'],
+						$row['poster_name'],
+						'',
+						'127.0.0.1',
 						1,
-						$txt[\'salvaged_poll_message_body\'],
-						\'xx\',
+						$txt['salvaged_poll_message_body'],
+						'xx',
 						1,
 					),
-					array(\'id_topic\')
+					array('id_msg'),
+					1
 				);
 
-				$newMessageID = $smcFunc[\'db_insert_id\']("{db_prefix}messages", \'id_msg\');
+				$newMessageID = $smcFunc['db_insert_id']('{db_prefix}messages', 'id_msg');
 
-				$smcFunc[\'db_insert\'](\'\',
-					\'{db_prefix}topics\',
+				$smcFunc['db_insert']('',
+					'{db_prefix}topics',
 					array(
-						\'id_board\' => \'int\',
-						\'id_poll\' => \'int\',
-						\'id_member_started\' => \'int\',
-						\'id_member_updated\' => \'int\',
-						\'id_first_msg\' => \'int\',
-						\'id_last_msg\' => \'int\',
-						\'num_replies\' => \'int\',
+						'id_board' => 'int',
+						'id_poll' => 'int',
+						'id_member_started' => 'int',
+						'id_member_updated' => 'int',
+						'id_first_msg' => 'int',
+						'id_last_msg' => 'int',
+						'num_replies' => 'int',
 					),
 					array(
-						$row[\'id_board\'],
-						$row[\'id_poll\'],
-						$row[\'id_member\'],
-						$row[\'id_member\'],
+						$row['id_board'],
+						$row['id_poll'],
+						$row['id_member'],
+						$row['id_member'],
 						$newMessageID,
 						$newMessageID,
 						0,
 					),
-					array(\'id_topic\')
+					array('id_topic'),
+					1
 				);
 
-				$newTopicID = $smcFunc[\'db_insert_id\']("{db_prefix}topics", \'id_topic\');
+				$newTopicID = $smcFunc['db_insert_id']('{db_prefix}topics', 'id_topic');
 
-				$smcFunc[\'db_query\'](\'\', "
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}messages
-					SET id_topic = $newTopicID, id_board = $row[id_board]
-					WHERE id_msg = $newMessageID",
+					SET id_topic = {int:newTopicID}, id_board = {int:id_board}
+					WHERE id_msg = {int:newMessageID}',
 					array(
+						'id_board' => $row['id_board'],
+						'newTopicID' => $newTopicID,
+						'newMessageID' => $newMessageID,
 					)
 				);
 
-				updateStats(\'subject\', $newTopicID, $txt[\'salvaged_poll_topic_name\']);
-
-				'),
+				updateStats('subject', $newTopicID, $txt['salvaged_poll_topic_name']);
+			},
 			'force_fix' => array('stats_topics'),
 			'messages' => array('repair_polls_missing_topics', 'id_poll', 'id_topic'),
 		),
@@ -466,45 +476,52 @@ function loadForumTests()
 				WHERE t.id_topic BETWEEN {STEP_LOW} AND {STEP_HIGH}
 				GROUP BY t.id_topic, t.id_first_msg, t.id_last_msg, t.approved, mf.approved
 				ORDER BY t.id_topic',
-			'fix_processing' => create_function('$row', '
-				global $smcFunc;
-				$row[\'firstmsg_approved\'] = (int) $row[\'firstmsg_approved\'];
-				$row[\'myid_first_msg\'] = (int) $row[\'myid_first_msg\'];
-				$row[\'myid_last_msg\'] = (int) $row[\'myid_last_msg\'];
+			'fix_processing' => function($row) use ($smcFunc)
+			{
+				$row['firstmsg_approved'] = (int) $row['firstmsg_approved'];
+				$row['myid_first_msg'] = (int) $row['myid_first_msg'];
+				$row['myid_last_msg'] = (int) $row['myid_last_msg'];
 
 				// Not really a problem?
-				if ($row[\'myid_first_msg\'] == $row[\'myid_first_msg\'] && $row[\'myid_first_msg\'] == $row[\'myid_first_msg\'] && $row[\'approved\'] == $row[\'firstmsg_approved\'])
+				if ($row['id_first_msg'] == $row['myid_first_msg'] && $row['id_first_msg'] == $row['myid_first_msg'] && $row['approved'] == $row['firstmsg_approved'])
 					return false;
 
-				$memberStartedID = (int) getMsgMemberID($row[\'myid_first_msg\']);
-				$memberUpdatedID = (int) getMsgMemberID($row[\'myid_last_msg\']);
+				$memberStartedID = (int) getMsgMemberID($row['myid_first_msg']);
+				$memberUpdatedID = (int) getMsgMemberID($row['myid_last_msg']);
 
-				$smcFunc[\'db_query\'](\'\', "
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}topics
-					SET id_first_msg = $row[myid_first_msg],
-						id_member_started = $memberStartedID, id_last_msg = $row[myid_last_msg],
-						id_member_updated = $memberUpdatedID, approved = $row[firstmsg_approved]
-					WHERE id_topic = $row[id_topic]",
+					SET id_first_msg = {int:myid_first_msg},
+						id_member_started = {int:memberStartedID}, id_last_msg = {int:myid_last_msg},
+						id_member_updated = {int:memberUpdatedID}, approved = {int:firstmsg_approved}
+					WHERE id_topic = {int:topic_id}',
 					array(
+						'myid_first_msg' => $row['myid_first_msg'],
+						'memberStartedID' => $memberStartedID,
+						'myid_last_msg' => $row['myid_last_msg'],
+						'memberUpdatedID' => $memberUpdatedID,
+						'firstmsg_approved' => $row['firstmsg_approved'],
+						'topic_id' => $row['id_topic'],
 					)
 				);
-			'),
-			'message_function' => create_function('$row', '
+			},
+			'message_function' => function($row)
+			{
 				global $txt, $context;
 
 				// A pretend error?
-				if ($row[\'myid_first_msg\'] == $row[\'myid_first_msg\'] && $row[\'myid_first_msg\'] == $row[\'myid_first_msg\'] && $row[\'approved\'] == $row[\'firstmsg_approved\'])
+				if ($row['id_first_msg'] == $row['myid_first_msg'] && $row['id_last_msg'] == $row['myid_last_msg'] && $row['approved'] == $row['firstmsg_approved'])
 					return false;
 
-				if ($row[\'id_first_msg\'] != $row[\'myid_first_msg\'])
-					$context[\'repair_errors\'][] = sprintf($txt[\'repair_stats_topics_1\'], $row[\'id_topic\'], $row[\'id_first_msg\']);
-				if ($row[\'id_last_msg\'] != $row[\'myid_last_msg\'])
-					$context[\'repair_errors\'][] = sprintf($txt[\'repair_stats_topics_2\'], $row[\'id_topic\'], $row[\'id_last_msg\']);
-				if ($row[\'approved\'] != $row[\'firstmsg_approved\'])
-					$context[\'repair_errors\'][] = sprintf($txt[\'repair_stats_topics_5\'], $row[\'id_topic\']);
+				if ($row['id_first_msg'] != $row['myid_first_msg'])
+					$context['repair_errors'][] = sprintf($txt['repair_stats_topics_1'], $row['id_topic'], $row['id_first_msg']);
+				if ($row['id_last_msg'] != $row['myid_last_msg'])
+					$context['repair_errors'][] = sprintf($txt['repair_stats_topics_2'], $row['id_topic'], $row['id_last_msg']);
+				if ($row['approved'] != $row['firstmsg_approved'])
+					$context['repair_errors'][] = sprintf($txt['repair_stats_topics_5'], $row['id_topic']);
 
 				return true;
-			'),
+			},
 		),
 		// Find topics with incorrect num_replies.
 		'stats_topics2' => array(
@@ -524,34 +541,38 @@ function loadForumTests()
 				WHERE t.id_topic BETWEEN {STEP_LOW} AND {STEP_HIGH}
 				GROUP BY t.id_topic, t.num_replies, mf.approved
 				ORDER BY t.id_topic',
-			'fix_processing' => create_function('$row', '
+			'fix_processing' => function($row)
+			{
 				global $smcFunc;
-				$row[\'my_num_replies\'] = (int) $row[\'my_num_replies\'];
+				$row['my_num_replies'] = (int) $row['my_num_replies'];
 
 				// Not really a problem?
-				if ($row[\'my_num_replies\'] == $row[\'num_replies\'])
+				if ($row['my_num_replies'] == $row['num_replies'])
 					return false;
 
-				$smcFunc[\'db_query\'](\'\', "
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}topics
-					SET num_replies = $row[my_num_replies]
-					WHERE id_topic = $row[id_topic]",
+					SET num_replies = {int:my_num_replies}
+					WHERE id_topic = {int:topic_id}',
 					array(
+						'my_num_replies' => $row['my_num_replies'],
+						'topic_id' => $row['id_topic'],
 					)
 				);
-			'),
-			'message_function' => create_function('$row', '
+			},
+			'message_function' => function($row)
+			{
 				global $txt, $context;
 
 				// Just joking?
-				if ($row[\'my_num_replies\'] == $row[\'num_replies\'])
+				if ($row['my_num_replies'] == $row['num_replies'])
 					return false;
 
-				if ($row[\'num_replies\'] != $row[\'my_num_replies\'])
-					$context[\'repair_errors\'][] = sprintf($txt[\'repair_stats_topics_3\'], $row[\'id_topic\'], $row[\'num_replies\']);
+				if ($row['num_replies'] != $row['my_num_replies'])
+					$context['repair_errors'][] = sprintf($txt['repair_stats_topics_3'], $row['id_topic'], $row['num_replies']);
 
 				return true;
-			'),
+			},
 		),
 		// Find topics with incorrect unapproved_posts.
 		'stats_topics3' => array(
@@ -570,18 +591,21 @@ function loadForumTests()
 				GROUP BY t.id_topic, t.unapproved_posts
 				HAVING unapproved_posts != COUNT(mu.id_msg)
 				ORDER BY t.id_topic',
-			'fix_processing' => create_function('$row', '
+			'fix_processing' => function($row)
+			{
 				global $smcFunc;
-				$row[\'my_unapproved_posts\'] = (int) $row[\'my_unapproved_posts\'];
+				$row['my_unapproved_posts'] = (int) $row['my_unapproved_posts'];
 
-				$smcFunc[\'db_query\'](\'\', "
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}topics
-					SET unapproved_posts = $row[my_unapproved_posts]
-					WHERE id_topic = $row[id_topic]",
+					SET unapproved_posts = {int:my_unapproved_posts}
+					WHERE id_topic = {int:topic_id}',
 					array(
+						'my_unapproved_posts' => $row['my_unapproved_posts'],
+						'topic_id' => $row['id_topic'],
 					)
 				);
-			'),
+			},
 			'messages' => array('repair_stats_topics_4', 'id_topic', 'unapproved_posts'),
 		),
 		// Find topics with nonexistent boards.
@@ -607,36 +631,43 @@ function loadForumTests()
 				WHERE b.id_board IS NULL
 					AND t.id_topic BETWEEN {STEP_LOW} AND {STEP_HIGH}
 				GROUP BY t.id_board',
-			'fix_processing' => create_function('$row', '
-				global $smcFunc, $salvageCatID;
+			'fix_processing' => function($row)
+			{
+				global $smcFunc, $salvageCatID, $txt;
 				createSalvageArea();
 
-				$row[\'my_num_topics\'] = (int) $row[\'my_num_topics\'];
-				$row[\'my_num_posts\'] = (int) $row[\'my_num_posts\'];
+				$row['my_num_topics'] = (int) $row['my_num_topics'];
+				$row['my_num_posts'] = (int) $row['my_num_posts'];
 
-				$smcFunc[\'db_insert\'](\'\',
-					\'{db_prefix}boards\',
-					array(\'id_cat\' => \'int\', \'name\' => \'string\', \'description\' => \'string\', \'num_topics\' => \'int\', \'num_posts\' => \'int\', \'member_groups\' => \'string\'),
-					array($salvageCatID, \'Salvaged board\', \'\', $row[\'my_num_topics\'], $row[\'my_num_posts\'], \'1\'),
-					array(\'id_board\')
+				$smcFunc['db_insert']('',
+					'{db_prefix}boards',
+					array('id_cat' => 'int', 'name' => 'string', 'description' => 'string', 'num_topics' => 'int', 'num_posts' => 'int', 'member_groups' => 'string'),
+					array($salvageCatID, $txt['salvaged_board_name'], $txt['salvaged_board_description'], $row['my_num_topics'], $row['my_num_posts'], '1'),
+					array('id_board'),
+					1
 				);
-				$newBoardID = $smcFunc[\'db_insert_id\'](\'{db_prefix}boards\', \'id_board\');
 
-				$smcFunc[\'db_query\'](\'\', "
+				$newBoardID = $smcFunc['db_insert_id']('{db_prefix}boards', 'id_board');
+
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}topics
-					SET id_board = $newBoardID
-					WHERE id_board = $row[id_board]",
+					SET id_board = {int:newBoardID}
+					WHERE id_board = {int:board_id}',
 					array(
+						'newBoardID' => $newBoardID,
+						'board_id' => $row['id_board'],
 					)
 				);
-				$smcFunc[\'db_query\'](\'\', "
+				$smcFunc['db_query']('', '
 					UPDATE {db_prefix}messages
-					SET id_board = $newBoardID
-					WHERE id_board = $row[id_board]",
+					SET id_board = {int:newBoardID}
+					WHERE id_board = {int:board_id}',
 					array(
+						'newBoardID' => $newBoardID,
+						'board_id' => $row['id_board'],
 					)
 				);
-			'),
+			},
 			'messages' => array('repair_missing_boards', 'id_topic', 'id_board'),
 		),
 		// Find boards with nonexistent categories.
@@ -649,18 +680,20 @@ function loadForumTests()
 				ORDER BY b.id_cat, b.id_board',
 			'fix_collect' => array(
 				'index' => 'id_cat',
-				'process' => create_function('$cats', '
+				'process' => function($cats)
+				{
 					global $smcFunc, $salvageCatID;
 					createSalvageArea();
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						UPDATE {db_prefix}boards
-						SET id_cat = $salvageCatID
-						WHERE id_cat IN ({array_int:categories})",
+						SET id_cat = {int:salvageCatID}
+						WHERE id_cat IN ({array_int:categories})',
 						array(
-							\'categories\' => $cats
+							'salvageCatID' => $salvageCatID,
+							'categories' => $cats,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_categories', 'id_board', 'id_cat'),
 		),
@@ -683,17 +716,19 @@ function loadForumTests()
 			// Last step-make sure all non-guest posters still exist.
 			'fix_collect' => array(
 				'index' => 'id_msg',
-				'process' => create_function('$msgs', '
+				'process' => function($msgs)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						UPDATE {db_prefix}messages
-						SET id_member = 0
-						WHERE id_msg IN ({array_int:msgs})",
+						SET id_member = {int:guest_id}
+						WHERE id_msg IN ({array_int:msgs})',
 						array(
-							\'msgs\' => $msgs
+							'msgs' => $msgs,
+							'guest_id' => 0,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_posters', 'id_msg', 'id_member'),
 		),
@@ -708,18 +743,24 @@ function loadForumTests()
 				ORDER BY b.id_parent, b.id_board',
 			'fix_collect' => array(
 				'index' => 'id_parent',
-				'process' => create_function('$parents', '
+				'process' => function($parents)
+				{
 					global $smcFunc, $salvageBoardID, $salvageCatID;
+
 					createSalvageArea();
-					$smcFunc[\'db_query\'](\'\', "
+					(int) $salvageBoardID;
+
+					$smcFunc['db_query']('', '
 						UPDATE {db_prefix}boards
-						SET id_parent = $salvageBoardID, id_cat = $salvageCatID, child_level = 1
-						WHERE id_parent IN ({array_int:parents})",
+						SET id_parent = {int:salvageBoardID}, id_cat = {int:salvageCatID}, child_level = 1
+						WHERE id_parent IN ({array_int:parents})',
 						array(
-							\'parents\' => $parents
+							'salvageBoardID' => $salvageBoardID,
+							'salvageCatID' => $salvageCatID,
+							'parents' => $parents,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_parents', 'id_board', 'id_parent'),
 		),
@@ -739,17 +780,18 @@ function loadForumTests()
 					AND p.id_poll IS NULL',
 			'fix_collect' => array(
 				'index' => 'id_poll',
-				'process' => create_function('$polls', '
+				'process' => function($polls)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						UPDATE {db_prefix}topics
 						SET id_poll = 0
-						WHERE id_poll IN ({array_int:polls})",
+						WHERE id_poll IN ({array_int:polls})',
 						array(
-							\'polls\' => $polls
+							'polls' => $polls,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_polls', 'id_topic', 'id_poll'),
 		),
@@ -770,17 +812,18 @@ function loadForumTests()
 				ORDER BY cal.id_topic',
 			'fix_collect' => array(
 				'index' => 'id_topic',
-				'process' => create_function('$events', '
+				'process' => function($events)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', \'
+					$smcFunc['db_query']('', '
 						UPDATE {db_prefix}calendar
 						SET id_topic = 0, id_board = 0
-						WHERE id_topic IN ({array_int:events})\',
+						WHERE id_topic IN ({array_int:events})',
 						array(
-							\'events\' => $events
+							'events' => $events,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_calendar_topics', 'id_event', 'id_topic'),
 		),
@@ -799,16 +842,17 @@ function loadForumTests()
 					AND lt.id_member BETWEEN {STEP_LOW} AND {STEP_HIGH}',
 			'fix_collect' => array(
 				'index' => 'id_topic',
-				'process' => create_function('$topics', '
+				'process' => function($topics)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_topics
-						WHERE id_topic IN ({array_int:topics})",
+						WHERE id_topic IN ({array_int:topics})',
 						array(
-							\'topics\' => $topics
+							'topics' => $topics,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_topics', 'id_topic'),
 		),
@@ -828,16 +872,17 @@ function loadForumTests()
 				GROUP BY lt.id_member',
 			'fix_collect' => array(
 				'index' => 'id_member',
-				'process' => create_function('$members', '
+				'process' => function($members)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_topics
-						WHERE id_member IN ({array_int:members})",
+						WHERE id_member IN ({array_int:members})',
 						array(
-							\'members\' => $members
+							'members' => $members,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_topics_members', 'id_member'),
 		),
@@ -857,16 +902,17 @@ function loadForumTests()
 				GROUP BY lb.id_board',
 			'fix_collect' => array(
 				'index' => 'id_board',
-				'process' => create_function('$boards', '
+				'process' => function($boards)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_boards
-						WHERE id_board IN ({array_int:boards})",
+						WHERE id_board IN ({array_int:boards})',
 						array(
-							\'boards\' => $boards
+							'boards' => $boards,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_boards', 'id_board'),
 		),
@@ -886,16 +932,16 @@ function loadForumTests()
 				GROUP BY lb.id_member',
 			'fix_collect' => array(
 				'index' => 'id_member',
-				'process' => create_function('$members', '
-					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+				'process' => function($members) use ($smcFunc)
+				{
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_boards
-						WHERE id_member IN ({array_int:members})",
+						WHERE id_member IN ({array_int:members})',
 						array(
-							\'members\' => $members
+							'members' => $members,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_boards_members', 'id_member'),
 		),
@@ -915,16 +961,16 @@ function loadForumTests()
 				GROUP BY lmr.id_board',
 			'fix_collect' => array(
 				'index' => 'id_board',
-				'process' => create_function('$boards', '
-					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+				'process' => function($boards) use ($smcFunc)
+				{
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_mark_read
-						WHERE id_board IN ({array_int:boards})",
+						WHERE id_board IN ({array_int:boards})',
 						array(
-							\'boards\' => $boards
+							'boards' => $boards,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_mark_read', 'id_board'),
 		),
@@ -944,16 +990,16 @@ function loadForumTests()
 				GROUP BY lmr.id_member',
 			'fix_collect' => array(
 				'index' => 'id_member',
-				'process' => create_function('$members', '
-					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+				'process' => function($members) use ($smcFunc)
+				{
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_mark_read
-						WHERE id_member IN ({array_int:members})",
+						WHERE id_member IN ({array_int:members})',
 						array(
-							\'members\' => $members
+							'members' => $members,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_mark_read_members', 'id_member'),
 		),
@@ -973,16 +1019,16 @@ function loadForumTests()
 				GROUP BY pmr.id_pm',
 			'fix_collect' => array(
 				'index' => 'id_pm',
-				'process' => create_function('$pms', '
-					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+				'process' => function($pms) use ($smcFunc)
+				{
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}pm_recipients
-						WHERE id_pm IN ({array_int:pms})",
+						WHERE id_pm IN ({array_int:pms})',
 						array(
-							\'pms\' => $pms
+							'pms' => $pms,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_pms', 'id_pm'),
 		),
@@ -1003,16 +1049,17 @@ function loadForumTests()
 				GROUP BY pmr.id_member',
 			'fix_collect' => array(
 				'index' => 'id_member',
-				'process' => create_function('$members', '
+				'process' => function($members)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}pm_recipients
-						WHERE id_member IN ({array_int:members})",
+						WHERE id_member IN ({array_int:members})',
 						array(
-							\'members\' => $members
+							'members' => $members,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_recipients', 'id_member'),
 		),
@@ -1032,16 +1079,18 @@ function loadForumTests()
 					AND mem.id_member IS NULL',
 			'fix_collect' => array(
 				'index' => 'id_pm',
-				'process' => create_function('$guestMessages', '
+				'process' => function($guestMessages)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						UPDATE {db_prefix}personal_messages
 						SET id_member_from = 0
-						WHERE id_pm IN ({array_int:guestMessages})",
+						WHERE id_pm IN ({array_int:guestMessages})',
 						array(
-							\'guestMessages\' => $guestMessages
-						));
-				'),
+							'guestMessages' => $guestMessages,
+						)
+					);
+				},
 			),
 			'messages' => array('repair_missing_senders', 'id_pm', 'id_member_from'),
 		),
@@ -1061,16 +1110,16 @@ function loadForumTests()
 				GROUP BY ln.id_member',
 			'fix_collect' => array(
 				'index' => 'id_member',
-				'process' => create_function('$members', '
-					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+				'process' => function($members) use ($smcFunc)
+				{
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_notify
-						WHERE id_member IN ({array_int:members})",
+						WHERE id_member IN ({array_int:members})',
 						array(
-							\'members\' => $members
+							'members' => $members,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_notify_members', 'id_member'),
 		),
@@ -1088,46 +1137,47 @@ function loadForumTests()
 					LEFT JOIN {db_prefix}log_search_subjects AS lss ON (lss.id_topic = t.id_topic)
 				WHERE t.id_topic BETWEEN {STEP_LOW} AND {STEP_HIGH}
 					AND lss.id_topic IS NULL',
-			'fix_full_processing' => create_function('$result', '
+			'fix_full_processing' => function($result)
+			{
 				global $smcFunc;
 
 				$inserts = array();
-				while ($row = $smcFunc[\'db_fetch_assoc\']($result))
+				while ($row = $smcFunc['db_fetch_assoc']($result))
 				{
-					foreach (text2words($row[\'subject\']) as $word)
-						$inserts[] = array($word, $row[\'id_topic\']);
+					foreach (text2words($row['subject']) as $word)
+						$inserts[] = array($word, $row['id_topic']);
 					if (count($inserts) > 500)
 					{
-						$smcFunc[\'db_insert\'](\'ignore\',
-							"{db_prefix}log_search_subjects",
-							array(\'word\' => \'string\', \'id_topic\' => \'int\'),
+						$smcFunc['db_insert']('ignore',
+							'{db_prefix}log_search_subjects',
+							array('word' => 'string', 'id_topic' => 'int'),
 							$inserts,
-							array(\'word\', \'id_topic\')
+							array('word', 'id_topic')
 						);
 						$inserts = array();
 					}
-
 				}
 
 				if (!empty($inserts))
-					$smcFunc[\'db_insert\'](\'ignore\',
-						"{db_prefix}log_search_subjects",
-						array(\'word\' => \'string\', \'id_topic\' => \'int\'),
+					$smcFunc['db_insert']('ignore',
+						'{db_prefix}log_search_subjects',
+						array('word' => 'string', 'id_topic' => 'int'),
 						$inserts,
-						array(\'word\', \'id_topic\')
+						array('word', 'id_topic')
 					);
-			'),
-			'message_function' => create_function('$row', '
+			},
+			'message_function' => function($row)
+			{
 				global $txt, $context;
 
-				if (count(text2words($row[\'subject\'])) != 0)
+				if (count(text2words($row['subject'])) != 0)
 				{
-					$context[\'repair_errors\'][] = sprintf($txt[\'repair_missing_cached_subject\'], $row[\'id_topic\']);
+					$context['repair_errors'][] = sprintf($txt['repair_missing_cached_subject'], $row['id_topic']);
 					return true;
 				}
 
 				return false;
-			'),
+			},
 		),
 		'missing_topic_for_cache' => array(
 			'substeps' => array(
@@ -1144,16 +1194,17 @@ function loadForumTests()
 					AND t.id_topic IS NULL',
 			'fix_collect' => array(
 				'index' => 'id_topic',
-				'process' => create_function('$deleteTopics', '
+				'process' => function($deleteTopics)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_search_subjects
-						WHERE id_topic IN ({array_int:deleteTopics})",
+						WHERE id_topic IN ({array_int:deleteTopics})',
 						array(
-							\'deleteTopics\' => $deleteTopics
+							'deleteTopics' => $deleteTopics,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_topic_for_cache', 'word'),
 		),
@@ -1173,16 +1224,17 @@ function loadForumTests()
 					AND mem.id_member IS NULL',
 			'fix_collect' => array(
 				'index' => 'id_member',
-				'process' => create_function('$members', '
+				'process' => function($members)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_polls
-						WHERE id_member IN ({array_int:members})",
+						WHERE id_member IN ({array_int:members})',
 						array(
-							\'members\' => $members
+							'members' => $members,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_poll_member', 'id_poll', 'id_member'),
 		),
@@ -1201,16 +1253,17 @@ function loadForumTests()
 					AND p.id_poll IS NULL',
 			'fix_collect' => array(
 				'index' => 'id_poll',
-				'process' => create_function('$polls', '
+				'process' => function($polls)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_polls
-						WHERE id_poll IN ({array_int:polls})",
+						WHERE id_poll IN ({array_int:polls})',
 						array(
-							\'polls\' => $polls
+							'polls' => $polls,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_missing_log_poll_vote', 'id_member', 'id_poll'),
 		),
@@ -1229,16 +1282,17 @@ function loadForumTests()
 					AND lrc.id_report IS NULL',
 			'fix_collect' => array(
 				'index' => 'id_report',
-				'process' => create_function('$reports', '
+				'process' => function($reports)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_reported
-						WHERE id_report IN ({array_int:reports})",
+						WHERE id_report IN ({array_int:reports})',
 						array(
-							\'reports\' => $reports
+							'reports' => $reports,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_report_missing_comments', 'id_report', 'subject'),
 		),
@@ -1257,16 +1311,17 @@ function loadForumTests()
 					AND lr.id_report IS NULL',
 			'fix_collect' => array(
 				'index' => 'id_report',
-				'process' => create_function('$reports', '
+				'process' => function($reports)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_reported_comments
-						WHERE id_report IN ({array_int:reports})",
+						WHERE id_report IN ({array_int:reports})',
 						array(
-							\'reports\' => $reports
+							'reports' => $reports,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_comments_missing_report', 'id_report', 'membername'),
 		),
@@ -1286,16 +1341,17 @@ function loadForumTests()
 				GROUP BY lgr.id_member',
 			'fix_collect' => array(
 				'index' => 'id_member',
-				'process' => create_function('$members', '
+				'process' => function($members)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', "
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_group_requests
-						WHERE id_member IN ({array_int:members})",
+						WHERE id_member IN ({array_int:members})',
 						array(
-							\'members\' => $members
+							'members' => $members,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_group_request_missing_member', 'id_member'),
 		),
@@ -1315,16 +1371,17 @@ function loadForumTests()
 				GROUP BY lgr.id_group',
 			'fix_collect' => array(
 				'index' => 'id_group',
-				'process' => create_function('$groups', '
+				'process' => function($groups)
+				{
 					global $smcFunc;
-					$smcFunc[\'db_query\'](\'\', \'
+					$smcFunc['db_query']('', '
 						DELETE FROM {db_prefix}log_group_requests
-						WHERE id_group IN ({array_int:groups})\',
+						WHERE id_group IN ({array_int:groups})',
 						array(
-							\'groups\' => $groups
+							'groups' => $groups,
 						)
 					);
-				'),
+				},
 			),
 			'messages' => array('repair_group_request_missing_group', 'id_group'),
 		),
@@ -1346,7 +1403,7 @@ function findForumErrors($do_fix = false)
 
 	// Don't allow the cache to get too full.
 	$db_temp_cache = $db_cache;
-	$db_cache = '';
+	$db_cache = array();
 
 	$context['total_steps'] = count($errorTests);
 
@@ -1503,7 +1560,7 @@ function findForumErrors($do_fix = false)
 			// Free the result.
 			$smcFunc['db_free_result']($request);
 			// Keep memory down.
-			$db_cache = '';
+			$db_cache = array();
 
 			// Are we done yet?
 			if (isset($test['substeps']))
diff --git a/Sources/ScheduledTasks.php b/Sources/ScheduledTasks.php
index e0824a6..6cb05e8 100644
--- a/Sources/ScheduledTasks.php
+++ b/Sources/ScheduledTasks.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.9
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -391,7 +391,7 @@ function scheduled_approval_notification()
 // Do some daily cleaning up.
 function scheduled_daily_maintenance()
 {
-	global $smcFunc, $modSettings, $sourcedir, $db_type;
+	global $smcFunc, $modSettings, $sourcedir, $db_type, $image_proxy_enabled, $cachedir;
 
 	// First clean out the cache.
 	clean_cache();
@@ -491,6 +491,19 @@ function scheduled_daily_maintenance()
 			)
 		);
 
+	// Cleanup old proxied images.
+	if (!empty($image_proxy_enabled) && $handle = opendir($cachedir . '/images'))
+	{
+		while (false !== ($file = readdir($handle)))
+		{
+			// Remove images older than 5 days.
+			if (is_file($cachedir . '/images/' . $file) && !in_array($file, array('index.php', '.htaccess')) && time() - filemtime($cachedir . '/images/' . $file) > 5 * 86400)
+				unlink($cachedir . '/images/' . $file);
+		}
+
+		closedir($handle);
+	}
+
 	// Log we've done it...
 	return true;
 }
@@ -1002,7 +1015,7 @@ function ReduceMailQueue($number = false, $override_limit = false, $force_send =
 				@apache_reset_timeout();
 		}
 		else
-			$result = smtp_mail(array($email['to']), $email['subject'], $email['body'], $email['send_html'] ? $email['headers'] : 'Mime-Version: 1.0' . "\r\n" . $email['headers']);
+			$result = smtp_mail(array($email['to']), $email['subject'], $email['body'], $email['headers']);
 
 		// Hopefully it sent?
 		if (!$result)
@@ -1236,6 +1249,35 @@ function loadEssentialThemeData()
 	}
 
 	loadLanguage('index+Modifications');
+
+	// Also load up some context that is used by routines throughout ScheduledTasks.
+	// These may not be set when AutoTask is called very early in index.php.
+	// When scheduled tasks throw undefined errors, address them here.
+
+	if (!isset($context['server']))
+	{
+		// Copied over from Load.php...
+		// This determines the server... not used in many places, except for login fixing.
+		$context['server'] = array(
+			'is_iis' => isset($_SERVER['SERVER_SOFTWARE']) && strpos($_SERVER['SERVER_SOFTWARE'], 'Microsoft-IIS') !== false,
+			'is_apache' => isset($_SERVER['SERVER_SOFTWARE']) && strpos($_SERVER['SERVER_SOFTWARE'], 'Apache') !== false,
+			'is_lighttpd' => isset($_SERVER['SERVER_SOFTWARE']) && strpos($_SERVER['SERVER_SOFTWARE'], 'lighttpd') !== false,
+			'is_nginx' => isset($_SERVER['SERVER_SOFTWARE']) && strpos($_SERVER['SERVER_SOFTWARE'], 'nginx') !== false,
+			'is_cgi' => isset($_SERVER['SERVER_SOFTWARE']) && strpos(php_sapi_name(), 'cgi') !== false,
+			'is_windows' => strpos(PHP_OS, 'WIN') === 0,
+			'iso_case_folding' => ord(strtolower(chr(138))) === 154,
+			'complex_preg_chars' => @version_compare(PHP_VERSION, '4.3.3') != -1,
+		);
+	}
+
+	if (!isset($context['utf8']))
+	{
+		// Copied over from Load.php...
+		// Set the character set from the template.
+		$context['character_set'] = empty($modSettings['global_character_set']) ? (empty($txt['lang_character_set']) ? 'ISO-8859-1' : $txt['lang_character_set']) : $modSettings['global_character_set'];
+		$context['utf8'] = $context['character_set'] === 'UTF-8' && (strpos(strtolower(PHP_OS), 'win') === false || @version_compare(PHP_VERSION, '4.2.3') != -1);
+		$context['right_to_left'] = !empty($txt['lang_rtl']);
+	}
 }
 
 function scheduled_fetchSMfiles()
@@ -1273,7 +1315,7 @@ function scheduled_fetchSMfiles()
 	foreach ($js_files as $ID_FILE => $file)
 	{
 		// Create the url
-		$server = empty($file['path']) || substr($file['path'], 0, 7) != 'http://' ? 'http://www.simplemachines.org' : '';
+		$server = empty($file['path']) || !in_array(parse_url($file['path'], PHP_URL_SCHEME), array('http', 'https')) ? 'https://www.simplemachines.org' : '';
 		$url = $server . (!empty($file['path']) ? $file['path'] : $file['path']) . $file['filename'] . (!empty($file['parameters']) ? '?' . $file['parameters'] : '');
 
 		// Get the file
diff --git a/Sources/Search.php b/Sources/Search.php
index 62cbd6b..66ee60a 100644
--- a/Sources/Search.php
+++ b/Sources/Search.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.9
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -1667,7 +1667,7 @@ function PlushSearch2()
 					else
 						$_SESSION['search_cache']['num_results'] += $smcFunc['db_affected_rows']();
 				}
-				else
+				elseif ($_SESSION['search_cache']['num_results'] == -1)
 					$_SESSION['search_cache']['num_results'] = 0;
 			}
 		}
diff --git a/Sources/SearchAPI-Custom.php b/Sources/SearchAPI-Custom.php
index e719582..0e4a0cd 100644
--- a/Sources/SearchAPI-Custom.php
+++ b/Sources/SearchAPI-Custom.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.15
  */
 
 if (!defined('SMF'))
@@ -109,7 +109,7 @@ class custom_search
 
 		// Excluded phrases don't benefit from being split into subwords.
 		if (count($subwords) > 1 && $isExcluded)
-			continue;
+			return;
 		else
 		{
 			foreach ($subwords as $subword)
diff --git a/Sources/SearchAPI-Fulltext.php b/Sources/SearchAPI-Fulltext.php
index 11ea37a..a55bef9 100644
--- a/Sources/SearchAPI-Fulltext.php
+++ b/Sources/SearchAPI-Fulltext.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -113,7 +113,7 @@ class fulltext_search
 	// Do we have to do some work with the words we are searching for to prepare them?
 	public function prepareIndexes($word, &$wordsSearch, &$wordsExclude, $isExcluded)
 	{
-		global $modSettings;
+		global $modSettings, $smcFunc;
 
 		$subwords = text2words($word, null, false);
 
@@ -168,8 +168,8 @@ class fulltext_search
 		if (empty($modSettings['search_simple_fulltext']))
 			foreach ($words['words'] as $regularWord)
 			{
-				$query_where[] = 'm.body' . (in_array($regularWord, $query_params['excluded_words']) ? ' NOT' : '') . (empty($modSettings['search_match_words']) || $no_regexp ? ' LIKE ' : 'RLIKE') . '{string:complex_body_' . $count . '}';
-				$query_params['complex_body_' . $count++] = empty($modSettings['search_match_words']) || $no_regexp ? '%' . strtr($regularWord, array('_' => '\\_', '%' => '\\%')) . '%' : '[[:<:]]' . addcslashes(preg_replace(array('/([\[\]$.+*?|{}()])/'), array('[$1]'), $regularWord), '\\\'') . '[[:>:]]';
+				$query_where[] = 'm.body' . (in_array($regularWord, $query_params['excluded_words']) ? ' NOT' : '') . (empty($modSettings['search_match_words']) || $search_data['no_regexp'] ? ' LIKE ' : 'RLIKE') . '{string:complex_body_' . $count . '}';
+				$query_params['complex_body_' . $count++] = empty($modSettings['search_match_words']) || $search_data['no_regexp'] ? '%' . strtr($regularWord, array('_' => '\\_', '%' => '\\%')) . '%' : '[[:<:]]' . addcslashes(preg_replace(array('/([\[\]$.+*?|{}()])/'), array('[$1]'), $regularWord), '\\\'') . '[[:>:]]';
 			}
 
 		if ($query_params['user_query'])
@@ -188,15 +188,15 @@ class fulltext_search
 		if (!empty($query_params['excluded_phrases']) && empty($modSettings['search_force_index']))
 			foreach ($query_params['excluded_phrases'] as $phrase)
 			{
-				$query_where[] = 'subject NOT ' . (empty($modSettings['search_match_words']) || $no_regexp ? ' LIKE ' : 'RLIKE') . '{string:exclude_subject_phrase_' . $count . '}';
-				$query_params['exclude_subject_phrase_' . $count++] = empty($modSettings['search_match_words']) || $no_regexp ? '%' . strtr($phrase, array('_' => '\\_', '%' => '\\%')) . '%' : '[[:<:]]' . addcslashes(preg_replace(array('/([\[\]$.+*?|{}()])/'), array('[$1]'), $phrase), '\\\'') . '[[:>:]]';
+				$query_where[] = 'subject NOT ' . (empty($modSettings['search_match_words']) || $search_data['no_regexp'] ? ' LIKE ' : 'RLIKE') . '{string:exclude_subject_phrase_' . $count . '}';
+				$query_params['exclude_subject_phrase_' . $count++] = empty($modSettings['search_match_words']) || $search_data['no_regexp'] ? '%' . strtr($phrase, array('_' => '\\_', '%' => '\\%')) . '%' : '[[:<:]]' . addcslashes(preg_replace(array('/([\[\]$.+*?|{}()])/'), array('[$1]'), $phrase), '\\\'') . '[[:>:]]';
 			}
 		$count = 0;
 		if (!empty($query_params['excluded_subject_words']) && empty($modSettings['search_force_index']))
 			foreach ($query_params['excluded_subject_words'] as $excludedWord)
 			{
-				$query_where[] = 'subject NOT ' . (empty($modSettings['search_match_words']) || $no_regexp ? ' LIKE ' : 'RLIKE') . '{string:exclude_subject_words_' . $count . '}';
-				$query_params['exclude_subject_words_' . $count++] = empty($modSettings['search_match_words']) || $no_regexp ? '%' . strtr($excludedWord, array('_' => '\\_', '%' => '\\%')) . '%' : '[[:<:]]' . addcslashes(preg_replace(array('/([\[\]$.+*?|{}()])/'), array('[$1]'), $excludedWord), '\\\'') . '[[:>:]]';
+				$query_where[] = 'subject NOT ' . (empty($modSettings['search_match_words']) || $search_data['no_regexp'] ? ' LIKE ' : 'RLIKE') . '{string:exclude_subject_words_' . $count . '}';
+				$query_params['exclude_subject_words_' . $count++] = empty($modSettings['search_match_words']) || $search_data['no_regexp'] ? '%' . strtr($excludedWord, array('_' => '\\_', '%' => '\\%')) . '%' : '[[:<:]]' . addcslashes(preg_replace(array('/([\[\]$.+*?|{}()])/'), array('[$1]'), $excludedWord), '\\\'') . '[[:>:]]';
 			}
 
 		if (!empty($modSettings['search_simple_fulltext']))
diff --git a/Sources/Security.php b/Sources/Security.php
index a6392b9..8d3aa10 100644
--- a/Sources/Security.php
+++ b/Sources/Security.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.3
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -101,7 +101,7 @@ if (!defined('SMF'))
 */
 
 // Check if the user is who he/she says he is
-function validateSession()
+function validateSession($force = false)
 {
 	global $modSettings, $sourcedir, $user_info, $sc, $user_settings;
 
@@ -112,7 +112,7 @@ function validateSession()
 	$refreshTime = isset($_GET['xml']) ? 4200 : 3600;
 
 	// Is the security option off?  Or are they already logged in?
-	if (!empty($modSettings['securityDisable']) || (!empty($_SESSION['admin_time']) && $_SESSION['admin_time'] + $refreshTime >= time()))
+	if (!$force && (!empty($modSettings['securityDisable']) || (!empty($_SESSION['admin_time']) && $_SESSION['admin_time'] + $refreshTime >= time())))
 		return;
 
 	require_once($sourcedir . '/Subs-Auth.php');
@@ -820,6 +820,11 @@ function allowedTo($permission, $boards = null)
 	if (empty($user_info))
 		return false;
 
+	// Calling this before permissions have not been set up properly?
+	// Assume a denial, since we don't know if you can do anything yet.
+	if (!isset($user_info['permissions']))
+		return false;
+
 	// Administrators are supermen :P.
 	if ($user_info['is_admin'])
 		return true;
diff --git a/Sources/SendTopic.php b/Sources/SendTopic.php
index 13accec..30db718 100644
--- a/Sources/SendTopic.php
+++ b/Sources/SendTopic.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.15
  */
 
 if (!defined('SMF'))
@@ -127,7 +127,7 @@ function SendTopic()
 		fatal_lang_error('no_name', false);
 	if (!isset($_POST['y_email']) || $_POST['y_email'] == '')
 		fatal_lang_error('no_email', false);
-	if (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $_POST['y_email']) == 0)
+	if (filter_var($_POST['y_email'], FILTER_VALIDATE_EMAIL) === false)
 		fatal_lang_error('email_invalid_character', false);
 
 	// The receiver should be valid to.
@@ -135,7 +135,7 @@ function SendTopic()
 		fatal_lang_error('no_name', false);
 	if (!isset($_POST['r_email']) || $_POST['r_email'] == '')
 		fatal_lang_error('no_email', false);
-	if (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $_POST['r_email']) == 0)
+	if (filter_var($_POST['r_email'], FILTER_VALIDATE_EMAIL) === false)
 		fatal_lang_error('email_invalid_character', false);
 
 	// Emails don't like entities...
@@ -244,7 +244,7 @@ function CustomEmail()
 				fatal_lang_error('no_name', false);
 			if (empty($_POST['y_email']))
 				fatal_lang_error('no_email', false);
-			if (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $_POST['y_email']) == 0)
+			if (filter_var($_POST['y_email'], FILTER_VALIDATE_EMAIL) === false)
 				fatal_lang_error('email_invalid_character', false);
 
 			$from_name = trim($_POST['y_name']);
@@ -385,7 +385,7 @@ function ReportToModerator2()
 		$_POST['email'] = !isset($_POST['email']) ? '' : trim($_POST['email']);
 		if ($_POST['email'] === '')
 			$post_errors[] = 'no_email';
-		elseif (preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,6})$~', $_POST['email']) == 0)
+		elseif (filter_var($_POST['email'], FILTER_VALIDATE_EMAIL) === false)
 			$post_errors[] = 'bad_email';
 
 		isBannedEmail($_POST['email'], 'cannot_post', sprintf($txt['you_are_post_banned'], $txt['guest_title']));
diff --git a/Sources/SplitTopics.php b/Sources/SplitTopics.php
index 89c8f7a..bca9f56 100644
--- a/Sources/SplitTopics.php
+++ b/Sources/SplitTopics.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.14
  */
 
 // Original module by Mach8 - We'll never forget you.
@@ -186,7 +186,7 @@ function SplitIndex()
 	// Basic template information....
 	$context['message'] = array(
 		'id' => $_GET['at'],
-		'subject' => $_REQUEST['subname']
+		'subject' => $smcFunc['htmlspecialchars']($_REQUEST['subname']),
 	);
 	$context['sub_template'] = 'ask';
 	$context['page_title'] = $txt['split'];
diff --git a/Sources/Stats.php b/Sources/Stats.php
index 91713f1..19b96bf 100644
--- a/Sources/Stats.php
+++ b/Sources/Stats.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.15
  */
 
 if (!defined('SMF'))
@@ -742,12 +742,20 @@ function SMStats()
 {
 	global $modSettings, $user_info, $forum_version, $sourcedir;
 
+	// Is this the old settings (upgrade failure)?
+	if (!empty($modSettings['allow_sm_stats']))
+	{
+		$modSettings['enable_sm_stats'] = 1;
+		$modSettings['sm_stats_key'] = $modSettings['allow_sm_stats'];
+		unset($modSettings['allow_sm_stats']);
+	}
+
 	// First, is it disabled?
-	if (empty($modSettings['allow_sm_stats']))
+	if (empty($modSettings['enable_sm_stats']) || empty($modSettings['sm_stats_key']))
 		die();
 
 	// Are we saying who we are, and are we right? (OR an admin)
-	if (!$user_info['is_admin'] && (!isset($_GET['sid']) || $_GET['sid'] != $modSettings['allow_sm_stats']))
+	if (!$user_info['is_admin'] && (!isset($_GET['sid']) || $_GET['sid'] != $modSettings['sm_stats_key']))
 		die();
 
 	// Verify the referer...
@@ -764,14 +772,14 @@ function SMStats()
 
 	// Get the actual stats.
 	$stats_to_send = array(
-		'UID' => $modSettings['allow_sm_stats'],
+		'UID' => $modSettings['sm_stats_key'],
 		'time_added' => time(),
 		'members' => $modSettings['totalMembers'],
 		'messages' => $modSettings['totalMessages'],
 		'topics' => $modSettings['totalTopics'],
 		'boards' => 0,
 		'php_version' => $serverVersions['php']['version'],
-		'database_type' => strtolower($serverVersions['db_server']['title']),
+		'database_type' => strtolower($serverVersions['db_engine']['version']),
 		'database_version' => $serverVersions['db_server']['version'],
 		'smf_version' => $forum_version,
 		'smfd_version' => $modSettings['smfVersion'],
@@ -798,9 +806,9 @@ function SMStats()
 			$out = 'POST /smf/stats/collect_stats.php HTTP/1.1' . "\r\n";
 			$out .= 'Host: www.simplemachines.org' . "\r\n";
 			$out .= 'Content-Type: application/x-www-form-urlencoded' . "\r\n";
+			$out .= 'Connection: Close' . "\r\n";
 			$out .= 'Content-Length: ' . $length . "\r\n\r\n";
 			$out .= $stats_to_send . "\r\n";
-			$out .= 'Connection: Close' . "\r\n\r\n";
 			fwrite($fp, $out);
 			fclose($fp);
 		}
diff --git a/Sources/Subs-Admin.php b/Sources/Subs-Admin.php
index 51dcc0e..b9f1994 100644
--- a/Sources/Subs-Admin.php
+++ b/Sources/Subs-Admin.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -76,6 +76,9 @@ function getServerVersions($checkFor)
 			trigger_error('getServerVersions(): you need to be connected to the database in order to get its server version', E_USER_NOTICE);
 		else
 		{
+			$versions['db_engine'] = array('title' => sprintf($txt['database_server'], $smcFunc['db_title']), 'version' => '');
+			$versions['db_engine']['version'] = $smcFunc['db_get_engine']();
+
 			$versions['db_server'] = array('title' => sprintf($txt['support_versions_db'], $smcFunc['db_title']), 'version' => '');
 			$versions['db_server']['version'] = $smcFunc['db_get_version']();
 		}
@@ -322,51 +325,7 @@ function updateSettingsFile($config_vars)
 	if (count($settingsArray) < 12)
 		return;
 
-	// Try to avoid a few pitfalls:
-	// like a possible race condition,
-	// or a failure to write at low diskspace
-
-	// Check before you act: if cache is enabled, we can do a simple test
-	// Can we even write things on this filesystem?
-	if ((empty($cachedir) || !file_exists($cachedir)) && file_exists($boarddir . '/cache'))
-		$cachedir = $boarddir . '/cache';
-	$test_fp = @fopen($cachedir . '/settings_update.tmp', "w+");
-	if ($test_fp)
-	{
-		fclose($test_fp);
-
-		$test_fp = @fopen($cachedir . '/settings_update.tmp', 'r+');
-		$written_bytes = fwrite($test_fp, "test");
-		fclose($test_fp);
-		@unlink($cachedir . '/settings_update.tmp');
-
-		if ($written_bytes !== strlen("test"))
-		{
-			// Oops. Low disk space, perhaps. Don't mess with Settings.php then.
-			// No means no. :P
-			return;
-		}
-	}
-
-	// Protect me from what I want! :P
-	clearstatcache();
-	if (filemtime($boarddir . '/Settings.php') === $last_settings_change)
-	{
-		// You asked for it...
-		// Blank out the file - done to fix a oddity with some servers.
-		$fp = @fopen($boarddir . '/Settings.php', 'w');
-
-		// Is it even writable, though?
-		if ($fp)
-		{
-			fclose($fp);
-
-			$fp = fopen($boarddir . '/Settings.php', 'r+');
-			foreach ($settingsArray as $line)
-				fwrite($fp, strtr($line, "\r", ''));
-			fclose($fp);
-		}
-	}
+	safe_file_write($boarddir . '/Settings.php', strtr(implode('', $settingsArray), "\r", ''), $boarddir . '/Settings_bak.php', $last_settings_change);
 }
 
 function updateAdminPreferences()
@@ -514,13 +473,15 @@ function updateLastDatabaseError()
 	$data = preg_replace('~\$db_last_error = \d+;~', '$db_last_error = ' . time() . ';', $data);
 
 	// Open the backup file for writing
-	if ($fp = @fopen($file, 'w'))
+	if ($fp = @fopen($file, 'c'))
 	{
 		// Reset the file buffer.
 		set_file_buffer($fp, 0);
 
 		// Update the file.
 		$t = flock($fp, LOCK_EX);
+		ftruncate($fp, 0);
+		rewind($fp);
 		$bytes = fwrite($fp, $data);
 		flock($fp, LOCK_UN);
 		fclose($fp);
@@ -547,4 +508,228 @@ function updateLastDatabaseError()
 	return false;
 }
 
+/**
+ * Writes data to a file, optionally making a backup, while avoiding race conditions.
+ *
+ * @param string $file The filepath of the file where the data should be written.
+ * @param string $data The data to be written to $file.
+ * @param string $backup_file The filepath where the backup should be saved. Default null.
+ * @param int $mtime If modification time of $file is more recent than this Unix timestamp, the write operation will abort. Defaults to time that the script started execution.
+ * @param bool $append If true, the data will be appended instead of overwriting the existing content of the file. Default false.
+ * @return bool Whether the write operation succeeded or not.
+ */
+function safe_file_write($file, $data, $backup_file = null, $mtime = null, $append = false)
+{
+	// Sanity checks.
+	if (!file_exists($file) && !is_dir(dirname($file)))
+		return false;
+
+	if (!is_int($mtime))
+		$mtime = $_SERVER['REQUEST_TIME'];
+
+	$temp_dir = sm_temp_dir();
+
+	// Our temp files.
+	$temp_sfile = tempnam($temp_dir, pathinfo($file, PATHINFO_FILENAME) . '.');
+
+	if (!empty($backup_file))
+		$temp_bfile = tempnam($temp_dir, pathinfo($backup_file, PATHINFO_FILENAME) . '.');
+
+	// We need write permissions.
+	$failed = false;
+	foreach (array($file, $backup_file) as $sf)
+	{
+		if (empty($sf))
+			continue;
+
+		if (!file_exists($sf))
+			touch($sf);
+		elseif (!is_file($sf))
+			$failed = true;
+
+		if (!$failed && !is_writable($sf))
+		{
+			foreach (array(0644, 0664, 0666) as $mode)
+			{
+				$failed = !@chmod($sf, $mode);
+				if (!$failed)
+					break;
+			}
+		}
+	}
+
+	// Now let's see if writing to a temp file succeeds.
+	if (!$failed && file_put_contents($temp_sfile, $data, LOCK_EX) !== strlen($data))
+		$failed = true;
+
+	// Tests passed, so it's time to do the job.
+	if (!$failed)
+	{
+		// Back up the backup, just in case.
+		if (file_exists($backup_file))
+			$temp_bfile_saved = @copy($backup_file, $temp_bfile);
+
+		// Make sure no one changed the file while we weren't looking.
+		clearstatcache();
+		if (filemtime($file) <= $mtime)
+		{
+			// Attempt to open the file.
+			$sfhandle = @fopen($file, 'c');
+
+			// Let's do this thing!
+			if ($sfhandle !== false)
+			{
+				// Immediately get a lock.
+				flock($sfhandle, LOCK_EX);
+
+				// Make sure the backup works before we do anything more.
+				$temp_sfile_saved = @copy($file, $temp_sfile);
+
+				// Now write our data to the file.
+				if ($temp_sfile_saved)
+				{
+					if (empty($append))
+					{
+						ftruncate($sfhandle, 0);
+						rewind($sfhandle);
+					}
+
+					$failed = fwrite($sfhandle, $data) !== strlen($data);
+				}
+				else
+					$failed = true;
+
+				// If writing failed, put everything back the way it was.
+				if ($failed)
+				{
+					if (!empty($temp_sfile_saved))
+						@rename($temp_sfile, $file);
+
+					if (!empty($temp_bfile_saved))
+						@rename($temp_bfile, $backup_file);
+				}
+				// It worked, so make our temp backup the new permanent backup.
+				elseif (!empty($backup_file))
+					@rename($temp_sfile, $backup_file);
+
+				// And we're done.
+				flock($sfhandle, LOCK_UN);
+				fclose($sfhandle);
+			}
+		}
+	}
+
+	// We're done with these.
+	@unlink($temp_sfile);
+	@unlink($temp_bfile);
+
+	if ($failed)
+		return false;
+
+	// Even though on normal installations the filemtime should invalidate any cached version
+	// it seems that there are times it might not. So let's MAKE it dump the cache.
+	if (function_exists('opcache_invalidate'))
+		opcache_invalidate($file, true);
+
+	return true;
+}
+
+/**
+ * Locates the most appropriate temp directory.
+ *
+ * Systems using `open_basedir` restrictions may receive errors with
+ * `sys_get_temp_dir()` due to misconfigurations on servers. Other
+ * cases sys_temp_dir may not be set to a safe value. Additionally
+ * `sys_get_temp_dir` may use a readonly directory. This attempts to
+ * find a working temp directory that is accessible under the
+ * restrictions and is writable to the web service account.
+ *
+ * Directories checked against `open_basedir`:
+ *
+ * - `sys_get_temp_dir()`
+ * - `upload_tmp_dir`
+ * - `session.save_path`
+ * - `cachedir`
+ *
+ * @return string
+*/
+function sm_temp_dir()
+{
+	global $cachedir;
+
+	static $temp_dir = null;
+
+	// Already did this.
+	if (!empty($temp_dir))
+		return $temp_dir;
+
+	// Temp Directory options order.
+	$temp_dir_options = array(
+		0 => 'sys_get_temp_dir',
+		1 => 'upload_tmp_dir',
+		2 => 'session.save_path',
+		3 => 'cachedir'
+	);
+
+	// Determine if we should detect a restriction and what restrictions that may be.
+	$open_base_dir = ini_get('open_basedir');
+	$restriction = !empty($open_base_dir) ? explode(':', $open_base_dir) : false;
+
+	// Prevent any errors as we search.
+	$old_error_reporting = error_reporting(0);
+
+	// Search for a working temp directory.
+	foreach ($temp_dir_options as $id_temp => $temp_option)
+	{
+		switch ($temp_option) {
+			case 'cachedir':
+				$possible_temp = rtrim($cachedir, '/');
+				break;
+
+			case 'session.save_path':
+				$possible_temp = rtrim(ini_get('session.save_path'), '/');
+				break;
+
+			case 'upload_tmp_dir':
+				$possible_temp = rtrim(ini_get('upload_tmp_dir'), '/');
+				break;
+
+			default:
+				$possible_temp = sys_get_temp_dir();
+				break;
+		}
+
+		// Check if we have a restriction preventing this from working.
+		if ($restriction)
+		{
+			foreach ($restriction as $dir)
+			{
+				if (strpos($possible_temp, $dir) !== false && is_writable($possible_temp))
+				{
+					$temp_dir = $possible_temp;
+					break;
+				}
+			}
+		}
+		// No restrictions, but need to check for writable status.
+		elseif (is_writable($possible_temp))
+		{
+			$temp_dir = $possible_temp;
+			break;
+		}
+	}
+
+	// Fall back to sys_get_temp_dir even though it won't work, so we have something.
+	if (empty($temp_dir))
+		$temp_dir = sys_get_temp_dir();
+
+	// Fix the path.
+	$temp_dir = substr($temp_dir, -1) === '/' ? $temp_dir : $temp_dir . '/';
+
+	// Put things back.
+	error_reporting($old_error_reporting);
+
+	return $temp_dir;
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/Subs-Auth.php b/Sources/Subs-Auth.php
index f1a2dfa..34a7953 100644
--- a/Sources/Subs-Auth.php
+++ b/Sources/Subs-Auth.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.11
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -102,7 +102,7 @@ if (!defined('SMF'))
 // Actually set the login cookie...
 function setLoginCookie($cookie_length, $id, $password = '')
 {
-	global $cookiename, $boardurl, $modSettings;
+	global $cookiename, $cookie_no_auth_secret, $boardurl, $modSettings;
 
 	// If changing state force them to re-address some permission caching.
 	$_SESSION['mc']['time'] = 0;
@@ -121,6 +121,11 @@ function setLoginCookie($cookie_length, $id, $password = '')
 		}
 	}
 
+	// Ensure the cookie can't be forged.
+	// Note: $cookie_no_auth_secret is a fallback that will be removed in future versions!
+	if ($password !== '' && empty($cookie_no_auth_secret))
+		$password = hash_hmac('sha1', $password, get_auth_secret());
+
 	// Get the data and path to set it on.
 	$data = serialize(empty($id) ? array(0, '', 0) : array($id, $password, time() + $cookie_length, $cookie_state));
 	$cookie_url = url_parts(!empty($modSettings['localCookies']), !empty($modSettings['globalCookies']));
@@ -360,6 +365,7 @@ function findMembers($names, $use_wildcards = false, $buddies_only = false, $max
 		$names = explode(',', $names);
 
 	$maybe_email = false;
+	$names_list = array();
 	foreach ($names as $i => $name)
 	{
 		// Trim, and fix wildcards for each name.
@@ -372,6 +378,9 @@ function findMembers($names, $use_wildcards = false, $buddies_only = false, $max
 			$names[$i] = strtr($names[$i], array('%' => '\%', '_' => '\_', '*' => '%', '?' => '_', '\'' => '&#039;'));
 		else
 			$names[$i] = strtr($names[$i], array('\'' => '&#039;'));
+
+		$names_list[] = '{string:lookup_name_' . $i . '}';
+		$where_params['lookup_name_' . $i] = $names[$i];
 	}
 
 	// What are we using to compare?
@@ -393,22 +402,23 @@ function findMembers($names, $use_wildcards = false, $buddies_only = false, $max
 	$member_name = $smcFunc['db_case_sensitive'] ? 'LOWER(member_name)' : 'member_name';
 	$real_name = $smcFunc['db_case_sensitive'] ? 'LOWER(real_name)' : 'real_name';
 
+	// Searches.
+	$member_name_search = $member_name . ' ' . $comparison . ' ' . implode( ' OR ' . $member_name . ' ' . $comparison . ' ', $names_list);
+	$real_name_search = $real_name . ' ' . $comparison . ' ' . implode( ' OR ' . $real_name . ' ' . $comparison . ' ', $names_list);
+
 	// Search by username, display name, and email address.
 	$request = $smcFunc['db_query']('', '
 		SELECT id_member, member_name, real_name, email_address, hide_email
 		FROM {db_prefix}members
-		WHERE ({raw:member_name_search}
-			OR {raw:real_name_search} {raw:email_condition})
+		WHERE (' . $member_name_search . '
+			OR ' . $real_name_search . ' ' . $email_condition . ')
 			' . ($buddies_only ? 'AND id_member IN ({array_int:buddy_list})' : '') . '
 			AND is_activated IN (1, 11)
 		LIMIT {int:limit}',
-		array(
+		array_merge($where_params, array(
 			'buddy_list' => $user_info['buddies'],
-			'member_name_search' => $member_name . ' ' . $comparison . ' \'' . implode( '\' OR ' . $member_name . ' ' . $comparison . ' \'', $names) . '\'',
-			'real_name_search' => $real_name . ' ' . $comparison . ' \'' . implode( '\' OR ' . $real_name . ' ' . $comparison . ' \'', $names) . '\'',
-			'email_condition' => $email_condition,
 			'limit' => $max,
-		)
+		))
 	);
 	while ($row = $smcFunc['db_fetch_assoc']($request))
 	{
@@ -531,7 +541,8 @@ function RequestMembers()
 
 		if (preg_match('~&#\d+;~', $row['real_name']) != 0)
 		{
-			$fixchar = create_function('$n', '
+			$fixchar = function($n)
+			{
 				if ($n < 128)
 					return chr($n);
 				elseif ($n < 2048)
@@ -539,7 +550,8 @@ function RequestMembers()
 				elseif ($n < 65536)
 					return chr(224 | $n >> 12) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);
 				else
-					return chr(240 | $n >> 18) . chr(128 | $n >> 12 & 63) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);');
+					return chr(240 | $n >> 18) . chr(128 | $n >> 12 & 63) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);
+			};
 
 			$row['real_name'] = preg_replace_callback('~&#(\d+);~', 'fixchar__callback', $row['real_name']);
 		}
diff --git a/Sources/Subs-BoardIndex.php b/Sources/Subs-BoardIndex.php
index ab18d7e..e4dc5dd 100644
--- a/Sources/Subs-BoardIndex.php
+++ b/Sources/Subs-BoardIndex.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -87,7 +87,7 @@ function getBoardIndex($boardIndexOptions)
 	// Find all boards and categories, as well as related information.  This will be sorted by the natural order of boards and categories, which we control.
 	$result_boards = $smcFunc['db_query']('boardindex_fetch_boards', '
 		SELECT' . ($boardIndexOptions['include_categories'] ? '
-			c.id_cat, c.name AS cat_name,' : '') . '
+			c.id_cat, c.name AS cat_name, cat_order,' : '') . '
 			b.id_board, b.name AS board_name, b.description,
 			CASE WHEN b.redirect != {string:blank_string} THEN 1 ELSE 0 END AS is_redirect,
 			b.num_posts, b.num_topics, b.unapproved_posts, b.unapproved_topics, b.id_parent,
@@ -140,6 +140,7 @@ function getBoardIndex($boardIndexOptions)
 				$categories[$row_board['id_cat']] = array(
 					'id' => $row_board['id_cat'],
 					'name' => $row_board['cat_name'],
+					'order' => $row_board['cat_order'],
 					'is_collapsed' => isset($row_board['can_collapse']) && $row_board['can_collapse'] == 1 && $row_board['is_collapsed'] > 0,
 					'can_collapse' => isset($row_board['can_collapse']) && $row_board['can_collapse'] == 1,
 					'collapse_href' => isset($row_board['can_collapse']) ? $scripturl . '?action=collapse;c=' . $row_board['id_cat'] . ';sa=' . ($row_board['is_collapsed'] > 0 ? 'expand;' : 'collapse;') . (isset($context['single_cats']) ? 'c_redirect=' . (is_array($_REQUEST['c']) ? implode(',', $_REQUEST['c']) : $_REQUEST['c']) . ';' : '') . $context['session_var'] . '=' . $context['session_id'] . '#c' . $row_board['id_cat'] : '',
@@ -366,7 +367,21 @@ function getBoardIndex($boardIndexOptions)
 	if (!empty($boardIndexOptions['set_latest_post']) && !empty($latest_post['ref']))
 		$context['latest_post'] = $latest_post['ref'];
 
+	// Sort the categories, maintaining index association.
+	// Don't do it in the query, that would use a temporary table and be very slow.
+	if ($boardIndexOptions['include_categories'])
+		uasort($categories, 'cmpBoardIndex');
+
 	return $boardIndexOptions['include_categories'] ? $categories : $this_category;
 }
 
+function cmpBoardIndex($a, $b)
+{
+	if ($a['order'] == $b['order'])
+	{
+		return 0;
+	}
+	return ($a['order'] < $b['order']) ? -1 : 1;
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/Subs-Boards.php b/Sources/Subs-Boards.php
index 5500dc1..9f2ff14 100644
--- a/Sources/Subs-Boards.php
+++ b/Sources/Subs-Boards.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.15
  */
 
 if (!defined('SMF'))
@@ -415,7 +415,7 @@ function MarkRead()
 			);
 			if ($smcFunc['db_num_rows']($result) > 0)
 			{
-				$logBoardInserts = '';
+				$logBoardInserts = array();
 				while ($row = $smcFunc['db_fetch_assoc']($result))
 					$logBoardInserts[] = array($modSettings['maxMsgID'], $user_info['id'], $row['id_board']);
 
diff --git a/Sources/Subs-Compat.php b/Sources/Subs-Compat.php
index 0810058..3ad9d7e 100644
--- a/Sources/Subs-Compat.php
+++ b/Sources/Subs-Compat.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -97,7 +97,7 @@ function sha1_smf($str)
 	$blks = array_pad(array(), $nblk * 16, 0);
 
 	for ($i = 0; $i < strlen($str); $i++)
-		$blks[$i >> 2] |= ord($str{$i}) << (24 - ($i % 4) * 8);
+		$blks[$i >> 2] |= ord($str[$i]) << (24 - ($i % 4) * 8);
 
 	$blks[$i >> 2] |= 0x80 << (24 - ($i % 4) * 8);
 
diff --git a/Sources/Subs-Db-mysql.php b/Sources/Subs-Db-mysql.php
index 6db12a6..602acc2 100644
--- a/Sources/Subs-Db-mysql.php
+++ b/Sources/Subs-Db-mysql.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.9
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -24,7 +24,17 @@ if (!defined('SMF'))
 // Initialize the database settings
 function smf_db_initiate($db_server, $db_name, $db_user, $db_passwd, $db_prefix, $db_options = array())
 {
-	global $smcFunc, $mysql_set_mode;
+	global $smcFunc, $mysql_set_mode, $sourcedir;
+
+	// Check for MySQLi first...
+	// !!! This driver does not work on PHP < 5.4.0.
+	if (function_exists('mysqli_connect') && version_compare(PHP_VERSION, '5.4') >= 0)
+	{
+		$db = new SMF_DB_MySQLi;
+
+		// Delegate control over to the new database driver.
+		return $db->initiate($db_server, $db_name, $db_user, $db_passwd, $db_prefix, $db_options);
+	}
 
 	// Map some database specific functions, only do this once.
 	if (!isset($smcFunc['db_fetch_assoc']) || $smcFunc['db_fetch_assoc'] != 'mysql_fetch_assoc')
@@ -50,6 +60,8 @@ function smf_db_initiate($db_server, $db_name, $db_user, $db_passwd, $db_prefix,
 			'db_sybase' => false,
 			'db_case_sensitive' => false,
 			'db_escape_wildcard_string' => 'smf_db_escape_wildcard_string',
+			'db_connect_error' => 'mysql_connect_error',
+			'db_connect_errno' => 'mysql_connect_errno',
 		);
 
 	if (!empty($db_options['persist']))
@@ -230,7 +242,13 @@ function smf_db_quote($db_string, $db_values, $connection = null)
 function smf_db_query($identifier, $db_string, $db_values = array(), $connection = null)
 {
 	global $db_cache, $db_count, $db_connection, $db_show_debug, $time_start;
-	global $db_unbuffered, $db_callback, $modSettings;
+	global $db_unbuffered, $db_callback, $modSettings, $smcFunc;
+
+	// Check for MySQLi first...
+	// !!! This driver does not work on PHP < 5.4.0.
+	// !!! This passthrough is needed for the search functions.
+	if (function_exists('mysqli_connect') && version_compare(PHP_VERSION, '5.4') >= 0)
+		return $smcFunc['db_query']($identifier, $db_string, $db_values, $connection);
 
 	// Comments that are allowed in a query are preg_removed.
 	static $allowed_comments_from = array(
@@ -617,7 +635,7 @@ function smf_db_error($db_string, $connection = null)
 }
 
 // Insert some data...
-function smf_db_insert($method = 'replace', $table, $columns, $data, $keys, $disable_trans = false, $connection = null)
+function smf_db_insert($method, $table, $columns, $data, $keys, $disable_trans = false, $connection = null)
 {
 	global $smcFunc, $db_connection, $db_prefix;
 
@@ -734,4 +752,847 @@ function smf_db_escape_wildcard_string($string, $translate_human_wildcards=false
 
 	return strtr($string, $replacements);
 }
+class SMF_DB_MySQLi
+{
+	/**
+	 *  Maps the implementations in this file ($this->function_name)
+	 *  to the $smcFunc['db_function_name'] variable.
+	 *
+	 * @param string $db_server
+	 * @param string $db_name
+	 * @param string $db_user
+	 * @param string $db_passwd
+	 * @param string $db_prefix
+	 * @param array $db_options
+	 * @return null
+	 */
+	public function initiate($db_server, $db_name, $db_user, $db_passwd, $db_prefix, $db_options = array())
+	{
+		global $smcFunc, $mysql_set_mode;
+
+		// Map some database specific functions, only do this once.
+		if (!isset($smcFunc['db_fetch_assoc']) || $smcFunc['db_fetch_assoc'] != 'mysqli_fetch_assoc')
+			$smcFunc += array(
+				'db_query'                  => array($this, 'query'),
+				'db_quote'                  => array($this, 'quote'),
+				'db_fetch_assoc'            => 'mysqli_fetch_assoc',
+				'db_fetch_row'              => 'mysqli_fetch_row',
+				'db_free_result'            => 'mysqli_free_result',
+				'db_insert'                 => array($this, 'insert'),
+				'db_insert_id'              => array($this, 'insert_id'),
+				'db_num_rows'               => 'mysqli_num_rows',
+				'db_data_seek'              => 'mysqli_data_seek',
+				'db_num_fields'             => 'mysqli_num_fields',
+				'db_escape_string'          => 'addslashes',
+				'db_unescape_string'        => 'stripslashes',
+				'db_server_info'            => array($this, 'get_server_info'),
+				'db_affected_rows'          => array($this, 'affected_rows'),
+				'db_transaction'            => array($this, 'transaction'),
+				'db_error'                  => array($this, 'show_error'),
+				'db_select_db'              => array($this, 'select'),
+				'db_title'                  => 'MySQL',
+				'db_sybase'                 => false,
+				'db_case_sensitive'         => false,
+				'db_escape_wildcard_string' => array($this, 'escape_wildcard_string'),
+				'db_connect_error'          => 'mysqli_connect_error',
+				'db_connect_errno'          => 'mysqli_connect_errno',
+			);
+
+		// This was the default prior to PHP 8.1, and all our code assumes it.
+		mysqli_report(MYSQLI_REPORT_OFF);
+
+		if (!empty($db_options['persist']))
+			$connection = @mysqli_connect('p:' . $db_server, $db_user, $db_passwd);
+		else
+			$connection = @mysqli_connect($db_server, $db_user, $db_passwd);
+
+		// Something's wrong, show an error if its fatal (which we assume it is)
+		if (!$connection)
+		{
+			if (!empty($db_options['non_fatal']))
+				return null;
+			else
+				db_fatal_error();
+		}
+
+		// Select the database, unless told not to
+		if (empty($db_options['dont_select_db']) && !@mysqli_select_db($connection, $db_name) && empty($db_options['non_fatal']))
+			db_fatal_error();
+
+		// This makes it possible to have SMF automatically change the sql_mode and autocommit if needed.
+		if (isset($mysql_set_mode) && $mysql_set_mode === true)
+			$smcFunc['db_query']('', 'SET sql_mode = \'\', AUTOCOMMIT = 1',
+			array(),
+			$connection
+		);
+
+		return $connection;
+	}
+
+	/**
+	 * Wrap mysqli_select_db so the connection does not need to be specified
+	 *
+	 * @param string &database
+	 * @param object $connection
+	 */
+	public function select($database, $connection = null)
+	{
+		global $db_connection;
+
+		return mysqli_select_db($connection === null ? $db_connection : $connection, $database);
+	}
+
+	/**
+	 * Wrap mysqli_get_server_info so the connection does not need to be specified
+	 *
+	 * @param object $connection
+	 */
+	public function get_server_info($connection = null)
+	{
+		global $db_connection;
+
+		return mysqli_get_server_info($connection === null ? $db_connection : $connection);
+	}
+
+	/**
+	 * Callback for preg_replace_callback on the query.
+	 * It allows to replace on the fly a few pre-defined strings, for convenience ('query_see_board', 'query_wanna_see_board'), with
+	 * their current values from $user_info.
+	 * In addition, it performs checks and sanitization on the values sent to the database.
+	 *
+	 * @param $matches
+	 */
+	private function replacement__callback($matches)
+	{
+		global $db_callback, $user_info, $db_prefix;
+
+		list ($values, $connection) = $db_callback;
+		if (!is_object($connection))
+			db_fatal_error();
+
+		if ($matches[1] === 'db_prefix')
+			return $db_prefix;
+
+		if ($matches[1] === 'query_see_board')
+			return $user_info['query_see_board'];
+
+		if ($matches[1] === 'query_wanna_see_board')
+			return $user_info['query_wanna_see_board'];
+
+		if (!isset($matches[2]))
+			$this->error_backtrace('Invalid value inserted or no type specified.', '', E_USER_ERROR, __FILE__, __LINE__);
+
+		if (!isset($values[$matches[2]]))
+			$this->error_backtrace('The database value you\'re trying to insert does not exist: ' . htmlspecialchars($matches[2]), '', E_USER_ERROR, __FILE__, __LINE__);
+
+		$replacement = $values[$matches[2]];
+
+		switch ($matches[1])
+		{
+			case 'int':
+				if (!is_numeric($replacement) || (string) $replacement !== (string) (int) $replacement)
+					$this->error_backtrace('Wrong value type sent to the database. Integer expected. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+				return (string) (int) $replacement;
+			break;
+
+			case 'string':
+			case 'text':
+				return sprintf('\'%1$s\'', mysqli_real_escape_string($connection, $replacement));
+			break;
+
+			case 'array_int':
+				if (is_array($replacement))
+				{
+					if (empty($replacement))
+						$this->error_backtrace('Database error, given array of integer values is empty. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+
+					foreach ($replacement as $key => $value)
+					{
+						if (!is_numeric($value) || (string) $value !== (string) (int) $value)
+							$this->error_backtrace('Wrong value type sent to the database. Array of integers expected. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+
+						$replacement[$key] = (string) (int) $value;
+					}
+
+					return implode(', ', $replacement);
+				}
+				else
+					$this->error_backtrace('Wrong value type sent to the database. Array of integers expected. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+
+			break;
+
+			case 'array_string':
+				if (is_array($replacement))
+				{
+					if (empty($replacement))
+						$this->error_backtrace('Database error, given array of string values is empty. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+
+					foreach ($replacement as $key => $value)
+						$replacement[$key] = sprintf('\'%1$s\'', mysqli_real_escape_string($connection, $value));
+
+					return implode(', ', $replacement);
+				}
+				else
+					$this->error_backtrace('Wrong value type sent to the database. Array of strings expected. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+			break;
+
+			case 'date':
+				if (preg_match('~^(\d{4})-([0-1]?\d)-([0-3]?\d)$~', $replacement, $date_matches) === 1)
+					return sprintf('\'%04d-%02d-%02d\'', $date_matches[1], $date_matches[2], $date_matches[3]);
+				else
+					$this->error_backtrace('Wrong value type sent to the database. Date expected. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+			break;
+
+			case 'float':
+				if (!is_numeric($replacement))
+					$this->error_backtrace('Wrong value type sent to the database. Floating point number expected. (' . $matches[2] . ')', '', E_USER_ERROR, __FILE__, __LINE__);
+				return (string) (float) $replacement;
+			break;
+
+			case 'identifier':
+				// Backticks inside identifiers are supported as of MySQL 4.1. We don't need them for SMF.
+				return '`' . strtr($replacement, array('`' => '', '.' => '')) . '`';
+			break;
+
+			case 'raw':
+				return $replacement;
+			break;
+
+			default:
+				$this->error_backtrace('Undefined type used in the database query. (' . $matches[1] . ':' . $matches[2] . ')', '', false, __FILE__, __LINE__);
+			break;
+		}
+	}
+
+	/**
+	 * Just like the db_query, escape and quote a string, but not executing the query.
+	 *
+	 * @param string $db_string
+	 * @param array $db_values
+	 * @param object $connection = null
+	 */
+	public function quote($db_string, $db_values, $connection = null)
+	{
+		global $db_callback, $db_connection;
+
+		// Only bother if there's something to replace.
+		if (strpos($db_string, '{') !== false)
+		{
+			// This is needed by the callback function.
+			$db_callback = array($db_values, $connection === null ? $db_connection : $connection);
+
+			// Do the quoting and escaping
+			$db_string = preg_replace_callback('~{([a-z_]+)(?::([a-zA-Z0-9_-]+))?}~', array($this, 'replacement__callback'), $db_string);
+
+			// Clear this global variable.
+			$db_callback = array();
+		}
+
+		return $db_string;
+	}
+
+	/**
+	 * Do a query.  Takes care of errors too.
+	 *
+	 * @param string $identifier
+	 * @param string $db_string
+	 * @param array $db_values = array()
+	 * @param object $connection = null
+	 */
+	public function query($identifier, $db_string, $db_values = array(), $connection = null)
+	{
+		global $db_cache, $db_count, $db_connection, $db_show_debug, $time_start;
+		global $db_unbuffered, $db_persist, $db_callback, $modSettings;
+
+		// Comments that are allowed in a query are preg_removed.
+		static $allowed_comments_from = array(
+			'~\s+~s',
+			'~/\*!40001 SQL_NO_CACHE \*/~',
+			'~/\*!40000 USE INDEX \([A-Za-z\_]+?\) \*/~',
+			'~/\*!40100 ON DUPLICATE KEY UPDATE id_msg = \d+ \*/~',
+		);
+		static $allowed_comments_to = array(
+			' ',
+			'',
+			'',
+			'',
+		);
+
+		// Decide which connection to use.
+		$connection = $connection === null ? $db_connection : $connection;
+
+		// Special queries that need processing.
+		$replacements = array(
+			'alter_table_boards' => array(
+				'~(.+)~' => '',
+			),
+			'boardindex_fetch_boards' => array(
+				'~(.)$~' => '$1 ORDER BY b.board_order',
+			),
+			'messageindex_fetch_boards' => array(
+				'~(.)$~' => '$1 ORDER BY b.board_order',
+			),
+			'order_by_board_order' => array(
+				'~(.)$~' => '$1 ORDER BY b.board_order',
+			),
+		);
+
+		if (isset($replacements[$identifier]))
+			$db_string = preg_replace(array_keys($replacements[$identifier]), array_values($replacements[$identifier]), $db_string);
+
+		if (trim($db_string) == '')
+			return false;
+
+		// Get a connection if we are shutting down, sometimes the link is closed before sessions are written
+		if (!is_object($connection))
+		{
+			global $db_server, $db_user, $db_passwd, $db_name, $db_show_debug, $ssi_db_user, $ssi_db_passwd;
+
+			// Are we in SSI mode?  If so try that username and password first
+			if (SMF == 'SSI' && !empty($ssi_db_user) && !empty($ssi_db_passwd))
+			{
+				if (empty($db_persist))
+					$db_connection = @mysqli_connect($db_server, $ssi_db_user, $ssi_db_passwd);
+				else
+					$db_connection = @mysqli_connect('p:' . $db_server, $ssi_db_user, $ssi_db_passwd);
+			}
+			// Fall back to the regular username and password if need be
+			if (!$db_connection)
+			{
+				if (empty($db_persist))
+					$db_connection = @mysqli_connect($db_server, $db_user, $db_passwd);
+				else
+					$db_connection = @mysqli_connect('p:' . $db_server, $db_user, $db_passwd);
+			}
+
+			if (!$db_connection || !@mysqli_select_db($db_connection, $db_name))
+				$db_connection = false;
+
+			$connection = $db_connection;
+		}
+
+		// One more query....
+		$db_count = !isset($db_count) ? 1 : $db_count + 1;
+
+		if (empty($modSettings['disableQueryCheck']) && strpos($db_string, '\'') !== false && empty($db_values['security_override']))
+			$this->error_backtrace('Hacking attempt...', 'Illegal character (\') used in query...', true, __FILE__, __LINE__);
+
+		// Use "ORDER BY null" to prevent Mysql doing filesorts for Group By clauses without an Order By
+		if (strpos($db_string, 'GROUP BY') !== false && strpos($db_string, 'ORDER BY') === false && preg_match('~^\s+SELECT~i', $db_string))
+		{
+			// Add before LIMIT
+			if ($pos = strpos($db_string, 'LIMIT '))
+				$db_string = substr($db_string, 0, $pos) . "\t\t\tORDER BY null\n" . substr($db_string, $pos, strlen($db_string));
+			else
+				// Append it.
+				$db_string .= "\n\t\t\tORDER BY null";
+		}
+
+		if (empty($db_values['security_override']) && (!empty($db_values) || strpos($db_string, '{db_prefix}') !== false))
+		{
+			// Pass some values to the global space for use in the callback function.
+			$db_callback = array($db_values, $connection);
+
+			// Inject the values passed to this function.
+			$db_string = preg_replace_callback('~{([a-z_]+)(?::([a-zA-Z0-9_-]+))?}~', array($this, 'replacement__callback'), $db_string);
+
+			// This shouldn't be residing in global space any longer.
+			$db_callback = array();
+		}
+
+		// Debugging.
+		if (isset($db_show_debug) && $db_show_debug === true)
+		{
+			// Get the file and line number this function was called.
+			list ($file, $line) = $this->error_backtrace('', '', 'return', __FILE__, __LINE__);
+
+			// Initialize $db_cache if not already initialized.
+			if (!isset($db_cache))
+				$db_cache = array();
+
+			if (!empty($_SESSION['debug_redirect']))
+			{
+				$db_cache = array_merge($_SESSION['debug_redirect'], $db_cache);
+				$db_count = count($db_cache) + 1;
+				$_SESSION['debug_redirect'] = array();
+			}
+
+			// Don't overload it.
+			$st = microtime();
+			$db_cache[$db_count]['q'] = $db_count < 50 ? $db_string : '...';
+			$db_cache[$db_count]['f'] = $file;
+			$db_cache[$db_count]['l'] = $line;
+			$db_cache[$db_count]['s'] = array_sum(explode(' ', $st)) - array_sum(explode(' ', $time_start));
+		}
+
+		// First, we clean strings out of the query, reduce whitespace, lowercase, and trim - so we can check it over.
+		if (empty($modSettings['disableQueryCheck']))
+		{
+			$clean = '';
+			$old_pos = 0;
+			$pos = -1;
+			while (true)
+			{
+				$pos = strpos($db_string, '\'', $pos + 1);
+				if ($pos === false)
+					break;
+				$clean .= substr($db_string, $old_pos, $pos - $old_pos);
+
+				while (true)
+				{
+					$pos1 = strpos($db_string, '\'', $pos + 1);
+					$pos2 = strpos($db_string, '\\', $pos + 1);
+					if ($pos1 === false)
+						break;
+					elseif ($pos2 == false || $pos2 > $pos1)
+					{
+						$pos = $pos1;
+						break;
+					}
+
+					$pos = $pos2 + 1;
+				}
+				$clean .= ' %s ';
+
+				$old_pos = $pos + 1;
+			}
+			$clean .= substr($db_string, $old_pos);
+			$clean = trim(strtolower(preg_replace($allowed_comments_from, $allowed_comments_to, $clean)));
+
+			// We don't use UNION in SMF, at least so far.  But it's useful for injections.
+			if (strpos($clean, 'union') !== false && preg_match('~(^|[^a-z])union($|[^[a-z])~s', $clean) != 0)
+				$fail = true;
+			// Comments?  We don't use comments in our queries, we leave 'em outside!
+			elseif (strpos($clean, '/*') > 2 || strpos($clean, '--') !== false || strpos($clean, ';') !== false)
+				$fail = true;
+			// Trying to change passwords, slow us down, or something?
+			elseif (strpos($clean, 'sleep') !== false && preg_match('~(^|[^a-z])sleep($|[^[_a-z])~s', $clean) != 0)
+				$fail = true;
+			elseif (strpos($clean, 'benchmark') !== false && preg_match('~(^|[^a-z])benchmark($|[^[a-z])~s', $clean) != 0)
+				$fail = true;
+			// Sub selects?  We don't use those either.
+			elseif (preg_match('~\([^)]*?select~s', $clean) != 0)
+				$fail = true;
+
+			if (!empty($fail) && function_exists('log_error'))
+				$this->error_backtrace('Hacking attempt...', 'Hacking attempt...' . "\n" . $db_string, E_USER_ERROR, __FILE__, __LINE__);
+		}
+
+		if (empty($db_unbuffered))
+			$ret = @mysqli_query($connection, $db_string);
+		else
+			$ret = @mysqli_query($connection, $db_string, MYSQLI_USE_RESULT);
+
+		if ($ret === false && empty($db_values['db_error_skip']))
+			$ret = $this->error($db_string, $connection);
+
+		// Debugging.
+		if (isset($db_show_debug) && $db_show_debug === true)
+			$db_cache[$db_count]['t'] = array_sum(explode(' ', microtime())) - array_sum(explode(' ', $st));
+
+		return $ret;
+	}
+
+	/**
+	 * affected_rows
+	 * @param object $connection
+	 */
+	public function affected_rows($connection = null)
+	{
+		global $db_connection;
+
+		return mysqli_affected_rows($connection === null ? $db_connection : $connection);
+	}
+
+	/**
+	 * insert_id
+	 *
+	 * @param string $table
+	 * @param string $field = null
+	 * @param object $connection = null
+	 */
+	public function insert_id($table, $field = null, $connection = null)
+	{
+		global $db_connection, $db_prefix;
+
+		$table = str_replace('{db_prefix}', $db_prefix, $table);
+
+		// MySQL doesn't need the table or field information.
+		return mysqli_insert_id($connection === null ? $db_connection : $connection);
+	}
+
+	/**
+	 * Do a transaction.
+	 *
+	 * @param string $type - the step to perform (i.e. 'begin', 'commit', 'rollback')
+	 * @param object $connection = null
+	 */
+	public function transaction($type = 'commit', $connection = null)
+	{
+		global $db_connection;
+
+		// Decide which connection to use
+		$connection = $connection === null ? $db_connection : $connection;
+
+		if ($type == 'begin')
+			return @mysqli_query($connection, 'BEGIN');
+		elseif ($type == 'rollback')
+			return @mysqli_query($connection, 'ROLLBACK');
+		elseif ($type == 'commit')
+			return @mysqli_query($connection, 'COMMIT');
+
+		return false;
+	}
+
+	/**
+	 * Database error!
+	 *
+	 * @param object $connection = null
+	 */
+	public function show_error($connection = null)
+	{
+		global $db_connection;
+
+		// Decide which connection to use
+		$connection = $connection === null ? $db_connection : $connection;
+
+		// This is the error message...
+		return mysqli_errno($connection);
+	}
+
+	/**
+	 * Database error!
+	 * Backtrace, log, try to fix.
+	 *
+	 * @param string $db_string
+	 * @param object $connection = null
+	 */
+	private function error($db_string, $connection = null)
+	{
+		global $txt, $context, $sourcedir, $webmaster_email, $modSettings;
+		global $forum_version, $db_connection, $db_last_error, $db_persist;
+		global $db_server, $db_user, $db_passwd, $db_name, $db_show_debug, $ssi_db_user, $ssi_db_passwd;
+		global $smcFunc;
+
+		// Get the file and line numbers.
+		list ($file, $line) = $this->error_backtrace('', '', 'return', __FILE__, __LINE__);
+
+		// Decide which connection to use
+		$connection = $connection === null ? $db_connection : $connection;
+
+		// This is the error message...
+		$query_error = mysqli_error($connection);
+		$query_errno = mysqli_errno($connection);
+
+		// Error numbers:
+		//    1016: Can't open file '....MYI'
+		//    1030: Got error ??? from table handler.
+		//    1034: Incorrect key file for table.
+		//    1035: Old key file for table.
+		//    1205: Lock wait timeout exceeded.
+		//    1213: Deadlock found.
+		//    2006: Server has gone away.
+		//    2013: Lost connection to server during query.
+
+		// Log the error.
+		if ($query_errno != 1213 && $query_errno != 1205 && function_exists('log_error'))
+			log_error($txt['database_error'] . ': ' . $query_error . (!empty($modSettings['enableErrorQueryLogging']) ? "\n\n$db_string" : ''), 'database', $file, $line);
+
+		// Database error auto fixing ;).
+		if (function_exists('cache_get_data') && (!isset($modSettings['autoFixDatabase']) || $modSettings['autoFixDatabase'] == '1'))
+		{
+			// Force caching on, just for the error checking.
+			$old_cache = @$modSettings['cache_enable'];
+			$modSettings['cache_enable'] = '1';
+
+			if (($temp = cache_get_data('db_last_error', 600)) !== null)
+				$db_last_error = max(@$db_last_error, $temp);
+
+			if (@$db_last_error < time() - 3600 * 24 * 3)
+			{
+				// We know there's a problem... but what?  Try to auto detect.
+				if ($query_errno == 1030 && strpos($query_error, ' 127 ') !== false)
+				{
+					preg_match_all('~(?:[\n\r]|^)[^\']+?(?:FROM|JOIN|UPDATE|TABLE) ((?:[^\n\r(]+?(?:, )?)*)~s', $db_string, $matches);
+
+					$fix_tables = array();
+					foreach ($matches[1] as $tables)
+					{
+						$tables = array_unique(explode(',', $tables));
+						foreach ($tables as $table)
+						{
+							// Now, it's still theoretically possible this could be an injection.  So backtick it!
+							if (trim($table) != '')
+								$fix_tables[] = '`' . strtr(trim($table), array('`' => '')) . '`';
+						}
+					}
+
+					$fix_tables = array_unique($fix_tables);
+				}
+				// Table crashed.  Let's try to fix it.
+				elseif ($query_errno == 1016)
+				{
+					if (preg_match('~\'([^\.\']+)~', $query_error, $match) != 0)
+						$fix_tables = array('`' . $match[1] . '`');
+				}
+				// Indexes crashed.  Should be easy to fix!
+				elseif ($query_errno == 1034 || $query_errno == 1035)
+				{
+					preg_match('~\'([^\']+?)\'~', $query_error, $match);
+					$fix_tables = array('`' . $match[1] . '`');
+				}
+			}
+
+			// Check for errors like 145... only fix it once every three days, and send an email. (can't use empty because it might not be set yet...)
+			if (!empty($fix_tables))
+			{
+				// Subs-Admin.php for updateSettingsFile(), Subs-Post.php for sendmail().
+				require_once($sourcedir . '/Subs-Admin.php');
+				require_once($sourcedir . '/Subs-Post.php');
+
+				// Make a note of the REPAIR...
+				cache_put_data('db_last_error', time(), 600);
+				if (($temp = cache_get_data('db_last_error', 600)) === null)
+					updateSettingsFile(array('db_last_error' => time()));
+
+				// Attempt to find and repair the broken table.
+				foreach ($fix_tables as $table)
+					$smcFunc['db_query']('', "
+						REPAIR TABLE $table", false, false);
+
+				// And send off an email!
+				sendmail($webmaster_email, $txt['database_error'], $txt['tried_to_repair']);
+
+				$modSettings['cache_enable'] = $old_cache;
+
+				// Try the query again...?
+				$ret = $smcFunc['db_query']('', $db_string, false, false);
+				if ($ret !== false)
+					return $ret;
+			}
+			else
+				$modSettings['cache_enable'] = $old_cache;
+
+			// Check for the "lost connection" or "deadlock found" errors - and try it just one more time.
+			if (in_array($query_errno, array(1205, 1213, 2006, 2013)))
+			{
+				if (in_array($query_errno, array(2006, 2013)) && $db_connection == $connection)
+				{
+					// Are we in SSI mode?  If so try that username and password first
+					if (SMF == 'SSI' && !empty($ssi_db_user) && !empty($ssi_db_passwd))
+					{
+						if (empty($db_persist))
+							$db_connection = @mysqli_connect($db_server, $ssi_db_user, $ssi_db_passwd);
+						else
+							$db_connection = @mysqli_connect('p:' . $db_server, $ssi_db_user, $ssi_db_passwd);
+					}
+					// Fall back to the regular username and password if need be
+					if (!$db_connection)
+					{
+						if (empty($db_persist))
+							$db_connection = @mysqli_connect($db_server, $db_user, $db_passwd);
+						else
+							$db_connection = @mysqli_connect('p:' . $db_server, $db_user, $db_passwd);
+					}
+
+					if (!$db_connection || !@mysqli_select_db($db_connection, $db_name))
+						$db_connection = false;
+				}
+
+				if ($db_connection)
+				{
+					// Try a deadlock more than once more.
+					for ($n = 0; $n < 4; $n++)
+					{
+						$ret = $smcFunc['db_query']('', $db_string, false, false);
+
+						$new_errno = mysqli_errno($db_connection);
+						if ($ret !== false || in_array($new_errno, array(1205, 1213)))
+							break;
+					}
+
+					// If it failed again, shucks to be you... we're not trying it over and over.
+					if ($ret !== false)
+						return $ret;
+				}
+			}
+			// Are they out of space, perhaps?
+			elseif ($query_errno == 1030 && (strpos($query_error, ' -1 ') !== false || strpos($query_error, ' 28 ') !== false || strpos($query_error, ' 12 ') !== false))
+			{
+				if (!isset($txt))
+					$query_error .= ' - check database storage space.';
+				else
+				{
+					if (!isset($txt['mysql_error_space']))
+						loadLanguage('Errors');
+
+					$query_error .= !isset($txt['mysql_error_space']) ? ' - check database storage space.' : $txt['mysql_error_space'];
+				}
+			}
+		}
+
+		// Nothing's defined yet... just die with it.
+		if (empty($context) || empty($txt))
+			die($query_error);
+
+		// Show an error message, if possible.
+		$context['error_title'] = $txt['database_error'];
+		if (allowedTo('admin_forum'))
+			$context['error_message'] = nl2br($query_error) . '<br />' . $txt['file'] . ': ' . $file . '<br />' . $txt['line'] . ': ' . $line;
+		else
+			$context['error_message'] = $txt['try_again'];
+
+		// A database error is often the sign of a database in need of upgrade.  Check forum versions, and if not identical suggest an upgrade... (not for Demo/CVS versions!)
+		if (allowedTo('admin_forum') && !empty($forum_version) && $forum_version != 'SMF ' . @$modSettings['smfVersion'] && strpos($forum_version, 'Demo') === false && strpos($forum_version, 'CVS') === false)
+			$context['error_message'] .= '<br /><br />' . sprintf($txt['database_error_versions'], $forum_version, $modSettings['smfVersion']);
+
+		if (allowedTo('admin_forum') && isset($db_show_debug) && $db_show_debug === true)
+		{
+			$context['error_message'] .= '<br /><br />' . nl2br($db_string);
+		}
+
+		// It's already been logged... don't log it again.
+		fatal_error($context['error_message'], false);
+	}
+
+	/**
+	 * insert
+	 *
+	 * @param string $method - options 'replace', 'ignore', 'insert'
+	 * @param $table
+	 * @param $columns
+	 * @param $data
+	 * @param $keys
+	 * @param bool $disable_trans = false
+	 * @param object $connection = null
+	 */
+	public function insert($method, $table, $columns, $data, $keys, $disable_trans = false, $connection = null)
+	{
+		global $smcFunc, $db_connection, $db_prefix;
+
+		$connection = $connection === null ? $db_connection : $connection;
+
+		// With nothing to insert, simply return.
+		if (empty($data))
+			return;
+
+		// Replace the prefix holder with the actual prefix.
+		$table = str_replace('{db_prefix}', $db_prefix, $table);
+
+		// Inserting data as a single row can be done as a single array.
+		if (!is_array($data[array_rand($data)]))
+			$data = array($data);
+
+		// Create the mold for a single row insert.
+		$insertData = '(';
+		foreach ($columns as $columnName => $type)
+		{
+			// Are we restricting the length?
+			if (strpos($type, 'string-') !== false)
+				$insertData .= sprintf('SUBSTRING({string:%1$s}, 1, ' . substr($type, 7) . '), ', $columnName);
+			else
+				$insertData .= sprintf('{%1$s:%2$s}, ', $type, $columnName);
+		}
+		$insertData = substr($insertData, 0, -2) . ')';
+
+		// Create an array consisting of only the columns.
+		$indexed_columns = array_keys($columns);
+
+		// Here's where the variables are injected to the query.
+		$insertRows = array();
+		foreach ($data as $dataRow)
+			$insertRows[] = $this->quote($insertData, array_combine($indexed_columns, $dataRow), $connection);
+
+		// Determine the method of insertion.
+		$queryTitle = $method == 'replace' ? 'REPLACE' : ($method == 'ignore' ? 'INSERT IGNORE' : 'INSERT');
+
+		// Do the insert.
+		$smcFunc['db_query']('', '
+			' . $queryTitle . ' INTO ' . $table . '(`' . implode('`, `', $indexed_columns) . '`)
+			VALUES
+				' . implode(',
+				', $insertRows),
+			array(
+				'security_override' => true,
+				'db_error_skip' => $table === $db_prefix . 'log_errors',
+			),
+			$connection
+		);
+	}
+
+	/**
+	 * This function tries to work out additional error information from a back trace.
+	 *
+	 * @param $error_message
+	 * @param $log_message
+	 * @param $error_type
+	 * @param $file
+	 * @param $line
+	 */
+	private function error_backtrace($error_message, $log_message = '', $error_type = false, $file = null, $line = null)
+	{
+		if (empty($log_message))
+			$log_message = $error_message;
+
+		foreach (debug_backtrace() as $step)
+		{
+			// Found it?
+			if (!method_exists($this, $step['function']) && strpos($step['function'], 'query') === false && !in_array(substr($step['function'], 0, 7), array('smf_db_', 'preg_re', 'db_erro', 'call_us')) && strpos($step['function'], '__') !== 0)
+			{
+				$log_message .= '<br />Function: ' . $step['function'];
+				break;
+			}
+
+			if (isset($step['line']))
+			{
+				$file = $step['file'];
+				$line = $step['line'];
+			}
+		}
+
+		// A special case - we want the file and line numbers for debugging.
+		if ($error_type == 'return')
+			return array($file, $line);
+
+		// Is always a critical error.
+		if (function_exists('log_error'))
+			log_error($log_message, 'critical', $file, $line);
+
+		if (function_exists('fatal_error'))
+		{
+			fatal_error($error_message, false);
+
+			// Cannot continue...
+			exit;
+		}
+		elseif ($error_type)
+			trigger_error($error_message . ($line !== null ? '<em>(' . basename($file) . '-' . $line . ')</em>' : ''), $error_type);
+		else
+			trigger_error($error_message . ($line !== null ? '<em>(' . basename($file) . '-' . $line . ')</em>' : ''));
+	}
+
+	/**
+	 * Escape the LIKE wildcards so that they match the character and not the wildcard.
+	 *
+	 * @param $string
+	 * @param bool $translate_human_wildcards = false, if true, turns human readable wildcards into SQL wildcards.
+	 */
+	public function escape_wildcard_string($string, $translate_human_wildcards=false)
+	{
+		$replacements = array(
+			'%' => '\%',
+			'_' => '\_',
+			'\\' => '\\\\',
+		);
+
+		if ($translate_human_wildcards)
+			$replacements += array(
+				'*' => '%',
+			);
+
+		return strtr($string, $replacements);
+	}
+}
+
+
 ?>
\ No newline at end of file
diff --git a/Sources/Subs-Db-postgresql.php b/Sources/Subs-Db-postgresql.php
index 5591ed3..8e72eed 100644
--- a/Sources/Subs-Db-postgresql.php
+++ b/Sources/Subs-Db-postgresql.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.4
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -50,6 +50,8 @@ function smf_db_initiate($db_server, $db_name, $db_user, $db_passwd, &$db_prefix
 			'db_sybase' => true,
 			'db_case_sensitive' => true,
 			'db_escape_wildcard_string' => 'smf_db_escape_wildcard_string',
+			'db_connect_error' => 'smf_db_connect_error',
+			'db_connect_errno' => 'smf_db_connect_errno',
 		);
 
 	if (!empty($db_options['persist']))
@@ -389,7 +391,7 @@ function smf_db_query($identifier, $db_string, $db_values = array(), $connection
 				$pos2 = strpos($db_string, '\\', $pos + 1);
 				if ($pos1 === false)
 					break;
-				elseif ($pos2 == false || $pos2 > $pos1)
+				elseif ($pos2 === false || $pos2 > $pos1)
 				{
 					$pos = $pos1;
 					break;
@@ -581,7 +583,7 @@ function smf_db_unescape_string($string)
 }
 
 // For inserting data in a special way...
-function smf_db_insert($method = 'replace', $table, $columns, $data, $keys, $disable_trans = false, $connection = null)
+function smf_db_insert($method, $table, $columns, $data, $keys, $disable_trans = false, $connection = null)
 {
 	global $db_replace_result, $db_in_transact, $smcFunc, $db_connection, $db_prefix;
 
@@ -754,4 +756,26 @@ function smf_db_escape_wildcard_string($string, $translate_human_wildcards=false
 	return strtr($string, $replacements);
 }
 
+/**
+ * Function to emulate mysqli_connect_error.
+ * Since pg doesn't have such a function, just return an empty string.
+ *
+ * @return string connection error message
+ */
+function smf_db_connect_error()
+{
+	return '';
+}
+
+/**
+ * Function to emulate mysqli_connect_errno.
+ * Since pg doesn't have such a function, just return an empty string.
+ *
+ * @return string connection error number
+ */
+function smf_db_connect_errno()
+{
+	return '';
+}
+
 ?>
\ No newline at end of file
diff --git a/Sources/Subs-Db-sqlite.php b/Sources/Subs-Db-sqlite.php
index 99bb9b4..e0657e8 100644
--- a/Sources/Subs-Db-sqlite.php
+++ b/Sources/Subs-Db-sqlite.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -494,7 +494,7 @@ function smf_db_error($db_string, $connection = null)
 }
 
 // Insert some data...
-function smf_db_insert($method = 'replace', $table, $columns, $data, $keys, $disable_trans = false, $connection = null)
+function smf_db_insert($method, $table, $columns, $data, $keys, $disable_trans = false, $connection = null)
 {
 	global $db_in_transact, $db_connection, $smcFunc, $db_prefix;
 
@@ -710,8 +710,9 @@ function smf_udf_locate($find, $string)
 // This is used to replace RLIKE.
 function smf_udf_regexp($exp, $search)
 {
-	if (preg_match($exp, $match))
+	if (preg_match($exp, $search))
 		return 1;
+
 	return 0;
 }
 
diff --git a/Sources/Subs-Editor.php b/Sources/Subs-Editor.php
index 2cfa4f0..8f6ddb4 100644
--- a/Sources/Subs-Editor.php
+++ b/Sources/Subs-Editor.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.11
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -897,7 +897,7 @@ function fetchTagAttributes($text)
 	for ($i = 0; $i < strlen($text); $i++)
 	{
 		// We're either moving from the key to the attribute or we're in a string and this is fine.
-		if ($text{$i} == '=')
+		if ($text[$i] == '=')
 		{
 			if ($tag_state == 0)
 				$tag_state = 1;
@@ -905,7 +905,7 @@ function fetchTagAttributes($text)
 				$value .= '=';
 		}
 		// A space is either moving from an attribute back to a potential key or in a string is fine.
-		elseif ($text{$i} == ' ')
+		elseif ($text[$i] == ' ')
 		{
 			if ($tag_state == 2)
 				$value .= ' ';
@@ -917,7 +917,7 @@ function fetchTagAttributes($text)
 			}
 		}
 		// A quote?
-		elseif ($text{$i} == '"')
+		elseif ($text[$i] == '"')
 		{
 			// Must be either going into or out of a string.
 			if ($tag_state == 1)
@@ -929,9 +929,9 @@ function fetchTagAttributes($text)
 		else
 		{
 			if ($tag_state == 0)
-				$key .= $text{$i};
+				$key .= $text[$i];
 			else
-				$value .= $text{$i};
+				$value .= $text[$i];
 		}
 	}
 
diff --git a/Sources/Subs-Graphics.php b/Sources/Subs-Graphics.php
index 6ab1be2..4ce1b69 100644
--- a/Sources/Subs-Graphics.php
+++ b/Sources/Subs-Graphics.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.19
  */
 
 // TrueType fonts supplied by www.LarabieFonts.com
@@ -269,8 +269,9 @@ function checkImageContents($fileName, $extensiveCheck = false)
 		// Though not exhaustive lists, better safe than sorry.
 		if (!empty($extensiveCheck))
 		{
-			// Paranoid check. Some like it that way.
-			if (preg_match('~(iframe|\\<\\?|\\<%|html|eval|body|script\W|[CF]WS[\x01-\x0C])~i', $prev_chunk . $cur_chunk) === 1)
+			// Paranoid check.  Use this if you have reason to distrust your host's security config.
+			// Will result in MANY false positives, and is not suitable for photography sites.
+			if (preg_match('~(iframe|\\<\\?|\\<%|html|eval|body|script\W|(?-i)[CFZ]WS[\x01-\x0E])~i', $prev_chunk . $cur_chunk) === 1)
 			{
 				fclose($fp);
 				return false;
@@ -278,8 +279,9 @@ function checkImageContents($fileName, $extensiveCheck = false)
 		}
 		else
 		{
-			// Check for potential infection
-			if (preg_match('~(iframe|(?<!cellTextIs)html|eval|body|script\W|[CF]WS[\x01-\x0C])~i', $prev_chunk . $cur_chunk) === 1)
+			// Check for potential infection - focus on clues for inline php & flash.
+			// Will result in significantly fewer false positives than the paranoid check.
+			if (preg_match('~(\\<\\?php\s|(?-i)[CFZ]WS[\x01-\x0E])~i', $prev_chunk . $cur_chunk) === 1)
 			{
 				fclose($fp);
 				return false;
@@ -333,6 +335,10 @@ function resizeImageFile($source, $destination, $max_width, $max_height, $prefer
 	{
 		$fileContents = fetch_web_data($source);
 
+		$mime_valid = check_mime_type($fileContents, implode('|', array_map('image_type_to_mime_type', array_keys($default_formats))));
+		if (empty($mime_valid))
+			return false;
+
 		fwrite($fp_destination, $fileContents);
 		fclose($fp_destination);
 
@@ -340,6 +346,10 @@ function resizeImageFile($source, $destination, $max_width, $max_height, $prefer
 	}
 	elseif ($fp_destination)
 	{
+		$mime_valid = check_mime_type($source, implode('|', array_map('image_type_to_mime_type', array_keys($default_formats))), true);
+		if (empty($mime_valid))
+			return false;
+
 		$sizes = @getimagesize($source);
 
 		$fp_source = fopen($source, 'rb');
@@ -354,7 +364,7 @@ function resizeImageFile($source, $destination, $max_width, $max_height, $prefer
 		fclose($fp_destination);
 	}
 	// We can't get to the file.
-	else
+	if (empty($sizes))
 		$sizes = array(-1, -1, -1);
 
 	// Gif? That might mean trouble if gif support is not available.
@@ -527,9 +537,9 @@ if (!function_exists('imagecreatefrombmp'))
 		$n = 0;
 		for ($j = 0; $j < $palette_size; $j++)
 		{
-			$b = ord($palettedata{$j++});
-			$g = ord($palettedata{$j++});
-			$r = ord($palettedata{$j++});
+			$b = ord($palettedata[$j++]);
+			$g = ord($palettedata[$j++]);
+			$r = ord($palettedata[$j++]);
 
 			$palette[$n++] = imagecolorallocate($dst_img, $r, $g, $b);
 		}
@@ -550,9 +560,9 @@ if (!function_exists('imagecreatefrombmp'))
 				$x = 0;
 				for ($j = 0; $j < $scan_line_size; $x++)
 				{
-					$b = ord($scan_line{$j++});
-					$g = ord($scan_line{$j++});
-					$r = ord($scan_line{$j++});
+					$b = ord($scan_line[$j++]);
+					$g = ord($scan_line[$j++]);
+					$r = ord($scan_line[$j++]);
 					$j++;
 
 					$color = imagecolorexact($dst_img, $r, $g, $b);
@@ -573,9 +583,9 @@ if (!function_exists('imagecreatefrombmp'))
 				$x = 0;
 				for ($j = 0; $j < $scan_line_size; $x++)
 				{
-					$b = ord($scan_line{$j++});
-					$g = ord($scan_line{$j++});
-					$r = ord($scan_line{$j++});
+					$b = ord($scan_line[$j++]);
+					$g = ord($scan_line[$j++]);
+					$r = ord($scan_line[$j++]);
 
 					$color = imagecolorexact($dst_img, $r, $g, $b);
 					if ($color == -1)
@@ -595,8 +605,8 @@ if (!function_exists('imagecreatefrombmp'))
 				$x = 0;
 				for ($j = 0; $j < $scan_line_size; $x++)
 				{
-					$b1 = ord($scan_line{$j++});
-					$b2 = ord($scan_line{$j++});
+					$b1 = ord($scan_line[$j++]);
+					$b2 = ord($scan_line[$j++]);
 
 					$word = $b2 * 256 + $b1;
 
@@ -622,14 +632,14 @@ if (!function_exists('imagecreatefrombmp'))
 			{
 				$x = 0;
 				for ($j = 0; $j < $scan_line_size; $x++)
-					imagesetpixel($dst_img, $x, $y, $palette[ord($scan_line{$j++})]);
+					imagesetpixel($dst_img, $x, $y, $palette[ord($scan_line[$j++])]);
 			}
 			elseif ($info['bits'] == 4)
 			{
 				$x = 0;
 				for ($j = 0; $j < $scan_line_size; $x++)
 				{
-					$byte = ord($scan_line{$j++});
+					$byte = ord($scan_line[$j++]);
 
 					imagesetpixel($dst_img, $x, $y, $palette[(int) ($byte / 16)]);
 					if (++$x < $info['width'])
@@ -786,7 +796,7 @@ function showCodeImage($code)
 	for ($i = 0; $i < strlen($code); $i++)
 	{
 		$characters[$i] = array(
-			'id' => $code{$i},
+			'id' => $code[$i],
 			'font' => array_rand($font_list),
 		);
 
diff --git a/Sources/Subs-Members.php b/Sources/Subs-Members.php
index da12573..838f6be 100644
--- a/Sources/Subs-Members.php
+++ b/Sources/Subs-Members.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -516,7 +516,7 @@ function registerMember(&$regOptions, $return_errors = false)
 		$reg_errors[] = array('lang', 'username_reserved', 'general', array($txt['guest_title']));
 
 	// !!! Separate the sprintf?
-	if (empty($regOptions['email']) || preg_match('~^[0-9A-Za-z=_+\-/][0-9A-Za-z=_\'+\-/\.]*@[\w\-]+(\.[\w\-]+)*(\.[\w]{2,15})$~', $regOptions['email']) === 0 || strlen($regOptions['email']) > 255)
+	if (empty($regOptions['email']) || filter_var($regOptions['email'], FILTER_VALIDATE_EMAIL) === false || strlen($regOptions['email']) > 255)
 		$reg_errors[] = array('lang', 'profile_error_bad_email');
 
 	if (!empty($regOptions['check_reserved_name']) && isReservedName($regOptions['username'], 0, false))
@@ -792,6 +792,18 @@ function registerMember(&$regOptions, $return_errors = false)
 		);
 	}
 
+	// Since they're not a user yet, user_info is incomplete, which breaks logging.
+	// Fill in enough gaps for logging to be successful.
+	if (empty($user_info['id']))
+		$user_info['id'] = $memberID;
+	if (empty($user_info['username']))
+		$user_info['username'] = $regOptions['username'];
+
+	// Log their acceptance of the agreement and privacy policy, for future reference.
+	foreach (array('agreement_accepted', 'policy_accepted') as $key)
+		if (!empty($theme_vars[$key]))
+			logAction($key, array('applicator' => $memberID), 'user');
+
 	// If it's enabled, increase the registrations for today.
 	trackStats(array('registers' => '+'));
 
@@ -900,12 +912,17 @@ function isReservedName($name, $current_ID_MEMBER = 0, $is_name = true, $fatal =
 	global $user_info, $modSettings, $smcFunc, $context;
 
 	// No cheating with entities please.
-	$replaceEntities = create_function('$string', '
-		$num = substr($string, 0, 1) === \'x\' ? hexdec(substr($string, 1)) : (int) $string;
-		if ($num === 0x202E || $num === 0x202D) return \'\'; if (in_array($num, array(0x22, 0x26, 0x27, 0x3C, 0x3E))) return \'&#\' . $num . \';\';' .
-		(empty($context['utf8']) ? 'return $num < 0x20 ? \'\' : ($num < 0x80 ? chr($num) : \'&#\' . $string . \';\');' : '
-		return $num < 0x20 || $num > 0x10FFFF || ($num >= 0xD800 && $num <= 0xDFFF) ? \'\' : ($num < 0x80 ? chr($num) : ($num < 0x800 ? chr(192 | $num >> 6) . chr(128 | $num & 63) : ($num < 0x10000 ? chr(224 | $num >> 12) . chr(128 | $num >> 6 & 63) . chr(128 | $num & 63) : chr(240 | $num >> 18) . chr(128 | $num >> 12 & 63) . chr(128 | $num >> 6 & 63) . chr(128 | $num & 63))));')
-	);
+	$replaceEntities = function($string) use ($context)
+	{
+		$num = substr($string, 0, 1) === 'x' ? hexdec(substr($string, 1)) : (int) $string;
+		if ($num === 0x202E || $num === 0x202D)
+			return '';
+		if (in_array($num, array(0x22, 0x26, 0x27, 0x3C, 0x3E)))
+			return '&#' . $num . ';';
+		if (empty($context['utf8']))
+			return $num < 0x20 ? '' : ($num < 0x80 ? chr($num) : '&#' . $string . ';');
+		return $num < 0x20 || $num > 0x10FFFF || ($num >= 0xD800 && $num <= 0xDFFF) ? '' : ($num < 0x80 ? chr($num) : ($num < 0x800 ? chr(192 | $num >> 6) . chr(128 | $num & 63) : ($num < 0x10000 ? chr(224 | $num >> 12) . chr(128 | $num >> 6 & 63) . chr(128 | $num & 63) : chr(240 | $num >> 18) . chr(128 | $num >> 12 & 63) . chr(128 | $num >> 6 & 63) . chr(128 | $num & 63))));
+	};
 
 	$name = preg_replace_callback('~(&#(\d{1,7}|x[0-9a-fA-F]{1,6});)~', 'replaceEntities__callback', $name);
 	$checkName = $smcFunc['strtolower']($name);
diff --git a/Sources/Subs-Package.php b/Sources/Subs-Package.php
index aaef19e..bb15d6b 100644
--- a/Sources/Subs-Package.php
+++ b/Sources/Subs-Package.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.10
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -227,14 +227,14 @@ function read_tgz_data($data, $destination, $single_file = false, $overwrite = f
 	$flags = $flags['f'];
 
 	$offset = 10;
-	$octdec = array('mode', 'uid', 'gid', 'size', 'mtime', 'checksum', 'type');
+	$octdec = array('mode', 'uid', 'gid', 'size', 'mtime', 'checksum');
 
 	// "Read" the filename and comment. // !!! Might be mussed.
 	if ($flags & 12)
 	{
-		while ($flags & 8 && $data{$offset++} != "\0")
+		while ($flags & 8 && $data[$offset++] != "\0")
 			continue;
-		while ($flags & 4 && $data{$offset++} != "\0")
+		while ($flags & 4 && $data[$offset++] != "\0")
 			continue;
 	}
 
@@ -270,14 +270,14 @@ function read_tgz_data($data, $destination, $single_file = false, $overwrite = f
 				$current[$k] = trim($v);
 		}
 
-		if ($current['type'] == 5 && substr($current['filename'], -1) != '/')
+		if ($current['type'] == '5' && substr($current['filename'], -1) != '/')
 			$current['filename'] .= '/';
 
 		$checksum = 256;
 		for ($i = 0; $i < 148; $i++)
-			$checksum += ord($header{$i});
+			$checksum += ord($header[$i]);
 		for ($i = 156; $i < 512; $i++)
-			$checksum += ord($header{$i});
+			$checksum += ord($header[$i]);
 
 		if ($current['checksum'] != $checksum)
 			break;
@@ -536,7 +536,7 @@ function getPackageInfo($gzfilename)
 	global $boarddir;
 
 	// Extract package-info.xml from downloaded file. (*/ is used because it could be in any directory.)
-	if (strpos($gzfilename, 'http://') !== false)
+	if (strpos($gzfilename, 'http://') !== false || strpos($gzfilename, 'https://') !== false)
 		$packageInfo = read_tgz_data(fetch_web_data($gzfilename, '', true), '*/package-info.xml', true);
 	else
 	{
@@ -567,7 +567,7 @@ function getPackageInfo($gzfilename)
 
 	$package = $packageInfo->to_array();
 	$package = htmlspecialchars__recursive($package);
-	$package['xml'] = $packageInfo;	
+	$package['xml'] = $packageInfo;
 	$package['filename'] = $gzfilename;
 
 	// Don't want to mess with code...
@@ -680,12 +680,11 @@ function create_chmod_control($chmodFiles = array(), $chmodOptions = array(), $r
 						'value' => $txt['package_restore_permissions_cur_status'],
 					),
 					'data' => array(
-						'function' => create_function('$rowData', '
-							global $txt;
-
-							$formatTxt = $rowData[\'result\'] == \'\' || $rowData[\'result\'] == \'skipped\' ? $txt[\'package_restore_permissions_pre_change\'] : $txt[\'package_restore_permissions_post_change\'];
-							return sprintf($formatTxt, $rowData[\'cur_perms\'], $rowData[\'new_perms\'], $rowData[\'writable_message\']);
-						'),
+						'function' => function($rowData) use ($txt)
+						{
+							$formatTxt = $rowData['result'] == '' || $rowData['result'] == 'skipped' ? $txt['package_restore_permissions_pre_change'] : $txt['package_restore_permissions_post_change'];
+							return sprintf($formatTxt, $rowData['cur_perms'], $rowData['new_perms'], $rowData['writable_message']);
+						},
 						'class' => 'smalltext',
 					),
 				),
@@ -708,11 +707,10 @@ function create_chmod_control($chmodFiles = array(), $chmodOptions = array(), $r
 						'value' => $txt['package_restore_permissions_result'],
 					),
 					'data' => array(
-						'function' => create_function('$rowData', '
-							global $txt;
-
-							return $txt[\'package_restore_permissions_action_\' . $rowData[\'result\']];
-						'),
+						'function' => function($rowData) use ($txt)
+						{
+							return $txt['package_restore_permissions_action_' . $rowData['result']];
+						},
 						'class' => 'smalltext',
 					),
 				),
@@ -1504,7 +1502,7 @@ function compareVersions($version1, $version2)
 			'minor' => !empty($parts[2]) ? (int) $parts[2] : 0,
 			'patch' => !empty($parts[3]) ? (int) $parts[3] : 0,
 			'type' => empty($parts[4]) ? 'stable' : $parts[4],
-			'type_major' => !empty($parts[6]) ? (int) $parts[5] : 0,
+			'type_major' => !empty($parts[5]) ? (int) $parts[5] : 0,
 			'type_minor' => !empty($parts[6]) ? (int) $parts[6] : 0,
 			'dev' => !empty($parts[7]),
 		);
@@ -1582,8 +1580,9 @@ function deltree($dir, $delete_dir = true)
 		if ($delete_dir && isset($package_ftp))
 		{
 			$ftp_file = strtr($dir, array($_SESSION['pack_ftp']['root'] => ''));
-			if (!is_writable($dir . '/' . $entryname))
+			if (!is_writable($dir . '/' . $ftp_file))
 				$package_ftp->chmod($ftp_file, 0777);
+
 			$package_ftp->unlink($ftp_file);
 		}
 
@@ -1796,12 +1795,19 @@ function parseModification($file, $testing = true, $undo = false, $theme_paths =
 	// This is needed to hold the long paths, as they can vary...
 	$long_changes = array();
 
+	// Translate everything to unix dir separators for comparisons during parsing
+	foreach ($theme_paths as $id => $theme)
+		$theme_paths[$id]['theme_dir'] = strtr($theme_paths[$id]['theme_dir'], '\\', '/');
+
 	// First, we need to build the list of all the files likely to get changed.
 	foreach ($files as $file)
 	{
 		// What is the filename we're currently on?
 		$filename = parse_path(trim($file->fetch('@name')));
 
+		// Xlate it to unix style for comparisons...
+		$filename = strtr($filename, '\\', '/');
+
 		// Now, we need to work out whether this is even a template file...
 		foreach ($theme_paths as $id => $theme)
 		{
@@ -1850,6 +1856,9 @@ function parseModification($file, $testing = true, $undo = false, $theme_paths =
 			1 => parse_path(trim($file->fetch('@name'))),
 		);
 
+		// Translate to unix dir separators for comparisons during parsing
+		$files_to_change[1] = strtr($files_to_change[1], '\\', '/');
+
 		// Sometimes though, we have some additional files for other themes, if we have add them to the mix.
 		if (isset($custom_themes_add[$files_to_change[1]]))
 			$files_to_change += $custom_themes_add[$files_to_change[1]];
@@ -2704,7 +2713,7 @@ function package_crypt($pass)
 		$salt .= session_id();
 
 	for ($i = 0; $i < $n; $i++)
-		$pass{$i} = chr(ord($pass{$i}) ^ (ord($salt{$i}) - 32));
+		$pass[$i] = chr(ord($pass[$i]) ^ (ord($salt[$i]) - 32));
 
 	return $pass;
 }
@@ -2715,7 +2724,7 @@ function package_create_backup($id = 'backup')
 
 	$files = array();
 
-	$base_files = array('index.php', 'SSI.php', 'agreement.txt', 'ssi_examples.php', 'ssi_examples.shtml');
+	$base_files = array('index.php', 'SSI.php', 'agreement.txt', 'proxy.php', 'ssi_examples.php', 'ssi_examples.shtml', 'subscriptions.php');
 	foreach ($base_files as $file)
 	{
 		if (file_exists($boarddir . '/' . $file))
@@ -2743,11 +2752,8 @@ function package_create_backup($id = 'backup')
 		$dirs[$row['value']] = empty($_REQUEST['use_full_paths']) ? 'Themes/' . basename($row['value']) . '/' : strtr($row['value'] . '/', '\\', '/');
 	$smcFunc['db_free_result']($request);
 
-	while (!empty($dirs))
+	foreach ($dirs as $dir => $dest)
 	{
-		list ($dir, $dest) = each($dirs);
-		unset($dirs[$dir]);
-
 		$listing = @dir($dir);
 		if (!$listing)
 			continue;
@@ -2819,7 +2825,7 @@ function package_create_backup($id = 'backup')
 
 		$checksum = 256;
 		for ($i = 0; $i < 512; $i++)
-			$checksum += ord($current{$i});
+			$checksum += ord($current[$i]);
 
 		$fwrite($output, substr($current, 0, 148) . pack('a8', decoct($checksum)) . substr($current, 156, 511));
 
@@ -2894,8 +2900,22 @@ function fetch_web_data($url, $post_data = '', $keep_alive = false, $redirection
 		$ftp->check_response(226);
 		$ftp->close();
 	}
-// This is more likely; a standard HTTP URL.
+	// More likely a standard HTTP/s URL, first try to use cURL if available
+	elseif (isset($match[1]) && substr($match[1], 0, 4) === 'http' && function_exists('curl_init'))
+	{
+		// Include the file containing the curl_fetch_web_data class.
+		loadClassFile('Class-CurlFetchWeb.php');
+
+		$fetch_data = new curl_fetch_web_data();
+		$fetch_data->get_url_data($url, $post_data);
 
+		// no errors and a 200 result, then we have a good dataset, well we at least have data ;)
+		if ($fetch_data->result('code') == 200 && !$fetch_data->result('error'))
+			$data = $fetch_data->result('body');
+		else
+			return false;
+	}
+	// Fallback to sockets.
 	elseif (isset($match[1]) && $match[1] == 'http')
 	{
 		if ($keep_alive && $match[3] == $keep_alive_dom)
@@ -3022,4 +3042,46 @@ if (!function_exists('smf_crc32'))
 	}
 }
 
-?>
\ No newline at end of file
+// Checks whether a file or data retrieved by fetch_web_data has the expected MIME type.
+// Returns 1 if the detected MIME type matches the pattern, 0 if it doesn't, or 2 if we can't check.
+function check_mime_type($data, $type_pattern, $is_path = false)
+{
+	// On Windows, the Fileinfo extension may not be enabled by default.
+	if (!extension_loaded('fileinfo'))
+	{
+		// Maybe we can load it dynamically?
+		$loaded = false;
+		$safe = ini_get('safe_mode');
+		$dl_ok = ini_get('enable_dl');
+		if (empty($safe) && !empty($dl_ok) && function_exists('dl'))
+			$loaded = @dl(((PHP_SHLIB_SUFFIX === 'dll') ? 'php_' : '') . 'fileinfo.' . PHP_SHLIB_SUFFIX);
+
+		// Oh well. We tried.
+		if (!$loaded)
+			return 2;
+	}
+
+	// Just some nice, simple data to analyze.
+	if (empty($is_path))
+		$mime_type = finfo_buffer(finfo_open(FILEINFO_MIME), $data);
+
+	// A file, or maybe a URL?
+	else
+	{
+		// Local file.
+		if (file_exists($data))
+			$mime_type = mime_content_type($data);
+
+		// URL.
+		elseif (url_exists($data))
+			$mime_type = finfo_buffer(finfo_open(FILEINFO_MIME), fetch_web_data($data));
+
+		// Non-existent files obviously don't have the right MIME type.
+		else
+			return 0;
+	}
+
+	return (int) @preg_match('~' . $type_pattern . '~', $mime_type);
+}
+
+?>
diff --git a/Sources/Subs-Post.php b/Sources/Subs-Post.php
index 63e9acf..5a2647b 100644
--- a/Sources/Subs-Post.php
+++ b/Sources/Subs-Post.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.13
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -236,7 +236,10 @@ function preparsecode(&$message, $previewing = false)
 				{
 					static $htmlfunc = null;
 					if ($htmlfunc === null)
-						$htmlfunc = create_function('$m', 'return \'[html]\' . strtr(un_htmlspecialchars("$m[1]"), array("\n" => \'&#13;\', \'  \' => \' &#32;\', \'[\' => \'&#91;\', \']\' => \'&#93;\')) . \'[/html]\';');
+						$htmlfunc = function($m)
+						{
+							return '[html]' . strtr(un_htmlspecialchars("$m[1]"), array("\n" => '&#13;', '  ' => ' &#32;', '[' => '&#91;', ']' => '&#93;')) . '[/html]';
+						};
 					$parts[$i] = preg_replace_callback('~\[html\](.+?)\[/html\]~is', $htmlfunc, $parts[$i]);
 				}
 
@@ -1248,7 +1251,8 @@ function mimespecialchars($string, $with_charset = true, $hotmail_fix = false, $
 					$string = $newstring;
 			}
 
-			$fixchar = create_function('$n', '
+			$fixchar = function($n)
+			{
 				if ($n < 128)
 					return chr($n);
 				elseif ($n < 2048)
@@ -1256,7 +1260,8 @@ function mimespecialchars($string, $with_charset = true, $hotmail_fix = false, $
 				elseif ($n < 65536)
 					return chr(224 | $n >> 12) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);
 				else
-					return chr(240 | $n >> 18) . chr(128 | $n >> 12 & 63) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);');
+					return chr(240 | $n >> 18) . chr(128 | $n >> 12 & 63) . chr(128 | $n >> 6 & 63) . chr(128 | $n & 63);
+			};
 
 			$string = preg_replace_callback('~&#(\d{3,8});~', 'fixchar__callback', $string);
 
@@ -1350,12 +1355,21 @@ function smtp_mail($mail_to_array, $subject, $message, $headers)
 	if (!server_parse(null, $socket, '220'))
 		return false;
 
+	// Start off by using the stored mail server.
+	$helo = $modSettings['smtp_host'];
+
+	// Try and determine this server's name.
+	if (function_exists('gethostname') && gethostname() !== false)
+		$helo = gethostname();
+	elseif (function_exists('php_uname'))
+		$helo = php_uname('n');
+	elseif (!empty($_SERVER['SERVER_NAME']))
+		$helo = $_SERVER['SERVER_NAME'];
+
 	if ($modSettings['mail_type'] == 1 && $modSettings['smtp_username'] != '' && $modSettings['smtp_password'] != '')
 	{
-		// !!! These should send the CURRENT server's name, not the mail server's!
-
 		// EHLO could be understood to mean encrypted hello...
-		if (server_parse('EHLO ' . $modSettings['smtp_host'], $socket, null) == '250')
+		if (server_parse('EHLO ' . $helo, $socket, null) == '250')
 		{
 			if (!server_parse('AUTH LOGIN', $socket, '334'))
 				return false;
@@ -1366,13 +1380,13 @@ function smtp_mail($mail_to_array, $subject, $message, $headers)
 			if (!server_parse($modSettings['smtp_password'], $socket, '235'))
 				return false;
 		}
-		elseif (!server_parse('HELO ' . $modSettings['smtp_host'], $socket, '250'))
+		elseif (!server_parse('HELO ' . $helo, $socket, '250'))
 			return false;
 	}
 	else
 	{
 		// Just say "helo".
-		if (!server_parse('HELO ' . $modSettings['smtp_host'], $socket, '250'))
+		if (!server_parse('HELO ' . $helo, $socket, '250'))
 			return false;
 	}
 
@@ -1432,6 +1446,8 @@ function server_parse($message, $socket, $response)
 	while (substr($server_response, 3, 1) != ' ')
 		if (!($server_response = fgets($socket, 256)))
 		{
+			loadLanguage('index');
+
 			// !!! Change this message to reflect that it may mean bad user/password/server issues/etc.
 			log_error($txt['smtp_bad_response']);
 			return false;
@@ -1442,6 +1458,8 @@ function server_parse($message, $socket, $response)
 
 	if (substr($server_response, 0, 3) != $response)
 	{
+		loadLanguage('index');
+
 		log_error($txt['smtp_error'] . $server_response);
 		return false;
 	}
@@ -1667,6 +1685,15 @@ function sendNotifications($topics, $type, $exclude = array(), $members_only = a
 			'UNSUBSCRIBELINK' => $scripturl . '?action=notify;topic=' . $row['id_topic'] . '.0',
 		);
 
+		// Make a token for the unsubscribe link
+		if (!empty($modSettings['notify_tokens']))
+		{
+			require_once($sourcedir . '/Notify.php');
+			$token = createUnsubscribeToken($row['id_member'], $row['email_address'], 'topic', $row['id_topic']);
+
+			$replacements['UNSUBSCRIBELINK'] .= ';u=' . $row['id_member'] . ';token=' . $token;
+		}
+
 		if ($type == 'remove')
 			unset($replacements['TOPICLINK'], $replacements['UNSUBSCRIBELINK']);
 		// Do they want the body of the message sent too?
@@ -2113,7 +2140,7 @@ function createAttachment(&$attachmentOptions)
 			if (!empty($size['mime']))
 				$attachmentOptions['mime_type'] = $size['mime'];
 			// Otherwise a valid one?
-			elseif (isset($validImageTypes[$size[2]]))
+			elseif (!empty($size[2]) && isset($validImageTypes[$size[2]]))
 				$attachmentOptions['mime_type'] = 'image/' . $validImageTypes[$size[2]];
 		}
 	}
@@ -2268,7 +2295,7 @@ function createAttachment(&$attachmentOptions)
 		{
 			if (!empty($size['mime']))
 				$attachmentOptions['mime_type'] = $size['mime'];
-			elseif (isset($validImageTypes[$size[2]]))
+			elseif (!empty($size[2]) && isset($validImageTypes[$size[2]]))
 				$attachmentOptions['mime_type'] = 'image/' . $validImageTypes[$size[2]];
 		}
 
@@ -2299,7 +2326,7 @@ function createAttachment(&$attachmentOptions)
 
 	// Security checks for images
 	// Do we have an image? If yes, we need to check it out!
-	if (isset($validImageTypes[$size[2]]))
+	if (!empty($size[2]) && isset($validImageTypes[$size[2]]))
 	{
 		if (!checkImageContents($attachmentOptions['destination'], !empty($modSettings['attachment_image_paranoid'])))
 		{
@@ -2325,7 +2352,7 @@ function createAttachment(&$attachmentOptions)
 				// Let's update the image information
 				// !!! This is becoming a mess: we keep coming back and update the database,
 				//  instead of getting it right the first time.
-				if (isset($validImageTypes[$size[2]]))
+				if (!empty($size[2]) && isset($validImageTypes[$size[2]]))
 				{
 					$attachmentOptions['mime_type'] = 'image/' . $validImageTypes[$size[2]];
 					$smcFunc['db_query']('', '
@@ -2357,7 +2384,7 @@ function createAttachment(&$attachmentOptions)
 
 			if (!empty($size['mime']))
 				$thumb_mime = $size['mime'];
-			elseif (isset($validImageTypes[$size[2]]))
+			elseif (!empty($size[2]) && isset($validImageTypes[$size[2]]))
 				$thumb_mime = 'image/' . $validImageTypes[$size[2]];
 			// Lord only knows how this happened...
 			else
@@ -2924,6 +2951,15 @@ function sendApprovalNotifications(&$topicData)
 				'UNSUBSCRIBELINK' => $scripturl . '?action=notify;topic=' . $row['id_topic'] . '.0',
 			);
 
+			// Make a token for the unsubscribe link
+			if (!empty($modSettings['notify_tokens']))
+			{
+				require_once($sourcedir . '/Notify.php');
+				$token = createUnsubscribeToken($row['id_member'], $row['email_address'], 'topic', $row['id_topic']);
+
+				$replacements['UNSUBSCRIBELINK'] .= ';u=' . $row['id_member'] . ';token=' . $token;
+			}
+
 			$message_type = 'notification_reply';
 			// Do they want the body of the message sent too?
 			if (!empty($row['notify_send_body']) && empty($modSettings['disallow_sendBody']))
diff --git a/Sources/Subs-Sound.php b/Sources/Subs-Sound.php
index a71a436..6323cbf 100644
--- a/Sources/Subs-Sound.php
+++ b/Sources/Subs-Sound.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -36,7 +36,8 @@ function createWaveFile($word)
 	cache_put_data('wave_file/' . $user_info['ip2'], $ip2 ? $ip2 + 1 : 1, 20);
 
 	// Fixate randomization for this word.
-	mt_srand(end(unpack('n', md5($word . session_id()))));
+	$unpacked = unpack('n', md5($word . session_id()));
+	mt_srand(end($unpacked));
 
 	// Try to see if there's a sound font in the user's language.
 	if (file_exists($settings['default_theme_dir'] . '/fonts/sound/a.' . $user_info['language'] . '.wav'))
@@ -57,23 +58,23 @@ function createWaveFile($word)
 	$sound_word = '';
 	for ($i = 0; $i < strlen($word); $i++)
 	{
-		$sound_letter = implode('', file($settings['default_theme_dir'] . '/fonts/sound/' . $word{$i} . '.' . $sound_language . '.wav'));
+		$sound_letter = implode('', file($settings['default_theme_dir'] . '/fonts/sound/' . $word[$i] . '.' . $sound_language . '.wav'));
 		if (strpos($sound_letter, 'data') === false)
 			return false;
 
 		$sound_letter = substr($sound_letter, strpos($sound_letter, 'data') + 8);
-		switch ($word{$i} === 's' ? 0 : mt_rand(0, 2))
+		switch ($word[$i] === 's' ? 0 : mt_rand(0, 2))
 		{
 			case 0:
 				for ($j = 0, $n = strlen($sound_letter); $j < $n; $j++)
 					for ($k = 0, $m = round(mt_rand(15, 25) / 10); $k < $m; $k++)
-						$sound_word .= $word{$i} === 's' ? $sound_letter{$j} : chr(mt_rand(max(ord($sound_letter{$j}) - 1, 0x00), min(ord($sound_letter{$j}) + 1, 0xFF)));
+						$sound_word .= $word[$i] === 's' ? $sound_letter[$j] : chr(mt_rand(max(ord($sound_letter[$j]) - 1, 0x00), min(ord($sound_letter[$j]) + 1, 0xFF)));
 			break;
 
 			case 1:
 				for ($j = 0, $n = strlen($sound_letter) - 1; $j < $n; $j += 2)
-					$sound_word .= (mt_rand(0, 3) == 0 ? '' : $sound_letter{$j}) . (mt_rand(0, 3) === 0 ? $sound_letter{$j + 1} : $sound_letter{$j}) . (mt_rand(0, 3) === 0 ? $sound_letter{$j} : $sound_letter{$j + 1}) . $sound_letter{$j + 1} . (mt_rand(0, 3) == 0 ? $sound_letter{$j + 1} : '');
-				$sound_word .= str_repeat($sound_letter{$n}, 2);
+					$sound_word .= (mt_rand(0, 3) == 0 ? '' : $sound_letter[$j]) . (mt_rand(0, 3) === 0 ? $sound_letter[$j + 1] : $sound_letter[$j]) . (mt_rand(0, 3) === 0 ? $sound_letter[$j] : $sound_letter[$j + 1]) . $sound_letter[$j + 1] . (mt_rand(0, 3) == 0 ? $sound_letter[$j + 1] : '');
+				$sound_word .= str_repeat($sound_letter[$n], 2);
 			break;
 
 			case 2:
@@ -83,7 +84,7 @@ function createWaveFile($word)
 					if (mt_rand(0, 10) === 0)
 						$shift += mt_rand(-3, 3);
 					for ($k = 0, $m = round(mt_rand(15, 25) / 10); $k < $m; $k++)
-						$sound_word .= chr(min(max(ord($sound_letter{$j}) + $shift, 0x00), 0xFF));
+						$sound_word .= chr(min(max(ord($sound_letter[$j]) + $shift, 0x00), 0xFF));
 				}
 			break;
 
diff --git a/Sources/Subs.php b/Sources/Subs.php
index b8314dc..fe01136 100644
--- a/Sources/Subs.php
+++ b/Sources/Subs.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.13
+ * @version 2.0.18
  */
 
 if (!defined('SMF'))
@@ -1090,41 +1090,36 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'type' => 'unparsed_content',
 				'content' => '<div class="codeheader">' . $txt['code'] . ': <a href="javascript:void(0);" onclick="return smfSelectText(this);" class="codeoperation">' . $txt['code_select'] . '</a></div>' . ($context['browser']['is_gecko'] || $context['browser']['is_opera'] ? '<pre style="margin: 0; padding: 0;">' : '') . '<code class="bbc_code">$1</code>' . ($context['browser']['is_gecko'] || $context['browser']['is_opera'] ? '</pre>' : ''),
 				// !!! Maybe this can be simplified?
-				'validate' => isset($disabled['code']) ? null : create_function('&$tag, &$data, $disabled', '
-					global $context;
-
-					if (!isset($disabled[\'code\']))
+				'validate' => isset($disabled['code']) ? null : function(&$tag, &$data, $disabled) use ($context)
+				{
+					if (!isset($disabled['code']))
 					{
-						$php_parts = preg_split(\'~(&lt;\?php|\?&gt;)~\', $data, -1, PREG_SPLIT_DELIM_CAPTURE);
+						$php_parts = preg_split('~(&lt;\?php|\?&gt;)~', $data, -1, PREG_SPLIT_DELIM_CAPTURE);
 
 						for ($php_i = 0, $php_n = count($php_parts); $php_i < $php_n; $php_i++)
 						{
 							// Do PHP code coloring?
-							if ($php_parts[$php_i] != \'&lt;?php\')
+							if ($php_parts[$php_i] != '&lt;?php')
 								continue;
 
-							$php_string = \'\';
-							while ($php_i + 1 < count($php_parts) && $php_parts[$php_i] != \'?&gt;\')
+							$php_string = '';
+							while ($php_i + 1 < count($php_parts) && $php_parts[$php_i] != '?&gt;')
 							{
 								$php_string .= $php_parts[$php_i];
-								$php_parts[$php_i++] = \'\';
+								$php_parts[$php_i++] = '';
 							}
 							$php_parts[$php_i] = highlight_php_code($php_string . $php_parts[$php_i]);
 						}
 
 						// Fix the PHP code stuff...
-						$data = str_replace("<pre style=\"display: inline;\">\t</pre>", "\t", implode(\'\', $php_parts));
-
-						// Older browsers are annoying, aren\'t they?
-						if ($context[\'browser\'][\'is_ie4\'] || $context[\'browser\'][\'is_ie5\'] || $context[\'browser\'][\'is_ie5.5\'])
-							$data = str_replace("\t", "<pre style=\"display: inline;\">\t</pre>", $data);
-						else
-							$data = str_replace("\t", "<span style=\"white-space: pre;\">\t</span>", $data);
+						$data = str_replace("<pre style=\"display: inline;\">\t</pre>", "\t", implode('', $php_parts));
+						$data = str_replace("\t", "<span style=\"white-space: pre;\">\t</span>", $data);
 
 						// Recent Opera bug requiring temporary fix. &nsbp; is needed before </code> to avoid broken selection.
-						if ($context[\'browser\'][\'is_opera\'])
-							$data .= \'&nbsp;\';
-					}'),
+						if (!empty($context['browser']['is_opera']))
+							$data .= '&nbsp;';
+					}
+				},
 				'block_level' => true,
 			),
 			array(
@@ -1132,41 +1127,36 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'type' => 'unparsed_equals_content',
 				'content' => '<div class="codeheader">' . $txt['code'] . ': ($2) <a href="#" onclick="return smfSelectText(this);" class="codeoperation">' . $txt['code_select'] . '</a></div>' . ($context['browser']['is_gecko'] || $context['browser']['is_opera'] ? '<pre style="margin: 0; padding: 0;">' : '') . '<code class="bbc_code">$1</code>' . ($context['browser']['is_gecko'] || $context['browser']['is_opera'] ? '</pre>' : ''),
 				// !!! Maybe this can be simplified?
-				'validate' => isset($disabled['code']) ? null : create_function('&$tag, &$data, $disabled', '
-					global $context;
-
-					if (!isset($disabled[\'code\']))
+				'validate' => isset($disabled['code']) ? null : function(&$tag, &$data, $disabled) use ($context)
+				{
+					if (!isset($disabled['code']))
 					{
-						$php_parts = preg_split(\'~(&lt;\?php|\?&gt;)~\', $data[0], -1, PREG_SPLIT_DELIM_CAPTURE);
+						$php_parts = preg_split('~(&lt;\?php|\?&gt;)~', $data[0], -1, PREG_SPLIT_DELIM_CAPTURE);
 
 						for ($php_i = 0, $php_n = count($php_parts); $php_i < $php_n; $php_i++)
 						{
 							// Do PHP code coloring?
-							if ($php_parts[$php_i] != \'&lt;?php\')
+							if ($php_parts[$php_i] != '&lt;?php')
 								continue;
 
-							$php_string = \'\';
-							while ($php_i + 1 < count($php_parts) && $php_parts[$php_i] != \'?&gt;\')
+							$php_string = '';
+							while ($php_i + 1 < count($php_parts) && $php_parts[$php_i] != '?&gt;')
 							{
 								$php_string .= $php_parts[$php_i];
-								$php_parts[$php_i++] = \'\';
+								$php_parts[$php_i++] = '';
 							}
 							$php_parts[$php_i] = highlight_php_code($php_string . $php_parts[$php_i]);
 						}
 
 						// Fix the PHP code stuff...
-						$data[0] = str_replace("<pre style=\"display: inline;\">\t</pre>", "\t", implode(\'\', $php_parts));
-
-						// Older browsers are annoying, aren\'t they?
-						if ($context[\'browser\'][\'is_ie4\'] || $context[\'browser\'][\'is_ie5\'] || $context[\'browser\'][\'is_ie5.5\'])
-							$data[0] = str_replace("\t", "<pre style=\"display: inline;\">\t</pre>", $data[0]);
-						else
-							$data[0] = str_replace("\t", "<span style=\"white-space: pre;\">\t</span>", $data[0]);
+						$data[0] = str_replace("<pre style=\"display: inline;\">\t</pre>", "\t", implode('', $php_parts));
+						$data[0] = str_replace("\t", "<span style=\"white-space: pre;\">\t</span>", $data[0]);
 
 						// Recent Opera bug requiring temporary fix. &nsbp; is needed before </code> to avoid broken selection.
-						if ($context[\'browser\'][\'is_opera\'])
-							$data[0] .= \'&nbsp;\';
-					}'),
+						if (!empty($context['browser']['is_opera']))
+							$data[0] .= '&nbsp;';
+					}
+				},
 				'block_level' => true,
 			),
 			array(
@@ -1181,7 +1171,10 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'type' => 'unparsed_content',
 				'content' => '<a href="mailto:$1" class="bbc_email">$1</a>',
 				// !!! Should this respect guest_hideContacts?
-				'validate' => create_function('&$tag, &$data, $disabled', '$data = strtr($data, array(\'<br />\' => \'\'));'),
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					$data = strtr($data, array('<br>' => ''));
+				},
 			),
 			array(
 				'tag' => 'email',
@@ -1196,14 +1189,15 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'tag' => 'flash',
 				'type' => 'unparsed_commas_content',
 				'test' => '\d+,\d+\]',
-				'content' => ($context['browser']['is_ie'] && !$context['browser']['is_mac_ie'] ? '<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="$2" height="$3"><param name="movie" value="$1" /><param name="play" value="true" /><param name="loop" value="true" /><param name="quality" value="high" /><param name="AllowScriptAccess" value="never" /><embed src="$1" width="$2" height="$3" play="true" loop="true" quality="high" AllowScriptAccess="never" /><noembed><a href="$1" target="_blank" class="new_win">$1</a></noembed></object>' : '<embed type="application/x-shockwave-flash" src="$1" width="$2" height="$3" play="true" loop="true" quality="high" AllowScriptAccess="never" /><noembed><a href="$1" target="_blank" class="new_win">$1</a></noembed>'),
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					if (isset($disabled[\'url\']))
-						$tag[\'content\'] = \'$1\';
-					elseif (strpos($data[0], \'http://\') !== 0 && strpos($data[0], \'https://\') !== 0)
-						$data[0] = \'http://\' . $data[0];
-				'),
-				'disabled_content' => '<a href="$1" target="_blank" class="new_win">$1</a>',
+				'content' => ($context['browser']['is_ie'] && !$context['browser']['is_mac_ie'] ? '<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="$2" height="$3"><param name="movie" value="$1" /><param name="play" value="true" /><param name="loop" value="true" /><param name="quality" value="high" /><param name="AllowScriptAccess" value="never" /><embed src="$1" width="$2" height="$3" play="true" loop="true" quality="high" AllowScriptAccess="never" /><noembed><a href="$1" target="_blank" rel="noopener noreferrer" class="bbc_link bbc_flash_disabled new_win">$1</a></noembed></object>' : '<embed type="application/x-shockwave-flash" src="$1" width="$2" height="$3" play="true" loop="true" quality="high" AllowScriptAccess="never" /><noembed><a href="$1" target="_blank" rel="noopener noreferrer" class="bbc_link bbc_flash_disabled new_win">$1</a></noembed>'),
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					if (isset($disabled['url']))
+						$tag['content'] = '$1';
+					elseif (strpos($data[0], 'http://') !== 0 && strpos($data[0], 'https://') !== 0)
+						$data[0] = 'http://' . $data[0];
+				},
+				'disabled_content' => '<a href="$1" target="_blank" rel="noopener noreferrer" class="bbc_link bbc_flash_disabled new_win">$1</a>',
 			),
 			array(
 				'tag' => 'font',
@@ -1222,22 +1216,24 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 			array(
 				'tag' => 'ftp',
 				'type' => 'unparsed_content',
-				'content' => '<a href="$1" class="bbc_ftp new_win" target="_blank">$1</a>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					$data = strtr($data, array(\'<br />\' => \'\'));
-					if (strpos($data, \'ftp://\') !== 0 && strpos($data, \'ftps://\') !== 0)
-						$data = \'ftp://\' . $data;
-				'),
+				'content' => '<a href="$1" class="bbc_ftp new_win" target="_blank" rel="noopener noreferrer">$1</a>',
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					$data = strtr($data, array('<br />' => ''));
+					if (strpos($data, 'ftp://') !== 0 && strpos($data, 'ftps://') !== 0)
+						$data = 'ftp://' . $data;
+				},
 			),
 			array(
 				'tag' => 'ftp',
 				'type' => 'unparsed_equals',
-				'before' => '<a href="$1" class="bbc_ftp new_win" target="_blank">',
+				'before' => '<a href="$1" class="bbc_ftp new_win" target="_blank" rel="noopener noreferrer">',
 				'after' => '</a>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					if (strpos($data, \'ftp://\') !== 0 && strpos($data, \'ftps://\') !== 0)
-						$data = \'ftp://\' . $data;
-				'),
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					if (strpos($data, 'ftp://') !== 0 && strpos($data, 'ftps://') !== 0)
+						$data = 'ftp://' . $data;
+				},
 				'disallow_children' => array('email', 'ftp', 'url', 'iurl'),
 				'disabled_after' => ' ($1)',
 			),
@@ -1280,45 +1276,53 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 					'height' => array('optional' => true, 'value' => ' height="$1"', 'match' => '(\d+)'),
 				),
 				'content' => '<img src="$1" alt="{alt}"{width}{height} class="bbc_img resized" />',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					$data = strtr($data, array(\'<br />\' => \'\'));
-					if (strpos($data, \'http://\') !== 0 && strpos($data, \'https://\') !== 0)
-						$data = \'http://\' . $data;
-				'),
+				'validate' => function (&$tag, &$data, $disabled)
+				{
+					$data = strtr($data, array('<br>' => ''));
+					if (strpos($data, 'http://') !== 0 && strpos($data, 'https://') !== 0)
+						$data = 'http://' . $data;
+
+					$data = get_proxied_url($data);
+				},
 				'disabled_content' => '($1)',
 			),
 			array(
 				'tag' => 'img',
 				'type' => 'unparsed_content',
 				'content' => '<img src="$1" alt="" class="bbc_img" />',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					$data = strtr($data, array(\'<br />\' => \'\'));
-					if (strpos($data, \'http://\') !== 0 && strpos($data, \'https://\') !== 0)
-						$data = \'http://\' . $data;
-				'),
+				'validate' => function (&$tag, &$data, $disabled)
+				{
+					$data = strtr($data, array('<br>' => ''));
+					if (strpos($data, 'http://') !== 0 && strpos($data, 'https://') !== 0)
+						$data = 'http://' . $data;
+
+					$data = get_proxied_url($data);
+				},
 				'disabled_content' => '($1)',
 			),
 			array(
 				'tag' => 'iurl',
 				'type' => 'unparsed_content',
 				'content' => '<a href="$1" class="bbc_link">$1</a>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					$data = strtr($data, array(\'<br />\' => \'\'));
-					if (strpos($data, \'http://\') !== 0 && strpos($data, \'https://\') !== 0)
-						$data = \'http://\' . $data;
-				'),
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					$data = strtr($data, array('<br />' => ''));
+					if (strpos($data, 'http://') !== 0 && strpos($data, 'https://') !== 0)
+						$data = 'http://' . $data;
+				},
 			),
 			array(
 				'tag' => 'iurl',
 				'type' => 'unparsed_equals',
 				'before' => '<a href="$1" class="bbc_link">',
 				'after' => '</a>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					if (substr($data, 0, 1) == \'#\')
-						$data = \'#post_\' . substr($data, 1);
-					elseif (strpos($data, \'http://\') !== 0 && strpos($data, \'https://\') !== 0)
-						$data = \'http://\' . $data;
-				'),
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					if (substr($data, 0, 1) == '#')
+						$data = '#post_' . substr($data, 1);
+					elseif (strpos($data, 'http://') !== 0 && strpos($data, 'https://') !== 0)
+						$data = 'http://' . $data;
+				},
 				'disallow_children' => array('email', 'ftp', 'url', 'iurl'),
 				'disabled_after' => ' ($1)',
 			),
@@ -1389,14 +1393,16 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'tag' => 'php',
 				'type' => 'unparsed_content',
 				'content' => '<span class="phpcode">$1</span>',
-				'validate' => isset($disabled['php']) ? null : create_function('&$tag, &$data, $disabled', '
-					if (!isset($disabled[\'php\']))
+				'validate' => isset($disabled['php']) ? null : function(&$tag, &$data, $disabled)
+				{
+					if (!isset($disabled['php']))
 					{
-						$add_begin = substr(trim($data), 0, 5) != \'&lt;?\';
-						$data = highlight_php_code($add_begin ? \'&lt;?php \' . $data . \'?&gt;\' : $data);
+						$add_begin = substr(trim($data), 0, 5) != '&lt;?';
+						$data = highlight_php_code($add_begin ? '&lt;?php ' . $data . '?&gt;' : $data);
 						if ($add_begin)
-							$data = preg_replace(array(\'~^(.+?)&lt;\?.{0,40}?php(?:&nbsp;|\s)~\', \'~\?&gt;((?:</(font|span)>)*)$~\'), \'$1\', $data, 2);
-					}'),
+							$data = preg_replace(array('~^(.+?)&lt;\?.{0,40}?php(?:&nbsp;|\s)~', '~\?&gt;((?:</(font|span)>)*)$~'), '$1', $data, 2);
+					}
+				},
 				'block_level' => false,
 				'disabled_content' => '$1',
 			),
@@ -1478,27 +1484,31 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'test' => '[#0-9a-zA-Z\-]{3,12},(left|right|top|bottom|[0123]\d{0,2})\]',
 				'before' => $context['browser']['is_ie'] ? '<span style="display: inline-block; filter: Shadow(color=$1, direction=$2); height: 1.2em;">' : '<span style="text-shadow: $1 $2">',
 				'after' => '</span>',
-				'validate' => $context['browser']['is_ie'] ? create_function('&$tag, &$data, $disabled', '
-					if ($data[1] == \'left\')
+				'validate' => $context['browser']['is_ie'] ? function(&$tag, &$data, $disabled)
+				{
+					if ($data[1] == 'left')
 						$data[1] = 270;
-					elseif ($data[1] == \'right\')
+					elseif ($data[1] == 'right')
 						$data[1] = 90;
-					elseif ($data[1] == \'top\')
+					elseif ($data[1] == 'top')
 						$data[1] = 0;
-					elseif ($data[1] == \'bottom\')
+					elseif ($data[1] == 'bottom')
 						$data[1] = 180;
 					else
-						$data[1] = (int) $data[1];') : create_function('&$tag, &$data, $disabled', '
-					if ($data[1] == \'top\' || (is_numeric($data[1]) && $data[1] < 50))
-						$data[1] = \'0 -2px 1px\';
-					elseif ($data[1] == \'right\' || (is_numeric($data[1]) && $data[1] < 100))
-						$data[1] = \'2px 0 1px\';
-					elseif ($data[1] == \'bottom\' || (is_numeric($data[1]) && $data[1] < 190))
-						$data[1] = \'0 2px 1px\';
-					elseif ($data[1] == \'left\' || (is_numeric($data[1]) && $data[1] < 280))
-						$data[1] = \'-2px 0 1px\';
+						$data[1] = (int) $data[1];
+				} : function(&$tag, &$data, $disabled)
+				{
+					if ($data[1] == 'top' || (is_numeric($data[1]) && $data[1] < 50))
+						$data[1] = '0 -2px 1px';
+					elseif ($data[1] == 'right' || (is_numeric($data[1]) && $data[1] < 100))
+						$data[1] = '2px 0 1px';
+					elseif ($data[1] == 'bottom' || (is_numeric($data[1]) && $data[1] < 190))
+						$data[1] = '0 2px 1px';
+					elseif ($data[1] == 'left' || (is_numeric($data[1]) && $data[1] < 280))
+						$data[1] = '-2px 0 1px';
 					else
-						$data[1] = \'1px 1px 1px\';'),
+						$data[1] = '1px 1px 1px';
+				},
 			),
 			array(
 				'tag' => 'size',
@@ -1513,10 +1523,11 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'test' => '[1-7]\]',
 				'before' => '<span style="font-size: $1;" class="bbc_size">',
 				'after' => '</span>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
+				'validate' => function(&$tag, &$data, $disabled)
+				{
 					$sizes = array(1 => 0.7, 2 => 1.0, 3 => 1.35, 4 => 1.45, 5 => 2.0, 6 => 2.65, 7 => 3.95);
-					$data = $sizes[$data] . \'em\';'
-				),
+					$data = $sizes[$data] . 'em';
+				},
 			),
 			array(
 				'tag' => 'sub',
@@ -1550,11 +1561,13 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 				'tag' => 'time',
 				'type' => 'unparsed_content',
 				'content' => '$1',
-				'validate' => create_function('&$tag, &$data, $disabled', '
+				'validate' => function(&$tag, &$data, $disabled)
+				{
 					if (is_numeric($data))
 						$data = timeformat($data);
 					else
-						$tag[\'content\'] = \'[time]$1[/time]\';'),
+						$tag['content'] = '[time]$1[/time]';
+				},
 			),
 			array(
 				'tag' => 'tr',
@@ -1580,37 +1593,40 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 			array(
 				'tag' => 'url',
 				'type' => 'unparsed_content',
-				'content' => '<a href="$1" class="bbc_link" target="_blank">$1</a>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					$data = strtr($data, array(\'<br />\' => \'\'));
-					if (strpos($data, \'http://\') !== 0 && strpos($data, \'https://\') !== 0)
-						$data = \'http://\' . $data;
-				'),
+				'content' => '<a href="$1" class="bbc_link" target="_blank" rel="noopener noreferrer">$1</a>',
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					if (strpos($data, 'http://') !== 0 && strpos($data, 'https://') !== 0)
+						$data = 'http://' . $data;
+				},
 			),
 			array(
 				'tag' => 'url',
 				'type' => 'unparsed_equals',
-				'before' => '<a href="$1" class="bbc_link" target="_blank">',
+				'before' => '<a href="$1" class="bbc_link" target="_blank" rel="noopener noreferrer">',
 				'after' => '</a>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-					if (strpos($data, \'http://\') !== 0 && strpos($data, \'https://\') !== 0)
-						$data = \'http://\' . $data;
-				'),
+				'validate' => function(&$tag, &$data, $disabled)
+				{
+					if (strpos($data, 'http://') !== 0 && strpos($data, 'https://') !== 0)
+						$data = 'http://' . $data;
+				},
 				'disallow_children' => array('email', 'ftp', 'url', 'iurl'),
 				'disabled_after' => ' ($1)',
 			),
-			array(
-				'tag' => 'youtube',
-				'type' => 'unparsed_content',
-				'content' => '<iframe style="border:0;" width="642" height="392" src="http://www.youtube.com/embed/$1" allowfullscreen></iframe>',
-				'validate' => create_function('&$tag, &$data, $disabled', '
-				if (isset($disabled[\'url\']))
-					$tag[\'content\'] = \'http://www.youtube.com/watch?v=$1\';
-				$pattern = \'~(?:http|https|)(?::\/\/|)(?:www.|)(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/ytscreeningroom\?v=|\/feeds\/api\/videos\/|\/user\S*[^\w\-\s]|\S*[^\w\-\s]))([\w\-]{11})[a-z0-9;:@?&%=+\/\$_.-]*~i\';
-				if (preg_match($pattern, $data, $matches))
-					$data = $matches[1];'),
-				'disabled_content' => 'http://www.youtube.com/watch?v=$1',
-			),
+                        array(
+                                'tag' => 'youtube',
+                                'type' => 'unparsed_content',
+                                'content' => '<iframe style="border:0;" width="642" height="392" src="https://www.youtube.com/embed/$1" allowfullscreen></iframe>',
+                                'validate' => function(&$tag, &$data, $disabled)
+                                {
+                                        if (isset($disabled['url']))
+                                                $tag['content'] = 'https://www.youtube.com/watch?v=$1';
+                                        $pattern = '~(?:http|https|)(?::\/\/|)(?:www.|)(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/ytscreeningroom\?v=|\/feeds\/api\/videos\/|\/user\S*[^\w\-\s]|\S*[^\w\-\s]))([\w\-]{11})[a-z0-9;:@?&%=+\/\$_.-]*~i';
+                                        if (preg_match($pattern, $data, $matches))
+                                                $data = $matches[1];
+                                },
+                                'disabled_content' => 'https://www.youtube.com/watch?v=$1',
+                        ),
 			array(
 				'tag' => 'white',
 				'before' => '<span style="color: white;" class="bbc_color">',
@@ -1877,7 +1893,7 @@ function parse_bbc($message, $smileys = true, $cache_id = '', $parse_tags = arra
 					}
 
 					// Next, emails...
-					if (!isset($disabled['email']) && strpos($data, '@') !== false && strpos($data, '[email') === false)
+					if (!isset($disabled['email']) && filter_var($data, FILTER_VALIDATE_EMAIL) !== false && strpos($data, '[email') === false)
 					{
 						$data = preg_replace('~(?<=[\?\s' . $non_breaking_space . '\[\]()*\\\;>]|^)([\w\-\.]{1,80}@[\w\-]+\.[\w\-\.]+[\w\-])(?=[?,\s' . $non_breaking_space . '\[\]()*\\\]|$|<br />|&nbsp;|&gt;|&lt;|&quot;|&#039;|\.(?:\.|;|&nbsp;|\s|$|<br />))~' . ($context['utf8'] ? 'u' : ''), '[email]$1[/email]', $data);
 						$data = preg_replace('~(?<=<br />)([\w\-\.]{1,80}@[\w\-]+\.[\w\-\.]+[\w\-])(?=[?\.,;\s' . $non_breaking_space . '\[\]()*\\\]|$|<br />|&nbsp;|&gt;|&lt;|&quot;|&#039;)~' . ($context['utf8'] ? 'u' : ''), '[email]$1[/email]', $data);
@@ -2551,23 +2567,6 @@ function parsesmileys(&$message)
 	$message = preg_replace_callback($smileyPregSearch, 'smileyPregReplaceCallback', $message);
 }
 
-// This allows use to do delayed argument binding and bring in the replacement variables for some preg replacements.
-function pregReplaceCurry($func, $arity)
-{
-	return create_function('', "
-		\$args = func_get_args();
-		if(count(\$args) >= $arity)
-			return call_user_func_array('$func', \$args);
-		\$args = var_export(\$args, 1);
-		return create_function('','
-			\$a = func_get_args();
-			\$z = ' . \$args . ';
-			\$a = array_merge(\$z,\$a);
-			return call_user_func_array(\'$func\', \$a);
-		');
-	");
-}
-
 // Our callback that does the actual smiley replacements.
 function smileyPregReplaceCallback($matches)
 {
@@ -2606,7 +2605,9 @@ function highlight_php_code($code)
 // Put this user in the online log.
 function writeLog($force = false)
 {
-	global $user_info, $user_settings, $context, $modSettings, $settings, $topic, $board, $smcFunc, $sourcedir;
+	global $user_info, $user_settings, $context, $modSettings, $settings, $topic, $board, $smcFunc, $sourcedir, $remember_old_url;
+
+	$remember_old_url = true;
 
 	// If we are showing who is viewing a topic, let's see if we are, and force an update if so - to make it accurate.
 	if (!empty($settings['display_who_viewing']) && ($topic || $board))
@@ -2798,7 +2799,7 @@ function redirectexit($setLocation = '', $refresh = false)
 // Ends execution.  Takes care of template loading and remembering the previous URL.
 function obExit($header = null, $do_footer = null, $from_index = false, $from_fatal_error = false)
 {
-	global $context, $settings, $modSettings, $txt, $smcFunc;
+	global $context, $settings, $modSettings, $txt, $smcFunc, $remember_old_url;
 	static $header_done = false, $footer_done = false, $level = 0, $has_fatal_error = false;
 
 	// Attempt to prevent a recursive loop.
@@ -2828,6 +2829,20 @@ function obExit($header = null, $do_footer = null, $from_index = false, $from_fa
 
 		// Start up the session URL fixer.
 		ob_start('ob_sessrewrite');
+		ob_start(function ($buffer) {
+			global $context;
+			if (!$context['user']['is_guest'])
+				return $buffer;
+
+			return preg_replace_callback('~(<form[^<]+action=login2(.+))</form>~iUs' . (!empty($context['utf8']) ? 'u' : ''), function($m) use ($context) {
+				$repl = '';
+
+				if (strpos($m[0], $context['session_var']) === false)
+					$repl .= '<input type="hidden" name="' . $context['session_var'] . '" value="' . $context['session_id'] . '"/>';
+
+				return $m[1] . $repl . '</form>';
+			}, $buffer);
+		});
 
 		if (!empty($settings['output_buffers']) && is_string($settings['output_buffers']))
 			$buffers = explode(',', $settings['output_buffers']);
@@ -2879,7 +2894,8 @@ function obExit($header = null, $do_footer = null, $from_index = false, $from_fa
 	}
 
 	// Remember this URL in case someone doesn't like sending HTTP_REFERER.
-	if (strpos($_SERVER['REQUEST_URL'], 'action=dlattach') === false && strpos($_SERVER['REQUEST_URL'], 'action=viewsmfile') === false)
+	// !!! $remember_old_url is set in writeLog().
+	if (!empty($remember_old_url))
 		$_SESSION['old_url'] = $_SERVER['REQUEST_URL'];
 
 	// For session check verfication.... don't switch browsers...
@@ -2969,7 +2985,9 @@ function logAction($action, $extra = array(), $log_type = 'moderate')
 	}
 
 	// No point in doing anything else, if the log isn't even enabled.
-	if (empty($modSettings['modlog_enabled']) || !isset($log_types[$log_type]))
+	// ...except in certain special cases:
+	$always_log = !empty($modSettings['force_gdpr']) ? array('agreement_accepted', 'policy_accepted', 'agreement_updated', 'policy_updated') : array();
+	if ((empty($modSettings['modlog_enabled']) && !in_array($action, $always_log)) || !isset($log_types[$log_type]))
 		return false;
 
 	if (isset($extra['member']) && !is_numeric($extra['member']))
@@ -3218,7 +3236,7 @@ function determineTopicClass(&$topic_context)
 function setupThemeContext($forceload = false)
 {
 	global $modSettings, $user_info, $scripturl, $context, $settings, $options, $txt, $maintenance;
-	global $user_settings, $smcFunc;
+	global $user_settings, $smcFunc, $boardurl, $image_proxy_enabled, $image_proxy_secret;
 	static $loaded = false;
 
 	// Under SSI this function can be called more then once.  That can cause some problems.
@@ -3271,9 +3289,9 @@ function setupThemeContext($forceload = false)
 		if ($user_info['avatar']['url'] == '' && !empty($user_info['avatar']['id_attach']))
 			$context['user']['avatar']['href'] = $user_info['avatar']['custom_dir'] ? $modSettings['custom_avatar_url'] . '/' . $user_info['avatar']['filename'] : $scripturl . '?action=dlattach;attach=' . $user_info['avatar']['id_attach'] . ';type=avatar';
 		// Full URL?
-		elseif (substr($user_info['avatar']['url'], 0, 7) == 'http://')
+		elseif (substr($user_info['avatar']['url'], 0, 7) == 'http://' || substr($user_info['avatar']['url'], 0, 8) == 'https://')
 		{
-			$context['user']['avatar']['href'] = $user_info['avatar']['url'];
+			$context['user']['avatar']['href'] = get_proxied_url($user_info['avatar']['url']);
 
 			if ($modSettings['avatar_action_too_large'] == 'option_html_resize' || $modSettings['avatar_action_too_large'] == 'option_js_resize')
 			{
@@ -3395,18 +3413,6 @@ function template_header()
 	{
 		header('Expires: Mon, 26 Jul 1997 05:00:00 GMT');
 		header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT');
-
-		// Are we debugging the template/html content?
-		if (!isset($_REQUEST['xml']) && isset($_GET['debug']) && !$context['browser']['is_ie'] && !WIRELESS)
-			header('Content-Type: application/xhtml+xml');
-		elseif (!isset($_REQUEST['xml']) && !WIRELESS)
-			header('Content-Type: text/html; charset=' . (empty($context['character_set']) ? 'ISO-8859-1' : $context['character_set']));
-
-		// Are we debugging the template/html content?
-		if (!isset($_REQUEST['xml']) && isset($_GET['debug']) && !$context['browser']['is_ie'] && !WIRELESS)
-			header('Content-Type: application/xhtml+xml');
-		elseif (!isset($_REQUEST['xml']) && !WIRELESS)
-			header('Content-Type: text/html; charset=' . (empty($context['character_set']) ? 'ISO-8859-1' : $context['character_set']));
 	}
 
 	header('Content-Type: text/' . (isset($_REQUEST['xml']) ? 'xml' : 'html') . '; charset=' . (empty($context['character_set']) ? 'ISO-8859-1' : $context['character_set']));
@@ -3490,7 +3496,7 @@ function template_header()
 // Show the copyright...
 function theme_copyright($get_it = false)
 {
-	global $forum_copyright, $context, $boardurl, $forum_version, $txt, $modSettings;
+	global $forum_copyright, $context, $scripturl, $forum_version, $txt, $modSettings;
 
 	// Don't display copyright for things like SSI.
 	if (!isset($forum_version))
@@ -3499,6 +3505,11 @@ function theme_copyright($get_it = false)
 	// Put in the version...
 	$forum_copyright = sprintf($forum_copyright, $forum_version);
 
+	// It feels icky putting this here, but it's the only good way to do this without
+	// requiring all custom themes to be updated in order to comply with the GDPR.
+	if (!empty($modSettings['force_gdpr']))
+		$forum_copyright .= ' | <a id="button_agreement" href="' . $scripturl . '?action=agreement"><span>' . $txt['terms_and_policies'] . '</span></a>';
+
 	echo '
 			<span class="smalltext" style="display: inline; visibility: visible; font-family: Verdana, Arial, sans-serif;">' . $forum_copyright . '
 			</span>';
@@ -3816,6 +3827,10 @@ function text2words($text, $max_chars = 20, $encrypt = false)
 {
 	global $smcFunc, $context;
 
+	// Upgrader may be working on old DBs...
+	if (!isset($context['utf8']))
+		$context['utf8'] = false;
+
 	// Step 1: Remove entities/things we don't consider words:
 	$words = preg_replace('~(?:[\x0B\0' . ($context['utf8'] ? ($context['server']['complex_preg_chars'] ? '\x{A0}' : "\xC2\xA0") : '\xA0') . '\t\r\s\n(){}\\[\\]<>!@$%^*.,:+=`\~\?/\\\\]+|&(?:amp|lt|gt|quot);)+~' . ($context['utf8'] ? 'u' : ''), ' ', strtr($text, array('<br />' => ' ')));
 
@@ -3836,7 +3851,7 @@ function text2words($text, $max_chars = 20, $encrypt = false)
 				$encrypted = substr(crypt($word, 'uk'), 2, $max_chars);
 				$total = 0;
 				for ($i = 0; $i < $max_chars; $i++)
-					$total += $possible_chars[ord($encrypted{$i})] * pow(63, $i);
+					$total += $possible_chars[ord($encrypted[$i])] * pow(63, $i);
 				$returned_ints[] = $max_chars == 4 ? min($total, 16777215) : $total;
 			}
 		}
@@ -4203,7 +4218,8 @@ function setupMenuContext()
 	elseif ($context['current_action'] == 'groups' && $context['allow_moderation_center'])
 		$current_action = 'moderate';
 
-	$context['menu_buttons'][$current_action]['active_button'] = true;
+	if (isset($context['menu_buttons'][$current_action]))
+		$context['menu_buttons'][$current_action]['active_button'] = true;
 
 	if (!$user_info['is_guest'] && $context['user']['unread_messages'] > 0 && isset($context['menu_buttons']['pm']))
 	{
@@ -4220,7 +4236,7 @@ function smf_seed_generator()
 	// Never existed?
 	if (empty($modSettings['rand_seed']))
 	{
-		$modSettings['rand_seed'] = microtime() * 1000000;
+		$modSettings['rand_seed'] = (double) microtime() * 1000000;
 		updateSettings(array('rand_seed' => $modSettings['rand_seed']));
 	}
 
@@ -4380,6 +4396,30 @@ function fixchar__callback($matches)
 		return chr(($num >> 18) + 240) . chr((($num >> 12) & 63) + 128) . chr((($num >> 6) & 63) + 128) . chr(($num & 63) + 128);
 }
 
+/**
+ * Converts html entities to utf8 equivalents
+ * special db wrapper for mysql based on the limitation of mysql/mb3
+ *
+ * Callback function for preg_replace_callback
+ * Uses capture group 1 in the supplied array
+ * Does basic checks to keep characters inside a viewable range.
+ *
+ * @param array $matches An array of matches (relevant info should be the 2nd item in the array)
+ * @return string The fixed string or return the old when limitation of mysql is hit
+ */
+function fixchardb__callback($matches)
+{
+	global $db_type;
+	if (!isset($matches[1]))
+		return '';
+	$num = $matches[1][0] === 'x' ? hexdec(substr($matches[1], 1)) : (int) $matches[1];
+	// it's to big for mb3?
+	if ($num > 0xFFFF && $db_type == 'mysql')
+		return $matches[0];
+	else
+		return fixchar__callback($matches);
+}
+
 // Strips out invalid html entities, replaces others with html style &#123; codes.
 function entity_fix__callback($matches)
 {
@@ -4702,4 +4742,41 @@ function safe_unserialize($str)
 
 	return $out;
 }
-?>
\ No newline at end of file
+
+/**
+ * Gets the appropriate URL to use for images (or whatever) when using SSL
+ *
+ * The returned URL may or may not be a proxied URL, depending on the situation.
+ * Mods can implement alternative proxies using the 'integrate_proxy' hook.
+ *
+ * @param string $url The original URL of the requested resource
+ * @return string The URL to use
+ */
+function get_proxied_url($url)
+{
+	global $boardurl, $image_proxy_enabled, $image_proxy_secret, $user_info;
+
+	// Only use the proxy if enabled, and never for robots
+	if (empty($image_proxy_enabled) || !empty($user_info['possibly_robot']))
+		return $url;
+
+	$parsedurl = parse_url($url);
+
+	// Don't bother with HTTPS URLs, schemeless URLs, or obviously invalid URLs
+	if (empty($parsedurl['scheme']) || empty($parsedurl['host']) || empty($parsedurl['path']) || $parsedurl['scheme'] === 'https')
+		return $url;
+
+	// We don't need to proxy our own resources
+	if ($parsedurl['host'] === parse_url($boardurl, PHP_URL_HOST))
+		return strtr($url, array('http://' => 'https://'));
+
+	// By default, use SMF's own image proxy script
+	$proxied_url = strtr($boardurl, array('http://' => 'https://')) . '/proxy.php?request=' . urlencode($url) . '&hash=' . hash_hmac('sha1', $url, $image_proxy_secret);
+
+	// Allow mods to easily implement an alternative proxy
+	call_integration_hook('integrate_proxy', array($url, &$proxied_url));
+
+	return $proxied_url;
+}
+
+?>
diff --git a/Sources/Themes.php b/Sources/Themes.php
index 6241198..dd63040 100644
--- a/Sources/Themes.php
+++ b/Sources/Themes.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.13
+ * @version 2.0.16
  */
 
 if (!defined('SMF'))
@@ -1064,13 +1064,14 @@ function PickTheme()
 		// Change a specific member's theme.
 		else
 		{
-			if (isset($_GET['th']) && $_GET['th'] == 0)
-				$_GET['th'] = $modSettings['theme_guests'];
-
+			// An identifier of zero means that the user wants the forum default theme.
 			updateMemberData((int) $_REQUEST['u'], array('id_theme' => (int) $_GET['th']));
 
 			if (!empty($_GET['vrt']))
 			{
+				// Set the identifier to the forum default.
+				if (isset($_GET['th']) && $_GET['th'] == 0)
+					$_GET['th'] = $modSettings['theme_guests'];
 				$smcFunc['db_insert']('replace',
 					'{db_prefix}themes',
 					array('id_theme' => 'int', 'id_member' => 'int', 'variable' => 'string-255', 'value' => 'string-65534'),
@@ -1409,7 +1410,7 @@ function ThemeInstall()
 	<!-- Author: your email address or contact information. The name attribute is optional. -->
 	<author name="Simple Machines">info@simplemachines.org</author>
 	<!-- Website... where to get updates and more information. -->
-	<website>http://www.simplemachines.org/</website>
+	<website>https://www.simplemachines.org/</website>
 	<!-- Template layers to use, defaults to "html,body". -->
 	<layers>' . (empty($theme_layers) ? 'html,body' : $theme_layers) . '</layers>
 	<!-- Templates to load on startup. Default is "index". -->
diff --git a/Sources/Who.php b/Sources/Who.php
index 0129ff3..016ea9d 100644
--- a/Sources/Who.php
+++ b/Sources/Who.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.12
+ * @version 2.0.19
  */
 
 if (!defined('SMF'))
@@ -530,6 +530,11 @@ function Credits($in_admin = false)
 				array(
 					'title' => $txt['credits_groups_ps'],
 					'members' => array(
+						'Aleksi &quot;Lex&quot; Kilpinen',
+						// Former Project Managers
+						'Michele &quot;Illori&quot; Davis',
+						'Jessica &quot;Suki&quot; Gonz&aacute;lez',
+						'Will &quot;Kindred&quot; Wagner',
 						'Michael &quot;Oldiesmann&quot; Eshom',
 						'Amacythe',
 						'Jeremy &quot;SleePy&quot; Darwood',
@@ -539,14 +544,27 @@ function Credits($in_admin = false)
 				array(
 					'title' => $txt['credits_groups_dev'],
 					'members' => array(
+						// Lead Developer
+						'Jon &quot;Sesquipedalian&quot; Stovell',
+						// Developers
+						'Jessica &quot;Suki&quot; Gonz&aacute;lez',
+						'John &quot;live627&quot; Rayes',
+						'Oscar &quot;Ozp&quot; Rydh',
+						'Shawn Bulen',
+
+						// Former Developers
 						'Norv',
 						'Aaron van Geffen',
 						'Antechinus',
 						'Bjoern &quot;Bloc&quot; Kristiansen',
+						'Colin Schoen',
+						'emanuele',
 						'Hendrik Jan &quot;Compuart&quot; Visser',
+						'Jeremy &quot;SleePy&quot; Darwood',
 						'Juan &quot;JayBachatero&quot; Hernandez',
 						'Karl &quot;RegularExpression&quot; Benson',
 						$user_info['is_admin'] ? 'Matt &quot;Grudge&quot; Wolf': 'Grudge',
+						'Michael &quot;Oldiesmann&quot; Eshom',
 						'Michael &quot;Thantos&quot; Miller',
 						'Selman &quot;[SiNaN]&quot; Eser',
 						'Theodore &quot;Orstio&quot; Hildebrandt',
@@ -557,26 +575,40 @@ function Credits($in_admin = false)
 				array(
 					'title' => $txt['credits_groups_support'],
 					'members' => array(
+						// Lead Support Specialist
+						'Will &quot;Kindred&quot; Wagner',
+						// Support Specialists
+						'lurkalot',
+						'shadav',
+						'Steve',
+
+						// Former Support Specialists
+						'Aleksi &quot;Lex&quot; Kilpinen',
 						'JimM',
 						'Adish &quot;(F.L.A.M.E.R)&quot; Patel',
 						'Aleksi &quot;Lex&quot; Kilpinen',
 						'Ben Scott',
 						'Bigguy',
+						'br360',
 						'CapadY',
+						'Chalky',
 						'Chas Large',
 						'Duncan85',
 						'Eliana Tamerin',
 						'Fiery',
+						'Gary M. Gadsdon',
+						'GigaWatt',
 						'gbsothere',
 						'Harro',
 						'Huw',
 						'Jan-Olof &quot;Owdy&quot; Eriksson',
 						'Jeremy &quot;jerm&quot; Strike',
-						'Jessica &quot;Miss All Sunday&quot; Gonzales',
+						'Justyne',
 						'K@',
 						'Kevin &quot;greyknight17&quot; Hou',
 						'KGIII',
 						'Kill Em All',
+						'margarett',
 						'Mattitude',
 						'Mashby',
 						'Mick G.',
@@ -592,31 +624,45 @@ function Credits($in_admin = false)
 						'S-Ace',
 						'Wade &quot;s&eta;&sigma;&omega;&quot; Poulsen',
 						'xenovanis',
+						'ziycon',
 					),
 				),
 				array(
 					'title' => $txt['credits_groups_customize'],
 					'members' => array(
+						// Lead Customizer
+						'Gary M. Gadsdon',
+						// Customizers
+						'Diego Andr&eacute;s',
+						'Jonathan &quot;vbgamer45&quot; Valentin',
+						'Mick.',
+
+						// Former Customizers
 						'Brad &quot;IchBin&trade;&quot; Grow',
 						'&#12487;&#12451;&#12531;1031',
 						'Brannon &quot;B&quot; Hall',
 						'Bryan &quot;Runic&quot; Deakin',
+						'Bugo',
 						'Bulakbol',
 						'Colin &quot;Shadow82x&quot; Blaber',
 						'Daniel15',
 						'Eren Yasarkurt',
-						'Gary M. Gadsdon',
+						'Gwenwyfar',
 						'Jason &quot;JBlaze&quot; Clemons',
 						'Jerry',
-						'Jonathan &quot;vbgamer45&quot; Valentin',
+						'Joker&trade;',
 						'Kays',
 						'Killer Possum',
 						'Kirby',
 						'Matt &quot;SlammedDime&quot; Zuba',
 						'Matthew &quot;Labradoodle-360&quot; Kerle',
+						'NanoSector',
+						'nend',
 						'Nibogo',
 						'Niko',
 						'Peter &quot;Arantor&quot; Spicer',
+						'Ricky.',
+						'Sami &quot;SychO&quot; Mazouz',
 						'snork13',
 						'Spuds',
 						'Steven &quot;Fustrate&quot; Hoffman',
@@ -626,8 +672,15 @@ function Credits($in_admin = false)
 				array(
 					'title' => $txt['credits_groups_docs'],
 					'members' => array(
+						// Doc Coordinator
+						'Michele &quot;Illori&quot; Davis',
+						// Doc Writers
+						'Irisado',
+
+						// Former Doc Writers
 						'Joshua &quot;groundup&quot; Dickerson',
 						'AngellinaBelle',
+						'Chainy',
 						'Daniel Diehl',
 						'Dannii Willis',
 						'emanuele',
@@ -640,17 +693,30 @@ function Credits($in_admin = false)
 				array(
 					'title' => $txt['credits_groups_marketing'],
 					'members' => array(
-						'Kindred',
+						// Marketing Coordinator
+
+						// Marketing
+
+						// Former Marketing
+						'Will &quot;Kindred&quot; Wagner',
 						'Marcus &quot;c&sigma;&sigma;&#1082;&iota;&#1108; &#1084;&sigma;&eta;&#1109;&#1090;&#1108;&#1103;&quot; Forsberg',
 						'Ralph &quot;[n3rve]&quot; Otowo',
 						'rickC',
 						'Tony Reid',
+						'Mert &quot;Antes&quot; Al&#x0131;nbay',
 					),
 				),
 				array(
 					'title' => $txt['credits_groups_internationalizers'],
 					'members' => array(
+						// Lead Localizer
+						'Nikola &quot;Dzonny&quot; Novakovi',
+						// Localizers
+						'Francisco &quot;d3vcho&quot; Domnguez',
+						'm4z',
+						// Former Localizers
 						'Relyana',
+						'Robert.',
 						'Akyhne',
 						'GravuTrad',
 					),
@@ -659,7 +725,8 @@ function Credits($in_admin = false)
 					'title' => $txt['credits_groups_servers'],
 					'members' => array(
 						'Derek Schwab',
-						'Liroy &quot;CoreISP&quot; van Hoewijk',
+						'Michael Johnson',
+						'Liroy van Hoewijk',
 					),
 				),
 			),
@@ -716,6 +783,15 @@ function Credits($in_admin = false)
 					'David Recordon',
 				),
 			),
+			array(
+				'title' => $txt['credits_in_memoriam'],
+				'members' => array(
+					'Crip',
+					'K@',
+					'metallica48423',
+					'Paul_Pauline',
+				),
+			),
 		),
 	);
 
diff --git a/Themes/core/Display.template.php b/Themes/core/Display.template.php
index cf74eca..16cd8e3 100644
--- a/Themes/core/Display.template.php
+++ b/Themes/core/Display.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 function template_main()
@@ -395,7 +395,7 @@ function template_main()
 				// Don't show an icon if they haven't specified a website.
 				if ($message['member']['website']['url'] != '' && !isset($context['disabled_fields']['website']))
 					echo '
-								<li><a href="', $message['member']['website']['url'], '" title="' . $message['member']['website']['title'] . '" target="_blank" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $message['member']['website']['title'] . '" border="0" />' : $txt['www']), '</a></li>';
+								<li><a href="', $message['member']['website']['url'], '" title="' . $message['member']['website']['title'] . '" target="_blank" rel="noopener noreferrer" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $message['member']['website']['title'] . '" border="0" />' : $txt['www']), '</a></li>';
 
 				// Don't show the email address if they want it hidden.
 				if (in_array($message['member']['show_email'], array('yes', 'yes_permission_override', 'no_through_forum')))
diff --git a/Themes/core/Memberlist.template.php b/Themes/core/Memberlist.template.php
index 4aebdfe..7bd05b5 100644
--- a/Themes/core/Memberlist.template.php
+++ b/Themes/core/Memberlist.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // Displays a sortable listing of all members registered on the forum.
@@ -82,7 +82,7 @@ function template_main()
 
 		if (!isset($context['disabled_fields']['website']))
 			echo '
-					<td align="center" class="windowbg">', $member['website']['url'] != '' ? '<a href="' . $member['website']['url'] . '" target="_blank" class="new_win"><img src="' . $settings['images_url'] . '/www.gif" alt="' . $member['website']['title'] . '" title="' . $member['website']['title'] . '" /></a>' : '', '</td>';
+					<td align="center" class="windowbg">', $member['website']['url'] != '' ? '<a href="' . $member['website']['url'] . '" target="_blank" rel="noopener noreferrer" class="new_win"><img src="' . $settings['images_url'] . '/www.gif" alt="' . $member['website']['title'] . '" title="' . $member['website']['title'] . '" /></a>' : '', '</td>';
 
 		// ICQ?
 		if (!isset($context['disabled_fields']['icq']))
diff --git a/Themes/core/PersonalMessage.template.php b/Themes/core/PersonalMessage.template.php
index 83cf05c..99e7876 100644
--- a/Themes/core/PersonalMessage.template.php
+++ b/Themes/core/PersonalMessage.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.2
+ * @version 2.0.16
  */
 
 // This is the main sidebar for the personal messages section.
@@ -322,7 +322,7 @@ function template_folder()
 				// Don't show an icon if they haven't specified a website.
 				if ($message['member']['website']['url'] != '' && !isset($context['disabled_fields']['website']))
 					echo '
-								<li><a href="', $message['member']['website']['url'], '" title="' . $message['member']['website']['title'] . '" target="_blank" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $message['member']['website']['title'] . '" border="0" />' : $txt['www']), '</a></li>';
+								<li><a href="', $message['member']['website']['url'], '" title="' . $message['member']['website']['title'] . '" target="_blank" rel="noopener noreferrer" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $message['member']['website']['title'] . '" border="0" />' : $txt['www']), '</a></li>';
 
 				// Don't show the email address if they want it hidden.
 				if (in_array($message['member']['show_email'], array('yes', 'yes_permission_override', 'no_through_forum')))
diff --git a/Themes/core/index.template.php b/Themes/core/index.template.php
index 3415afb..f5a080e 100644
--- a/Themes/core/index.template.php
+++ b/Themes/core/index.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 /*	This template is, perhaps, the most important template in the theme. It
@@ -288,7 +288,7 @@ function template_body_above()
 					<input type="text" name="openid_identifier" id="openid_url" size="25" class="input_text openid_login" />';
 
 		echo '
-					<input type="hidden" name="hash_passwrd" value="" />
+					<input type="hidden" name="hash_passwrd" value="" /><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
 				</form>';
 	}
 
diff --git a/Themes/core/theme_info.xml b/Themes/core/theme_info.xml
index ee49be0..bf7ac1a 100644
--- a/Themes/core/theme_info.xml
+++ b/Themes/core/theme_info.xml
@@ -5,7 +5,7 @@
 	<!-- Author: your email address or contact information.  The name attribute is optional. -->
 	<author name="Simple Machines">info@simplemachines.org</author>
 	<!-- Website... where to get updates and more information. -->
-	<website>http://www.simplemachines.org/</website>
+	<website>https://www.simplemachines.org/</website>
 	<!-- Template layers to use, defaults to "html,body". -->
 	<layers>html,body</layers>
 	<!-- Templates to load on startup.  Default is "index". -->
diff --git a/Themes/default/Admin.template.php b/Themes/default/Admin.template.php
index 3a5fd9c..e80bb67 100644
--- a/Themes/default/Admin.template.php
+++ b/Themes/default/Admin.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // This is the administration center home.
@@ -886,8 +886,14 @@ function template_show_settings()
 
 				// Show a check box.
 				if ($config_var['type'] == 'check')
+				{
+					if (!empty($config_var['needs_default']))
+						echo '
+							<input type="hidden" name="', $config_var['name'], '" value="0" />';
+
 					echo '
 							<input type="checkbox"', $javascript, $disabled, ' name="', $config_var['name'], '" id="', $config_var['name'], '"', ($config_var['value'] ? ' checked="checked"' : ''), ' value="1" class="input_check" />';
+				}
 				// Escape (via htmlspecialchars.) the text box.
 				elseif ($config_var['type'] == 'password')
 					echo '
@@ -1358,8 +1364,15 @@ function template_core_features()
 			// Change the image, alternative text and the title.
 			document.getElementById("switch_" + itemID).src = \'', $settings['images_url'], '/admin/switch_\' + (itemValueHandle.value == 1 ? \'on\' : \'off\') + \'.png\';
 			document.getElementById("switch_" + itemID).alt = itemValueHandle.value == 1 ? \'', $txt['core_settings_switch_off'], '\' : \'', $txt['core_settings_switch_on'], '\';
-			document.getElementById("switch_" + itemID).title = itemValueHandle.value == 1 ? \'', $txt['core_settings_switch_off'], '\' : \'', $txt['core_settings_switch_on'], '\';
+			document.getElementById("switch_" + itemID).title = itemValueHandle.value == 1 ? \'', $txt['core_settings_switch_off'], '\' : \'', $txt['core_settings_switch_on'], '\';';
 
+	if (!empty($context['show_privacy_policy_warning']))
+		echo '
+			if (itemID == "gdpr" && itemValueHandle.value == 1) {
+				alert("' . $txt['core_settings_privacy_policy_warning'] . '");
+			}';
+
+	echo '
 			// Don\'t reload.
 			return false;
 		}
diff --git a/Themes/default/Agreement.template.php b/Themes/default/Agreement.template.php
new file mode 100644
index 0000000..ec5e5a1
--- /dev/null
+++ b/Themes/default/Agreement.template.php
@@ -0,0 +1,95 @@
+<?php
+
+/**
+ * Simple Machines Forum (SMF)
+ *
+ * @package SMF
+ * @author Simple Machines
+ * @copyright 2018 Simple Machines
+ * @license http://www.simplemachines.org/about/smf/license.php BSD
+ *
+ * @version 2.0.16
+ */
+
+// The main sub template - show the agreement and/or privacy policy
+function template_main()
+{
+	global $context, $scripturl, $txt;
+
+	if (!empty($context['accept_doc']))
+		echo '
+	<form action="', $scripturl, '?action=acceptagreement;doc=', $context['accept_doc'], '" method="post">';
+
+	if (!empty($context['agreement']))
+	{
+		echo '
+		<div class="cat_bar">
+			<h3 class="catbg">', $txt['agreement' . ($context['can_accept_agreement'] ? '_updated' : '')], '</h3>
+		</div>';
+
+		if ($context['can_accept_agreement'])
+		{
+			echo '
+		<p class="description">
+			', $txt['agreement_updated_desc'], '
+		</p>';
+		}
+		elseif (!empty($context['agreement_accepted_date']))
+		{
+			echo '
+		<p class="description">
+			', sprintf($txt['agreement_accepted'], timeformat($context['agreement_accepted_date'], false)), '
+		</p>';
+		}
+
+		echo '
+		<span class="upperframe"><span></span></span>
+		<div class="roundframe">
+			<div>', $context['agreement'], '</div>
+		</div>
+		<span class="lowerframe"><span></span></span>';
+	}
+
+	if (!empty($context['policy']))
+	{
+		if (!empty($context['agreement']))
+			echo '<br />';
+
+		echo '
+		<div class="cat_bar">
+			<h3 class="catbg">', $txt['privacy_policy' . ($context['can_accept_privacy_policy'] ? '_updated' : '')], '</h3>
+		</div>';
+
+		if ($context['can_accept_privacy_policy'])
+		{
+			echo '
+		<p class="description">
+			', $txt['privacy_policy_updated_desc'], '
+		</p>';
+		}
+		elseif (!empty($context['privacy_policy_accepted_date']))
+		{
+			echo '
+		<p class="description">
+			', sprintf($txt['privacy_policy_accepted'], timeformat($context['privacy_policy_accepted_date'], false)), '
+		</p>';
+		}
+
+		echo '
+		<span class="upperframe"><span></span></span>
+		<div class="roundframe">
+			<div>', $context['policy'], '</div>
+		</div>
+		<span class="lowerframe"><span></span></span>';
+	}
+
+	if (!empty($context['accept_doc']))
+		echo '
+		<div id="confirm_buttons">
+			<input type="submit" value="', $txt['agree'], '" class="button_submit" />
+			<input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
+		</div>
+	</form>';
+}
+
+?>
\ No newline at end of file
diff --git a/Themes/default/Display.template.php b/Themes/default/Display.template.php
index 268d6f8..7cb345f 100644
--- a/Themes/default/Display.template.php
+++ b/Themes/default/Display.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 function template_main()
@@ -375,7 +375,7 @@ function template_main()
 				// Don't show an icon if they haven't specified a website.
 				if ($message['member']['website']['url'] != '' && !isset($context['disabled_fields']['website']))
 					echo '
-										<li><a href="', $message['member']['website']['url'], '" title="' . $message['member']['website']['title'] . '" target="_blank" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $message['member']['website']['title'] . '" />' : $txt['www']), '</a></li>';
+										<li><a href="', $message['member']['website']['url'], '" title="' . $message['member']['website']['title'] . '" target="_blank" rel="noopener noreferrer" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $message['member']['website']['title'] . '" />' : $txt['www']), '</a></li>';
 
 				// Don't show the email address if they want it hidden.
 				if (in_array($message['member']['show_email'], array('yes', 'yes_permission_override', 'no_through_forum')))
diff --git a/Themes/default/Login.template.php b/Themes/default/Login.template.php
index 4c2f997..b25e3ae 100644
--- a/Themes/default/Login.template.php
+++ b/Themes/default/Login.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // This is just the basic "login" form.
@@ -69,7 +69,7 @@ function template_login()
 	echo '
 				</dl>
 				<p><input type="submit" value="', $txt['login'], '" class="button_submit" /></p>
-				<p class="smalltext"><a href="', $scripturl, '?action=reminder">', $txt['forgot_your_password'], '</a></p>
+				<p class="smalltext"><a href="', $scripturl, '?action=reminder">', $txt['forgot_your_password'], '</a></p><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
 				<input type="hidden" name="hash_passwrd" value="" />
 			</div>
 			<span class="lowerframe"><span></span></span>
@@ -136,10 +136,10 @@ function template_kick_guest()
 					<dd><input type="checkbox" name="cookieneverexp" class="input_check" onclick="this.form.cookielength.disabled = this.checked;" /></dd>
 				</dl>
 				<p class="centertext"><input type="submit" value="', $txt['login'], '" class="button_submit" /></p>
-				<p class="centertext smalltext"><a href="', $scripturl, '?action=reminder">', $txt['forgot_your_password'], '</a></p>
+				<p class="centertext smalltext"><a href="', $scripturl, '?action=reminder">', $txt['forgot_your_password'], '</a></p><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
 			</div>
 			<span class="lowerframe"><span></span></span>
-			<input type="hidden" name="hash_passwrd" value="" />
+			<input type="hidden" name="hash_passwrd" value="" /><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
 		</div>
 	</form>';
 
@@ -185,7 +185,7 @@ function template_maintenance()
 			<p class="centertext"><input type="submit" value="', $txt['login'], '" class="button_submit" /></p>
 		</div>
 		<span class="lowerframe"><span></span></span>
-		<input type="hidden" name="hash_passwrd" value="" />
+		<input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" /><input type="hidden" name="hash_passwrd" value="" />
 	</div>
 </form>';
 }
diff --git a/Themes/default/ManageNews.template.php b/Themes/default/ManageNews.template.php
index aa12029..cbc4294 100644
--- a/Themes/default/ManageNews.template.php
+++ b/Themes/default/ManageNews.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // Form for editing current news on the site.
@@ -80,7 +80,7 @@ function template_edit_news()
 
 function template_email_members()
 {
-	global $context, $settings, $options, $txt, $scripturl;
+	global $context, $settings, $options, $txt, $scripturl, $modSettings;
 
 	// This is some javascript for the simple/advanced toggling stuff.
 	echo '
@@ -143,14 +143,19 @@ function template_email_members()
 			<div class="windowbg2" id="advanced_settings_div" style="display: none;">
 				<span class="topslice"><span></span></span>
 				<div class="content">
-					<dl class="settings">
+					<dl class="settings">';
+
+	if (empty($modSettings['force_gdpr']))
+		echo '
 						<dt>
 							<strong>', $txt['admin_news_select_email'], ':</strong><br />
 							<span class="smalltext">', $txt['admin_news_select_email_desc'], '</span>
 						</dt>
 						<dd>
 							<textarea name="emails" rows="5" cols="30" style="' . ($context['browser']['is_ie8'] ? 'width: 635px; max-width: 98%; min-width: 98%' : 'width: 98%') . ';"></textarea>
-						</dd>
+						</dd>';
+
+	echo '
 						<dt>
 							<strong>', $txt['admin_news_select_members'], ':</strong><br />
 							<span class="smalltext">', $txt['admin_news_select_members_desc'], '</span>
@@ -184,7 +189,10 @@ function template_email_members()
 							<input type="text" name="exclude_members" id="exclude_members" value="" size="30" class="input_text" />
 							<span id="exclude_members_container"></span>
 						</dd>
-					</dl>
+					</dl>';
+
+	if (empty($modSettings['force_gdpr']))
+		echo '
 					<hr class="bordercolor" />
 					<dl class="settings">
 						<dt>
@@ -194,7 +202,10 @@ function template_email_members()
 						<dd>
 							<input type="checkbox" name="email_force" id="email_force" value="1" class="input_check" />
 						</dd>
-					</dl><br class="clear" />
+					</dl>';
+
+	echo '
+					<br class="clear" />
 				</div>
 				<span class="botslice"><span></span></span>
 			</div>
diff --git a/Themes/default/Memberlist.template.php b/Themes/default/Memberlist.template.php
index 0b5f717..aff8828 100644
--- a/Themes/default/Memberlist.template.php
+++ b/Themes/default/Memberlist.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // Displays a sortable listing of all members registered on the forum.
@@ -82,7 +82,7 @@ function template_main()
 
 		if (!isset($context['disabled_fields']['website']))
 			echo '
-					<td class="windowbg">', $member['website']['url'] != '' ? '<a href="' . $member['website']['url'] . '" target="_blank" class="new_win"><img src="' . $settings['images_url'] . '/www.gif" alt="' . $member['website']['title'] . '" title="' . $member['website']['title'] . '" /></a>' : '', '</td>';
+					<td class="windowbg">', $member['website']['url'] != '' ? '<a href="' . $member['website']['url'] . '" target="_blank" rel="noopener noreferrer" class="new_win"><img src="' . $settings['images_url'] . '/www.gif" alt="' . $member['website']['title'] . '" title="' . $member['website']['title'] . '" /></a>' : '', '</td>';
 
 		// ICQ?
 		if (!isset($context['disabled_fields']['icq']))
diff --git a/Themes/default/Notify.template.php b/Themes/default/Notify.template.php
index b397355..4ff834b 100644
--- a/Themes/default/Notify.template.php
+++ b/Themes/default/Notify.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 function template_main()
@@ -24,7 +24,7 @@ function template_main()
 		<div class="roundframe centertext">
 			<p>', $context['notification_set'] ? $txt['notify_deactivate'] : $txt['notify_request'], '</p>
 			<p>
-				<strong><a href="', $scripturl, '?action=notify;sa=', $context['notification_set'] ? 'off' : 'on', ';topic=', $context['current_topic'], '.', $context['start'], ';', $context['session_var'], '=', $context['session_id'], '">', $txt['yes'], '</a> - <a href="', $context['topic_href'], '">', $txt['no'], '</a></strong>
+				<strong><a href="', $scripturl, '?action=notify;sa=', $context['notification_set'] ? 'off' : 'on', ';topic=', $context['current_topic'], '.', $context['start'], ';', (!empty($context['notify_info']['token']) ? 'u=' . $context['notify_info']['u'] . ';token=' . $context['notify_info']['token'] : $context['session_var'] . '=' . $context['session_id']), '">', $txt['yes'], '</a> - <a href="', $context['topic_href'], '">', $txt['no'], '</a></strong>
 			</p>
 		</div>
 		<span class="lowerframe"><span></span></span>';
@@ -44,10 +44,47 @@ function template_notify_board()
 		<div class="roundframe centertext">
 			<p>', $context['notification_set'] ? $txt['notifyboard_turnoff'] : $txt['notifyboard_turnon'], '</p>
 			<p>
-				<strong><a href="', $scripturl, '?action=notifyboard;sa=', $context['notification_set'] ? 'off' : 'on', ';board=', $context['current_board'], '.', $context['start'], ';', $context['session_var'], '=', $context['session_id'], '">', $txt['yes'], '</a> - <a href="', $context['board_href'], '">', $txt['no'], '</a></strong>
+				<strong><a href="', $scripturl, '?action=notifyboard;sa=', $context['notification_set'] ? 'off' : 'on', ';board=', $context['current_board'], '.', $context['start'], ';', (!empty($context['notify_info']['token']) ? 'u=' . $context['notify_info']['u'] . ';token=' . $context['notify_info']['token'] : $context['session_var'] . '=' . $context['session_id']), '">', $txt['yes'], '</a> - <a href="', $context['board_href'], '">', $txt['no'], '</a></strong>
 			</p>
 		</div>
 		<span class="lowerframe"><span></span></span>';
 }
 
+function template_notify_announcements()
+{
+	global $context, $settings, $options, $txt, $scripturl;
+
+	echo '
+		<div class="cat_bar">
+			<h3 class="catbg">
+				<span class="ie6_header floatleft"><img src="', $settings['images_url'], '/email_sm.gif" alt="" class="icon" />', $txt['notify'], '</span>
+			</h3>
+		</div>
+		<span class="upperframe"><span></span></span>
+		<div class="roundframe centertext">
+			<p>', $txt['notifyannouncements_prompt'], '</p>
+			<p>
+				<strong><a href="', $scripturl, '?action=notifyannouncements;sa=on;', (!empty($context['notify_info']['token']) ? 'u=' . $context['notify_info']['u'] . ';token=' . $context['notify_info']['token'] : $context['session_var'] . '=' . $context['session_id']), '">', $txt['yes'], '</a> - <a href="', $scripturl, '?action=notifyannouncements;sa=off;', (!empty($context['notify_info']['token']) ? 'u=' . $context['notify_info']['u'] . ';token=' . $context['notify_info']['token'] : $context['session_var'] . '=' . $context['session_id']), '">', $txt['no'], '</a></strong>
+			</p>
+		</div>
+		<span class="lowerframe"><span></span></span>';
+}
+
+function template_notify_pref_changed()
+{
+	global $context, $settings, $options, $txt, $scripturl;
+
+	echo '
+		<div class="cat_bar">
+			<h3 class="catbg">
+				<span class="ie6_header floatleft"><img src="', $settings['images_url'], '/email_sm.gif" alt="" class="icon" />', $txt['notify'], '</span>
+			</h3>
+		</div>
+		<span class="upperframe"><span></span></span>
+		<div class="roundframe centertext">
+			<p>', $context['notify_success_msg'], '</p>
+		</div>
+		<span class="lowerframe"><span></span></span>';
+}
+
 ?>
\ No newline at end of file
diff --git a/Themes/default/PersonalMessage.template.php b/Themes/default/PersonalMessage.template.php
index 6ff12f1..720f8d9 100644
--- a/Themes/default/PersonalMessage.template.php
+++ b/Themes/default/PersonalMessage.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // This is the main sidebar for the personal messages section.
@@ -1440,7 +1440,9 @@ function template_add_rule()
 						if (document.forms.addrule.elements[i].id.substr(0, 8) == "ruletype")
 							criteriaNum++;
 				}
-				criteriaNum++
+
+				if (criteriaNum++ >= ', $context['rule_limiters']['criteria'], ')
+					return false;
 
 				setOuterHTML(document.getElementById("criteriaAddHere"), \'<br /><select name="ruletype[\' + criteriaNum + \']" id="ruletype\' + criteriaNum + \'" onchange="updateRuleDef(\' + criteriaNum + \'); rebuildRuleDesc();"><option value="">', addslashes($txt['pm_rule_criteria_pick']), ':<\' + \'/option><option value="mid">', addslashes($txt['pm_rule_mid']), '<\' + \'/option><option value="gid">', addslashes($txt['pm_rule_gid']), '<\' + \'/option><option value="sub">', addslashes($txt['pm_rule_sub']), '<\' + \'/option><option value="msg">', addslashes($txt['pm_rule_msg']), '<\' + \'/option><option value="bud">', addslashes($txt['pm_rule_bud']), '<\' + \'/option><\' + \'/select>&nbsp;<span id="defdiv\' + criteriaNum + \'" style="display: none;"><input type="text" name="ruledef[\' + criteriaNum + \']" id="ruledef\' + criteriaNum + \'" onkeyup="rebuildRuleDesc();" value="" class="input_text" /><\' + \'/span><span id="defseldiv\' + criteriaNum + \'" style="display: none;"><select name="ruledefgroup[\' + criteriaNum + \']" id="ruledefgroup\' + criteriaNum + \'" onchange="rebuildRuleDesc();"><option value="">', addslashes($txt['pm_rule_sel_group']), '<\' + \'/option>';
 
@@ -1448,6 +1450,9 @@ function template_add_rule()
 		echo '<option value="', $id, '">', strtr($group, array("'" => "\'")), '<\' + \'/option>';
 
 	echo '<\' + \'/select><\' + \'/span><span id="criteriaAddHere"><\' + \'/span>\');
+
+				if (criteriaNum + 1 > ', $context['rule_limiters']['criteria'], ')
+					document.getElementById(\'addonjs1\').style.display = \'none\';
 			}
 
 			function addActionOption()
@@ -1458,7 +1463,8 @@ function template_add_rule()
 						if (document.forms.addrule.elements[i].id.substr(0, 7) == "acttype")
 							actionNum++;
 				}
-				actionNum++
+				if (actionNum++ >= ', $context['rule_limiters']['actions'], ')
+					return false;
 
 				setOuterHTML(document.getElementById("actionAddHere"), \'<br /><select name="acttype[\' + actionNum + \']" id="acttype\' + actionNum + \'" onchange="updateActionDef(\' + actionNum + \'); rebuildRuleDesc();"><option value="">', addslashes($txt['pm_rule_sel_action']), ':<\' + \'/option><option value="lab">', addslashes($txt['pm_rule_label']), '<\' + \'/option><option value="del">', addslashes($txt['pm_rule_delete']), '<\' + \'/option><\' + \'/select>&nbsp;<span id="labdiv\' + actionNum + \'" style="display: none;"><select name="labdef[\' + actionNum + \']" id="labdef\' + actionNum + \'" onchange="rebuildRuleDesc();"><option value="">', addslashes($txt['pm_rule_sel_label']), '<\' + \'/option>';
 
@@ -1467,6 +1473,9 @@ function template_add_rule()
 			echo '<option value="', ($label['id'] + 1), '">', addslashes($label['name']), '<\' + \'/option>';
 
 	echo '<\' + \'/select><\' + \'/span><span id="actionAddHere"><\' + \'/span>\');
+
+				if (actionNum + 1 > ', $context['rule_limiters']['actions'], ')
+					document.getElementById(\'addonjs2\').style.display = \'none\';
 			}
 
 			function updateRuleDef(optNum)
@@ -1736,8 +1745,12 @@ function template_add_rule()
 			document.getElementById("removeonjs1").style.display = "none";
 			document.getElementById("removeonjs2").style.display = "none";';
 
-	echo '
-			document.getElementById("addonjs1").style.display = "";
+	if (count($context['rule']['criteria']) <= $context['rule_limiters']['criteria'])
+		echo '
+			document.getElementById("addonjs1").style.display = "";';
+
+	if (count($context['rule']['actions']) <= $context['rule_limiters']['actions'])
+		echo '
 			document.getElementById("addonjs2").style.display = "";';
 
 	echo '
diff --git a/Themes/default/Profile.template.php b/Themes/default/Profile.template.php
index 15b3bdf..89f4a1a 100644
--- a/Themes/default/Profile.template.php
+++ b/Themes/default/Profile.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // Template for the profile side bar - goes before any other profile template.
@@ -72,7 +72,7 @@ function template_summary()
 	// Don't show an icon if they haven't specified a website.
 	if ($context['member']['website']['url'] !== '' && !isset($context['disabled_fields']['website']))
 		echo '
-					<li><a href="', $context['member']['website']['url'], '" title="' . $context['member']['website']['title'] . '" target="_blank" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $context['member']['website']['title'] . '" />' : $txt['www']), '</a></li>';
+					<li><a href="', $context['member']['website']['url'], '" title="' . $context['member']['website']['title'] . '" target="_blank" rel="noopener noreferrer" class="new_win">', ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/www_sm.gif" alt="' . $context['member']['website']['title'] . '" />' : $txt['www']), '</a></li>';
 
 	// Are there any custom profile fields for the summary?
 	if (!empty($context['custom_fields']))
@@ -2762,7 +2762,7 @@ function template_profile_avatar_select()
 		echo '
 								<div id="avatar_external">
 									<div class="smalltext">', $txt['avatar_by_url'], '</div>
-									<input type="text" name="userpicpersonal" size="45" value="', $context['member']['avatar']['external'], '" onfocus="selectRadioByName(document.forms.creator.avatar_choice, \'external\');" onchange="if (typeof(previewExternalAvatar) != \'undefined\') previewExternalAvatar(this.value);" class="input_text" />
+									<input type="text" name="userpicpersonal" size="45" value="', $context['member']['avatar']['external_original'], '" onfocus="selectRadioByName(document.forms.creator.avatar_choice, \'external\');" onchange="if (typeof(previewExternalAvatar) != \'undefined\') previewExternalAvatar(this.value);" class="input_text" />
 								</div>';
 	}
 
diff --git a/Themes/default/Register.template.php b/Themes/default/Register.template.php
index 3497cac..f9b5b9e 100644
--- a/Themes/default/Register.template.php
+++ b/Themes/default/Register.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // Before showing users a registration form, show them the registration agreement.
@@ -16,15 +16,31 @@ function template_registration_agreement()
 	global $context, $settings, $options, $scripturl, $txt, $modSettings;
 
 	echo '
-		<form action="', $scripturl, '?action=register" method="post" accept-charset="', $context['character_set'], '" id="registration">
+		<form action="', $scripturl, '?action=register" method="post" accept-charset="', $context['character_set'], '" id="registration">';
+
+	if (!empty($context['agreement']))
+		echo '
 			<div class="cat_bar">
 				<h3 class="catbg">', $txt['registration_agreement'], '</h3>
 			</div>
 			<span class="upperframe"><span></span></span>
 			<div class="roundframe">
-				<p>', $context['agreement'], '</p>
+				<div>', $context['agreement'], '</div>
+			</div>
+			<span class="lowerframe"><span></span></span>';
+
+	if (!empty($context['policy']))
+		echo '
+			<div class="cat_bar">
+				<h3 class="catbg">', $txt['privacy_policy'], '</h3>
+			</div>
+			<span class="upperframe"><span></span></span>
+			<div class="roundframe">
+				<div>', $context['policy'], '</div>
 			</div>
-			<span class="lowerframe"><span></span></span>
+			<span class="lowerframe"><span></span></span>';
+
+	echo '
 			<div id="confirm_buttons">';
 
 	// Age restriction in effect?
@@ -34,7 +50,7 @@ function template_registration_agreement()
 				<input type="submit" name="accept_agreement_coppa" value="', $context['coppa_agree_below'], '" class="button_submit" />';
 	else
 		echo '
-				<input type="submit" name="accept_agreement" value="', $txt['agreement_agree'], '" class="button_submit" />';
+				<input type="submit" name="accept_agreement" value="', $txt['agreement' . ($context['require_policy_agreement'] ? '_policy' : '') . '_agree'], '" class="button_submit" />';
 
 	echo '
 			</div>
@@ -209,6 +225,15 @@ function template_registration_form()
 
 	}
 
+	if (!empty($context['announcements_ask']))
+		echo '
+					<dl class="register_form" id="notify_announcements_group">
+						<dt><strong><label for="notify_announcements">', $txt['notify_announcements'], ':</label></strong></dt>
+						<dd>
+							<input type="checkbox" name="notify_announcements" id="notify_announcements" tabindex="', $context['tabindex']++, '" class="input_check"', (!empty($context['notify_announcements']) ? ' checked="checked"' : ''), ' />
+						</dd>
+					</dl>';
+
 	echo '
 				</fieldset>
 				<span class="botslice"><span></span></span>
@@ -598,6 +623,20 @@ function template_admin_register()
 					<dd>
 						<input type="checkbox" name="emailActivate" id="emailActivate_check" tabindex="', $context['tabindex']++, '"', !empty($modSettings['registration_method']) && $modSettings['registration_method'] == 1 ? ' checked="checked"' : '', ' onclick="onCheckChange();" class="input_check" />
 					</dd>
+					<dt>
+						<strong><label for="requireAgreement">', $txt['admin_register_require_agreement'], ':</label></strong>
+					</dt>
+					<dd>
+						<input type="checkbox" name="requireAgreement" id="requireAgreement_check" tabindex="', $context['tabindex']++, '"', !empty($modSettings['requireAgreement']) || !empty($modSettings['force_gdpr']) ? ' checked="checked"' : '', !empty($modSettings['force_gdpr']) ? ' disabled="disabled"' : '', ' class="input_check" />', !empty($modSettings['force_gdpr']) ? '
+						<input type="hidden" name="requireAgreement" value=1>' : '', '
+					</dd>
+					<dt>
+						<strong><label for="requirePolicyAgreement">', $txt['admin_register_require_policy'], ':</label></strong>
+					</dt>
+					<dd>
+						<input type="checkbox" name="requirePolicyAgreement" id="requirePolicyAgreement_check" tabindex="', $context['tabindex']++, '"', !empty($modSettings['requirePolicyAgreement']) || !empty($modSettings['force_gdpr']) ? ' checked="checked"' : '', !empty($modSettings['force_gdpr']) ? ' disabled="disabled"' : '', ' class="input_check" />', !empty($modSettings['force_gdpr']) ? '
+						<input type="hidden" name="requirePolicyAgreement" value=1>' : '', '
+					</dd>
 				</dl>
 				<div class="righttext">
 					<input type="submit" name="regSubmit" value="', $txt['register'], '" tabindex="', $context['tabindex']++, '" class="button_submit" />
@@ -664,14 +703,24 @@ function template_edit_agreement()
 					<p class="agreement">
 						<textarea cols="70" rows="20" name="agreement" id="agreement">', $context['agreement'], '</textarea>
 					</p>
-					<p>
-						<label for="requireAgreement"><input type="checkbox" name="requireAgreement" id="requireAgreement"', $context['require_agreement'] ? ' checked="checked"' : '', ' tabindex="', $context['tabindex']++, '" value="1" class="input_check" /> ', $txt['admin_agreement'], '.</label>
-					</p>
-					<div class="righttext">
-						<input type="submit" value="', $txt['save'], '" tabindex="', $context['tabindex']++, '" class="button_submit" />
+					<div class="information">
+						<span>', $context['agreement_info'], '</span>
+					</div>
+					<div class="righttext">', empty($context['force_gdpr']) ? '
+						<label for="minor_edit"><input type="checkbox" value="" id="minor_edit" name="minor_edit" tabindex="' . $context['tabindex']++ . '" class="input_check" /> ' . $txt['admin_agreement_minor_edit'] . '</label>' : '', '
+						<input type="submit" value="', $txt['save'], '" tabindex="', $context['tabindex']++, '" class="button_submit" onclick="return resetAgreementConfirm()" />
 						<input type="hidden" name="agree_lang" value="', $context['current_agreement'], '" />
 						<input type="hidden" name="sa" value="agreement" />
 						<input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
+						<script>
+							function resetAgreementConfirm()
+							{
+								if (document.getElementById("minor_edit").checked)
+									return true;
+								else if (document.getElementById(\'agreement\').value != ' . JavaScriptEscape(un_htmlspecialchars($context['agreement'])) . ')
+									return confirm(' . JavaScriptEscape($txt['reset_agreement_desc']) . ');
+							}
+						</script>
 					</div>
 				</form>
 			</div>
@@ -712,4 +761,78 @@ function template_edit_reserved_words()
 		<br class="clear" />';
 }
 
+// Form for editing the privacy policy shown to people registering to the forum.
+function template_edit_privacy_policy()
+{
+	global $context, $settings, $options, $scripturl, $txt;
+
+	// Just a big box to edit the text file ;).
+	echo '
+		<div class="cat_bar">
+			<h3 class="catbg">', $txt['privacy_policy'], '</h3>
+		</div>';
+
+	echo '
+		<div class="windowbg2" id="privacy_policy">
+			<span class="topslice"><span></span></span>
+			<div class="content">';
+
+	// Is there more than one language to choose from?
+	if (count($context['editable_policies']) > 1)
+	{
+		echo '
+				<div class="information">
+					<form action="', $scripturl, '?action=admin;area=regcenter" id="change_policy" method="post" accept-charset="', $context['character_set'], '" style="display: inline;">
+						<strong>', $txt['admin_agreement_select_language'], ':</strong>&nbsp;
+						<select name="policy_lang" onchange="document.getElementById(\'change_policy\').submit();" tabindex="', $context['tabindex']++, '">';
+
+		foreach ($context['editable_policies'] as $lang => $name)
+			echo '
+							<option value="', $lang, '" ', $context['current_policy_lang'] == $lang ? 'selected="selected"' : '', '>', $name, '</option>';
+
+		echo '
+						</select>
+						<div class="righttext">
+							<input type="hidden" name="sa" value="policy" />
+							<input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
+							<input type="submit" name="change" value="', $txt['admin_agreement_select_language_change'], '" tabindex="', $context['tabindex']++, '" class="button_submit" />
+						</div>
+					</form>
+				</div>';
+	}
+
+	echo '
+				<form action="', $scripturl, '?action=admin;area=regcenter" method="post" accept-charset="', $context['character_set'], '">';
+
+	// Show the actual policy in an oversized text box.
+	echo '
+					<p class="policy">
+						<textarea cols="70" rows="20" name="policy" id="agreement">', $context['policy'], '</textarea>
+					</p>
+					<div class="information">
+						<span>', $context['policy_info'], '</span>
+					</div>
+					<div class="righttext">', empty($context['force_gdpr']) ? '
+						<label for="minor_edit"><input type="checkbox" value="" id="minor_edit" name="minor_edit" tabindex="' . $context['tabindex']++ . '" class="input_check" /> ' . $txt['admin_agreement_minor_edit'] . '</label>' : '', '
+						<input type="submit" value="', $txt['save'], '" tabindex="', $context['tabindex']++, '" class="button_submit" onclick="return resetPolicyConfirm()" />
+						<input type="hidden" name="policy_lang" value="', $context['current_policy_lang'], '" />
+						<input type="hidden" name="sa" value="policy" />
+						<input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
+						<script>
+							function resetPolicyConfirm()
+							{
+								if (document.getElementById("minor_edit").checked)
+									return true;
+								else if (document.getElementById(\'agreement\').value != ' . JavaScriptEscape(un_htmlspecialchars($context['policy'])) . ')
+									return confirm(' . JavaScriptEscape($txt['reset_privacy_policy_desc']) . ');
+							}
+						</script>
+					</div>
+				</form>
+			</div>
+			<span class="botslice"><span></span></span>
+		</div>
+		<br class="clear" />';
+}
+
 ?>
\ No newline at end of file
diff --git a/Themes/default/Search.template.php b/Themes/default/Search.template.php
index 64979bb..a0e4770 100644
--- a/Themes/default/Search.template.php
+++ b/Themes/default/Search.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.10
+ * @version 2.0.18
  */
 
 function template_main()
@@ -305,7 +305,7 @@ function template_results()
 
 			echo '
 			<div class="search_results_posts">
-			<div class="', $message['alternate'] == 0 ? 'windowbg' : 'windowbg2', ' core_posts">
+			<div class="', empty($message['alternate']) ? 'windowbg' : 'windowbg2', ' core_posts">
 				<span class="topslice"><span></span></span>
 				<div class="content flow_auto">';
 
diff --git a/Themes/default/Wireless.template.php b/Themes/default/Wireless.template.php
index c830fac..a32ea04 100644
--- a/Themes/default/Wireless.template.php
+++ b/Themes/default/Wireless.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 // This is the header for WAP 1.1 output. You can view it with ?wap in the URL.
@@ -26,7 +26,7 @@ function template_wap_above()
 // This is the board index (main page) in WAP 1.1.
 function template_wap_boardindex()
 {
-	global $context, $settings, $options, $scripturl;
+	global $context, $settings, $options, $scripturl, $txt;
 
 	// This is the "main" card...
 	echo '
@@ -62,6 +62,24 @@ function template_wap_boardindex()
 		echo '
 	</card>';
 	}
+
+	echo '
+	<card>
+		<p', $txt['wireless_options'], '</p>';
+	if ($context['user']['is_guest'])
+		echo '
+		<p><a href="', $scripturl, '?action=login;wap">', $txt['wireless_options_login'], '</a></p>';
+	else
+	{
+		if ($context['allow_pm'])
+			echo '
+			<p><a href="', $scripturl, '?action=pm;wap">', empty($context['user']['unread_messages']) ? $txt['wireless_pm_inbox'] : sprintf($txt['wireless_pm_inbox_new'], $context['user']['unread_messages']), '</a></p>';
+		echo '
+		<p><a href="', $scripturl, '?action=unread;wap">', $txt['wireless_recent_unread_posts'], '</a></p>
+		<p><a href="', $scripturl, '?action=unreadreplies;wap">', $txt['wireless_recent_unread_replies'], '</a></p>
+		<p><a href="', $scripturl, '?action=logout;', $context['session_var'], '=', $context['session_id'], ';wap">', $txt['wireless_options_logout'], '</a></p>
+	</card>';
+	}
 }
 
 // This is the message index (list of topics in a board) for WAP 1.1.
@@ -174,6 +192,7 @@ function template_wap_login()
 				<postfield name="user" value="$user" />
 				<postfield name="passwrd" value="$passwrd" />
 				<postfield name="cookieneverexp" value="1" />
+				<postfield name="', $context['session_var'], '" value="', $context['session_id'], '" />
 			</go>
 		</do></p>
 	</card>';
@@ -476,7 +495,7 @@ function template_imode_login()
 				<tr><td><input type="text" name="openid_identifier" class="input_text openid_login" size="17" /></td></tr>';
 
 	echo '
-				<tr><td><input type="submit" value="', $txt['login'], '" class="button_submit" /><input type="hidden" name="cookieneverexp" value="1" /></td></tr>
+				<tr><td><input type="submit" value="', $txt['login'], '" class="button_submit" /><input type="hidden" name="cookieneverexp" value="1" /><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" /></td></tr>
 				<tr bgcolor="#b6dbff"><td>', $txt['wireless_navigation'], '</td></tr>
 				<tr><td>[0] <a href="', $scripturl, '?imode" accesskey="0">', $txt['wireless_navigation_up'], '</a></td></tr>
 			</table>
@@ -1074,7 +1093,7 @@ function template_wap2_login()
 			<p class="windowbg"><input type="text" name="openid_identifier" class="input_text openid_login" size="17" /></p>';
 
 	echo '
-			<p class="windowbg"><input type="submit" value="', $txt['login'], '" class="button_submit" /><input type="hidden" name="cookieneverexp" value="1" /></p>
+			<p class="windowbg"><input type="submit" value="', $txt['login'], '" class="button_submit" /><input type="hidden" name="cookieneverexp" value="1" /><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" /></p>
 			<p class="catbg">', $txt['wireless_navigation'], '</p>
 			<p class="windowbg">[0] <a href="', $scripturl, '?wap2" accesskey="0">', $txt['wireless_navigation_up'], '</a></p>
 		</form>';
diff --git a/Themes/default/Xml.template.php b/Themes/default/Xml.template.php
index e7e46a4..56edc9b 100644
--- a/Themes/default/Xml.template.php
+++ b/Themes/default/Xml.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.16
  */
 
 function template_sendbody()
@@ -139,7 +139,7 @@ function template_stats()
 	echo '<', '?xml version="1.0" encoding="', $context['character_set'], '"?', '>
 <smf>';
 	foreach ($context['yearly'] as $year)
-		foreach ($year['months'] as $month);
+		foreach ($year['months'] as $month)
 		{
 			echo '
 	<month id="', $month['date']['year'], $month['date']['month'], '">';
diff --git a/Themes/default/index.template.php b/Themes/default/index.template.php
index 821d814..0258469 100644
--- a/Themes/default/index.template.php
+++ b/Themes/default/index.template.php
@@ -7,7 +7,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0
+ * @version 2.0.19
  */
 
 /*	This template is, perhaps, the most important template in the theme. It
@@ -147,12 +147,6 @@ function template_html_above()
 		echo '
 	<link rel="alternate" type="application/rss+xml" title="', $context['forum_name_html_safe'], ' - ', $txt['rss'], '" href="', $scripturl, '?type=rss;action=.xml" />';
 
-	// If we're viewing a topic, these should be the previous and next topics, respectively.
-	if (!empty($context['current_topic']))
-		echo '
-	<link rel="prev" href="', $scripturl, '?topic=', $context['current_topic'], '.0;prev_next=prev" />
-	<link rel="next" href="', $scripturl, '?topic=', $context['current_topic'], '.0;prev_next=next" />';
-
 	// If we're in a board, or a topic for that matter, the index will be the board's index.
 	if (!empty($context['current_board']))
 		echo '
@@ -241,7 +235,7 @@ function template_body_above()
 					<br /><input type="text" name="openid_identifier" id="openid_url" size="25" class="input_text openid_login" />';
 
 		echo '
-					<input type="hidden" name="hash_passwrd" value="" />
+					<input type="hidden" name="hash_passwrd" value="" /><input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
 				</form>';
 	}
 
diff --git a/Themes/default/languages/Admin.english.php b/Themes/default/languages/Admin.english.php
index 1b1cb14..c665b53 100644
--- a/Themes/default/languages/Admin.english.php
+++ b/Themes/default/languages/Admin.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Admin
+// Version: 2.0.16; Admin
 
 global $settings, $scripturl;
 
@@ -41,13 +41,18 @@ $txt['admin_smfpackage'] = 'SMF Package';
 $txt['admin_maintenance'] = 'Maintenance';
 $txt['admin_image_text'] = 'Show buttons as images instead of text';
 $txt['admin_credits'] = 'Credits';
-$txt['admin_agreement'] = 'Show and require agreement letter when registering';
+$txt['admin_agreement'] = 'Require new members to accept the registration agreement';
+$txt['admin_agreement_minor_edit'] = 'This is a minor edit';
+$txt['reset_agreement_desc'] = 'This will force all members to re-read and accept the registration agreement in order to continue using the forum.';
+$txt['admin_privacy_policy'] = 'Require new members to accept the privacy policy';
+$txt['reset_privacy_policy_desc'] = 'This will force all members to re-read and accept the privacy policy in order to continue using the forum.';
+$txt['admin_agreement_info'] = 'Last updated: %1$s.';
 $txt['admin_agreement_default'] = 'Default';
 $txt['admin_agreement_select_language'] = 'Language to edit';
 $txt['admin_agreement_select_language_change'] = 'Change';
 $txt['admin_delete_members'] = 'Delete Selected Members';
 $txt['admin_repair'] = 'Repair All Boards and Topics';
-$txt['admin_main_welcome'] = 'This is your &quot;%1$s&quot;.  From here, you can edit settings, maintain your forum, view logs, install packages, manage themes, and many other things.<div style="margin-top: 1ex;">If you have any trouble, please look at the &quot;Support &amp; Credits&quot; page.  If the information there doesn\'t help you, feel free to <a href="http://www.simplemachines.org/community/index.php" target="_blank" class="new_win">look to us for help</a> with the problem.</div>You may also find answers to your questions or problems by clicking the <img src="' . $settings['images_url'] . '/helptopics.gif" alt="%2$s" title="%3$s" /> symbols for more information on the related functions.';
+$txt['admin_main_welcome'] = 'This is your &quot;%1$s&quot;.  From here, you can edit settings, maintain your forum, view logs, install packages, manage themes, and many other things.<div style="margin-top: 1ex;">If you have any trouble, please look at the &quot;Support &amp; Credits&quot; page.  If the information there doesn\'t help you, feel free to <a href="https://www.simplemachines.org/community/index.php" target="_blank" class="new_win">look to us for help</a> with the problem.</div>You may also find answers to your questions or problems by clicking the <img src="' . $settings['images_url'] . '/helptopics.gif" alt="%2$s" title="%3$s" /> symbols for more information on the related functions.';
 $txt['admin_news_desc'] = 'Please place one news item per box. BBC tags, such as <span title="Are you bold?">[b]</span>, <span title="I tall icks!!">[i]</span> and <span title="Brackets are great, no?">[u]</span> are allowed in your news, as well as smileys. Clear a news item\'s text box to remove it.';
 $txt['administrators'] = 'Forum Administrators';
 $txt['admin_reserved_desc'] = 'Reserved names will keep members from registering certain usernames or using these words in their displayed names. Choose the options you wish to use from the bottom before submitting.';
@@ -68,6 +73,8 @@ $txt['database_password'] = 'Database Password';
 $txt['database_name'] = 'Database Name';
 $txt['registration_agreement'] = 'Registration Agreement';
 $txt['registration_agreement_desc'] = 'This agreement is shown when a user registers an account on this forum and has to be accepted before users can continue registration.';
+$txt['privacy_policy'] = 'Privacy Policy';
+$txt['privacy_policy_desc'] = 'This privacy policy describes the promises you make to your users regarding how you will use their personal data. It is shown when a user registers an account on this forum and has to be accepted before the user can continue registration.';
 $txt['database_prefix'] = 'Database Tables Prefix';
 $txt['errors_list'] = 'Listing of forum errors';
 $txt['errors_found'] = 'The following errors are fouling up your forum';
@@ -103,7 +110,7 @@ $txt['remove_all'] = 'Remove All';
 $txt['approve_new_members'] = 'Admin must approve all new members';
 $txt['agreement_not_writable'] = 'Warning - agreement.txt is not writable, any changes you make will NOT be saved.';
 
-$txt['version_check_desc'] = 'This shows you the versions of your installation\'s files versus those of the latest version. If any of these files are out of date, you should download and upgrade to the latest version at <a href="http://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.';
+$txt['version_check_desc'] = 'This shows you the versions of your installation\'s files versus those of the latest version. If any of these files are out of date, you should download and upgrade to the latest version at <a href="https://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.';
 $txt['version_check_more'] = '(more detailed)';
 
 $txt['lfyi'] = 'You are unable to connect to simplemachines.org\'s latest news file.';
diff --git a/Themes/default/languages/Agreement.english.php b/Themes/default/languages/Agreement.english.php
new file mode 100644
index 0000000..89369db
--- /dev/null
+++ b/Themes/default/languages/Agreement.english.php
@@ -0,0 +1,15 @@
+<?php
+// Version: 2.0.16; Agreement
+
+$txt['agreement'] = 'Registration Agreement';
+$txt['agreement_updated'] = 'Updated Registration Agreement';
+$txt['agreement_updated_desc'] = 'You must accept the terms of the registration agreement in order to continue using the forum.';
+$txt['agreement_accepted'] = 'You accepted the terms of this agreement on %1$s.';
+$txt['privacy_policy'] = 'Privacy Policy';
+$txt['privacy_policy_updated'] = 'Updated Privacy Policy';
+$txt['privacy_policy_updated_desc'] = 'You must accept the terms of the privacy policy in order to continue using the forum.';
+$txt['privacy_policy_accepted'] = 'You accepted the terms of this privacy policy on %1$s.';
+$txt['agreement_and_privacy_policy'] = 'Registration Agreement and Privacy Policy';
+$txt['agree'] = 'I Agree';
+
+?>
\ No newline at end of file
diff --git a/Themes/default/languages/EmailTemplates.english.php b/Themes/default/languages/EmailTemplates.english.php
index bade6a4..7ced1ba 100644
--- a/Themes/default/languages/EmailTemplates.english.php
+++ b/Themes/default/languages/EmailTemplates.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; EmailTemplates
+// Version: 2.0.16; EmailTemplates
 
 // Since all of these strings are being used in emails, numeric entities should be used.
 
@@ -215,17 +215,21 @@ Should you have any problems with the activation, please visit {ACTIVATIONLINKWI
 				TOPICSUBJECT: The subject of the topic being announced.
 				MESSAGE: The message body of the first post of the announced topic.
 				TOPICLINK: A link to the topic being announced.
+				UNSUBSCRIBELINK: Link to unsubscribe from announcements.
 			@description:
 
 		*/
 		'subject' => 'New announcement: {TOPICSUBJECT}',
 		'body' => '{MESSAGE}
 
-To unsubscribe from these announcements, login to the forum and uncheck "Receive forum announcements and important notifications by email." in your profile.
-
 You can view the full announcement by following this link:
 {TOPICLINK}
 
+To unsubscribe from these announcements, follow this link:
+{UNSUBSCRIBELINK}
+
+For more control over the email notifications you receive, login to the forum and go to the Notification area in your profile.
+
 {REGARDS}',
 	),
 	'notify_boards_once_body' => array(
@@ -993,7 +997,7 @@ $birthdayEmails = array(
 We here at {FORUMNAME} would like to wish you a happy birthday.  May this day and the year to follow be full of joy.
 
 {REGARDS}',
-		'author' => '<a href="http://www.simplemachines.org/community/?action=profile;u=2676">Thantos</a>',
+		'author' => '<a href="https://www.simplemachines.org/community/?action=profile;u=2676">Thantos</a>',
 	),
 	'karlbenson1' => array(
 		'subject' => 'On your Birthday...',
@@ -1012,7 +1016,7 @@ We would like to wish you a very special birthday.
 {REGARDS}
 
 //:: This message was automatically generated :://',
-		'author' => '<a href="http://www.simplemachines.org/community/?action=profile;u=63186">karlbenson</a>',
+		'author' => '<a href="https://www.simplemachines.org/community/?action=profile;u=63186">karlbenson</a>',
 	),
 	'nite0859' => array(
 		'subject' => 'Happy Birthday!',
@@ -1022,7 +1026,7 @@ Even though today is your birthday, {REALNAME}, we would like to remind you that
 
 Best Wishes,
 The Staff of {FORUMNAME}',
-		'author' => '<a href="http://www.simplemachines.org/community/?action=profile;u=46625">nite0859</a>',
+		'author' => '<a href="https://www.simplemachines.org/community/?action=profile;u=46625">nite0859</a>',
 	),
 	'zwaldowski' => array(
 		'subject' => 'Birthday Wishes to {REALNAME}',
@@ -1031,7 +1035,7 @@ The Staff of {FORUMNAME}',
 Another year in your life has passed.  We at {FORUMNAME} hope it has been filled with happiness, and wish you luck in the coming one.
 
 {REGARDS}',
-		'author' => '<a href="http://www.simplemachines.org/community/?action=profile;u=72038">zwaldowski</a>',
+		'author' => '<a href="https://www.simplemachines.org/community/?action=profile;u=72038">zwaldowski</a>',
 	),
 	'geezmo' => array(
 		'subject' => 'Happy birthday, {REALNAME}!',
@@ -1046,7 +1050,7 @@ You\'re now a year older but we hope you\'re a lot happier than last year.
 Enjoy your day today, {REALNAME}!
 
 - From your {FORUMNAME} family',
-		'author' => '<a href="http://www.simplemachines.org/community/?action=profile;u=48671">geezmo</a>',
+		'author' => '<a href="https://www.simplemachines.org/community/?action=profile;u=48671">geezmo</a>',
 	),
 	'karlbenson2' => array(
 		'subject' => 'Your Birthday Greeting',
@@ -1056,7 +1060,7 @@ Have lots of birthday cake and fun, and tell us what you have done.
 We hope this message brought you cheer, and make it last, until same time same place, next year.
 
 {REGARDS}',
-		'author' => '<a href="http://www.simplemachines.org/community/?action=profile;u=63186">karlbenson</a>',
+		'author' => '<a href="https://www.simplemachines.org/community/?action=profile;u=63186">karlbenson</a>',
 	),
 );
 ?>
\ No newline at end of file
diff --git a/Themes/default/languages/Errors.english.php b/Themes/default/languages/Errors.english.php
index 233e65f..4e6e40b 100644
--- a/Themes/default/languages/Errors.english.php
+++ b/Themes/default/languages/Errors.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Errors
+// Version: 2.0.16; Errors
 
 global $scripturl, $modSettings;
 
@@ -403,6 +403,14 @@ $txt['restore_not_found'] = 'The following messages could not be restored; the o
 
 $txt['error_invalid_dir'] = 'The directory you entered is invalid.';
 
-$txt['error_sqlite_optimizing'] = 'Sqlite is optimizing the database, the forum can not be accessed until it has finished.  Please try refreshing this page momentarily.';$txt['filter_boards_notint'] = 'Please fill in only integer values seperated by commas!';
+$txt['error_sqlite_optimizing'] = 'Sqlite is optimizing the database, the forum can not be accessed until it has finished.  Please try refreshing this page momentarily.';
 
-?>
\ No newline at end of file
+// Registration Agreement
+$txt['error_no_agreement'] = 'There is no registration agreement to display!';
+$txt['error_no_privacy_policy'] = 'A privacy policy has not been created for this forum.';
+
+// Unsubscribe
+$txt['unsubscribe_invalid'] = 'The unsubscribe link that brought you here does not appear to be valid.';
+
+$txt['filter_boards_notint'] = 'Please fill in only integer values seperated by commas!';
+?>
diff --git a/Themes/default/languages/Help.english.php b/Themes/default/languages/Help.english.php
index 4cce814..c406fce 100644
--- a/Themes/default/languages/Help.english.php
+++ b/Themes/default/languages/Help.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Help
+// Version: 2.0.19; Help
 
 global $helptxt;
 
@@ -141,7 +141,7 @@ $helptxt['time_format'] = '<strong>Time Format</strong><br />
 	<em>* Does not work on Windows-based servers.</em></span>';
 
 $helptxt['live_news'] = '<strong>Live announcements</strong><br />
-	This box shows recently updated announcements from <a href="http://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.
+	This box shows recently updated announcements from <a href="https://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.
 	You should check here every now and then for updates, new releases, and important information from Simple Machines.';
 
 $helptxt['registrations'] = '<strong>Registration Management</strong><br />
@@ -281,7 +281,9 @@ $helptxt['databaseSession_loose'] = 'Turning this on will decrease the bandwidth
 $helptxt['databaseSession_lifetime'] = 'This is the number of seconds for sessions to last after they haven\'t been accessed.  If a session is not accessed for too long, it is said to have &quot;timed out&quot;.  Anything higher than 2400 is recommended.';
 $helptxt['enableErrorLogging'] = 'This will log any errors, like a failed login, so you can see what went wrong.';
 $helptxt['enableErrorQueryLogging'] = 'This will include the full query sent to the database in the error log.  Requires error logging to be turned on.<br /><br /><strong>Note:  This will affect the ability to filter the error log by the error message.</strong>';
-$helptxt['allow_disableAnnounce'] = 'This will allow users to opt out of notification of topics you announce by checking the &quot;announce topic&quot; checkbox when posting.';
+$helptxt['allow_disableAnnounce'] = 'This will allow users to opt out of notification of topics you announce by checking the &quot;announce topic&quot; checkbox when posting.<br /><br />This setting must be enabled in order to comply with the rules of the <a href="https://ec.europa.eu/info/law/law-topic/data-protection_en" class="bbc_link">GDPR</a>.';
+$helptxt['announcements_default'] = 'This simply controls whether the the checkbox on the registration form starts as checked or unchecked.<br /><br />This setting must be disabled in order to comply with the rules of the <a href="https://ec.europa.eu/info/law/law-topic/data-protection_en" class="bbc_link">GDPR</a>.';
+$helptxt['notify_tokens'] = 'When this setting is enabled, the unsubscribe link included in every notification email includes a unique token to identify an unsubscribe request as legitimate. Without this, users must instead log into the forum to verify their identities before being allowed to unsubscribe.<br /><br />This setting must be enabled in order to comply with the rules of the <a href="https://ec.europa.eu/info/law/law-topic/data-protection_en" class="bbc_link">GDPR</a>.';
 $helptxt['disallow_sendBody'] = 'This option removes the option to receive the text of replies and posts in notification emails.<br /><br />Often, members will reply to the notification email, which in most cases means the webmaster receives the reply.';
 $helptxt['compactTopicPagesEnable'] = 'This will just show a selection of the number of pages.<br /><em>Example:</em>
 		&quot;3&quot; to display: 1 ... 4 [5] 6 ... 9 <br />
@@ -361,6 +363,7 @@ $helptxt['globalCookies'] = 'Makes log in cookies available across subdomains.
 	And your forum is at http://forum.simplemachines.org/,<br />
 	Using this option will allow you to access the forum\'s cookie on your site.  Do not enable this if there are other subdomains (like hacker.simplemachines.org) not controlled by you.';
 $helptxt['secureCookies'] = 'Enabling this option will force the cookies created for users on your forum to be marked as secure. Only enable this option if you are using HTTPS throughout your site as it will break cookie handling otherwise!';
+$helptxt['cookie_no_auth_secret'] = 'This option forces SMF to use a weaker form of authentication for login cookies. It should only be enabled if you need backwards compatibility with login integration mods that have not yet been updated to support SMF 2.0.16 and higher.';
 $helptxt['securityDisable'] = 'This <em>disables</em> the additional password check for the administration section. This is not recommended!';
 $helptxt['securityDisable_why'] = 'This is your current password. (the same one you use to login.)<br /><br />Having to type this helps ensure that you want to do whatever administration you are doing, and that it is <strong>you</strong> doing it.';
 $helptxt['emailmembers'] = 'In this message you can use a few &quot;variables&quot;.  These are:<br />
@@ -454,6 +457,9 @@ $helptxt['password_strength'] = 'This setting determines the strength required f
 		<li><strong>High:</strong> As for medium, except the password must also contain a mixture of upper and lower case letters, and at least one number.</li>
 	</ul>';
 
+$helptxt['requireAgreement'] = 'This setting must be enabled in order to comply with the rules of the <a href="https://ec.europa.eu/info/law/law-topic/data-protection_en" class="bbc_link">GDPR</a>.';
+$helptxt['requirePolicyAgreement'] = 'This setting must be enabled in order to comply with the rules of the <a href="https://ec.europa.eu/info/law/law-topic/data-protection_en" class="bbc_link">GDPR</a>.';
+
 $helptxt['coppaAge'] = 'The value specified in this box will determine the minimum age that new members must be to be granted immediate access to the forums.
 	On registration they will be prompted to confirm whether they are over this age, and if not will either have their application rejected or suspended awaiting parental approval - dependant on the type of restriction chosen.
 	If a value of 0 is chosen for this setting then all other age restriction settings shall be ignored.';
@@ -474,9 +480,9 @@ $helptxt['allow_hideOnline'] = 'With this option enabled all members will be abl
 $helptxt['make_email_viewable'] = 'If this option is enabled instead of users email addresses being hidden to normal members and guests they will be publicly viewable on the forum. Enabling this will put your users at greater risk of being victims of spam as a result of email harvesters visiting your forum. Note this setting does not override the user setting for hiding their email address from users. Enabling this setting is <strong>not</strong> recommended.';
 $helptxt['meta_keywords'] = 'These keywords are sent in the output of every page to indicate to search engines (etc) the key content of your site. They should be a comma separated list of words, and should not use HTML.';
 
-$helptxt['latest_support'] = 'This panel shows you some of the most common problems and questions on your server configuration. Don\'t worry, this information isn\'t logged or anything.<br /><br />If this stays as &quot;Retrieving support information...&quot;, your computer probably cannot connect to <a href="http://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.';
-$helptxt['latest_packages'] = 'Here you can see some of the most popular and some random packages or mods, with quick and easy installations.<br /><br />If this section doesn\'t show up, your computer probably cannot connect to <a href="http://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.';
-$helptxt['latest_themes'] = 'This area shows a few of the latest and most popular themes from <a href="http://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.  It may not show up properly if your computer can\'t find <a href="http://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>, though.';
+$helptxt['latest_support'] = 'This panel shows you some of the most common problems and questions on your server configuration. Don\'t worry, this information isn\'t logged or anything.<br /><br />If this stays as &quot;Retrieving support information...&quot;, your computer probably cannot connect to <a href="https://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.';
+$helptxt['latest_packages'] = 'Here you can see some of the most popular and some random packages or mods, with quick and easy installations.<br /><br />If this section doesn\'t show up, your computer probably cannot connect to <a href="https://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.';
+$helptxt['latest_themes'] = 'This area shows a few of the latest and most popular themes from <a href="https://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>.  It may not show up properly if your computer can\'t find <a href="https://www.simplemachines.org/" target="_blank" class="new_win">www.simplemachines.org</a>, though.';
 
 $helptxt['secret_why_blank'] = 'For your security, your password and the answer to your secret question are encrypted so that the SMF software will never tell you, or anyone else, what they are.';
 $helptxt['moderator_why_missing'] = 'Since moderation is done on a board-by-board basis, you have to make members moderators from the <a href="javascript:window.open(\'%1$s?action=admin;area=manageboards\'); self.close();">board management interface</a>.';
@@ -606,4 +612,7 @@ $helptxt['gpbp_threshold'] = 'Depending on each user\'s Theme and Layout configu
 $helptxt['gpbp_display_respect'] = 'Respect is the sum of all received votes. Negative votes substract from this value.';
 
 
-?>
\ No newline at end of file
+$helptxt['image_proxy_enabled'] = 'Whether to enable the image proxy';
+$helptxt['image_proxy_secret'] = 'Keep this a secret, protects your forum from hotlinking images. Change it in order to render current hotlinked images useless';
+$helptxt['image_proxy_maxsize'] = 'Maximum image size that the image proxy will cache: bigger images will be not be cached. Cached images are stored in your SMF cache folder, so make sure you have enough free space.';
+?>
diff --git a/Themes/default/languages/Install.english.php b/Themes/default/languages/Install.english.php
index ced98ca..ba0e677 100644
--- a/Themes/default/languages/Install.english.php
+++ b/Themes/default/languages/Install.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Install
+// Version: 2.0.16; Install
 
 // These should be the same as those in index.language.php.
 $txt['lang_character_set'] = 'ISO-8859-1';
@@ -17,7 +17,7 @@ $txt['smf_installer'] = 'SMF Installer';
 $txt['installer_language'] = 'Language';
 $txt['installer_language_set'] = 'Set';
 $txt['congratulations'] = 'Congratulations, the installation process is complete!';
-$txt['congratulations_help'] = 'If at any time you need support, or SMF fails to work properly, please remember that <a href="http://www.simplemachines.org/community/index.php" target="_blank">help is available</a> if you need it.';
+$txt['congratulations_help'] = 'If at any time you need support, or SMF fails to work properly, please remember that <a href="https://www.simplemachines.org/community/index.php" target="_blank">help is available</a> if you need it.';
 $txt['still_writable'] = 'Your installation directory is still writable.  It\'s a good idea to chmod it so that it is not writable for security reasons.';
 $txt['delete_installer'] = 'Click here to delete this install.php file now.';
 $txt['delete_installer_maybe'] = '<em>(doesn\'t work on all servers.)</em>';
@@ -32,7 +32,7 @@ $txt['user_refresh_install'] = 'Forum Refreshed';
 $txt['user_refresh_install_desc'] = 'While installing, the installer found that (with the details you provided) one or more of the tables this installer might create already existed.<br />Any missing tables in your installation have been recreated with the default data, but no data was deleted from existing tables.';
 
 $txt['default_topic_subject'] = 'Welcome to SMF!';
-$txt['default_topic_message'] = 'Welcome to Simple Machines Forum!<br /><br />We hope you enjoy using your forum.&nbsp; If you have any problems, please feel free to [url=http://www.simplemachines.org/community/index.php]ask us for assistance[/url].<br /><br />Thanks!<br />Simple Machines';
+$txt['default_topic_message'] = 'Welcome to Simple Machines Forum!<br /><br />We hope you enjoy using your forum.&nbsp; If you have any problems, please feel free to [url=https://www.simplemachines.org/community/index.php]ask us for assistance[/url].<br /><br />Thanks!<br />Simple Machines';
 $txt['default_board_name'] = 'General Discussion';
 $txt['default_board_description'] = 'Feel free to talk about anything and everything in this board.';
 $txt['default_category_name'] = 'General Category';
@@ -106,7 +106,7 @@ $txt['install_settings_utf8_title'] = 'Use UTF-8 as default character set';
 $txt['install_settings_utf8_info'] = 'This feature lets both the database and the forum use an international character set, UTF-8. This can be useful when working with multiple languages that use different character sets.';
 $txt['install_settings_stats'] = 'Allow Stat Collection';
 $txt['install_settings_stats_title'] = 'Allow Simple Machines to Collect Basic Stats Monthly';
-$txt['install_settings_stats_info'] = 'If enabled, this will allow Simple Machines to visit your site once a month to collect basic statistics. This will help us make decisions as to which configurations to optimize the software for. For more information please visit our <a href="http://www.simplemachines.org/about/stats.php" target="_blank">info page</a>.';
+$txt['install_settings_stats_info'] = 'If enabled, this will allow Simple Machines to visit your site once a month to collect basic statistics. This will help us make decisions as to which configurations to optimize the software for. For more information please visit our <a href="https://www.simplemachines.org/about/stats.php" target="_blank">info page</a>.';
 $txt['install_settings_proceed'] = 'Proceed';
 
 $txt['db_settings'] = 'Database Server Settings';
@@ -126,7 +126,7 @@ $txt['db_settings_database_file'] = 'Database filename';
 $txt['db_settings_database_file_info'] = 'This is the name of the file in which to store the SMF data. We recommend you use the randomly generated name for this and set the path of this file to be outside of the public area of your webserver.';
 $txt['db_settings_prefix'] = 'Table prefix';
 $txt['db_settings_prefix_info'] = 'The prefix for every table in the database.  <strong>Do not install two forums with the same prefix!</strong><br />This value allows for multiple installations in one database.';
-$txt['db_sqlite_warning'] = 'Only recommended for small, low volume and/or intranet-type forums';
+$txt['db_sqlite_warning'] = 'Only recommended for small, low volume and/or intranet-type forums. In future versions, this will be removed!';
 $txt['db_populate'] = 'Populated Database';
 $txt['db_populate_info'] = 'Your settings have now been saved and the database has been populated with all the data required to get your forum up and running. Summary of population:';
 $txt['db_populate_info2'] = 'Click &quot;Continue&quot; to progress to the admin account creation page.';
@@ -190,14 +190,14 @@ $txt['error_user_settings_query'] = 'A database error occurred while trying to c
 $txt['error_subs_missing'] = 'Unable to find the Sources/Subs.php file.  Please make sure it was uploaded properly, and then try again.';
 $txt['error_db_alter_priv'] = 'The database account you specified does not have permission to ALTER, CREATE, and/or DROP tables in the database; this is necessary for SMF to function properly.';
 $txt['error_versions_do_not_match'] = 'The installer has detected another version of SMF already installed with the specified information.  If you are trying to upgrade, you should use the upgrader, not the installer.<br /><br />Otherwise, you may wish to use different information, or create a backup and then delete the data currently in the database.';
-$txt['error_mod_security'] = 'The installer has detected the mod_security module is installed on your web server. Mod_security will block submitted forms even before SMF gets a say in anything. SMF has a built-in security scanner that will work more effectively than mod_security and that won\'t block submitted forms.<br /><br /><a href="http://www.simplemachines.org/redirect/mod_security">More information about disabling mod_security</a>';
-$txt['error_mod_security_no_write'] = 'The installer has detected the mod_security module is installed on your web server. Mod_security will block submitted forms even before SMF gets a say in anything. SMF has a built-in security scanner that will work more effectively than mod_security and that won\'t block submitted forms.<br /><br /><a href="http://www.simplemachines.org/redirect/mod_security">More information about disabling mod_security</a><br /><br />Alternatively, you may wish to use your ftp client to chmod .htaccess in the forum directory to be writable (777), and then refresh this page.';
+$txt['error_mod_security'] = 'The installer has detected the mod_security module is installed on your web server. Mod_security will block submitted forms even before SMF gets a say in anything. SMF has a built-in security scanner that will work more effectively than mod_security and that won\'t block submitted forms.<br /><br /><a href="https://www.simplemachines.org/redirect/mod_security">More information about disabling mod_security</a>';
+$txt['error_mod_security_no_write'] = 'The installer has detected the mod_security module is installed on your web server. Mod_security will block submitted forms even before SMF gets a say in anything. SMF has a built-in security scanner that will work more effectively than mod_security and that won\'t block submitted forms.<br /><br /><a href="https://www.simplemachines.org/redirect/mod_security">More information about disabling mod_security</a><br /><br />Alternatively, you may wish to use your ftp client to chmod .htaccess in the forum directory to be writable (777), and then refresh this page.';
 $txt['error_utf8_version'] = 'The current version of your database doesn\'t support the use of the UTF-8 character set. You can still install SMF without any problems, but only with UTF-8 support unchecked. If you would like to switch over to UTF-8 in the future (e.g. after the database server of your forum has been upgraded to version >= %1$s), you can convert your forum to UTF-8 through the admin panel.';
 $txt['error_valid_email_needed'] = 'You have not entered a valid email address.';
-$txt['error_already_installed'] = 'The installer has detected that you already have SMF installed. It is strongly advised that you do <strong>not</strong> try to overwrite an existing installation - continuing with installation <strong>may result in the loss or corruption of existing data</strong>.<br /><br />If you wish to upgrade please visit the <a href="http://www.simplemachines.org">Simple Machines Website</a> and download the latest <em>upgrade</em> package.<br /><br />If you wish to overwrite your existing installation, including all data, it\'s recommended that you delete the existing database tables and replace Settings.php and try again.';
+$txt['error_already_installed'] = 'The installer has detected that you already have SMF installed. It is strongly advised that you do <strong>not</strong> try to overwrite an existing installation - continuing with installation <strong>may result in the loss or corruption of existing data</strong>.<br /><br />If you wish to upgrade please visit the <a href="https://www.simplemachines.org">Simple Machines Website</a> and download the latest <em>upgrade</em> package.<br /><br />If you wish to overwrite your existing installation, including all data, it\'s recommended that you delete the existing database tables and replace Settings.php and try again.';
 $txt['error_warning_notice'] = 'Warning!';
 $txt['error_script_outdated'] = 'This install script is out of date! The current version of SMF is %1$s but this install script is for %2$s.<br /><br />
-	It is recommended that you visit the <a href="http://www.simplemachines.org">Simple Machines</a> website to ensure you are installing the latest version.';
+	It is recommended that you visit the <a href="https://www.simplemachines.org">Simple Machines</a> website to ensure you are installing the latest version.';
 $txt['error_db_filename'] = 'You must enter a name for the database file name for SQLite.';
 $txt['error_db_prefix_numeric'] = 'The selected database type does not support the use of numeric prefixes.';
 $txt['error_invalid_characters_username'] = 'Invalid character used in Username.';
@@ -227,9 +227,9 @@ $txt['upgrade_paused_overload'] = 'This upgrade has been paused to avoid overloa
 
 $txt['upgrade_ready_proceed'] = 'Thank you for choosing to upgrade to SMF %1$s. All files appear to be in place, and we\'re ready to proceed.';
 
-$txt['upgrade_error_script_js'] = 'The upgrade script cannot find script.js or it is out of date. Make sure your theme paths are correct. You can download a setting checker tool from the <a href="http://www.simplemachines.org">Simple Machines Website</a>';
+$txt['upgrade_error_script_js'] = 'The upgrade script cannot find script.js or it is out of date. Make sure your theme paths are correct. You can download a setting checker tool from the <a href="https://www.simplemachines.org">Simple Machines Website</a>';
 
 $txt['upgrade_warning_lots_data'] = 'This upgrade script has detected that your forum contains a lot of data which needs upgrading. This process may take quite some time depending on your server and forum size, and for very large forums (~300,000 messages) may take several hours to complete.';
-$txt['upgrade_warning_out_of_date'] = 'This upgrade script is out of date! The current version of SMF is <em id="smfVersion" style="white-space: nowrap;">??</em> but this upgrade script is for <em id="yourVersion" style="white-space: nowrap;">%1$s</em>.<br /><br />It is recommended that you visit the <a href="http://www.simplemachines.org">Simple Machines</a> website to ensure you are upgrading to the latest version.';
+$txt['upgrade_warning_out_of_date'] = 'This upgrade script is out of date! The current version of SMF is <em id="smfVersion" style="white-space: nowrap;">??</em> but this upgrade script is for <em id="yourVersion" style="white-space: nowrap;">%1$s</em>.<br /><br />It is recommended that you visit the <a href="https://www.simplemachines.org">Simple Machines</a> website to ensure you are upgrading to the latest version.';
 
 ?>
\ No newline at end of file
diff --git a/Themes/default/languages/Login.english.php b/Themes/default/languages/Login.english.php
index d21d092..e09dc63 100644
--- a/Themes/default/languages/Login.english.php
+++ b/Themes/default/languages/Login.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Login
+// Version: 2.0.16; Login
 
 global $context;
 
@@ -8,6 +8,10 @@ $txt['registration_agreement'] = 'Registration Agreement';
 $txt['agreement_agree'] = 'I accept the terms of the agreement.';
 $txt['agreement_agree_coppa_above'] = 'I accept the terms of the agreement and I am at least %1$d years old.';
 $txt['agreement_agree_coppa_below'] = 'I accept the terms of the agreement and I am younger than %1$d years old.';
+$txt['privacy_policy'] = 'Privacy Policy';
+$txt['agreement_policy_agree'] = 'I accept the terms of the agreement and privacy policy.';
+$txt['agreement_policy_agree_coppa_above'] = 'I accept the terms of the agreement and privacy policy, and I am at least %1$d years old.';
+$txt['agreement_policy_agree_coppa_below'] = 'I accept the terms of the agreement and privacy policy, and I am younger than %1$d years old.';
 
 // Registration form.
 $txt['registration_form'] = 'Registration Form';
@@ -95,6 +99,8 @@ $txt['setting_coppaPost_desc'] = 'Only applies if age restriction is in place';
 $txt['setting_coppaFax'] = 'Fax number to which approval forms should be faxed';
 $txt['setting_coppaPhone'] = 'Contact number for parents to contact with age restriction queries';
 
+$txt['setting_announcements_default'] = 'Enable "' . $txt['notify_announcements'] . '" by default.';
+
 $txt['admin_register'] = 'Registration of new member';
 $txt['admin_register_desc'] = 'From here you can register new members into the forum, and if desired, email them their details.';
 $txt['admin_register_username'] = 'New Username';
@@ -110,6 +116,8 @@ $txt['admin_register_group'] = 'Primary Membergroup';
 $txt['admin_register_group_desc'] = 'Primary membergroup new member will belong to';
 $txt['admin_register_group_none'] = '(no primary membergroup)';
 $txt['admin_register_done'] = 'Member %1$s has been registered successfully!';
+$txt['admin_register_require_agreement'] = 'Require user to accept the registration agreement';
+$txt['admin_register_require_policy'] = 'Require user to accept the privacy policy';
 
 $txt['coppa_title'] = 'Age Restricted Forum';
 $txt['coppa_after_registration'] = 'Thank you for registering with ' . $context['forum_name_html_safe'] . '.<br /><br />Because you fall under the age of {MINIMUM_AGE}, it is a legal requirement
diff --git a/Themes/default/languages/ManageSettings.english.php b/Themes/default/languages/ManageSettings.english.php
index b7859c9..b978522 100644
--- a/Themes/default/languages/ManageSettings.english.php
+++ b/Themes/default/languages/ManageSettings.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; ManageSettings
+// Version: 2.0.19; ManageSettings
 
 global $scripturl;
 
@@ -47,12 +47,14 @@ $txt['cookieTime'] = 'Default login cookies length (in minutes)';
 $txt['localCookies'] = 'Enable local storage of cookies<div class="smalltext">(SSI won\'t work well with this on.)</div>';
 $txt['globalCookies'] = 'Use subdomain independent cookies<div class="smalltext">(turn off local cookies first!)</div>';
 $txt['secureCookies'] = 'Force cookies to be secure<div class="smalltext">(This only applies if you are using HTTPS - don\'t use otherwise!)</div>';
+$txt['cookie_no_auth_secret'] = 'Use basic cookie authentication';
 $txt['securityDisable'] = 'Disable administration security';
 $txt['send_validation_onChange'] = 'Require reactivation after email change';
 $txt['approveAccountDeletion'] = 'Require admin approval when member deletes account';
 $txt['autoOptMaxOnline'] = 'Maximum users online when optimizing<div class="smalltext">(0 for no max.)</div>';
 $txt['autoFixDatabase'] = 'Automatically fix broken tables';
 $txt['allow_disableAnnounce'] = 'Allow users to disable announcements';
+$txt['notify_tokens'] = 'Use token-based unsubscribe links in notification emails<div class="smalltext">Allows users to unsubscribe without logging in.</div>';
 $txt['disallow_sendBody'] = 'Don\'t allow post text in notifications';
 $txt['queryless_urls'] = 'Search engine friendly URLs<div class="smalltext"><strong>Apache/Lighttpd only!</strong></div>';
 $txt['max_image_width'] = 'Max width of posted pictures (0 = disable)';
@@ -77,6 +79,13 @@ $txt['disableHostnameLookup'] = 'Disable hostname lookups';
 $txt['who_enabled'] = 'Enable who\'s online list';
 $txt['make_email_viewable'] = 'Allow viewable email addresses';
 $txt['meta_keywords'] = 'Meta keywords associated with forum<div class="smalltext">For search engines. Leave blank for default.</div>';
+$txt['image_proxy_enabled'] = 'Enable Image Proxy';
+$txt['image_proxy_enabled_desc'] = 'This will proxy images posted within <b>[img]</b> tags.</b>';
+$txt['image_proxy_secret'] = 'Image Proxy Secret';
+$txt['image_proxy_secret_desc'] = 'This should be unique to your site. Be sure to keep it a secret.';
+$txt['image_proxy_maxsize'] = 'Maximum file size of images to cache';
+$txt['image_proxy_maxsize_postinput'] = 'KB';
+$txt['image_proxy_maxsize_desc'] = 'Images above this threshold are still shown.';
 
 $txt['karmaMode'] = 'Karma mode';
 $txt['karma_options'] = 'Disable karma|Enable karma total|Enable karma positive/negative';
@@ -292,6 +301,9 @@ $txt['core_settings_item_sp'] = 'Search Engine Tracking';
 $txt['core_settings_item_sp_desc'] = 'Enabling this feature will allow administrators to track search engines as they index your forum.';
 $txt['core_settings_item_w'] = 'Warning System';
 $txt['core_settings_item_w_desc'] = 'This functionality allows administrators and moderators to issue warnings to users; it also includes advanced functionality for automatically removing user rights as their warning level increases. Note to take full advantage of this function &quot;Post Moderation&quot; should be enabled.';
+$txt['core_settings_item_gdpr'] = 'GDPR Compliance';
+$txt['core_settings_item_gdpr_desc'] = 'Enabling this feature will configure a number of settings on your forum to make it compliant with the European Union\'s <a href="https://ec.europa.eu/info/law/law-topic/data-protection_en" class="bbc_link">General Data Protection Regulation</a>.';
+$txt['core_settings_privacy_policy_warning'] = 'The GDPR requires you to have a privacy policy for your forum. After you enable this setting, you will be take to a page where you can create one.';
 $txt['core_settings_switch_on'] = 'Click to Enable';
 $txt['core_settings_switch_off'] = 'Click to Disable';
 $txt['core_settings_enabled'] = 'Enabled';
diff --git a/Themes/default/languages/Modlog.english.php b/Themes/default/languages/Modlog.english.php
index dd19970..b225d3d 100644
--- a/Themes/default/languages/Modlog.english.php
+++ b/Themes/default/languages/Modlog.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Modlog
+// Version: 2.0.16; Modlog
 
 global $scripturl;
 
@@ -52,6 +52,7 @@ $txt['modlog_ac_ban_trigger_hostname'] = ' <em>Hostname:</em> {hostname}';
 $txt['modlog_admin_log'] = 'Administration Log';
 $txt['modlog_admin_log_desc'] = 'Below is a list of administration actions which have been logged on your forum.<br /><strong>Please note:</strong> Entries cannot be removed from this log until they are at least twenty-four hours old.';
 $txt['modlog_admin_log_no_entries_found'] = 'There are currently no administration log entries.';
+$txt['modlog_admin_log_gdpr_no_delete'] = '<strong>Also note:</strong> Entries for updates to the registration agreement and privacy policy cannot be removed from this log while the GDPR Compliance setting is enabled.';
 
 // Admin type strings.
 $txt['modlog_ac_upgrade'] = 'Upgraded the forum to version {version}';
@@ -70,6 +71,9 @@ $txt['modlog_ac_added_to_group'] = 'Added &quot;{member}&quot; to the &quot;{gro
 $txt['modlog_ac_removed_from_group'] = 'Removed &quot;{member}&quot; from the &quot;{group}&quot; group';
 $txt['modlog_ac_removed_all_groups'] = 'Removed &quot;{member}&quot; from all groups';
 
+$txt['modlog_ac_agreement_updated'] = 'Updated the {language} registration agreement';
+$txt['modlog_ac_policy_updated'] = 'Updated the {language} privacy policy';
+
 $txt['modlog_ac_remind_member'] = 'Sent out a reminder to &quot;{member}&quot; to activate their account';
 $txt['modlog_ac_approve_member'] = 'Approved/Activated the account of &quot;{member}&quot;';
 $txt['modlog_ac_newsletter'] = 'Sent Newsletter';
diff --git a/Themes/default/languages/Profile.english.php b/Themes/default/languages/Profile.english.php
index 2cdf006..5ab0680 100644
--- a/Themes/default/languages/Profile.english.php
+++ b/Themes/default/languages/Profile.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Profile
+// Version: 2.0.18; Profile
 
 global $scripturl, $context;
 
@@ -290,7 +290,6 @@ $txt['display_quick_mod_check'] = 'checkboxes.';
 $txt['display_quick_mod_image'] = 'icons.';
 
 $txt['whois_title'] = 'Look up IP on a regional whois-server';
-$txt['whois_afrinic'] = 'AfriNIC (Africa)';
 $txt['whois_apnic'] = 'APNIC (Asia Pacific region)';
 $txt['whois_arin'] = 'ARIN (North America, a portion of the Caribbean and sub-Saharan Africa)';
 $txt['whois_lacnic'] = 'LACNIC (Latin American and Caribbean region)';
@@ -471,4 +470,10 @@ $txt['filter_boards'] = 'Filter to certain boards:';
 $txt['current_filtered_boards'] = 'Currently viewing by boards:';
 $txt['filter_boards_submit'] = 'Filter';
 
+// Registration Agreement
+$txt['trackEdit_action_agreement_accepted'] = 'Accepted the registration agreement';
+$txt['trackEdit_action_policy_accepted'] = 'Accepted the privacy policy';
+
+$txt['export_profile_data'] = 'Download profile data';
+
 ?>
\ No newline at end of file
diff --git a/Themes/default/languages/Who.english.php b/Themes/default/languages/Who.english.php
index 84148b1..01f0723 100644
--- a/Themes/default/languages/Who.english.php
+++ b/Themes/default/languages/Who.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0; Who
+// Version: 2.0.16; Who
 
 global $scripturl, $context;
 
@@ -150,6 +150,7 @@ $txt['credits_groups_beta'] = 'Beta Testers';
 $txt['credits_beta_message'] = 'The invaluable few who tirelessly find bugs, provide feedback, and drive the developers crazier.';
 $txt['credits_groups_founder'] = 'Founding Father of SMF';
 $txt['credits_groups_orignal_pm'] = 'Original Project Managers';
+$txt['credits_in_memoriam'] = 'In loving memory of';
 
 // List of people who have made more than a token contribution to this translation. (blank for English)
 $txt['translation_credits'] = array();
diff --git a/Themes/default/languages/index.english.php b/Themes/default/languages/index.english.php
index f13087b..dd7ea6f 100644
--- a/Themes/default/languages/index.english.php
+++ b/Themes/default/languages/index.english.php
@@ -1,5 +1,5 @@
 <?php
-// Version: 2.0.12; index
+// Version: 2.0.18; index
 
 global $forum_copyright, $forum_version, $webmaster_email, $scripturl, $context, $boardurl;
 
@@ -106,6 +106,7 @@ $txt['admin_login'] = 'Administration Login';
 // Use numeric entities in the below string.
 $txt['topic'] = 'Topic';
 $txt['help'] = 'Help';
+$txt['terms_and_policies'] = 'Terms and Policies';
 $txt['notify'] = 'Notify';
 $txt['unnotify'] = 'Unnotify';
 $txt['notify_request'] = 'Do you want a notification email if someone replies to this topic?';
@@ -436,7 +437,7 @@ $txt['go_up'] = 'Go Up';
 $txt['go_down'] = 'Go Down';
 
 $forum_copyright = '<a href="' . $scripturl . '?action=credits" title="Simple Machines Forum" target="_blank" class="new_win">%1$s</a> |
- <a href="http://www.simplemachines.org/about/smf/license.php" title="License" target="_blank" class="new_win">SMF &copy; 2016</a>, <a href="http://www.simplemachines.org" title="Simple Machines" target="_blank" class="new_win">Simple Machines</a>';
+ <a href="https://www.simplemachines.org/about/smf/license.php" title="License" target="_blank" class="new_win">SMF &copy; 2021</a>, <a href="https://www.simplemachines.org" title="Simple Machines" target="_blank" class="new_win">Simple Machines</a>';
 
 $txt['birthdays'] = 'Birthdays:';
 $txt['events'] = 'Events:';
@@ -619,6 +620,19 @@ $txt['approve_members_waiting'] = 'awaiting approval.';
 
 $txt['notifyboard_turnon'] = 'Do you want a notification email when someone posts a new topic in this board?';
 $txt['notifyboard_turnoff'] = 'Are you sure you do not want to receive new topic notifications for this board?';
+$txt['notifyboard_subscribed'] = '%1$s has been subscribed to new topic notifications for this board.';
+$txt['notifyboard_unsubscribed'] = '%1$s has been unsubscribed from new topic notifications for this board.';
+
+$txt['notifytopic_subscribed'] = '%1$s has been subscribed to new reply notifications for this topic.';
+$txt['notifytopic_unsubscribed'] = '%1$s has been unsubscribed from new reply notifications for this topic.';
+
+$txt['notify_announcements'] = 'Allow the administrators to send me important news by email';
+$txt['notifyannouncements_prompt'] = 'Do you want to receive forum newsletters, announcements and important notifications by email?';
+$txt['notifyannouncements_subscribed'] = '%1$s has been subscribed to forum newsletters, announcements and important notifications.';
+$txt['notifyannouncements_unsubscribed'] = '%1$s has been unsubscribed from forum newsletters, announcements and important notifications.';
+
+$txt['unsubscribe_announcements_plain'] = 'To unsubscribe from forum newsletters, announcements and important notifications, follow this link:<br />%1$s';
+$txt['unsubscribe_announcements_html'] = '<span style="font-size:small"><a href="%1$s">Unsubscribe</a> from forum newsletters, announcements and important notifications.</span>';
 
 $txt['activate_code'] = 'Your activation code is';
 
diff --git a/Themes/default/scripts/script.js b/Themes/default/scripts/script.js
index e45c7c1..789b65d 100644
--- a/Themes/default/scripts/script.js
+++ b/Themes/default/scripts/script.js
@@ -144,17 +144,26 @@ String.prototype.php_to8bit = function ()
 	{
 		var n, sReturn = '';
 
+		// Recode from UTF16 (native .js) to UTF8
 		for (var i = 0, iTextLen = this.length; i < iTextLen; i++)
 		{
+			// Below xFFFF, UTF16 simply = the code points
 			n = this.charCodeAt(i);
 			if (n < 128)
-				sReturn += String.fromCharCode(n)
+				sReturn += String.fromCharCode(n);
 			else if (n < 2048)
 				sReturn += String.fromCharCode(192 | n >> 6) + String.fromCharCode(128 | n & 63);
-			else if (n < 65536)
-				sReturn += String.fromCharCode(224 | n >> 12) + String.fromCharCode(128 | n >> 6 & 63) + String.fromCharCode(128 | n & 63);
-			else
+			// 0xD800 - 0xDBFF
+			else if (n >= 55296 && n <= 56319)
+			{
+				// In this range, this is the beginning of a surrogate pair, where 4-byte utf8 chars are
+				n = 65536 + ((n & 1023) << 10) + (this.charCodeAt(i + 1) & 1023);
 				sReturn += String.fromCharCode(240 | n >> 18) + String.fromCharCode(128 | n >> 12 & 63) + String.fromCharCode(128 | n >> 6 & 63) + String.fromCharCode(128 | n & 63);
+				// Skip next char, already used...
+				i++;
+			}
+			else
+				sReturn += String.fromCharCode(224 | n >> 12) + String.fromCharCode(128 | n >> 6 & 63) + String.fromCharCode(128 | n & 63);
 		}
 
 		return sReturn;
@@ -1360,7 +1369,11 @@ function smfSelectText(oCurElement, bActOnElement)
 	{
 		var oCurSelection = window.getSelection();
 		// Safari is special!
-		if (oCurSelection.setBaseAndExtent)
+		if (oCurSelection.selectAllChildren)
+		{
+			oCurSelection.selectAllChildren(oCodeArea);
+		}
+		else if (oCurSelection.setBaseAndExtent)
 		{
 			var oLastChild = oCodeArea.lastChild;
 			oCurSelection.setBaseAndExtent(oCodeArea, 0, oLastChild, 'innerText' in oLastChild ? oLastChild.innerText.length : oLastChild.textContent.length);
diff --git a/index.php b/index.php
index e794bca..df4d64a 100644
--- a/index.php
+++ b/index.php
@@ -8,7 +8,7 @@
  * @copyright 2011 Simple Machines
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.13
+ * @version 2.0.19
  */
 
 /*	This, as you have probably guessed, is the crux on which SMF functions.
@@ -22,12 +22,12 @@
 	with the URL index.php?action=action-in-url.  Relatively simple, no?
 */
 
-$forum_version = 'SMF 2.0.13';
+$forum_version = 'SMF 2.0.19';
 @ini_set('memory_limit', '128M');
 
 // Get everything started up...
 define('SMF', 1);
-if (function_exists('set_magic_quotes_runtime'))
+if (version_compare(PHP_VERSION, '7.4.0') == -1 && function_exists('set_magic_quotes_runtime'))
 	@set_magic_quotes_runtime(0);
 error_reporting(defined('E_STRICT') ? E_ALL | E_STRICT : E_ALL);
 $time_start = microtime();
@@ -65,6 +65,9 @@ if (!empty($maintenance) && $maintenance == 2)
 // Create a variable to store some SMF specific functions in.
 $smcFunc = array();
 
+// Register an error handler.
+set_error_handler('error_handler');
+
 // Initate the database connection and define some database functions to use.
 loadDatabase();
 
@@ -107,8 +110,25 @@ if (!headers_sent())
 	header('X-Content-Type-Options: nosniff');
 }
 
-// Register an error handler.
-set_error_handler('error_handler');
+// Quickly catch random exceptions.
+set_exception_handler(function ($e) use ($db_show_debug)
+{
+	$error_type = 'general';
+
+	// PHP 7 converts fatal errors to special Throwable types. Log them as such.
+	if (is_a($e, 'Error'))
+		$error_type = 'critical';
+
+	if (isset($db_show_debug) && $db_show_debug === true && allowedTo('admin_forum'))
+	{
+		// Only log the message; the rest (such as the stack trace) is just fluff in the log.
+		log_error($e->getMessage(), $error_type);
+
+		fatal_error(nl2br($e), false);
+	}
+	else
+		fatal_error($e->getMessage(), $error_type);
+});
 
 // Start the session. (assuming it hasn't already been.)
 loadSession();
@@ -255,6 +275,8 @@ function smf_main()
 
 	// Here's the monstrous $_REQUEST['action'] array - $_REQUEST['action'] => array($file, $function).
 	$actionArray = array(
+		'agreement' => array('Agreement.php', 'Agreement'),
+		'acceptagreement' => array('Agreement.php', 'AcceptAgreement'),
 		'activate' => array('Register.php', 'Activate'),
 		'admin' => array('Admin.php', 'AdminMain'),
 		'announce' => array('Post.php', 'AnnounceTopic'),
@@ -298,6 +320,7 @@ function smf_main()
 		'movetopic2' => array('MoveTopic.php', 'MoveTopic2'),
 		'notify' => array('Notify.php', 'Notify'),
 		'notifyboard' => array('Notify.php', 'BoardNotify'),
+		'notifyannouncements' => array('Notify.php', 'AnnouncementsNotify'),
 		'openidreturn' => array('Subs-OpenID.php', 'smf_openID_return'),
 		'pm' => array('PersonalMessage.php', 'MessageMain'),
 		'post' => array('Post.php', 'Post'),
diff --git a/proxy.php b/proxy.php
index 8f4b3b7..0810303 100644
--- a/proxy.php
+++ b/proxy.php
@@ -10,7 +10,7 @@
  * @copyright 2016 Simple Machines and individual contributors
  * @license http://www.simplemachines.org/about/smf/license.php BSD
  *
- * @version 2.0.14
+ * @version 2.0.19
  */
 
 define('SMF', 'proxy');
@@ -67,26 +67,31 @@ class ProxyServer
 
 		// Try to create the image cache directory if it doesn't exist
 		if (!file_exists($this->cache))
+		{
 			if (!mkdir($this->cache) || !copy(dirname($this->cache) . '/index.php', $this->cache . '/index.php'))
 				return false;
+		}
+
+		// Basic sanity check
+		$_GET['request'] = filter_var($_GET['request'], FILTER_VALIDATE_URL);
 
+		// We aren't going anywhere without these
 		if (empty($_GET['hash']) || empty($_GET['request']))
 			return false;
 
 		$hash = $_GET['hash'];
 		$request = $_GET['request'];
 
-		if (md5($request . $this->secret) != $hash)
+		if (hash_hmac('sha1', $request, $this->secret) != $hash)
 			return false;
 
 		// Attempt to cache the request if it doesn't exist
-		if (!$this->isCached($request)) {
+		if (!$this->isCached($request))
 			return $this->cacheImage($request);
-		}
 
 		return true;
 	}
-	
+
 
 	/**
 	 * Serves the request
@@ -102,17 +107,14 @@ class ProxyServer
 
 		// Did we get an error when trying to fetch the image
 		$response = $this->checkRequest();
-		if (is_int($response)) {
+		if (!$response)
+		{
 			// Throw a 404
-			header('HTTP/1.0 404 Not Found');
+			header('HTTP/1.1 404 Not Found');
 			exit;
 		}
-		// Right, image not cached? Simply redirect, then.
-		if (!$response) {
-			header('Location: ' . $request, false, 301);
-		}
 
-		// Is the cache expired?
+		// Is the cache expired? Try to refresh it.
 		if (!$cached || time() - $cached['time'] > (5 * 86400))
 		{
 			@unlink($cached_file);
@@ -126,15 +128,30 @@ class ProxyServer
 		if ($contentParts[0] != 'image')
 			exit;
 
+		// Check whether the ETag was sent back, and cache based on that...
+		$eTag = '"' . substr(sha1($request) . $cached['time'], 0, 64) . '"';
+		if (!empty($_SERVER['HTTP_IF_NONE_MATCH']) && strpos($_SERVER['HTTP_IF_NONE_MATCH'], $eTag) !== false)
+		{
+			header('HTTP/1.1 304 Not Modified');
+			exit;
+		}
+
 		header('Content-type: ' . $cached['content_type']);
 		header('Content-length: ' . $cached['size']);
+
+		// Add some caching
+		header('Cache-control: public');
+		header('Expires: ' . gmdate('D, d M Y H:i:s', time() + 525600 * 60) . ' GMT');
+		header('Last-Modified: ' . gmdate('D, d M Y H:i:s', filemtime($cached_file)) . ' GMT');
+		header('ETag: ' . $eTag);
+
 		echo base64_decode($cached['body']);
 	}
 
 	/**
 	 * Returns the request's hashed filepath
 	 *
-	 * @access public
+	 * @access protected
 	 * @param string $request The request to get the path for
 	 * @return string The hashed filepath for the specified request
 	 */
@@ -160,43 +177,66 @@ class ProxyServer
 	 *
 	 * @access protected
 	 * @param string $request The image to cache/validate
-	 * @return bool|int Whether the specified image was cached or error code when accessing
+	 * @return bool|null Whether the specified image was cached; null if not found or not an image.
 	 */
 	protected function cacheImage($request)
 	{
+		$request_url = $request;
+
 		$dest = $this->getCachedPath($request);
 		$curl = new curl_fetch_web_data(array(CURLOPT_BINARYTRANSFER => 1));
 		$request = $curl->get_url_data($request);
 		$responseCode = $request->result('code');
 		$response = $request->result();
-		
-		if (empty($response)) {
-			return false;
-		}
-		
-		if ($responseCode != 200) {
-			return $request->result('code');
-		}
+
+		if (empty($response) || $responseCode != 200)
+			$this->redirectexit($request_url);
 
 		$headers = $response['headers'];
 
+		// What kind of file did they give us?
+		if (function_exists('finfo_open'))
+		{
+			$finfo = finfo_open(FILEINFO_MIME_TYPE);
+			$headers['content-type'] = finfo_buffer($finfo, $response['body']);
+			finfo_close($finfo);
+		}
+
+		// SVG needs a little extra care
+		if (in_array($headers['content-type'], array('text/plain', 'text/xml')) && strtolower(pathinfo(parse_url($request_url, PHP_URL_PATH), PATHINFO_EXTENSION)) == 'svg' && strpos($response['body'], '<svg') !== false && strpos($response['body'], '</svg>') !== false)
+			$headers['content-type'] = 'image/svg+xml';
+
 		// Make sure the url is returning an image
 		$contentParts = explode('/', !empty($headers['content-type']) ? $headers['content-type'] : '');
 		if ($contentParts[0] != 'image')
-			return false;
+			$this->redirectexit($request_url);
 
 		// Validate the filesize
 		if ($response['size'] > ($this->maxSize * 1024))
-			return false;
+			$this->redirectexit($request_url);
 
 		return file_put_contents($dest, json_encode(array(
 			'content_type' => $headers['content-type'],
 			'size' => $response['size'],
 			'time' => time(),
 			'body' => base64_encode($response['body']),
-		)));
+		))) !== false;
+	}
+
+	/**
+	 * A helper function to redirect a request
+	 *
+	 * @access private
+	 * @param string $request
+	 */
+	private function redirectexit($request)
+	{
+		header('Location: ' . un_htmlspecialchars($request), false, 301);
+		exit;
 	}
 }
 
 $proxy = new ProxyServer();
 $proxy->serve();
+
+?>
diff --git a/ssi_examples.php b/ssi_examples.php
index 1aca176..116f7d0 100644
--- a/ssi_examples.php
+++ b/ssi_examples.php
@@ -4,9 +4,9 @@
  * Simple Machines Forum (SMF)
  *
  * @package SMF
- * @author Simple Machines http://www.simplemachines.org
+ * @author Simple Machines https://www.simplemachines.org
  * @copyright 2011 Simple Machines
- * @license http://www.simplemachines.org/about/smf/license.php BSD
+ * @license https://www.simplemachines.org/about/smf/license.php BSD
  *
  * @version 2.0
  */
@@ -44,10 +44,10 @@ template_ssi_above();
 			<h2>Some notes on usage</h2>
 			<p>All the functions have an output method parameter.  This can either be &quot;echo&quot; (the default) or &quot;array&quot;</p>
 			<p>If it is &quot;echo&quot;, the function will act normally - otherwise, it will return an array containing information about the requested task. For example, it might return a list of topics for ssi_recentTopics.</p>
-			<p onclick="if (getInnerHTML(this).indexOf('Bird') == -1) setInnerHTML(this, getInnerHTML(this) + '<br /><img src=&quot;http://www.simplemachines.org/images/chocobo.jpg&quot; title=&quot;Bird-san&quot; alt=&quot;Chocobo!&quot; />'); return false;">This functionality can be used to allow you to present the information in any way you wish.</p>
+			<p onclick="if (getInnerHTML(this).indexOf('Bird') == -1) setInnerHTML(this, getInnerHTML(this) + '<br /><img src=&quot;https://www.simplemachines.org/images/chocobo.jpg&quot; title=&quot;Bird-san&quot; alt=&quot;Chocobo!&quot; />'); return false;">This functionality can be used to allow you to present the information in any way you wish.</p>
 
 			<h2>Additional Guides &amp; FAQ</h2>
-			<p>Need more information on using SSI.php? Check out <a href="http://docs.simplemachines.org/index.php?topic=400.0">Using SSI.php article</a> or <a href="http://www.simplemachines.org/community/index.php?topic=14906.0">the SSI FAQ</a>.</p>
+			<p>Need more information on using SSI.php? Check out <a href="https://docs.simplemachines.org/index.php?topic=400.0">Using SSI.php article</a> or <a href="https://www.simplemachines.org/community/index.php?topic=14906.0">the SSI FAQ</a>.</p>
 
 			<div id="sidenav" class="windowbg">
 				<span class="topslice"><span></span></span>
@@ -547,7 +547,7 @@ function template_ssi_below()
 				</div>
 			</div></div>
 			<div id="footer_section"><div class="frame">
-				<div class="smalltext"><a href="http://www.simplemachines.org">Simple Machines Forum</a></div>
+				<div class="smalltext"><a href="https://www.simplemachines.org">Simple Machines Forum</a></div>
 			</div></div>
 		</div>
 	</body>
@@ -683,4 +683,4 @@ unset($topics);
 	return $result;
 }
 
-?>
\ No newline at end of file
+?>
diff --git a/ssi_examples.shtml b/ssi_examples.shtml
index 0e93ab2..697f106 100644
--- a/ssi_examples.shtml
+++ b/ssi_examples.shtml
@@ -150,7 +150,7 @@
 		<br />
 		<br />
 		<span style="font-size: smaller;">
-			<a href="http://www.simplemachines.org/" title="Free Forum Software" target="_blank">SMF &copy; 2006&ndash;2010, Simple Machines LLC</a>
+			<a href="https://www.simplemachines.org/" title="Free Forum Software" target="_blank">SMF &copy; 2006&ndash;2010, Simple Machines LLC</a>
 		</span>
 		<br />
 		<br />
@@ -159,4 +159,4 @@
 		</span>
 
 	</body>
-</html>
\ No newline at end of file
+</html>
diff --git a/upgrade.php b/upgrade.php
new file mode 100644
index 0000000..bd0d1a6
--- /dev/null
+++ b/upgrade.php
@@ -0,0 +1,4576 @@
+<?php
+
+/**
+ * Simple Machines Forum (SMF)
+ *
+ * @package SMF
+ * @author Simple Machines http://www.simplemachines.org
+ * @copyright 2011 Simple Machines
+ * @license http://www.simplemachines.org/about/smf/license.php BSD
+ *
+ * @version 2.0.19
+ */
+
+// Version of index.php
+define('SMF_VERSION', '2.0.19');
+
+// Version of index.[language].php
+define('SMF_LANG_VERSION', '2.0.18');
+
+$GLOBALS['required_php_version'] = '5.3.0';
+
+$databases = array(
+	'mysql' => array(
+		'name' => 'MySQL',
+		'version' => '4.0.18',
+		'version_check' => 'global $db_connection; return min(mysqli_get_server_info($db_connection), mysqli_get_client_info());',
+		'utf8_support' => true,
+		'utf8_version' => '4.1.0',
+		'utf8_version_check' => 'global $db_connection; return mysqli_get_server_info($db_connection);',
+		'alter_support' => true,
+	),
+	'postgresql' => array(
+		'name' => 'PostgreSQL',
+		'version' => '8.0',
+		'version_check' => '$version = pg_version(); return $version[\'client\'];',
+		'always_has_db' => true,
+	),
+	'sqlite' => array(
+		'name' => 'SQLite',
+		'version' => '1',
+		'version_check' => 'return 1;',
+		'always_has_db' => true,
+	),
+);
+
+// General options for the script.
+$timeLimitThreshold = 3;
+$upgrade_path = dirname(__FILE__);
+$upgradeurl = $_SERVER['PHP_SELF'];
+// Where the SMF images etc are kept.
+$smfsite = 'https://www.simplemachines.org/smf';
+// Disable the need for admins to login?
+$disable_security = 0;
+// How long, in seconds, must admin be inactive to allow someone else to run?
+$upcontext['inactive_timeout'] = 10;
+
+// All the steps in detail.
+// Number,Name,Function,Progress Weight.
+$upcontext['steps'] = array(
+	0 => array(1, 'Login', 'WelcomeLogin', 2),
+	1 => array(2, 'Upgrade Options', 'UpgradeOptions', 2),
+	2 => array(3, 'Backup', 'BackupDatabase', 10),
+	3 => array(4, 'Database Changes', 'DatabaseChanges', 70),
+	// This is removed as it doesn't really work right at the moment.
+	//4 => array(5, 'Cleanup Mods', 'CleanupMods', 10),
+	4 => array(5, 'Delete Upgrade', 'DeleteUpgrade', 1),
+);
+// Just to remember which one has files in it.
+$upcontext['database_step'] = 3;
+@set_time_limit(600);
+// Clean the upgrade path if this is from the client.
+if (!empty($_SERVER['argv']) && php_sapi_name() == 'cli' && empty($_SERVER['REMOTE_ADDR']))
+	for ($i = 1; $i < $_SERVER['argc']; $i++)
+	{
+		if (preg_match('~^--path=(.+)$~', $_SERVER['argv'][$i], $match) != 0)
+			$upgrade_path = substr($match[1], -1) == '/' ? substr($match[1], 0, -1) : $match[1];
+	}
+
+// Are we from the client?
+if (php_sapi_name() == 'cli' && empty($_SERVER['REMOTE_ADDR']))
+{
+	$command_line = true;
+	$disable_security = 1;
+}
+else
+	$command_line = false;
+
+// Load this now just because we can.
+require_once($upgrade_path . '/Settings.php');
+
+// Are we logged in?
+if (isset($upgradeData))
+{
+	$upcontext['user'] = unserialize(base64_decode($upgradeData));
+
+	// Check for sensible values.
+	if (empty($upcontext['user']['started']) || $upcontext['user']['started'] < time() - 86400)
+		$upcontext['user']['started'] = time();
+	if (empty($upcontext['user']['updated']) || $upcontext['user']['updated'] < time() - 86400)
+		$upcontext['user']['updated'] = 0;
+
+	$upcontext['started'] = $upcontext['user']['started'];
+	$upcontext['updated'] = $upcontext['user']['updated'];
+}
+
+// Nothing sensible?
+if (empty($upcontext['updated']))
+{
+	$upcontext['started'] = time();
+	$upcontext['updated'] = 0;
+	$upcontext['user'] = array(
+		'id' => 0,
+		'name' => 'Guest',
+		'pass' => 0,
+		'started' => $upcontext['started'],
+		'updated' => $upcontext['updated'],
+	);
+}
+
+// Load up some essential data...
+loadEssentialData();
+
+// Are we going to be mimic'ing SSI at this point?
+if (isset($_GET['ssi']))
+{
+	require_once($sourcedir . '/Subs.php');
+	require_once($sourcedir . '/Errors.php');
+	require_once($sourcedir . '/Load.php');
+	require_once($sourcedir . '/Security.php');
+	require_once($sourcedir . '/Subs-Package.php');
+
+	loadUserSettings();
+	loadPermissions();
+}
+
+// All the non-SSI stuff.
+if (!function_exists('ip2range'))
+	require_once($sourcedir . '/Subs.php');
+
+if (!function_exists('un_htmlspecialchars'))
+{
+	function un_htmlspecialchars($string)
+	{
+		return strtr($string, array_flip(get_html_translation_table(HTML_SPECIALCHARS, ENT_QUOTES)) + array('&#039;' => '\'', '&nbsp;' => ' '));
+	}
+}
+
+if (!function_exists('text2words'))
+{
+	function text2words($text)
+	{
+		global $smcFunc;
+
+		// Step 1: Remove entities/things we don't consider words:
+		$words = preg_replace('~(?:[\x0B\0\xA0\t\r\s\n(){}\\[\\]<>!@$%^*.,:+=`\~\?/\\\\]+|&(?:amp|lt|gt|quot);)+~', ' ', $text);
+
+		// Step 2: Entities we left to letters, where applicable, lowercase.
+		$words = preg_replace('~([^&\d]|^)[#;]~', '$1 ', un_htmlspecialchars(strtolower($words)));
+
+		// Step 3: Ready to split apart and index!
+		$words = explode(' ', $words);
+		$returned_words = array();
+		foreach ($words as $word)
+		{
+			$word = trim($word, '-_\'');
+
+			if ($word != '')
+				$returned_words[] = substr($word, 0, 20);
+		}
+
+		return array_unique($returned_words);
+	}
+}
+
+// Used in some of the index-building funcs in 1.1; mb not needed yet...
+if (!isset($smcFunc['strtolower']))
+{
+	$smcFunc += array(
+		'strtolower' => 'strtolower',
+	);
+}
+
+if (!function_exists('clean_cache'))
+{
+	// Empty out the cache folder.
+	function clean_cache($type = '')
+	{
+		global $cachedir, $sourcedir;
+
+		// No directory = no game.
+		if (!is_dir($cachedir))
+			return;
+
+		// Remove the files in SMF's own disk cache, if any
+		$dh = opendir($cachedir);
+		while ($file = readdir($dh))
+		{
+			if ($file != '.' && $file != '..' && $file != 'index.php' && $file != '.htaccess' && (!$type || substr($file, 0, strlen($type)) == $type))
+				@unlink($cachedir . '/' . $file);
+		}
+		closedir($dh);
+
+		// Invalidate cache, to be sure!
+		// ... as long as Load.php can be modified, anyway.
+		@touch($sourcedir . '/' . 'Load.php');
+		clearstatcache();
+	}
+}
+
+// MD5 Encryption.
+if (!function_exists('md5_hmac'))
+{
+	function md5_hmac($data, $key)
+	{
+		if (strlen($key) > 64)
+			$key = pack('H*', md5($key));
+		$key = str_pad($key, 64, chr(0x00));
+
+		$k_ipad = $key ^ str_repeat(chr(0x36), 64);
+		$k_opad = $key ^ str_repeat(chr(0x5c), 64);
+
+		return md5($k_opad . pack('H*', md5($k_ipad . $data)));
+	}
+}
+
+// http://www.faqs.org/rfcs/rfc959.html
+if (!class_exists('ftp_connection'))
+{
+	class ftp_connection
+	{
+		var $connection = 'no_connection', $error = false, $last_message, $pasv = array();
+
+		// Create a new FTP connection...
+		function __construct($ftp_server, $ftp_port = 21, $ftp_user = 'anonymous', $ftp_pass = 'ftpclient@simplemachines.org')
+		{
+			if ($ftp_server !== null)
+				$this->connect($ftp_server, $ftp_port, $ftp_user, $ftp_pass);
+		}
+
+		function connect($ftp_server, $ftp_port = 21, $ftp_user = 'anonymous', $ftp_pass = 'ftpclient@simplemachines.org')
+		{
+			if (substr($ftp_server, 0, 6) == 'ftp://')
+				$ftp_server = substr($ftp_server, 6);
+			elseif (substr($ftp_server, 0, 7) == 'ftps://')
+				$ftp_server = 'ssl://' . substr($ftp_server, 7);
+			if (substr($ftp_server, 0, 7) == 'http://')
+				$ftp_server = substr($ftp_server, 7);
+			$ftp_server = strtr($ftp_server, array('/' => '', ':' => '', '@' => ''));
+
+			// Connect to the FTP server.
+			$this->connection = @fsockopen($ftp_server, $ftp_port, $err, $err, 5);
+			if (!$this->connection)
+			{
+				$this->error = 'bad_server';
+				return;
+			}
+
+			// Get the welcome message...
+			if (!$this->check_response(220))
+			{
+				$this->error = 'bad_response';
+				return;
+			}
+
+			// Send the username, it should ask for a password.
+			fwrite($this->connection, 'USER ' . $ftp_user . "\r\n");
+			if (!$this->check_response(331))
+			{
+				$this->error = 'bad_username';
+				return;
+			}
+
+			// Now send the password... and hope it goes okay.
+			fwrite($this->connection, 'PASS ' . $ftp_pass . "\r\n");
+			if (!$this->check_response(230))
+			{
+				$this->error = 'bad_password';
+				return;
+			}
+		}
+
+		function chdir($ftp_path)
+		{
+			if (!is_resource($this->connection))
+				return false;
+
+			// No slash on the end, please...
+			if (substr($ftp_path, -1) == '/' && $ftp_path !== '/')
+				$ftp_path = substr($ftp_path, 0, -1);
+
+			fwrite($this->connection, 'CWD ' . $ftp_path . "\r\n");
+			if (!$this->check_response(250))
+			{
+				$this->error = 'bad_path';
+				return false;
+			}
+
+			return true;
+		}
+
+		function chmod($ftp_file, $chmod)
+		{
+			if (!is_resource($this->connection))
+				return false;
+
+			// Convert the chmod value from octal (0777) to text ("777").
+			fwrite($this->connection, 'SITE CHMOD ' . decoct($chmod) . ' ' . $ftp_file . "\r\n");
+			if (!$this->check_response(200))
+			{
+				$this->error = 'bad_file';
+				return false;
+			}
+
+			return true;
+		}
+
+		function unlink($ftp_file)
+		{
+			// We are actually connected, right?
+			if (!is_resource($this->connection))
+				return false;
+
+			// Delete file X.
+			fwrite($this->connection, 'DELE ' . $ftp_file . "\r\n");
+			if (!$this->check_response(250))
+			{
+				fwrite($this->connection, 'RMD ' . $ftp_file . "\r\n");
+
+				// Still no love?
+				if (!$this->check_response(250))
+				{
+					$this->error = 'bad_file';
+					return false;
+				}
+			}
+
+			return true;
+		}
+
+		function check_response($desired)
+		{
+			// Wait for a response that isn't continued with -, but don't wait too long.
+			$time = time();
+			do
+				$this->last_message = fgets($this->connection, 1024);
+			while (substr($this->last_message, 3, 1) != ' ' && time() - $time < 5);
+
+			// Was the desired response returned?
+			return is_array($desired) ? in_array(substr($this->last_message, 0, 3), $desired) : substr($this->last_message, 0, 3) == $desired;
+		}
+
+		function passive()
+		{
+			// We can't create a passive data connection without a primary one first being there.
+			if (!is_resource($this->connection))
+				return false;
+
+			// Request a passive connection - this means, we'll talk to you, you don't talk to us.
+			@fwrite($this->connection, 'PASV' . "\r\n");
+			$time = time();
+			do
+				$response = fgets($this->connection, 1024);
+			while (substr($response, 3, 1) != ' ' && time() - $time < 5);
+
+			// If it's not 227, we weren't given an IP and port, which means it failed.
+			if (substr($response, 0, 4) != '227 ')
+			{
+				$this->error = 'bad_response';
+				return false;
+			}
+
+			// Snatch the IP and port information, or die horribly trying...
+			if (preg_match('~\((\d+),\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))\)~', $response, $match) == 0)
+			{
+				$this->error = 'bad_response';
+				return false;
+			}
+
+			// This is pretty simple - store it for later use ;).
+			$this->pasv = array('ip' => $match[1] . '.' . $match[2] . '.' . $match[3] . '.' . $match[4], 'port' => $match[5] * 256 + $match[6]);
+
+			return true;
+		}
+
+		function create_file($ftp_file)
+		{
+			// First, we have to be connected... very important.
+			if (!is_resource($this->connection))
+				return false;
+
+			// I'd like one passive mode, please!
+			if (!$this->passive())
+				return false;
+
+			// Seems logical enough, so far...
+			fwrite($this->connection, 'STOR ' . $ftp_file . "\r\n");
+
+			// Okay, now we connect to the data port.  If it doesn't work out, it's probably "file already exists", etc.
+			$fp = @fsockopen($this->pasv['ip'], $this->pasv['port'], $err, $err, 5);
+			if (!$fp || !$this->check_response(150))
+			{
+				$this->error = 'bad_file';
+				@fclose($fp);
+				return false;
+			}
+
+			// This may look strange, but we're just closing it to indicate a zero-byte upload.
+			fclose($fp);
+			if (!$this->check_response(226))
+			{
+				$this->error = 'bad_response';
+				return false;
+			}
+
+			return true;
+		}
+
+		function list_dir($ftp_path = '', $search = false)
+		{
+			// Are we even connected...?
+			if (!is_resource($this->connection))
+				return false;
+
+			// Passive... non-agressive...
+			if (!$this->passive())
+				return false;
+
+			// Get the listing!
+			fwrite($this->connection, 'LIST -1' . ($search ? 'R' : '') . ($ftp_path == '' ? '' : ' ' . $ftp_path) . "\r\n");
+
+			// Connect, assuming we've got a connection.
+			$fp = @fsockopen($this->pasv['ip'], $this->pasv['port'], $err, $err, 5);
+			if (!$fp || !$this->check_response(array(150, 125)))
+			{
+				$this->error = 'bad_response';
+				@fclose($fp);
+				return false;
+			}
+
+			// Read in the file listing.
+			$data = '';
+			while (!feof($fp))
+				$data .= fread($fp, 4096);
+			fclose($fp);
+
+			// Everything go okay?
+			if (!$this->check_response(226))
+			{
+				$this->error = 'bad_response';
+				return false;
+			}
+
+			return $data;
+		}
+
+		function locate($file, $listing = null)
+		{
+			if ($listing === null)
+				$listing = $this->list_dir('', true);
+			$listing = explode("\n", $listing);
+
+			@fwrite($this->connection, 'PWD' . "\r\n");
+			$time = time();
+			do
+				$response = fgets($this->connection, 1024);
+			while (substr($response, 3, 1) != ' ' && time() - $time < 5);
+
+			// Check for 257!
+			if (preg_match('~^257 "(.+?)" ~', $response, $match) != 0)
+				$current_dir = strtr($match[1], array('""' => '"'));
+			else
+				$current_dir = '';
+
+			for ($i = 0, $n = count($listing); $i < $n; $i++)
+			{
+				if (trim($listing[$i]) == '' && isset($listing[$i + 1]))
+				{
+					$current_dir = substr(trim($listing[++$i]), 0, -1);
+					$i++;
+				}
+
+				// Okay, this file's name is:
+				$listing[$i] = $current_dir . '/' . trim(strlen($listing[$i]) > 30 ? strrchr($listing[$i], ' ') : $listing[$i]);
+
+				if (substr($file, 0, 1) == '*' && substr($listing[$i], -(strlen($file) - 1)) == substr($file, 1))
+					return $listing[$i];
+				if (substr($file, -1) == '*' && substr($listing[$i], 0, strlen($file) - 1) == substr($file, 0, -1))
+					return $listing[$i];
+				if (basename($listing[$i]) == $file || $listing[$i] == $file)
+					return $listing[$i];
+			}
+
+			return false;
+		}
+
+		function create_dir($ftp_dir)
+		{
+			// We must be connected to the server to do something.
+			if (!is_resource($this->connection))
+				return false;
+
+			// Make this new beautiful directory!
+			fwrite($this->connection, 'MKD ' . $ftp_dir . "\r\n");
+			if (!$this->check_response(257))
+			{
+				$this->error = 'bad_file';
+				return false;
+			}
+
+			return true;
+		}
+
+		function detect_path($filesystem_path, $lookup_file = null)
+		{
+			$username = '';
+
+			if (isset($_SERVER['DOCUMENT_ROOT']))
+			{
+				if (preg_match('~^/home[2]?/([^/]+?)/public_html~', $_SERVER['DOCUMENT_ROOT'], $match))
+				{
+					$username = $match[1];
+
+					$path = strtr($_SERVER['DOCUMENT_ROOT'], array('/home/' . $match[1] . '/' => '', '/home2/' . $match[1] . '/' => ''));
+
+					if (substr($path, -1) == '/')
+						$path = substr($path, 0, -1);
+
+					if (strlen(dirname($_SERVER['PHP_SELF'])) > 1)
+						$path .= dirname($_SERVER['PHP_SELF']);
+				}
+				elseif (substr($filesystem_path, 0, 9) == '/var/www/')
+					$path = substr($filesystem_path, 8);
+				else
+					$path = strtr(strtr($filesystem_path, array('\\' => '/')), array($_SERVER['DOCUMENT_ROOT'] => ''));
+			}
+			else
+				$path = '';
+
+			if (is_resource($this->connection) && $this->list_dir($path) == '')
+			{
+				$data = $this->list_dir('', true);
+
+				if ($lookup_file === null)
+					$lookup_file = $_SERVER['PHP_SELF'];
+
+				$found_path = dirname($this->locate('*' . basename(dirname($lookup_file)) . '/' . basename($lookup_file), $data));
+				if ($found_path == false)
+					$found_path = dirname($this->locate(basename($lookup_file)));
+				if ($found_path != false)
+					$path = $found_path;
+			}
+			elseif (is_resource($this->connection))
+				$found_path = true;
+
+			return array($username, $path, isset($found_path));
+		}
+
+		function close()
+		{
+			// Goodbye!
+			fwrite($this->connection, 'QUIT' . "\r\n");
+			fclose($this->connection);
+
+			return true;
+		}
+	}
+}
+
+// Don't do security check if on Yabbse
+if (!isset($modSettings['smfVersion']))
+	$disable_security = true;
+
+// This only exists if we're on SMF ;)
+if (isset($modSettings['smfVersion']))
+{
+	$request = $smcFunc['db_query']('', '
+		SELECT variable, value
+		FROM {db_prefix}themes
+		WHERE id_theme = {int:id_theme}
+			AND variable IN ({string:theme_url}, {string:theme_dir}, {string:images_url})',
+		array(
+			'id_theme' => 1,
+			'theme_url' => 'theme_url',
+			'theme_dir' => 'theme_dir',
+			'images_url' => 'images_url',
+			'db_error_skip' => true,
+		)
+	);
+	while ($row = $smcFunc['db_fetch_assoc']($request))
+		$modSettings[$row['variable']] = $row['value'];
+	$smcFunc['db_free_result']($request);
+}
+
+if (!isset($modSettings['theme_url']))
+{
+	$modSettings['theme_dir'] = $boarddir . '/Themes/default';
+	$modSettings['theme_url'] = 'Themes/default';
+	$modSettings['images_url'] = 'Themes/default/images';
+}
+if (!isset($settings['default_theme_url']))
+	$settings['default_theme_url'] = $modSettings['theme_url'];
+if (!isset($settings['default_theme_dir']))
+	$settings['default_theme_dir'] = $modSettings['theme_dir'];
+
+$upcontext['is_large_forum'] = (empty($modSettings['smfVersion']) || $modSettings['smfVersion'] <= '1.1 RC1') && !empty($modSettings['totalMessages']) && $modSettings['totalMessages'] > 75000;
+// Default title...
+$upcontext['page_title'] = isset($modSettings['smfVersion']) ? 'Updating Your SMF Install!' : 'Upgrading from YaBB SE!';
+
+$upcontext['right_to_left'] = isset($txt['lang_rtl']) ? $txt['lang_rtl'] : false;
+
+// Have we got tracking data - if so use it (It will be clean!)
+if (isset($_GET['data']))
+{
+	$upcontext['upgrade_status'] = unserialize(base64_decode($_GET['data']));
+	$upcontext['current_step'] = $upcontext['upgrade_status']['curstep'];
+	$upcontext['language'] = $upcontext['upgrade_status']['lang'];
+	$upcontext['rid'] = $upcontext['upgrade_status']['rid'];
+	$is_debug = $upcontext['upgrade_status']['debug'];
+	$support_js = $upcontext['upgrade_status']['js'];
+
+	// Load the language.
+	if (file_exists($modSettings['theme_dir'] . '/languages/Install.' . $upcontext['language'] . '.php'))
+		require_once($modSettings['theme_dir'] . '/languages/Install.' . $upcontext['language'] . '.php');
+}
+// Set the defaults.
+else
+{
+	$upcontext['current_step'] = 0;
+	$upcontext['rid'] = mt_rand(0, 5000);
+	$upcontext['upgrade_status'] = array(
+		'curstep' => 0,
+		'lang' => isset($_GET['lang']) ? $_GET['lang'] : basename($language, '.lng'),
+		'rid' => $upcontext['rid'],
+		'pass' => 0,
+		'debug' => 0,
+		'js' => 0,
+	);
+	$upcontext['language'] = $upcontext['upgrade_status']['lang'];
+
+	// Load the language.
+	if (file_exists($modSettings['theme_dir'] . '/languages/Install.' . $upcontext['language'] . '.php'))
+		require_once($modSettings['theme_dir'] . '/languages/Install.' . $upcontext['language'] . '.php');
+}
+
+// If this isn't the first stage see whether they are logging in and resuming.
+if ($upcontext['current_step'] != 0 || !empty($upcontext['user']['step']))
+	checkLogin();
+
+if ($command_line)
+	cmdStep0();
+
+// Don't error if we're using xml.
+if (isset($_GET['xml']))
+	$upcontext['return_error'] = true;
+
+// These three checks are necessary to workaround an issue with the upgrade stucking when encountering a db error
+if (!isset($context))
+{
+	$context = Array();
+	$context['error'] = '';
+	if (!isset($txt['database_error']))
+		$txt['database_error'] = 'Database Error';
+}
+
+if (!function_exists('allowedTo'))
+{
+	function allowedTo($p,$b)
+	{
+		return true;
+	}
+}
+
+if (!function_exists('fatal_error'))
+{
+	function fatal_error($error,$log)
+	{
+		return ($error);
+	}
+}
+
+// Loop through all the steps doing each one as required.
+$upcontext['overall_percent'] = 0;
+foreach ($upcontext['steps'] as $num => $step)
+{
+	if ($num >= $upcontext['current_step'])
+	{
+		// The current weight of this step in terms of overall progress.
+		$upcontext['step_weight'] = $step[3];
+		// Make sure we reset the skip button.
+		$upcontext['skip'] = false;
+
+		// We cannot proceed if we're not logged in.
+		if ($num != 0 && !$disable_security && $upcontext['user']['pass'] != $upcontext['upgrade_status']['pass'])
+		{
+			$upcontext['steps'][0][2]();
+			break;
+		}
+
+		// Call the step and if it returns false that means pause!
+		if (function_exists($step[2]) && $step[2]() === false)
+			break;
+		elseif (function_exists($step[2]))
+			$upcontext['current_step']++;
+	}
+	$upcontext['overall_percent'] += $step[3];
+}
+
+upgradeExit();
+
+// Exit the upgrade script.
+function upgradeExit($fallThrough = false)
+{
+	global $upcontext, $upgradeurl, $boarddir, $command_line;
+
+	// Save where we are...
+	if (!empty($upcontext['current_step']) && !empty($upcontext['user']['id']))
+	{
+		$upcontext['user']['step'] = $upcontext['current_step'];
+		$upcontext['user']['substep'] = $_GET['substep'];
+		$upcontext['user']['updated'] = time();
+		$upgradeData = base64_encode(serialize($upcontext['user']));
+		copy($boarddir . '/Settings.php', $boarddir . '/Settings_bak.php');
+		changeSettings(array('upgradeData' => '"' . $upgradeData . '"'));
+	}
+
+	// Handle the progress of the step, if any.
+	if (!empty($upcontext['step_progress']) && isset($upcontext['steps'][$upcontext['current_step']]))
+	{
+		$upcontext['step_progress'] = round($upcontext['step_progress'], 1);
+		$upcontext['overall_percent'] += $upcontext['step_progress'] * ($upcontext['steps'][$upcontext['current_step']][3] / 100);
+	}
+	$upcontext['overall_percent'] = (int) $upcontext['overall_percent'];
+
+	// We usually dump our templates out.
+	if (!$fallThrough)
+	{
+		// This should not happen my dear... HELP ME DEVELOPERS!!
+		if (!empty($command_line))
+		{
+			if (function_exists('debug_print_backtrace'))
+				debug_print_backtrace();
+
+			echo "\n" . 'Error: Unexpected call to use the ' . (isset($upcontext['sub_template']) ? $upcontext['sub_template'] : '') . ' template. Please copy and paste all the text above and visit the SMF support forum to tell the Developers that they\'ve made a boo boo; they\'ll get you up and running again.';
+			flush();
+			die();
+		}
+
+		if (!isset($_GET['xml']))
+			template_upgrade_above();
+		else
+		{
+			header('Content-Type: text/xml; charset=ISO-8859-1');
+			// Sadly we need to retain the $_GET data thanks to the old upgrade scripts.
+			$upcontext['get_data'] = array();
+			foreach ($_GET as $k => $v)
+			{
+				if (substr($k, 0, 3) != 'amp' && !in_array($k, array('xml', 'substep', 'lang', 'data', 'step', 'filecount')))
+				{
+					$upcontext['get_data'][$k] = $v;
+				}
+			}
+			template_xml_above();
+		}
+
+		// Call the template.
+		if (isset($upcontext['sub_template']))
+		{
+			$upcontext['upgrade_status']['curstep'] = $upcontext['current_step'];
+			$upcontext['form_url'] = $upgradeurl . '?step=' . $upcontext['current_step'] . '&amp;substep=' . $_GET['substep'] . '&amp;data=' . base64_encode(serialize($upcontext['upgrade_status']));
+
+			// Custom stuff to pass back?
+			if (!empty($upcontext['query_string']))
+				$upcontext['form_url'] .= $upcontext['query_string'];
+
+			call_user_func('template_' . $upcontext['sub_template']);
+		}
+
+		// Was there an error?
+		if (!empty($upcontext['forced_error_message']))
+			echo $upcontext['forced_error_message'];
+
+		// Show the footer.
+		if (!isset($_GET['xml']))
+			template_upgrade_below();
+		else
+			template_xml_below();
+	}
+
+	// Bang - gone!
+	die();
+}
+
+// Used to direct the user to another location.
+function redirectLocation($location, $addForm = true)
+{
+	global $upgradeurl, $upcontext, $command_line;
+
+	// Command line users can't be redirected.
+	if ($command_line)
+		upgradeExit(true);
+
+	// Are we providing the core info?
+	if ($addForm)
+	{
+		$upcontext['upgrade_status']['curstep'] = $upcontext['current_step'];
+		$location = $upgradeurl . '?step=' . $upcontext['current_step'] . '&substep=' . $_GET['substep'] . '&data=' . base64_encode(serialize($upcontext['upgrade_status'])) . $location;
+	}
+
+	while (@ob_end_clean());
+	header('Location: ' . strtr($location, array('&amp;' => '&')));
+
+	// Exit - saving status as we go.
+	upgradeExit(true);
+}
+
+// Load all essential data and connect to the DB as this is pre SSI.php
+function loadEssentialData()
+{
+	global $db_server, $db_user, $db_passwd, $db_name, $db_connection, $db_prefix, $db_character_set, $db_type;
+	global $modSettings, $sourcedir, $smcFunc, $upcontext;
+
+	// Do the non-SSI stuff...
+	if (function_exists('set_magic_quotes_runtime'))
+		@set_magic_quotes_runtime(0);
+
+	// Report all errors except for depreciation notices.
+	error_reporting(E_ALL & ~E_DEPRECATED);
+
+	define('SMF', 1);
+	header('X-Frame-Options: SAMEORIGIN');
+	header('X-XSS-Protection: 1');
+	header('X-Content-Type-Options: nosniff');
+
+	// Start the session.
+	if (@ini_get('session.save_handler') == 'user')
+		@ini_set('session.save_handler', 'files');
+	@session_start();
+
+	if (empty($smcFunc))
+		$smcFunc = array();
+
+	// Check we don't need some compatibility.
+	if (@version_compare(PHP_VERSION, '5') == -1)
+		require_once($sourcedir . '/Subs-Compat.php');
+
+	// Initialize everything...
+	initialize_inputs();
+
+	// Get the database going!
+	if (empty($db_type))
+		$db_type = 'mysql';
+	if (file_exists($sourcedir . '/Subs-Db-' . $db_type . '.php'))
+	{
+		require_once($sourcedir . '/Subs-Db-' . $db_type . '.php');
+
+		// Make the connection...
+		$db_connection = smf_db_initiate($db_server, $db_name, $db_user, $db_passwd, $db_prefix, array('non_fatal' => true));
+
+		// Oh dear god!!
+		if ($db_connection === null)
+		{
+			// Get error info...  Recast just in case we get false or 0...
+			$error_message = $smcFunc['db_connect_error']();
+			if (empty($error_message))
+				$error_message = '';
+			$error_number = $smcFunc['db_connect_errno']();
+			if (empty($error_number))
+				$error_number = '';
+			$db_error = (!empty($error_number) ? $error_number . ': ' : '') . $error_message;
+
+			die('Unable to connect to database - please check username and password are correct in Settings.php<br><br>' . $db_error);
+		}
+
+		if ($db_type == 'mysql' && isset($db_character_set) && preg_match('~^\w+$~', $db_character_set) === 1)
+			$smcFunc['db_query']('', '
+			SET NAMES ' . $db_character_set,
+			array(
+				'db_error_skip' => true,
+			)
+		);
+
+		// Protect old versions of SMF from new versions of MySQL...
+		$request = $smcFunc['db_query']('', '
+			SET SESSION sql_mode = \'\'',
+			array()
+		);
+
+		// Load the modSettings data...
+		$request = $smcFunc['db_query']('', '
+			SELECT variable, value
+			FROM {db_prefix}settings',
+			array(
+				'db_error_skip' => true,
+			)
+		);
+		$modSettings = array();
+		while ($row = $smcFunc['db_fetch_assoc']($request))
+			$modSettings[$row['variable']] = $row['value'];
+		$smcFunc['db_free_result']($request);
+	}
+	else
+	{
+		return throw_error('Cannot find ' . $sourcedir . '/Subs-Db-' . $db_type . '.php' . '. Please check you have uploaded all source files and have the correct paths set.');
+	}
+
+	// If they don't have the file, they're going to get a warning anyway so we won't need to clean request vars.
+	if (file_exists($sourcedir . '/QueryString.php'))
+	{
+		require_once($sourcedir . '/QueryString.php');
+		cleanRequest();
+	}
+
+	if (!isset($_GET['substep']))
+		$_GET['substep'] = 0;
+}
+
+function initialize_inputs()
+{
+	global $sourcedir, $start_time, $upcontext, $db_type;
+
+	$start_time = time();
+
+	umask(0);
+
+	// Fun.  Low PHP version...
+	if (!isset($_GET))
+	{
+		$GLOBALS['_GET']['step'] = 0;
+		return;
+	}
+
+	ob_start();
+
+	// Better to upgrade cleanly and fall apart than to screw everything up if things take too long.
+	ignore_user_abort(true);
+
+	// This is really quite simple; if ?delete is on the URL, delete the upgrader...
+	if (isset($_GET['delete']))
+	{
+		@unlink(__FILE__);
+
+		// And the extra little files ;).
+		@unlink(dirname(__FILE__) . '/upgrade_1-0.sql');
+		@unlink(dirname(__FILE__) . '/upgrade_1-1.sql');
+		@unlink(dirname(__FILE__) . '/webinstall.php');
+
+		$dh = opendir(dirname(__FILE__));
+		while ($file = readdir($dh))
+		{
+			if (preg_match('~upgrade_\d-\d_([A-Za-z])+\.sql~i', $file, $matches) && isset($matches[1]))
+				@unlink(dirname(__FILE__) . '/' . $file);
+		}
+		closedir($dh);
+
+		header('Location: http://' . (isset($_SERVER['HTTP_HOST']) ? $_SERVER['HTTP_HOST'] : $_SERVER['SERVER_NAME'] . ':' . $_SERVER['SERVER_PORT']) . dirname($_SERVER['PHP_SELF']) . '/Themes/default/images/blank.gif');
+		exit;
+	}
+
+	// Are we calling the backup css file?
+	if (isset($_GET['infile_css']))
+	{
+		header('Content-Type: text/css');
+		template_css();
+		exit;
+	}
+
+	// Anybody home?
+	if (!isset($_GET['xml']))
+	{
+		$upcontext['remote_files_available'] = false;
+		$test = @fsockopen('www.simplemachines.org', 80, $errno, $errstr, 1);
+		if ($test)
+			$upcontext['remote_files_available'] = true;
+		@fclose($test);
+	}
+
+	// Something is causing this to happen, and it's annoying.  Stop it.
+	$temp = 'upgrade_php?step';
+	while (strlen($temp) > 4)
+	{
+		if (isset($_GET[$temp]))
+			unset($_GET[$temp]);
+		$temp = substr($temp, 1);
+	}
+
+	// Force a step, defaulting to 0.
+	$_GET['step'] = (int) @$_GET['step'];
+	$_GET['substep'] = (int) @$_GET['substep'];
+}
+
+// Step 0 - Let's welcome them in and ask them to login!
+function WelcomeLogin()
+{
+	global $boarddir, $sourcedir, $db_prefix, $language, $modSettings, $cachedir, $upgradeurl, $upcontext, $disable_security;
+	global $smcFunc, $db_type, $databases, $txt;
+
+	$upcontext['sub_template'] = 'welcome_message';
+
+	// Check for some key files - one template, one language, and a new and an old source file.
+	$check = @file_exists($modSettings['theme_dir'] . '/index.template.php')
+		&& @file_exists($sourcedir . '/QueryString.php')
+		&& @file_exists($sourcedir . '/Subs-Db-' . $db_type . '.php')
+		&& @file_exists(dirname(__FILE__) . '/upgrade_2-0_' . $db_type . '.sql');
+
+	// Need legacy scripts?
+	if (!isset($modSettings['smfVersion']) || $modSettings['smfVersion'] < 2.0)
+		$check &= @file_exists(dirname(__FILE__) . '/upgrade_1-1.sql');
+	if (!isset($modSettings['smfVersion']) || $modSettings['smfVersion'] < 1.1)
+		$check &= @file_exists(dirname(__FILE__) . '/upgrade_1-0.sql');
+
+	if (!$check)
+		// Don't tell them what files exactly because it's a spot check - just like teachers don't tell which problems they are spot checking, that's dumb.
+		return throw_error('The upgrader was unable to find some crucial files.<br /><br />Please make sure you uploaded all of the files included in the package, including the Themes, Sources, and other directories.');
+
+	// Do they meet the install requirements?
+	if (!php_version_check())
+		return throw_error('Warning!  You do not appear to have a version of PHP installed on your webserver that meets SMF\'s minimum installations requirements.<br /><br />Please ask your host to upgrade.');
+
+	if (!db_version_check())
+		return throw_error('Your ' . $databases[$db_type]['name'] . ' version does not meet the minimum requirements of SMF.<br /><br />Please ask your host to upgrade.');
+
+	// Do they have ALTER privileges?
+	if (!empty($databases[$db_type]['alter_support']) && $smcFunc['db_query']('alter_boards', 'ALTER TABLE {db_prefix}boards ORDER BY id_board', array()) === false)
+		return throw_error('The ' . $databases[$db_type]['name'] . ' user you have set in Settings.php does not have proper privileges.<br /><br />Please ask your host to give this user the ALTER, CREATE, and DROP privileges.');
+
+	// Do a quick version spot check.
+	$temp = substr(@implode('', @file($boarddir . '/index.php')), 0, 4096);
+	preg_match('~\*\s@version\s+([^\r\n]+)~i', $temp, $match);
+	if (empty($match[1]) || (trim($match[1]) != SMF_VERSION))
+		return throw_error('The upgrader found some old or outdated files.<br /><br />Please make certain you uploaded the new versions of all the files included in the package.');
+
+	// What absolutely needs to be writable?
+	$writable_files = array(
+		$boarddir . '/Settings.php',
+		$boarddir . '/Settings_bak.php',
+	);
+
+	// Check the cache directory.
+	$cachedir_temp = empty($cachedir) ? $boarddir . '/cache' : $cachedir;
+	if (!file_exists($cachedir_temp))
+		@mkdir($cachedir_temp);
+	if (!file_exists($cachedir_temp))
+		return throw_error('The cache directory could not be found.<br /><br />Please make sure you have a directory called &quot;cache&quot; in your forum directory before continuing.');
+
+	if (!file_exists($modSettings['theme_dir'] . '/languages/index.' . $upcontext['language'] . '.php') && !isset($modSettings['smfVersion']) && !isset($_GET['lang']))
+		return throw_error('The upgrader was unable to find language files for the language specified in Settings.php.<br />SMF will not work without the primary language files installed.<br /><br />Please either install them, or <a href="' . $upgradeurl . '?step=0;lang=english">use english instead</a>.');
+	elseif (!isset($_GET['skiplang']))
+	{
+		$temp = substr(@implode('', @file($modSettings['theme_dir'] . '/languages/index.' . $upcontext['language'] . '.php')), 0, 4096);
+		preg_match('~(?://|/\*)\s*Version:\s+(.+?);\s*index(?:[\s]{2}|\*/)~i', $temp, $match);
+
+		if (empty($match[1]) || $match[1] != SMF_LANG_VERSION)
+			return throw_error('The upgrader found some old or outdated language files, for the forum default language, ' . $upcontext['language'] . '.<br /><br />Please make certain you uploaded the new versions of all the files included in the package, even the theme and language files for the default theme.<br />&nbsp;&nbsp;&nbsp;[<a href="' . $upgradeurl . '?skiplang">SKIP</a>] [<a href="' . $upgradeurl . '?lang=english">Try English</a>]');
+	}
+
+	// This needs to exist!
+	if (!file_exists($modSettings['theme_dir'] . '/languages/Install.' . $upcontext['language'] . '.php'))
+		return throw_error('The upgrader could not find the &quot;Install&quot; language file for the forum default language, ' . $upcontext['language'] . '.<br /><br />Please make certain you uploaded all the files included in the package, even the theme and language files for the default theme.<br />&nbsp;&nbsp;&nbsp;[<a href="' . $upgradeurl . '?lang=english">Try English</a>]');
+	else
+		require_once($modSettings['theme_dir'] . '/languages/Install.' . $upcontext['language'] . '.php');
+
+	if (!makeFilesWritable($writable_files))
+		return false;
+
+	// Check agreement.txt. (it may not exist, in which case $boarddir must be writable.)
+	if (isset($modSettings['agreement']) && (!is_writable($boarddir) || file_exists($boarddir . '/agreement.txt')) && !is_writable($boarddir . '/agreement.txt'))
+		return throw_error('The upgrader was unable to obtain write access to agreement.txt.<br /><br />If you are using a linux or unix based server, please ensure that the file is chmod\'d to 777, or if it does not exist that the directory this upgrader is in is 777.<br />If your server is running Windows, please ensure that the internet guest account has the proper permissions on it or its folder.');
+
+	// Upgrade the agreement.
+	elseif (isset($modSettings['agreement']))
+	{
+		$fp = fopen($boarddir . '/agreement.txt', 'w');
+		fwrite($fp, $modSettings['agreement']);
+		fclose($fp);
+	}
+
+	// We're going to check that their board dir setting is right incase they've been moving stuff around.
+	if (strtr($boarddir, array('/' => '', '\\' => '')) != strtr(dirname(__FILE__), array('/' => '', '\\' => '')))
+		$upcontext['warning'] = '
+			It looks as if your board directory settings <em>might</em> be incorrect. Your board directory is currently set to &quot;' . $boarddir . '&quot; but should probably be &quot;' . dirname(__FILE__) . '&quot;. Settings.php currently lists your paths as:<br />
+			<ul>
+				<li>Board Directory: ' . $boarddir . '</li>
+				<li>Source Directory: ' . $boarddir . '</li>
+				<li>Cache Directory: ' . $cachedir_temp . '</li>
+			</ul>
+			If these seem incorrect please open Settings.php in a text editor before proceeding with this upgrade. If they are incorrect due to you moving your forum to a new location please download and execute the <a href="https://download.simplemachines.org/?tools">Repair Settings</a> tool from the Simple Machines website before continuing.';
+
+	// Either we're logged in or we're going to present the login.
+	if (checkLogin())
+		return true;
+
+	return false;
+}
+
+// Step 0.5: Does the login work?
+function checkLogin()
+{
+	global $boarddir, $sourcedir, $db_prefix, $language, $modSettings, $cachedir, $upgradeurl, $upcontext, $disable_security;
+	global $smcFunc, $db_type, $databases, $support_js, $txt;
+
+	// Are we trying to login?
+	if (isset($_POST['contbutt']) && (!empty($_POST['user']) || $disable_security))
+	{
+		// If we've disabled security pick a suitable name!
+		if (empty($_POST['user']))
+			$_POST['user'] = 'Administrator';
+
+		// Before 2.0 these column names were different!
+		$oldDB = false;
+		if (empty($db_type) || $db_type == 'mysql')
+		{
+			$request = $smcFunc['db_query']('', '
+				SHOW COLUMNS
+				FROM {db_prefix}members
+				LIKE {string:member_name}',
+				array(
+					'member_name' => 'memberName',
+					'db_error_skip' => true,
+				)
+			);
+			if ($smcFunc['db_num_rows']($request) != 0)
+				$oldDB = true;
+			$smcFunc['db_free_result']($request);
+		}
+
+		// Get what we believe to be their details.
+		if (!$disable_security)
+		{
+			if ($oldDB)
+				$request = $smcFunc['db_query']('', '
+					SELECT id_member, memberName AS member_name, passwd, id_group,
+					additionalGroups AS additional_groups, lngfile
+					FROM {db_prefix}members
+					WHERE memberName = {string:member_name}',
+					array(
+						'member_name' => $_POST['user'],
+						'db_error_skip' => true,
+					)
+				);
+			else
+				$request = $smcFunc['db_query']('', '
+					SELECT id_member, member_name, passwd, id_group, additional_groups, lngfile
+					FROM {db_prefix}members
+					WHERE member_name = {string:member_name}',
+					array(
+						'member_name' => $_POST['user'],
+						'db_error_skip' => true,
+					)
+				);
+			if ($smcFunc['db_num_rows']($request) != 0)
+			{
+				list ($id_member, $name, $password, $id_group, $addGroups, $user_language) = $smcFunc['db_fetch_row']($request);
+
+				$groups = explode(',', $addGroups);
+				$groups[] = $id_group;
+
+				foreach ($groups as $k => $v)
+					$groups[$k] = (int) $v;
+
+				// Figure out the password using SMF's encryption - if what they typed is right.
+				if (isset($_REQUEST['hash_passwrd']) && strlen($_REQUEST['hash_passwrd']) == 40)
+				{
+					// Challenge passed.
+					if ($_REQUEST['hash_passwrd'] == sha1($password . $upcontext['rid']))
+						$sha_passwd = $password;
+				}
+				else
+					$sha_passwd = sha1(strtolower($name) . un_htmlspecialchars($_REQUEST['passwrd']));
+			}
+			else
+				$upcontext['username_incorrect'] = true;
+			$smcFunc['db_free_result']($request);
+		}
+		$upcontext['username'] = $_POST['user'];
+
+		// Track whether javascript works!
+		if (isset($_POST['js_works']))
+		{
+			if (!empty($_POST['js_works']))
+			{
+				$upcontext['upgrade_status']['js'] = 1;
+				$support_js = 1;
+			}
+			else
+				$support_js = 0;
+		}
+
+		// Note down the version we are coming from.
+		if (!empty($modSettings['smfVersion']) && empty($upcontext['user']['version']))
+			$upcontext['user']['version'] = $modSettings['smfVersion'];
+
+		// Didn't get anywhere?
+		if ((empty($sha_passwd) || $password != $sha_passwd) && empty($upcontext['username_incorrect']) && !$disable_security)
+		{
+			// MD5?
+			$md5pass = md5_hmac($_REQUEST['passwrd'], strtolower($_POST['user']));
+			if ($md5pass != $password)
+			{
+				$upcontext['password_failed'] = true;
+				// Disable the hashing this time.
+				$upcontext['disable_login_hashing'] = true;
+			}
+		}
+
+		if ((empty($upcontext['password_failed']) && !empty($name)) || $disable_security)
+		{
+			// Set the password.
+			if (!$disable_security)
+			{
+				// Do we actually have permission?
+				if (!in_array(1, $groups))
+				{
+					$request = $smcFunc['db_query']('', '
+						SELECT permission
+						FROM {db_prefix}permissions
+						WHERE id_group IN ({array_int:groups})
+							AND permission = {string:admin_forum}',
+						array(
+							'groups' => $groups,
+							'admin_forum' => 'admin_forum',
+							'db_error_skip' => true,
+						)
+					);
+					if ($smcFunc['db_num_rows']($request) == 0)
+						return throw_error('You need to be an admin to perform an upgrade!');
+					$smcFunc['db_free_result']($request);
+				}
+
+				$upcontext['user']['id'] = $id_member;
+				$upcontext['user']['name'] = $name;
+			}
+			else
+			{
+				$upcontext['user']['id'] = 1;
+				$upcontext['user']['name'] = 'Administrator';
+			}
+			$upcontext['user']['pass'] = mt_rand(0,60000);
+			// This basically is used to match the GET variables to Settings.php.
+			$upcontext['upgrade_status']['pass'] = $upcontext['user']['pass'];
+
+			// Set the language to that of the user?
+			if (isset($user_language) && $user_language != $upcontext['language'] && file_exists($modSettings['theme_dir'] . '/languages/index.' . basename($user_language, '.lng') . '.php'))
+			{
+				$user_language = basename($user_language, '.lng');
+				$temp = substr(@implode('', @file($modSettings['theme_dir'] . '/languages/index.' . $user_language . '.php')), 0, 4096);
+				preg_match('~(?://|/\*)\s*Version:\s+(.+?);\s*index(?:[\s]{2}|\*/)~i', $temp, $match);
+
+				if (empty($match[1]) || $match[1] != SMF_LANG_VERSION)
+					$upcontext['upgrade_options_warning'] = 'The language files for your selected language, ' . $user_language . ', have not been updated to the latest version. Upgrade will continue with the forum default, ' . $upcontext['language'] . '.';
+				elseif (!file_exists($modSettings['theme_dir'] . '/languages/Install.' . basename($user_language, '.lng') . '.php'))
+					$upcontext['upgrade_options_warning'] = 'The language files for your selected language, ' . $user_language . ', have not been uploaded/updated as the &quot;Install&quot; language file is missing. Upgrade will continue with the forum default, ' . $upcontext['language'] . '.';
+				else
+				{
+					// Set this as the new language.
+					$upcontext['language'] = $user_language;
+					$upcontext['upgrade_status']['lang'] = $upcontext['language'];
+
+					// Include the file.
+					require_once($modSettings['theme_dir'] . '/languages/Install.' . $user_language . '.php');
+				}
+			}
+
+			// If we're resuming set the step and substep to be correct.
+			if (isset($_POST['cont']))
+			{
+				$upcontext['current_step'] = $upcontext['user']['step'];
+				$_GET['substep'] = $upcontext['user']['substep'];
+			}
+
+			return true;
+		}
+	}
+
+	return false;
+}
+
+// Step 1: Do the maintenance and backup.
+function UpgradeOptions()
+{
+	global $db_prefix, $command_line, $modSettings, $is_debug, $smcFunc;
+	global $boarddir, $boardurl, $sourcedir, $maintenance, $mmessage, $cachedir, $upcontext, $db_type;
+
+	$upcontext['sub_template'] = 'upgrade_options';
+	$upcontext['page_title'] = 'Upgrade Options';
+
+	// If we've not submitted then we're done.
+	if (empty($_POST['upcont']))
+		return false;
+
+	// Firstly, if they're enabling SM stat collection just do it.
+	if (!empty($_POST['stats']) && substr($boardurl, 0, 16) != 'http://localhost' && empty($modSettings['allow_sm_stats']) && empty($modSettings['enable_sm_stats']))
+	{
+		$upcontext['allow_sm_stats'] = true;
+
+		// Don't register if we still have a key.
+		if (empty($modSettings['sm_stats_key']))
+		{
+			// Attempt to register the site etc.
+			$fp = @fsockopen('www.simplemachines.org', 80, $errno, $errstr);
+			if ($fp)
+			{
+				$out = 'GET /smf/stats/register_stats.php?site=' . base64_encode($boardurl) . ' HTTP/1.1' . "\r\n";
+				$out .= 'Host: www.simplemachines.org' . "\r\n";
+				$out .= 'Connection: Close' . "\r\n\r\n";
+				fwrite($fp, $out);
+
+				$return_data = '';
+				while (!feof($fp))
+					$return_data .= fgets($fp, 128);
+
+				fclose($fp);
+
+				// Get the unique site ID.
+				preg_match('~SITE-ID:\s(\w{10})~', $return_data, $ID);
+
+				if (!empty($ID[1]))
+					$smcFunc['db_insert']('replace',
+						$db_prefix . 'settings',
+						array('variable' => 'string', 'value' => 'string'),
+						array(
+							array('sm_stats_key', $ID[1]),
+							array('enable_sm_stats', 1),
+						),
+						array('variable')
+					);
+			}
+		}
+		else
+		{
+			$smcFunc['db_insert']('replace',
+				$db_prefix . 'settings',
+				array('variable' => 'string', 'value' => 'string'),
+				array('enable_sm_stats', 1),
+				array('variable')
+			);
+		}
+	}
+	// Don't remove stat collection unless we unchecked the box for real, not from the loop.
+	elseif (empty($_POST['stats']) && empty($upcontext['allow_sm_stats']))
+		$smcFunc['db_query']('', '
+			DELETE FROM {db_prefix}settings
+			WHERE variable = {string:enable_sm_stats}',
+			array(
+				'enable_sm_stats' => 'enable_sm_stats',
+				'db_error_skip' => true,
+			)
+		);
+
+	// Emptying the error log?
+	if (!empty($_POST['empty_error']))
+		$smcFunc['db_query']('truncate_table', '
+			TRUNCATE {db_prefix}log_errors',
+			array(
+			)
+		);
+
+	$changes = array();
+
+	// If we're overriding the language follow it through.
+	if (isset($_GET['lang']) && file_exists($modSettings['theme_dir'] . '/languages/index.' . $_GET['lang'] . '.php'))
+		$changes['language'] = '\'' . $_GET['lang'] . '\'';
+
+	if (!empty($_POST['maint']))
+	{
+		$changes['maintenance'] = '2';
+		// Remember what it was...
+		$upcontext['user']['main'] = $maintenance;
+
+		if (!empty($_POST['maintitle']))
+		{
+			$changes['mtitle'] = '\'' . addslashes($_POST['maintitle']) . '\'';
+			$changes['mmessage'] = '\'' . addslashes($_POST['mainmessage']) . '\'';
+		}
+		else
+		{
+			$changes['mtitle'] = '\'Upgrading the forum...\'';
+			$changes['mmessage'] = '\'Don\\\'t worry, we will be back shortly with an updated forum.  It will only be a minute ;).\'';
+		}
+	}
+
+	if ($command_line)
+		echo ' * Updating Settings.php...';
+
+	// Backup the current one first.
+	copy($boarddir . '/Settings.php', $boarddir . '/Settings_bak.php');
+
+	// Add proxy settings.
+	if (!isset($GLOBALS['image_proxy_maxsize']))
+		$changes += array(
+			'image_proxy_secret' => '\'' . substr(sha1(mt_rand()), 0, 20) . '\'',
+			'image_proxy_maxsize' => 5190,
+			'image_proxy_enabled' => 0,
+		);
+
+	// Fix some old paths.
+	if (substr($boarddir, 0, 1) == '.')
+		$changes['boarddir'] = '\'' . fixRelativePath($boarddir) . '\'';
+
+	if (substr($sourcedir, 0, 1) == '.')
+		$changes['sourcedir'] = '\'' . fixRelativePath($sourcedir) . '\'';
+
+	if (empty($cachedir) || substr($cachedir, 0, 1) == '.')
+		$changes['cachedir'] = '\'' . fixRelativePath($boarddir) . '/cache\'';
+
+	// Not had the database type added before?
+	if (empty($db_type))
+		$changes['db_type'] = 'mysql';
+
+	// !!! Maybe change the cookie name if going to 1.1, too?
+
+	// Update Settings.php with the new settings.
+	changeSettings($changes);
+
+	if ($command_line)
+		echo ' Successful.' . "\n";
+
+	// Are we doing debug?
+	if (isset($_POST['debug']))
+	{
+		$upcontext['upgrade_status']['debug'] = true;
+		$is_debug = true;
+	}
+
+	// If we're not backing up then jump one.
+	if (empty($_POST['backup']))
+		$upcontext['current_step']++;
+
+	// If we've got here then let's proceed to the next step!
+	return true;
+}
+
+// Backup the database - why not...
+function BackupDatabase()
+{
+	global $upcontext, $db_prefix, $command_line, $is_debug, $support_js, $file_steps, $smcFunc;
+
+	$upcontext['sub_template'] = isset($_GET['xml']) ? 'backup_xml' : 'backup_database';
+	$upcontext['page_title'] = 'Backup Database';
+
+	// Done it already - js wise?
+	if (!empty($_POST['backup_done']))
+		return true;
+
+	// Some useful stuff here.
+	db_extend();
+
+	// Get all the table names.
+	$filter = str_replace('_', '\_', preg_match('~^`(.+?)`\.(.+?)$~', $db_prefix, $match) != 0 ? $match[2] : $db_prefix) . '%';
+	$db = preg_match('~^`(.+?)`\.(.+?)$~', $db_prefix, $match) != 0 ? strtr($match[1], array('`' => '')) : false;
+	$tables = $smcFunc['db_list_tables']($db, $filter);
+
+	$table_names = array();
+	foreach ($tables as $table)
+		if (substr($table, 0, 7) !== 'backup_')
+			$table_names[] = $table;
+
+	$upcontext['table_count'] = count($table_names);
+	$upcontext['cur_table_num'] = $_GET['substep'];
+	$upcontext['cur_table_name'] = str_replace($db_prefix, '', isset($table_names[$_GET['substep']]) ? $table_names[$_GET['substep']] : $table_names[0]);
+	$upcontext['step_progress'] = (int) (($upcontext['cur_table_num'] / $upcontext['table_count']) * 100);
+	// For non-java auto submit...
+	$file_steps = $upcontext['table_count'];
+
+	// What ones have we already done?
+	foreach ($table_names as $id => $table)
+		if ($id < $_GET['substep'])
+			$upcontext['previous_tables'][] = $table;
+
+	if ($command_line)
+		echo 'Backing Up Tables.';
+
+	// If we don't support javascript we backup here.
+	if (!$support_js || isset($_GET['xml']))
+	{
+		// Backup each table!
+		for ($substep = $_GET['substep'], $n = count($table_names); $substep < $n; $substep++)
+		{
+			$upcontext['cur_table_name'] = str_replace($db_prefix, '', (isset($table_names[$substep + 1]) ? $table_names[$substep + 1] : $table_names[$substep]));
+			$upcontext['cur_table_num'] = $substep + 1;
+
+			$upcontext['step_progress'] = (int) (($upcontext['cur_table_num'] / $upcontext['table_count']) * 100);
+
+			// Do we need to pause?
+			nextSubstep($substep);
+
+			backupTable($table_names[$substep]);
+
+			// If this is XML to keep it nice for the user do one table at a time anyway!
+			if (isset($_GET['xml']))
+				return upgradeExit();
+		}
+
+		if ($is_debug && $command_line)
+		{
+			echo "\n" . ' Successful.\'' . "\n";
+			flush();
+		}
+		$upcontext['step_progress'] = 100;
+
+		$_GET['substep'] = 0;
+		// Make sure we move on!
+		return true;
+	}
+
+	// Either way next place to post will be database changes!
+	$_GET['substep'] = 0;
+	return false;
+}
+
+// Backup one table...
+function backupTable($table)
+{
+	global $is_debug, $command_line, $db_prefix, $smcFunc;
+
+	if ($is_debug && $command_line)
+	{
+		echo "\n" . ' +++ Backing up \"' . str_replace($db_prefix, '', $table) . '"...';
+		flush();
+	}
+
+	$smcFunc['db_backup_table']($table, 'backup_' . $table);
+
+	if ($is_debug && $command_line)
+		echo ' done.';
+}
+
+// Step 2: Everything.
+function DatabaseChanges()
+{
+	global $db_prefix, $modSettings, $command_line, $smcFunc;
+	global $language, $boardurl, $sourcedir, $boarddir, $upcontext, $support_js, $db_type;
+
+	// Have we just completed this?
+	if (!empty($_POST['database_done']))
+		return true;
+
+	$upcontext['sub_template'] = isset($_GET['xml']) ? 'database_xml' : 'database_changes';
+	$upcontext['page_title'] = 'Database Changes';
+
+	// All possible files.
+	// Name, <version, insert_on_complete
+	$files = array(
+		array('upgrade_1-0.sql', '1.1', '1.1 RC0'),
+		array('upgrade_1-1.sql', '2.0', '2.0 a'),
+		array('upgrade_2-0_' . $db_type . '.sql', '3.0', SMF_VERSION),
+	);
+
+	// How many files are there in total?
+	if (isset($_GET['filecount']))
+		$upcontext['file_count'] = (int) $_GET['filecount'];
+	else
+	{
+		$upcontext['file_count'] = 0;
+		foreach ($files as $file)
+		{
+			if (!isset($modSettings['smfVersion']) || $modSettings['smfVersion'] < $file[1])
+				$upcontext['file_count']++;
+		}
+	}
+
+	// Do each file!
+	$did_not_do = count($files) - $upcontext['file_count'];
+	$upcontext['step_progress'] = 0;
+	$upcontext['cur_file_num'] = 0;
+	foreach ($files as $file)
+	{
+		if ($did_not_do)
+			$did_not_do--;
+		else
+		{
+			$upcontext['cur_file_num']++;
+			$upcontext['cur_file_name'] = $file[0];
+			// Do we actually need to do this still?
+			if (!isset($modSettings['smfVersion']) || $modSettings['smfVersion'] < $file[1])
+			{
+				// Reload modSettings to capture any adds/updates made along the way
+				$request = $smcFunc['db_query']('', '
+					SELECT variable, value
+					FROM {db_prefix}settings',
+					array(
+						'db_error_skip' => true,
+					)
+				);
+				$modSettings = array();
+				while ($row = $smcFunc['db_fetch_assoc']($request))
+					$modSettings[$row['variable']] = $row['value'];
+				$smcFunc['db_free_result']($request);
+
+				// Some theme settings are in $modSettings
+				// Note we still might be doing yabbse (no smf ver)
+				if (isset($modSettings['smfVersion']))
+				{
+					$request = $smcFunc['db_query']('', '
+						SELECT variable, value
+						FROM {db_prefix}themes
+						WHERE id_theme = {int:id_theme}
+							AND variable IN ({string:theme_url}, {string:theme_dir}, {string:images_url})',
+						array(
+							'id_theme' => 1,
+							'theme_url' => 'theme_url',
+							'theme_dir' => 'theme_dir',
+							'images_url' => 'images_url',
+							'db_error_skip' => true,
+						)
+					);
+					while ($row = $smcFunc['db_fetch_assoc']($request))
+						$modSettings[$row['variable']] = $row['value'];
+					$smcFunc['db_free_result']($request);
+				}
+
+				if (!isset($modSettings['theme_url']))
+				{
+					$modSettings['theme_dir'] = $boarddir . '/Themes/default';
+					$modSettings['theme_url'] = 'Themes/default';
+					$modSettings['images_url'] = 'Themes/default/images';
+				}
+
+				// Now process the file...
+				$nextFile = parse_sql(dirname(__FILE__) . '/' . $file[0]);
+				if ($nextFile)
+				{
+					// Only update the version of this if complete.
+					$smcFunc['db_insert']('replace',
+						$db_prefix . 'settings',
+						array('variable' => 'string', 'value' => 'string'),
+						array('smfVersion', $file[2]),
+						array('variable')
+					);
+
+					$modSettings['smfVersion'] = $file[2];
+				}
+
+				// If this is XML we only do this stuff once.
+				if (isset($_GET['xml']))
+				{
+					// Flag to move on to the next.
+					$upcontext['completed_step'] = true;
+					// Did we complete the whole file?
+					if ($nextFile)
+						$upcontext['current_debug_item_num'] = -1;
+					return upgradeExit();
+				}
+				elseif ($support_js)
+					break;
+			}
+			// Set the progress bar to be right as if we had - even if we hadn't...
+			$upcontext['step_progress'] = ($upcontext['cur_file_num'] / $upcontext['file_count']) * 100;
+		}
+	}
+
+	$_GET['substep'] = 0;
+	// So the template knows we're done.
+	if (!$support_js)
+	{
+		$upcontext['changes_complete'] = true;
+
+		// If this is the command line we can't do any more.
+		if ($command_line)
+			return DeleteUpgrade();
+
+		return true;
+	}
+	return false;
+}
+
+// Clean up any mods installed...
+function CleanupMods()
+{
+	global $db_prefix, $modSettings, $upcontext, $boarddir, $sourcedir, $settings, $smcFunc, $command_line;
+
+	// Sorry. Not supported for command line users.
+	if ($command_line)
+		return true;
+
+	// Skipping first?
+	if (!empty($_POST['skip']))
+	{
+		unset($_POST['skip']);
+		return true;
+	}
+
+	// If we get here withOUT SSI we need to redirect to ensure we get it!
+	if (!isset($_GET['ssi']) || !function_exists('mktree'))
+		redirectLocation('&ssi=1');
+
+	$upcontext['sub_template'] = 'clean_mods';
+	$upcontext['page_title'] = 'Cleanup Modifications';
+
+	// This can be skipped.
+	$upcontext['skip'] = true;
+
+	// If we're on the second redirect continue...
+	if (isset($_POST['cleandone2']))
+		return true;
+
+	// Do we already know about some writable files?
+	if (isset($_POST['writable_files']))
+	{
+		$writable_files = unserialize(base64_decode($_POST['writable_files']));
+		if (!makeFilesWritable($writable_files))
+		{
+			// What have we left?
+			$upcontext['writable_files'] = $writable_files;
+			return false;
+		}
+	}
+
+	// Load all theme paths....
+	$request = $smcFunc['db_query']('', '
+		SELECT id_theme, variable, value
+		FROM {db_prefix}themes
+		WHERE id_member = {int:id_member}
+			AND variable IN ({string:theme_dir}, {string:images_url})',
+		array(
+			'id_member' => 0,
+			'theme_dir' => 'theme_dir',
+			'images_url' => 'images_url',
+			'db_error_skip' => true,
+		)
+	);
+	$theme_paths = array();
+	while ($row = $smcFunc['db_fetch_assoc']($request))
+	{
+		if ($row['id_theme'] == 1)
+			$settings['default_' . $row['variable']] = $row['value'];
+		elseif ($row['variable'] == 'theme_dir')
+			$theme_paths[$row['id_theme']][$row['variable']] = $row['value'];
+	}
+	$smcFunc['db_free_result']($request);
+
+	// Are there are mods installed that may need uninstalling?
+	$request = $smcFunc['db_query']('', '
+		SELECT id_install, filename, name, themes_installed, version
+		FROM {db_prefix}log_packages
+		WHERE install_state = {int:installed}
+		ORDER BY time_installed DESC',
+		array(
+			'installed' => 1,
+			'db_error_skip' => true,
+		)
+	);
+	$upcontext['packages'] = array();
+	while ($row = $smcFunc['db_fetch_assoc']($request))
+	{
+		// Work out the status.
+		if (!file_exists($boarddir . '/Packages/' . $row['filename']))
+		{
+			$status = 'Missing';
+			$status_color = 'red';
+			$result = 'Removed';
+		}
+		else
+		{
+			$status = 'Installed';
+			$status_color = 'green';
+			$result = 'No Action Needed';
+		}
+
+		$upcontext['packages'][$row['id_install']] = array(
+			'id' => $row['id_install'],
+			'themes' => explode(',', $row['themes_installed']),
+			'name' => $row['name'],
+			'filename' => $row['filename'],
+			'missing_file' => file_exists($boarddir . '/Packages/' . $row['filename']) ? 0 : 1,
+			'files' => array(),
+			'file_count' => 0,
+			'status' => $status,
+			'result' => $result,
+			'color' => $status_color,
+			'version' => $row['version'],
+			'needs_removing' => false,
+		);
+	}
+	$smcFunc['db_free_result']($request);
+
+	// Don't carry on if there are none.
+	if (empty($upcontext['packages']))
+		return true;
+
+	// Setup some basics.
+	if (!empty($upcontext['user']['version']))
+		$_SESSION['version_emulate'] = $upcontext['user']['version'];
+
+	// Before we get started, don't report notice errors.
+	$oldErrorReporting = error_reporting(E_ALL ^ E_NOTICE);
+
+	if (!mktree($boarddir . '/Packages/temp', 0755))
+	{
+		deltree($boarddir . '/Packages/temp', false);
+		if (!mktree($boarddir . '/Packages/temp', 0777))
+		{
+			deltree($boarddir . '/Packages/temp', false);
+			//!!! Error here - plus chmod!
+		}
+	}
+
+	// Anything which reinstalled should not have its entry removed.
+	$reinstall_worked = array();
+
+	// We're gonna be doing some removin'
+	$test = isset($_POST['cleandone']) ? false : true;
+	foreach ($upcontext['packages'] as $id => $package)
+	{
+		// Can't do anything about this....
+		if ($package['missing_file'])
+			continue;
+
+		// Not testing *and* this wasn't checked?
+		if (!$test && (!isset($_POST['remove']) || !isset($_POST['remove'][$id])))
+			continue;
+
+		// What are the themes this was installed into?
+		$cur_theme_paths = array();
+		foreach ($theme_paths as $tid => $data)
+			if ($tid != 1 && in_array($tid, $package['themes']))
+				$cur_theme_paths[$tid] = $data;
+
+		// Get the modifications data if applicable.
+		$filename = $package['filename'];
+		$packageInfo = getPackageInfo($filename);
+		if (!is_array($packageInfo))
+			continue;
+
+		$info = parsePackageInfo($packageInfo['xml'], $test, 'uninstall');
+		// Also get the reinstall details...
+		if (isset($_POST['remove']))
+			$infoInstall = parsePackageInfo($packageInfo['xml'], true);
+
+		if (is_file($boarddir . '/Packages/' . $filename))
+			read_tgz_file($boarddir . '/Packages/' . $filename, $boarddir . '/Packages/temp');
+		else
+			copytree($boarddir . '/Packages/' . $filename, $boarddir . '/Packages/temp');
+
+		// Work out how we uninstall...
+		$files = array();
+		foreach ($info as $change)
+		{
+			// Work out two things:
+			// 1) Whether it's installed at the moment - and if so whether its fully installed, and:
+			// 2) Whether it could be installed on the new version.
+			if ($change['type'] == 'modification')
+			{
+				$contents = @file_get_contents($boarddir . '/Packages/temp/' . $upcontext['base_path'] . $change['filename']);
+				if ($change['boardmod'])
+					$results = parseBoardMod($contents, $test, $change['reverse'], $cur_theme_paths);
+				else
+					$results = parseModification($contents, $test, $change['reverse'], $cur_theme_paths);
+
+				foreach ($results as $action)
+				{
+					// Something we can remove? Probably means it existed!
+					if (($action['type'] == 'replace' || $action['type'] == 'append' || (!empty($action['filename']) && $action['type'] == 'failure')) && !in_array($action['filename'], $files))
+						$files[] = $action['filename'];
+					if ($action['type'] == 'failure')
+					{
+						$upcontext['packages'][$id]['needs_removing'] = true;
+						$upcontext['packages'][$id]['status'] = 'Reinstall Required';
+						$upcontext['packages'][$id]['color'] = '#FD6435';
+					}
+				}
+			}
+		}
+
+		// Store this info for the template as appropriate.
+		$upcontext['packages'][$id]['files'] = $files;
+		$upcontext['packages'][$id]['file_count'] = count($files);
+
+		// If we've done something save the changes!
+		if (!$test)
+			package_flush_cache();
+
+		// Are we attempting to reinstall this thing?
+		if (isset($_POST['remove']) && !$test && isset($infoInstall))
+		{
+			// Need to extract again I'm afraid.
+			if (is_file($boarddir . '/Packages/' . $filename))
+				read_tgz_file($boarddir . '/Packages/' . $filename, $boarddir . '/Packages/temp');
+			else
+				copytree($boarddir . '/Packages/' . $filename, $boarddir . '/Packages/temp');
+
+			$errors = false;
+			$upcontext['packages'][$id]['result'] = 'Removed';
+			foreach ($infoInstall as $change)
+			{
+				if ($change['type'] == 'modification')
+				{
+					$contents = @file_get_contents($boarddir . '/Packages/temp/' . $upcontext['base_path'] . $change['filename']);
+					if ($change['boardmod'])
+						$results = parseBoardMod($contents, true, $change['reverse'], $cur_theme_paths);
+					else
+						$results = parseModification($contents, true, $change['reverse'], $cur_theme_paths);
+
+					// Are there any errors?
+					foreach ($results as $action)
+						if ($action['type'] == 'failure')
+							$errors = true;
+				}
+			}
+			if (!$errors)
+			{
+				$reinstall_worked[] = $id;
+				$upcontext['packages'][$id]['result'] = 'Reinstalled';
+				$upcontext['packages'][$id]['color'] = 'green';
+				foreach ($infoInstall as $change)
+				{
+					if ($change['type'] == 'modification')
+					{
+						$contents = @file_get_contents($boarddir . '/Packages/temp/' . $upcontext['base_path'] . $change['filename']);
+						if ($change['boardmod'])
+							$results = parseBoardMod($contents, false, $change['reverse'], $cur_theme_paths);
+						else
+							$results = parseModification($contents, false, $change['reverse'], $cur_theme_paths);
+					}
+				}
+
+				// Save the changes.
+				package_flush_cache();
+			}
+		}
+	}
+
+	// Put errors back on a sec.
+	error_reporting($oldErrorReporting);
+
+	// Check everything is writable.
+	if ($test && !empty($upcontext['packages']))
+	{
+		$writable_files = array();
+		foreach ($upcontext['packages'] as $package)
+		{
+			if (!empty($package['files']))
+				foreach ($package['files'] as $file)
+					$writable_files[] = $file;
+		}
+
+		if (!empty($writable_files))
+		{
+			$writable_files = array_unique($writable_files);
+			$upcontext['writable_files'] = $writable_files;
+
+			if (!makeFilesWritable($writable_files))
+				return false;
+		}
+	}
+
+	if (file_exists($boarddir . '/Packages/temp'))
+		deltree($boarddir . '/Packages/temp');
+
+	// Removing/Reinstalling any packages?
+	if (isset($_POST['remove']))
+	{
+		$deletes = array();
+		foreach ($_POST['remove'] as $id => $dummy)
+		{
+			if (!in_array((int) $id, $reinstall_worked))
+				$deletes[] = (int) $id;
+		}
+
+		if (!empty($deletes))
+			upgrade_query( '
+				UPDATE ' . $db_prefix . 'log_packages
+				SET install_state = 0
+				WHERE id_install IN (' . implode(',', $deletes) . ')');
+
+		// Ensure we don't lose our changes!
+		package_put_contents($boarddir . '/Packages/installed.list', time());
+
+		$upcontext['sub_template'] = 'cleanup_done';
+		return false;
+	}
+	else
+	{
+		$allgood = true;
+		// Is there actually anything that needs our attention?
+		foreach ($upcontext['packages'] as $package)
+			if ($package['color'] != 'green')
+				$allgood = false;
+
+		if ($allgood)
+			return true;
+	}
+
+	$_GET['substep'] = 0;
+	return isset($_POST['cleandone']) ? true : false;
+}
+
+
+// Delete the damn thing!
+function DeleteUpgrade()
+{
+	global $command_line, $language, $upcontext, $boarddir, $sourcedir, $forum_version, $user_info, $maintenance, $smcFunc, $db_type;
+
+	// Now it's nice to have some of the basic SMF source files.
+	if (!isset($_GET['ssi']) && !$command_line)
+		redirectLocation('&ssi=1');
+
+	$upcontext['sub_template'] = 'upgrade_complete';
+	$upcontext['page_title'] = 'Upgrade Complete';
+
+	$endl = $command_line ? "\n" : '<br />' . "\n";
+
+	$changes = array(
+		'language' => '\'' . (substr($language, -4) == '.lng' ? substr($language, 0, -4) : $language) . '\'',
+		'db_error_send' => '1',
+		'upgradeData' => '#remove#',
+	);
+
+	// Are we in maintenance mode?
+	if (isset($upcontext['user']['main']))
+	{
+		if ($command_line)
+			echo ' * ';
+		$upcontext['removed_maintenance'] = true;
+		$changes['maintenance'] = $upcontext['user']['main'];
+	}
+	// Otherwise if somehow we are in 2 let's go to 1.
+	elseif (!empty($maintenance) && $maintenance == 2)
+		$changes['maintenance'] = 1;
+
+	// Wipe this out...
+	$upcontext['user'] = array();
+
+	// Make a backup of Settings.php first as otherwise earlier changes are lost.
+	copy($boarddir . '/Settings.php', $boarddir . '/Settings_bak.php');
+	changeSettings($changes);
+
+	// Clean any old cache files away.
+	clean_cache();
+
+	// Can we delete the file?
+	$upcontext['can_delete_script'] = is_writable(dirname(__FILE__)) || is_writable(__FILE__);
+
+	// Now is the perfect time to fetch the SM files.
+	if ($command_line)
+		cli_scheduled_fetchSMfiles();
+	else
+	{
+		require_once($sourcedir . '/ScheduledTasks.php');
+		$forum_version = SMF_VERSION;  // The variable is usually defined in index.php so lets just use the constant to do it for us.
+		scheduled_fetchSMfiles(); // Now go get those files!
+	}
+
+	// Log what we've done.
+	if (empty($user_info['id']))
+		$user_info['id'] = !empty($upcontext['user']['id']) ? $upcontext['user']['id'] : 0;
+
+	// Log the action manually, so CLI still works.
+	$smcFunc['db_insert']('',
+		'{db_prefix}log_actions',
+		array(
+			'log_time' => 'int', 'id_log' => 'int', 'id_member' => 'int', 'ip' => 'string-16', 'action' => 'string',
+			'id_board' => 'int', 'id_topic' => 'int', 'id_msg' => 'int', 'extra' => 'string-65534',
+		),
+		array(
+			time(), 3, $user_info['id'], $command_line ? '127.0.0.1' : $user_info['ip'], 'upgrade',
+			0, 0, 0, serialize(array('version' => $forum_version, 'member' => $user_info['id'])),
+		),
+		array('id_action')
+	);
+	$user_info['id'] = 0;
+
+	// Save the current database version.
+	$server_version = $smcFunc['db_server_info']();
+	if ($db_type == 'mysql' && in_array(substr($server_version, 0, 6), array('5.0.50', '5.0.51')))
+		updateSettings(array('db_mysql_group_by_fix' => '1'));
+
+	if ($command_line)
+	{
+		echo $endl;
+		echo 'Upgrade Complete!', $endl;
+		echo 'Please delete this file as soon as possible for security reasons.', $endl;
+		exit;
+	}
+
+	// Make sure it says we're done.
+	$upcontext['overall_percent'] = 100;
+	if (isset($upcontext['step_progress']))
+		unset($upcontext['step_progress']);
+
+	$_GET['substep'] = 0;
+	return false;
+}
+
+// Just like the built in one, but setup for CLI to not use themes.
+function cli_scheduled_fetchSMfiles()
+{
+	global $sourcedir, $txt, $language, $settings, $forum_version, $modSettings, $smcFunc;
+
+	if (empty($modSettings['time_format']))
+		$modSettings['time_format'] = '%B %d, %Y, %I:%M:%S %p';
+
+	// What files do we want to get
+	$request = $smcFunc['db_query']('', '
+		SELECT id_file, filename, path, parameters
+		FROM {db_prefix}admin_info_files',
+		array(
+		)
+	);
+
+	$js_files = array();
+	while ($row = $smcFunc['db_fetch_assoc']($request))
+	{
+		$js_files[$row['id_file']] = array(
+			'filename' => $row['filename'],
+			'path' => $row['path'],
+			'parameters' => sprintf($row['parameters'], $language, urlencode($modSettings['time_format']), urlencode($forum_version)),
+		);
+	}
+	$smcFunc['db_free_result']($request);
+
+	// We're gonna need fetch_web_data() to pull this off.
+	require_once($sourcedir . '/Subs-Package.php');
+
+	foreach ($js_files as $ID_FILE => $file)
+	{
+		// Create the url
+		$server = empty($file['path']) || (strpos($file['path'], 'http://') === false && strpos($file['path'], 'https://') === false) ? 'https://www.simplemachines.org' : '';
+		$url = $server . $file['path'] . $file['filename'] . (!empty($file['parameters']) ? '?' . $file['parameters'] : '');
+
+		// Get the file
+		$file_data = fetch_web_data($url);
+
+		// If we got an error - give up - the site might be down.
+		if ($file_data === false)
+			return throw_error(sprintf('Could not retrieve the file %1$s.', $url));
+
+		// Save the file to the database.
+		$smcFunc['db_query']('substring', '
+			UPDATE {db_prefix}admin_info_files
+			SET data = SUBSTRING({string:file_data}, 1, 65534)
+			WHERE id_file = {int:id_file}',
+			array(
+				'id_file' => $ID_FILE,
+				'file_data' => $file_data,
+			)
+		);
+	}
+	return true;
+}
+
+function convertSettingsToTheme()
+{
+	global $db_prefix, $modSettings, $smcFunc;
+
+	$values = array(
+		'show_latest_member' => @$GLOBALS['showlatestmember'],
+		'show_bbc' => isset($GLOBALS['showyabbcbutt']) ? $GLOBALS['showyabbcbutt'] : @$GLOBALS['showbbcbutt'],
+		'show_modify' => @$GLOBALS['showmodify'],
+		'show_user_images' => @$GLOBALS['showuserpic'],
+		'show_blurb' => @$GLOBALS['showusertext'],
+		'show_gender' => @$GLOBALS['showgenderimage'],
+		'show_newsfader' => @$GLOBALS['shownewsfader'],
+		'display_recent_bar' => @$GLOBALS['Show_RecentBar'],
+		'show_member_bar' => @$GLOBALS['Show_MemberBar'],
+		'linktree_link' => @$GLOBALS['curposlinks'],
+		'show_profile_buttons' => @$GLOBALS['profilebutton'],
+		'show_mark_read' => @$GLOBALS['showmarkread'],
+		'show_board_desc' => @$GLOBALS['ShowBDescrip'],
+		'newsfader_time' => @$GLOBALS['fadertime'],
+		'use_image_buttons' => empty($GLOBALS['MenuType']) ? 1 : 0,
+		'enable_news' => @$GLOBALS['enable_news'],
+		'linktree_inline' => @$modSettings['enableInlineLinks'],
+		'return_to_post' => @$modSettings['returnToPost'],
+	);
+
+	$themeData = array();
+	foreach ($values as $variable => $value)
+	{
+		if (!isset($value) || $value === null)
+			$value = 0;
+
+		$themeData[] = array(0, 1, $variable, $value);
+	}
+	if (!empty($themeData))
+	{
+		$smcFunc['db_insert']('ignore',
+			$db_prefix . 'themes',
+			array('id_member' => 'int', 'id_theme' => 'int', 'variable' => 'string', 'value' => 'string'),
+			$themeData,
+			array('id_member', 'id_theme', 'variable')
+		);
+	}
+}
+
+// This function only works with MySQL but that's fine as it is only used for v1.0.
+function convertSettingstoOptions()
+{
+	global $db_prefix, $modSettings, $smcFunc;
+
+	// Format: new_setting -> old_setting_name.
+	$values = array(
+		'calendar_start_day' => 'cal_startmonday',
+		'view_newest_first' => 'viewNewestFirst',
+		'view_newest_pm_first' => 'viewNewestFirst',
+	);
+
+	foreach ($values as $variable => $value)
+	{
+		if (empty($modSettings[$value[0]]))
+			continue;
+
+		$smcFunc['db_query']('', '
+			INSERT IGNORE INTO {db_prefix}themes
+				(id_member, id_theme, variable, value)
+			SELECT id_member, 1, {string:variable}, {string:value}
+			FROM {db_prefix}members',
+			array(
+				'variable' => $variable,
+				'value' => $modSettings[$value[0]],
+				'db_error_skip' => true,
+			)
+		);
+
+		$smcFunc['db_query']('', '
+			INSERT IGNORE INTO {db_prefix}themes
+				(id_member, id_theme, variable, value)
+			VALUES (-1, 1, {string:variable}, {string:value})',
+			array(
+				'variable' => $variable,
+				'value' => $modSettings[$value[0]],
+				'db_error_skip' => true,
+			)
+		);
+	}
+}
+
+function changeSettings($config_vars)
+{
+	global $boarddir;
+
+	$settingsArray = file($boarddir . '/Settings_bak.php');
+
+	if (count($settingsArray) == 1)
+		$settingsArray = preg_split('~[\r\n]~', $settingsArray[0]);
+
+	for ($i = 0, $n = count($settingsArray); $i < $n; $i++)
+	{
+		// Don't trim or bother with it if it's not a variable.
+		if (substr($settingsArray[$i], 0, 1) == '$')
+		{
+			$settingsArray[$i] = trim($settingsArray[$i]) . "\n";
+
+			foreach ($config_vars as $var => $val)
+			{
+				if (isset($settingsArray[$i]) && strncasecmp($settingsArray[$i], '$' . $var, 1 + strlen($var)) == 0)
+				{
+					if ($val == '#remove#')
+						unset($settingsArray[$i]);
+					else
+					{
+						$comment = strstr(substr($settingsArray[$i], strpos($settingsArray[$i], ';')), '#');
+						$settingsArray[$i] = '$' . $var . ' = ' . $val . ';' . ($comment != '' ? "\t\t" . $comment : "\n");
+					}
+
+					unset($config_vars[$var]);
+				}
+			}
+		}
+		if (isset($settingsArray[$i]))
+		{
+			if (trim(substr($settingsArray[$i], 0, 2)) == '?' . '>')
+				$end = $i;
+		}
+	}
+
+	// Assume end-of-file if the end wasn't found.
+	if (empty($end) || $end < 10)
+		$end = count($settingsArray);
+
+	if (!empty($config_vars))
+	{
+		$settingsArray[$end++] = '';
+		foreach ($config_vars as $var => $val)
+		{
+			if ($val != '#remove#')
+				$settingsArray[$end++] = '$' . $var . ' = ' . $val . ';' . "\n";
+		}
+	}
+	// This should be the last line and even last bytes of the file.
+	$settingsArray[$end] = '?' . '>';
+
+	// Blank out the file - done to fix a oddity with some servers.
+	$fp = fopen($boarddir . '/Settings.php', 'w');
+	fclose($fp);
+
+	$fp = fopen($boarddir . '/Settings.php', 'r+');
+	for ($i = 0; $i < $end; $i++)
+	{
+		if (isset($settingsArray[$i]))
+			fwrite($fp, strtr($settingsArray[$i], "\r", ''));
+	}
+	fwrite($fp, rtrim($settingsArray[$i]));
+	fclose($fp);
+}
+
+function php_version_check()
+{
+	$minver = explode('.', $GLOBALS['required_php_version']);
+	$curver = explode('.', PHP_VERSION);
+
+	return !(($curver[0] <= $minver[0]) && ($curver[1] <= $minver[1]) && ($curver[1] <= $minver[1]) && ($curver[2][0] < $minver[2][0]));
+}
+
+function db_version_check()
+{
+	global $db_type, $databases;
+
+	$curver = eval($databases[$db_type]['version_check']);
+	$curver = preg_replace('~\-.+?$~', '', $curver);
+
+	return version_compare($databases[$db_type]['version'], $curver) <= 0;
+}
+
+function getMemberGroups()
+{
+	global $db_prefix, $smcFunc;
+	static $member_groups = array();
+
+	if (!empty($member_groups))
+		return $member_groups;
+
+	$request = $smcFunc['db_query']('', '
+		SELECT groupName, id_group
+		FROM {db_prefix}membergroups
+		WHERE id_group = {int:admin_group} OR id_group > {int:old_group}',
+		array(
+			'admin_group' => 1,
+			'old_group' => 7,
+			'db_error_skip' => true,
+		)
+	);
+	if ($request === false)
+	{
+		$request = $smcFunc['db_query']('', '
+			SELECT membergroup, id_group
+			FROM {db_prefix}membergroups
+			WHERE id_group = {int:admin_group} OR id_group > {int:old_group}',
+			array(
+				'admin_group' => 1,
+				'old_group' => 7,
+				'db_error_skip' => true,
+			)
+		);
+	}
+	while ($row = $smcFunc['db_fetch_row']($request))
+		$member_groups[trim($row[0])] = $row[1];
+	$smcFunc['db_free_result']($request);
+
+	return $member_groups;
+}
+
+function fixRelativePath($path)
+{
+	global $install_path;
+
+	// Fix the . at the start, clear any duplicate slashes, and fix any trailing slash...
+	return addslashes(preg_replace(array('~^\.([/\\\]|$)~', '~[/]+~', '~[\\\]+~', '~[/\\\]$~'), array($install_path . '$1', '/', '\\', ''), $path));
+}
+
+function parse_sql($filename)
+{
+	global $db_prefix, $db_collation, $boarddir, $boardurl, $command_line, $file_steps, $step_progress, $custom_warning;
+	global $upcontext, $support_js, $is_debug, $smcFunc, $db_connection, $databases, $db_type, $db_character_set;
+
+/*
+	Failure allowed on:
+		- INSERT INTO but not INSERT IGNORE INTO.
+		- UPDATE IGNORE but not UPDATE.
+		- ALTER TABLE and ALTER IGNORE TABLE.
+		- DROP TABLE.
+	Yes, I realize that this is a bit confusing... maybe it should be done differently?
+
+	If a comment...
+		- begins with --- it is to be output, with a break only in debug mode. (and say successful\n\n if there was one before.)
+		- begins with ---# it is a debugging statement, no break - only shown at all in debug.
+		- is only ---#, it is "done." and then a break - only shown in debug.
+		- begins with ---{ it is a code block terminating at ---}.
+
+	Every block of between "--- ..."s is a step.  Every "---#" section represents a substep.
+
+	Replaces the following variables:
+		- {$boarddir}
+		- {$boardurl}
+		- {$db_prefix}
+		- {$db_collation}
+*/
+
+	// May want to use extended functionality.
+	db_extend();
+	db_extend('packages');
+
+	// Our custom error handler - does nothing but does stop public errors from XML!
+	// Note that php error suppression - @ - used heavily in the upgrader, calls the error handler
+	// but error_reporting() will return 0 as it does so (pre php8).
+	// Note error handling in php8+ no longer fails silently on many errors, but error_reporting()
+	// will return 4437 (E_ERROR | E_CORE_ERROR | E_COMPILE_ERROR | E_USER_ERROR | E_RECOVERABLE_ERROR | E_PARSE)
+	// as it does so.
+	if (!function_exists('sql_error_handler'))
+	{
+		function sql_error_handler($errno, $errstr, $errfile, $errline)
+		{
+			global $support_js;
+
+			if ($support_js)
+				return true;
+			elseif ((error_reporting() != 0) && (error_reporting() != (E_ERROR | E_CORE_ERROR | E_COMPILE_ERROR | E_USER_ERROR | E_RECOVERABLE_ERROR | E_PARSE)))
+				echo 'Error: ' . $errstr . ' File: ' . $errfile . ' Line: ' . $errline;
+		}
+	}
+
+	// Make our own error handler.
+	set_error_handler('sql_error_handler');
+
+	// If we're on MySQL supporting collations then let's find out what the members table uses and put it in a global var - to allow upgrade script to match collations!
+	if (!empty($databases[$db_type]['utf8_support']) && version_compare($databases[$db_type]['utf8_version'], eval($databases[$db_type]['utf8_version_check'])) != 1)
+	{
+		$request = $smcFunc['db_query']('', '
+			SHOW TABLE STATUS
+			LIKE {string:table_name}',
+			array(
+				'table_name' => "{$db_prefix}members",
+				'db_error_skip' => true,
+			)
+		);
+		if ($smcFunc['db_num_rows']($request) === 0)
+			die('Unable to find members table!');
+		$table_status = $smcFunc['db_fetch_assoc']($request);
+		$smcFunc['db_free_result']($request);
+
+		if (!empty($table_status['Collation']))
+		{
+			$request = $smcFunc['db_query']('', '
+				SHOW COLLATION
+				LIKE {string:collation}',
+				array(
+					'collation' => $table_status['Collation'],
+					'db_error_skip' => true,
+				)
+			);
+			// Got something?
+			if ($smcFunc['db_num_rows']($request) !== 0)
+				$collation_info = $smcFunc['db_fetch_assoc']($request);
+			$smcFunc['db_free_result']($request);
+
+			// Excellent!
+			if (!empty($collation_info['Collation']) && !empty($collation_info['Charset']))
+				$db_collation = ' CHARACTER SET ' . $collation_info['Charset'] . ' COLLATE ' . $collation_info['Collation'];
+		}
+	}
+	if (empty($db_collation))
+		$db_collation = '';
+
+	$endl = $command_line ? "\n" : '<br />' . "\n";
+
+	$lines = file($filename);
+
+	$current_type = 'sql';
+	$current_data = '';
+	$substep = 0;
+	$last_step = '';
+
+	// Make sure all newly created tables will have the proper characters set.
+	if (isset($db_character_set) && $db_character_set === 'utf8')
+		$lines = str_replace(') ENGINE=MyISAM;', ') ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;', $lines);
+
+	// Count the total number of steps within this file - for progress.
+	$file_steps = substr_count(implode('', $lines), '---#');
+	$upcontext['total_items'] = substr_count(implode('', $lines), '--- ');
+	$upcontext['debug_items'] = $file_steps;
+	$upcontext['current_item_num'] = 0;
+	$upcontext['current_item_name'] = '';
+	$upcontext['current_debug_item_num'] = 0;
+	$upcontext['current_debug_item_name'] = '';
+	// This array keeps a record of what we've done in case java is dead...
+	$upcontext['actioned_items'] = array();
+
+	$done_something = false;
+
+	foreach ($lines as $line_number => $line)
+	{
+		$do_current = $substep >= $_GET['substep'];
+
+		// Get rid of any comments in the beginning of the line...
+		if (substr(trim($line), 0, 2) === '/*')
+			$line = preg_replace('~/\*.+?\*/~', '', $line);
+
+		// Always flush.  Flush, flush, flush.  Flush, flush, flush, flush!  FLUSH!
+		if ($is_debug && !$support_js && $command_line)
+			flush();
+
+		if (trim($line) === '')
+			continue;
+
+		if (trim(substr($line, 0, 3)) === '---')
+		{
+			$type = substr($line, 3, 1);
+
+			// An error??
+			if (trim($current_data) != '' && $type !== '}')
+			{
+				$upcontext['error_message'] = 'Error in upgrade script - line ' . $line_number . '!' . $endl;
+				if ($command_line)
+					echo $upcontext['error_message'];
+			}
+
+			if ($type == ' ')
+			{
+				if (!$support_js && $do_current && $_GET['substep'] != 0 && $command_line)
+				{
+					echo ' Successful.', $endl;
+					flush();
+				}
+
+				$last_step = htmlspecialchars(rtrim(substr($line, 4)));
+				$upcontext['current_item_num']++;
+				$upcontext['current_item_name'] = $last_step;
+
+				if ($do_current)
+				{
+					$upcontext['actioned_items'][] = $last_step;
+					if ($command_line)
+						echo ' * ';
+				}
+			}
+			elseif ($type == '#')
+			{
+				$upcontext['step_progress'] += (100 / $upcontext['file_count']) / $file_steps;
+
+				$upcontext['current_debug_item_num']++;
+				if (trim($line) != '---#')
+					$upcontext['current_debug_item_name'] = htmlspecialchars(rtrim(substr($line, 4)));
+
+				// Have we already done something?
+				if (isset($_GET['xml']) && $done_something)
+				{
+					restore_error_handler();
+					return $upcontext['current_debug_item_num'] >= $upcontext['debug_items'] ? true : false;
+				}
+
+				if ($do_current)
+				{
+					if (trim($line) == '---#' && $command_line)
+						echo ' done.', $endl;
+					elseif ($command_line)
+						echo ' +++ ', rtrim(substr($line, 4));
+					elseif (trim($line) != '---#')
+					{
+						if ($is_debug)
+							$upcontext['actioned_items'][] = htmlspecialchars(rtrim(substr($line, 4)));
+					}
+				}
+
+				if ($substep < $_GET['substep'] && $substep + 1 >= $_GET['substep'])
+				{
+					if ($command_line)
+						echo ' * ';
+					else
+						$upcontext['actioned_items'][] = $last_step;
+				}
+
+				// Small step - only if we're actually doing stuff.
+				if ($do_current)
+					nextSubstep(++$substep);
+				else
+					$substep++;
+			}
+			elseif ($type == '{')
+				$current_type = 'code';
+			elseif ($type == '}')
+			{
+				$current_type = 'sql';
+
+				if (!$do_current)
+				{
+					$current_data = '';
+					continue;
+				}
+
+				if (eval('global $db_prefix, $modSettings, $smcFunc; ' . $current_data) === false)
+				{
+					$upcontext['error_message'] = 'Error in upgrade script ' . basename($filename) . ' on line ' . $line_number . '!' . $endl;
+					if ($command_line)
+						echo $upcontext['error_message'];
+				}
+
+				// Done with code!
+				$current_data = '';
+				$done_something = true;
+			}
+
+			continue;
+		}
+
+		$current_data .= $line;
+		if (substr(rtrim($current_data), -1) === ';' && $current_type === 'sql')
+		{
+			if ((!$support_js || isset($_GET['xml'])))
+			{
+				if (!$do_current)
+				{
+					$current_data = '';
+					continue;
+				}
+
+				$current_data = strtr(substr(rtrim($current_data), 0, -1), array('{$db_prefix}' => $db_prefix, '{$boarddir}' => $boarddir, '{$sboarddir}' => addslashes($boarddir), '{$boardurl}' => $boardurl, '{$db_collation}' => $db_collation));
+
+				upgrade_query($current_data);
+
+				// !!! This will be how it kinda does it once mysql all stripped out - needed for postgre (etc).
+				/*
+				$result = $smcFunc['db_query']('', $current_data, false, false);
+				// Went wrong?
+				if (!$result)
+				{
+					// Bit of a bodge - do we want the error?
+					if (!empty($upcontext['return_error']))
+					{
+						$upcontext['error_message'] = $smcFunc['db_error']($db_connection);
+						return false;
+					}
+				}*/
+				$done_something = true;
+			}
+			$current_data = '';
+		}
+		// If this is xml based and we're just getting the item name then that's grand.
+		elseif ($support_js && !isset($_GET['xml']) && $upcontext['current_debug_item_name'] != '' && $do_current)
+		{
+			restore_error_handler();
+			return false;
+		}
+
+		// Clean up by cleaning any step info.
+		$step_progress = array();
+		$custom_warning = '';
+	}
+
+	// Put back the error handler.
+	restore_error_handler();
+
+	if ($command_line)
+	{
+		echo ' Successful.' . "\n";
+		flush();
+	}
+
+	$_GET['substep'] = 0;
+	return true;
+}
+
+function upgrade_query($string, $unbuffered = false)
+{
+	global $db_connection, $db_server, $db_user, $db_passwd, $db_type, $command_line, $upcontext, $upgradeurl, $modSettings;
+	global $db_name, $db_unbuffered, $smcFunc;
+
+	// Get the query result - working around some SMF specific security - just this once!
+	$modSettings['disableQueryCheck'] = true;
+	$db_unbuffered = $unbuffered;
+	$result = $smcFunc['db_query']('', $string, array('security_override' => true, 'db_error_skip' => true));
+	$db_unbuffered = false;
+
+	// Failure?!
+	if ($result !== false)
+		return $result;
+
+	$db_error_message = $smcFunc['db_error']($db_connection);
+	// If MySQL we do something more clever.
+	if ($db_type == 'mysql')
+	{
+		$mysqli_errno = mysqli_errno($db_connection);
+		$error_query = in_array(substr(trim($string), 0, 11), array('INSERT INTO', 'UPDATE IGNO', 'ALTER TABLE', 'DROP TABLE ', 'ALTER IGNOR', 'INSERT IGNO'));
+
+		// Error numbers:
+		//    1016: Can't open file '....MYI'
+		//    1050: Table already exists.
+		//    1054: Unknown column name.
+		//    1060: Duplicate column name.
+		//    1061: Duplicate key name.
+		//    1062: Duplicate entry for unique key.
+		//    1068: Multiple primary keys.
+		//    1072: Key column '%s' doesn't exist in table.
+		//    1091: Can't drop key, doesn't exist.
+		//    1146: Table doesn't exist.
+		//    2013: Lost connection to server during query.
+
+		if ($mysqli_errno == 1016)
+		{
+			if (preg_match('~\'([^\.\']+)~', $db_error_message, $match) != 0 && !empty($match[1]))
+			{
+				mysqli_query($db_connection, 'REPAIR TABLE `' . $match[1] . '`');
+				$result = mysqli_query($db_connection, $string);
+				if ($result !== false)
+					return $result;
+			}
+		}
+		elseif ($mysqli_errno == 2013)
+		{
+			$db_connection = mysqli_connect($db_server, $db_user, $db_passwd);
+			mysqli_select_db($db_connection, $db_name);
+			if ($db_connection)
+			{
+				$result = mysqli_query($db_connection, $string);
+				if ($result !== false)
+					return $result;
+			}
+		}
+		// Duplicate column name... should be okay ;).
+		elseif (in_array($mysqli_errno, array(1060, 1061, 1068, 1091)))
+			return false;
+		// Duplicate insert... make sure it's the proper type of query ;).
+		elseif (in_array($mysqli_errno, array(1054, 1062, 1146)) && $error_query)
+			return false;
+		// Creating an index on a non-existent column.
+		elseif ($mysqli_errno == 1072)
+			return false;
+		elseif ($mysqli_errno == 1050 && substr(trim($string), 0, 12) == 'RENAME TABLE')
+			return false;
+		// Testing for legacy tables or columns? Needed for 1.0 & 1.1 scripts.
+		elseif (in_array($mysqli_errno, array(1054, 1146)) && in_array(substr(trim($string), 0, 7), array('SELECT ', 'SHOW CO')))
+			return false;
+	}
+	// If a table already exists don't go potty.
+	else
+	{
+		if (in_array(substr(trim($string), 0, 8), array('CREATE T', 'CREATE S', 'DROP TABL', 'ALTER TA', 'CREATE I', 'CREATE U')))
+		{
+			if (strpos($db_error_message, 'exist') !== false)
+				return true;
+			// SQLite
+			if (strpos($db_error_message, 'missing') !== false)
+				return true;
+		}
+		elseif (strpos(trim($string), 'INSERT ') !== false)
+		{
+			if (strpos($db_error_message, 'duplicate') !== false)
+				return true;
+		}
+	}
+
+	// Get the query string so we pass everything.
+	$query_string = '';
+	foreach ($_GET as $k => $v)
+		$query_string .= ';' . $k . '=' . $v;
+	if (strlen($query_string) != 0)
+		$query_string = '?' . substr($query_string, 1);
+
+	if ($command_line)
+	{
+		echo 'Unsuccessful!  Database error message:', "\n", $db_error_message, "\n";
+		die;
+	}
+
+	// Bit of a bodge - do we want the error?
+	if (!empty($upcontext['return_error']))
+	{
+		$upcontext['error_message'] = $db_error_message;
+		$upcontext['error_string'] = $string;
+		return false;
+	}
+
+	// Otherwise we have to display this somewhere appropriate if possible.
+	$upcontext['forced_error_message'] = '
+			<strong>Unsuccessful!</strong><br />
+
+			<div style="margin: 2ex;">
+				This query:
+				<blockquote><tt>' . nl2br(htmlspecialchars(trim($string))) . ';</tt></blockquote>
+
+				Caused the error:
+				<blockquote>' . nl2br(htmlspecialchars($db_error_message)) . '</blockquote>
+			</div>
+
+			<form action="' . $upgradeurl . $query_string . '" method="post">
+				<input type="submit" value="Try again" class="button_submit" />
+			</form>
+		</div>';
+
+	upgradeExit();
+}
+
+// This performs a table alter, but does it unbuffered so the script can time out professionally.
+function protected_alter($change, $substep, $is_test = false)
+{
+	global $db_prefix, $smcFunc;
+
+	db_extend('packages');
+
+	// Firstly, check whether the current index/column exists.
+	$found = false;
+	if ($change['type'] === 'column')
+	{
+		$columns = $smcFunc['db_list_columns']('{db_prefix}' . $change['table'], true);
+		foreach ($columns as $column)
+		{
+			// Found it?
+			if ($column['name'] === $change['name'])
+			{
+				$found |= 1;
+				// Do some checks on the data if we have it set.
+				if (isset($change['col_type']))
+					$found &= $change['col_type'] === $column['type'];
+				if (isset($change['null_allowed']))
+					$found &= $column['null'] == $change['null_allowed'];
+				if (isset($change['default']))
+					$found &= $change['default'] === $column['default'];
+			}
+		}
+	}
+	elseif ($change['type'] === 'index')
+	{
+		$request = upgrade_query( '
+			SHOW INDEX
+			FROM ' . $db_prefix . $change['table']);
+		if ($request !== false)
+		{
+			$cur_index = array();
+
+			while ($row = $smcFunc['db_fetch_assoc']($request))
+				if ($row['Key_name'] === $change['name'])
+					$cur_index[(int) $row['Seq_in_index']] = $row['Column_name'];
+
+			ksort($cur_index, SORT_NUMERIC);
+			$found = array_values($cur_index) === $change['target_columns'];
+
+			$smcFunc['db_free_result']($request);
+		}
+	}
+
+	// If we're trying to add and it's added, we're done.
+	if ($found && in_array($change['method'], array('add', 'change')))
+		return true;
+	// Otherwise if we're removing and it wasn't found we're also done.
+	elseif (!$found && in_array($change['method'], array('remove', 'change_remove')))
+		return true;
+	// Otherwise is it just a test?
+	elseif ($is_test)
+		return false;
+
+	// Not found it yet? Bummer! How about we see if we're currently doing it?
+	$running = false;
+	$found = false;
+	while (1 == 1)
+	{
+		$request = upgrade_query('
+			SHOW FULL PROCESSLIST');
+		while ($row = $smcFunc['db_fetch_assoc']($request))
+		{
+			if (strpos($row['Info'], 'ALTER TABLE ' . $db_prefix . $change['table']) !== false && strpos($row['Info'], $change['text']) !== false)
+				$found = true;
+		}
+
+		// Can't find it? Then we need to run it fools!
+		if (!$found && !$running)
+		{
+			$smcFunc['db_free_result']($request);
+
+			$success = upgrade_query('
+				ALTER TABLE ' . $db_prefix . $change['table'] . '
+				' . $change['text'], true) !== false;
+
+			if (!$success)
+				return false;
+
+			// Return
+			$running = true;
+		}
+		// What if we've not found it, but we'd ran it already? Must of completed.
+		elseif (!$found)
+		{
+			$smcFunc['db_free_result']($request);
+			return true;
+		}
+
+		// Pause execution for a sec or three.
+		sleep(3);
+
+		// Can never be too well protected.
+		nextSubstep($substep);
+	}
+
+	// Protect it.
+	nextSubstep($substep);
+}
+
+// Alter a text column definition preserving its character set.
+function textfield_alter($change, $substep)
+{
+	global $db_prefix, $databases, $db_type, $smcFunc;
+
+	// Versions of MySQL < 4.1 wouldn't benefit from character set detection.
+	if (empty($databases[$db_type]['utf8_support']) || version_compare($databases[$db_type]['utf8_version'], eval($databases[$db_type]['utf8_version_check'])) > 0)
+	{
+		$column_fix = true;
+		$null_fix = !$change['null_allowed'];
+	}
+	else
+	{
+		$request = $smcFunc['db_query']('', '
+			SHOW FULL COLUMNS
+			FROM {db_prefix}' . $change['table'] . '
+			LIKE {string:column}',
+			array(
+				'column' => $change['column'],
+				'db_error_skip' => true,
+			)
+		);
+		if ($smcFunc['db_num_rows']($request) === 0)
+			die('Unable to find column ' . $change['column'] . ' inside table ' . $db_prefix . $change['table']);
+		$table_row = $smcFunc['db_fetch_assoc']($request);
+		$smcFunc['db_free_result']($request);
+
+		// If something of the current column definition is different, fix it.
+		$column_fix = $table_row['Type'] !== $change['type'] || (strtolower($table_row['Null']) === 'yes') !== $change['null_allowed'] || ($table_row['Default'] == NULL) !== !isset($change['default']) || (isset($change['default']) && $change['default'] !== $table_row['Default']);
+
+		// Columns that previously allowed null, need to be converted first.
+		$null_fix = strtolower($table_row['Null']) === 'yes' && !$change['null_allowed'];
+
+		// Get the character set that goes with the collation of the column.
+		if ($column_fix && !empty($table_row['Collation']))
+		{
+			$request = $smcFunc['db_query']('', '
+				SHOW COLLATION
+				LIKE {string:collation}',
+				array(
+					'collation' => $table_row['Collation'],
+					'db_error_skip' => true,
+				)
+			);
+			// No results? Just forget it all together.
+			if ($smcFunc['db_num_rows']($request) === 0)
+				unset($table_row['Collation']);
+			else
+				$collation_info = $smcFunc['db_fetch_assoc']($request);
+			$smcFunc['db_free_result']($request);
+		}
+	}
+
+	if ($column_fix)
+	{
+		// Make sure there are no NULL's left.
+		if ($null_fix)
+			$smcFunc['db_query']('', '
+				UPDATE {db_prefix}' . $change['table'] . '
+				SET ' . $change['column'] . ' = {string:default}
+				WHERE ' . $change['column'] . ' IS NULL',
+				array(
+					'default' => isset($change['default']) ? $change['default'] : '',
+					'db_error_skip' => true,
+				)
+			);
+
+		// Do the actual alteration.
+		$smcFunc['db_query']('', '
+			ALTER TABLE {db_prefix}' . $change['table'] . '
+			CHANGE COLUMN ' . $change['column'] . ' ' . $change['column'] . ' ' . $change['type'] . (isset($collation_info['Charset']) ? ' CHARACTER SET ' . $collation_info['Charset'] . ' COLLATE ' . $collation_info['Collation'] : '') . ($change['null_allowed'] ? '' : ' NOT NULL') . (isset($change['default']) ? ' default {string:default}' : ''),
+			array(
+				'default' => isset($change['default']) ? $change['default'] : '',
+				'db_error_skip' => true,
+			)
+		);
+	}
+	nextSubstep($substep);
+}
+
+// The next substep.
+function nextSubstep($substep)
+{
+	global $start_time, $timeLimitThreshold, $command_line, $file_steps, $modSettings, $custom_warning;
+	global $step_progress, $is_debug, $upcontext;
+
+	if ($_GET['substep'] < $substep)
+		$_GET['substep'] = $substep;
+
+	if ($command_line)
+	{
+		if (time() - $start_time > 1 && empty($is_debug))
+		{
+			echo '.';
+			$start_time = time();
+		}
+		return;
+	}
+
+	@set_time_limit(300);
+	if (function_exists('apache_reset_timeout'))
+		@apache_reset_timeout();
+
+	if (time() - $start_time <= $timeLimitThreshold)
+		return;
+
+	// Do we have some custom step progress stuff?
+	if (!empty($step_progress))
+	{
+		$upcontext['substep_progress'] = 0;
+		$upcontext['substep_progress_name'] = $step_progress['name'];
+		if ($step_progress['current'] > $step_progress['total'])
+			$upcontext['substep_progress'] = 99.9;
+		else
+			$upcontext['substep_progress'] = ($step_progress['current'] / $step_progress['total']) * 100;
+
+		// Make it nicely rounded.
+		$upcontext['substep_progress'] = round($upcontext['substep_progress'], 1);
+	}
+
+	// If this is XML we just exit right away!
+	if (isset($_GET['xml']))
+		return upgradeExit();
+
+	// We're going to pause after this!
+	$upcontext['pause'] = true;
+
+	$upcontext['query_string'] = '';
+	foreach ($_GET as $k => $v)
+	{
+		if ($k != 'data' && $k != 'substep' && $k != 'step')
+			$upcontext['query_string'] .= ';' . $k . '=' . $v;
+	}
+
+	// Custom warning?
+	if (!empty($custom_warning))
+		$upcontext['custom_warning'] = $custom_warning;
+
+	upgradeExit();
+}
+
+function cmdStep0()
+{
+	global $boarddir, $sourcedir, $db_prefix, $language, $modSettings, $start_time, $cachedir, $databases, $db_type, $smcFunc, $upcontext;
+	global $language, $is_debug, $txt;
+	$start_time = time();
+
+	ob_end_clean();
+	ob_implicit_flush(true);
+	@set_time_limit(600);
+
+	if (!isset($_SERVER['argv']))
+		$_SERVER['argv'] = array();
+	$_GET['maint'] = 1;
+
+	foreach ($_SERVER['argv'] as $i => $arg)
+	{
+		if (preg_match('~^--language=(.+)$~', $arg, $match) != 0)
+			$_GET['lang'] = $match[1];
+		elseif (preg_match('~^--path=(.+)$~', $arg) != 0)
+			continue;
+		elseif ($arg == '--no-maintenance')
+			$_GET['maint'] = 0;
+		elseif ($arg == '--debug')
+			$is_debug = true;
+		elseif ($arg == '--backup')
+			$_POST['backup'] = 1;
+		elseif ($arg == '--template' && (file_exists($boarddir . '/template.php') || file_exists($boarddir . '/template.html') && !file_exists($modSettings['theme_dir'] . '/converted')))
+			$_GET['conv'] = 1;
+		elseif ($i != 0)
+		{
+			echo 'SMF Command-line Upgrader
+Usage: /path/to/php -f ' . basename(__FILE__) . ' -- [OPTION]...
+
+    --language=LANG         Reset the forum\'s language to LANG.
+    --no-maintenance        Don\'t put the forum into maintenance mode.
+    --debug                 Output debugging information.
+    --backup                Create backups of tables with "backup_" prefix.';
+			echo "\n";
+			exit;
+		}
+	}
+
+	if (!php_version_check())
+		print_error('Error: PHP ' . PHP_VERSION . ' does not match version requirements.', true);
+	if (!db_version_check())
+		print_error('Error: ' . $databases[$db_type]['name'] . ' ' . $databases[$db_type]['version'] . ' does not match minimum requirements.', true);
+
+	if (!empty($databases[$db_type]['alter_support']) && $smcFunc['db_query']('alter_boards', 'ALTER TABLE {db_prefix}boards ORDER BY id_board', array()) === false)
+		print_error('Error: The ' . $databases[$db_type]['name'] . ' account in Settings.php does not have sufficient privileges.', true);
+
+	$check = @file_exists($modSettings['theme_dir'] . '/index.template.php')
+		&& @file_exists($sourcedir . '/QueryString.php')
+		&& @file_exists($sourcedir . '/ManageBoards.php');
+	if (!$check && !isset($modSettings['smfVersion']))
+		print_error('Error: Some files are missing or out-of-date.', true);
+
+	// Do a quick version spot check.
+	$temp = substr(@implode('', @file($boarddir . '/index.php')), 0, 4096);
+	preg_match('~\*\s@version\s+(.+)[\s]{2}~i', $temp, $match);
+	if (empty($match[1]) || $match[1] != SMF_VERSION)
+		print_error('Error: Some files have not yet been updated properly.');
+
+	// Make sure Settings.php is writable.
+	if (!is_writable($boarddir . '/Settings.php'))
+		@chmod($boarddir . '/Settings.php', 0777);
+	if (!is_writable($boarddir . '/Settings.php'))
+		print_error('Error: Unable to obtain write access to "Settings.php".', true);
+
+	// Make sure Settings.php is writable.
+	if (!is_writable($boarddir . '/Settings_bak.php'))
+		@chmod($boarddir . '/Settings_bak.php', 0777);
+	if (!is_writable($boarddir . '/Settings_bak.php'))
+		print_error('Error: Unable to obtain write access to "Settings_bak.php".');
+
+	if (isset($modSettings['agreement']) && (!is_writable($boarddir) || file_exists($boarddir . '/agreement.txt')) && !is_writable($boarddir . '/agreement.txt'))
+		print_error('Error: Unable to obtain write access to "agreement.txt".');
+	elseif (isset($modSettings['agreement']))
+	{
+		$fp = fopen($boarddir . '/agreement.txt', 'w');
+		fwrite($fp, $modSettings['agreement']);
+		fclose($fp);
+	}
+
+	// Make sure Themes is writable.
+	if (!is_writable($modSettings['theme_dir']))
+		@chmod($modSettings['theme_dir'], 0777);
+
+	if (!is_writable($modSettings['theme_dir']) && !isset($modSettings['smfVersion']))
+		print_error('Error: Unable to obtain write access to "Themes".');
+
+	// Make sure cache directory exists and is writable!
+	$cachedir_temp = empty($cachedir) ? $boarddir . '/cache' : $cachedir;
+	if (!file_exists($cachedir_temp))
+		@mkdir($cachedir_temp);
+
+	if (!is_writable($cachedir_temp))
+		@chmod($cachedir_temp, 0777);
+
+	if (!is_writable($cachedir_temp))
+		print_error('Error: Unable to obtain write access to "cache".', true);
+
+	if (!file_exists($modSettings['theme_dir'] . '/languages/index.' . $upcontext['language'] . '.php') && !isset($modSettings['smfVersion']) && !isset($_GET['lang']))
+		print_error('Error: Unable to find language files!', true);
+	else
+	{
+		$temp = substr(@implode('', @file($modSettings['theme_dir'] . '/languages/index.' . $upcontext['language'] . '.php')), 0, 4096);
+		preg_match('~(?://|/\*)\s*Version:\s+(.+?);\s*index(?:[\s]{2}|\*/)~i', $temp, $match);
+
+		if (empty($match[1]) || $match[1] != SMF_LANG_VERSION)
+			print_error('Error: Language files out of date.', true);
+		if (!file_exists($modSettings['theme_dir'] . '/languages/Install.' . $upcontext['language'] . '.php'))
+			print_error('Error: Install language is missing for selected language.', true);
+
+		// Otherwise include it!
+		require_once($modSettings['theme_dir'] . '/languages/Install.' . $upcontext['language'] . '.php');
+	}
+
+	// Make sure we skip the HTML for login.
+	$_POST['upcont'] = true;
+	$upcontext['current_step'] = 1;
+}
+
+function print_error($message, $fatal = false)
+{
+	static $fp = null;
+
+	if ($fp === null)
+		$fp = fopen('php://stderr', 'wb');
+
+	fwrite($fp, $message . "\n");
+
+	if ($fatal)
+		exit;
+}
+
+function throw_error($message)
+{
+	global $upcontext;
+
+	$upcontext['error_msg'] = $message;
+	$upcontext['sub_template'] = 'error_message';
+
+	return false;
+}
+
+// Check files are writable - make them writable if necessary...
+function makeFilesWritable(&$files)
+{
+	global $upcontext, $boarddir;
+
+	if (empty($files))
+		return true;
+
+	$failure = false;
+	// On linux, it's easy - just use is_writable!
+	if (substr(__FILE__, 1, 2) != ':\\')
+	{
+		foreach ($files as $k => $file)
+		{
+			if (!is_writable($file))
+			{
+				@chmod($file, 0755);
+
+				// Well, 755 hopefully worked... if not, try 777.
+				if (!is_writable($file) && !@chmod($file, 0777))
+					$failure = true;
+				// Otherwise remove it as it's good!
+				else
+					unset($files[$k]);
+			}
+			else
+				unset($files[$k]);
+		}
+	}
+	// Windows is trickier.  Let's try opening for r+...
+	else
+	{
+		foreach ($files as $k => $file)
+		{
+			// Folders can't be opened for write... but the index.php in them can ;).
+			if (is_dir($file))
+				$file .= '/index.php';
+
+			// Funny enough, chmod actually does do something on windows - it removes the read only attribute.
+			@chmod($file, 0777);
+			$fp = @fopen($file, 'r+');
+
+			// Hmm, okay, try just for write in that case...
+			if (!$fp)
+				$fp = @fopen($file, 'w');
+
+			if (!$fp)
+				$failure = true;
+			else
+				unset($files[$k]);
+			@fclose($fp);
+		}
+	}
+
+	if (empty($files))
+		return true;
+
+	if (!isset($_SERVER))
+		return !$failure;
+
+	// What still needs to be done?
+	$upcontext['chmod']['files'] = $files;
+
+	// If it's windows it's a mess...
+	if ($failure && substr(__FILE__, 1, 2) == ':\\')
+	{
+		$upcontext['chmod']['ftp_error'] = 'total_mess';
+
+		return false;
+	}
+	// We're going to have to use... FTP!
+	elseif ($failure)
+	{
+		// Load any session data we might have...
+		if (!isset($_POST['ftp_username']) && isset($_SESSION['installer_temp_ftp']))
+		{
+			$upcontext['chmod']['server'] = $_SESSION['installer_temp_ftp']['server'];
+			$upcontext['chmod']['port'] = $_SESSION['installer_temp_ftp']['port'];
+			$upcontext['chmod']['username'] = $_SESSION['installer_temp_ftp']['username'];
+			$upcontext['chmod']['password'] = $_SESSION['installer_temp_ftp']['password'];
+			$upcontext['chmod']['path'] = $_SESSION['installer_temp_ftp']['path'];
+		}
+		// Or have we submitted?
+		elseif (isset($_POST['ftp_username']))
+		{
+			$upcontext['chmod']['server'] = $_POST['ftp_server'];
+			$upcontext['chmod']['port'] = $_POST['ftp_port'];
+			$upcontext['chmod']['username'] = $_POST['ftp_username'];
+			$upcontext['chmod']['password'] = $_POST['ftp_password'];
+			$upcontext['chmod']['path'] = $_POST['ftp_path'];
+		}
+
+		if (isset($upcontext['chmod']['username']))
+		{
+			$ftp = new ftp_connection($upcontext['chmod']['server'], $upcontext['chmod']['port'], $upcontext['chmod']['username'], $upcontext['chmod']['password']);
+
+			if ($ftp->error === false)
+			{
+				// Try it without /home/abc just in case they messed up.
+				if (!$ftp->chdir($upcontext['chmod']['path']))
+				{
+					$upcontext['chmod']['ftp_error'] = $ftp->last_message;
+					$ftp->chdir(preg_replace('~^/home[2]?/[^/]+?~', '', $upcontext['chmod']['path']));
+				}
+			}
+		}
+
+		if (!isset($ftp) || $ftp->error !== false)
+		{
+			if (!isset($ftp))
+				$ftp = new ftp_connection(null);
+			// Save the error so we can mess with listing...
+			elseif ($ftp->error !== false && !isset($upcontext['chmod']['ftp_error']))
+				$upcontext['chmod']['ftp_error'] = $ftp->last_message === null ? '' : $ftp->last_message;
+
+			list ($username, $detect_path, $found_path) = $ftp->detect_path(dirname(__FILE__));
+
+			if ($found_path || !isset($upcontext['chmod']['path']))
+				$upcontext['chmod']['path'] = $detect_path;
+
+			if (!isset($upcontext['chmod']['username']))
+				$upcontext['chmod']['username'] = $username;
+
+			return false;
+		}
+		else
+		{
+			// We want to do a relative path for FTP.
+			if (!in_array($upcontext['chmod']['path'], array('', '/')))
+			{
+				$ftp_root = strtr($boarddir, array($upcontext['chmod']['path'] => ''));
+				if (substr($ftp_root, -1) == '/' && ($upcontext['chmod']['path'] == '' || substr($upcontext['chmod']['path'], 0, 1) == '/'))
+				$ftp_root = substr($ftp_root, 0, -1);
+			}
+			else
+				$ftp_root = $boarddir;
+
+			// Save the info for next time!
+			$_SESSION['installer_temp_ftp'] = array(
+				'server' => $upcontext['chmod']['server'],
+				'port' => $upcontext['chmod']['port'],
+				'username' => $upcontext['chmod']['username'],
+				'password' => $upcontext['chmod']['password'],
+				'path' => $upcontext['chmod']['path'],
+				'root' => $ftp_root,
+			);
+
+			foreach ($files as $k => $file)
+			{
+				if (!is_writable($file))
+					$ftp->chmod($file, 0755);
+				if (!is_writable($file))
+					$ftp->chmod($file, 0777);
+
+				// Assuming that didn't work calculate the path without the boarddir.
+				if (!is_writable($file))
+				{
+					if (strpos($file, $boarddir) === 0)
+					{
+						$ftp_file = strtr($file, array($_SESSION['installer_temp_ftp']['root'] => ''));
+						$ftp->chmod($ftp_file, 0755);
+						if (!is_writable($file))
+							$ftp->chmod($ftp_file, 0777);
+						// Sometimes an extra slash can help...
+						$ftp_file = '/' . $ftp_file;
+						if (!is_writable($file))
+							$ftp->chmod($ftp_file, 0755);
+						if (!is_writable($file))
+							$ftp->chmod($ftp_file, 0777);
+					}
+				}
+
+				if (is_writable($file))
+					unset($files[$k]);
+			}
+
+			$ftp->close();
+		}
+	}
+
+	// What remains?
+	$upcontext['chmod']['files'] = $files;
+
+	if (empty($files))
+		return true;
+
+	return false;
+}
+
+/******************************************************************************
+******************* Templates are below this point ****************************
+******************************************************************************/
+
+// This is what is displayed if there's any chmod to be done. If not it returns nothing...
+function template_chmod()
+{
+	global $upcontext, $upgradeurl, $settings;
+
+	// Don't call me twice!
+	if (!empty($upcontext['chmod_called']))
+		return;
+
+	$upcontext['chmod_called'] = true;
+
+	// Nothing?
+	if (empty($upcontext['chmod']['files']) && empty($upcontext['chmod']['ftp_error']))
+		return;
+
+	//!!! Temporary!
+	$txt['error_ftp_no_connect'] = 'Unable to connect to FTP server with this combination of details.';
+	$txt['ftp_login'] = 'Your FTP connection information';
+	$txt['ftp_login_info'] = 'This web installer needs your FTP information in order to automate the installation for you.  Please note that none of this information is saved in your installation, it is just used to setup SMF.';
+	$txt['ftp_server'] = 'Server';
+	$txt['ftp_server_info'] = 'The address (often localhost) and port for your FTP server.';
+	$txt['ftp_port'] = 'Port';
+	$txt['ftp_username'] = 'Username';
+	$txt['ftp_username_info'] = 'The username to login with. <em>This will not be saved anywhere.</em>';
+	$txt['ftp_password'] = 'Password';
+	$txt['ftp_password_info'] = 'The password to login with. <em>This will not be saved anywhere.</em>';
+	$txt['ftp_path'] = 'Install Path';
+	$txt['ftp_path_info'] = 'This is the <em>relative</em> path you use in your FTP client <a href="' . $_SERVER['PHP_SELF'] . '?ftphelp" onclick="window.open(this.href, \'\', \'width=450,height=250\');return false;" target="_blank">(more help)</a>.';
+	$txt['ftp_path_found_info'] = 'The path in the box above was automatically detected.';
+	$txt['ftp_path_help'] = 'Your FTP path is the path you see when you log in to your FTP client.  It commonly starts with &quot;<tt>www</tt>&quot;, &quot;<tt>public_html</tt>&quot;, or &quot;<tt>httpdocs</tt>&quot; - but it should include the directory SMF is in too, such as &quot;/public_html/forum&quot;.  It is different from your URL and full path.<br /><br />Files in this path may be overwritten, so make sure it\'s correct.';
+	$txt['ftp_path_help_close'] = 'Close';
+	$txt['ftp_connect'] = 'Connect';
+
+	// Was it a problem with Windows?
+	if (!empty($upcontext['chmod']['ftp_error']) && $upcontext['chmod']['ftp_error'] == 'total_mess')
+	{
+		echo '
+			<div class="error_message">
+				<div style="color: red;">The following files need to be writable to continue the upgrade. Please ensure the Windows permissions are correctly set to allow this:</div>
+				<ul style="margin: 2.5ex; font-family: monospace;">
+				<li>' . implode('</li>
+				<li>', $upcontext['chmod']['files']). '</li>
+			</ul>
+			</div>';
+
+		return false;
+	}
+
+	echo '
+		<div class="panel">
+			<h2>Your FTP connection information</h2>
+			<h3>The upgrader can fix any issues with file permissions to make upgrading as simple as possible. Simply enter your connection information below or alternatively click <a href="#" onclick="warning_popup();">here</a> for a list of files which need to be changed.</h3>
+			<script type="text/javascript"><!-- // --><![CDATA[
+				function warning_popup()
+				{
+					popup = window.open(\'\',\'popup\',\'height=150,width=400,scrollbars=yes\');
+					var content = popup.document;
+					content.write(\'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">\n\');
+					content.write(\'<html xmlns="http://www.w3.org/1999/xhtml"', $upcontext['right_to_left'] ? ' dir="rtl"' : '', '>\n\t<head>\n\t\t<meta name="robots" content="noindex" />\n\t\t\');
+					content.write(\'<title>Warning</title>\n\t\t<link rel="stylesheet" type="text/css" href="', $settings['default_theme_url'], '/css/index.css" />\n\t</head>\n\t<body id="popup">\n\t\t\');
+					content.write(\'<div class="windowbg description">\n\t\t\t<h4>The following files needs to be made writable to continue:</h4>\n\t\t\t\');
+					content.write(\'<p>', implode('<br />\n\t\t\t', $upcontext['chmod']['files']), '</p>\n\t\t\t\');
+					content.write(\'<a href="javascript:self.close();">close</a>\n\t\t</div>\n\t</body>\n</html>\');
+					content.close();
+				}
+		// ]]></script>';
+
+	if (!empty($upcontext['chmod']['ftp_error']))
+		echo '
+			<div class="error_message">
+				<div style="color: red;">
+					The following error was encountered when trying to connect:<br />
+					<br />
+					<code>', $upcontext['chmod']['ftp_error'], '</code>
+				</div>
+			</div>
+			<br />';
+
+	if (empty($upcontext['chmod_in_form']))
+		echo '
+	<form action="', $upcontext['form_url'], '" method="post">';
+
+	echo '
+		<table width="520" cellspacing="0" cellpadding="0" border="0" align="center" style="margin-bottom: 1ex;">
+			<tr>
+				<td width="26%" valign="top" class="textbox"><label for="ftp_server">', $txt['ftp_server'], ':</label></td>
+				<td>
+					<div style="float: right; margin-right: 1px;"><label for="ftp_port" class="textbox"><strong>', $txt['ftp_port'], ':&nbsp;</strong></label> <input type="text" size="3" name="ftp_port" id="ftp_port" value="', isset($upcontext['chmod']['port']) ? $upcontext['chmod']['port'] : '21', '" class="input_text" /></div>
+					<input type="text" size="30" name="ftp_server" id="ftp_server" value="', isset($upcontext['chmod']['server']) ? $upcontext['chmod']['server'] : 'localhost', '" style="width: 70%;" class="input_text" />
+					<div style="font-size: smaller; margin-bottom: 2ex;">', $txt['ftp_server_info'], '</div>
+				</td>
+			</tr><tr>
+				<td width="26%" valign="top" class="textbox"><label for="ftp_username">', $txt['ftp_username'], ':</label></td>
+				<td>
+					<input type="text" size="50" name="ftp_username" id="ftp_username" value="', isset($upcontext['chmod']['username']) ? $upcontext['chmod']['username'] : '', '" style="width: 99%;" class="input_text" />
+					<div style="font-size: smaller; margin-bottom: 2ex;">', $txt['ftp_username_info'], '</div>
+				</td>
+			</tr><tr>
+				<td width="26%" valign="top" class="textbox"><label for="ftp_password">', $txt['ftp_password'], ':</label></td>
+				<td>
+					<input type="password" size="50" name="ftp_password" id="ftp_password" style="width: 99%;" class="input_password" />
+					<div style="font-size: smaller; margin-bottom: 3ex;">', $txt['ftp_password_info'], '</div>
+				</td>
+			</tr><tr>
+				<td width="26%" valign="top" class="textbox"><label for="ftp_path">', $txt['ftp_path'], ':</label></td>
+				<td style="padding-bottom: 1ex;">
+					<input type="text" size="50" name="ftp_path" id="ftp_path" value="', isset($upcontext['chmod']['path']) ? $upcontext['chmod']['path'] : '', '" style="width: 99%;" class="input_text" />
+					<div style="font-size: smaller; margin-bottom: 2ex;">', !empty($upcontext['chmod']['path']) ? $txt['ftp_path_found_info'] : $txt['ftp_path_info'], '</div>
+				</td>
+			</tr>
+		</table>
+
+		<div class="righttext" style="margin: 1ex;"><input type="submit" value="', $txt['ftp_connect'], '" class="button_submit" /></div>
+	</div>';
+
+	if (empty($upcontext['chmod_in_form']))
+		echo '
+	</form>';
+}
+
+function template_upgrade_above()
+{
+	global $modSettings, $txt, $smfsite, $settings, $upcontext, $upgradeurl;
+
+	echo '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml"', $upcontext['right_to_left'] ? ' dir="rtl"' : '', '>
+	<head>
+		<meta http-equiv="Content-Type" content="text/html; charset=', isset($txt['lang_character_set']) ? $txt['lang_character_set'] : 'ISO-8859-1', '" />
+		<meta name="robots" content="noindex" />
+		<title>', $txt['upgrade_upgrade_utility'], '</title>
+		<link rel="stylesheet" type="text/css" href="', $settings['default_theme_url'], '/css/index.css?fin20" />
+		<link rel="stylesheet" type="text/css" href="', $settings['default_theme_url'], '/css/install.css?fin20" />
+				<script type="text/javascript" src="', $settings['default_theme_url'], '/scripts/script.js"></script>
+		<script type="text/javascript"><!-- // --><![CDATA[
+			var smf_scripturl = \'', $upgradeurl, '\';
+			var smf_charset = \'', (empty($modSettings['global_character_set']) ? (empty($txt['lang_character_set']) ? 'ISO-8859-1' : $txt['lang_character_set']) : $modSettings['global_character_set']), '\';
+			var startPercent = ', $upcontext['overall_percent'], ';
+
+			// This function dynamically updates the step progress bar - and overall one as required.
+			function updateStepProgress(current, max, overall_weight)
+			{
+				// What out the actual percent.
+				var width = parseInt((current / max) * 100);
+				if (document.getElementById(\'step_progress\'))
+				{
+					document.getElementById(\'step_progress\').style.width = width + "%";
+					setInnerHTML(document.getElementById(\'step_text\'), width + "%");
+				}
+				if (overall_weight && document.getElementById(\'overall_progress\'))
+				{
+					overall_width = parseInt(startPercent + width * (overall_weight / 100));
+					document.getElementById(\'overall_progress\').style.width = overall_width + "%";
+					setInnerHTML(document.getElementById(\'overall_text\'), overall_width + "%");
+				}
+			}
+		// ]]></script>
+	</head>
+	<body>
+	<div id="header"><div class="frame">
+		<div id="top_section">
+			<h1 class="forumtitle">', $txt['upgrade_upgrade_utility'], '</h1>
+			<img id="smflogo" src="', $settings['default_theme_url'], '/images/smflogo.png" alt="Simple Machines Forum" title="Simple Machines Forum" />
+		</div>
+		<div id="upper_section" class="middletext flow_hidden">
+			<div class="user"></div>
+			<div class="news normaltext">
+			</div>
+		</div>
+	</div></div>
+	<div id="content_section"><div class="frame">
+		<div id="main_content_section">
+			<div id="main-steps">
+				<h2>', $txt['upgrade_progress'], '</h2>
+				<ul>';
+
+	foreach ($upcontext['steps'] as $num => $step)
+		echo '
+						<li class="', $num < $upcontext['current_step'] ? 'stepdone' : ($num == $upcontext['current_step'] ? 'stepcurrent' : 'stepwaiting'), '">', $txt['upgrade_step'], ' ', $step[0], ': ', $step[1], '</li>';
+
+	echo '
+					</ul>
+			</div>
+			<div style="float: left; width: 40%;">
+				<div style="font-size: 8pt; height: 12pt; border: 1px solid black; background-color: white; width: 50%; margin: auto;">
+					<div id="overall_text" style="color: #000; position: absolute; margin-left: -5em;">', $upcontext['overall_percent'], '%</div>
+					<div id="overall_progress" style="width: ', $upcontext['overall_percent'], '%; height: 12pt; z-index: 1; background-color: lime;">&nbsp;</div>
+					<div class="progress">', $txt['upgrade_overall_progress'], '</div>
+				</div>
+				';
+
+	if (isset($upcontext['step_progress']))
+		echo '
+				<div style="font-size: 8pt; height: 12pt; border: 1px solid black; background-color: white; width: 50%; margin: 5px auto; ">
+					<div id="step_text" style="color: #000; position: absolute; margin-left: -5em;">', $upcontext['step_progress'], '%</div>
+					<div id="step_progress" style="width: ', $upcontext['step_progress'], '%; height: 12pt; z-index: 1; background-color: #ffd000;">&nbsp;</div>
+					<div class="progress">', $txt['upgrade_step_progress'], '</div>
+				</div>
+				';
+
+	echo '
+				<div id="substep_bar_div" class="smalltext" style="display: ', isset($upcontext['substep_progress']) ? '' : 'none', ';">', isset($upcontext['substep_progress_name']) ? trim(strtr($upcontext['substep_progress_name'], array('.' => ''))) : '', ':</div>
+				<div id="substep_bar_div2" style="font-size: 8pt; height: 12pt; border: 1px solid black; background-color: white; width: 50%; margin: 5px auto; display: ', isset($upcontext['substep_progress']) ? '' : 'none', ';">
+					<div id="substep_text" style="color: #000; position: absolute; margin-left: -5em;">', isset($upcontext['substep_progress']) ? $upcontext['substep_progress'] : '', '%</div>
+				<div id="substep_progress" style="width: ', isset($upcontext['substep_progress']) ? $upcontext['substep_progress'] : 0, '%; height: 12pt; z-index: 1; background-color: #eebaf4;">&nbsp;</div>
+								</div>';
+
+	// How long have we been running this?
+	$elapsed = time() - $upcontext['started'];
+	$mins = (int) ($elapsed / 60);
+	$seconds = $elapsed - $mins * 60;
+	echo '
+								<div class="smalltext" style="padding: 5px; text-align: center;">', $txt['upgrade_time_elapsed'], ':
+									<span id="mins_elapsed">', $mins, '</span> ', $txt['upgrade_time_mins'], ', <span id="secs_elapsed">', $seconds, '</span> ', $txt['upgrade_time_secs'], '.
+								</div>';
+	echo '
+			</div>
+			<div id="main_screen" class="clear">
+				<h2>', $upcontext['page_title'], '</h2>
+				<div class="panel">
+					<div style="max-height: 360px; overflow: auto;">';
+}
+
+function template_upgrade_below()
+{
+	global $upcontext, $txt;
+
+	if (!empty($upcontext['pause']))
+		echo '
+								<em>', $txt['upgrade_incomplete'], '.</em><br />
+
+								<h2 style="margin-top: 2ex;">', $txt['upgrade_not_quite_done'], '</h2>
+								<h3>
+									', $txt['upgrade_paused_overload'], '
+								</h3>';
+
+	if (!empty($upcontext['custom_warning']))
+		echo '
+								<div style="margin: 2ex; padding: 2ex; border: 2px dashed #cc3344; color: black; background-color: #ffe4e9;">
+									<div style="float: left; width: 2ex; font-size: 2em; color: red;">!!</div>
+									<strong style="text-decoration: underline;">', $txt['upgrade_note'], '</strong><br />
+									<div style="padding-left: 6ex;">', $upcontext['custom_warning'], '</div>
+								</div>';
+
+	echo '
+								<div class="righttext" style="margin: 1ex;">';
+
+	if (!empty($upcontext['continue']))
+		echo '
+									<input type="submit" id="contbutt" name="contbutt" value="', $txt['upgrade_continue'], '"', $upcontext['continue'] == 2 ? ' disabled="disabled"' : '', ' class="button_submit" />';
+	if (!empty($upcontext['skip']))
+		echo '
+									<input type="submit" id="skip" name="skip" value="', $txt['upgrade_skip'], '" onclick="dontSubmit = true; document.getElementById(\'contbutt\').disabled = \'disabled\'; return true;" class="button_submit" />';
+
+	echo '
+								</div>
+							</form>
+						</div>
+				</div>
+			</div>
+		</div>
+	</div></div>
+	<div id="footer_section"><div class="frame" style="height: 40px;">
+		<div class="smalltext"><a href="https://www.simplemachines.org/" title="Simple Machines Forum" target="_blank" class="new_win">SMF &copy;2020, Simple Machines</a></div>
+	</div></div>
+	</body>
+</html>';
+
+	// Are we on a pause?
+	if (!empty($upcontext['pause']))
+	{
+		echo '
+		<script type="text/javascript"><!-- // --><![CDATA[
+			window.onload = doAutoSubmit;
+			var countdown = 3;
+			var dontSubmit = false;
+
+			function doAutoSubmit()
+			{
+				if (countdown == 0 && !dontSubmit)
+					document.upform.submit();
+				else if (countdown == -1)
+					return;
+
+				document.getElementById(\'contbutt\').value = "', $txt['upgrade_continue'], ' (" + countdown + ")";
+				countdown--;
+
+				setTimeout("doAutoSubmit();", 1000);
+			}
+		// ]]></script>';
+	}
+}
+
+function template_xml_above()
+{
+	global $upcontext;
+
+	echo '<', '?xml version="1.0" encoding="ISO-8859-1"?', '>
+	<smf>';
+
+	if (!empty($upcontext['get_data']))
+		foreach ($upcontext['get_data'] as $k => $v)
+			echo '
+		<get key="', $k, '">', $v, '</get>';
+}
+
+function template_xml_below()
+{
+	global $upcontext;
+
+	echo '
+		</smf>';
+}
+
+function template_error_message()
+{
+	global $upcontext;
+
+	echo '
+	<div class="error_message">
+		<div style="color: red;">
+			', $upcontext['error_msg'], '
+		</div>
+		<br />
+		<a href="', $_SERVER['PHP_SELF'], '">Click here to try again.</a>
+	</div>';
+}
+
+function template_welcome_message()
+{
+	global $upcontext, $modSettings, $upgradeurl, $disable_security, $settings, $txt, $smfsite;
+
+	echo '
+		<script type="text/javascript" src="' . $smfsite . '/current-version.js?version=' . SMF_VERSION . '"></script>
+		<script type="text/javascript" src="', $settings['default_theme_url'], '/scripts/sha1.js"></script>
+			<h3>', sprintf($txt['upgrade_ready_proceed'], SMF_VERSION), '</h3>
+	<form action="', $upcontext['form_url'], isset($_GET['skiplang']) ? ';skiplang' : '', '" method="post" name="upform" id="upform" ', empty($upcontext['disable_login_hashing']) ? ' onsubmit="hashLoginPassword(this, \'' . $upcontext['rid'] . '\');"' : '', '>
+		<div id="version_warning" style="margin: 2ex; padding: 2ex; border: 2px dashed #a92174; color: black; background-color: #fbbbe2; display: none;">
+			<div style="float: left; width: 2ex; font-size: 2em; color: red;">!!</div>
+			<strong style="text-decoration: underline;">', $txt['upgrade_warning'], '</strong><br />
+			<div style="padding-left: 6ex;">
+				', sprintf($txt['upgrade_warning_out_of_date'], SMF_VERSION), '
+			</div>
+		</div>';
+
+	$upcontext['chmod_in_form'] = true;
+	template_chmod();
+
+	// For large, pre 1.1 RC2 forums give them a warning about the possible impact of this upgrade!
+	if ($upcontext['is_large_forum'])
+		echo '
+		<div style="margin: 2ex; padding: 2ex; border: 2px dashed #cc3344; color: black; background-color: #ffe4e9;">
+			<div style="float: left; width: 2ex; font-size: 2em; color: red;">!!</div>
+			<strong style="text-decoration: underline;">', $txt['upgrade_warning'], '</strong><br />
+			<div style="padding-left: 6ex;">
+				', $txt['upgrade_warning_lots_data'], '
+			</div>
+		</div>';
+
+	// A warning message?
+	if (!empty($upcontext['warning']))
+		echo '
+		<div style="margin: 2ex; padding: 2ex; border: 2px dashed #cc3344; color: black; background-color: #ffe4e9;">
+			<div style="float: left; width: 2ex; font-size: 2em; color: red;">!!</div>
+			<strong style="text-decoration: underline;">', $txt['upgrade_warning'], '</strong><br />
+			<div style="padding-left: 6ex;">
+				', $upcontext['warning'], '
+			</div>
+		</div>';
+
+	// Paths are incorrect?
+	echo '
+		<div style="margin: 2ex; padding: 2ex; border: 2px dashed #804840; color: black; background-color: #fe5a44; ', (file_exists($settings['default_theme_dir'] . '/scripts/script.js') ? 'display: none;' : ''), '" id="js_script_missing_error">
+			<div style="float: left; width: 2ex; font-size: 2em; color: black;">!!</div>
+			<strong style="text-decoration: underline;">', $txt['upgrade_critical_error'], '</strong><br />
+			<div style="padding-left: 6ex;">
+				', $txt['upgrade_error_script_js'], '
+			</div>
+		</div>';
+
+	// Is there someone already doing this?
+	if (!empty($upcontext['user']['id']) && (time() - $upcontext['started'] < 72600 || time() - $upcontext['updated'] < 3600))
+	{
+		$ago = time() - $upcontext['started'];
+		if ($ago < 60)
+			$ago = $ago . ' seconds';
+		elseif ($ago < 3600)
+			$ago = (int) ($ago / 60) . ' minutes';
+		else
+			$ago = (int) ($ago / 3600) . ' hours';
+
+		$active = time() - $upcontext['updated'];
+		if ($active < 60)
+			$updated = $active . ' seconds';
+		elseif ($active < 3600)
+			$updated = (int) ($active / 60) . ' minutes';
+		else
+			$updated = (int) ($active / 3600) . ' hours';
+
+		echo '
+		<div style="margin: 2ex; padding: 2ex; border: 2px dashed #cc3344; color: black; background-color: #ffe4e9;">
+			<div style="float: left; width: 2ex; font-size: 2em; color: red;">!!</div>
+			<strong style="text-decoration: underline;">', $txt['upgrade_warning'], '</strong><br />
+			<div style="padding-left: 6ex;">
+				&quot;', $upcontext['user']['name'], '&quot; has been running the upgrade script for the last ', $ago, ' - and was last active ', $updated, ' ago.';
+
+		if ($active < 600)
+			echo '
+				We recommend that you do not run this script unless you are sure that ', $upcontext['user']['name'], ' has completed their upgrade.';
+
+		if ($active > $upcontext['inactive_timeout'])
+			echo '
+				<br /><br />You can choose to either run the upgrade again from the beginning - or alternatively continue from the last step reached during the last upgrade.';
+		else
+			echo '
+				<br /><br />This upgrade script cannot be run until ', $upcontext['user']['name'], ' has been inactive for at least ', ($upcontext['inactive_timeout'] > 120 ? round($upcontext['inactive_timeout'] / 60, 1) . ' minutes!' : $upcontext['inactive_timeout'] . ' seconds!');
+
+		echo '
+			</div>
+		</div>';
+	}
+
+	echo '
+			<strong>Admin Login: ', $disable_security ? '(DISABLED)' : '', '</strong>
+			<h3>For security purposes please login with your admin account to proceed with the upgrade.</h3>
+			<table>
+				<tr valign="top">
+					<td><strong ', $disable_security ? 'style="color: gray;"' : '', '>Username:</strong></td>
+					<td>
+						<input type="text" name="user" value="', !empty($upcontext['username']) ? $upcontext['username'] : '', '" ', $disable_security ? 'disabled="disabled"' : '', ' class="input_text" />';
+
+	if (!empty($upcontext['username_incorrect']))
+		echo '
+						<div class="smalltext" style="color: red;">Username Incorrect</div>';
+
+	echo '
+					</td>
+				</tr>
+				<tr valign="top">
+					<td><strong ', $disable_security ? 'style="color: gray;"' : '', '>Password:</strong></td>
+					<td>
+						<input type="password" name="passwrd" value=""', $disable_security ? ' disabled="disabled"' : '', ' class="input_password" />
+						<input type="hidden" name="hash_passwrd" value="" />';
+
+	if (!empty($upcontext['password_failed']))
+		echo '
+						<div class="smalltext" style="color: red;">Password Incorrect</div>';
+
+	echo '
+					</td>
+				</tr>';
+
+	// Can they continue?
+	if (!empty($upcontext['user']['id']) && time() - $upcontext['user']['updated'] >= $upcontext['inactive_timeout'] && $upcontext['user']['step'] > 1)
+	{
+		echo '
+				<tr>
+					<td colspan="2">
+						<label for="cont"><input type="checkbox" id="cont" name="cont" checked="checked" class="input_check" />Continue from step reached during last execution of upgrade script.</label>
+					</td>
+				</tr>';
+	}
+
+	echo '
+			</table><br />
+			<span class="smalltext">
+				<strong>Note:</strong> If necessary the above security check can be bypassed for users who may administrate a server but not have admin rights on the forum. In order to bypass the above check simply open &quot;upgrade.php&quot; in a text editor and replace &quot;$disable_security = 0;&quot; with &quot;$disable_security = 1;&quot; and refresh this page.
+			</span>
+			<input type="hidden" name="login_attempt" id="login_attempt" value="1" />
+			<input type="hidden" name="js_works" id="js_works" value="0" />';
+
+	// Say we want the continue button!
+	$upcontext['continue'] = !empty($upcontext['user']['id']) && time() - $upcontext['user']['updated'] < $upcontext['inactive_timeout'] ? 2 : 1;
+
+	// This defines whether javascript is going to work elsewhere :D
+	echo '
+		<script type="text/javascript"><!-- // --><![CDATA[
+			if (\'XMLHttpRequest\' in window && document.getElementById(\'js_works\'))
+				document.getElementById(\'js_works\').value = 1;
+
+			// Latest version?
+			function smfCurrentVersion()
+			{
+				var smfVer, yourVer;
+
+				if (!(\'smfVersion\' in window))
+					return;
+
+				window.smfVersion = window.smfVersion.replace(/SMF\s?/g, \'\');
+
+				smfVer = document.getElementById(\'smfVersion\');
+				yourVer = document.getElementById(\'yourVersion\');
+
+				setInnerHTML(smfVer, window.smfVersion);
+
+				var currentVersion = getInnerHTML(yourVer);
+				if (currentVersion < window.smfVersion)
+					document.getElementById(\'version_warning\').style.display = \'\';
+			}
+			addLoadEvent(smfCurrentVersion);
+
+			// This checks that the script file even exists!
+			if (typeof(smfSelectText) == \'undefined\')
+				document.getElementById(\'js_script_missing_error\').style.display = \'\';
+
+		// ]]></script>';
+}
+
+function template_upgrade_options()
+{
+	global $upcontext, $modSettings, $upgradeurl, $disable_security, $settings, $boarddir, $db_prefix, $mmessage, $mtitle, $db_type;
+
+	echo '
+			<h3>Before the upgrade gets underway please review the options below - and hit continue when you\'re ready to begin.</h3>
+			<form action="', $upcontext['form_url'], '" method="post" name="upform" id="upform">';
+
+	// Warning message?
+	if (!empty($upcontext['upgrade_options_warning']))
+		echo '
+		<div style="margin: 1ex; padding: 1ex; border: 1px dashed #cc3344; color: black; background-color: #ffe4e9;">
+			<div style="float: left; width: 2ex; font-size: 2em; color: red;">!!</div>
+			<strong style="text-decoration: underline;">Warning!</strong><br />
+			<div style="padding-left: 4ex;">
+				', $upcontext['upgrade_options_warning'], '
+			</div>
+		</div>';
+
+	echo '
+				<table cellpadding="1" cellspacing="0">
+					<tr valign="top">
+						<td width="2%">
+							<input type="checkbox" name="backup" id="backup" value="1"', $db_type != 'mysql' && $db_type != 'postgresql' ? ' disabled="disabled"' : '', ' class="input_check" />
+						</td>
+						<td width="100%">
+							<label for="backup">Backup tables in your database with the prefix &quot;backup_' . $db_prefix . '&quot;.</label>', isset($modSettings['smfVersion']) ? '' : ' (recommended!)', '
+						</td>
+					</tr>
+					<tr valign="top">
+						<td width="2%">
+							<input type="checkbox" name="maint" id="maint" value="1" checked="checked" class="input_check" />
+						</td>
+						<td width="100%">
+							<label for="maint">Put the forum into maintenance mode during upgrade.</label> <span class="smalltext">(<a href="#" onclick="document.getElementById(\'mainmess\').style.display = document.getElementById(\'mainmess\').style.display == \'\' ? \'none\' : \'\'">Customize</a>)</span>
+							<div id="mainmess" style="display: none;">
+								<strong class="smalltext">Maintenance Title: </strong><br />
+								<input type="text" name="maintitle" size="30" value="', htmlspecialchars($mtitle), '" class="input_text" /><br />
+								<strong class="smalltext">Maintenance Message: </strong><br />
+								<textarea name="mainmessage" rows="3" cols="50">', htmlspecialchars($mmessage), '</textarea>
+							</div>
+						</td>
+					</tr>
+					<tr valign="top">
+						<td width="2%">
+							<input type="checkbox" name="debug" id="debug" value="1" class="input_check" />
+						</td>
+						<td width="100%">
+							<label for="debug">Output extra debugging information</label>
+						</td>
+					</tr>
+					<tr valign="top">
+						<td width="2%">
+							<input type="checkbox" name="empty_error" id="empty_error" value="1" class="input_check" />
+						</td>
+						<td width="100%">
+							<label for="empty_error">Empty error log before upgrading</label>
+						</td>
+					</tr>
+					<tr valign="top">
+						<td width="2%">
+							<input type="checkbox" name="stats" id="stats" value="1"', empty($modSettings['allow_sm_stats']) && empty($modSettings['enable_sm_stats']) ? '' : ' checked="checked"', ' class="input_check" />
+						</td>
+						<td width="100%">
+							<label for="stats">
+								Allow Simple Machines to Collect Basic Stats Monthly.<br />
+								<span class="smalltext">If enabled, this will allow Simple Machines to visit your site once a month to collect basic statistics. This will help us make decisions as to which configurations to optimise the software for. For more information please visit our <a href="https://www.simplemachines.org/about/stats.php" target="_blank">info page</a>.</span>
+							</label>
+						</td>
+					</tr>
+				</table>
+				<input type="hidden" name="upcont" value="1" />';
+
+	// We need a normal continue button here!
+	$upcontext['continue'] = 1;
+}
+
+// Template for the database backup tool/
+function template_backup_database()
+{
+	global $upcontext, $modSettings, $upgradeurl, $disable_security, $settings, $support_js, $is_debug;
+
+	echo '
+			<h3>Please wait while a backup is created. For large forums this may take some time!</h3>';
+
+	echo '
+			<form action="', $upcontext['form_url'], '" name="upform" id="upform" method="post">
+			<input type="hidden" name="backup_done" id="backup_done" value="0" />
+			<strong>Completed <span id="tab_done">', $upcontext['cur_table_num'], '</span> out of ', $upcontext['table_count'], ' tables.</strong>
+			<span id="debuginfo"></span>';
+
+	// Dont any tables so far?
+	if (!empty($upcontext['previous_tables']))
+		foreach ($upcontext['previous_tables'] as $table)
+			echo '
+			<br />Completed Table: &quot;', $table, '&quot;.';
+
+	echo '
+			<h3 id="current_tab_div">Current Table: &quot;<span id="current_table">', $upcontext['cur_table_name'], '</span>&quot;</h3>
+			<br /><span id="commess" style="font-weight: bold; display: ', $upcontext['cur_table_num'] == $upcontext['table_count'] ? 'inline' : 'none', ';">Backup Complete! Click Continue to Proceed.</span>';
+
+	// Continue please!
+	$upcontext['continue'] = $support_js ? 2 : 1;
+
+	// If javascript allows we want to do this using XML.
+	if ($support_js)
+	{
+		echo '
+		<script type="text/javascript"><!-- // --><![CDATA[
+			var lastTable = ', $upcontext['cur_table_num'], ';
+			function getNextTables()
+			{
+				getXMLDocument(\'', $upcontext['form_url'], '&xml&substep=\' + lastTable, onBackupUpdate);
+			}
+
+			// Got an update!
+			function onBackupUpdate(oXMLDoc)
+			{
+				var sCurrentTableName = "";
+				var iTableNum = 0;
+				var sCompletedTableName = getInnerHTML(document.getElementById(\'current_table\'));
+				for (var i = 0; i < oXMLDoc.getElementsByTagName("table")[0].childNodes.length; i++)
+					sCurrentTableName += oXMLDoc.getElementsByTagName("table")[0].childNodes[i].nodeValue;
+				iTableNum = oXMLDoc.getElementsByTagName("table")[0].getAttribute("num");
+
+				// Update the page.
+				setInnerHTML(document.getElementById(\'tab_done\'), iTableNum);
+				setInnerHTML(document.getElementById(\'current_table\'), sCurrentTableName);
+				lastTable = iTableNum;
+				updateStepProgress(iTableNum, ', $upcontext['table_count'], ', ', $upcontext['step_weight'] * ((100 - $upcontext['step_progress']) / 100), ');';
+
+		// If debug flood the screen.
+		if ($is_debug)
+			echo '
+				setOuterHTML(document.getElementById(\'debuginfo\'), \'<br />Completed Table: &quot;\' + sCompletedTableName + \'&quot;.<span id="debuginfo"><\' + \'/span>\');';
+
+		echo '
+				// Get the next update...
+				if (iTableNum == ', $upcontext['table_count'], ')
+				{
+					document.getElementById(\'commess\').style.display = "";
+					document.getElementById(\'current_tab_div\').style.display = "none";
+					document.getElementById(\'contbutt\').disabled = 0;
+					document.getElementById(\'backup_done\').value = 1;
+				}
+				else
+					getNextTables();
+			}
+			getNextTables();
+		// ]]></script>';
+	}
+}
+
+function template_backup_xml()
+{
+	global $upcontext, $settings, $options, $txt;
+
+	echo '
+	<table num="', $upcontext['cur_table_num'], '">', $upcontext['cur_table_name'], '</table>';
+}
+
+// Here is the actual "make the changes" template!
+function template_database_changes()
+{
+	global $upcontext, $modSettings, $upgradeurl, $disable_security, $settings, $support_js, $is_debug, $timeLimitThreshold;
+
+	echo '
+		<h3>Executing database changes</h3>
+		<h4 style="font-style: italic;">Please be patient - this may take some time on large forums. The time elapsed increments from the server to show progress is being made!</h4>';
+
+	echo '
+		<form action="', $upcontext['form_url'], '&amp;filecount=', $upcontext['file_count'], '" name="upform" id="upform" method="post">
+		<input type="hidden" name="database_done" id="database_done" value="0" />';
+
+	// No javascript looks rubbish!
+	if (!$support_js)
+	{
+		foreach ($upcontext['actioned_items'] as $num => $item)
+		{
+			if ($num != 0)
+				echo ' Successful!';
+			echo '<br />' . $item;
+		}
+		if (!empty($upcontext['changes_complete']))
+			echo ' Successful!<br /><br /><span id="commess" style="font-weight: bold;">Database Updates Complete! Click Continue to Proceed.</span><br />';
+	}
+	else
+	{
+		// Tell them how many files we have in total.
+		if ($upcontext['file_count'] > 1)
+			echo '
+		<strong id="info1">Executing upgrade script <span id="file_done">', $upcontext['cur_file_num'], '</span> of ', $upcontext['file_count'], '.</strong>';
+
+		echo '
+		<h3 id="info2"><strong>Executing:</strong> &quot;<span id="cur_item_name">', $upcontext['current_item_name'], '</span>&quot; (<span id="item_num">', $upcontext['current_item_num'], '</span> of <span id="total_items"><span id="item_count">', $upcontext['total_items'], '</span>', $upcontext['file_count'] > 1 ? ' - of this script' : '', ')</span></h3>
+		<br /><span id="commess" style="font-weight: bold; display: ', !empty($upcontext['changes_complete']) || $upcontext['current_debug_item_num'] == $upcontext['debug_items'] ? 'inline' : 'none', ';">Database Updates Complete! Click Continue to Proceed.</span>';
+
+		if ($is_debug)
+		{
+			echo '
+			<div id="debug_section" style="height: 200px; overflow: auto;">
+			<span id="debuginfo"></span>
+			</div>';
+		}
+	}
+
+	// Place for the XML error message.
+	echo '
+		<div id="error_block" style="margin: 2ex; padding: 2ex; border: 2px dashed #cc3344; color: black; background-color: #ffe4e9; display: ', empty($upcontext['error_message']) ? 'none' : '', ';">
+			<div style="float: left; width: 2ex; font-size: 2em; color: red;">!!</div>
+			<strong style="text-decoration: underline;">Error!</strong><br />
+			<div style="padding-left: 6ex;" id="error_message">', isset($upcontext['error_message']) ? $upcontext['error_message'] : 'Unknown Error!', '</div>
+		</div>';
+
+	// We want to continue at some point!
+	$upcontext['continue'] = $support_js ? 2 : 1;
+
+	// If javascript allows we want to do this using XML.
+	if ($support_js)
+	{
+		echo '
+		<script type="text/javascript"><!-- // --><![CDATA[
+			var lastItem = ', $upcontext['current_debug_item_num'], ';
+			var sLastString = "', strtr($upcontext['current_debug_item_name'], array('"' => '&quot;')), '";
+			var iLastSubStepProgress = -1;
+			var curFile = ', $upcontext['cur_file_num'], ';
+			var totalItems = 0;
+			var prevFile = 0;
+			var retryCount = 0;
+			var testvar = 0;
+			var timeOutID = 0;
+			var getData = "";
+			var debugItems = ', $upcontext['debug_items'], ';
+			function getNextItem()
+			{
+				// We want to track this...
+				if (timeOutID)
+					clearTimeout(timeOutID);
+				timeOutID = window.setTimeout("retTimeout()", ', (10 * $timeLimitThreshold), '000);
+
+				getXMLDocument(\'', $upcontext['form_url'], '&xml&filecount=', $upcontext['file_count'], '&substep=\' + lastItem + getData, onItemUpdate);
+			}
+
+			// Got an update!
+			function onItemUpdate(oXMLDoc)
+			{
+				var sItemName = "";
+				var sDebugName = "";
+				var iItemNum = 0;
+				var iSubStepProgress = -1;
+				var iDebugNum = 0;
+				var bIsComplete = 0;
+				getData = "";
+
+				// We\'ve got something - so reset the timeout!
+				if (timeOutID)
+					clearTimeout(timeOutID);
+
+				// Assume no error at this time...
+				document.getElementById("error_block").style.display = "none";
+
+				// Are we getting some duff info?
+				if (!oXMLDoc.getElementsByTagName("item")[0])
+				{
+					// Too many errors?
+					if (retryCount > 15)
+					{
+						document.getElementById("error_block").style.display = "";
+						setInnerHTML(document.getElementById("error_message"), "Error retrieving information on step: " + (sDebugName == "" ? sLastString : sDebugName));';
+
+	if ($is_debug)
+		echo '
+						setOuterHTML(document.getElementById(\'debuginfo\'), \'<span style="color: red;">failed<\' + \'/span><span id="debuginfo"><\' + \'/span>\');';
+
+	echo '
+					}
+					else
+					{
+						retryCount++;
+						getNextItem();
+					}
+					return false;
+				}
+
+				// Never allow loops.
+				if (curFile == prevFile)
+				{
+					retryCount++;
+					if (retryCount > 10)
+					{
+						document.getElementById("error_block").style.display = "";
+						setInnerHTML(document.getElementById("error_message"), "Upgrade script appears to be going into a loop - step: " + sDebugName);';
+
+	if ($is_debug)
+		echo '
+						setOuterHTML(document.getElementById(\'debuginfo\'), \'<span style="color: red;">failed<\' + \'/span><span id="debuginfo"><\' + \'/span>\');';
+
+	echo '
+					}
+				}
+				retryCount = 0;
+
+				for (var i = 0; i < oXMLDoc.getElementsByTagName("item")[0].childNodes.length; i++)
+					sItemName += oXMLDoc.getElementsByTagName("item")[0].childNodes[i].nodeValue;
+				for (var i = 0; i < oXMLDoc.getElementsByTagName("debug")[0].childNodes.length; i++)
+					sDebugName += oXMLDoc.getElementsByTagName("debug")[0].childNodes[i].nodeValue;
+				for (var i = 0; i < oXMLDoc.getElementsByTagName("get").length; i++)
+				{
+					getData += "&" + oXMLDoc.getElementsByTagName("get")[i].getAttribute("key") + "=";
+					for (var j = 0; j < oXMLDoc.getElementsByTagName("get")[i].childNodes.length; j++)
+					{
+						getData += oXMLDoc.getElementsByTagName("get")[i].childNodes[j].nodeValue;
+					}
+				}
+
+				iItemNum = oXMLDoc.getElementsByTagName("item")[0].getAttribute("num");
+				iDebugNum = parseInt(oXMLDoc.getElementsByTagName("debug")[0].getAttribute("num"));
+				bIsComplete = parseInt(oXMLDoc.getElementsByTagName("debug")[0].getAttribute("complete"));
+				iSubStepProgress = parseFloat(oXMLDoc.getElementsByTagName("debug")[0].getAttribute("percent"));
+				sLastString = sDebugName + " (Item: " + iDebugNum + ")";
+
+				curFile = parseInt(oXMLDoc.getElementsByTagName("file")[0].getAttribute("num"));
+				debugItems = parseInt(oXMLDoc.getElementsByTagName("file")[0].getAttribute("debug_items"));
+				totalItems = parseInt(oXMLDoc.getElementsByTagName("file")[0].getAttribute("items"));
+
+				// If we have an error we haven\'t completed!
+				if (oXMLDoc.getElementsByTagName("error")[0] && bIsComplete)
+					iDebugNum = lastItem;
+
+				// Do we have the additional progress bar?
+				if (iSubStepProgress != -1)
+				{
+					document.getElementById("substep_bar_div").style.display = "";
+					document.getElementById("substep_bar_div2").style.display = "";
+					document.getElementById("substep_progress").style.width = iSubStepProgress + "%";
+					setInnerHTML(document.getElementById("substep_text"), iSubStepProgress + "%");
+					setInnerHTML(document.getElementById("substep_bar_div"), sDebugName.replace(/\./g, "") + ":");
+				}
+				else
+				{
+					document.getElementById("substep_bar_div").style.display = "none";
+					document.getElementById("substep_bar_div2").style.display = "none";
+				}
+
+				// Move onto the next item?
+				if (bIsComplete)
+					lastItem = iDebugNum;
+				else
+					lastItem = iDebugNum - 1;
+
+				// Are we finished?
+				if (bIsComplete && iDebugNum == -1 && curFile >= ', $upcontext['file_count'], ')
+				{';
+
+		if ($is_debug)
+			echo '
+					document.getElementById(\'debug_section\').style.display = "none";';
+
+		echo '
+
+					document.getElementById(\'commess\').style.display = "";
+					document.getElementById(\'contbutt\').disabled = 0;
+					document.getElementById(\'database_done\').value = 1;';
+
+		if ($upcontext['file_count'] > 1)
+			echo '
+					document.getElementById(\'info1\').style.display = "none";';
+
+		echo '
+					document.getElementById(\'info2\').style.display = "none";
+					updateStepProgress(100, 100, ', $upcontext['step_weight'] * ((100 - $upcontext['step_progress']) / 100), ');
+					return true;
+				}
+				// Was it the last step in the file?
+				else if (bIsComplete && iDebugNum == -1)
+				{
+					lastItem = 0;
+					prevFile = curFile;';
+
+		if ($is_debug)
+			echo '
+					setOuterHTML(document.getElementById(\'debuginfo\'), \'Moving to next script file...done<br /><span id="debuginfo"><\' + \'/span>\');';
+
+		echo '
+					getNextItem();
+					return true;
+				}';
+
+		// If debug scroll the screen.
+		if ($is_debug)
+			echo '
+				if (iLastSubStepProgress == -1)
+				{
+					// Give it consistent dots.
+					dots = sDebugName.match(/\./g);
+					numDots = dots ? dots.length : 0;
+					for (var i = numDots; i < 3; i++)
+						sDebugName += ".";
+					setOuterHTML(document.getElementById(\'debuginfo\'), sDebugName + \'<span id="debuginfo"><\' + \'/span>\');
+				}
+				iLastSubStepProgress = iSubStepProgress;
+
+				if (bIsComplete)
+					setOuterHTML(document.getElementById(\'debuginfo\'), \'done<br /><span id="debuginfo"><\' + \'/span>\');
+				else
+					setOuterHTML(document.getElementById(\'debuginfo\'), \'...<span id="debuginfo"><\' + \'/span>\');
+
+				if (document.getElementById(\'debug_section\').scrollHeight)
+					document.getElementById(\'debug_section\').scrollTop = document.getElementById(\'debug_section\').scrollHeight';
+
+		echo '
+				// Update the page.
+				setInnerHTML(document.getElementById(\'item_num\'), iItemNum);
+				setInnerHTML(document.getElementById(\'cur_item_name\'), sItemName);';
+
+		if ($upcontext['file_count'] > 1)
+		{
+			echo '
+				setInnerHTML(document.getElementById(\'file_done\'), curFile);
+				setInnerHTML(document.getElementById(\'item_count\'), totalItems);';
+		}
+
+		echo '
+				// Is there an error?
+				if (oXMLDoc.getElementsByTagName("error")[0])
+				{
+					var sErrorMsg = "";
+					for (var i = 0; i < oXMLDoc.getElementsByTagName("error")[0].childNodes.length; i++)
+						sErrorMsg += oXMLDoc.getElementsByTagName("error")[0].childNodes[i].nodeValue;
+					document.getElementById("error_block").style.display = "";
+					setInnerHTML(document.getElementById("error_message"), sErrorMsg);
+					return false;
+				}
+
+				// Get the progress bar right.
+				barTotal = debugItems * ', $upcontext['file_count'], ';
+				barDone = (debugItems * (curFile - 1)) + lastItem;
+
+				updateStepProgress(barDone, barTotal, ', $upcontext['step_weight'] * ((100 - $upcontext['step_progress']) / 100), ');
+
+				// Finally - update the time here as it shows the server is responding!
+				curTime = new Date();
+				iElapsed = (curTime.getTime() / 1000 - ', $upcontext['started'], ');
+				mins = parseInt(iElapsed / 60);
+				secs = parseInt(iElapsed - mins * 60);
+				setInnerHTML(document.getElementById("mins_elapsed"), mins);
+				setInnerHTML(document.getElementById("secs_elapsed"), secs);
+
+				getNextItem();
+				return true;
+			}
+
+			// What if we timeout?!
+			function retTimeout(attemptAgain)
+			{
+				// Oh noes...
+				if (!attemptAgain)
+				{
+					document.getElementById("error_block").style.display = "";
+					setInnerHTML(document.getElementById("error_message"), "Server has not responded for ', ($timeLimitThreshold * 10), ' seconds. It may be worth waiting a little longer or otherwise please click <a href=\"#\" onclick=\"retTimeout(true); return false;\">here<" + "/a> to try this step again");
+				}
+				else
+				{
+					document.getElementById("error_block").style.display = "none";
+					getNextItem();
+				}
+			}';
+
+		// Start things off assuming we've not errored.
+		if (empty($upcontext['error_message']))
+			echo '
+			getNextItem();';
+
+		echo '
+		// ]]></script>';
+	}
+	return;
+}
+
+function template_database_xml()
+{
+	global $upcontext, $settings, $options, $txt;
+
+	echo '
+	<file num="', $upcontext['cur_file_num'], '" items="', $upcontext['total_items'], '" debug_items="', $upcontext['debug_items'], '">', $upcontext['cur_file_name'], '</file>
+	<item num="', $upcontext['current_item_num'], '">', $upcontext['current_item_name'], '</item>
+	<debug num="', $upcontext['current_debug_item_num'], '" percent="', isset($upcontext['substep_progress']) ? $upcontext['substep_progress'] : '-1', '" complete="', empty($upcontext['completed_step']) ? 0 : 1, '">', $upcontext['current_debug_item_name'], '</debug>';
+
+	if (!empty($upcontext['error_message']))
+		echo '
+	<error>', $upcontext['error_message'], '</error>';
+}
+
+function template_clean_mods()
+{
+	global $upcontext, $modSettings, $upgradeurl, $disable_security, $settings, $boarddir, $db_prefix, $boardurl;
+
+	$upcontext['chmod_in_form'] = true;
+
+	echo '
+	<h3>SMF has detected some packages which were installed but not fully removed prior to upgrade. We recommend you remove the following mods and reinstall upon completion of the upgrade.</h3>
+	<form action="', $upcontext['form_url'], '&amp;ssi=1" name="upform" id="upform" method="post">';
+
+	// In case it's required.
+	template_chmod();
+
+	echo '
+		<table width="90%" align="center" cellspacing="1" cellpadding="2" style="background-color: black;">
+			<tr style="background-color: #eeeeee;">
+				<td width="40%"><strong>Modification Name</strong></td>
+				<td width="10%" align="center"><strong>Version</strong></td>
+				<td width="15%"><strong>Files Affected</strong></td>
+				<td width="20%"><strong>Status</strong></td>
+				<td width="5%" align="center"><strong>Fix?</strong></td>
+			</tr>';
+
+	foreach ($upcontext['packages'] as $package)
+	{
+		echo '
+			<tr style="background-color: #cccccc;">
+				<td width="40%">', $package['name'], '</td>
+				<td width="10%">', $package['version'], '</td>
+				<td width="15%">', $package['file_count'], ' <span class="smalltext">[<a href="#" onclick="alert(\'The following files are affected by this modification:\\n\\n', strtr(implode('<br />', $package['files']), array('\\' => '\\\\', '<br />' => '\\n')), '\'); return false;">details</a>]</td>
+				<td width="20%"><span style="font-weight: bold; color: ', $package['color'], '">', $package['status'], '</span></td>
+				<td width="5%" align="center">
+					<input type="hidden" name="remove[', $package['id'], ']" value="0" />
+					<input type="checkbox" name="remove[', $package['id'], ']"', $package['color'] == 'green' ? ' disabled="disabled"' : '', ' class="input_check" />
+				</td>
+			</tr>';
+	}
+	echo '
+		</table>
+		<input type="hidden" name="cleandone" value="1" />';
+
+	// Files to make writable?
+	if (!empty($upcontext['writable_files']))
+		echo '
+		<input type="hidden" name="writable_files" value="', base64_encode(serialize($upcontext['writable_files'])), '" />';
+
+	// We'll want a continue button...
+	if (empty($upcontext['chmod']['files']))
+		$upcontext['continue'] = 1;
+}
+
+// Finished with the mods - let them know what we've done.
+function template_cleanup_done()
+{
+	global $upcontext, $modSettings, $upgradeurl, $disable_security, $settings, $boarddir, $db_prefix, $boardurl;
+
+	echo '
+	<h3>SMF has attempted to fix and reinstall mods as required. We recommend you visit the package manager upon completing upgrade to check the status of your modifications.</h3>
+	<form action="', $upcontext['form_url'], '&amp;ssi=1" name="upform" id="upform" method="post">
+		<table width="90%" align="center" cellspacing="1" cellpadding="2" style="background-color: black;">
+			<tr style="background-color: #eeeeee;">
+				<td width="100%"><strong>Actions Completed:</strong></td>
+			</tr>';
+
+	foreach ($upcontext['packages'] as $package)
+	{
+		echo '
+			<tr style="background-color: #cccccc;">
+				<td>', $package['name'], '... <span style="font-weight: bold; color: ', $package['color'], ';">', $package['result'], '</span></td>
+			</tr>';
+	}
+	echo '
+		</table>
+		<input type="hidden" name="cleandone2" value="1" />';
+
+	// We'll want a continue button...
+	$upcontext['continue'] = 1;
+}
+
+// Do they want to upgrade their templates?
+function template_upgrade_templates()
+{
+	global $upcontext, $modSettings, $upgradeurl, $disable_security, $settings, $boarddir, $db_prefix, $boardurl;
+
+	echo '
+	<h3>There have been numerous language and template changes since the previous version of SMF. On this step the upgrader can attempt to automatically make these changes in your templates to save you from doing so manually.</h3>
+	<form action="', $upcontext['form_url'], '&amp;ssi=1', $upcontext['is_test'] ? '' : ';forreal=1', '" name="upform" id="upform" method="post">';
+
+	// Any files need to be writable?
+	$upcontext['chmod_in_form'] = true;
+	template_chmod();
+
+	// Language/Template files need an update?
+	if ($upcontext['temp_progress'] == 0 && !$upcontext['is_test'] && (!empty($upcontext['languages']) || !empty($upcontext['themes'])))
+	{
+		echo '
+		The following template files will be updated to ensure they are compatible with this version of SMF. Note that this can only fix a limited number of compatibility issues and in general you should seek out the latest version of these themes/language files.
+		<table width="90%" align="center" cellspacing="1" cellpadding="2" style="background-color: black;">
+			<tr style="background-color: #eeeeee;">
+				<td width="80%"><strong>Area</strong></td>
+				<td width="20%" align="center"><strong>Changes Required</strong></td>
+			</tr>';
+
+		foreach ($upcontext['languages'] as $language)
+		{
+			echo '
+				<tr style="background-color: #cccccc;">
+					<td width="80%">
+						&quot;', $language['name'], '&quot; Language Pack
+						<div class="smalltext">(';
+
+			foreach ($language['files'] as $k => $file)
+				echo $file['name'], $k + 1 != count($language['files']) ? ', ' : ')';
+
+			echo '
+						</div>
+					</td>
+					<td width="20%" align="center">', $language['edit_count'] == 0 ? 1 : $language['edit_count'], '</td>
+				</tr>';
+		}
+
+		foreach ($upcontext['themes'] as $theme)
+		{
+			echo '
+				<tr style="background-color: #CCCCCC;">
+					<td width="80%">
+						&quot;', $theme['name'], '&quot; Theme
+						<div class="smalltext">(';
+
+			foreach ($theme['files'] as $k => $file)
+				echo $file['name'], $k + 1 != count($theme['files']) ? ', ' : ')';
+
+			echo '
+						</div>
+					</td>
+					<td width="20%" align="center">', $theme['edit_count'] == 0 ? 1 : $theme['edit_count'], '</td>
+				</tr>';
+		}
+
+		echo '
+		</table>';
+	}
+	else
+	{
+		$langFiles = 0;
+		$themeFiles = 0;
+		if (!empty($upcontext['languages']))
+			foreach ($upcontext['languages'] as $lang)
+				$langFiles += count($lang['files']);
+		if (!empty($upcontext['themes']))
+			foreach ($upcontext['themes'] as $theme)
+				$themeFiles += count($theme['files']);
+		echo sprintf('Found <strong>%d</strong> language files and <strong>%d</strong> templates requiring an update so far.', $langFiles, $themeFiles) . '<br />';
+
+		// What we're currently doing?
+		if (!empty($upcontext['current_message']))
+			echo '
+				', $upcontext['current_message'];
+	}
+
+	echo '
+		<input type="hidden" name="uptempdone" value="1" />';
+
+	if (!empty($upcontext['languages']))
+		echo '
+		<input type="hidden" name="languages" value="', base64_encode(serialize($upcontext['languages'])), '" />';
+	if (!empty($upcontext['themes']))
+		echo '
+		<input type="hidden" name="themes" value="', base64_encode(serialize($upcontext['themes'])), '" />';
+	if (!empty($upcontext['writable_files']))
+		echo '
+		<input type="hidden" name="writable_files" value="', base64_encode(serialize($upcontext['writable_files'])), '" />';
+
+	// Offer them the option to upgrade from YaBB SE?
+	if (!empty($upcontext['can_upgrade_yabbse']))
+		echo '
+		<br /><label for="conv"><input type="checkbox" name="conv" id="conv" value="1" class="input_check" /> Convert the existing YaBB SE template and set it as default.</label><br />';
+
+	// We'll want a continue button... assuming chmod is OK (Otherwise let them use connect!)
+	if (empty($upcontext['chmod']['files']) || $upcontext['is_test'])
+		$upcontext['continue'] = 1;
+}
+
+function template_upgrade_complete()
+{
+	global $upcontext, $modSettings, $upgradeurl, $disable_security, $settings, $boarddir, $db_prefix, $boardurl;
+
+	echo '
+	<h3>That wasn\'t so hard, was it?  Now you are ready to use <a href="', $boardurl, '/index.php">your installation of SMF</a>.  Hope you like it!</h3>
+	<form action="', $boardurl, '/index.php">';
+
+	if (!empty($upcontext['can_delete_script']))
+		echo '
+			<label for="delete_self"><input type="checkbox" id="delete_self" onclick="doTheDelete(this);" class="input_check" /> Delete this upgrade.php and its data files now.</label> <em>(doesn\'t work on all servers.)</em>
+			<script type="text/javascript"><!-- // --><![CDATA[
+				function doTheDelete(theCheck)
+				{
+					var theImage = document.getElementById ? document.getElementById("delete_upgrader") : document.all.delete_upgrader;
+
+					theImage.src = "', $upgradeurl, '?delete=1&ts_" + (new Date().getTime());
+					theCheck.disabled = true;
+				}
+			// ]]></script>
+			<img src="', $settings['default_theme_url'], '/images/blank.gif" alt="" id="delete_upgrader" /><br />';
+
+	echo '<br />
+			If you had any problems with this upgrade, or have any problems using SMF, please don\'t hesitate to <a href="https://www.simplemachines.org/community/index.php">look to us for assistance</a>.<br />
+			<br />
+			Best of luck,<br />
+			Simple Machines';
+}
+
+?>
\ No newline at end of file
diff --git a/upgrade_1-0.sql b/upgrade_1-0.sql
new file mode 100644
index 0000000..85a7f17
--- /dev/null
+++ b/upgrade_1-0.sql
@@ -0,0 +1,2021 @@
+/* ATTENTION: You don't need to run or use this file!  The upgrade.php script does everything for you! */
+
+/******************************************************************************/
+--- Creating new tables and inserting default data...
+/******************************************************************************/
+
+---# Creating "themes"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}themes (
+	ID_MEMBER mediumint(8) NOT NULL default '0',
+	ID_THEME tinyint(4) unsigned NOT NULL default '1',
+	variable tinytext NOT NULL default '',
+	value text NOT NULL default '',
+	PRIMARY KEY (ID_MEMBER, ID_THEME, variable(30))
+) ENGINE=MyISAM;
+
+ALTER TABLE {$db_prefix}themes
+CHANGE COLUMN ID_MEMBER ID_MEMBER mediumint(8) NOT NULL default '0';
+
+ALTER TABLE {$db_prefix}themes
+CHANGE COLUMN value value text NOT NULL default '';
+
+INSERT IGNORE INTO {$db_prefix}themes
+	(ID_MEMBER, ID_THEME, variable, value)
+VALUES (0, 1, 'name', 'SMF Default Theme'),
+	(0, 1, 'theme_url', '{$boardurl}/Themes/default'),
+	(0, 1, 'images_url', '{$boardurl}/Themes/default/images'),
+	(0, 1, 'theme_dir', '{$sboarddir}/Themes/default'),
+	(0, 1, 'allow_no_censored', '0'),
+	(0, 1, 'additional_options_collapsable', '1'),
+	(0, 2, 'name', 'Classic YaBB SE Theme'),
+	(0, 2, 'theme_url', '{$boardurl}/Themes/classic'),
+	(0, 2, 'images_url', '{$boardurl}/Themes/classic/images'),
+	(0, 2, 'theme_dir', '{$sboarddir}/Themes/classic');
+---#
+
+---# Creating "collapsed_categories"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}collapsed_categories (
+	ID_CAT tinyint(4) unsigned NOT NULL default '0',
+	ID_MEMBER mediumint(8) unsigned NOT NULL default '0',
+	PRIMARY KEY (ID_CAT, ID_MEMBER)
+) ENGINE=MyISAM;
+---#
+
+---# Creating and verifying "permissions"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}permissions (
+	ID_GROUP smallint(6) NOT NULL default '0',
+	permission varchar(30) NOT NULL default '',
+	addDeny tinyint(4) NOT NULL default '1',
+	PRIMARY KEY (ID_GROUP, permission)
+) ENGINE=MyISAM;
+
+ALTER TABLE {$db_prefix}permissions
+ADD addDeny tinyint(4) NOT NULL default '1';
+ALTER TABLE {$db_prefix}permissions
+CHANGE COLUMN permission permission varchar(30) NOT NULL default '';
+
+UPDATE IGNORE {$db_prefix}permissions
+SET
+	permission = REPLACE(permission, 'profile_own_identity', 'profile_identity_own'),
+	permission = REPLACE(permission, 'profile_any_identity', 'profile_identity_any'),
+	permission = REPLACE(permission, 'profile_own_extra', 'profile_extra_own'),
+	permission = REPLACE(permission, 'profile_any_extra', 'profile_extra_any'),
+	permission = REPLACE(permission, 'profile_own_title', 'profile_title_own'),
+	permission = REPLACE(permission, 'profile_any_title', 'profile_title_any'),
+	permission = REPLACE(permission, 'im_read', 'pm_read'),
+	permission = REPLACE(permission, 'im_send', 'pm_send');
+---#
+
+---# Inserting data into "permissions"...
+INSERT INTO {$db_prefix}permissions
+	(ID_GROUP, permission)
+VALUES (-1, 'search_posts'), (-1, 'calendar_view'), (-1, 'view_stats'), (-1, 'profile_view_any'),
+	(2, 'calendar_post'), (2, 'calendar_edit_any'), (2, 'calendar_edit_own');
+---#
+
+---# Creating and verifying "board_permissions"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}board_permissions (
+	ID_GROUP smallint(6) NOT NULL default '0',
+	ID_BOARD smallint(5) unsigned NOT NULL default '0',
+	permission varchar(30) NOT NULL default '',
+	addDeny tinyint(4) NOT NULL default '1',
+	PRIMARY KEY (ID_GROUP, ID_BOARD, permission)
+) ENGINE=MyISAM;
+
+ALTER TABLE {$db_prefix}board_permissions
+ADD addDeny tinyint(4) NOT NULL default '1';
+ALTER TABLE {$db_prefix}board_permissions
+CHANGE COLUMN permission permission varchar(30) NOT NULL default '';
+---#
+
+---# Inserting data into "board_permissions"...
+INSERT INTO {$db_prefix}board_permissions
+	(ID_GROUP, ID_BOARD, permission)
+VALUES (-1, 0, 'poll_view'), (3, 0, 'make_sticky'), (3, 0, 'lock_any'),
+	(3, 0, 'remove_any'), (3, 0, 'move_any'), (3, 0, 'merge_any'), (3, 0, 'split_any'),
+	(3, 0, 'delete_any'), (3, 0, 'modify_any'), (2, 0, 'make_sticky'), (2, 0, 'lock_any'),
+	(2, 0, 'remove_any'), (2, 0, 'move_any'), (2, 0, 'merge_any'), (2, 0, 'split_any'),
+	(2, 0, 'delete_any'), (2, 0, 'modify_any'), (2, 0, 'poll_lock_any'), (2, 0, 'poll_lock_any'),
+	(2, 0, 'poll_add_any'), (2, 0, 'poll_remove_any'), (2, 0, 'poll_remove_any');
+INSERT IGNORE INTO {$db_prefix}board_permissions
+	(ID_GROUP, ID_BOARD, permission)
+VALUES (3, 0, 'moderate_board'), (2, 0, 'moderate_board');
+---#
+
+---# Creating "moderators"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}moderators (
+	ID_BOARD smallint(5) unsigned NOT NULL default '0',
+	ID_MEMBER mediumint(8) unsigned NOT NULL default '0',
+	PRIMARY KEY (ID_BOARD, ID_MEMBER)
+) ENGINE=MyISAM;
+---#
+
+---# Creating "attachments"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}attachments (
+	ID_ATTACH int(11) unsigned NOT NULL auto_increment,
+	ID_MSG int(10) unsigned NOT NULL default '0',
+	ID_MEMBER int(10) unsigned NOT NULL default '0',
+	filename tinytext NOT NULL default '',
+	size int(10) unsigned NOT NULL default '0',
+	downloads mediumint(8) unsigned NOT NULL default '0',
+	PRIMARY KEY (ID_ATTACH),
+	UNIQUE ID_MEMBER (ID_MEMBER, ID_ATTACH),
+	KEY ID_MSG (ID_MSG)
+) ENGINE=MyISAM;
+---#
+
+---# Creating "log_notify"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_notify (
+	ID_MEMBER mediumint(8) unsigned NOT NULL default '0',
+	ID_TOPIC mediumint(8) unsigned NOT NULL default '0',
+	ID_BOARD smallint(5) unsigned NOT NULL default '0',
+	sent tinyint(1) unsigned NOT NULL default '0',
+	PRIMARY KEY (ID_MEMBER, ID_TOPIC, ID_BOARD)
+) ENGINE=MyISAM;
+---#
+
+---# Creating "log_polls"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_polls (
+	ID_POLL mediumint(8) unsigned NOT NULL default '0',
+	ID_MEMBER mediumint(8) unsigned NOT NULL default '0',
+	ID_CHOICE tinyint(4) unsigned NOT NULL default '0',
+	PRIMARY KEY (ID_POLL, ID_MEMBER, ID_CHOICE)
+) ENGINE=MyISAM;
+---#
+
+---# Creating "log_actions"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_actions (
+	ID_ACTION int(10) unsigned NOT NULL auto_increment,
+	logTime int(10) unsigned NOT NULL default '0',
+	ID_MEMBER mediumint(8) unsigned NOT NULL default '0',
+	IP tinytext NOT NULL default '',
+	action varchar(30) NOT NULL default '',
+	extra text NOT NULL default '',
+	PRIMARY KEY (ID_ACTION),
+	KEY logTime (logTime),
+	KEY ID_MEMBER (ID_MEMBER)
+) ENGINE=MyISAM;
+---#
+
+---# Creating "poll_choices"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}poll_choices (
+	ID_POLL mediumint(8) unsigned NOT NULL default '0',
+	ID_CHOICE tinyint(4) unsigned NOT NULL default '0',
+	label tinytext NOT NULL default '',
+	votes smallint(5) unsigned NOT NULL default '0',
+	PRIMARY KEY (ID_POLL, ID_CHOICE)
+) ENGINE=MyISAM;
+---#
+
+---# Creating "smileys"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}smileys (
+	id_smiley smallint(5) unsigned NOT NULL auto_increment,
+	code varchar(30) NOT NULL default '',
+	filename varchar(48) NOT NULL default '',
+	description varchar(80) NOT NULL default '',
+	smileyRow tinyint(4) unsigned NOT NULL default '0',
+	smileyOrder tinyint(4) unsigned NOT NULL default '0',
+	hidden tinyint(4) unsigned NOT NULL default '0',
+	PRIMARY KEY (id_smiley),
+	KEY smileyOrder (smileyOrder)
+) ENGINE=MyISAM;
+---#
+
+---# Loading default smileys...
+INSERT IGNORE INTO {$db_prefix}smileys
+	(id_smiley, code, filename, description, smileyOrder, hidden)
+VALUES (1, ':)', 'smiley.gif', 'Smiley', 0, 0),
+	(2, ';)', 'wink.gif', 'Wink', 1, 0),
+	(3, ':D', 'cheesy.gif', 'Cheesy', 2, 0),
+	(4, ';D', 'grin.gif', 'Grin', 3, 0),
+	(5, '>:(', 'angry.gif', 'Angry', 4, 0),
+	(6, ':(', 'sad.gif', 'Sad', 5, 0),
+	(7, ':o', 'shocked.gif', 'Shocked', 6, 0),
+	(8, '8)', 'cool.gif', 'Cool', 7, 0),
+	(9, '???', 'huh.gif', 'Huh', 8, 0),
+	(10, '::)', 'rolleyes.gif', 'Roll Eyes', 9, 0),
+	(11, ':P', 'tongue.gif', 'Tongue', 10, 0),
+	(12, ':-[', 'embarassed.gif', 'Embarrassed', 11, 0),
+	(13, ':-X', 'lipsrsealed.gif', 'Lips Sealed', 12, 0),
+	(14, ':-\\', 'undecided.gif', 'Undecided', 13, 0),
+	(15, ':-*', 'kiss.gif', 'Kiss', 14, 0),
+	(16, ':\'(', 'cry.gif', 'Cry', 15, 0),
+	(17, '>:D', 'evil.gif', 'Evil', 16, 1),
+	(18, '^-^', 'azn.gif', 'Azn', 17, 1),
+	(19, 'O0', 'afro.gif', 'Afro', 18, 1);
+---#
+
+---# Dropping "log_search" and recreating it...
+DROP TABLE IF EXISTS {$db_prefix}log_search;
+CREATE TABLE {$db_prefix}log_search (
+	ID_SEARCH tinyint(3) unsigned NOT NULL default '0',
+	ID_TOPIC mediumint(8) unsigned NOT NULL default '0',
+	ID_MSG int(10) unsigned NOT NULL default '0',
+	relevance smallint(5) unsigned NOT NULL default '0',
+	num_matches smallint(5) unsigned NOT NULL default '0',
+	PRIMARY KEY (ID_SEARCH, ID_TOPIC)
+) ENGINE=MyISAM;
+---#
+
+---# Dropping "sessions" and recreating it...
+DROP TABLE IF EXISTS {$db_prefix}sessions;
+CREATE TABLE {$db_prefix}sessions (
+	session_id char(32) NOT NULL,
+	last_update int(10) unsigned NOT NULL,
+	data text NOT NULL,
+	PRIMARY KEY (session_id)
+) ENGINE=MyISAM;
+---#
+
+---# Verifying "settings"...
+ALTER TABLE {$db_prefix}settings
+DROP PRIMARY KEY,
+ADD PRIMARY KEY (variable(30));
+---#
+
+/******************************************************************************/
+--- Converting activity logs...
+/******************************************************************************/
+
+---# Converting "log_online"...
+DROP TABLE IF EXISTS {$db_prefix}log_online;
+CREATE TABLE {$db_prefix}log_online (
+	session char(32) NOT NULL default '                                ',
+	logTime timestamp,
+	ID_MEMBER mediumint(8) unsigned NOT NULL default '0',
+	ip int(11) unsigned NOT NULL default '0',
+	url text NOT NULL default '',
+	PRIMARY KEY (session),
+	KEY online (logTime, ID_MEMBER),
+	KEY ID_MEMBER (ID_MEMBER)
+) ENGINE=MyISAM;
+---#
+
+---# Converting "log_floodcontrol"...
+DROP TABLE IF EXISTS {$db_prefix}log_floodcontrol;
+CREATE TABLE {$db_prefix}log_floodcontrol (
+	ip tinytext NOT NULL default '',
+	logTime int(10) unsigned NOT NULL default '0',
+	PRIMARY KEY (ip(16)),
+	KEY logTime (logTime)
+) ENGINE=MyISAM;
+---#
+
+---# Converting "log_karma"...
+DROP TABLE IF EXISTS {$db_prefix}log_karma;
+CREATE TABLE {$db_prefix}log_karma (
+	ID_TARGET mediumint(8) unsigned NOT NULL default '0',
+	ID_EXECUTOR mediumint(8) unsigned NOT NULL default '0',
+	logTime int(10) unsigned NOT NULL default '0',
+	action tinyint(4) NOT NULL default '0',
+	PRIMARY KEY (ID_TARGET, ID_EXECUTOR),
+	KEY logTime (logTime)
+) ENGINE=MyISAM;
+---#
+
+---# Retiring "log_clicks"...
+DROP TABLE IF EXISTS {$db_prefix}log_clicks;
+---#
+
+---# Converting "log_notify"...
+INSERT INTO {$db_prefix}log_notify
+SELECT ID_MEMBER, ID_TOPIC, 0, notificationSent
+FROM {$db_prefix}log_topics
+WHERE notificationSent != 0;
+
+ALTER TABLE {$db_prefix}log_topics
+DROP notificationSent;
+---#
+
+---# Converting "log_errors"...
+ALTER TABLE {$db_prefix}log_errors
+CHANGE COLUMN ID_ERROR ID_ERROR mediumint(8) unsigned NOT NULL auto_increment,
+ADD session char(32) NOT NULL default '                                ';
+---#
+
+---# Converting "log_boards"...
+---{
+$request = upgrade_query("
+	SELECT lmr.ID_BOARD, lmr.ID_MEMBER, lmr.logTime
+	FROM {$db_prefix}log_mark_read AS lmr
+		LEFT JOIN {$db_prefix}log_boards AS lb ON (lb.ID_BOARD = lmr.ID_BOARD AND lb.ID_MEMBER = lmr.ID_MEMBER)
+	WHERE lb.logTime < lmr.logTime");
+$replaceRows = '';
+while ($row = mysqli_fetch_assoc($request))
+	$replaceRows .= "($row[ID_BOARD], $row[ID_MEMBER], $row[logTime]),";
+mysqli_free_result($request);
+if (!empty($replaceRows))
+{
+	$replaceRows = substr($replaceRows, 0, -1);
+
+	upgrade_query("
+		REPLACE INTO {$db_prefix}log_boards
+			(ID_BOARD, ID_MEMBER, logTime)
+		VALUES $replaceRows");
+}
+---}
+---#
+
+---# Converting "log_activity"...
+ALTER TABLE {$db_prefix}log_activity
+ADD date date NOT NULL default '0001-01-01';
+
+ALTER TABLE {$db_prefix}log_activity
+DROP PRIMARY KEY;
+
+UPDATE IGNORE {$db_prefix}log_activity
+SET date = year * 10000 + month * 100 + day;
+
+ALTER TABLE {$db_prefix}log_activity
+DROP day,
+DROP month,
+DROP year;
+
+ALTER TABLE {$db_prefix}log_activity
+ADD INDEX hits (hits);
+ALTER TABLE {$db_prefix}log_activity
+ADD PRIMARY KEY (date);
+
+ALTER TABLE {$db_prefix}log_activity
+CHANGE COLUMN hits hits mediumint(8) unsigned NOT NULL default '0',
+CHANGE COLUMN topics topics smallint(5) unsigned NOT NULL default '0',
+CHANGE COLUMN posts posts smallint(5) unsigned NOT NULL default '0',
+CHANGE COLUMN registers registers smallint(5) unsigned NOT NULL default '0',
+CHANGE COLUMN most_on most_on smallint(5) unsigned NOT NULL default '0';
+---#
+
+/******************************************************************************/
+--- Converting Boards and Categories...
+/******************************************************************************/
+
+---# Adding new columns to "boards"...
+ALTER TABLE {$db_prefix}boards
+CHANGE COLUMN count countPosts tinyint(4) NOT NULL default '0',
+ADD lastUpdated int(11) unsigned NOT NULL default '0',
+ADD ID_PARENT smallint(5) unsigned NOT NULL default '0',
+ADD ID_LAST_MSG int(10) unsigned NOT NULL default '0',
+ADD childLevel tinyint(4) unsigned NOT NULL default '0';
+---#
+
+---# Updating the structure of "boards"...
+ALTER TABLE {$db_prefix}boards
+CHANGE COLUMN boardOrder boardOrder smallint(5) NOT NULL default '0';
+
+ALTER TABLE {$db_prefix}boards
+DROP isAnnouncement;
+ALTER TABLE {$db_prefix}boards
+ADD ID_THEME tinyint(4) unsigned NOT NULL default '0';
+ALTER TABLE {$db_prefix}boards
+ADD use_local_permissions tinyint(4) unsigned NOT NULL default '0';
+ALTER TABLE {$db_prefix}boards
+ADD override_theme tinyint(4) unsigned NOT NULL default '0';
+---#
+
+---# Reindexing "boards" (part 1)...
+ALTER TABLE {$db_prefix}boards
+DROP INDEX ID_CAT,
+DROP ID_LAST_TOPIC;
+ALTER TABLE {$db_prefix}boards
+DROP INDEX memberGroups;
+---#
+
+---# Reindexing "boards" (part 2)...
+ALTER TABLE {$db_prefix}boards
+ADD INDEX lastUpdated (lastUpdated),
+ADD INDEX memberGroups (memberGroups(48)),
+ADD UNIQUE INDEX categories (ID_CAT, ID_BOARD);
+---#
+
+---# Updating the column sizes on "boards"...
+ALTER TABLE {$db_prefix}boards
+DROP PRIMARY KEY,
+CHANGE COLUMN ID_CAT ID_CAT tinyint(4) unsigned NOT NULL default '0',
+CHANGE COLUMN numTopics numTopics mediumint(8) unsigned NOT NULL default '0',
+CHANGE COLUMN numPosts numPosts mediumint(8) unsigned NOT NULL default '0',
+CHANGE COLUMN description description text NOT NULL default '',
+CHANGE COLUMN ID_BOARD ID_BOARD smallint(5) unsigned NOT NULL auto_increment PRIMARY KEY;
+---#
+
+---# Updating access permissions...
+---{
+$member_groups = getMemberGroups();
+
+$result = upgrade_query("
+	ALTER TABLE {$db_prefix}boards
+	ADD memberGroups varchar(128) NOT NULL default '-1,0'");
+if ($result !== false)
+{
+	$result = upgrade_query("
+		SELECT TRIM(memberGroups) AS memberGroups, ID_CAT
+		FROM {$db_prefix}categories");
+	while ($row = mysqli_fetch_assoc($result))
+	{
+		if (trim($row['memberGroups']) == '')
+			$groups = '-1,0,2';
+		else
+		{
+			$memberGroups = array_unique(explode(',', $row['memberGroups']));
+			$groups = array(2);
+			foreach ($memberGroups as $k => $check)
+			{
+				$memberGroups[$k] = trim($memberGroups[$k]);
+				if ($memberGroups[$k] == '' || !isset($member_groups[$memberGroups[$k]]) || $member_groups[$memberGroups[$k]] == 8)
+					continue;
+
+				$groups[] = $member_groups[$memberGroups[$k]];
+			}
+
+			$groups = implode(',', array_unique($groups));
+		}
+
+		upgrade_query("
+			UPDATE {$db_prefix}boards
+			SET memberGroups = '$groups', lastUpdated = " . time() . "
+			WHERE ID_CAT = $row[ID_CAT]");
+	}
+}
+---}
+
+ALTER TABLE {$db_prefix}categories
+DROP memberGroups;
+
+ALTER TABLE {$db_prefix}boards
+CHANGE COLUMN memberGroups memberGroups varchar(128) NOT NULL default '-1,0';
+---#
+
+---# Converting "categories"...
+ALTER TABLE {$db_prefix}categories
+DROP PRIMARY KEY,
+ADD canCollapse tinyint(1) NOT NULL default '1',
+CHANGE COLUMN ID_CAT ID_CAT tinyint(4) unsigned NOT NULL auto_increment PRIMARY KEY;
+---#
+
+---# Converting announcement permissions...
+---{
+$request = upgrade_query("
+	SHOW COLUMNS
+	FROM {$db_prefix}boards
+	LIKE 'notifyAnnouncements'");
+if (mysqli_num_rows($request) > 0)
+{
+	$conversions = array(
+		'moderate_forum' => array('manage_membergroups', 'manage_bans'),
+		'admin_forum' => array('manage_permissions'),
+		'edit_forum' => array('manage_boards', 'manage_smileys', 'manage_attachments'),
+	);
+	foreach ($conversions as $original_permission => $new_permissions)
+	{
+		$setString = '';
+		$result = upgrade_query("
+			SELECT ID_GROUP, addDeny
+			FROM {$db_prefix}permissions
+			WHERE permission = '$original_permission'");
+		while ($row = mysqli_fetch_assoc($result))
+			$setString .= "
+				('" . implode("', $row[ID_GROUP], $row[addDeny]),
+				('", $new_permissions) . "', $row[ID_GROUP], $row[addDeny]),";
+		mysqli_free_result($result);
+
+		if ($setString != '')
+			upgrade_query("
+				INSERT IGNORE INTO {$db_prefix}permissions
+					(permission, ID_GROUP, addDeny)
+				VALUES" . substr($setString, 0, -1));
+	}
+}
+mysqli_free_result($request);
+---}
+
+DELETE FROM {$db_prefix}permissions
+WHERE permission = 'edit_forum';
+
+ALTER TABLE {$db_prefix}boards
+DROP COLUMN notifyAnnouncements;
+---#
+
+---# Converting board statistics...
+---{
+$result = upgrade_query("
+	SELECT MAX(m.ID_MSG) AS ID_LAST_MSG, t.ID_BOARD
+	FROM ({$db_prefix}messages AS m, {$db_prefix}topics AS t)
+	WHERE m.ID_MSG = t.ID_LAST_MSG
+	GROUP BY t.ID_BOARD");
+$last_msgs = array();
+while ($row = mysqli_fetch_assoc($result))
+	$last_msgs[] = $row['ID_LAST_MSG'];
+mysqli_free_result($result);
+
+if (!empty($last_msgs))
+{
+	$result = upgrade_query("
+		SELECT m.ID_MSG, m.posterTime, t.ID_BOARD
+		FROM ({$db_prefix}messages AS m, {$db_prefix}topics AS t)
+		WHERE t.ID_TOPIC = m.ID_TOPIC
+			AND m.ID_MSG IN (" . implode(',', $last_msgs) . ")
+		LIMIT " . count($last_msgs));
+	while ($row = mysqli_fetch_assoc($result))
+	{
+		upgrade_query("
+			UPDATE {$db_prefix}boards
+			SET ID_LAST_MSG = $row[ID_MSG], lastUpdated = " . (int) $row['posterTime'] . "
+			WHERE ID_BOARD = $row[ID_BOARD]
+			LIMIT 1");
+	}
+	mysqli_free_result($result);
+}
+---}
+---#
+
+---# Converting "moderators"...
+---{
+$request = upgrade_query("
+	SHOW COLUMNS
+	FROM {$db_prefix}boards
+	LIKE 'moderators'");
+$do_moderators = mysqli_num_rows($request) > 0;
+mysqli_free_result($request);
+
+if ($do_moderators)
+{
+	$result = upgrade_query("
+		SELECT TRIM(moderators) AS moderators, ID_BOARD
+		FROM {$db_prefix}boards
+		WHERE TRIM(moderators) != ''");
+	while ($row = mysqli_fetch_assoc($result))
+	{
+		$moderators = array_unique(explode(',', $row['moderators']));
+		foreach ($moderators as $k => $dummy)
+		{
+			$moderators[$k] = addslashes(trim($moderators[$k]));
+			if ($moderators[$k] == '')
+				unset($moderators[$k]);
+		}
+
+		if (!empty($moderators))
+		{
+			upgrade_query("
+				INSERT IGNORE INTO {$db_prefix}moderators
+					(ID_BOARD, ID_MEMBER)
+				SELECT $row[ID_BOARD], ID_MEMBER
+				FROM {$db_prefix}members
+				WHERE memberName IN ('" . implode("', '", $moderators) . "')
+				LIMIT " . count($moderators));
+		}
+	}
+}
+---}
+
+ALTER TABLE {$db_prefix}boards
+DROP moderators;
+---#
+
+---# Updating board order...
+---{
+$request = upgrade_query("
+	SELECT c.ID_CAT, c.catOrder, b.ID_BOARD, b.boardOrder
+	FROM {$db_prefix}categories AS c
+		LEFT JOIN {$db_prefix}boards AS b ON (b.ID_CAT = c.ID_CAT)
+	ORDER BY c.catOrder, b.childLevel, b.boardOrder, b.ID_BOARD");
+$catOrder = -1;
+$boardOrder = -1;
+$curCat = -1;
+while ($row = mysqli_fetch_assoc($request))
+{
+	if ($curCat != $row['ID_CAT'])
+	{
+		$curCat = $row['ID_CAT'];
+		if (++$catOrder != $row['catOrder'])
+			upgrade_query("
+				UPDATE {$db_prefix}categories
+				SET catOrder = $catOrder
+				WHERE ID_CAT = $row[ID_CAT]
+				LIMIT 1");
+	}
+	if (!empty($row['ID_BOARD']) && ++$boardOrder != $row['boardOrder'])
+		upgrade_query("
+			UPDATE {$db_prefix}boards
+			SET boardOrder = $boardOrder
+			WHERE ID_BOARD = $row[ID_BOARD]
+			LIMIT 1");
+}
+mysqli_free_result($request);
+---}
+---#
+
+---# Fixing possible issues with board access (part 1)...
+---{
+if (empty($modSettings['smfVersion']) || (substr($modSettings['smfVersion'], 0, 9) == '1.0 Beta ' && $modSettings['smfVersion'][9] <= 5))
+{
+	$all_groups = array();
+	$result = upgrade_query("
+		SELECT ID_GROUP
+		FROM {$db_prefix}membergroups");
+	while ($row = mysqli_fetch_assoc($result))
+		$all_groups[] = $row['ID_GROUP'];
+	mysqli_free_result($result);
+
+	$result = upgrade_query("
+		SELECT ID_BOARD, memberGroups
+		FROM {$db_prefix}boards
+		WHERE FIND_IN_SET(0, memberGroups)");
+	while ($row = mysqli_fetch_assoc($result))
+	{
+		upgrade_query("
+			UPDATE {$db_prefix}boards
+			SET memberGroups = '" . implode(',', array_unique(array_merge(explode(',', $row['memberGroups']), $all_groups))) . "'
+			WHERE ID_BOARD = $row[ID_BOARD]
+			LIMIT 1");
+	}
+	mysqli_free_result($result);
+}
+---}
+---#
+
+---# Fixing possible issues with board access. (part 2)..
+UPDATE {$db_prefix}boards
+SET memberGroups = SUBSTRING(memberGroups, 2)
+WHERE SUBSTRING(memberGroups, 1, 1) = ',';
+
+UPDATE {$db_prefix}boards
+SET memberGroups = SUBSTRING(memberGroups, 1, LENGTH(memberGroups) - 1)
+WHERE SUBSTRING(memberGroups, LENGTH(memberGroups)) = ',';
+
+UPDATE {$db_prefix}boards
+SET memberGroups = REPLACE(',,', ',', REPLACE(',,', ',', memberGroups))
+WHERE LOCATE(',,', memberGroups);
+---#
+
+/******************************************************************************/
+--- Converting attachments, topics, and messages...
+/******************************************************************************/
+
+---# Converting "attachments"...
+INSERT INTO {$db_prefix}attachments
+	(ID_MSG, filename, size)
+SELECT ID_MSG, SUBSTRING(attachmentFilename, 1, 255), attachmentSize
+FROM {$db_prefix}messages
+WHERE attachmentFilename IS NOT NULL
+	AND attachmentFilename != '';
+
+ALTER TABLE {$db_prefix}messages
+DROP attachmentSize,
+DROP attachmentFilename;
+---#
+
+---# Updating "attachments"...
+ALTER TABLE {$db_prefix}attachments
+DROP INDEX ID_MEMBER,
+ADD UNIQUE ID_MEMBER (ID_MEMBER, ID_ATTACH);
+
+ALTER TABLE {$db_prefix}attachments
+CHANGE COLUMN size size int(10) unsigned NOT NULL default '0';
+---#
+
+---# Updating columns on "messages" (part 1)...
+ALTER TABLE {$db_prefix}messages
+DROP PRIMARY KEY,
+CHANGE COLUMN ID_MSG ID_MSG int(10) unsigned NOT NULL auto_increment PRIMARY KEY;
+---#
+
+---# Updating columns on "messages" (part 2)...
+ALTER TABLE {$db_prefix}messages
+CHANGE COLUMN ID_TOPIC ID_TOPIC mediumint(8) unsigned NOT NULL default '0';
+ALTER TABLE {$db_prefix}messages
+CHANGE COLUMN smiliesEnabled smileysEnabled tinyint(4) NOT NULL default '1';
+---#
+
+---# Updating columns on "messages" (part 3)...
+ALTER TABLE {$db_prefix}messages
+CHANGE COLUMN posterTime posterTime int(10) unsigned NOT NULL default '0',
+CHANGE COLUMN modifiedTime modifiedTime int(10) unsigned NOT NULL default '0';
+
+ALTER TABLE {$db_prefix}messages
+ADD INDEX participation (ID_MEMBER, ID_TOPIC);
+ALTER TABLE {$db_prefix}messages
+ADD INDEX ipIndex (posterIP(15), ID_TOPIC);
+---#
+
+---# Updating columns on "messages" (part 4)...
+ALTER TABLE {$db_prefix}messages
+CHANGE COLUMN ID_MEMBER ID_MEMBER mediumint(8) unsigned NOT NULL default '0',
+CHANGE COLUMN icon icon varchar(16) NOT NULL default 'xx';
+
+ALTER TABLE {$db_prefix}messages
+ADD INDEX ID_MEMBER (ID_MEMBER);
+ALTER TABLE {$db_prefix}messages
+ADD UNIQUE INDEX topic (ID_TOPIC, ID_MSG);
+---#
+
+---# Updating columns on "messages" (part 5)...
+ALTER TABLE {$db_prefix}messages
+ADD COLUMN ID_BOARD smallint(5) unsigned NOT NULL default '0';
+---#
+
+---# Updating data in "messages"...
+---{
+while (true)
+{
+	nextSubstep($substep);
+
+	$request = upgrade_query("
+		SELECT DISTINCT t.ID_BOARD, t.ID_TOPIC
+		FROM ({$db_prefix}messages AS m, {$db_prefix}topics AS t)
+		WHERE t.ID_TOPIC = m.ID_TOPIC
+			AND m.ID_BOARD = 0
+		LIMIT 1400");
+	$boards = array();
+	while ($row = mysqli_fetch_assoc($request))
+		$boards[$row['ID_BOARD']][] = $row['ID_TOPIC'];
+
+	foreach ($boards as $board => $topics)
+		upgrade_query("
+			UPDATE {$db_prefix}messages
+			SET ID_BOARD = $board
+			WHERE ID_TOPIC IN (" . implode(', ', $topics) . ')');
+
+	if (mysqli_num_rows($request) < 1400)
+		break;
+
+	mysqli_free_result($request);
+}
+---}
+---#
+
+---# Cleaning up "messages"...
+ALTER TABLE {$db_prefix}messages
+ADD INDEX ID_BOARD (ID_BOARD);
+
+ALTER TABLE {$db_prefix}messages
+DROP INDEX posterTime_2;
+ALTER TABLE {$db_prefix}messages
+DROP INDEX posterTime_3;
+
+ALTER TABLE {$db_prefix}messages
+DROP INDEX ID_MEMBER_2;
+ALTER TABLE {$db_prefix}messages
+DROP INDEX ID_MEMBER_3;
+---#
+
+---# Updating indexes on "topics" (part 1)...
+ALTER TABLE {$db_prefix}topics
+DROP INDEX ID_FIRST_MSG;
+
+ALTER TABLE {$db_prefix}topics
+DROP INDEX ID_LAST_MSG;
+
+ALTER TABLE {$db_prefix}topics
+ADD INDEX isSticky (isSticky);
+---#
+
+---# Updating indexes on "topics" (part 2)...
+ALTER TABLE {$db_prefix}topics
+ADD UNIQUE INDEX lastMessage (ID_LAST_MSG, ID_BOARD),
+ADD UNIQUE INDEX firstMessage (ID_FIRST_MSG, ID_BOARD),
+ADD UNIQUE INDEX poll (ID_POLL, ID_TOPIC);
+---#
+
+---# Updating columns on "topics" (part 1)...
+ALTER TABLE {$db_prefix}topics
+DROP PRIMARY KEY,
+CHANGE COLUMN ID_TOPIC ID_TOPIC mediumint(8) unsigned NOT NULL auto_increment PRIMARY KEY,
+CHANGE COLUMN ID_BOARD ID_BOARD smallint(5) unsigned NOT NULL default '0';
+---#
+
+---# Updating columns on "topics" (part 2)...
+ALTER TABLE {$db_prefix}topics
+CHANGE COLUMN ID_MEMBER_STARTED ID_MEMBER_STARTED mediumint(8) unsigned NOT NULL default '0',
+CHANGE COLUMN ID_MEMBER_UPDATED ID_MEMBER_UPDATED mediumint(8) unsigned NOT NULL default '0';
+---#
+
+---# Updating columns on "topics" (part 3)...
+ALTER TABLE {$db_prefix}topics
+CHANGE COLUMN ID_FIRST_MSG ID_FIRST_MSG int(10) unsigned NOT NULL default '0',
+CHANGE COLUMN ID_LAST_MSG ID_LAST_MSG int(10) unsigned NOT NULL default '0';
+---#
+
+---# Updating columns on "topics" (part 4)...
+ALTER TABLE {$db_prefix}topics
+CHANGE COLUMN ID_POLL ID_POLL mediumint(8) unsigned NOT NULL default '0';
+---#
+
+/******************************************************************************/
+--- Converting members and personal messages...
+/******************************************************************************/
+
+---# Updating data in "members" (part 1)...
+UPDATE IGNORE {$db_prefix}members
+SET im_ignore_list = '*'
+WHERE im_ignore_list RLIKE '([\n,]|^)[*]([\n,]|$)';
+---#
+
+---# Updating data in "members" (part 2)...
+---{
+$request = upgrade_query("
+	SHOW COLUMNS
+	FROM {$db_prefix}members
+	LIKE 'im_ignore_list'");
+$do_it = mysqli_num_rows($request) != 0;
+mysqli_free_result($request);
+
+while ($do_it)
+{
+	nextSubstep($substep);
+
+	$request = upgrade_query("
+		SELECT ID_MEMBER, im_ignore_list
+		FROM {$db_prefix}members
+		WHERE im_ignore_list RLIKE '[a-z]'
+		LIMIT 512");
+	while ($row = mysqli_fetch_assoc($request))
+	{
+		$request2 = upgrade_query("
+			SELECT ID_MEMBER
+			FROM {$db_prefix}members
+			WHERE FIND_IN_SET(memberName, '" . addslashes($row['im_ignore_list']) . "')");
+		$im_ignore_list = '';
+		while ($row2 = mysqli_fetch_assoc($request2))
+			$im_ignore_list .= ',' . $row2['ID_MEMBER'];
+		mysqli_free_result($request2);
+
+		upgrade_query("
+			UPDATE {$db_prefix}members
+			SET im_ignore_list = '" . substr($im_ignore_list, 1) . "'
+			WHERE ID_MEMBER = $row[ID_MEMBER]
+			LIMIT 1");
+	}
+	if (mysqli_num_rows($request) < 512)
+		break;
+	mysqli_free_result($request);
+}
+---}
+---#
+
+---# Updating data in "members" (part 3)...
+UPDATE {$db_prefix}members
+SET realName = memberName
+WHERE IFNULL(realName, '') = '';
+---#
+
+---# Updating data in "members" (part 4)...
+UPDATE {$db_prefix}members
+SET lngfile = REPLACE(lngfile, '.lng', '')
+WHERE lngfile LIKE '%.lng';
+---#
+
+---# Cleaning up "members"...
+ALTER TABLE {$db_prefix}members
+DROP INDEX memberID;
+ALTER TABLE {$db_prefix}members
+DROP INDEX memberID_2;
+---#
+
+---# Adding new columns to "members"...
+ALTER TABLE {$db_prefix}members
+DROP PRIMARY KEY,
+CHANGE COLUMN ID_MEMBER ID_MEMBER mediumint(8) unsigned NOT NULL auto_increment PRIMARY KEY,
+ADD instantMessages smallint(5) NOT NULL default 0,
+ADD unreadMessages smallint(5) NOT NULL default 0,
+ADD ID_THEME tinyint(4) unsigned NOT NULL default 0,
+ADD ID_GROUP smallint(5) unsigned NOT NULL default 0,
+ADD is_activated tinyint(3) unsigned NOT NULL default '1',
+ADD validation_code varchar(10) NOT NULL default '',
+ADD ID_MSG_LAST_VISIT int(10) unsigned NOT NULL default '0',
+ADD additionalGroups tinytext NOT NULL default '';
+---#
+
+---# Updating columns on "members"...
+ALTER TABLE {$db_prefix}members
+CHANGE COLUMN ID_THEME ID_THEME tinyint(4) unsigned NOT NULL default 0;
+ALTER TABLE {$db_prefix}members
+ADD showOnline tinyint(4) NOT NULL default '1';
+ALTER TABLE {$db_prefix}members
+ADD smileySet varchar(48) NOT NULL default '';
+ALTER TABLE {$db_prefix}members
+ADD totalTimeLoggedIn int(10) unsigned NOT NULL default '0';
+ALTER TABLE {$db_prefix}members
+ADD passwordSalt varchar(5) NOT NULL default '';
+---#
+
+---# Updating data in "members" (part 5)...
+UPDATE {$db_prefix}members
+SET gender = CASE gender
+	WHEN '0' THEN 0
+	WHEN 'Male' THEN 1
+	WHEN 'Female' THEN 2
+	ELSE 0 END, secretAnswer = IF(secretAnswer = '', '', MD5(secretAnswer))
+WHERE gender NOT IN ('0', '1', '2');
+---#
+
+---# Updating data in "members" (part 6)...
+---{
+$member_groups = getMemberGroups();
+
+foreach ($member_groups as $name => $id)
+{
+	upgrade_query("
+		UPDATE IGNORE {$db_prefix}members
+		SET ID_GROUP = $id
+		WHERE memberGroup = '" . addslashes($name) . "'");
+
+	nextSubstep($substep);
+}
+---}
+UPDATE IGNORE {$db_prefix}members
+SET ID_GROUP = 1
+WHERE memberGroup = 'Administrator';
+UPDATE IGNORE {$db_prefix}members
+SET ID_GROUP = 2
+WHERE memberGroup = 'Global Moderator';
+
+ALTER TABLE {$db_prefix}members
+DROP memberGroup;
+---#
+
+---# Changing column sizes on "members" (part 1)...
+ALTER TABLE {$db_prefix}members
+CHANGE COLUMN timeOffset timeOffset float NOT NULL default '0',
+CHANGE COLUMN posts posts mediumint(8) unsigned NOT NULL default '0',
+CHANGE COLUMN timeFormat timeFormat varchar(80) NOT NULL default '',
+CHANGE COLUMN lastLogin lastLogin int(11) NOT NULL default '0',
+CHANGE COLUMN karmaBad karmaBad smallint(5) unsigned NOT NULL default '0',
+CHANGE COLUMN karmaGood karmaGood smallint(5) unsigned NOT NULL default '0',
+CHANGE COLUMN gender gender tinyint(4) unsigned NOT NULL default '0',
+CHANGE COLUMN hideEmail hideEmail tinyint(4) NOT NULL default '0';
+---#
+
+---# Changing column sizes on "members" (part 2)...
+ALTER TABLE {$db_prefix}members
+DROP INDEX realName;
+
+ALTER TABLE {$db_prefix}members
+CHANGE COLUMN AIM AIM varchar(16) NOT NULL default '',
+CHANGE COLUMN YIM YIM varchar(32) NOT NULL default '',
+CHANGE COLUMN ICQ ICQ tinytext NOT NULL default '',
+CHANGE COLUMN realName realName tinytext NOT NULL default '',
+CHANGE COLUMN emailAddress emailAddress tinytext NOT NULL default '',
+CHANGE COLUMN dateRegistered dateRegistered int(10) unsigned NOT NULL default '0',
+CHANGE COLUMN passwd passwd varchar(64) NOT NULL default '',
+CHANGE COLUMN personalText personalText tinytext NOT NULL default '',
+CHANGE COLUMN websiteTitle websiteTitle tinytext NOT NULL default '';
+---#
+
+---# Changing column sizes on "members" (part 3)...
+ALTER TABLE {$db_prefix}members
+DROP INDEX lngfile;
+
+ALTER TABLE {$db_prefix}members
+CHANGE COLUMN websiteUrl websiteUrl tinytext NOT NULL default '',
+CHANGE COLUMN location location tinytext NOT NULL default '',
+CHANGE COLUMN avatar avatar tinytext NOT NULL default '',
+CHANGE COLUMN im_ignore_list im_ignore_list tinytext NOT NULL default '',
+CHANGE COLUMN usertitle usertitle tinytext NOT NULL default '',
+CHANGE COLUMN lngfile lngfile tinytext NOT NULL default '',
+CHANGE COLUMN MSN MSN tinytext NOT NULL default '',
+CHANGE COLUMN memberIP memberIP tinytext NOT NULL default '',
+ADD INDEX lngfile (lngfile(24));
+---#
+
+---# Updating keys on "members"...
+ALTER TABLE {$db_prefix}members
+ADD INDEX ID_GROUP (ID_GROUP),
+ADD INDEX birthdate (birthdate),
+ADD INDEX lngfile (lngfile(30));
+---#
+
+---# Converting member statistics...
+REPLACE INTO {$db_prefix}settings
+	(variable, value)
+SELECT 'latestMember', ID_MEMBER
+FROM {$db_prefix}members
+ORDER BY ID_MEMBER DESC
+LIMIT 1;
+
+REPLACE INTO {$db_prefix}settings
+	(variable, value)
+SELECT 'latestRealName', IFNULL(realName, memberName)
+FROM {$db_prefix}members
+ORDER BY ID_MEMBER DESC
+LIMIT 1;
+
+REPLACE INTO {$db_prefix}settings
+	(variable, value)
+SELECT 'maxMsgID', ID_MSG
+FROM {$db_prefix}messages
+ORDER BY ID_MSG DESC
+LIMIT 1;
+---#
+
+---# Adding new columns to "instant_messages"...
+ALTER TABLE {$db_prefix}instant_messages
+ADD COLUMN deletedBySender tinyint(3) unsigned NOT NULL default '0' AFTER ID_MEMBER_FROM;
+---#
+
+---# Changing column sizes on "instant_messages" (part 1)...
+ALTER TABLE {$db_prefix}instant_messages
+CHANGE COLUMN ID_MEMBER_FROM ID_MEMBER_FROM mediumint(8) unsigned NOT NULL default 0,
+CHANGE COLUMN msgtime msgtime int(10) unsigned NOT NULL default '0',
+CHANGE COLUMN subject subject tinytext NOT NULL;
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX fromName,
+DROP INDEX ID_MEMBER_FROM;
+---#
+
+---# Changing column sizes on "instant_messages" (part 2)...
+ALTER TABLE {$db_prefix}instant_messages
+DROP PRIMARY KEY,
+CHANGE COLUMN ID_IM ID_PM int(10) unsigned NOT NULL auto_increment PRIMARY KEY;
+ALTER TABLE {$db_prefix}instant_messages
+ADD INDEX msgtime (msgtime);
+---#
+
+---# Cleaning up "instant_messages"...
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX ID_MEMBER_FROM_2;
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX ID_MEMBER_FROM_3;
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX ID_MEMBER_FROM_4;
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX ID_MEMBER_FROM_5;
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX ID_MEMBER_TO_2;
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX ID_MEMBER_TO_3;
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX ID_MEMBER_TO_4;
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX ID_MEMBER_TO_5;
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX deletedBy_2;
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX deletedBy_3;
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX deletedBy_4;
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX deletedBy_5;
+---#
+
+---# Creating "im_recipients"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}im_recipients (
+	ID_PM int(10) unsigned NOT NULL default '0',
+	ID_MEMBER mediumint(8) unsigned NOT NULL default '0',
+	bcc tinyint(3) unsigned NOT NULL default '0',
+	is_read tinyint(3) unsigned NOT NULL default '0',
+	deleted tinyint(3) unsigned NOT NULL default '0',
+	PRIMARY KEY (ID_PM, ID_MEMBER),
+	KEY ID_MEMBER (ID_MEMBER, deleted)
+) ENGINE=MyISAM;
+---#
+
+---# Updating "im_recipients"...
+ALTER TABLE {$db_prefix}im_recipients
+DROP PRIMARY KEY,
+CHANGE COLUMN ID_IM ID_PM int(10) unsigned NOT NULL default '0',
+ADD PRIMARY KEY (ID_PM, ID_MEMBER);
+---#
+
+---# Updating data in "instant_messages" (part 1)...
+---{
+$request = upgrade_query("
+	SHOW COLUMNS
+	FROM {$db_prefix}instant_messages
+	LIKE 'readBy'");
+$do_it = $request !== false;
+
+if ($do_it)
+{
+	$adv_im = mysqli_num_rows($request) == 0;
+	mysqli_free_result($request);
+
+	upgrade_query("
+		INSERT IGNORE INTO {$db_prefix}im_recipients
+			(ID_PM, ID_MEMBER, bcc, is_read, deleted)
+		SELECT ID_PM, ID_MEMBER_TO, 0, IF(" . (!$adv_im ? 'readBy' : 'alerted') . " != 0, 1, 0), IF(deletedBy = '1', 1, 0)
+		FROM {$db_prefix}instant_messages");
+}
+---}
+
+UPDATE IGNORE {$db_prefix}instant_messages
+SET deletedBySender = 1
+WHERE deletedBy = 0;
+---#
+
+---# Updating data in "instant_messages" (part 2)...
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX ID_MEMBER_TO;
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX deletedBy;
+ALTER TABLE {$db_prefix}instant_messages
+DROP INDEX readBy;
+
+ALTER TABLE {$db_prefix}instant_messages
+DROP COLUMN ID_MEMBER_TO,
+DROP COLUMN deletedBy,
+DROP COLUMN toName,
+DROP COLUMN readBy;
+
+ALTER TABLE {$db_prefix}instant_messages
+ADD INDEX ID_MEMBER (ID_MEMBER_FROM, deletedBySender);
+---#
+
+---# Recounting personal message totals...
+---{
+$request = upgrade_query("
+	SHOW CREATE TABLE {$db_prefix}instant_messages");
+$do_it = $request !== false;
+@mysqli_free_result($request);
+
+$request = upgrade_query("
+	SELECT COUNT(*)
+	FROM {$db_prefix}members");
+list ($totalMembers) = mysqli_fetch_row($request);
+mysqli_free_result($request);
+
+$_GET['m'] = (int) @$_GET['m'];
+
+while ($_GET['m'] < $totalMembers && $do_it)
+{
+	nextSubstep($substep);
+
+	$mrequest = upgrade_query("
+		SELECT mem.ID_MEMBER, COUNT(pmr.ID_PM) AS instantMessages_real, mem.instantMessages
+		FROM {$db_prefix}members AS mem
+			LEFT JOIN {$db_prefix}im_recipients AS pmr ON (pmr.ID_MEMBER = mem.ID_MEMBER AND pmr.deleted = 0)
+		WHERE mem.ID_MEMBER > $_GET[m]
+			AND mem.ID_MEMBER <= $_GET[m] + 512
+		GROUP BY mem.ID_MEMBER
+		HAVING instantMessages_real != instantMessages
+		LIMIT 512");
+	while ($row = mysqli_fetch_assoc($mrequest))
+	{
+		upgrade_query("
+			UPDATE {$db_prefix}members
+			SET instantMessages = $row[instantMessages_real]
+			WHERE ID_MEMBER = $row[ID_MEMBER]
+			LIMIT 1");
+	}
+
+	$_GET['m'] += 512;
+}
+unset($_GET['m']);
+---}
+---{
+$request = upgrade_query("
+	SHOW CREATE TABLE {$db_prefix}instant_messages");
+$do_it = $request !== false;
+@mysqli_free_result($request);
+
+$request = upgrade_query("
+	SELECT COUNT(*)
+	FROM {$db_prefix}members");
+list ($totalMembers) = mysqli_fetch_row($request);
+mysqli_free_result($request);
+
+$_GET['m'] = (int) @$_GET['m'];
+
+while ($_GET['m'] < $totalMembers && $do_it)
+{
+	nextSubstep($substep);
+
+	$mrequest = upgrade_query("
+		SELECT mem.ID_MEMBER, COUNT(pmr.ID_PM) AS unreadMessages_real, mem.unreadMessages
+		FROM {$db_prefix}members AS mem
+			LEFT JOIN {$db_prefix}im_recipients AS pmr ON (pmr.ID_MEMBER = mem.ID_MEMBER AND pmr.deleted = 0 AND pmr.is_read = 0)
+		WHERE mem.ID_MEMBER > $_GET[m]
+			AND mem.ID_MEMBER <= $_GET[m] + 512
+		GROUP BY mem.ID_MEMBER
+		HAVING unreadMessages_real != unreadMessages
+		LIMIT 512");
+	while ($row = mysqli_fetch_assoc($mrequest))
+	{
+		upgrade_query("
+			UPDATE {$db_prefix}members
+			SET unreadMessages = $row[unreadMessages_real]
+			WHERE ID_MEMBER = $row[ID_MEMBER]
+			LIMIT 1");
+	}
+
+	$_GET['m'] += 512;
+}
+unset($_GET['m']);
+---}
+---#
+
+---# Converting "membergroups"...
+---{
+global $JrPostNum, $FullPostNum, $SrPostNum, $GodPostNum;
+
+$result = upgrade_query("
+	SELECT minPosts
+	FROM {$db_prefix}membergroups
+	LIMIT 1");
+if ($result === false)
+{
+	upgrade_query("
+		RENAME TABLE {$db_prefix}membergroups TO {$db_prefix}old_membergroups");
+
+	upgrade_query("
+		CREATE TABLE {$db_prefix}membergroups (
+			ID_GROUP smallint(5) unsigned NOT NULL auto_increment,
+			groupName varchar(80) NOT NULL default '',
+			onlineColor varchar(20) NOT NULL default '',
+			minPosts mediumint(9) NOT NULL default '-1',
+			maxMessages smallint(5) unsigned NOT NULL default '0',
+			stars tinytext NOT NULL default '',
+			PRIMARY KEY (ID_GROUP),
+			KEY minPosts (minPosts)
+		) ENGINE=MyISAM");
+
+	upgrade_query("
+		INSERT INTO {$db_prefix}membergroups
+			(ID_GROUP, groupName, onlineColor, minPosts, stars)
+		SELECT ID_GROUP, membergroup, '#FF0000', -1, '5#staradmin.gif'
+		FROM {$db_prefix}old_membergroups
+		WHERE ID_GROUP = 1");
+
+	upgrade_query("
+		INSERT INTO {$db_prefix}membergroups
+			(ID_GROUP, groupName, onlineColor, minPosts, stars)
+		SELECT 2, membergroup, '#0000FF', -1, '5#stargmod.gif'
+		FROM {$db_prefix}old_membergroups
+		WHERE ID_GROUP = 8");
+
+	upgrade_query("
+		INSERT INTO {$db_prefix}membergroups
+			(ID_GROUP, groupName, onlineColor, minPosts, stars)
+		SELECT 3, membergroup, '', -1, '5#starmod.gif'
+		FROM {$db_prefix}old_membergroups
+		WHERE ID_GROUP = 2");
+
+	upgrade_query("
+		INSERT INTO {$db_prefix}membergroups
+			(ID_GROUP, groupName, onlineColor, minPosts, stars)
+		SELECT
+			ID_GROUP + 1, membergroup, '', CASE ID_GROUP
+				WHEN 3 THEN 0
+				WHEN 4 THEN '$JrPostNum'
+				WHEN 5 THEN '$FullPostNum'
+				WHEN 6 THEN '$SrPostNum'
+				WHEN 7 THEN '$GodPostNum'
+			END, CONCAT(ID_GROUP - 2, '#star.gif')
+		FROM {$db_prefix}old_membergroups
+		WHERE ID_GROUP IN (3, 4, 5, 6, 7)");
+
+	upgrade_query("
+		INSERT INTO {$db_prefix}membergroups
+			(ID_GROUP, groupName, onlineColor, minPosts, stars)
+		SELECT ID_GROUP, membergroup, '', -1, ''
+		FROM {$db_prefix}old_membergroups
+		WHERE ID_GROUP > 8");
+
+	upgrade_query("
+		DROP TABLE IF EXISTS {$db_prefix}old_membergroups");
+
+	$permissions = array(
+		'view_mlist',
+		'search_posts',
+		'profile_view_own',
+		'profile_view_any',
+		'pm_read',
+		'pm_send',
+		'calendar_view',
+		'view_stats',
+		'who_view',
+		'profile_identity_own',
+		'profile_extra_own',
+		'profile_remote_avatar',
+		'profile_remove_own',
+	);
+
+	foreach ($permissions as $perm)
+		upgrade_query("
+			INSERT INTO {$db_prefix}permissions
+				(ID_GROUP, permission)
+			SELECT IF(ID_GROUP = 1, 0, ID_GROUP), '$perm'
+			FROM {$db_prefix}membergroups
+			WHERE ID_GROUP != 3
+				AND minPosts = -1");
+
+	$board_permissions = array(
+		'remove_own',
+		'lock_own',
+		'mark_any_notify',
+		'mark_notify',
+		'modify_own',
+		'poll_add_own',
+		'poll_edit_own',
+		'poll_lock_own',
+		'poll_post',
+		'poll_view',
+		'poll_vote',
+		'post_attachment',
+		'post_new',
+		'post_reply_any',
+		'post_reply_own',
+		'delete_own',
+		'report_any',
+		'send_topic',
+		'view_attachments',
+	);
+
+	foreach ($board_permissions as $perm)
+		upgrade_query("
+			INSERT INTO {$db_prefix}board_permissions
+				(ID_GROUP, permission)
+			SELECT IF(ID_GROUP = 1, 0, ID_GROUP), '$perm'
+			FROM {$db_prefix}membergroups
+			WHERE minPosts = -1");
+}
+---}
+---#
+
+---# Converting "reserved_names"...
+---{
+$request = upgrade_query("
+	SELECT setting, value
+	FROM {$db_prefix}reserved_names");
+if ($request !== false)
+{
+	$words = array();
+	$match_settings = array();
+	while ($row = mysqli_fetch_assoc($request))
+	{
+		if (substr($row['setting'], 0, 5) == 'match')
+			$match_settings[$row['setting']] = $row['value'];
+		else
+			$words[] = $row['value'];
+	}
+	mysqli_free_result($request);
+
+	upgrade_query("
+		INSERT IGNORE INTO {$db_prefix}settings
+		VALUES ('reserveWord', '" . (int) @$match_settings['matchword'] . "'),
+			('reserveCase', '" . (int) @$match_settings['matchcase'] . "'),
+			('reserveUser', '" . (int) @$match_settings['matchuser'] . "'),
+			('reserveName', '" . (int) @$match_settings['matchname'] . "'),
+			('reserveNames', '" . implode("\n", $words) . "')");
+
+	upgrade_query("
+		DROP TABLE {$db_prefix}reserved_names");
+}
+---}
+---#
+
+---# Converting member's groups...
+ALTER TABLE {$db_prefix}members
+ADD COLUMN ID_POST_GROUP smallint(5) unsigned NOT NULL default '0',
+ADD INDEX ID_POST_GROUP (ID_POST_GROUP);
+
+---{
+$request = upgrade_query("
+	SELECT ID_GROUP, minPosts
+	FROM {$db_prefix}membergroups
+	WHERE minPosts != -1
+	ORDER BY minPosts DESC");
+$post_groups = array();
+while ($row = mysqli_fetch_assoc($request))
+	$post_groups[$row['minPosts']] = $row['ID_GROUP'];
+mysqli_free_result($request);
+
+$request = upgrade_query("
+	SELECT ID_MEMBER, posts
+	FROM {$db_prefix}members");
+$mg_updates = array();
+while ($row = mysqli_fetch_assoc($request))
+{
+	$group = 4;
+	foreach ($post_groups as $min_posts => $group_id)
+		if ($row['posts'] > $min_posts)
+		{
+			$group = $group_id;
+			break;
+		}
+
+	$mg_updates[$group][] = $row['ID_MEMBER'];
+}
+mysqli_free_result($request);
+
+foreach ($mg_updates as $group_to => $update_members)
+	upgrade_query("
+		UPDATE {$db_prefix}members
+		SET ID_POST_GROUP = $group_to
+		WHERE ID_MEMBER IN (" . implode(', ', $update_members) . ")
+		LIMIT " . count($update_members));
+---}
+---#
+
+/******************************************************************************/
+--- Converting the calendar, notifications, and miscellaneous...
+/******************************************************************************/
+
+---# Converting censored words...
+---{
+if (!isset($modSettings['censor_vulgar']) || !isset($modSettings['censor_proper']))
+{
+	$request = upgrade_query("
+		SELECT vulgar, proper
+		FROM {$db_prefix}censor");
+	$censor_vulgar = array();
+	$censor_proper = array();
+	while ($row = mysqli_fetch_row($request))
+	{
+		$censor_vulgar[] = trim($row[0]);
+		$censor_proper[] = trim($row[1]);
+	}
+	mysqli_free_result($request);
+
+	$modSettings['censor_vulgar'] = addslashes(implode("\n", $censor_vulgar));
+	$modSettings['censor_proper'] = addslashes(implode("\n", $censor_proper));
+
+	upgrade_query("
+		INSERT IGNORE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('censor_vulgar', '$modSettings[censor_vulgar]'),
+			('censor_proper', '$modSettings[censor_proper]')");
+
+	upgrade_query("
+		DROP TABLE IF EXISTS {$db_prefix}censor");
+}
+---}
+---#
+
+---# Converting topic notifications...
+---{
+$result = upgrade_query("
+	SELECT COUNT(*)
+	FROM {$db_prefix}topics
+	WHERE notifies != ''");
+if ($result !== false)
+{
+	list ($numNotifies) = mysqli_fetch_row($result);
+	mysqli_free_result($result);
+
+	$_GET['t'] = (int) @$_GET['t'];
+
+	while ($_GET['t'] < $numNotifies)
+	{
+		nextSubstep($substep);
+
+		upgrade_query("
+			INSERT IGNORE INTO {$db_prefix}log_notify
+				(ID_MEMBER, ID_TOPIC)
+			SELECT mem.ID_MEMBER, t.ID_TOPIC
+			FROM ({$db_prefix}topics AS t, {$db_prefix}members AS mem)
+			WHERE FIND_IN_SET(mem.ID_MEMBER, t.notifies)
+				AND t.notifies != ''
+			LIMIT $_GET[t], 512");
+
+		$_GET['t'] += 512;
+	}
+	unset($_GET['t']);
+}
+---}
+
+ALTER TABLE {$db_prefix}topics
+DROP notifies;
+---#
+
+---# Converting "banned"...
+---{
+$request = upgrade_query("
+	SELECT type, value
+	FROM {$db_prefix}banned
+	WHERE type = 'ip'");
+if ($request !== false)
+{
+	$insertEntries = array();
+	while ($row = mysqli_fetch_assoc($request))
+	{
+		if (preg_match('~^\d{1,3}\.(\d{1,3}|\*)\.(\d{1,3}|\*)\.(\d{1,3}|\*)$~', $row['value']) == 0)
+			continue;
+
+		$ip_parts = ip2range($row['value']);
+		$insertEntries[] = "('ip_ban', {$ip_parts[0]['low']}, {$ip_parts[0]['high']}, {$ip_parts[1]['low']}, {$ip_parts[1]['high']}, {$ip_parts[2]['low']}, {$ip_parts[2]['high']}, {$ip_parts[3]['low']}, {$ip_parts[3]['high']}, '', '', 0, " . time() . ", NULL, 'full_ban', '', 'Imported from YaBB SE')";
+	}
+	mysqli_free_result($request);
+
+	upgrade_query("
+		CREATE TABLE IF NOT EXISTS {$db_prefix}banned2 (
+			id_ban mediumint(8) unsigned NOT NULL auto_increment,
+			ban_type varchar(30) NOT NULL default '',
+			ip_low1 tinyint(3) unsigned NOT NULL default '0',
+			ip_high1 tinyint(3) unsigned NOT NULL default '0',
+			ip_low2 tinyint(3) unsigned NOT NULL default '0',
+			ip_high2 tinyint(3) unsigned NOT NULL default '0',
+			ip_low3 tinyint(3) unsigned NOT NULL default '0',
+			ip_high3 tinyint(3) unsigned NOT NULL default '0',
+			ip_low4 tinyint(3) unsigned NOT NULL default '0',
+			ip_high4 tinyint(3) unsigned NOT NULL default '0',
+			hostname tinytext NOT NULL default '',
+			email_address tinytext NOT NULL default '',
+			ID_MEMBER mediumint(8) unsigned NOT NULL default '0',
+			ban_time int(10) unsigned NOT NULL default '0',
+			expire_time int(10) unsigned,
+			restriction_type varchar(30) NOT NULL default '',
+			reason tinytext NOT NULL default '',
+			notes text NOT NULL default '',
+			PRIMARY KEY (id_ban)
+		) ENGINE=MyISAM");
+
+	upgrade_query("
+		INSERT INTO {$db_prefix}banned2
+			(ban_type, ip_low1, ip_high1, ip_low2, ip_high2, ip_low3, ip_high3, ip_low4, ip_high4, hostname, email_address, ID_MEMBER, ban_time, expire_time, restriction_type, reason, notes)
+		SELECT 'email_ban', 0, 0, 0, 0, 0, 0, 0, 0, '', value, 0, " . time() . ", NULL, 'full_ban', '', 'Imported from YaBB SE'
+		FROM {$db_prefix}banned
+		WHERE type = 'email'");
+
+	upgrade_query("
+		INSERT INTO {$db_prefix}banned2
+			(ban_type, ip_low1, ip_high1, ip_low2, ip_high2, ip_low3, ip_high3, ip_low4, ip_high4, hostname, email_address, ID_MEMBER, ban_time, expire_time, restriction_type, reason, notes)
+		SELECT 'user_ban', 0, 0, 0, 0, 0, 0, 0, 0, '', '', mem.ID_MEMBER, " . time() . ", NULL, 'full_ban', '', 'Imported from YaBB SE'
+		FROM ({$db_prefix}banned AS ban, {$db_prefix}members AS mem)
+		WHERE ban.type = 'username'
+			AND mem.memberName = ban.value");
+
+	upgrade_query("
+		DROP TABLE {$db_prefix}banned");
+	upgrade_query("
+		RENAME TABLE {$db_prefix}banned2 TO {$db_prefix}banned");
+
+	if (!empty($insertEntries))
+	{
+		upgrade_query("
+			INSERT INTO {$db_prefix}banned
+				(ban_type, ip_low1, ip_high1, ip_low2, ip_high2, ip_low3, ip_high3, ip_low4, ip_high4, hostname, email_address, ID_MEMBER, ban_time, expire_time, restriction_type, reason, notes)
+			VALUES " . implode(',', $insertEntries));
+	}
+}
+---}
+---#
+
+---# Updating "log_banned"...
+ALTER TABLE {$db_prefix}log_banned
+CHANGE COLUMN logTime logTime int(10) unsigned NOT NULL default '0';
+ALTER TABLE {$db_prefix}log_banned
+ADD COLUMN id_ban_log mediumint(8) unsigned NOT NULL auto_increment PRIMARY KEY FIRST,
+ADD COLUMN ID_MEMBER mediumint(8) unsigned NOT NULL default '0' AFTER id_ban_log,
+ADD INDEX logTime (logTime);
+---#
+
+---# Updating columns on "calendar"...
+ALTER TABLE {$db_prefix}calendar
+DROP PRIMARY KEY,
+CHANGE COLUMN id ID_EVENT smallint(5) unsigned NOT NULL auto_increment PRIMARY KEY,
+CHANGE COLUMN id_board ID_BOARD smallint(5) unsigned NOT NULL default '0',
+CHANGE COLUMN id_topic ID_TOPIC mediumint(8) unsigned NOT NULL default '0',
+CHANGE COLUMN id_member ID_MEMBER mediumint(8) unsigned NOT NULL default '0';
+ALTER TABLE {$db_prefix}calendar
+CHANGE COLUMN title title varchar(48) NOT NULL default '';
+
+ALTER TABLE {$db_prefix}calendar
+ADD eventDate date NOT NULL default '0000-00-00';
+---#
+
+---# Updating indexes on "calendar"...
+ALTER TABLE {$db_prefix}calendar
+DROP INDEX idx_year_month;
+ALTER TABLE {$db_prefix}calendar
+DROP INDEX year;
+---#
+
+---# Updating data in "calendar"...
+UPDATE IGNORE {$db_prefix}calendar
+SET eventDate = CONCAT(year, '-', month + 1, '-', day);
+
+ALTER TABLE {$db_prefix}calendar
+DROP year,
+DROP month,
+DROP day,
+ADD INDEX eventDate (eventDate);
+---#
+
+---# Updating structure on "calendar_holidays"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}calendar_holidays (
+	ID_HOLIDAY smallint(5) unsigned NOT NULL auto_increment,
+	eventDate date NOT NULL default '0000-00-00',
+	title varchar(30) NOT NULL default '',
+	PRIMARY KEY (ID_HOLIDAY),
+	KEY eventDate (eventDate)
+) ENGINE=MyISAM;
+---#
+
+---# Updating data in "calendar_holidays"...
+---{
+$result = upgrade_query("
+	SELECT COUNT(*)
+	FROM {$db_prefix}calendar_holidays");
+list ($size) = mysqli_fetch_row($result);
+mysqli_free_result($result);
+
+if (empty($size))
+{
+	upgrade_query("
+		INSERT INTO {$db_prefix}calendar_holidays
+			(eventDate, title)
+		SELECT IF(year IS NULL, CONCAT('0000-', month, '-', day), CONCAT(year, '-', month, '-', day)), title
+		FROM {$db_prefix}calendar_holiday");
+
+	upgrade_query("
+		INSERT INTO {$db_prefix}calendar_holidays
+			(eventDate, title)
+		VALUES ('0000-06-06', 'D-Day')");
+}
+---}
+
+UPDATE {$db_prefix}calendar_holidays
+SET title = 'New Year\'s'
+WHERE title = 'New Years';
+---#
+
+/******************************************************************************/
+--- Converting polls and choices...
+/******************************************************************************/
+
+---# Converting data to "poll_choices"...
+INSERT INTO {$db_prefix}poll_choices
+	(ID_POLL, ID_CHOICE, label, votes)
+SELECT ID_POLL, 0, option1, votes1
+FROM {$db_prefix}polls;
+
+INSERT INTO {$db_prefix}poll_choices
+	(ID_POLL, ID_CHOICE, label, votes)
+SELECT ID_POLL, 1, option2, votes2
+FROM {$db_prefix}polls;
+
+INSERT INTO {$db_prefix}poll_choices
+	(ID_POLL, ID_CHOICE, label, votes)
+SELECT ID_POLL, 2, option3, votes3
+FROM {$db_prefix}polls;
+
+INSERT INTO {$db_prefix}poll_choices
+	(ID_POLL, ID_CHOICE, label, votes)
+SELECT ID_POLL, 3, option4, votes4
+FROM {$db_prefix}polls;
+
+INSERT INTO {$db_prefix}poll_choices
+	(ID_POLL, ID_CHOICE, label, votes)
+SELECT ID_POLL, 4, option5, votes5
+FROM {$db_prefix}polls;
+
+INSERT INTO {$db_prefix}poll_choices
+	(ID_POLL, ID_CHOICE, label, votes)
+SELECT ID_POLL, 5, option6, votes6
+FROM {$db_prefix}polls;
+
+INSERT INTO {$db_prefix}poll_choices
+	(ID_POLL, ID_CHOICE, label, votes)
+SELECT ID_POLL, 6, option7, votes7
+FROM {$db_prefix}polls;
+
+INSERT INTO {$db_prefix}poll_choices
+	(ID_POLL, ID_CHOICE, label, votes)
+SELECT ID_POLL, 7, option8, votes8
+FROM {$db_prefix}polls;
+---#
+
+---# Converting data to "log_polls"...
+---{
+$query = upgrade_query("
+	SELECT ID_POLL, votedMemberIDs
+	FROM {$db_prefix}polls");
+if ($query !== false)
+{
+	$setStringLog = '';
+	while ($row = mysqli_fetch_assoc($query))
+	{
+		$members = explode(',', $row['votedMemberIDs']);
+		foreach ($members as $member)
+			if (is_numeric($member) && !empty($member))
+				$setStringLog .= "
+				($row[ID_POLL], $member, 0),";
+	}
+
+	if (!empty($setStringLog))
+	{
+		upgrade_query("
+			INSERT IGNORE INTO {$db_prefix}log_polls
+				(ID_POLL, ID_MEMBER, ID_CHOICE)
+			VALUES " . substr($setStringLog, 0, -1));
+	}
+}
+---}
+---#
+
+---# Updating "polls"...
+ALTER TABLE {$db_prefix}polls
+DROP option1, DROP option2, DROP option3, DROP option4, DROP option5, DROP option6, DROP option7, DROP option8,
+DROP votes1, DROP votes2, DROP votes3, DROP votes4, DROP votes5, DROP votes6, DROP votes7, DROP votes8,
+DROP votedMemberIDs,
+DROP PRIMARY KEY,
+CHANGE COLUMN ID_POLL ID_POLL mediumint(8) unsigned NOT NULL auto_increment PRIMARY KEY,
+CHANGE COLUMN votingLocked votingLocked tinyint(1) NOT NULL default '0',
+CHANGE COLUMN question question tinytext NOT NULL default '',
+ADD maxVotes tinyint(4) unsigned NOT NULL default '1',
+ADD expireTime int(10) unsigned NOT NULL default '0',
+ADD hideResults tinyint(4) unsigned NOT NULL default '0';
+
+ALTER TABLE {$db_prefix}polls
+ADD ID_MEMBER mediumint(8) unsigned NOT NULL default '0',
+ADD posterName tinytext NOT NULL default '';
+ALTER TABLE {$db_prefix}polls
+ADD changeVote tinyint(4) unsigned NOT NULL default '0';
+---#
+
+---# Updating data in "polls"...
+---{
+$result = upgrade_query("
+	SELECT p.ID_POLL, t.ID_MEMBER_STARTED
+	FROM ({$db_prefix}topics AS t, {$db_prefix}messages AS m, {$db_prefix}polls AS p)
+	WHERE m.ID_MSG = t.ID_FIRST_MSG
+		AND p.ID_POLL = t.ID_POLL
+		AND p.ID_MEMBER = 0
+		AND t.ID_MEMBER_STARTED != 0");
+while ($row = mysqli_fetch_assoc($result))
+{
+	upgrade_query("
+		UPDATE {$db_prefix}polls
+		SET ID_MEMBER = $row[ID_MEMBER_STARTED]
+		WHERE ID_POLL = $row[ID_POLL]
+		LIMIT 1");
+}
+mysqli_free_result($result);
+---}
+---#
+
+/******************************************************************************/
+--- Converting settings...
+/******************************************************************************/
+
+---# Updating news...
+---{
+if (!isset($modSettings['smfVersion']))
+{
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('news', SUBSTRING('" . htmlspecialchars(stripslashes($modSettings['news']), ENT_QUOTES) . "', 1, 65534))");
+}
+---}
+---#
+
+---# Updating "themes"...
+---{
+convertSettingsToTheme();
+
+$insertRows = '';
+$request = upgrade_query("
+	SELECT ID_THEME, IF(value = '2', 5, value) AS value
+	FROM {$db_prefix}themes
+	WHERE variable = 'display_recent_bar'");
+while ($row = mysqli_fetch_assoc($request))
+	$insertRows .= "($row[ID_THEME], 'number_recent_posts', '$row[value]'),";
+mysqli_free_result($request);
+if (!empty($insertRows))
+{
+	$insertRows = substr($insertRows, 0, -1);
+	upgrade_query("
+		INSERT IGNORE INTO {$db_prefix}themes
+			(ID_THEME, variable, value)
+		VALUES $insertRows");
+}
+---}
+---#
+
+---# Updating "settings"...
+ALTER TABLE {$db_prefix}settings
+DROP INDEX variable;
+
+UPDATE IGNORE {$db_prefix}settings
+SET variable = 'guest_hideContacts'
+WHERE variable = 'guest_hideEmail'
+LIMIT 1;
+---#
+
+---# Adding new settings (part 1)...
+INSERT IGNORE INTO {$db_prefix}settings
+	(variable, value)
+VALUES
+	('news', ''),
+	('compactTopicPagesContiguous', '5'),
+	('compactTopicPagesEnable', '1'),
+	('enableStickyTopics', '1'),
+	('todayMod', '1'),
+	('karmaMode', '0'),
+	('karmaTimeRestrictAdmins', '1'),
+	('enablePreviousNext', '1'),
+	('pollMode', '1'),
+	('enableVBStyleLogin', '1'),
+	('enableCompressedOutput', '1'),
+	('karmaWaitTime', '1'),
+	('karmaMinPosts', '0'),
+	('karmaLabel', 'Karma:'),
+	('karmaSmiteLabel', '[smite]'),
+	('karmaApplaudLabel', '[applaud]'),
+	('attachmentSizeLimit', '128'),
+	('attachmentPostLimit', '192'),
+	('attachmentNumPerPostLimit', '4'),
+	('attachmentDirSizeLimit', '10240'),
+	('attachmentUploadDir', '{$sboarddir}/attachments'),
+	('attachmentExtensions', 'txt,doc,pdf,jpg,gif,mpg,png'),
+	('attachmentCheckExtensions', '1'),
+	('attachmentShowImages', '1'),
+	('attachmentEnable', '1'),
+	('attachmentEncryptFilenames', '1'),
+	('censorIgnoreCase', '1'),
+	('mostOnline', '1');
+INSERT IGNORE INTO {$db_prefix}settings
+	(variable, value)
+VALUES
+	('mostOnlineToday', '1'),
+	('mostDate', UNIX_TIMESTAMP()),
+	('trackStats', '1'),
+	('userLanguage', '1'),
+	('titlesEnable', '1'),
+	('topicSummaryPosts', '15'),
+	('enableErrorLogging', '1'),
+	('onlineEnable', '0'),
+	('cal_holidaycolor', '000080'),
+	('cal_bdaycolor', '920AC4'),
+	('cal_eventcolor', '078907'),
+	('cal_enabled', '0'),
+	('cal_maxyear', '2010'),
+	('cal_minyear', '2002'),
+	('cal_daysaslink', '0'),
+	('cal_defaultboard', ''),
+	('cal_showeventsonindex', '0'),
+	('cal_showbdaysonindex', '0'),
+	('cal_showholidaysonindex', '0'),
+	('cal_showweeknum', '0'),
+	('cal_maxspan', '7'),
+	('smtp_host', ''),
+	('smtp_username', ''),
+	('smtp_password', ''),
+	('mail_type', '0'),
+	('timeLoadPageEnable', '0'),
+	('totalTopics', '1'),
+	('totalMessages', '1'),
+	('simpleSearch', '0'),
+	('censor_vulgar', ''),
+	('censor_proper', ''),
+	('mostOnlineToday', '1'),
+	('enablePostHTML', '0'),
+	('theme_allow', '1'),
+	('theme_default', '1'),
+	('theme_guests', '1'),
+	('enableEmbeddedFlash', '0'),
+	('xmlnews_enable', '1'),
+	('xmlnews_maxlen', '255'),
+	('hotTopicPosts', '15'),
+	('hotTopicVeryPosts', '25'),
+	('allow_editDisplayName', '1'),
+	('number_format', '1234.00'),
+	('attachmentEncryptFilenames', '1'),
+	('autoLinkUrls', '1');
+INSERT IGNORE INTO {$db_prefix}settings
+	(variable, value)
+VALUES
+	('avatar_allow_server_stored', '1'),
+	('avatar_check_size', '0'),
+	('avatar_action_too_large', 'option_user_resize'),
+	('avatar_resize_upload', '1'),
+	('avatar_download_png', '1'),
+	('failed_login_threshold', '3'),
+	('edit_wait_time', '90'),
+	('autoFixDatabase', '1'),
+	('autoOptDatabase', '7'),
+	('autoOptMaxOnline', '0'),
+	('autoOptLastOpt', '0'),
+	('enableParticipation', '1'),
+	('recycle_enable', '0'),
+	('recycle_board', '0'),
+	('banLastUpdated', '0'),
+	('enableAllMessages', '0'),
+	('fixLongWords', '0'),
+	('knownThemes', '1,2'),
+	('who_enabled', '1'),
+	('lastActive', '15'),
+	('allow_hideOnline', '1'),
+	('guest_hideContacts', '0');
+---#
+
+---# Adding new settings (part 2)...
+---{
+upgrade_query("
+	INSERT IGNORE INTO {$db_prefix}settings
+		(variable, value)
+	VALUES
+		('registration_method', '" . (!empty($modSettings['registration_disabled']) ? 3 : (!empty($modSettings['approve_registration']) ? 2 : (!empty($GLOBALS['emailpassword']) || !empty($modSettings['send_validation']) ? 1 : 0))) . "'),
+		('send_validation_onChange', '" . @$GLOBALS['emailnewpass'] . "'),
+		('send_welcomeEmail', '" . @$GLOBALS['emailwelcome'] . "'),
+		('allow_hideEmail', '" . @$GLOBALS['allow_hide_email'] . "'),
+		('allow_guestAccess', '" . @$GLOBALS['guestaccess'] . "'),
+		('time_format', '" . (!empty($GLOBALS['timeformatstring']) ? $GLOBALS['timeformatstring'] : '%B %d, %Y, %I:%M:%S %p') . "'),
+		('enableBBC', '" . (!isset($GLOBALS['enable_ubbc']) ? 1 : $GLOBALS['enable_ubbc']) . "'),
+		('max_messageLength', '" . (empty($GLOBALS['MaxMessLen']) ? 10000 : $GLOBALS['MaxMessLen']) . "'),
+		('max_signatureLength', '" . @$GLOBALS['MaxSigLen'] . "'),
+		('spamWaitTime', '" . (empty($GLOBALS['timeout']) ? 5 : $GLOBALS['timeout']) . "'),
+		('avatar_directory', '" . (isset($GLOBALS['facesdir']) ? fixRelativePath($GLOBALS['facesdir']) : fixRelativePath('./avatars')) . "'),
+		('avatar_url', '" . @$GLOBALS['facesurl'] . "'),
+		('avatar_max_height_external', '" . @$GLOBALS['userpic_height'] . "'),
+		('avatar_max_width_external', '" . @$GLOBALS['userpic_width'] . "'),
+		('avatar_max_height_upload', '" . @$GLOBALS['userpic_height'] . "'),
+		('avatar_max_width_upload', '" . @$GLOBALS['userpic_width'] . "'),
+		('defaultMaxMessages', '" . (empty($GLOBALS['maxmessagedisplay']) ? 15 : $GLOBALS['maxmessagedisplay']) . "'),
+		('defaultMaxTopics', '" . (empty($GLOBALS['maxdisplay']) ? 20 : $GLOBALS['maxdisplay']) . "'),
+		('defaultMaxMembers', '" . (empty($GLOBALS['MembersPerPage']) ? 20 : $GLOBALS['MembersPerPage']) . "'),
+		('time_offset', '" . (empty($GLOBALS['timeoffset']) ? 0 : $GLOBALS['timeoffset']) . "'),
+		('cookieTime', '" . (empty($GLOBALS['Cookie_Length']) ? 60 : $GLOBALS['Cookie_Length']) . "'),
+		('requireAgreement', '" . @$GLOBALS['RegAgree'] . "')");
+---}
+
+INSERT IGNORE INTO {$db_prefix}settings
+	(variable, value)
+VALUES
+	('smileys_dir', '{$sboarddir}/Smileys'),
+	('smileys_url', '{$boardurl}/Smileys'),
+	('smiley_sets_known', 'default,classic'),
+	('smiley_sets_names', 'Default\nClassic'),
+	('smiley_sets_default', 'default'),
+	('censorIgnoreCase', '1'),
+	('cal_days_for_index', '7'),
+	('unapprovedMembers', '0'),
+	('default_personalText', ''),
+	('attachmentPostLimit', '192'),
+	('attachmentNumPerPostLimit', '4'),
+	('package_make_backups', '1'),
+	('databaseSession_loose', '1'),
+	('databaseSession_lifetime', '2880'),
+	('smtp_port', '25'),
+	('search_cache_size', '50'),
+	('search_results_per_page', '30'),
+	('search_weight_frequency', '30'),
+	('search_weight_age', '25'),
+	('search_weight_length', '20'),
+	('search_weight_subject', '15'),
+	('search_weight_first_message', '10');
+
+DELETE FROM {$db_prefix}settings
+WHERE variable = 'agreement'
+LIMIT 1;
+---#
+
+---# Converting settings to options...
+---{
+convertSettingsToOptions();
+---}
+---#
+
+---# Updating statistics...
+REPLACE INTO {$db_prefix}settings
+	(variable, value)
+SELECT 'latestMember', ID_MEMBER
+FROM {$db_prefix}members
+ORDER BY ID_MEMBER DESC
+LIMIT 1;
+
+REPLACE INTO {$db_prefix}settings
+	(variable, value)
+SELECT 'latestRealName', IFNULL(realName, memberName)
+FROM {$db_prefix}members
+ORDER BY ID_MEMBER DESC
+LIMIT 1;
+
+REPLACE INTO {$db_prefix}settings
+	(variable, value)
+SELECT 'maxMsgID', ID_MSG
+FROM {$db_prefix}messages
+ORDER BY ID_MSG DESC
+LIMIT 1;
+
+REPLACE INTO {$db_prefix}settings
+	(variable, value)
+SELECT 'totalMembers', COUNT(*)
+FROM {$db_prefix}members;
+
+REPLACE INTO {$db_prefix}settings
+	(variable, value)
+SELECT 'unapprovedMembers', COUNT(*)
+FROM {$db_prefix}members
+WHERE is_activated = 0
+	AND validation_code = '';
+
+REPLACE INTO {$db_prefix}settings
+	(variable, value)
+SELECT 'totalMessages', COUNT(*)
+FROM {$db_prefix}messages;
+
+REPLACE INTO {$db_prefix}settings
+	(variable, value)
+SELECT 'totalTopics', COUNT(*)
+FROM {$db_prefix}topics;
+
+REPLACE INTO {$db_prefix}settings
+	(variable, value)
+VALUES ('cal_today_updated', '00000000');
+
+REPLACE INTO {$db_prefix}settings
+	(variable, value)
+VALUES ('enable_password_conversion', '1');
+---#
\ No newline at end of file
diff --git a/upgrade_1-1.sql b/upgrade_1-1.sql
new file mode 100644
index 0000000..9ad3e4d
--- /dev/null
+++ b/upgrade_1-1.sql
@@ -0,0 +1,2546 @@
+/* ATTENTION: You don't need to run or use this file!  The upgrade.php script does everything for you! */
+
+/******************************************************************************/
+--- Updating and creating indexes...
+/******************************************************************************/
+
+---# Updating indexes on "messages"...
+---{
+$request = upgrade_query("
+	SHOW KEYS
+	FROM {$db_prefix}messages");
+$found = false;
+while ($row = mysqli_fetch_assoc($request))
+	$found |= $row['Key_name'] == 'ID_BOARD' && $row['Column_name'] == 'ID_MSG';
+mysqli_free_result($request);
+
+if (!$found)
+	upgrade_query("
+		ALTER TABLE {$db_prefix}messages
+		DROP INDEX ID_BOARD");
+---}
+---#
+
+---# Updating table indexes...
+---{
+$_GET['mess_ind'] = isset($_GET['mess_ind']) ? (int) $_GET['mess_ind'] : 0;
+$step_progress['name'] = 'Updating table indexes';
+$step_progress['current'] = $_GET['mess_ind'];
+$custom_warning = 'On a very large board these indexes may take a few minutes to create.';
+
+$index_changes = array(
+	array(
+		'table' => 'log_errors',
+		'type' => 'index',
+		'method' => 'add',
+		'name' => 'ID_MEMBER',
+		'target_columns' => array('ID_MEMBER'),
+		'text' => 'ADD INDEX ID_MEMBER (ID_MEMBER)',
+	),
+	array(
+		'table' => 'log_errors',
+		'type' => 'index',
+		'method' => 'add',
+		'name' => 'IP',
+		'target_columns' => array('IP'),
+		'text' => 'ADD INDEX IP (IP(15))',
+	),
+	array(
+		'table' => 'log_online',
+		'type' => 'index',
+		'method' => 'add',
+		'name' => 'logTime',
+		'target_columns' => array('logTime'),
+		'text' => 'ADD INDEX logTime (logTime)',
+	),
+	array(
+		'table' => 'log_online',
+		'type' => 'index',
+		'method' => 'remove',
+		'name' => 'online',
+		'target_columns' => array('online'),
+		'text' => 'DROP INDEX online',
+	),
+	array(
+		'table' => 'smileys',
+		'type' => 'index',
+		'method' => 'remove',
+		'name' => 'smileyOrder',
+		'target_columns' => array('smileyOrder'),
+		'text' => 'DROP INDEX smileyOrder',
+	),
+	array(
+		'table' => 'boards',
+		'type' => 'index',
+		'method' => 'add',
+		'name' => 'ID_PARENT',
+		'target_columns' => array('ID_PARENT'),
+		'text' => 'ADD INDEX ID_PARENT (ID_PARENT)',
+	),
+	array(
+		'table' => 'boards',
+		'type' => 'index',
+		'method' => 'remove',
+		'name' => 'children',
+		'target_columns' => array('children'),
+		'text' => 'DROP INDEX children',
+	),
+	array(
+		'table' => 'boards',
+		'type' => 'index',
+		'method' => 'remove',
+		'name' => 'boardOrder',
+		'target_columns' => array('boardOrder'),
+		'text' => 'DROP INDEX boardOrder',
+	),
+	array(
+		'table' => 'categories',
+		'type' => 'index',
+		'method' => 'remove',
+		'name' => 'catOrder',
+		'target_columns' => array('catOrder'),
+		'text' => 'DROP INDEX catOrder',
+	),
+	array(
+		'table' => 'messages',
+		'type' => 'index',
+		'method' => 'add',
+		'name' => 'ID_TOPIC',
+		'target_columns' => array('ID_TOPIC'),
+		'text' => 'ADD INDEX ID_TOPIC (ID_TOPIC)',
+	),
+	array(
+		'table' => 'messages',
+		'type' => 'index',
+		'method' => 'remove',
+		'name' => 'ID_MEMBER',
+		'target_columns' => array('ID_MEMBER'),
+		'text' => 'DROP INDEX ID_MEMBER',
+	),
+	array(
+		'table' => 'messages',
+		'type' => 'index',
+		'method' => 'add',
+		'name' => 'ID_BOARD',
+		'target_columns' => array('ID_BOARD', 'ID_MSG'),
+		'text' => 'ADD UNIQUE ID_BOARD (ID_BOARD, ID_MSG)',
+	),
+	array(
+		'table' => 'messages',
+		'type' => 'index',
+		'method' => 'add',
+		'name' => 'ID_MEMBER',
+		'target_columns' => array('ID_MEMBER', 'ID_MSG'),
+		'text' => 'ADD UNIQUE ID_MEMBER (ID_MEMBER, ID_MSG)',
+	),
+	array(
+		'table' => 'messages',
+		'type' => 'index',
+		'method' => 'add',
+		'name' => 'showPosts',
+		'target_columns' => array('ID_MEMBER', 'ID_BOARD'),
+		'text' => 'ADD INDEX showPosts (ID_MEMBER, ID_BOARD)',
+	),
+);
+
+$step_progress['total'] = count($index_changes);
+
+// Now we loop through the changes and work out where the hell we are.
+foreach ($index_changes as $ind => $change)
+{
+	// Already done it?
+	if ($_GET['mess_ind'] > $ind)
+		continue;
+
+	// Make the index, with all the protection and all.
+	protected_alter($change, $substep);
+
+	// Store this for the next table.
+	$_GET['mess_ind']++;
+	$step_progress['current'] = $_GET['mess_ind'];
+}
+
+// Clean up.
+unset($_GET['mess_ind']);
+---}
+---#
+
+---# Reordering boards and categories...
+ALTER TABLE {$db_prefix}categories
+ORDER BY catOrder;
+
+ALTER TABLE {$db_prefix}boards
+ORDER BY boardOrder;
+---#
+
+---# Updating indexes and data on "smileys"...
+ALTER TABLE {$db_prefix}smileys
+CHANGE COLUMN smileyOrder smileyOrder smallint(5) unsigned NOT NULL default '0';
+
+UPDATE {$db_prefix}smileys
+SET filename = 'embarrassed.gif'
+WHERE filename = 'embarassed.gif';
+---#
+
+---# Updating indexes on "log_boards"...
+ALTER TABLE {$db_prefix}log_boards
+DROP PRIMARY KEY,
+ADD PRIMARY KEY (ID_MEMBER, ID_BOARD);
+---#
+
+---# Updating indexes on "log_mark_read"...
+ALTER TABLE {$db_prefix}log_mark_read
+DROP PRIMARY KEY,
+ADD PRIMARY KEY (ID_MEMBER, ID_BOARD);
+---#
+
+---# Updating indexes on "themes"...
+ALTER TABLE {$db_prefix}themes
+DROP PRIMARY KEY,
+ADD PRIMARY KEY (ID_THEME, ID_MEMBER, variable(30)),
+ADD INDEX ID_MEMBER (ID_MEMBER);
+---#
+
+/******************************************************************************/
+--- Reorganizing configuration settings...
+/******************************************************************************/
+
+---# Updating data in "settings"...
+REPLACE INTO {$db_prefix}settings
+	(variable, value)
+SELECT 'totalMembers', COUNT(*)
+FROM {$db_prefix}members;
+
+UPDATE {$db_prefix}settings
+SET variable = 'notify_new_registration'
+WHERE variable = 'notify_on_new_registration'
+LIMIT 1;
+
+UPDATE IGNORE {$db_prefix}settings
+SET variable = 'max_image_width'
+WHERE variable = 'maxwidth'
+LIMIT 1;
+
+UPDATE IGNORE {$db_prefix}settings
+SET variable = 'max_image_height'
+WHERE variable = 'maxheight'
+LIMIT 1;
+
+UPDATE {$db_prefix}settings
+SET value = IF(value = 'sendmail' OR value = '0', '0', '1')
+WHERE variable = 'mail_type'
+LIMIT 1;
+
+UPDATE IGNORE {$db_prefix}settings
+SET variable = 'search_method'
+WHERE variable = 'search_match_complete_words'
+LIMIT 1;
+
+UPDATE IGNORE {$db_prefix}settings
+SET variable = 'allow_disableAnnounce'
+WHERE variable = 'notifyAnncmnts_UserDisable'
+LIMIT 1;
+---#
+
+---# Adding new settings...
+INSERT IGNORE INTO {$db_prefix}settings
+	(variable, value)
+VALUES ('edit_disable_time', '0'),
+	('oldTopicDays', '120'),
+	('cal_showeventsoncalendar', '1'),
+	('cal_showbdaysoncalendar', '1'),
+	('cal_showholidaysoncalendar', '1'),
+	('allow_disableAnnounce', '1'),
+	('attachmentThumbnails', '1'),
+	('attachmentThumbWidth', '150'),
+	('attachmentThumbHeight', '150'),
+	('max_pm_recipients', '10');
+
+---{
+if (@$modSettings['smfVersion'] < '1.1')
+{
+	// Hopefully 90 days is enough?
+	upgrade_query("
+		INSERT INTO {$db_prefix}settings
+			(variable, value)
+		VALUES ('disableHashTime', " . (time() + 7776000) . ")");
+}
+
+if (isset($modSettings['smfVersion']) && $modSettings['smfVersion'] <= '1.1 Beta 4')
+{
+	// Enable the buddy list for those used to it.
+	upgrade_query("
+		INSERT INTO {$db_prefix}settings
+			(variable, value)
+		VALUES ('enable_buddylist', '1')");
+}
+---}
+---#
+
+---# Adding PM spam protection settings.
+---{
+if (empty($modSettings['pm_spam_settings']))
+{
+	if (isset($modSettings['max_pm_recipients']))
+		$modSettings['pm_spam_settings'] = (int) $modSettings['max_pm_recipients'] . ',5,20';
+	else
+		$modSettings['pm_spam_settings'] = '10,5,20';
+
+	upgrade_query("
+		INSERT IGNORE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('pm_spam_settings', '$modSettings[pm_spam_settings]')");
+}
+upgrade_query("
+	DELETE FROM {$db_prefix}settings
+	WHERE variable = 'max_pm_recipients'");
+---}
+---#
+
+---# Cleaning old values from "settings"...
+DELETE FROM {$db_prefix}settings
+WHERE variable IN ('modlog_enabled', 'localCookies', 'globalCookies', 'send_welcomeEmail', 'search_method', 'notify_new_registration', 'removeNestedQuotes', 'smiley_enable', 'smiley_sets_enable')
+	AND value = '0';
+
+DELETE FROM {$db_prefix}settings
+WHERE variable IN ('allow_guestAccess', 'userLanguage', 'allow_editDisplayName', 'allow_hideOnline', 'allow_hideEmail', 'guest_hideContacts', 'titlesEnable', 'search_match_complete_words')
+	AND value = '0';
+
+DELETE FROM {$db_prefix}settings
+WHERE variable IN ('cal_allowspan', 'hitStats', 'queryless_urls', 'disableHostnameLookup', 'messageIcons_enable', 'disallow_sendBody', 'censorWholeWord')
+	AND value = '0';
+
+DELETE FROM {$db_prefix}settings
+WHERE variable IN (
+	'totalMessag',
+	'redirectMetaRefresh',
+	'memberCount',
+	'cal_today_u',
+	'approve_registration',
+	'registration_disabled',
+	'requireRegistrationVerification',
+	'returnToPost',
+	'send_validation',
+	'search_max_cached_results',
+	'disableTemporaryTables',
+	'search_cache_size',
+	'enableReportToMod'
+);
+---#
+
+---# Encoding SMTP password...
+---{
+// Can't do this more than once, we just can't...
+if ((!isset($modSettings['smfVersion']) || $modSettings['smfVersion'] <= '1.1 RC1') && empty($modSettings['dont_repeat_smtp']))
+{
+	if (!empty($modSettings['smtp_password']))
+	{
+		upgrade_query("
+			UPDATE {$db_prefix}settings
+			SET value = '" . base64_encode($modSettings['smtp_password']) . "'
+			WHERE variable = 'smtp_password'");
+	}
+	// Don't let this run twice!
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('dont_repeat_smtp', '1')");
+}
+
+---}
+---#
+
+---# Adjusting timezone settings...
+---{
+	if (!isset($modSettings['default_timezone']) && function_exists('date_default_timezone_set'))
+	{
+		$server_offset = mktime(0, 0, 0, 1, 1, 1970);
+		$timezone_id = 'Etc/GMT' . ($server_offset > 0 ? '+' : '') . ($server_offset / 3600);
+		if (date_default_timezone_set($timezone_id))
+			upgrade_query("
+				REPLACE INTO {$db_prefix}settings
+					(variable, value)
+				VALUES
+					('default_timezone', '$timezone_id')");
+	}
+---}
+---#
+
+/******************************************************************************/
+--- Cleaning up after old themes...
+/******************************************************************************/
+
+---# Checking for "classic" and removing it if necessary...
+---{
+// Do they have "classic" installed?
+if (file_exists($GLOBALS['boarddir'] . '/Themes/classic'))
+{
+	$classic_dir = mysqli_real_escape_string($db_connection, $GLOBALS['boarddir'] . '/Themes/classic');
+	$theme_request = upgrade_query("
+		SELECT ID_THEME
+		FROM {$db_prefix}themes
+		WHERE variable = 'theme_dir'
+			AND value ='$classic_dir'");
+
+	// Don't do anything if this theme is already uninstalled
+	if (mysqli_num_rows($theme_request) == 1)
+	{
+		list($id_theme) = mysqli_fetch_row($theme_request);
+		mysqli_free_result($theme_request);
+
+		$known_themes = explode(',', $modSettings['knownThemes']);
+
+		// Remove this value...
+		$known_themes = array_diff($known_themes, array($id_theme));
+
+		// Change back to a string...
+		$known_themes = implode(',', $known_themes);
+
+		// Update the database
+		upgrade_query("
+			REPLACE INTO {$db_prefix}settings (variable, value)
+			VALUES ('knownThemes', '$known_themes')");
+
+		// Delete any info about this theme
+		upgrade_query("
+			DELETE FROM {$db_prefix}themes
+			WHERE ID_THEME = $id_theme");
+
+		// Set any members or boards using this theme to the default
+		upgrade_query("
+			UPDATE {$db_prefix}members
+			SET ID_THEME = 0
+			WHERE ID_THEME = $id_theme");
+
+		upgrade_query("
+			UPDATE {$db_prefix}boards
+			SET ID_THEME = 0
+			WHERE ID_THEME = $id_theme");
+
+		if ($modSettings['theme_guests'] == $id_theme)
+		{
+			upgrade_query("
+				REPLACE INTO {$db_prefix}settings
+				(variable, value)
+				VALUES('theme_guests', 0)");
+		}
+	}
+}
+---}
+---#
+
+/******************************************************************************/
+--- Adding and updating member data...
+/******************************************************************************/
+
+---# Renaming personal message tables...
+RENAME TABLE {$db_prefix}instant_messages
+TO {$db_prefix}personal_messages;
+
+RENAME TABLE {$db_prefix}im_recipients
+TO {$db_prefix}pm_recipients;
+---#
+
+---# Updating indexes on "pm_recipients"...
+ALTER TABLE {$db_prefix}pm_recipients
+DROP INDEX ID_MEMBER,
+ADD UNIQUE ID_MEMBER (ID_MEMBER, deleted, ID_PM);
+---#
+
+---# Updating columns on "pm_recipients"...
+ALTER TABLE {$db_prefix}pm_recipients
+ADD COLUMN labels varchar(60) NOT NULL default '-1';
+
+ALTER TABLE {$db_prefix}pm_recipients
+CHANGE COLUMN labels labels varchar(60) NOT NULL default '-1';
+
+UPDATE {$db_prefix}pm_recipients
+SET labels = '-1'
+WHERE labels NOT RLIKE '[0-9,\-]' OR labels = '';
+---#
+
+---# Updating columns on "members"...
+ALTER TABLE {$db_prefix}members
+ADD COLUMN messageLabels text NOT NULL,
+ADD COLUMN buddy_list tinytext NOT NULL,
+ADD COLUMN notifySendBody tinyint(4) NOT NULL default '0',
+ADD COLUMN notifyTypes tinyint(4) NOT NULL default '2',
+CHANGE COLUMN im_ignore_list pm_ignore_list tinytext NOT NULL,
+CHANGE COLUMN im_email_notify pm_email_notify tinyint(4) NOT NULL default '0';
+---#
+
+---# Updating columns on "members" - part 2...
+ALTER TABLE {$db_prefix}members
+CHANGE COLUMN secretAnswer secretAnswer varchar(64) NOT NULL default '';
+
+ALTER TABLE {$db_prefix}members
+ADD COLUMN memberIP2 tinytext NOT NULL;
+---#
+
+---# Updating member approval...
+---{
+// Although it *shouldn't* matter, best to do it just once to be sure.
+if (@$modSettings['smfVersion'] < '1.1')
+{
+	upgrade_query("
+		UPDATE {$db_prefix}members
+		SET is_activated = 3
+		WHERE validation_code = ''
+			AND is_activated = 0");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Updating holidays and calendar...
+/******************************************************************************/
+
+---# Adding new holidays...
+---{
+$result = upgrade_query("
+	SELECT ID_HOLIDAY
+	FROM {$db_prefix}calendar_holidays
+	WHERE YEAR(eventDate) > 2010
+	LIMIT 1");
+$do_it = mysqli_num_rows($result) == 0;
+mysqli_free_result($result);
+
+if ($do_it)
+{
+	upgrade_query("
+		INSERT INTO {$db_prefix}calendar_holidays
+			(title, eventDate)
+		VALUES
+			('Mother\\'s Day', '2011-05-08'),
+			('Mother\\'s Day', '2012-05-13'),
+			('Mother\\'s Day', '2013-05-12'),
+			('Mother\\'s Day', '2014-05-11'),
+			('Mother\\'s Day', '2015-05-10'),
+			('Mother\\'s Day', '2016-05-08'),
+			('Mother\\'s Day', '2017-05-14'),
+			('Mother\\'s Day', '2018-05-13'),
+			('Mother\\'s Day', '2019-05-12'),
+			('Mother\\'s Day', '2020-05-10'),
+			('Father\\'s Day', '2011-06-19'),
+			('Father\\'s Day', '2012-06-17'),
+			('Father\\'s Day', '2013-06-16'),
+			('Father\\'s Day', '2014-06-15'),
+			('Father\\'s Day', '2015-06-21'),
+			('Father\\'s Day', '2016-06-19'),
+			('Father\\'s Day', '2017-06-18'),
+			('Father\\'s Day', '2018-06-17'),
+			('Father\\'s Day', '2019-06-16'),
+			('Father\\'s Day', '2020-06-21'),
+			('Summer Solstice', '2011-06-21'),
+			('Summer Solstice', '2012-06-20'),
+			('Summer Solstice', '2013-06-21'),
+			('Summer Solstice', '2014-06-21'),
+			('Summer Solstice', '2015-06-21'),
+			('Summer Solstice', '2016-06-20'),
+			('Summer Solstice', '2017-06-20'),
+			('Summer Solstice', '2018-06-21'),
+			('Summer Solstice', '2019-06-21'),
+			('Summer Solstice', '2020-06-20'),
+			('Vernal Equinox', '2011-03-20'),
+			('Vernal Equinox', '2012-03-20'),
+			('Vernal Equinox', '2013-03-20'),
+			('Vernal Equinox', '2014-03-20'),
+			('Vernal Equinox', '2015-03-20'),
+			('Vernal Equinox', '2016-03-19'),
+			('Vernal Equinox', '2017-03-20'),
+			('Vernal Equinox', '2018-03-20'),
+			('Vernal Equinox', '2019-03-20'),
+			('Vernal Equinox', '2020-03-19'),
+			('Winter Solstice', '2011-12-22'),
+			('Winter Solstice', '2012-12-21'),
+			('Winter Solstice', '2013-12-21'),
+			('Winter Solstice', '2014-12-21'),
+			('Winter Solstice', '2015-12-21'),
+			('Winter Solstice', '2016-12-21'),
+			('Winter Solstice', '2017-12-21'),
+			('Winter Solstice', '2018-12-21'),
+			('Winter Solstice', '2019-12-21'),
+			('Winter Solstice', '2020-12-21'),
+			('Autumnal Equinox', '2011-09-23'),
+			('Autumnal Equinox', '2012-09-22'),
+			('Autumnal Equinox', '2013-09-22'),
+			('Autumnal Equinox', '2014-09-22'),
+			('Autumnal Equinox', '2015-09-23'),
+			('Autumnal Equinox', '2016-09-22'),
+			('Autumnal Equinox', '2017-09-22'),
+			('Autumnal Equinox', '2018-09-22'),
+			('Autumnal Equinox', '2019-09-23'),
+			('Autumnal Equinox', '2020-09-22'),
+			('Thanksgiving', '2011-11-24'),
+			('Thanksgiving', '2012-11-22'),
+			('Thanksgiving', '2013-11-21'),
+			('Thanksgiving', '2014-11-20'),
+			('Thanksgiving', '2015-11-26'),
+			('Thanksgiving', '2016-11-24'),
+			('Thanksgiving', '2017-11-23'),
+			('Thanksgiving', '2018-11-22'),
+			('Thanksgiving', '2019-11-21'),
+			('Thanksgiving', '2020-11-26'),
+			('Memorial Day', '2011-05-30'),
+			('Memorial Day', '2012-05-28'),
+			('Memorial Day', '2013-05-27'),
+			('Memorial Day', '2014-05-26'),
+			('Memorial Day', '2015-05-25'),
+			('Memorial Day', '2016-05-30'),
+			('Memorial Day', '2017-05-29'),
+			('Memorial Day', '2018-05-28'),
+			('Memorial Day', '2019-05-27'),
+			('Memorial Day', '2020-05-25'),
+			('Labor Day', '2011-09-05'),
+			('Labor Day', '2012-09-03'),
+			('Labor Day', '2013-09-09'),
+			('Labor Day', '2014-09-08'),
+			('Labor Day', '2015-09-07'),
+			('Labor Day', '2016-09-05'),
+			('Labor Day', '2017-09-04'),
+			('Labor Day', '2018-09-03'),
+			('Labor Day', '2019-09-09'),
+			('Labor Day', '2020-09-07')");
+}
+---}
+---#
+
+---# Updating event start and end dates...
+ALTER TABLE {$db_prefix}calendar
+DROP INDEX eventDate;
+
+ALTER TABLE {$db_prefix}calendar
+CHANGE COLUMN eventDate startDate date NOT NULL default '0001-01-01';
+
+ALTER TABLE {$db_prefix}calendar
+CHANGE COLUMN startDate startDate date NOT NULL default '0001-01-01';
+
+UPDATE {$db_prefix}calendar
+SET startDate = '0001-01-01'
+WHERE startDate = '0000-00-00';
+
+ALTER TABLE {$db_prefix}calendar
+ADD COLUMN endDate date NOT NULL default '0001-01-01';
+
+ALTER TABLE {$db_prefix}calendar
+CHANGE COLUMN endDate endDate date NOT NULL default '0001-01-01';
+
+UPDATE {$db_prefix}calendar
+SET endDate = startDate
+WHERE endDate = '0001-01-01'
+	OR endDate = '0000-00-00';
+
+ALTER TABLE {$db_prefix}calendar
+ADD INDEX startDate (startDate),
+ADD INDEX endDate (endDate);
+
+ALTER TABLE {$db_prefix}calendar
+DROP INDEX ID_TOPIC;
+
+ALTER TABLE {$db_prefix}calendar
+ADD INDEX topic (ID_TOPIC, ID_MEMBER);
+
+ALTER TABLE {$db_prefix}calendar_holidays
+CHANGE COLUMN eventDate eventDate date NOT NULL default '0001-01-01';
+
+UPDATE {$db_prefix}calendar_holidays
+SET eventDate = '0001-01-01'
+WHERE eventDate = '0000-00-00';
+
+UPDATE {$db_prefix}calendar_holidays
+SET eventDate = CONCAT('0004-', MONTH(eventDate), '-', DAYOFMONTH(eventDate))
+WHERE YEAR(eventDate) = 0;
+---#
+
+---# Converting other date columns...
+ALTER TABLE {$db_prefix}log_activity
+CHANGE COLUMN startDate date date NOT NULL default '0001-01-01';
+
+ALTER TABLE {$db_prefix}log_activity
+CHANGE COLUMN date date date NOT NULL default '0001-01-01';
+
+UPDATE {$db_prefix}log_activity
+SET date = '0001-01-01'
+WHERE date = '0000-00-00';
+
+ALTER TABLE {$db_prefix}members
+CHANGE COLUMN birthdate birthdate date NOT NULL default '0001-01-01';
+
+UPDATE {$db_prefix}members
+SET birthdate = '0001-01-01'
+WHERE birthdate = '0000-00-00';
+
+UPDATE {$db_prefix}members
+SET birthdate = CONCAT('0004-', MONTH(birthdate), '-', DAYOFMONTH(birthdate))
+WHERE YEAR(birthdate) = 0;
+---#
+
+/******************************************************************************/
+--- Adding custom message icons...
+/******************************************************************************/
+
+---# Checking for an old table...
+---{
+$request = upgrade_query("
+	SHOW COLUMNS
+	FROM {$db_prefix}message_icons");
+$test = false;
+while ($request && $row = mysqli_fetch_row($request))
+	$test |= $row[0] == 'Name';
+if ($request)
+	mysqli_free_result($request);
+
+if ($test)
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}message_icons
+		DROP PRIMARY KEY,
+		CHANGE COLUMN id_icon id_icon smallint(5) unsigned NOT NULL auto_increment PRIMARY KEY,
+		CHANGE COLUMN Name filename varchar(80) NOT NULL default '',
+		CHANGE COLUMN Description title varchar(80) NOT NULL default '',
+		CHANGE COLUMN ID_BOARD ID_BOARD mediumint(8) unsigned NOT NULL default '0',
+		DROP INDEX id_icon,
+		ADD COLUMN iconOrder smallint(5) unsigned NOT NULL default '0'");
+}
+---}
+---#
+
+---# Creating "message_icons"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}message_icons (
+	id_icon smallint(5) unsigned NOT NULL auto_increment,
+	title varchar(80) NOT NULL default '',
+	filename varchar(80) NOT NULL default '',
+	ID_BOARD mediumint(8) unsigned NOT NULL default 0,
+	iconOrder smallint(5) unsigned NOT NULL default 0,
+	PRIMARY KEY (id_icon),
+	KEY ID_BOARD (ID_BOARD)
+) ENGINE=MyISAM;
+---#
+
+---# Inserting "message_icons"...
+---{
+// We do not want to do this twice!
+if (@$modSettings['smfVersion'] < '1.1')
+{
+	upgrade_query("
+		INSERT INTO {$db_prefix}message_icons
+			(filename, title, iconOrder)
+		VALUES ('xx', 'Standard', '0'),
+			('thumbup', 'Thumb Up', '1'),
+			('thumbdown', 'Thumb Down', '2'),
+			('exclamation', 'Exclamation point', '3'),
+			('question', 'Question mark', '4'),
+			('lamp', 'Lamp', '5'),
+			('smiley', 'Smiley', '6'),
+			('angry', 'Angry', '7'),
+			('cheesy', 'Cheesy', '8'),
+			('grin', 'Grin', '9'),
+			('sad', 'Sad', '10'),
+			('wink', 'Wink', '11')");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Adding package servers...
+/******************************************************************************/
+
+---# Creating "package_servers"...
+CREATE TABLE IF NOT EXISTS {$db_prefix}package_servers (
+	id_server smallint(5) unsigned NOT NULL auto_increment,
+	name tinytext NOT NULL,
+	url tinytext NOT NULL,
+	PRIMARY KEY (id_server)
+) ENGINE=MyISAM;
+---#
+
+---# Inserting "package_servers"...
+INSERT IGNORE INTO {$db_prefix}package_servers
+	(id_server, name, url)
+VALUES
+	(1, 'Simple Machines Third-party Mod Site', 'http://mods.simplemachines.org');
+---#
+
+/******************************************************************************/
+--- Cleaning up database...
+/******************************************************************************/
+
+---# Updating flood control log...
+ALTER TABLE {$db_prefix}log_floodcontrol
+CHANGE COLUMN ip ip char(16) NOT NULL default '                ';
+
+ALTER TABLE {$db_prefix}log_floodcontrol
+DROP INDEX logTime;
+---#
+
+---# Updating ip address storage...
+ALTER TABLE {$db_prefix}log_actions
+CHANGE COLUMN IP ip char(16) NOT NULL default '                ';
+
+ALTER TABLE {$db_prefix}log_banned
+CHANGE COLUMN IP ip char(16) NOT NULL default '                ';
+
+ALTER TABLE {$db_prefix}log_banned
+DROP COLUMN ban_ids;
+
+ALTER TABLE {$db_prefix}log_errors
+DROP INDEX IP,
+CHANGE COLUMN IP ip char(16) NOT NULL default '                ',
+ADD INDEX ip (ip(16));
+---#
+
+---# Converting "log_online"...
+DROP TABLE IF EXISTS {$db_prefix}log_online;
+CREATE TABLE {$db_prefix}log_online (
+	session char(32) NOT NULL default '                                ',
+	logTime timestamp /*!40102 NOT NULL default CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP */,
+	ID_MEMBER mediumint(8) unsigned NOT NULL default '0',
+	ip int(10) unsigned NOT NULL default '0',
+	url text NOT NULL,
+	PRIMARY KEY (session),
+	KEY online (logTime, ID_MEMBER),
+	KEY ID_MEMBER (ID_MEMBER)
+) ENGINE=MyISAM;
+---#
+
+---# Updating poll column sizes...
+ALTER TABLE {$db_prefix}polls
+CHANGE COLUMN maxVotes maxVotes tinyint(3) unsigned NOT NULL default '1',
+CHANGE COLUMN hideResults hideResults tinyint(3) unsigned NOT NULL default '0',
+CHANGE COLUMN changeVote changeVote tinyint(3) unsigned NOT NULL default '0';
+
+ALTER TABLE {$db_prefix}poll_choices
+CHANGE COLUMN ID_CHOICE ID_CHOICE tinyint(3) unsigned NOT NULL default '0';
+
+ALTER TABLE {$db_prefix}log_polls
+CHANGE COLUMN ID_CHOICE ID_CHOICE tinyint(3) unsigned NOT NULL default '0';
+---#
+
+---# Updating attachments table...
+ALTER TABLE {$db_prefix}attachments
+DROP PRIMARY KEY,
+CHANGE COLUMN ID_ATTACH ID_ATTACH int(10) unsigned NOT NULL auto_increment PRIMARY KEY;
+---#
+
+---# Updating boards and topics...
+ALTER TABLE {$db_prefix}topics
+CHANGE COLUMN numReplies numReplies int(10) unsigned NOT NULL default 0,
+CHANGE COLUMN numViews numViews int(10) unsigned NOT NULL default 0;
+---#
+
+---# Updating members...
+ALTER TABLE {$db_prefix}members
+CHANGE COLUMN lastLogin lastLogin int(10) unsigned NOT NULL default 0;
+---#
+
+---# Recounting member pm totals (step 1)...
+---{
+$request = upgrade_query("
+	SELECT COUNT(*)
+	FROM {$db_prefix}members");
+list ($totalMembers) = mysqli_fetch_row($request);
+mysqli_free_result($request);
+
+$_GET['m'] = isset($_GET['m']) ? (int) $_GET['m'] : 0;
+
+while ($_GET['m'] < $totalMembers)
+{
+	nextSubstep($substep);
+
+	$mrequest = upgrade_query("
+		SELECT mem.ID_MEMBER, COUNT(pmr.ID_PM) AS instantMessages_real, mem.instantMessages
+		FROM {$db_prefix}members AS mem
+			LEFT JOIN {$db_prefix}pm_recipients AS pmr ON (pmr.ID_MEMBER = mem.ID_MEMBER AND pmr.deleted = 0)
+		WHERE mem.ID_MEMBER > $_GET[m]
+			AND mem.ID_MEMBER <= $_GET[m] + 128
+		GROUP BY mem.ID_MEMBER, mem.instantMessages
+		HAVING instantMessages_real != instantMessages
+		LIMIT 256");
+	while ($row = mysqli_fetch_assoc($mrequest))
+	{
+		upgrade_query("
+			UPDATE {$db_prefix}members
+			SET instantMessages = $row[instantMessages_real]
+			WHERE ID_MEMBER = $row[ID_MEMBER]
+			LIMIT 1");
+	}
+
+	$_GET['m'] += 128;
+}
+unset($_GET['m']);
+---}
+---#
+
+---# Recounting member pm totals (step 2)...
+---{
+$request = upgrade_query("
+	SELECT COUNT(*)
+	FROM {$db_prefix}members");
+list ($totalMembers) = mysqli_fetch_row($request);
+mysqli_free_result($request);
+
+$_GET['m'] = isset($_GET['m']) ? (int) $_GET['m'] : 0;
+
+while ($_GET['m'] < $totalMembers)
+{
+	nextSubstep($substep);
+
+	$mrequest = upgrade_query("
+		SELECT mem.ID_MEMBER, COUNT(pmr.ID_PM) AS unreadMessages_real, mem.unreadMessages
+		FROM {$db_prefix}members AS mem
+			LEFT JOIN {$db_prefix}pm_recipients AS pmr ON (pmr.ID_MEMBER = mem.ID_MEMBER AND pmr.deleted = 0 AND pmr.is_read = 0)
+		WHERE mem.ID_MEMBER > $_GET[m]
+			AND mem.ID_MEMBER <= $_GET[m] + 128
+		GROUP BY mem.ID_MEMBER, mem.unreadMessages
+		HAVING unreadMessages_real != unreadMessages
+		LIMIT 256");
+	while ($row = mysqli_fetch_assoc($mrequest))
+	{
+		upgrade_query("
+			UPDATE {$db_prefix}members
+			SET unreadMessages = $row[unreadMessages_real]
+			WHERE ID_MEMBER = $row[ID_MEMBER]
+			LIMIT 1");
+	}
+
+	$_GET['m'] += 128;
+}
+unset($_GET['m']);
+---}
+---#
+
+/******************************************************************************/
+--- Converting avatar permissions...
+/******************************************************************************/
+
+---# Converting server stored setting...
+---{
+if (!empty($modSettings['avatar_allow_server_stored']))
+{
+	// Create permissions for existing membergroups.
+	upgrade_query("
+		INSERT INTO {$db_prefix}permissions
+			(ID_GROUP, permission)
+		SELECT IF(ID_GROUP = 1, 0, ID_GROUP), 'profile_server_avatar'
+		FROM {$db_prefix}membergroups
+		WHERE ID_GROUP != 3
+			AND minPosts = -1");
+}
+---}
+---#
+
+---# Converting avatar upload setting...
+---{
+// Do the same, but for uploading avatars.
+if (!empty($modSettings['avatar_allow_upload']))
+{
+	// Put in these permissions
+	upgrade_query("
+		INSERT INTO {$db_prefix}permissions
+			(ID_GROUP, permission)
+		SELECT IF(ID_GROUP = 1, 0, ID_GROUP), 'profile_upload_avatar'
+		FROM {$db_prefix}membergroups
+		WHERE ID_GROUP != 3
+			AND minPosts = -1");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Adjusting uploadable avatars...
+/******************************************************************************/
+
+---# Updating attachments...
+ALTER TABLE {$db_prefix}attachments
+CHANGE COLUMN ID_MEMBER ID_MEMBER mediumint(8) unsigned NOT NULL default '0';
+---#
+
+---# Updating settings...
+DELETE FROM {$db_prefix}settings
+WHERE variable IN ('avatar_allow_external_url', 'avatar_check_size', 'avatar_allow_upload', 'avatar_allow_server_stored');
+---#
+
+/******************************************************************************/
+--- Updating thumbnails...
+/******************************************************************************/
+
+---# Registering thumbs...
+---{
+// Checkout the current structure of the attachment table.
+$request = upgrade_query("
+	SHOW COLUMNS
+	FROM {$db_prefix}attachments");
+$has_customAvatarDir_column = false;
+$has_attachmentType_column = false;
+while ($row = mysqli_fetch_assoc($request))
+{
+	$has_customAvatarDir_column |= $row['Field'] == 'customAvatarDir';
+	$has_attachmentType_column |= $row['Field'] == 'attachmentType';
+}
+mysqli_free_result($request);
+
+// Post SMF 1.1 Beta 1.
+if ($has_customAvatarDir_column)
+	$request = upgrade_query("
+		ALTER TABLE {$db_prefix}attachments
+		CHANGE COLUMN customAvatarDir attachmentType tinyint(3) unsigned NOT NULL default '0'");
+// Pre SMF 1.1.
+elseif (!$has_attachmentType_column)
+	$request = upgrade_query("
+		ALTER TABLE {$db_prefix}attachments
+		ADD COLUMN attachmentType tinyint(3) unsigned NOT NULL default '0'");
+
+if (!$has_attachmentType_column)
+{
+	$request = upgrade_query("
+		ALTER TABLE {$db_prefix}attachments
+		ADD COLUMN id_thumb int(10) unsigned NOT NULL default '0' AFTER ID_ATTACH,
+		ADD COLUMN width mediumint(8) unsigned NOT NULL default '0',
+		ADD COLUMN height mediumint(8) unsigned NOT NULL default '0'");
+
+	// Get a list of attachments currently stored in the database.
+	$request = upgrade_query("
+		SELECT ID_ATTACH, ID_MSG, filename
+		FROM {$db_prefix}attachments");
+	$filenames = array();
+	$encrypted_filenames = array();
+	$ID_MSG = array();
+	while ($row = mysqli_fetch_assoc($request))
+	{
+		$clean_name = strtr($row['filename'], '', 'SZszYAAAAAACEEEEIIIINOOOOOOUUUUYaaaaaaceeeeiiiinoooooouuuuyy');
+		$clean_name = strtr($clean_name, array('' => 'TH', '' => 'th', '' => 'DH', '' => 'dh', '' => 'ss', '' => 'OE', '' => 'oe', '' => 'AE', '' => 'ae', '' => 'u'));
+		$clean_name = preg_replace(array('/\s/', '/[^\w_\.\-]/'), array('_', ''), $clean_name);
+		$enc_name = $row['ID_ATTACH'] . '_' . strtr($clean_name, '.', '_') . md5($clean_name);
+		$clean_name = preg_replace('~\.[\.]+~', '.', $clean_name);
+
+		if (file_exists($modSettings['attachmentUploadDir'] . '/' . $enc_name))
+			$filename = $enc_name;
+		elseif (file_exists($modSettings['attachmentUploadDir'] . '/' . $clean_name))
+			$filename = $clean_name;
+		else
+			$filename = $row['filename'];
+
+		$filenames[$row['ID_ATTACH']] = $clean_name;
+		$encrypted_filenames[$row['ID_ATTACH']] = $filename;
+		$ID_MSG[$row['ID_ATTACH']] = $row['ID_MSG'];
+	}
+	mysqli_free_result($request);
+
+	// Let's loop through the attachments
+	if (is_dir($modSettings['attachmentUploadDir']) && $dir = @opendir($modSettings['attachmentUploadDir']))
+	{
+		while ($file = readdir($dir))
+		{
+			if (substr($file, -6) == '_thumb')
+			{
+				// We found a thumbnail, now find the attachment it represents.
+				$attach_realFilename = substr($file, 0, -6);
+				if (in_array($attach_realFilename, $filenames))
+				{
+					$attach_id = array_search($attach_realFilename, $filenames);
+					$attach_filename = $attach_realFilename;
+				}
+				elseif (in_array($attach_realFilename, $encrypted_filenames))
+				{
+					$attach_id = array_search($attach_realFilename, $encrypted_filenames);
+					$attach_filename = $filenames[$attach_id];
+				}
+				else
+					continue;
+
+				// No need to register thumbs of non-existent attachments.
+				if (!file_exists($modSettings['attachmentUploadDir'] . '/' . $attach_realFilename) || strlen($attach_filename) > 249)
+					continue;
+
+				// Determine the dimensions of the thumb.
+				list ($thumb_width, $thumb_height) = @getimagesize($modSettings['attachmentUploadDir'] . '/' . $file);
+				$thumb_size = filesize($modSettings['attachmentUploadDir'] . '/' . $file);
+				$thumb_filename = $attach_filename . '_thumb';
+
+				// Insert the thumbnail in the attachment database.
+				upgrade_query("
+					INSERT INTO {$db_prefix}attachments
+						(ID_MSG, attachmentType, filename, size, width, height)
+					VALUES (" . $ID_MSG[$attach_id] . ", 3, '$thumb_filename', " . (int) $thumb_size . ', ' . (int) $thumb_width . ', ' . (int) $thumb_height . ')');
+				$thumb_attach_id = mysqli_insert_id();
+
+				// Determine the dimensions of the original attachment.
+				$attach_width = $attach_height = 0;
+				list ($attach_width, $attach_height) = @getimagesize($modSettings['attachmentUploadDir'] . '/' . $attach_realFilename);
+
+				// Link the original attachment to its thumb.
+				upgrade_query("
+					UPDATE {$db_prefix}attachments
+					SET
+						id_thumb = $thumb_attach_id,
+						width = " . (int) $attach_width . ",
+						height = " . (int) $attach_height . "
+					WHERE ID_ATTACH = $attach_id
+					LIMIT 1");
+
+				// Since it's an attachment now, we might as well encrypt it.
+				if (!empty($modSettings['attachmentEncryptFilenames']))
+					@rename($modSettings['attachmentUploadDir'] . '/' . $file, $modSettings['attachmentUploadDir'] . '/' . $thumb_attach_id . '_' . strtr($thumb_filename, '.', '_') . md5($thumb_filename));
+			}
+		}
+		closedir($dir);
+	}
+}
+---}
+---#
+
+---# Adding image dimensions...
+---{
+// Now add dimension to the images that have no thumb (yet).
+$request = upgrade_query("
+	SELECT ID_ATTACH, filename, attachmentType
+	FROM {$db_prefix}attachments
+	WHERE id_thumb = 0
+		AND (RIGHT(filename, 4) IN ('.gif', '.jpg', '.png', '.bmp') OR RIGHT(filename, 5) = '.jpeg')
+		AND width = 0
+		AND height = 0");
+while ($row = mysqli_fetch_assoc($request))
+{
+	if ($row['attachmentType'] == 1)
+		$filename = $modSettings['custom_avatar_dir'] . '/' . $row['filename'];
+	else
+	{
+		$clean_name = strtr($row['filename'], '', 'SZszYAAAAAACEEEEIIIINOOOOOOUUUUYaaaaaaceeeeiiiinoooooouuuuyy');
+		$clean_name = strtr($clean_name, array('' => 'TH', '' => 'th', '' => 'DH', '' => 'dh', '' => 'ss', '' => 'OE', '' => 'oe', '' => 'AE', '' => 'ae', '' => 'u'));
+		$clean_name = preg_replace(array('/\s/', '/[^\w_\.\-]/'), array('_', ''), $clean_name);
+		$enc_name = $row['ID_ATTACH'] . '_' . strtr($clean_name, '.', '_') . md5($clean_name);
+		$clean_name = preg_replace('~\.[\.]+~', '.', $clean_name);
+
+		if (file_exists($modSettings['attachmentUploadDir'] . '/' . $enc_name))
+			$filename = $modSettings['attachmentUploadDir'] . '/' . $enc_name;
+		elseif (file_exists($modSettings['attachmentUploadDir'] . '/' . $clean_name))
+			$filename = $modSettings['attachmentUploadDir'] . '/' . $clean_name;
+		else
+			$filename = $modSettings['attachmentUploadDir'] . '/' . $row['filename'];
+	}
+
+	$width = 0;
+	$height = 0;
+	list ($width, $height) = @getimagesize($filename);
+	if (!empty($width) && !empty($height))
+		upgrade_query("
+			UPDATE {$db_prefix}attachments
+			SET
+				width = $width,
+				height = $height
+			WHERE ID_ATTACH = $row[ID_ATTACH]
+			LIMIT 1");
+}
+mysqli_free_result($request);
+---}
+---#
+
+/******************************************************************************/
+--- Updating ban system...
+/******************************************************************************/
+
+---# Splitting ban table...
+---{
+// Checkout the current structure of the attachment table.
+$request = upgrade_query("
+	SHOW TABLES
+	LIKE '{$db_prefix}banned'");
+$upgradeBanTable = mysqli_num_rows($request) == 1;
+mysqli_free_result($request);
+
+if ($upgradeBanTable)
+{
+	upgrade_query("
+		RENAME TABLE {$db_prefix}banned
+		TO {$db_prefix}ban_groups");
+	upgrade_query("
+		ALTER TABLE {$db_prefix}ban_groups
+		CHANGE COLUMN id_ban id_ban_group mediumint(8) unsigned NOT NULL auto_increment");
+
+	upgrade_query("
+		CREATE TABLE IF NOT EXISTS {$db_prefix}ban_items (
+			id_ban mediumint(8) unsigned NOT NULL auto_increment,
+			id_ban_group smallint(5) unsigned NOT NULL default '0',
+			ip_low1 tinyint(3) unsigned NOT NULL default '0',
+			ip_high1 tinyint(3) unsigned NOT NULL default '0',
+			ip_low2 tinyint(3) unsigned NOT NULL default '0',
+			ip_high2 tinyint(3) unsigned NOT NULL default '0',
+			ip_low3 tinyint(3) unsigned NOT NULL default '0',
+			ip_high3 tinyint(3) unsigned NOT NULL default '0',
+			ip_low4 tinyint(3) unsigned NOT NULL default '0',
+			ip_high4 tinyint(3) unsigned NOT NULL default '0',
+			hostname tinytext NOT NULL,
+			email_address tinytext NOT NULL,
+			ID_MEMBER mediumint(8) unsigned NOT NULL default '0',
+			hits mediumint(8) unsigned NOT NULL default '0',
+			PRIMARY KEY (id_ban),
+			KEY id_ban_group (id_ban_group)
+		) ENGINE=MyISAM");
+
+	upgrade_query("
+		INSERT INTO {$db_prefix}ban_items
+			(id_ban_group, ip_low1, ip_high1, ip_low2, ip_high2, ip_low3, ip_high3, ip_low4, ip_high4, hostname, email_address, ID_MEMBER)
+		SELECT id_ban_group, ip_low1, ip_high1, ip_low2, ip_high2, ip_low3, ip_high3, ip_low4, ip_high4, hostname, email_address, ID_MEMBER
+		FROM {$db_prefix}ban_groups");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}ban_groups
+		DROP COLUMN ban_type,
+		DROP COLUMN ip_low1,
+		DROP COLUMN ip_high1,
+		DROP COLUMN ip_low2,
+		DROP COLUMN ip_high2,
+		DROP COLUMN ip_low3,
+		DROP COLUMN ip_high3,
+		DROP COLUMN ip_low4,
+		DROP COLUMN ip_high4,
+		DROP COLUMN hostname,
+		DROP COLUMN email_address,
+		DROP COLUMN ID_MEMBER,
+		ADD COLUMN cannot_access tinyint(3) unsigned NOT NULL default '0' AFTER expire_time,
+		ADD COLUMN cannot_register tinyint(3) unsigned NOT NULL default '0' AFTER cannot_access,
+		ADD COLUMN cannot_post tinyint(3) unsigned NOT NULL default '0' AFTER cannot_register,
+		ADD COLUMN cannot_login tinyint(3) unsigned NOT NULL default '0' AFTER cannot_post");
+
+	// Generate names for existing bans.
+	upgrade_query("
+		ALTER TABLE {$db_prefix}ban_groups
+		ADD COLUMN name varchar(20) NOT NULL default '' AFTER id_ban_group");
+
+	$request = upgrade_query("
+		SELECT id_ban_group, restriction_type
+		FROM {$db_prefix}ban_groups
+		ORDER BY ban_time ASC");
+	$ban_names = array(
+		'full_ban' => 1,
+		'cannot_register' => 1,
+		'cannot_post' => 1,
+	);
+	if ($request != false)
+	{
+		while ($row = mysqli_fetch_assoc($request))
+			upgrade_query("
+				UPDATE {$db_prefix}ban_groups
+				SET name = '" . $row['restriction_type'] . '_' . str_pad($ban_names[$row['restriction_type']]++, 3, '0', STR_PAD_LEFT) . "'
+				WHERE id_ban_group = $row[id_ban_group]");
+		mysqli_free_result($request);
+	}
+
+	// Move each restriction type to its own column.
+	upgrade_query("
+		UPDATE {$db_prefix}ban_groups
+		SET
+			cannot_access = IF(restriction_type = 'full_ban', 1, 0),
+			cannot_register = IF(restriction_type = 'cannot_register', 1, 0),
+			cannot_post = IF(restriction_type = 'cannot_post', 1, 0)");
+	upgrade_query("
+		ALTER TABLE {$db_prefix}ban_groups
+		DROP COLUMN restriction_type");
+
+	// Make sure everybody's ban situation is re-evaluated.
+	upgrade_query("
+		UPDATE {$db_prefix}settings
+		SET value = '" . time() . "'
+		WHERE variable = 'banLastUpdated'");
+}
+---}
+---#
+
+---# Updating ban statistics...
+---{
+	$request = upgrade_query("
+		SELECT mem.ID_MEMBER, mem.is_activated + 10 AS new_value
+		FROM ({$db_prefix}ban_groups AS bg, {$db_prefix}ban_items AS bi, {$db_prefix}members AS mem)
+		WHERE bg.id_ban_group = bi.id_ban_group
+			AND bg.cannot_access = 1
+			AND (bg.expire_time IS NULL OR bg.expire_time > " . time() . ")
+			AND (mem.ID_MEMBER = bi.ID_MEMBER OR mem.emailAddress LIKE bi.email_address)
+			AND mem.is_activated < 10");
+	$updates = array();
+	while ($row = mysqli_fetch_assoc($request))
+		$updates[$row['new_value']][] = $row['ID_MEMBER'];
+	mysqli_free_result($request);
+
+	// Find members that are wrongfully marked as banned.
+	$request = upgrade_query("
+		SELECT mem.ID_MEMBER, mem.is_activated - 10 AS new_value
+		FROM {$db_prefix}members AS mem
+			LEFT JOIN {$db_prefix}ban_items AS bi ON (bi.ID_MEMBER = mem.ID_MEMBER OR mem.emailAddress LIKE bi.email_address)
+			LEFT JOIN {$db_prefix}ban_groups AS bg ON (bg.id_ban_group = bi.id_ban_group AND bg.cannot_access = 1 AND (bg.expire_time IS NULL OR bg.expire_time > " . time() . "))
+		WHERE (bi.id_ban IS NULL OR bg.id_ban_group IS NULL)
+			AND mem.is_activated >= 10");
+	while ($row = mysqli_fetch_assoc($request))
+		$updates[$row['new_value']][] = $row['ID_MEMBER'];
+	mysqli_free_result($request);
+
+	if (!empty($updates))
+		foreach ($updates as $newStatus => $members)
+			upgrade_query("
+				UPDATE {$db_prefix}members
+				SET is_activated = $newStatus
+				WHERE ID_MEMBER IN (" . implode(', ', $members) . ")
+				LIMIT " . count($members));
+---}
+---#
+
+/******************************************************************************/
+--- Updating permissions...
+/******************************************************************************/
+
+---# Deleting some very old permissions...
+DELETE FROM {$db_prefix}board_permissions
+WHERE permission IN ('view_threads', 'poll_delete_own', 'poll_delete_any', 'profile_edit_own', 'profile_edit_any');
+---#
+
+---# Renaming permissions...
+---{
+// We *cannot* do this twice!
+if (@$modSettings['smfVersion'] < '1.1')
+{
+	upgrade_query("
+		UPDATE {$db_prefix}board_permissions
+		SET
+			permission = REPLACE(permission, 'remove_replies', 'delete_replies'),
+			permission = REPLACE(permission, 'remove_own', 'delete2_own'),
+			permission = REPLACE(permission, 'remove_any', 'delete2_any')");
+	upgrade_query("
+		UPDATE {$db_prefix}board_permissions
+		SET
+			permission = REPLACE(permission, 'delete_own', 'remove_own'),
+			permission = REPLACE(permission, 'delete_any', 'remove_any')");
+	upgrade_query("
+		UPDATE {$db_prefix}board_permissions
+		SET
+			permission = REPLACE(permission, 'delete2_own', 'delete_own'),
+			permission = REPLACE(permission, 'delete2_any', 'delete_any')");
+}
+---}
+---#
+
+---# Upgrading "deny"-permissions...
+---{
+if (!isset($modSettings['permission_enable_deny']))
+{
+	// Only disable if no deny permissions are used.
+	$request = upgrade_query("
+		SELECT permission
+		FROM {$db_prefix}permissions
+		WHERE addDeny = 0
+		LIMIT 1");
+	$disable_deny_permissions = mysqli_num_rows($request) == 0;
+	mysqli_free_result($request);
+
+	// Still wanna disable deny permissions? Check board permissions.
+	if ($disable_deny_permissions)
+	{
+		$request = upgrade_query("
+			SELECT permission
+			FROM {$db_prefix}board_permissions
+			WHERE addDeny = 0
+			LIMIT 1");
+		$disable_deny_permissions &= mysqli_num_rows($request) == 0;
+		mysqli_free_result($request);
+	}
+
+	$request = upgrade_query("
+		INSERT INTO {$db_prefix}settings
+			(variable, value)
+		VALUES ('permission_enable_deny', '" . ($disable_deny_permissions ? '0' : '1') . "')");
+}
+---}
+---#
+
+---# Upgrading post based group permissions...
+---{
+if (!isset($modSettings['permission_enable_postgroups']))
+{
+	// Only disable if no post group permissions are used.
+	$disable_postgroup_permissions = true;
+	$request = upgrade_query("
+		SELECT p.permission
+		FROM ({$db_prefix}permissions AS p, {$db_prefix}membergroups AS mg)
+		WHERE mg.ID_GROUP = p.ID_GROUP
+			AND mg.minPosts != -1
+		LIMIT 1");
+	$disable_postgroup_permissions &= mysqli_num_rows($request) == 0;
+	mysqli_free_result($request);
+
+	// Still wanna disable postgroup permissions? Check board permissions.
+	if ($disable_postgroup_permissions)
+	{
+		$request = upgrade_query("
+			SELECT bp.permission
+			FROM ({$db_prefix}board_permissions AS bp, {$db_prefix}membergroups AS mg)
+			WHERE mg.ID_GROUP = bp.ID_GROUP
+				AND mg.minPosts != -1
+			LIMIT 1");
+		$disable_postgroup_permissions &= mysqli_num_rows($request) == 0;
+		mysqli_free_result($request);
+	}
+
+	$request = upgrade_query("
+		INSERT INTO {$db_prefix}settings
+			(variable, value)
+		VALUES ('permission_enable_postgroups', '" . ($disable_postgroup_permissions ? '0' : '1') . "')");
+}
+---}
+---#
+
+---# Upgrading by-board permissions...
+ALTER TABLE {$db_prefix}boards
+CHANGE COLUMN use_local_permissions permission_mode tinyint(4) unsigned NOT NULL default '0';
+
+---{
+if (!isset($modSettings['permission_enable_by_board']))
+{
+	// Enable by-board permissions if there's >= 1 local permission board.
+	$request = upgrade_query("
+		SELECT ID_BOARD
+		FROM {$db_prefix}boards
+		WHERE permission_mode = 1
+		LIMIT 1");
+	$enable_by_board = mysqli_num_rows($request) == 1 ? '1' : '0';
+	mysqli_free_result($request);
+
+	$request = upgrade_query("
+		INSERT INTO {$db_prefix}settings
+			(variable, value)
+		VALUES ('permission_enable_by_board', '$enable_by_board')");
+}
+---}
+---#
+
+---# Removing all guest deny permissions...
+DELETE FROM {$db_prefix}permissions
+WHERE ID_GROUP = -1
+	AND addDeny = 0;
+
+DELETE FROM {$db_prefix}board_permissions
+WHERE ID_GROUP = -1
+	AND addDeny = 0;
+---#
+
+---# Removing guest admin permissions (if any)...
+DELETE FROM {$db_prefix}permissions
+WHERE ID_GROUP = -1
+	AND permission IN ('admin_forum', 'manage_boards', 'manage_attachments', 'manage_smileys', 'edit_news', 'moderate_forum', 'manage_membergroups', 'manage_permissions', 'manage_bans', 'send_mail');
+
+DELETE FROM {$db_prefix}board_permissions
+WHERE ID_GROUP = -1
+	AND permission IN ('admin_forum', 'manage_boards', 'manage_attachments', 'manage_smileys', 'edit_news', 'moderate_forum', 'manage_membergroups', 'manage_permissions', 'manage_bans', 'send_mail');
+---#
+
+/******************************************************************************/
+--- Updating search cache...
+/******************************************************************************/
+
+---# Creating search cache tables...
+DROP TABLE IF EXISTS {$db_prefix}log_search_fulltext;
+DROP TABLE IF EXISTS {$db_prefix}log_search_messages;
+DROP TABLE IF EXISTS {$db_prefix}log_search_topics;
+DROP TABLE IF EXISTS {$db_prefix}log_search;
+
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_search_messages (
+  id_search tinyint(3) unsigned NOT NULL default '0',
+  ID_MSG int(10) NOT NULL default '0',
+  PRIMARY KEY (id_search, ID_MSG)
+) ENGINE=MyISAM;
+
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_search_topics (
+  id_search tinyint(3) unsigned NOT NULL default '0',
+  ID_TOPIC mediumint(9) NOT NULL default '0',
+  PRIMARY KEY (id_search, ID_TOPIC)
+) ENGINE=MyISAM;
+
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_search_results (
+  id_search tinyint(3) unsigned NOT NULL default '0',
+  ID_TOPIC mediumint(8) unsigned NOT NULL default '0',
+  ID_MSG int(10) unsigned NOT NULL default '0',
+  relevance smallint(5) unsigned NOT NULL default '0',
+  num_matches smallint(5) unsigned NOT NULL default '0',
+  PRIMARY KEY (id_search, ID_TOPIC),
+  KEY relevance (relevance)
+) ENGINE=MyISAM;
+
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_search_subjects (
+  word varchar(20) NOT NULL default '',
+  ID_TOPIC mediumint(8) unsigned NOT NULL default '0',
+  PRIMARY KEY (word, ID_TOPIC),
+  KEY ID_TOPIC (ID_TOPIC)
+) ENGINE=MyISAM;
+---#
+
+---# Rebuilding fulltext index...
+---{
+$request = upgrade_query("
+	SHOW KEYS
+	FROM {$db_prefix}messages");
+$found = false;
+while ($row = mysqli_fetch_assoc($request))
+	$found |= $row['Key_name'] == 'subject' && $row['Column_name'] == 'subject';
+mysqli_free_result($request);
+if ($found)
+{
+	$request = upgrade_query("
+		ALTER TABLE {$db_prefix}messages
+		DROP INDEX subject,
+		DROP INDEX body,
+		ADD FULLTEXT body (body)");
+}
+---}
+---#
+
+---# Indexing topic subjects...
+---{
+$request = upgrade_query("
+	SELECT COUNT(*)
+	FROM {$db_prefix}log_search_subjects");
+list ($numIndexedWords) = mysqli_fetch_row($request);
+mysqli_free_result($request);
+if ($numIndexedWords == 0 || isset($_GET['lt']))
+{
+	$request = upgrade_query("
+		SELECT COUNT(*)
+		FROM {$db_prefix}topics");
+	list ($maxTopics) = mysqli_fetch_row($request);
+	mysqli_free_result($request);
+
+	$_GET['lt'] = isset($_GET['lt']) ? (int) $_GET['lt'] : 0;
+	$step_progress['name'] = 'Indexing Topic Subjects';
+	$step_progress['current'] = $_GET['lt'];
+	$step_progress['total'] = $maxTopics;
+
+	while ($_GET['lt'] <= $maxTopics)
+	{
+		$request = upgrade_query("
+			SELECT t.ID_TOPIC, m.subject
+			FROM ({$db_prefix}topics AS t, {$db_prefix}messages AS m)
+			WHERE m.ID_MSG = t.ID_FIRST_MSG
+			LIMIT $_GET[lt], 250");
+		$inserts = array();
+		while ($row = mysqli_fetch_assoc($request))
+		{
+			foreach (text2words($row['subject']) as $word)
+				$inserts[] = "'" . mysqli_real_escape_string($db_connection, $word) . "', $row[ID_TOPIC]";
+		}
+		mysqli_free_result($request);
+
+		if (!empty($inserts))
+			upgrade_query("
+				INSERT INTO {$db_prefix}log_search_subjects
+					(word, ID_TOPIC)
+				VALUES (" . implode('),
+					(', array_unique($inserts)) . ")");
+
+		$_GET['lt'] += 250;
+		$step_progress['current'] = $_GET['lt'];
+		nextSubstep($substep);
+	}
+	unset($_GET['lt']);
+}
+---}
+---#
+
+---# Converting settings...
+---{
+if (isset($modSettings['search_method']))
+{
+	if (!empty($modSettings['search_method']))
+		$request = upgrade_query("
+			INSERT INTO {$db_prefix}settings
+				(variable, value)
+			VALUES
+				('search_match_words', '1')");
+
+	if ($modSettings['search_method'] > 1)
+		$request = upgrade_query("
+			INSERT INTO {$db_prefix}settings
+				(variable, value)
+			VALUES
+				('search_index', 'fulltext')");
+
+	if ($modSettings['search_method'] == 3)
+		$request = upgrade_query("
+			INSERT INTO {$db_prefix}settings
+				(variable, value)
+			VALUES
+				('search_force_index', '1')");
+
+	$request = upgrade_query("
+		DELETE FROM {$db_prefix}settings
+		WHERE variable = 'search_method'");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Upgrading log system...
+/******************************************************************************/
+
+---# Creating log table indexes (this might take some time!)...
+---{
+$request = upgrade_query("
+	SHOW COLUMNS
+	FROM {$db_prefix}log_topics");
+$upgradeLogTable = false;
+while ($request && $row = mysqli_fetch_row($request))
+	$upgradeLogTable |= $row[0] == 'logTime';
+if ($request !== false)
+	mysqli_free_result($request);
+
+if ($upgradeLogTable)
+{
+	$_GET['preprep_lt'] = isset($_GET['preprep_lt']) ? (int) $_GET['preprep_lt'] : 0;
+	$step_progress['name'] = 'Creating index\'s for log table';
+	$step_progress['current'] = $_GET['preprep_lt'];
+	$custom_warning = 'On a very large board these index\'s may take a few minutes to create.';
+
+	$log_additions = array(
+		array(
+			'table' => 'log_boards',
+			'type' => 'index',
+			'method' => 'add',
+			'name' => 'logTime',
+			'target_columns' => array('logTime'),
+			'text' => 'ADD INDEX logTime (logTime)',
+		),
+		array(
+			'table' => 'log_mark_read',
+			'type' => 'index',
+			'method' => 'add',
+			'name' => 'logTime',
+			'target_columns' => array('logTime'),
+			'text' => 'ADD INDEX logTime (logTime)',
+		),
+		array(
+			'table' => 'messages',
+			'type' => 'index',
+			'method' => 'add',
+			'name' => 'modifiedTime',
+			'target_columns' => array('modifiedTime'),
+			'text' => 'ADD INDEX modifiedTime (modifiedTime)',
+		),
+	);
+
+	$step_progress['total'] = count($log_additions);
+
+	// Now we loop through the changes and work out where the hell we are.
+	foreach ($log_additions as $ind => $change)
+	{
+		// Already done it?
+		if ($_GET['preprep_lt'] > $ind)
+			continue;
+
+		// Make the index, with all the protection and all.
+		protected_alter($change, $substep);
+
+		// Store this for the next table.
+		$_GET['preprep_lt']++;
+		$step_progress['current'] = $_GET['preprep_lt'];
+	}
+
+	// Clean up.
+	unset($_GET['preprep_lt']);
+}
+---}
+---#
+
+---# Preparing log table upgrade...
+---{
+$request = upgrade_query("
+	SHOW COLUMNS
+	FROM {$db_prefix}log_topics");
+$upgradeLogTable = false;
+while ($request && $row = mysqli_fetch_row($request))
+	$upgradeLogTable |= $row[0] == 'logTime';
+if ($request !== false)
+	mysqli_free_result($request);
+
+if ($upgradeLogTable)
+{
+	$_GET['prep_lt'] = isset($_GET['prep_lt']) ? (int) $_GET['prep_lt'] : 0;
+	$step_progress['name'] = 'Preparing log table update';
+	$step_progress['current'] = $_GET['prep_lt'];
+	$custom_warning = 'This step may take quite some time. During this time it may appear that nothing is happening while
+		the databases MySQL tables are expanded. Please be patient.';
+
+	// All these changes need to be made, they may take a while, so let's timeout neatly.
+	$log_additions = array(
+		array(
+			'table' => 'log_topics',
+			'type' => 'index',
+			'method' => 'remove',
+			'name' => 'ID_MEMBER',
+			'target_columns' => array('ID_MEMBER'),
+			'text' => 'DROP INDEX ID_MEMBER',
+		),
+		array(
+			'table' => 'log_topics',
+			'type' => 'index',
+			'method' => 'change',
+			'name' => 'PRIMARY',
+			'target_columns' => array('ID_MEMBER', 'ID_TOPIC'),
+			'text' => '
+				DROP PRIMARY KEY,
+				ADD PRIMARY KEY (ID_MEMBER, ID_TOPIC)',
+		),
+		array(
+			'table' => 'log_topics',
+			'type' => 'index',
+			'method' => 'add',
+			'name' => 'logTime',
+			'target_columns' => array('logTime'),
+			'text' => 'ADD INDEX logTime (logTime)',
+		),
+		array(
+			'table' => 'log_boards',
+			'type' => 'column',
+			'method' => 'add',
+			'name' => 'ID_MSG',
+			'text' => 'ADD COLUMN ID_MSG mediumint(8) unsigned NOT NULL default \'0\'',
+		),
+		array(
+			'table' => 'log_mark_read',
+			'type' => 'column',
+			'method' => 'add',
+			'name' => 'ID_MSG',
+			'text' => 'ADD COLUMN ID_MSG mediumint(8) unsigned NOT NULL default \'0\'',
+		),
+		array(
+			'table' => 'log_topics',
+			'type' => 'column',
+			'method' => 'add',
+			'name' => 'ID_MSG',
+			'text' => 'ADD COLUMN ID_MSG mediumint(8) unsigned NOT NULL default \'0\'',
+		),
+		array(
+			'table' => 'messages',
+			'type' => 'column',
+			'method' => 'add',
+			'name' => 'ID_MSG_MODIFIED',
+			'text' => 'ADD COLUMN ID_MSG_MODIFIED mediumint(8) unsigned NOT NULL default \'0\' AFTER ID_MEMBER',
+		),
+		array(
+			'table' => 'boards',
+			'type' => 'column',
+			'method' => 'add',
+			'name' => 'ID_MSG_UPDATED',
+			'text' => 'ADD COLUMN ID_MSG_UPDATED mediumint(8) unsigned NOT NULL default \'0\' AFTER ID_LAST_MSG',
+		),
+		array(
+			'table' => 'boards',
+			'type' => 'index',
+			'method' => 'add',
+			'name' => 'ID_MSG_UPDATED',
+			'target_columns' => array('ID_MSG_UPDATED'),
+			'text' => 'ADD INDEX ID_MSG_UPDATED (ID_MSG_UPDATED)',
+		),
+	);
+	$step_progress['total'] = count($log_additions);
+
+	// Now we loop through the changes and work out where the hell we are.
+	foreach ($log_additions as $ind => $change)
+	{
+		// Already done it?
+		if ($_GET['prep_lt'] > $ind)
+			continue;
+
+		// Make the index, with all the protection and all.
+		protected_alter($change, $substep);
+
+		// Store this for the next table.
+		$_GET['prep_lt']++;
+		$step_progress['current'] = $_GET['prep_lt'];
+	}
+
+	// Clean up.
+	unset($_GET['prep_lt']);
+}
+---}
+---#
+
+---# Converting log tables (this might take some time!)...
+---{
+$request = upgrade_query("
+	SHOW COLUMNS
+	FROM {$db_prefix}log_topics");
+$upgradeLogTable = false;
+while ($request && $row = mysqli_fetch_row($request))
+	$upgradeLogTable |= $row[0] == 'logTime';
+if ($request !== false)
+	mysqli_free_result($request);
+
+if ($upgradeLogTable)
+{
+	$request = upgrade_query("
+		SELECT MAX(ID_MSG)
+		FROM {$db_prefix}messages");
+	list($maxMsg) = mysqli_fetch_row($request);
+	mysqli_free_result($request);
+
+	if (empty($maxMsg))
+		$maxMsg = 0;
+
+	$_GET['m'] = isset($_GET['m']) ? (int) $_GET['m'] : 0;
+	$step_progress['name'] = 'Converting Log Tables';
+	$step_progress['current'] = $_GET['m'];
+	$step_progress['total'] = $maxMsg;
+	$custom_warning = 'This step is converting all your log tables and may take quite some time on a large forum (Several hours for a forum with ~500,000 messages).';
+
+	// Only adjust the structure if this is the first message.
+	if ($_GET['m'] === 0)
+	{
+		// By default a message is modified when it was written.
+		upgrade_query("
+			UPDATE {$db_prefix}messages
+			SET ID_MSG_MODIFIED = ID_MSG");
+
+		$request = upgrade_query("
+			SELECT posterTime
+			FROM {$db_prefix}messages
+			WHERE ID_MSG = $maxMsg");
+		list($maxPosterTime) = mysqli_fetch_row($request);
+		mysqli_free_result($request);
+
+		if (empty($maxPosterTime))
+			$maxPosterTime = 0;
+
+		upgrade_query("
+			UPDATE {$db_prefix}log_boards
+			SET ID_MSG = $maxMsg
+			WHERE logTime >= $maxPosterTime");
+		upgrade_query("
+			UPDATE {$db_prefix}log_mark_read
+			SET ID_MSG = $maxMsg
+			WHERE logTime >= $maxPosterTime");
+		upgrade_query("
+			UPDATE {$db_prefix}log_topics
+			SET ID_MSG = $maxMsg
+			WHERE logTime >= $maxPosterTime");
+		upgrade_query("
+			UPDATE {$db_prefix}messages
+			SET ID_MSG_MODIFIED = $maxMsg
+			WHERE modifiedTime >= $maxPosterTime");
+
+		// Timestamp 1 is where it all starts.
+		$lower_limit = 1;
+	}
+	else
+	{
+		// Determine the lower limit.
+		$request = upgrade_query("
+			SELECT MAX(posterTime) + 1
+			FROM {$db_prefix}messages
+			WHERE ID_MSG < $_GET[m]");
+		list($lower_limit) = mysqli_fetch_row($request);
+		mysqli_free_result($request);
+
+		if (empty($lower_limit))
+			$lower_limit = 1;
+
+		if (empty($maxPosterTime))
+			$maxPosterTime = 1;
+	}
+
+	while ($_GET['m'] <= $maxMsg)
+	{
+		$condition = '';
+		$lowest_limit = $lower_limit;
+		$request = upgrade_query("
+			SELECT MAX(ID_MSG) AS ID_MSG, posterTime
+			FROM {$db_prefix}messages
+			WHERE ID_MSG BETWEEN $_GET[m] AND " . ($_GET['m'] + 300) . "
+			GROUP BY posterTime
+			ORDER BY posterTime
+			LIMIT 300");
+		while ($row = mysqli_fetch_assoc($request))
+		{
+			if ($condition === '')
+				$condition = "IF(logTime BETWEEN $lower_limit AND $row[posterTime], $row[ID_MSG], %else%)";
+			else
+				$condition = strtr($condition, array('%else%' => "IF(logTime <= $row[posterTime], $row[ID_MSG], %else%)"));
+
+			$lower_limit = $row['posterTime'] + 1;
+		}
+		mysqli_free_result($request);
+
+		if ($condition !== '')
+		{
+			$condition = strtr($condition, array('%else%' => '0'));
+			$highest_limit = $lower_limit;
+
+			upgrade_query("
+				UPDATE {$db_prefix}log_boards
+				SET ID_MSG = $condition
+				WHERE logTime BETWEEN $lowest_limit AND $highest_limit
+					AND ID_MSG = 0");
+			upgrade_query("
+				UPDATE {$db_prefix}log_mark_read
+				SET ID_MSG = $condition
+				WHERE logTime BETWEEN $lowest_limit AND $highest_limit
+					AND ID_MSG = 0");
+			upgrade_query("
+				UPDATE {$db_prefix}log_topics
+				SET ID_MSG = $condition
+				WHERE logTime BETWEEN $lowest_limit AND $highest_limit
+					AND ID_MSG = 0");
+			upgrade_query("
+				UPDATE {$db_prefix}messages
+				SET ID_MSG_MODIFIED = " . strtr($condition, array('logTime' => 'modifiedTime')) . "
+				WHERE modifiedTime BETWEEN $lowest_limit AND $highest_limit
+					AND modifiedTime > 0");
+		}
+
+		$_GET['m'] += 300;
+		nextSubstep($substep);
+	}
+	unset($_GET['m']);
+}
+---}
+---#
+
+---# Updating last message IDs for boards.
+---{
+
+$request = upgrade_query("
+	SHOW COLUMNS
+	FROM {$db_prefix}boards");
+$upgradeBoardsTable = false;
+while ($request && $row = mysqli_fetch_row($request))
+	$upgradeBoardsTable |= $row[0] == 'lastUpdated';
+if ($request !== false)
+	mysqli_free_result($request);
+
+if ($upgradeBoardsTable)
+{
+	$request = upgrade_query("
+		SELECT MAX(ID_BOARD)
+		FROM {$db_prefix}boards");
+	list ($maxBoard) = mysqli_fetch_row($request);
+	mysqli_free_result($request);
+
+	$_GET['bdi'] = isset($_GET['bdi']) ? (int) $_GET['bdi'] : 0;
+	$step_progress['name'] = 'Updating Last Board ID';
+	$step_progress['current'] = $_GET['bdi'];
+	$step_progress['total'] = $maxBoard;
+
+	// OK, we need to get the last updated message.
+	$request = upgrade_query("
+		SELECT ID_BOARD, lastUpdated
+		FROM {$db_prefix}boards");
+	while ($row = mysqli_fetch_assoc($request))
+	{
+		// Done this?
+		if ($row['ID_BOARD'] < $_GET['bdi'])
+			continue;
+
+		// Maybe we don't have any?
+		if ($row['lastUpdated'] == 0)
+			$ID_MSG = 0;
+		// Otherwise need to query it?
+		else
+		{
+			$request2 = upgrade_query("
+				SELECT MIN(ID_MSG)
+				FROM {$db_prefix}messages
+				WHERE posterTime >= $row[lastUpdated]");
+			list ($ID_MSG) = mysqli_fetch_row($request2);
+
+			if (empty($ID_MSG))
+				$ID_MSG = 0;
+		}
+
+		upgrade_query("
+			UPDATE {$db_prefix}boards
+			SET ID_MSG_UPDATED = $ID_MSG
+			WHERE ID_BOARD = $row[ID_BOARD]");
+
+		$_GET['bdi']++;
+		$step_progress['current'] = $_GET['bdi'];
+		nextSubstep($substep);
+	}
+	unset($_GET['bdi']);
+}
+---}
+---#
+
+---# Cleaning up old log indexes...
+---{
+$request = upgrade_query("
+	SHOW COLUMNS
+	FROM {$db_prefix}log_topics");
+$upgradeLogTable = false;
+while ($request && $row = mysqli_fetch_row($request))
+	$upgradeLogTable |= $row[0] == 'logTime';
+if ($request !== false)
+	mysqli_free_result($request);
+
+if ($upgradeLogTable)
+{
+	$_GET['prep_lt'] = isset($_GET['prep_lt']) ? (int) $_GET['prep_lt'] : 0;
+	$step_progress['name'] = 'Cleaning up old log table index\'s';
+	$step_progress['current'] = $_GET['prep_lt'];
+	$custom_warning = 'This step may take quite some time. During this time it may appear that nothing is happening while
+		the databases MySQL tables are cleaned. Please be patient.';
+
+	// Here we remove all the unused indexes
+	$log_deletions = array(
+		array(
+			'table' => 'boards',
+			'type' => 'index',
+			'method' => 'remove',
+			'name' => 'lastUpdated',
+			'target_columns' => array('lastUpdated'),
+			'text' => 'DROP INDEX lastUpdated',
+		),
+		array(
+			'table' => 'messages',
+			'type' => 'index',
+			'method' => 'remove',
+			'name' => 'posterTime',
+			'target_columns' => array('posterTime'),
+			'text' => 'DROP INDEX posterTime',
+		),
+		array(
+			'table' => 'messages',
+			'type' => 'index',
+			'method' => 'remove',
+			'name' => 'modifiedTime',
+			'target_columns' => array('modifiedTime'),
+			'text' => 'DROP INDEX modifiedTime',
+		),
+		array(
+			'table' => 'log_topics',
+			'type' => 'column',
+			'method' => 'remove',
+			'name' => 'logTime',
+			'text' => 'DROP COLUMN logTime',
+		),
+		array(
+			'table' => 'log_boards',
+			'type' => 'column',
+			'method' => 'remove',
+			'name' => 'logTime',
+			'text' => 'DROP COLUMN logTime',
+		),
+		array(
+			'table' => 'log_mark_read',
+			'type' => 'column',
+			'method' => 'remove',
+			'name' => 'logTime',
+			'text' => 'DROP COLUMN logTime',
+		),
+		array(
+			'table' => 'boards',
+			'type' => 'column',
+			'method' => 'remove',
+			'name' => 'lastUpdated',
+			'text' => 'DROP COLUMN lastUpdated',
+		),
+	);
+	$step_progress['total'] = count($log_deletions);
+
+	// Now we loop through the changes and work out where the hell we are.
+	foreach ($log_deletions as $ind => $change)
+	{
+		// Already done it?
+		if ($_GET['prep_lt'] > $ind)
+			continue;
+
+		// Make the index, with all the protection and all.
+		protected_alter($change, $substep);
+
+		// Store this for the next table.
+		$_GET['prep_lt']++;
+		$step_progress['current'] = $_GET['prep_lt'];
+	}
+
+	// Clean up.
+	unset($_GET['prep_lt']);
+	$step_progress = array();
+}
+---}
+---#
+
+/******************************************************************************/
+--- Making SMF MySQL strict compatible...
+/******************************************************************************/
+
+---# Preparing messages table for strict upgrade
+ALTER TABLE {$db_prefix}messages
+DROP INDEX ipIndex;
+---#
+
+---# Adjusting text fields
+---#
+---{
+// Note we move on by one as there is no point ALTER'ing the same thing twice.
+$_GET['strict_step'] = isset($_GET['strict_step']) ? (int) $_GET['strict_step'] + 1 : 0;
+$step_progress['name'] = 'Adding MySQL strict compatibility';
+$step_progress['current'] = $_GET['strict_step'];
+
+// Take care with the body column from messages, just in case it's been enlarged by others.
+$request = upgrade_query("
+	SHOW COLUMNS
+	FROM {$db_prefix}messages
+	LIKE 'body'");
+$body_row = mysqli_fetch_assoc($request);
+mysqli_free_result($request);
+
+$body_type = $body_row['Type'];
+
+$textfield_updates = array(
+	array(
+		'table' => 'attachments',
+		'column' => 'filename',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'ban_groups',
+		'column' => 'reason',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'ban_items',
+		'column' => 'hostname',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'ban_items',
+		'column' => 'email_address',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'boards',
+		'column' => 'name',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'boards',
+		'column' => 'description',
+		'type' => 'text',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'categories',
+		'column' => 'name',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'log_actions',
+		'column' => 'extra',
+		'type' => 'text',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'log_banned',
+		'column' => 'email',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'log_banned',
+		'column' => 'email',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'log_errors',
+		'column' => 'url',
+		'type' => 'text',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'log_errors',
+		'column' => 'message',
+		'type' => 'text',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'log_online',
+		'column' => 'url',
+		'type' => 'text',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'membergroups',
+		'column' => 'stars',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'lngfile',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'realName',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'buddy_list',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'pm_ignore_list',
+		'type' => 'text',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'messageLabels',
+		'type' => 'text',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'emailAddress',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'personalText',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'websiteTitle',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'websiteUrl',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'location',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'ICQ',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'MSN',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'signature',
+		'type' => 'text',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'avatar',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'usertitle',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'memberIP',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'secretQuestion',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'members',
+		'column' => 'additionalGroups',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'messages',
+		'column' => 'subject',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'messages',
+		'column' => 'posterName',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'messages',
+		'column' => 'posterEmail',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'messages',
+		'column' => 'posterIP',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'messages',
+		'column' => 'modifiedName',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'messages',
+		'column' => 'body',
+		'type' => $body_type,
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'personal_messages',
+		'column' => 'body',
+		'type' => 'text',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'package_servers',
+		'column' => 'name',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'personal_messages',
+		'column' => 'fromName',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'personal_messages',
+		'column' => 'subject',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'personal_messages',
+		'column' => 'body',
+		'type' => 'text',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'polls',
+		'column' => 'question',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'polls',
+		'column' => 'posterName',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'poll_choices',
+		'column' => 'label',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'settings',
+		'column' => 'variable',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'settings',
+		'column' => 'value',
+		'type' => 'text',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'sessions',
+		'column' => 'data',
+		'type' => 'text',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'themes',
+		'column' => 'variable',
+		'type' => 'tinytext',
+		'null_allowed' => false,
+	),
+	array(
+		'table' => 'themes',
+		'column' => 'value',
+		'type' => 'text',
+		'null_allowed' => false,
+	),
+);
+$step_progress['total'] = count($textfield_updates);
+
+foreach ($textfield_updates as $ind => $change)
+{
+	// Already done it?
+	if ($_GET['strict_step'] > $ind)
+		continue;
+
+	// Make the index, with all the protection and all.
+	textfield_alter($change, $substep);
+
+	// Store this for the next table.
+	$_GET['strict_step']++;
+	$step_progress['current'] = $_GET['strict_step'];
+}
+
+$step_progress = array();
+---}
+---#
+
+---# Replacing messages index.
+ALTER TABLE {$db_prefix}messages
+ADD INDEX ipIndex (posterIP(15), ID_TOPIC);
+---#
+
+---# Adding log_topics index.
+---{
+upgrade_query("
+	ALTER TABLE {$db_prefix}log_topics
+	ADD INDEX ID_TOPIC (ID_TOPIC)", true);
+---}
+---#
+
+/******************************************************************************/
+--- Adding more room for the buddy list
+/******************************************************************************/
+
+---# Updating the members table ...
+ALTER TABLE {$db_prefix}members
+CHANGE COLUMN buddy_list buddy_list text NOT NULL;
+---#
+
+/******************************************************************************/
+--- Change some column types to accommodate more messages.
+/******************************************************************************/
+
+---# Expanding message column size.
+---{
+$_GET['msg_change'] = isset($_GET['msg_change']) ? (int) $_GET['msg_change'] : 0;
+$step_progress['name'] = 'Expanding Message Capacity';
+$step_progress['current'] = $_GET['msg_change'];
+
+// The array holding all the changes.
+$columnChanges = array(
+	array(
+		'table' => 'boards',
+		'type' => 'column',
+		'method' => 'change',
+		'name' => 'ID_LAST_MSG',
+		'text' => 'CHANGE ID_LAST_MSG ID_LAST_MSG int(10) unsigned NOT NULL default \'0\'',
+	),
+	array(
+		'table' => 'boards',
+		'type' => 'column',
+		'method' => 'change',
+		'name' => 'ID_MSG_UPDATED',
+		'text' => 'CHANGE ID_MSG_UPDATED ID_MSG_UPDATED int(10) unsigned NOT NULL default \'0\'',
+	),
+	array(
+		'table' => 'log_boards',
+		'type' => 'column',
+		'method' => 'change',
+		'name' => 'ID_MSG',
+		'text' => 'CHANGE ID_MSG ID_MSG int(10) unsigned NOT NULL default \'0\'',
+	),
+	array(
+		'table' => 'log_mark_read',
+		'type' => 'column',
+		'method' => 'change',
+		'name' => 'ID_MSG',
+		'text' => 'CHANGE ID_MSG ID_MSG int(10) unsigned NOT NULL default \'0\'',
+	),
+	array(
+		'table' => 'log_topics',
+		'type' => 'column',
+		'method' => 'change',
+		'name' => 'ID_MSG',
+		'text' => 'CHANGE ID_MSG ID_MSG int(10) unsigned NOT NULL default \'0\'',
+	),
+	array(
+		'table' => 'messages',
+		'type' => 'column',
+		'method' => 'change',
+		'name' => 'ID_MSG_MODIFIED',
+		'text' => 'CHANGE ID_MSG_MODIFIED ID_MSG_MODIFIED int(10) unsigned NOT NULL default \'0\'',
+	),
+);
+
+if (!empty($modSettings['search_custom_index_config']))
+	$columnChanges[] = array(
+		'table' => 'log_search_words',
+		'type' => 'column',
+		'method' => 'change',
+		'name' => 'ID_MSG',
+		'text' => 'CHANGE ID_MSG ID_MSG int(10) unsigned NOT NULL default \'0\'',
+	);
+
+$step_progress['total'] = count($columnChanges);
+
+// Now we do all the changes...
+foreach ($columnChanges as $index => $change)
+{
+	// Already done it?
+	if ($_GET['msg_change'] > $ind)
+		continue;
+
+	// Now change the column at last.
+	protected_alter($change, $substep);
+
+	// Update where we are...
+	$_GET['msg_change']++;
+	$step_progress['current'] = $_GET['msg_change'];
+}
+
+// Clean up.
+unset($_GET['msg_change']);
+---}
+---#
+
+/******************************************************************************/
+--- Final clean up...
+/******************************************************************************/
+
+---# Sorting the boards...
+ALTER TABLE {$db_prefix}categories
+ORDER BY catOrder;
+
+ALTER TABLE {$db_prefix}boards
+ORDER BY boardOrder;
+---#
+
+---# Removing upgrade loop protection...
+DELETE FROM {$db_prefix}settings
+WHERE variable IN ('dont_repeat_smtp', 'dont_repeat_theme');
+---#
\ No newline at end of file
diff --git a/upgrade_2-0_mysql.sql b/upgrade_2-0_mysql.sql
new file mode 100644
index 0000000..cc63186
--- /dev/null
+++ b/upgrade_2-0_mysql.sql
@@ -0,0 +1,3103 @@
+/* ATTENTION: You don't need to run or use this file!  The upgrade.php script does everything for you! */
+
+/******************************************************************************/
+--- Changing column names.
+/******************************************************************************/
+
+---# Renaming table columns.
+---{
+// The array holding all the changes.
+$nameChanges = array(
+	'admin_info_files' => array(
+		'ID_FILE' => 'ID_FILE id_file tinyint(4) unsigned NOT NULL auto_increment',
+	),
+	'approval_queue' => array(
+		'ID_MSG' => 'ID_MSG id_msg int(10) unsigned NOT NULL default \'0\'',
+		'ID_ATTACH' => 'ID_ATTACH id_attach int(10) unsigned NOT NULL default \'0\'',
+		'ID_EVENT' => 'ID_EVENT id_event smallint(5) unsigned NOT NULL default \'0\'',
+		'attachmentType' => 'attachmentType attachment_type tinyint(3) unsigned NOT NULL default \'0\'',
+	),
+	'attachments' => array(
+		'ID_ATTACH' => 'ID_ATTACH id_attach int(10) unsigned NOT NULL auto_increment',
+		'ID_THUMB' => 'ID_THUMB id_thumb int(10) unsigned NOT NULL default \'0\'',
+		'ID_MSG' => 'ID_MSG id_msg int(10) unsigned NOT NULL default \'0\'',
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'attachmentType' => 'attachmentType attachment_type tinyint(3) unsigned NOT NULL default \'0\'',
+	),
+	'ban_groups' => array(
+		'ID_BAN_GROUP' => 'ID_BAN_GROUP id_ban_group mediumint(8) unsigned NOT NULL auto_increment',
+	),
+	'ban_items' => array(
+		'ID_BAN' => 'ID_BAN id_ban mediumint(8) unsigned NOT NULL auto_increment',
+		'ID_BAN_GROUP' => 'ID_BAN_GROUP id_ban_group smallint(5) unsigned NOT NULL default \'0\'',
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+	),
+	'board_permissions' => array(
+		'ID_GROUP' => 'ID_GROUP id_group smallint(5) NOT NULL default \'0\'',
+		'ID_PROFILE' => 'ID_PROFILE id_profile smallint(5) NOT NULL default \'0\'',
+		'addDeny' => 'addDeny add_deny tinyint(4) NOT NULL default \'1\'',
+	),
+	'boards' => array(
+		'ID_BOARD' => 'ID_BOARD id_board smallint(5) unsigned NOT NULL auto_increment',
+		'ID_CAT' => 'ID_CAT id_cat tinyint(4) unsigned NOT NULL default \'0\'',
+		'childLevel' => 'childLevel child_level tinyint(4) unsigned NOT NULL default \'0\'',
+		'ID_PARENT' => 'ID_PARENT id_parent smallint(5) unsigned NOT NULL default \'0\'',
+		'boardOrder' => 'boardOrder board_order smallint(5) NOT NULL default \'0\'',
+		'ID_LAST_MSG' => 'ID_LAST_MSG id_last_msg int(10) unsigned NOT NULL default \'0\'',
+		'ID_MSG_UPDATED' => 'ID_MSG_UPDATED id_msg_updated int(10) unsigned NOT NULL default \'0\'',
+		'memberGroups' => 'memberGroups member_groups varchar(255) NOT NULL default \'-1,0\'',
+		'ID_PROFILE' => 'ID_PROFILE id_profile smallint(5) unsigned NOT NULL default \'1\'',
+		'numTopics' => 'numTopics num_topics mediumint(8) unsigned NOT NULL default \'0\'',
+		'numPosts' => 'numPosts num_posts mediumint(8) unsigned NOT NULL default \'0\'',
+		'countPosts' => 'countPosts count_posts tinyint(4) NOT NULL default \'0\'',
+		'ID_THEME' => 'ID_THEME id_theme tinyint(4) unsigned NOT NULL default \'0\'',
+		'unapprovedPosts' => 'unapprovedPosts unapproved_posts smallint(5) NOT NULL default \'0\'',
+		'unapprovedTopics' => 'unapprovedTopics unapproved_topics smallint(5) NOT NULL default \'0\'',
+	),
+	'calendar' => array(
+		'ID_EVENT' => 'ID_EVENT id_event smallint(5) unsigned NOT NULL auto_increment',
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_BOARD' => 'ID_BOARD id_board smallint(5) unsigned NOT NULL default \'0\'',
+		'ID_TOPIC' => 'ID_TOPIC id_topic mediumint(8) unsigned NOT NULL default \'0\'',
+		'startDate' => 'startDate start_date date NOT NULL default \'0001-01-01\'',
+		'endDate' => 'endDate end_date date NOT NULL default \'0001-01-01\'',
+	),
+	'calendar_holidays' => array(
+		'ID_HOLIDAY' => 'ID_HOLIDAY id_holiday smallint(5) unsigned NOT NULL auto_increment',
+		'eventDate' => 'eventDate event_date date NOT NULL default \'0001-01-01\'',
+	),
+	'categories' => array(
+		'ID_CAT' => 'ID_CAT id_cat tinyint(4) unsigned NOT NULL auto_increment',
+		'catOrder' => 'catOrder cat_order tinyint(4) NOT NULL default \'0\'',
+		'canCollapse' => 'canCollapse can_collapse tinyint(1) NOT NULL default \'1\'',
+	),
+	'collapsed_categories' => array(
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_CAT' => 'ID_CAT id_cat tinyint(4) unsigned NOT NULL',
+	),
+	'custom_fields' => array(
+		'ID_FIELD' => 'ID_FIELD id_field smallint(5) NOT NULL auto_increment',
+		'colName' => 'colName col_name varchar(12) NOT NULL default \'\'',
+		'fieldName' => 'fieldName field_name varchar(40) NOT NULL default \'\'',
+		'fieldDesc' => 'fieldDesc field_desc varchar(255) NOT NULL default \'\'',
+		'fieldType' => 'fieldType field_type varchar(8) NOT NULL default \'text\'',
+		'fieldLength' => 'fieldLength field_length smallint(5) NOT NULL default \'255\'',
+		'fieldOptions' => 'fieldOptions field_options text NOT NULL',
+		'showReg' => 'showReg show_reg tinyint(3) NOT NULL default \'0\'',
+		'showDisplay' => 'showDisplay show_display tinyint(3) NOT NULL default \'0\'',
+		'showProfile' => 'showProfile show_profile varchar(20) NOT NULL default \'forumprofile\'',
+		'defaultValue' => 'defaultValue default_value varchar(8) NOT NULL default \'0\'',
+	),
+	'group_moderators' => array(
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_GROUP' => 'ID_GROUP id_group smallint(5) unsigned NOT NULL default \'0\'',
+	),
+	'log_actions' => array(
+		'ID_ACTION' => 'ID_ACTION id_action int(10) unsigned NOT NULL auto_increment',
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'logTime' => 'logTime log_time int(10) unsigned NOT NULL default \'0\'',
+		'ID_MSG' => 'ID_MSG id_msg int(10) unsigned NOT NULL default \'0\'',
+		'ID_TOPIC' => 'ID_TOPIC id_topic mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_BOARD' => 'ID_BOARD id_board smallint(5) unsigned NOT NULL default \'0\'',
+	),
+	'log_activity' => array(
+		'mostOn' => 'mostOn most_on smallint(5) unsigned NOT NULL default \'0\'',
+	),
+	'log_banned' => array(
+		'ID_BAN_LOG' => 'ID_BAN_LOG id_ban_log mediumint(8) unsigned NOT NULL auto_increment',
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'logTime' => 'logTime log_time int(10) unsigned NOT NULL default \'0\'',
+	),
+	'log_boards' => array(
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_MSG' => 'ID_MSG id_msg int(10) unsigned NOT NULL default \'0\'',
+		'ID_BOARD' => 'ID_BOARD id_board smallint(5) unsigned NOT NULL default \'0\'',
+	),
+	'log_digest' => array(
+		'ID_TOPIC' => 'ID_TOPIC id_topic mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_MSG' => 'ID_MSG id_msg int(10) unsigned NOT NULL default \'0\'',
+	),
+	'log_errors' => array(
+		'ID_ERROR' => 'ID_ERROR id_error mediumint(8) unsigned NOT NULL auto_increment',
+		'logTime' => 'logTime log_time int(10) unsigned NOT NULL default \'0\'',
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'errorType' => 'errorType error_type char(15) NOT NULL default \'general\'',
+	),
+	'log_floodcontrol' => array(
+		'logTime' => 'logTime log_time int(10) unsigned NOT NULL default \'0\'',
+	),
+	'log_group_requests' => array(
+		'ID_REQUEST' => 'ID_REQUEST id_request mediumint(8) unsigned NOT NULL auto_increment',
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_GROUP' => 'ID_GROUP id_group smallint(5) unsigned NOT NULL default \'0\'',
+	),
+	'log_karma' => array(
+		'ID_TARGET' => 'ID_TARGET id_target mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_EXECUTOR' => 'ID_EXECUTOR id_executor mediumint(8) unsigned NOT NULL default \'0\'',
+		'logTime' => 'logTime log_time int(10) unsigned NOT NULL default \'0\'',
+	),
+	'log_mark_read' => array(
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_MSG' => 'ID_MSG id_msg int(10) unsigned NOT NULL default \'0\'',
+		'ID_BOARD' => 'ID_BOARD id_board smallint(5) unsigned NOT NULL default \'0\'',
+	),
+	'log_notify' => array(
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_TOPIC' => 'ID_TOPIC id_topic mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_BOARD' => 'ID_BOARD id_board smallint(5) unsigned NOT NULL default \'0\'',
+	),
+	'log_packages' => array(
+		'ID_INSTALL' => 'ID_INSTALL id_install int(10) NOT NULL auto_increment',
+		'ID_MEMBER_INSTALLED' => 'ID_MEMBER_INSTALLED id_member_installed mediumint(8) NOT NULL default \'0\'',
+		'ID_MEMBER_REMOVED' => 'ID_MEMBER_REMOVED id_member_removed mediumint(8) NOT NULL default \'0\'',
+	),
+	'log_polls' => array(
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_CHOICE' => 'ID_CHOICE id_choice tinyint(3) unsigned NOT NULL default \'0\'',
+		'ID_POLL' => 'ID_POLL id_poll mediumint(8) unsigned NOT NULL default \'0\'',
+	),
+	'log_reported' => array(
+		'ID_REPORT' => 'ID_REPORT id_report mediumint(8) unsigned NOT NULL auto_increment',
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_MSG' => 'ID_MSG id_msg int(10) unsigned NOT NULL default \'0\'',
+		'ID_TOPIC' => 'ID_TOPIC id_topic mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_BOARD' => 'ID_BOARD id_board smallint(5) unsigned NOT NULL default \'0\'',
+	),
+	'log_reported_comments' => array(
+		'ID_COMMENT' => 'ID_COMMENT id_comment mediumint(8) unsigned NOT NULL auto_increment',
+		'ID_REPORT' => 'ID_REPORT id_report mediumint(8) NOT NULL default \'0\'',
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+	),
+	'log_scheduled_tasks' => array(
+		'ID_LOG' => 'ID_LOG id_log mediumint(8) NOT NULL auto_increment',
+		'ID_TASK' => 'ID_TASK id_task smallint(5) NOT NULL default \'0\'',
+		'timeRun' => 'timeRun time_run int(10) NOT NULL default \'0\'',
+		'timeTaken' => 'timeTaken time_taken float NOT NULL default \'0\'',
+	),
+	'log_search_messages' => array(
+		'ID_SEARCH' => 'ID_SEARCH id_search tinyint(3) unsigned NOT NULL default \'0\'',
+		'ID_MSG' => 'ID_MSG id_msg int(10) unsigned NOT NULL default \'0\'',
+	),
+	'log_search_results' => array(
+		'ID_TOPIC' => 'ID_TOPIC id_topic mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_MSG' => 'ID_MSG id_msg int(10) unsigned NOT NULL default \'0\'',
+		'ID_SEARCH' => 'ID_SEARCH id_search tinyint(3) unsigned NOT NULL default \'0\'',
+	),
+	'log_search_subjects' => array(
+		'ID_TOPIC' => 'ID_TOPIC id_topic mediumint(8) unsigned NOT NULL default \'0\'',
+	),
+	'log_search_topics' => array(
+		'ID_SEARCH' => 'ID_SEARCH id_search tinyint(3) unsigned NOT NULL default \'0\'',
+		'ID_TOPIC' => 'ID_TOPIC id_topic mediumint(8) unsigned NOT NULL default \'0\'',
+	),
+	'log_subscribed' => array(
+		'ID_SUBLOG' => 'ID_SUBLOG id_sublog int(10) unsigned NOT NULL auto_increment',
+		'ID_SUBSCRIBE' => 'ID_SUBSCRIBE id_subscribe mediumint(8) unsigned NOT NULL default \'0\'',
+		'OLD_ID_GROUP' => 'OLD_ID_GROUP old_id_group smallint(5) NOT NULL default \'0\'',
+		'startTime' => 'startTime start_time int(10) NOT NULL default \'0\'',
+		'endTime' => 'endTime end_time int(10) NOT NULL default \'0\'',
+	),
+	'log_topics' => array(
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_MSG' => 'ID_MSG id_msg int(10) unsigned NOT NULL default \'0\'',
+		'ID_TOPIC' => 'ID_TOPIC id_topic mediumint(8) unsigned NOT NULL default \'0\'',
+	),
+	'mail_queue' => array(
+		'ID_MAIL' => 'ID_MAIL id_mail int(10) unsigned NOT NULL auto_increment',
+	),
+	'members' => array(
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL auto_increment',
+		'memberName' => 'memberName member_name varchar(80) NOT NULL default \'\'',
+		'dateRegistered' => 'dateRegistered date_registered int(10) unsigned NOT NULL default \'0\'',
+		'ID_GROUP' => 'ID_GROUP id_group smallint(5) unsigned NOT NULL default \'0\'',
+		'lastLogin' => 'lastLogin last_login int(10) unsigned NOT NULL default \'0\'',
+		'realName' => 'realName real_name varchar(255) NOT NULL default \'\'',
+		'instantMessages' => 'instantMessages instant_messages smallint(5) NOT NULL default \'0\'',
+		'unreadMessages' => 'unreadMessages unread_messages smallint(5) NOT NULL default \'0\'',
+		'messageLabels' => 'messageLabels message_labels text NOT NULL',
+		'emailAddress' => 'emailAddress email_address varchar(255) NOT NULL default \'\'',
+		'personalText' => 'personalText personal_text varchar(255) NOT NULL default \'\'',
+		'websiteTitle' => 'websiteTitle website_title varchar(255) NOT NULL default \'\'',
+		'websiteUrl' => 'websiteUrl website_url varchar(255) NOT NULL default \'\'',
+		'ICQ' => 'ICQ icq varchar(255) NOT NULL default \'\'',
+		'AIM' => 'AIM aim varchar(255) NOT NULL default \'\'',
+		'YIM' => 'YIM yim varchar(32) NOT NULL default \'\'',
+		'MSN' => 'MSN msn varchar(255) NOT NULL default \'\'',
+		'hideEmail' => 'hideEmail hide_email tinyint(4) NOT NULL default \'0\'',
+		'showOnline' => 'showOnline show_online tinyint(4) NOT NULL default \'1\'',
+		'timeFormat' => 'timeFormat time_format varchar(80) NOT NULL default \'\'',
+		'timeOffset' => 'timeOffset time_offset float NOT NULL default \'0\'',
+		'karmaBad' => 'karmaBad karma_bad smallint(5) unsigned NOT NULL default \'0\'',
+		'karmaGood' => 'karmaGood karma_good smallint(5) unsigned NOT NULL default \'0\'',
+		'notifyAnnouncements' => 'notifyAnnouncements notify_announcements tinyint(4) NOT NULL default \'1\'',
+		'notifyRegularity' => 'notifyRegularity notify_regularity tinyint(4) NOT NULL default \'1\'',
+		'notifySendBody' => 'notifySendBody notify_send_body tinyint(4) NOT NULL default \'0\'',
+		'notifyTypes' => 'notifyTypes notify_types tinyint(4) NOT NULL default \'2\'',
+		'memberIP' => 'memberIP member_ip varchar(255) NOT NULL default \'\'',
+		'secretQuestion' => 'secretQuestion secret_question varchar(255) NOT NULL default \'\'',
+		'secretAnswer' => 'secretAnswer secret_answer varchar(64) NOT NULL default \'\'',
+		'ID_THEME' => 'ID_THEME id_theme tinyint(4) unsigned NOT NULL default \'0\'',
+		'ID_MSG_LAST_VISIT' => 'ID_MSG_LAST_VISIT id_msg_last_visit int(10) unsigned NOT NULL default \'0\'',
+		'additionalGroups' => 'additionalGroups additional_groups varchar(255) NOT NULL default \'\'',
+		'smileySet' => 'smileySet smiley_set varchar(48) NOT NULL default \'\'',
+		'ID_POST_GROUP' => 'ID_POST_GROUP id_post_group smallint(5) unsigned NOT NULL default \'0\'',
+		'totalTimeLoggedIn' => 'totalTimeLoggedIn total_time_logged_in int(10) unsigned NOT NULL default \'0\'',
+		'passwordSalt' => 'passwordSalt password_salt varchar(255) NOT NULL default \'\'',
+		'ignoreBoards' => 'ignoreBoards ignore_boards text NOT NULL',
+		'memberIP2' => 'memberIP2 member_ip2 varchar(255) NOT NULL default \'\'',
+	),
+	'messages' => array(
+		'ID_MSG' => 'ID_MSG id_msg int(10) unsigned NOT NULL auto_increment',
+		'ID_TOPIC' => 'ID_TOPIC id_topic mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_BOARD' => 'ID_BOARD id_board smallint(5) unsigned NOT NULL default \'0\'',
+		'posterTime' => 'posterTime poster_time int(10) unsigned NOT NULL default \'0\'',
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_MSG_MODIFIED' => 'ID_MSG_MODIFIED id_msg_modified int(10) unsigned NOT NULL default \'0\'',
+		'posterName' => 'posterName poster_name varchar(255) NOT NULL default \'\'',
+		'posterEmail' => 'posterEmail poster_email varchar(255) NOT NULL default \'\'',
+		'posterIP' => 'posterIP poster_ip varchar(255) NOT NULL default \'\'',
+		'smileysEnabled' => 'smileysEnabled smileys_enabled tinyint(4) NOT NULL default \'1\'',
+		'modifiedTime' => 'modifiedTime modified_time int(10) unsigned NOT NULL default \'0\'',
+		'modifiedName' => 'modifiedName modified_name varchar(255) NOT NULL default \'\'',
+	),
+	'membergroups' => array(
+		'ID_GROUP' => 'ID_GROUP id_group smallint(5) unsigned NOT NULL auto_increment',
+		'ID_PARENT' => 'ID_PARENT id_parent smallint(5) NOT NULL default \'-2\'',
+		'groupName' => 'groupName group_name varchar(80) NOT NULL default \'\'',
+		'onlineColor' => 'onlineColor online_color varchar(20) NOT NULL default \'\'',
+		'minPosts' => 'minPosts min_posts mediumint(9) NOT NULL default \'-1\'',
+		'maxMessages' => 'maxMessages max_messages smallint(5) unsigned NOT NULL default \'0\'',
+		'groupType' => 'groupType group_type tinyint(3) NOT NULL default \'0\'',
+	),
+	'message_icons' => array(
+		'ID_ICON' => 'ID_ICON id_icon smallint(5) unsigned NOT NULL auto_increment',
+		'iconOrder' => 'iconOrder icon_order smallint(5) unsigned NOT NULL default \'0\'',
+		'ID_BOARD' => 'ID_BOARD id_board smallint(5) unsigned NOT NULL default \'0\'',
+	),
+	'moderators' => array(
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_BOARD' => 'ID_BOARD id_board smallint(5) unsigned NOT NULL default \'0\'',
+	),
+	'package_servers' => array(
+		'ID_SERVER' => 'ID_SERVER id_server smallint(5) unsigned NOT NULL auto_increment',
+	),
+	'personal_messages' => array(
+		'ID_PM' => 'ID_PM id_pm int(10) unsigned NOT NULL auto_increment',
+		'ID_MEMBER_FROM' => 'ID_MEMBER_FROM id_member_from mediumint(8) unsigned NOT NULL default \'0\'',
+		'deletedBySender' => 'deletedBySender deleted_by_sender tinyint(3) unsigned NOT NULL default \'0\'',
+		'fromName' => 'fromName from_name varchar(255) NOT NULL default \'\'',
+	),
+	'permission_profiles' => array(
+		'ID_PROFILE' => 'ID_PROFILE id_profile smallint(5) NOT NULL auto_increment',
+	),
+	'permissions' => array(
+		'ID_GROUP' => 'ID_GROUP id_group smallint(5) NOT NULL default \'0\'',
+		'addDeny' => 'addDeny add_deny tinyint(4) NOT NULL default \'1\'',
+	),
+	'pm_recipients' => array(
+		'ID_PM' => 'ID_PM id_pm int(10) unsigned NOT NULL default \'0\'',
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+	),
+	'polls' => array(
+		'ID_POLL' => 'ID_POLL id_poll mediumint(8) unsigned NOT NULL auto_increment',
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) unsigned NOT NULL default \'0\'',
+		'votingLocked' => 'votingLocked voting_locked tinyint(1) NOT NULL default \'0\'',
+		'maxVotes' => 'maxVotes max_votes tinyint(3) unsigned NOT NULL default \'1\'',
+		'expireTime' => 'expireTime expire_time int(10) unsigned NOT NULL default \'0\'',
+		'hideResults' => 'hideResults hide_results tinyint(3) unsigned NOT NULL default \'0\'',
+		'changeVote' => 'changeVote change_vote tinyint(3) unsigned NOT NULL default \'0\'',
+		'posterName' => 'posterName poster_name varchar(255) NOT NULL default \'\'',
+	),
+	'poll_choices' => array(
+		'ID_CHOICE' => 'ID_CHOICE id_choice tinyint(3) unsigned NOT NULL default \'0\'',
+		'ID_POLL' => 'ID_POLL id_poll mediumint(8) unsigned NOT NULL default \'0\'',
+	),
+	'scheduled_tasks' => array(
+		'ID_TASK' => 'ID_TASK id_task smallint(5) NOT NULL auto_increment',
+		'nextTime' => 'nextTime next_time int(10) NOT NULL default \'0\'',
+		'timeRegularity' => 'timeRegularity time_regularity smallint(5) NOT NULL default \'0\'',
+		'timeOffset' => 'timeOffset time_offset int(10) NOT NULL default \'0\'',
+		'timeUnit' => 'timeUnit time_unit varchar(1) NOT NULL default \'h\'',
+	),
+	'smileys' => array(
+		'ID_SMILEY' => 'ID_SMILEY id_smiley smallint(5) unsigned NOT NULL auto_increment',
+		'smileyRow' => 'smileyRow smiley_row tinyint(4) unsigned NOT NULL default \'0\'',
+		'smileyOrder' => 'smileyOrder smiley_order smallint(5) unsigned NOT NULL default \'0\'',
+	),
+	'subscriptions' => array(
+		'ID_SUBSCRIBE' => 'ID_SUBSCRIBE id_subscribe mediumint(8) unsigned NOT NULL auto_increment',
+		'ID_GROUP' => 'ID_GROUP id_group smallint(5) NOT NULL default \'0\'',
+		'addGroups' => 'addGroups add_groups varchar(40) NOT NULL default \'\'',
+		'allowPartial' => 'allowPartial allow_partial tinyint(3) NOT NULL default \'0\'',
+	),
+	'themes' => array(
+		'ID_MEMBER' => 'ID_MEMBER id_member mediumint(8) NOT NULL default \'0\'',
+		'ID_THEME' => 'ID_THEME id_theme tinyint(4) unsigned NOT NULL default \'1\'',
+	),
+	'topics' => array(
+		'ID_TOPIC' => 'ID_TOPIC id_topic mediumint(8) unsigned NOT NULL auto_increment',
+		'isSticky' => 'isSticky is_sticky tinyint(4) NOT NULL default \'0\'',
+		'ID_BOARD' => 'ID_BOARD id_board smallint(5) unsigned NOT NULL default \'0\'',
+		'ID_FIRST_MSG' => 'ID_FIRST_MSG id_first_msg int(10) unsigned NOT NULL default \'0\'',
+		'ID_LAST_MSG' => 'ID_LAST_MSG id_last_msg int(10) unsigned NOT NULL default \'0\'',
+		'ID_MEMBER_STARTED' => 'ID_MEMBER_STARTED id_member_started mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_MEMBER_UPDATED' => 'ID_MEMBER_UPDATED id_member_updated mediumint(8) unsigned NOT NULL default \'0\'',
+		'ID_POLL' => 'ID_POLL id_poll mediumint(8) unsigned NOT NULL default \'0\'',
+		'numReplies' => 'numReplies num_replies int(10) unsigned NOT NULL default \'0\'',
+		'numViews' => 'numViews num_views int(10) unsigned NOT NULL default \'0\'',
+		'unapprovedPosts' => 'unapprovedPosts unapproved_posts smallint(5) NOT NULL default \'0\'',
+	),
+);
+
+$_GET['ren_col'] = isset($_GET['ren_col']) ? (int) $_GET['ren_col'] : 0;
+$step_progress['name'] = 'Renaming columns';
+$step_progress['current'] = $_GET['ren_col'];
+$step_progress['total'] = count($nameChanges);
+
+$count = 0;
+// Now do every table...
+foreach ($nameChanges as $table_name => $table)
+{
+	// Already done this?
+	$count++;
+	if ($_GET['ren_col'] > $count)
+		continue;
+	$_GET['ren_col'] = $count;
+
+	// Check the table exists!
+	$request = upgrade_query("
+		SHOW TABLES
+		LIKE '{$db_prefix}$table_name'");
+	if (mysqli_num_rows($request) == 0)
+	{
+		mysqli_free_result($request);
+		continue;
+	}
+	mysqli_free_result($request);
+
+	// Check each column!
+	$actualChanges = array();
+	foreach ($table as $colname => $coldef)
+	{
+		$change = array(
+			'table' => $table_name,
+			'name' => $colname,
+			'type' => 'column',
+			'method' => 'change_remove',
+			'text' => 'CHANGE ' . $coldef,
+		);
+
+		if (protected_alter($change, $substep, true) == false)
+			$actualChanges[] = ' CHANGE COLUMN ' . $coldef;
+	}
+
+	// Do the query - if it needs doing.
+	if (!empty($actualChanges))
+	{
+		$change = array(
+			'table' => $table_name,
+			'name' => 'na',
+			'type' => 'table',
+			'method' => 'full_change',
+			'text' => implode(', ', $actualChanges),
+		);
+
+		// Here we go - hold on!
+		protected_alter($change, $substep);
+	}
+
+	// Update where we are!
+	$step_progress['current'] = $_GET['ren_col'];
+}
+
+// All done!
+unset($_GET['ren_col']);
+---}
+---#
+
+---# Converting "log_online".
+DROP TABLE IF EXISTS {$db_prefix}log_online;
+CREATE TABLE {$db_prefix}log_online (
+	session varchar(32) NOT NULL default '',
+	log_time int(10) NOT NULL default '0',
+	id_member mediumint(8) unsigned NOT NULL default '0',
+	id_spider smallint(5) unsigned NOT NULL default '0',
+	ip int(10) unsigned NOT NULL default '0',
+	url text NOT NULL,
+	PRIMARY KEY (session),
+	KEY log_time (log_time),
+	KEY id_member (id_member)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+/******************************************************************************/
+--- Adding new board specific features.
+/******************************************************************************/
+
+---# Implementing board redirects.
+ALTER TABLE {$db_prefix}boards
+ADD COLUMN redirect varchar(255) NOT NULL default '';
+---#
+
+/******************************************************************************/
+--- Adding search engine tracking.
+/******************************************************************************/
+
+---# Creating spider table.
+CREATE TABLE IF NOT EXISTS {$db_prefix}spiders (
+	id_spider smallint(5) unsigned NOT NULL auto_increment,
+	spider_name varchar(255) NOT NULL default '',
+	user_agent varchar(255) NOT NULL default '',
+	ip_info varchar(255) NOT NULL default '',
+	PRIMARY KEY id_spider(id_spider)
+) ENGINE=MyISAM{$db_collation};
+
+INSERT IGNORE INTO {$db_prefix}spiders
+	(id_spider, spider_name, user_agent, ip_info)
+VALUES
+	(1, 'Google', 'googlebot', ''),
+	(2, 'Yahoo!', 'slurp', ''),
+	(3, 'Bing', 'bingbot', ''),
+	(4, 'Google (Mobile)', 'Googlebot-Mobile', ''),
+	(5, 'Google (Image)', 'Googlebot-Image', ''),
+	(6, 'Google (AdSense)', 'Mediapartners-Google', ''),
+	(7, 'Google (Adwords)', 'AdsBot-Google', ''),
+	(8, 'Yahoo! (Mobile)', 'YahooSeeker/M1A1-R2D2', ''),
+	(9, 'Yahoo! (Image)', 'Yahoo-MMCrawler', ''),
+	(10, 'Bing (Preview)', 'BingPreview', ''),
+	(11, 'Bing (Ads)', 'adidxbot', ''),
+	(12, 'Bing (MSNBot)', 'msnbot', ''),
+	(13, 'Bing (Media)', 'msnbot-media', ''),
+	(14, 'Cuil', 'twiceler', ''),
+	(15, 'Ask', 'Teoma', ''),
+	(16, 'Baidu', 'Baiduspider', ''),
+	(17, 'Gigablast', 'Gigabot', ''),
+	(18, 'InternetArchive', 'ia_archiver-web.archive.org', ''),
+	(19, 'Alexa', 'ia_archiver', ''),
+	(20, 'Omgili', 'omgilibot', ''),
+	(21, 'EntireWeb', 'Speedy Spider', ''),
+	(22, 'Yandex', 'yandex', '');
+---#
+
+---# Removing a spider.
+---{
+	upgrade_query("
+		DELETE FROM {$db_prefix}spiders
+		WHERE user_agent = 'yahoo'
+			AND spider_name = 'Yahoo! (Publisher)'
+	");
+---}
+---#
+
+---# Creating spider hit tracking table.
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_spider_hits (
+	id_hit int(10) unsigned NOT NULL auto_increment,
+	id_spider smallint(5) unsigned NOT NULL default '0',
+	log_time int(10) unsigned NOT NULL default '0',
+	url varchar(255) NOT NULL default '',
+	processed tinyint(3) unsigned NOT NULL default '0',
+	PRIMARY KEY (id_hit),
+	KEY id_spider(id_spider),
+	KEY log_time(log_time),
+	KEY processed (processed)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Making some changes to spider hit table...
+ALTER TABLE {$db_prefix}log_spider_hits
+ADD COLUMN id_hit int(10) unsigned NOT NULL auto_increment,
+ADD PRIMARY KEY (id_hit);
+---#
+
+---# Creating spider statistic table.
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_spider_stats (
+	id_spider smallint(5) unsigned NOT NULL default '0',
+	page_hits smallint(5) unsigned NOT NULL default '0',
+	last_seen int(10) unsigned NOT NULL default '0',
+	stat_date date NOT NULL default '0001-01-01',
+	PRIMARY KEY (stat_date, id_spider)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+/******************************************************************************/
+--- Adding new forum settings.
+/******************************************************************************/
+
+---# Resetting settings_updated.
+REPLACE INTO {$db_prefix}settings
+	(variable, value)
+VALUES
+	('settings_updated', '0'),
+	('last_mod_report_action', '0'),
+	('search_floodcontrol_time', '5'),
+	('next_task_time', UNIX_TIMESTAMP());
+---#
+
+---# Changing stats settings.
+---{
+$request = upgrade_query("
+	SELECT value
+	FROM {$db_prefix}themes
+	WHERE variable = 'show_sp1_info'");
+if (mysqli_num_rows($request) != 0)
+{
+	upgrade_query("
+		DELETE FROM {$db_prefix}themes
+		WHERE variable = 'show_stats_index'");
+
+	upgrade_query("
+		UPDATE {$db_prefix}themes
+		SET variable = 'show_stats_index'
+		WHERE variable = 'show_sp1_info'");
+}
+upgrade_query("
+	DELETE FROM {$db_prefix}themes
+	WHERE variable = 'show_sp1_info'");
+---}
+---#
+
+---# Enable cache if upgrading from 1.1 and lower.
+---{
+if (isset($modSettings['smfVersion']) && $modSettings['smfVersion'] <= '2.0 Beta 1')
+{
+	$request = upgrade_query("
+		SELECT value
+		FROM {$db_prefix}settings
+		WHERE variable = 'cache_enable'");
+	list ($cache_enable) = $smcFunc['db_fetch_row']($request);
+
+	// No cache before 1.1.
+	if ($smcFunc['db_num_rows']($request) == 0)
+		upgrade_query("
+			INSERT INTO {$db_prefix}settings
+				(variable, value)
+			VALUES ('cache_enable', '1')");
+	elseif (empty($cache_enable))
+		upgrade_query("
+			UPDATE {$db_prefix}settings
+			SET value = '1'
+			WHERE variable = 'cache_enable'");
+}
+---}
+---#
+
+---# Changing visual verification setting.
+---{
+$request = upgrade_query("
+	SELECT value
+	FROM {$db_prefix}settings
+	WHERE variable = 'disable_visual_verification'");
+if (mysqli_num_rows($request) != 0)
+{
+	list ($oldValue) = mysqli_fetch_row($request);
+	if ($oldValue != 0)
+	{
+		// We have changed the medium setting from SMF 1.1.2.
+		if ($oldValue == 4)
+			$oldValue = 5;
+
+		upgrade_query("
+			UPDATE {$db_prefix}settings
+			SET variable = 'visual_verification_type', value = $oldValue
+			WHERE variable = 'disable_visual_verification'");
+	}
+}
+upgrade_query("
+	DELETE FROM {$db_prefix}settings
+	WHERE variable = 'disable_visual_verification'");
+---}
+---#
+
+---# Changing visual verification setting, again.
+---{
+$request = upgrade_query("
+	SELECT value
+	FROM {$db_prefix}settings
+	WHERE variable = 'reg_verification'");
+if (mysqli_num_rows($request) == 0)
+{
+	// Upgrade visual verification again!
+	if (!empty($modSettings['visual_verification_type']))
+	{
+		upgrade_query("
+			UPDATE {$db_prefix}settings
+			SET value = value - 1
+			WHERE variable = 'visual_verification_type'");
+		$modSettings['visual_verification_type']--;
+	}
+	// Never set?
+	elseif (!isset($modSettings['visual_verification_type']))
+	{
+		upgrade_query("
+			INSERT INTO {$db_prefix}settings
+				(variable, value)
+			VALUES
+				('visual_verification_type', '3')");
+		$modSettings['visual_verification_type'] = 3;
+	}
+
+	upgrade_query("
+		INSERT INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('reg_verification', '" . (!empty($modSettings['visual_verification_type']) ? 1 : 0) . "')");
+}
+---}
+---#
+
+---# Changing default personal text setting.
+UPDATE {$db_prefix}settings
+SET variable = 'default_personal_text'
+WHERE variable = 'default_personalText';
+
+DELETE FROM {$db_prefix}settings
+WHERE variable = 'default_personalText';
+---#
+
+---# Removing allow hide email setting.
+DELETE FROM {$db_prefix}settings
+WHERE variable = 'allow_hideEmail'
+	OR variable = 'allow_hide_email';
+---#
+
+---# Ensuring stats index setting present...
+INSERT IGNORE INTO {$db_prefix}themes
+	(id_theme, variable, value)
+VALUES
+	(1, 'show_stats_index', '0');
+---#
+
+---# Ensuring forum width setting present...
+INSERT IGNORE INTO {$db_prefix}themes
+	(id_theme, variable, value)
+VALUES
+	(1, 'forum_width', '90%');
+---#
+
+---# Replacing old calendar settings...
+---{
+// Only try it if one of the "new" settings doesn't yet exist.
+if (!isset($modSettings['cal_showholidays']) || !isset($modSettings['cal_showbdays']) || !isset($modSettings['cal_showevents']))
+{
+	// Default to just the calendar setting.
+	$modSettings['cal_showholidays'] = empty($modSettings['cal_showholidaysoncalendar']) ? 0 : 1;
+	$modSettings['cal_showbdays'] = empty($modSettings['cal_showbdaysoncalendar']) ? 0 : 1;
+	$modSettings['cal_showevents'] = empty($modSettings['cal_showeventsoncalendar']) ? 0 : 1;
+
+	// Then take into account board index.
+	if (!empty($modSettings['cal_showholidaysonindex']))
+		$modSettings['cal_showholidays'] = $modSettings['cal_showholidays'] === 1 ? 2 : 3;
+	if (!empty($modSettings['cal_showbdaysonindex']))
+		$modSettings['cal_showbdays'] = $modSettings['cal_showbdays'] === 1 ? 2 : 3;
+	if (!empty($modSettings['cal_showeventsonindex']))
+		$modSettings['cal_showevents'] = $modSettings['cal_showevents'] === 1 ? 2 : 3;
+
+	// Actually save the settings.
+	upgrade_query("
+		INSERT IGNORE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('cal_showholidays', $modSettings[cal_showholidays]),
+			('cal_showbdays', $modSettings[cal_showbdays]),
+			('cal_showevents', $modSettings[cal_showevents])");
+}
+
+---}
+---#
+
+---# Fixing the calendar holidays if they were somehow wrong before...
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2013-11-28'
+WHERE event_date = '2013-11-21'
+	AND title = 'Thanksgiving';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2014-11-27'
+WHERE event_date = '2014-11-20'
+	AND title = 'Thanksgiving';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2019-11-28'
+WHERE event_date = '2019-11-21'
+	AND title = 'Thanksgiving';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2013-09-02'
+WHERE event_date = '2013-09-09'
+	AND title = 'Labor Day';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2014-09-01'
+WHERE event_date = '2014-09-08'
+	AND title = 'Labor Day';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2019-09-02'
+WHERE event_date = '2019-09-09'
+	AND title = 'Labor Day';
+---#
+
+---# Deleting old calendar settings...
+	DELETE FROM {$db_prefix}settings
+	WHERE VARIABLE IN ('cal_showholidaysonindex', 'cal_showbdaysonindex', 'cal_showeventsonindex',
+		'cal_showholidaysoncalendar', 'cal_showbdaysoncalendar', 'cal_showeventsoncalendar',
+		'cal_holidaycolor', 'cal_bdaycolor', 'cal_eventcolor');
+---#
+
+---# Adjusting calendar maximum year...
+---{
+if (!isset($modSettings['cal_maxyear']) || $modSettings['cal_maxyear'] < 2030)
+{
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('cal_maxyear', '2030')");
+}
+---}
+---#
+
+---# Adding advanced signature settings...
+---{
+if (empty($modSettings['signature_settings']))
+{
+	if (isset($modSettings['max_signatureLength']))
+		$modSettings['signature_settings'] = '1,' . $modSettings['max_signatureLength'] . ',0,0,0,0,0,0:';
+	else
+		$modSettings['signature_settings'] = '1,300,0,0,0,0,0,0:';
+
+	upgrade_query("
+		INSERT IGNORE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('signature_settings', '$modSettings[signature_settings]')");
+
+	upgrade_query("
+		DELETE FROM {$db_prefix}settings
+		WHERE variable = 'max_signatureLength'");
+}
+---}
+---#
+
+---# Updating spam protection settings.
+---{
+if (empty($modSettings['pm_spam_settings']))
+{
+	if (isset($modSettings['max_pm_recipients']))
+		$modSettings['pm_spam_settings'] = $modSettings['max_pm_recipients'] . ',5,20';
+	else
+		$modSettings['pm_spam_settings'] = '10,5,20';
+}
+elseif (substr_count($modSettings['pm_spam_settings'], ',') == 1)
+{
+	$modSettings['pm_spam_settings'] .= ',20';
+}
+
+upgrade_query("
+	INSERT IGNORE INTO {$db_prefix}settings
+		(variable, value)
+	VALUES
+		('pm_spam_settings', '$modSettings[pm_spam_settings]')");
+
+upgrade_query("
+	DELETE FROM {$db_prefix}settings
+	WHERE variable = 'max_pm_recipients'");
+---}
+---#
+
+---# Adjusting timezone settings...
+---{
+	if (!isset($modSettings['default_timezone']) && function_exists('date_default_timezone_set'))
+	{
+		$server_offset = mktime(0, 0, 0, 1, 1, 1970);
+		$timezone_id = 'Etc/GMT' . ($server_offset > 0 ? '+' : '') . ($server_offset / 3600);
+		if (date_default_timezone_set($timezone_id))
+			upgrade_query("
+				REPLACE INTO {$db_prefix}settings
+					(variable, value)
+				VALUES
+					('default_timezone', '$timezone_id')");
+	}
+---}
+---#
+
+---# Checking theme layers are correct for default themes.
+---{
+$request = upgrade_query("
+	SELECT id_theme, value, variable
+	FROM {$db_prefix}themes
+	WHERE variable = 'theme_layers'
+		OR variable = 'theme_dir'");
+$themeLayerChanges = array();
+while ($row = mysqli_fetch_assoc($request))
+{
+	$themeLayerChanges[$row['id_theme']][$row['variable']] = $row['value'];
+}
+mysqli_free_result($request);
+
+foreach ($themeLayerChanges as $id_theme => $data)
+{
+	// Has to be a SMF provided theme and have custom layers defined.
+	if (!isset($data['theme_layers']) || !isset($data['theme_dir']) || !in_array(substr($data['theme_dir'], -7), array('default', 'babylon', 'classic')))
+		continue;
+
+	$layers = explode(',', $data['theme_layers']);
+	foreach ($layers as $k => $v)
+		if ($v == 'main')
+		{
+			$layers[$k] = 'html,body';
+			upgrade_query("
+				UPDATE {$db_prefix}themes
+				SET value = '" . implode(',', $layers) . "'
+				WHERE id_theme = $id_theme
+					AND variable = 'theme_layers'");
+			break;
+		}
+}
+---}
+---#
+
+---# Adding index to log_notify table...
+ALTER TABLE {$db_prefix}log_notify
+ADD INDEX id_topic (id_topic, id_member);
+---#
+
+---# GDPR compliance settings.
+---{
+if (!isset($modSettings['requirePolicyAgreement']))
+{
+	upgrade_query("
+		INSERT INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('requirePolicyAgreement', '0')");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Adding custom profile fields.
+/******************************************************************************/
+
+---# Creating "custom_fields" table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}custom_fields (
+	id_field smallint(5) NOT NULL auto_increment,
+	col_name varchar(12) NOT NULL default '',
+	field_name varchar(40) NOT NULL default '',
+	field_desc varchar(255) NOT NULL default '',
+	field_type varchar(8) NOT NULL default 'text',
+	field_length smallint(5) NOT NULL default '255',
+	field_options text NOT NULL,
+	mask varchar(255) NOT NULL default '',
+	show_reg tinyint(3) NOT NULL default '0',
+	show_display tinyint(3) NOT NULL default '0',
+	show_profile varchar(20) NOT NULL default 'forumprofile',
+	private tinyint(3) NOT NULL default '0',
+	active tinyint(3) NOT NULL default '1',
+	bbc tinyint(3) NOT NULL default '0',
+	default_value varchar(255) NOT NULL default '',
+	PRIMARY KEY (id_field),
+	UNIQUE col_name (col_name)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Adding search ability to custom fields.
+ALTER TABLE {$db_prefix}custom_fields
+ADD COLUMN can_search tinyint(3) NOT NULL default '0' AFTER bbc;
+---#
+
+---# Fixing default value field length.
+ALTER TABLE {$db_prefix}custom_fields
+CHANGE COLUMN default_value default_value varchar(255) NOT NULL default '';
+---#
+
+---# Enhancing privacy settings for custom fields.
+---{
+if (isset($modSettings['smfVersion']) && $modSettings['smfVersion'] <= '2.0 Beta 1')
+{
+upgrade_query("
+	UPDATE {$db_prefix}custom_fields
+	SET private = 2
+	WHERE private = 1");
+}
+if (isset($modSettings['smfVersion']) && $modSettings['smfVersion'] < '2.0 Beta 4')
+{
+upgrade_query("
+	UPDATE {$db_prefix}custom_fields
+	SET private = 3
+	WHERE private = 2");
+}
+---}
+---#
+
+---# Checking display fields setup correctly..
+---{
+if (isset($modSettings['smfVersion']) && $modSettings['smfVersion'] <= '2.0 Beta 1' && isset($modSettings['displayFields']) && @unserialize($modSettings['displayFields']) == false)
+{
+$request = upgrade_query("
+	SELECT col_name, field_name, bbc
+	FROM {$db_prefix}custom_fields
+	WHERE show_display = 1
+		AND active = 1
+		AND private != 2");
+$fields = array();
+while ($row = mysqli_fetch_assoc($request))
+{
+	$fields[] = array(
+		'c' => strtr($row['col_name'], array('|' => '', ';' => '')),
+		'f' => strtr($row['field_name'], array('|' => '', ';' => '')),
+		'b' => ($row['bbc'] ? '1' : '0')
+	);
+}
+mysqli_free_result($request);
+
+upgrade_query("
+	UPDATE {$db_prefix}settings
+	SET value = '" . mysqli_real_escape_string(serialize($fields)) . "'
+	WHERE variable = 'displayFields'");
+}
+---}
+---#
+
+---# Adding new custom fields columns.
+ALTER TABLE {$db_prefix}custom_fields
+ADD enclose text NOT NULL;
+
+ALTER TABLE {$db_prefix}custom_fields
+ADD placement tinyint(3) NOT NULL default '0';
+---#
+
+/******************************************************************************/
+--- Adding email digest functionality.
+/******************************************************************************/
+
+---# Creating "log_digest" table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_digest (
+	id_topic mediumint(8) unsigned NOT NULL default '0',
+	id_msg int(10) unsigned NOT NULL default '0',
+	note_type varchar(10) NOT NULL default 'post',
+	daily tinyint(3) unsigned NOT NULL default '0',
+	exclude mediumint(8) unsigned NOT NULL default '0'
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Adding digest option to "members" table...
+ALTER TABLE {$db_prefix}members
+CHANGE COLUMN notifyOnce notify_regularity tinyint(4) unsigned NOT NULL default '1';
+---#
+
+/******************************************************************************/
+--- Making changes to the package manager.
+/******************************************************************************/
+
+---# Creating "log_packages" table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_packages (
+	id_install int(10) NOT NULL auto_increment,
+	filename varchar(255) NOT NULL default '',
+	package_id varchar(255) NOT NULL default '',
+	name varchar(255) NOT NULL default '',
+	version varchar(255) NOT NULL default '',
+	id_member_installed mediumint(8) NOT NULL default '0',
+	member_installed varchar(255) NOT NULL default '',
+	time_installed int(10) NOT NULL default '0',
+	id_member_removed mediumint(8) NOT NULL default '0',
+	member_removed varchar(255) NOT NULL default '',
+	time_removed int(10) NOT NULL default '0',
+	install_state tinyint(3) NOT NULL default '1',
+	failed_steps text NOT NULL,
+	themes_installed varchar(255) NOT NULL default '',
+	db_changes text NOT NULL,
+	PRIMARY KEY (id_install),
+	KEY filename (filename(15))
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Adding extra "log_packages" columns...
+ALTER TABLE {$db_prefix}log_packages
+ADD db_changes text NOT NULL AFTER themes_installed;
+---#
+
+---# Changing URL to SMF package server...
+UPDATE {$db_prefix}package_servers
+SET url = 'https://custom.simplemachines.org/packages/mods'
+WHERE
+	url = 'http://mods.simplemachines.org'
+	OR url = 'http://custom.simplemachines.org/packages/mods';
+---#
+
+/******************************************************************************/
+--- Creating mail queue functionality.
+/******************************************************************************/
+
+---# Creating "mail_queue" table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}mail_queue (
+	id_mail int(10) unsigned NOT NULL auto_increment,
+	time_sent int(10) NOT NULL default '0',
+	recipient varchar(255) NOT NULL default '',
+	body text NOT NULL,
+	subject varchar(255) NOT NULL default '',
+	headers text NOT NULL,
+	send_html tinyint(3) NOT NULL default '0',
+	priority tinyint(3) NOT NULL default '1',
+	PRIMARY KEY (id_mail),
+	KEY time_sent (time_sent),
+	KEY mail_priority (priority, id_mail)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Adding new mail queue settings...
+---{
+if (!isset($modSettings['mail_next_send']))
+{
+	upgrade_query("
+		INSERT INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('mail_next_send', '0'),
+			('mail_recent', '0000000000|0')");
+}
+---}
+---#
+
+---# Change mail queue indexes...
+ALTER TABLE {$db_prefix}mail_queue
+DROP INDEX priority;
+
+ALTER TABLE {$db_prefix}mail_queue
+ADD INDEX mail_priority (priority, id_mail);
+---#
+
+---# Adding type to mail queue...
+ALTER TABLE {$db_prefix}mail_queue
+ADD private tinyint(1) NOT NULL default '0';
+---#
+
+/******************************************************************************/
+--- Creating moderation center tables.
+/******************************************************************************/
+
+---# Creating "log_reported" table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_reported (
+	id_report mediumint(8) unsigned NOT NULL auto_increment,
+	id_msg int(10) unsigned NOT NULL default '0',
+	id_topic mediumint(8) unsigned NOT NULL default '0',
+	id_board smallint(5) unsigned NOT NULL default '0',
+	id_member mediumint(8) unsigned NOT NULL default '0',
+	membername varchar(255) NOT NULL default '',
+	subject varchar(255) NOT NULL default '',
+	body text NOT NULL,
+	time_started int(10) NOT NULL default '0',
+	time_updated int(10) NOT NULL default '0',
+	num_reports mediumint(6) NOT NULL default '0',
+	closed tinyint(3) NOT NULL default '0',
+	ignore_all tinyint(3) NOT NULL default '0',
+	PRIMARY KEY (id_report),
+	KEY id_member (id_member),
+	KEY id_topic (id_topic),
+	KEY closed (closed),
+	KEY time_started (time_started),
+	KEY id_msg (id_msg)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Creating "log_reported_comments" table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_reported_comments (
+	id_comment mediumint(8) unsigned NOT NULL auto_increment,
+	id_report mediumint(8) NOT NULL default '0',
+	id_member mediumint(8) NOT NULL,
+	membername varchar(255) NOT NULL default '',
+	comment varchar(255) NOT NULL default '',
+	time_sent int(10) NOT NULL,
+	PRIMARY KEY (id_comment),
+	KEY id_report (id_report),
+	KEY id_member (id_member),
+	KEY time_sent (time_sent)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Adding moderator center permissions...
+---{
+// Don't do this twice!
+if (@$modSettings['smfVersion'] < '2.0')
+{
+	// Try find people who probably should see the moderation center.
+	$request = upgrade_query("
+		SELECT id_group, add_deny, permission
+		FROM {$db_prefix}permissions
+		WHERE permission = 'calendar_edit_any'");
+	$inserts = array();
+	while ($row = mysqli_fetch_assoc($request))
+	{
+		$inserts[] = "($row[id_group], 'access_mod_center', $row[add_deny])";
+	}
+	mysqli_free_result($request);
+
+	if (!empty($inserts))
+		upgrade_query("
+			INSERT IGNORE INTO {$db_prefix}permissions
+				(id_group, permission, add_deny)
+			VALUES
+				" . implode(',', $inserts));
+}
+---}
+---#
+
+---# Adding moderation center preferences...
+ALTER TABLE {$db_prefix}members
+ADD mod_prefs varchar(20) NOT NULL default '';
+---#
+
+/******************************************************************************/
+--- Adding user warnings.
+/******************************************************************************/
+
+---# Creating member notices table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_member_notices (
+	id_notice mediumint(8) unsigned NOT NULL auto_increment,
+	subject varchar(255) NOT NULL default '',
+	body text NOT NULL,
+	PRIMARY KEY (id_notice)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Creating comments table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_comments (
+	id_comment mediumint(8) unsigned NOT NULL auto_increment,
+	id_member mediumint(8) unsigned NOT NULL default '0',
+	member_name varchar(80) NOT NULL default '',
+	comment_type varchar(8) NOT NULL default 'warning',
+	id_recipient mediumint(8) unsigned NOT NULL default '0',
+	recipient_name varchar(255) NOT NULL default '',
+	log_time int(10) NOT NULL default '0',
+	id_notice mediumint(8) unsigned NOT NULL default '0',
+	counter tinyint(3) NOT NULL default '0',
+	body text NOT NULL,
+	PRIMARY KEY (id_comment),
+	KEY id_recipient (id_recipient),
+	KEY log_time (log_time),
+	KEY comment_type (comment_type(8))
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Adding user warning column...
+ALTER TABLE {$db_prefix}members
+ADD warning tinyint(4) NOT NULL default '0';
+
+ALTER TABLE {$db_prefix}members
+ADD INDEX warning (warning);
+---#
+
+---# Ensuring warning settings are present...
+---{
+// Only do this if not already done.
+if (empty($modSettings['warning_settings']))
+{
+	upgrade_query("
+		INSERT IGNORE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('warning_settings', '1,20,0'),
+			('warning_watch', '10'),
+			('warning_moderate', '35'),
+			('warning_mute', '60')");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Enhancing membergroups.
+/******************************************************************************/
+
+---# Creating "log_group_requests" table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_group_requests (
+	id_request mediumint(8) unsigned NOT NULL auto_increment,
+	id_member mediumint(8) unsigned NOT NULL default '0',
+	id_group smallint(5) unsigned NOT NULL default '0',
+	time_applied int(10) unsigned NOT NULL default '0',
+	reason text NOT NULL,
+	PRIMARY KEY (id_request),
+	UNIQUE id_member (id_member, id_group)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Adding new membergroup table columns...
+ALTER TABLE {$db_prefix}membergroups
+ADD description text NOT NULL AFTER group_name;
+
+ALTER TABLE {$db_prefix}membergroups
+ADD group_type tinyint(3) NOT NULL default '0';
+
+ALTER TABLE {$db_prefix}membergroups
+ADD hidden tinyint(3) NOT NULL default '0';
+---#
+
+---# Creating "group_moderators" table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}group_moderators (
+	id_group smallint(5) unsigned NOT NULL default '0',
+	id_member mediumint(8) unsigned NOT NULL default '0',
+	PRIMARY KEY (id_group, id_member)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+/******************************************************************************/
+--- Updating attachment data...
+/******************************************************************************/
+
+---# Altering attachment table.
+ALTER TABLE {$db_prefix}attachments
+ADD COLUMN fileext varchar(8) NOT NULL default '',
+ADD COLUMN mime_type varchar(20) NOT NULL default '';
+
+ALTER TABLE {$db_prefix}attachments
+ADD COLUMN id_folder tinyint(3) NOT NULL default '1';
+---#
+
+---# Adding file hash.
+ALTER TABLE {$db_prefix}attachments
+ADD COLUMN file_hash varchar(40) NOT NULL default '';
+---#
+
+---# Populate the attachment extension.
+UPDATE {$db_prefix}attachments
+SET fileext = LOWER(SUBSTRING(filename, 1 - (INSTR(REVERSE(filename), '.'))))
+WHERE fileext = ''
+	AND INSTR(filename, '.')
+	AND INSTR(REVERSE(filename), '.') < 10
+	AND attachment_type != 3;
+---#
+
+---# Updating thumbnail attachments JPG.
+UPDATE {$db_prefix}attachments
+SET fileext = 'jpg'
+WHERE attachment_type = 3
+	AND fileext = ''
+	AND RIGHT(filename, 9) = 'JPG_thumb';
+---#
+
+---# Updating thumbnail attachments PNG.
+UPDATE {$db_prefix}attachments
+SET fileext = 'png'
+WHERE attachment_type = 3
+	AND fileext = ''
+	AND RIGHT(filename, 9) = 'PNG_thumb';
+---#
+
+---# Calculating attachment mime types.
+---{
+// Don't ever bother doing this twice.
+if (@$modSettings['smfVersion'] < '2.0' || @$modSettings['smfVersion'] === '2.0 a')
+{
+	$request = upgrade_query("
+		SELECT MAX(id_attach)
+		FROM {$db_prefix}attachments");
+	list ($step_progress['total']) = $smcFunc['db_fetch_row']($request);
+	$smcFunc['db_free_result']($request);
+
+	$_GET['a'] = isset($_GET['a']) ? (int) $_GET['a'] : 0;
+	$step_progress['name'] = 'Calculating MIME Types';
+	$step_progress['current'] = $_GET['a'];
+
+	if (!function_exists('getAttachmentFilename'))
+	{
+		function getAttachmentFilename($filename, $attachment_id)
+		{
+			global $modSettings;
+
+			$clean_name = strtr($filename, '', 'SZszYAAAAAACEEEEIIIINOOOOOOUUUUYaaaaaaceeeeiiiinoooooouuuuyy');
+			$clean_name = strtr($clean_name, array('' => 'TH', '' => 'th', '' => 'DH', '' => 'dh', '' => 'ss', '' => 'OE', '' => 'oe', '' => 'AE', '' => 'ae', '' => 'u'));
+			$clean_name = preg_replace(array('/\s/', '/[^\w_\.\-]/'), array('_', ''), $clean_name);
+			$enc_name = $attachment_id . '_' . strtr($clean_name, '.', '_') . md5($clean_name);
+			$clean_name = preg_replace('~\.[\.]+~', '.', $clean_name);
+
+			if ($attachment_id == false)
+				return $clean_name;
+
+			if (file_exists($modSettings['attachmentUploadDir'] . '/' . $enc_name))
+				$filename = $modSettings['attachmentUploadDir'] . '/' . $enc_name;
+			else
+				$filename = $modSettings['attachmentUploadDir'] . '/' . $clean_name;
+
+			return $filename;
+		}
+	}
+
+	$ext_updates = array();
+
+	// What headers are valid results for getimagesize?
+	$validTypes = array(
+		1 => 'gif',
+		2 => 'jpeg',
+		3 => 'png',
+		5 => 'psd',
+		6 => 'bmp',
+		7 => 'tiff',
+		8 => 'tiff',
+		9 => 'jpeg',
+		14 => 'iff',
+	);
+
+	$is_done = false;
+	while (!$is_done)
+	{
+		nextSubStep($substep);
+
+		$request = upgrade_query("
+			SELECT id_attach, filename, fileext
+			FROM {$db_prefix}attachments
+			WHERE fileext != ''
+				AND mime_type = ''
+			LIMIT $_GET[a], 100");
+		// Finished?
+		if ($smcFunc['db_num_rows']($request) == 0)
+			$is_done = true;
+		while ($row = $smcFunc['db_fetch_assoc']($request))
+		{
+			$filename = getAttachmentFilename($row['filename'], $row['id_attach']);
+			if (!file_exists($filename))
+				continue;
+
+			// Is it an image?
+			$size = @getimagesize($filename);
+			// Nothing valid?
+			if (empty($size) || empty($size[0]))
+				continue;
+			// Got the mime?
+			elseif (!empty($size['mime']))
+				$mime = $size['mime'];
+			// Otherwise is it valid?
+			elseif (!isset($validTypes[$size[2]]))
+				continue;
+			else
+				$mime = 'image/' . $validTypes[$size[2]];
+
+			// Let's try keep updates to a minimum.
+			if (!isset($ext_updates[$row['fileext'] . $size['mime']]))
+				$ext_updates[$row['fileext'] . $size['mime']] = array(
+					'fileext' => $row['fileext'],
+					'mime' => $mime,
+					'files' => array(),
+				);
+			$ext_updates[$row['fileext'] . $size['mime']]['files'][] = $row['id_attach'];
+		}
+		$smcFunc['db_free_result']($request);
+
+		// Do the updates?
+		foreach ($ext_updates as $key => $update)
+		{
+			upgrade_query("
+				UPDATE {$db_prefix}attachments
+				SET mime_type = '$update[mime]'
+				WHERE id_attach IN (" . implode(',', $update['files']) . ")");
+
+			// Remove it.
+			unset($ext_updates[$key]);
+		}
+
+		$_GET['a'] += 100;
+		$step_progress['current'] = $_GET['a'];
+	}
+
+	unset($_GET['a']);
+}
+---}
+---#
+
+/******************************************************************************/
+--- Adding Post Moderation.
+/******************************************************************************/
+
+---# Creating "approval_queue" table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}approval_queue (
+	id_msg int(10) unsigned NOT NULL default '0',
+	id_attach int(10) unsigned NOT NULL default '0',
+	id_event smallint(5) unsigned NOT NULL default '0'
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Adding approved column to attachments table...
+ALTER TABLE {$db_prefix}attachments
+ADD approved tinyint(3) NOT NULL default '1';
+---#
+
+---# Adding approved column to messages table...
+ALTER TABLE {$db_prefix}messages
+ADD approved tinyint(3) NOT NULL default '1';
+
+ALTER TABLE {$db_prefix}messages
+ADD INDEX approved (approved);
+---#
+
+---# Adding unapproved count column to topics table...
+ALTER TABLE {$db_prefix}topics
+ADD unapproved_posts smallint(5) NOT NULL default '0';
+---#
+
+---# Adding approved column to topics table...
+ALTER TABLE {$db_prefix}topics
+ADD approved tinyint(3) NOT NULL default '1',
+ADD INDEX approved (approved);
+---#
+
+---# Adding approved columns to boards table...
+ALTER TABLE {$db_prefix}boards
+ADD unapproved_posts smallint(5) NOT NULL default '0',
+ADD unapproved_topics smallint(5) NOT NULL default '0';
+---#
+
+---# Adding post moderation permissions...
+---{
+// We *cannot* do this twice!
+if (@$modSettings['smfVersion'] < '2.0')
+{
+	// Anyone who can currently edit posts we assume can approve them...
+	$request = upgrade_query("
+		SELECT id_group, id_board, add_deny, permission
+		FROM {$db_prefix}board_permissions
+		WHERE permission = 'modify_any'");
+	$inserts = array();
+	while ($row = mysqli_fetch_assoc($request))
+	{
+		$inserts[] = "($row[id_group], $row[id_board], 'approve_posts', $row[add_deny])";
+	}
+	mysqli_free_result($request);
+
+	if (!empty($inserts))
+		upgrade_query("
+			INSERT IGNORE INTO {$db_prefix}board_permissions
+				(id_group, id_board, permission, add_deny)
+			VALUES
+				" . implode(',', $inserts));
+}
+---}
+---#
+
+/******************************************************************************/
+--- Upgrading the error log.
+/******************************************************************************/
+
+---# Adding columns to log_errors table...
+ALTER TABLE {$db_prefix}log_errors
+ADD error_type char(15) NOT NULL default 'general';
+ALTER TABLE {$db_prefix}log_errors
+ADD file varchar(255) NOT NULL default '',
+ADD line mediumint(8) unsigned NOT NULL default '0';
+---#
+
+---# Updating error log table...
+---{
+$request = upgrade_query("
+	SELECT COUNT(*)
+	FROM {$db_prefix}log_errors");
+list($totalActions) = mysqli_fetch_row($request);
+mysqli_free_result($request);
+
+$_GET['m'] = !empty($_GET['m']) ? (int) $_GET['m'] : '0';
+$step_progress['total'] = $totalActions;
+$step_progress['current'] = $_GET['m'];
+
+while ($_GET['m'] < $totalActions)
+{
+	nextSubStep($substep);
+
+	$request = upgrade_query("
+		SELECT id_error, message, file, line
+		FROM {$db_prefix}log_errors
+		LIMIT $_GET[m], 500");
+	while($row = mysqli_fetch_assoc($request))
+	{
+		preg_match('~<br />(%1\$s: )?([\w\. \\\\/\-_:]+)<br />(%2\$s: )?([\d]+)~', $row['message'], $matches);
+		if (!empty($matches[2]) && !empty($matches[4]) && empty($row['file']) && empty($row['line']))
+		{
+			$row['file'] = addslashes(str_replace('\\', '/', $matches[2]));
+			$row['line'] = (int) $matches[4];
+			$row['message'] = addslashes(preg_replace('~<br />(%1\$s: )?([\w\. \\\\/\-_:]+)<br />(%2\$s: )?([\d]+)~', '', $row['message']));
+		}
+		else
+			continue;
+
+		upgrade_query("
+			UPDATE {$db_prefix}log_errors
+			SET file = SUBSTRING('$row[file]', 1, 255),
+				line = $row[line],
+				message = SUBSTRING('$row[message]', 1, 65535)
+			WHERE id_error = $row[id_error]
+			LIMIT 1");
+	}
+
+	$_GET['m'] += 500;
+	$step_progress['current'] = $_GET['m'];
+}
+unset($_GET['m']);
+---}
+---#
+
+/******************************************************************************/
+--- Adding Scheduled Tasks Data.
+/******************************************************************************/
+
+---# Creating Scheduled Task Table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}scheduled_tasks (
+	id_task smallint(5) NOT NULL auto_increment,
+	next_time int(10) NOT NULL default '0',
+	time_offset int(10) NOT NULL default '0',
+	time_regularity smallint(5) NOT NULL default '0',
+	time_unit varchar(1) NOT NULL default 'h',
+	disabled tinyint(3) NOT NULL default '0',
+	task varchar(24) NOT NULL default '',
+	PRIMARY KEY (id_task),
+	KEY next_time (next_time),
+	KEY disabled (disabled),
+	UNIQUE task (task)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Populating Scheduled Task Table...
+INSERT IGNORE INTO {$db_prefix}scheduled_tasks
+	(next_time, time_offset, time_regularity, time_unit, disabled, task)
+VALUES
+	(0, 0, 2, 'h', 0, 'approval_notification'),
+	(0, 60, 1, 'd', 0, 'daily_maintenance'),
+	(0, 0, 1, 'd', 0, 'daily_digest'),
+	(0, 0, 1, 'w', 0, 'weekly_digest'),
+	(0, 0, 1, 'd', 1, 'birthdayemails'),
+	(0, 120, 1, 'd', 0, 'paid_subscriptions');
+---#
+
+---# Adding the simple machines scheduled task.
+---{
+// Randomise the time.
+$randomTime = 82800 + rand(0, 86399);
+upgrade_query("
+	INSERT IGNORE INTO {$db_prefix}scheduled_tasks
+		(next_time, time_offset, time_regularity, time_unit, disabled, task)
+	VALUES
+		(0, {$randomTime}, 1, 'd', 0, 'fetchSMfiles')");
+---}
+---#
+
+---# Deleting old scheduled task items...
+DELETE FROM {$db_prefix}scheduled_tasks
+WHERE task = 'clean_cache';
+---#
+
+---# Moving auto optimise settings to scheduled task...
+---{
+if (!isset($modSettings['next_task_time']) && isset($modSettings['autoOptLastOpt']))
+{
+	// Try move over the regularity...
+	if (isset($modSettings['autoOptDatabase']))
+	{
+		$disabled = empty($modSettings['autoOptDatabase']) ? 1 : 0;
+		$regularity = $disabled ? 7 : $modSettings['autoOptDatabase'];
+		$next_time = $modSettings['autoOptLastOpt'] + 3600 * 24 * $modSettings['autoOptDatabase'];
+
+		// Update the task accordingly.
+		upgrade_query("
+			UPDATE {$db_prefix}scheduled_tasks
+			SET disabled = $disabled, time_regularity = $regularity, next_time = $next_time
+			WHERE task = 'auto_optimize'");
+	}
+
+	// Delete the old settings!
+	upgrade_query("
+		DELETE FROM {$db_prefix}settings
+		WHERE VARIABLE IN ('autoOptLastOpt', 'autoOptDatabase')");
+}
+---}
+---#
+
+---# Creating Scheduled Task Log Table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_scheduled_tasks (
+	id_log mediumint(8) NOT NULL auto_increment,
+	id_task smallint(5) NOT NULL default '0',
+	time_run int(10) NOT NULL default '0',
+	time_taken float NOT NULL default '0',
+	PRIMARY KEY (id_log)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Adding new scheduled task setting...
+---{
+if (!isset($modSettings['next_task_time']))
+{
+	upgrade_query("
+		INSERT INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('next_task_time', '0')");
+}
+---}
+---#
+
+---# Setting the birthday email template if not set...
+---{
+if (!isset($modSettings['birthday_email']))
+{
+	upgrade_query("
+		INSERT INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('birthday_email', 'happy_birthday')");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Adding permission profiles for boards.
+/******************************************************************************/
+
+---# Creating "permission_profiles" table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}permission_profiles (
+	id_profile smallint(5) NOT NULL auto_increment,
+	profile_name varchar(255) NOT NULL default '',
+	PRIMARY KEY (id_profile)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Adding profile columns to boards table...
+ALTER TABLE {$db_prefix}boards
+ADD id_profile smallint(5) unsigned NOT NULL default '1' AFTER member_groups;
+---#
+
+---# Adding profile columns to board permission table...
+ALTER TABLE {$db_prefix}board_permissions
+ADD id_profile smallint(5) unsigned NOT NULL default '1' AFTER id_group;
+
+ALTER TABLE {$db_prefix}board_permissions
+DROP PRIMARY KEY;
+
+ALTER TABLE {$db_prefix}board_permissions
+ADD PRIMARY KEY (id_group, id_profile, permission);
+---#
+
+---# Cleaning up some 2.0 Beta 1 permission profile bits...
+---{
+$request = upgrade_query("
+	SELECT id_profile
+	FROM {$db_prefix}permission_profiles
+	WHERE profile_name = ''");
+$profiles = array();
+while ($row = mysqli_fetch_assoc($request))
+	$profiles[] = $row['id_profile'];
+mysqli_free_result($request);
+
+if (!empty($profiles))
+{
+	$request = upgrade_query("
+		SELECT id_profile, name
+		FROM {$db_prefix}boards
+		WHERE id_profile IN (" . implode(',', $profiles) . ")");
+	$done_ids = array();
+	while ($row = mysqli_fetch_assoc($request))
+	{
+		if (isset($done_ids[$row['id_profile']]))
+			continue;
+		$done_ids[$row['id_profile']] = true;
+
+		$row['name'] = mysqli_real_escape_string($row['name']);
+
+		upgrade_query("
+			UPDATE {$db_prefix}permission_profiles
+			SET profile_name = '$row[name]'
+			WHERE id_profile = $row[id_profile]");
+	}
+	mysqli_free_result($request);
+}
+---}
+---#
+
+---# Migrating old board profiles to profile system
+---{
+
+// Doing this twice would be awful!
+$request = upgrade_query("
+	SELECT COUNT(*)
+	FROM {$db_prefix}permission_profiles");
+list ($profileCount) = mysqli_fetch_row($request);
+mysqli_free_result($request);
+
+if ($profileCount == 0)
+{
+	// Everything starts off invalid.
+	upgrade_query("
+		UPDATE {$db_prefix}board_permissions
+		SET id_profile = 0");
+
+	// Insert a boat load of default profile permissions.
+	upgrade_query("
+		INSERT INTO {$db_prefix}permission_profiles
+			(id_profile, profile_name)
+		VALUES
+			(1, 'default'),
+			(2, 'no_polls'),
+			(3, 'reply_only'),
+			(4, 'read_only')");
+
+	// Update the default permissions, this is easy!
+	upgrade_query("
+		UPDATE {$db_prefix}board_permissions
+		SET id_profile = 1
+		WHERE id_board = 0");
+
+	// Load all the other permissions
+	$request = upgrade_query("
+		SELECT id_board, id_group, permission, add_deny
+		FROM {$db_prefix}board_permissions
+		WHERE id_profile = 0");
+	$all_perms = array();
+	while ($row = mysqli_fetch_assoc($request))
+		$all_perms[$row['id_board']][$row['id_group']][$row['permission']] = $row['add_deny'];
+	mysqli_free_result($request);
+
+	// Now we have the profile profiles for this installation. We now need to go through each board and work out what the permission profile should be!
+	$request = upgrade_query("
+		SELECT id_board, name, permission_mode
+		FROM {$db_prefix}boards");
+	$board_updates = array();
+	while ($row = mysqli_fetch_assoc($request))
+	{
+		$row['name'] = addslashes($row['name']);
+
+		// Is it a truely local permission board? If so this is a new profile!
+		if ($row['permission_mode'] == 1)
+		{
+			// I know we could cache this, but I think we need to be practical - this is slow but guaranteed to work.
+			upgrade_query("
+				INSERT INTO {$db_prefix}permission_profiles
+					(profile_name)
+				VALUES
+					('$row[name]')");
+			$board_updates[mysqli_insert_id()][] = $row['id_board'];
+		}
+		// Otherwise, dear god, this is an old school "simple" permission...
+		elseif ($row['permission_mode'] > 1 && $row['permission_mode'] < 5)
+		{
+			$board_updates[$row['permission_mode']][] = $row['id_board'];
+		}
+		// Otherwise this is easy. It becomes default.
+		else
+			$board_updates[1][] = $row['id_board'];
+	}
+	mysqli_free_result($request);
+
+	// Update the board tables.
+	foreach ($board_updates as $profile => $boards)
+	{
+		if (empty($boards) || empty($profile))
+			continue;
+
+		$boards = implode(',', $boards);
+
+		upgrade_query("
+			UPDATE {$db_prefix}boards
+			SET id_profile = $profile
+			WHERE id_board IN ($boards)");
+
+		// If it's a custom profile then update this too.
+		if ($profile > 4)
+			upgrade_query("
+				UPDATE {$db_prefix}board_permissions
+				SET id_profile = $profile
+				WHERE id_board IN ($boards)
+					AND id_profile = 0");
+	}
+
+	// Just in case we have any random permissions that didn't have boards.
+	upgrade_query("
+		DELETE FROM {$db_prefix}board_permissions
+		WHERE id_profile = 0");
+}
+---}
+---#
+
+---# Removing old board permissions column...
+ALTER TABLE {$db_prefix}board_permissions
+DROP COLUMN id_board;
+---#
+
+---# Check the predefined profiles all have the right permissions.
+---{
+// What are all the permissions people can have.
+$mod_permissions = array(
+	'moderate_board', 'post_new', 'post_reply_own', 'post_reply_any', 'poll_post', 'poll_add_any',
+	'poll_remove_any', 'poll_view', 'poll_vote', 'poll_lock_any', 'poll_edit_any', 'report_any',
+	'lock_own', 'send_topic', 'mark_any_notify', 'mark_notify', 'delete_own', 'modify_own', 'make_sticky',
+	'lock_any', 'remove_any', 'move_any', 'merge_any', 'split_any', 'delete_any', 'modify_any', 'approve_posts',
+	'post_attachment', 'view_attachments', 'post_unapproved_replies_any', 'post_unapproved_replies_own',
+	'post_unapproved_attachments', 'post_unapproved_topics',
+);
+
+$no_poll_reg = array(
+	'post_new', 'post_reply_own', 'post_reply_any', 'poll_view', 'poll_vote', 'report_any',
+	'lock_own', 'send_topic', 'mark_any_notify', 'mark_notify', 'delete_own', 'modify_own',
+	'post_attachment', 'view_attachments', 'remove_own', 'post_unapproved_replies_any', 'post_unapproved_replies_own',
+	'post_unapproved_attachments', 'post_unapproved_topics',
+);
+
+$reply_only_reg = array(
+	'post_reply_own', 'post_reply_any', 'poll_view', 'poll_vote', 'report_any',
+	'lock_own', 'send_topic', 'mark_any_notify', 'mark_notify', 'delete_own', 'modify_own',
+	'post_attachment', 'view_attachments', 'remove_own', 'post_unapproved_replies_any', 'post_unapproved_replies_own',
+	'post_unapproved_attachments',
+);
+
+$read_only_reg = array(
+	'poll_view', 'poll_vote', 'report_any', 'send_topic', 'mark_any_notify', 'mark_notify', 'view_attachments',
+);
+
+// Clear all the current predefined profiles.
+upgrade_query("
+	DELETE FROM {$db_prefix}board_permissions
+	WHERE id_profile IN (2,3,4)");
+
+// Get all the membergroups - cheating to use the fact id_group = 1 exists to get a group of 0.
+$request = upgrade_query("
+	SELECT IF(id_group = 1, 0, id_group) AS id_group
+	FROM {$db_prefix}membergroups
+	WHERE id_group != 0
+		AND min_posts = -1");
+$inserts = array();
+while ($row = mysqli_fetch_assoc($request))
+{
+	if ($row['id_group'] == 2 || $row['id_group'] == 3)
+	{
+		foreach ($mod_permissions as $permission)
+		{
+			$inserts[] = "($row[id_group], 2, '$permission')";
+			$inserts[] = "($row[id_group], 3, '$permission')";
+			$inserts[] = "($row[id_group], 4, '$permission')";
+		}
+	}
+	else
+	{
+		foreach ($no_poll_reg as $permission)
+			$inserts[] = "($row[id_group], 2, '$permission')";
+		foreach ($reply_only_reg as $permission)
+			$inserts[] = "($row[id_group], 3, '$permission')";
+		foreach ($read_only_reg as $permission)
+			$inserts[] = "($row[id_group], 4, '$permission')";
+	}
+}
+mysqli_free_result($request);
+
+upgrade_query("
+	INSERT INTO {$db_prefix}board_permissions
+		(id_group, id_profile, permission)
+	VALUES (-1, 2, 'poll_view'),
+		(-1, 3, 'poll_view'),
+		(-1, 4, 'poll_view'),
+		" . implode(', ', $inserts));
+
+---}
+---#
+
+---# Adding inherited permissions...
+ALTER TABLE {$db_prefix}membergroups
+ADD id_parent smallint(5) NOT NULL default '-2';
+---#
+
+---# Make sure admins and moderators don't inherit...
+UPDATE {$db_prefix}membergroups
+SET id_parent = -2
+WHERE id_group = 1
+	OR id_group = 3;
+---#
+
+---# Deleting old permission settings...
+DELETE FROM {$db_prefix}settings
+WHERE VARIABLE IN ('permission_enable_by_board', 'autoOptDatabase');
+---#
+
+---# Removing old permission_mode column...
+ALTER TABLE {$db_prefix}boards
+DROP COLUMN permission_mode;
+---#
+
+/******************************************************************************/
+--- Adding Some Additional Functionality.
+/******************************************************************************/
+
+---# Adding column to hold the boards being ignored ...
+ALTER TABLE {$db_prefix}members
+ADD ignore_boards text NOT NULL;
+---#
+
+---# Purge flood control ...
+DELETE FROM {$db_prefix}log_floodcontrol;
+---#
+
+---# Adding advanced flood control ...
+ALTER TABLE {$db_prefix}log_floodcontrol
+ADD log_type varchar(8) NOT NULL default 'post';
+---#
+
+---# Sorting out flood control keys ...
+ALTER TABLE {$db_prefix}log_floodcontrol
+DROP PRIMARY KEY,
+ADD PRIMARY KEY (ip(16), log_type(8));
+---#
+
+---# Adding guest voting ...
+ALTER TABLE {$db_prefix}polls
+ADD guest_vote tinyint(3) NOT NULL default '0';
+
+DELETE FROM {$db_prefix}log_polls
+WHERE id_member < 0;
+
+ALTER TABLE {$db_prefix}log_polls
+DROP PRIMARY KEY;
+
+ALTER TABLE {$db_prefix}log_polls
+ADD INDEX id_poll (id_poll, id_member, id_choice);
+---#
+
+---# Implementing admin feature toggles.
+---{
+if (!isset($modSettings['admin_features']))
+{
+	// Work out what they used to have enabled.
+	$enabled_features = array('rg');
+	if (!empty($modSettings['cal_enabled']))
+		$enabled_features[] = 'cd';
+	if (!empty($modSettings['karmaMode']))
+		$enabled_features[] = 'k';
+	if (!empty($modSettings['modlog_enabled']))
+		$enabled_features[] = 'ml';
+	if (!empty($modSettings['paid_enabled']))
+		$enabled_features[] = 'ps';
+
+	$enabled_features = implode(',', $enabled_features);
+
+	upgrade_query("
+		INSERT INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('admin_features', '$enabled_features')");
+}
+---}
+---#
+
+---# Adding advanced password brute force protection to "members" table...
+ALTER TABLE {$db_prefix}members
+ADD passwd_flood varchar(12) NOT NULL default '';
+---#
+
+/******************************************************************************/
+--- Adding some columns to moderation log
+/******************************************************************************/
+---# Add the columns and the keys to log_actions ...
+ALTER TABLE {$db_prefix}log_actions
+ADD id_board smallint(5) unsigned NOT NULL default '0',
+ADD id_topic mediumint(8) unsigned NOT NULL default '0',
+ADD id_msg int(10) unsigned NOT NULL default '0',
+ADD KEY id_board (id_board),
+ADD KEY id_msg (id_msg);
+---#
+
+---# Add the user log...
+ALTER TABLE {$db_prefix}log_actions
+ADD id_log tinyint(3) unsigned NOT NULL default '1',
+ADD KEY id_log (id_log);
+---#
+
+---# Update the information already in log_actions
+---{
+$request = upgrade_query("
+	SELECT COUNT(*)
+	FROM {$db_prefix}log_actions");
+list($totalActions) = mysqli_fetch_row($request);
+mysqli_free_result($request);
+
+$_GET['m'] = !empty($_GET['m']) ? (int) $_GET['m'] : '0';
+$step_progress['total'] = $totalActions;
+$step_progress['current'] = $_GET['m'];
+
+while ($_GET['m'] < $totalActions)
+{
+	nextSubStep($substep);
+
+	$mrequest = upgrade_query("
+		SELECT id_action, extra, id_board, id_topic, id_msg
+		FROM {$db_prefix}log_actions
+		LIMIT $_GET[m], 500");
+
+	while ($row = mysqli_fetch_assoc($mrequest))
+	{
+		if (!empty($row['id_board']) || !empty($row['id_topic']) || !empty($row['id_msg']))
+			continue;
+		$row['extra'] = @unserialize($row['extra']);
+		// Corrupt?
+		$row['extra'] = is_array($row['extra']) ? $row['extra'] : array();
+		if (!empty($row['extra']['board']))
+		{
+			$board_id = (int) $row['extra']['board'];
+			unset($row['extra']['board']);
+		}
+		else
+			$board_id = '0';
+		if (!empty($row['extra']['board_to']) && empty($board_id))
+		{
+			$board_id = (int) $row['extra']['board_to'];
+			unset($row['extra']['board_to']);
+		}
+
+		if (!empty($row['extra']['topic']))
+		{
+			$topic_id = (int) $row['extra']['topic'];
+			unset($row['extra']['topic']);
+			if (empty($board_id))
+			{
+				$trequest = upgrade_query("
+					SELECT id_board
+					FROM {$db_prefix}topics
+					WHERE id_topic=$topic_id
+					LIMIT 1");
+				if (mysqli_num_rows($trequest))
+					list($board_id) = mysqli_fetch_row($trequest);
+				mysqli_free_result($trequest);
+			}
+		}
+		else
+			$topic_id = '0';
+
+		if(!empty($row['extra']['message']))
+		{
+			$msg_id = (int) $row['extra']['message'];
+			unset($row['extra']['message']);
+			if (empty($topic_id) || empty($board_id))
+			{
+				$trequest = upgrade_query("
+					SELECT id_board, id_topic
+					FROM {$db_prefix}messages
+					WHERE id_msg=$msg_id
+					LIMIT 1");
+				if (mysqli_num_rows($trequest))
+					list($board_id, $topic_id) = mysqli_fetch_row($trequest);
+				mysqli_free_result($trequest);
+			}
+		}
+		else
+			$msg_id = '0';
+		$row['extra'] = addslashes(serialize($row['extra']));
+		upgrade_query("UPDATE {$db_prefix}log_actions SET id_board=$board_id, id_topic=$topic_id, id_msg=$msg_id, extra='$row[extra]' WHERE id_action=$row[id_action]");
+	}
+	$_GET['m'] += 500;
+	$step_progress['current'] = $_GET['m'];
+}
+unset($_GET['m']);
+---}
+---#
+
+/******************************************************************************/
+--- Create a repository for the javascript files from Simple Machines...
+/******************************************************************************/
+
+---# Creating repository table ...
+CREATE TABLE IF NOT EXISTS {$db_prefix}admin_info_files (
+  id_file tinyint(4) unsigned NOT NULL auto_increment,
+  filename varchar(255) NOT NULL default '',
+  path varchar(255) NOT NULL default '',
+  parameters varchar(255) NOT NULL default '',
+  data text NOT NULL,
+  filetype varchar(255) NOT NULL default '',
+  PRIMARY KEY (id_file),
+  KEY filename (filename(30))
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Add in the files to get from Simple Machines...
+INSERT IGNORE INTO {$db_prefix}admin_info_files
+	(id_file, filename, path, parameters)
+VALUES
+	(1, 'current-version.js', '/smf/', 'version=%3$s'),
+	(2, 'detailed-version.js', '/smf/', 'language=%1$s&version=%3$s'),
+	(3, 'latest-news.js', '/smf/', 'language=%1$s&format=%2$s'),
+	(4, 'latest-packages.js', '/smf/', 'language=%1$s&version=%3$s'),
+	(5, 'latest-smileys.js', '/smf/', 'language=%1$s&version=%3$s'),
+	(6, 'latest-themes.js', '/smf/', 'language=%1$s&version=%3$s');
+---#
+
+---# Ensure that the table has the filetype column
+ALTER TABLE {$db_prefix}admin_info_files
+ADD filetype varchar(255) NOT NULL default '';
+---#
+
+---# Set the filetype for the files
+UPDATE {$db_prefix}admin_info_files
+SET filetype='text/javascript'
+WHERE id_file IN (1,2,3,4,5,6,7);
+---#
+
+---# Ensure that the files from Simple Machines get updated
+UPDATE {$db_prefix}scheduled_tasks
+SET next_time = UNIX_TIMESTAMP()
+WHERE id_task = 7
+LIMIT 1;
+---#
+
+/******************************************************************************/
+--- Adding new personal messaging functionality.
+/******************************************************************************/
+
+---# Adding personal message rules table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}pm_rules (
+	id_rule int(10) unsigned NOT NULL auto_increment,
+	id_member int(10) unsigned NOT NULL default '0',
+	rule_name varchar(60) NOT NULL,
+	criteria text NOT NULL,
+	actions text NOT NULL,
+	delete_pm tinyint(3) unsigned NOT NULL default '0',
+	is_or tinyint(3) unsigned NOT NULL default '0',
+	PRIMARY KEY (id_rule),
+	KEY id_member (id_member),
+	KEY delete_pm (delete_pm)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Adding new message status columns...
+ALTER TABLE {$db_prefix}members
+ADD COLUMN new_pm tinyint(3) NOT NULL default '0';
+
+ALTER TABLE {$db_prefix}members
+ADD COLUMN pm_prefs mediumint(8) NOT NULL default '0';
+
+ALTER TABLE {$db_prefix}pm_recipients
+ADD COLUMN is_new tinyint(3) NOT NULL default '0';
+---#
+
+---# Set the new status to be correct....
+---{
+// Don't do this twice!
+if (@$modSettings['smfVersion'] < '2.0')
+{
+	// Set all unread messages as new.
+	upgrade_query("
+		UPDATE {$db_prefix}pm_recipients
+		SET is_new = 1
+		WHERE is_read = 0");
+
+	// Also set members to have a new pm if they have any unread.
+	upgrade_query("
+		UPDATE {$db_prefix}members
+		SET new_pm = 1
+		WHERE unread_messages > 0");
+}
+---}
+---#
+
+---# Adding personal message tracking column...
+ALTER TABLE {$db_prefix}personal_messages
+ADD id_pm_head int(10) unsigned default '0' NOT NULL AFTER id_pm,
+ADD INDEX id_pm_head (id_pm_head);
+---#
+
+---# Adding personal message tracking column...
+UPDATE {$db_prefix}personal_messages
+SET id_pm_head = id_pm
+WHERE id_pm_head = 0;
+---#
+
+/******************************************************************************/
+--- Adding Open ID support.
+/******************************************************************************/
+
+---# Adding Open ID Association table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}openid_assoc (
+	server_url text NOT NULL,
+	handle varchar(255) NOT NULL default '',
+	secret text NOT NULL,
+	issued int(10) NOT NULL default '0',
+	expires int(10) NOT NULL default '0',
+	assoc_type varchar(64) NOT NULL,
+	PRIMARY KEY (server_url(125), handle(125)),
+	KEY expires (expires)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Adding column to hold Open ID URL...
+ALTER TABLE {$db_prefix}members
+ADD openid_uri text NOT NULL;
+---#
+
+/******************************************************************************/
+--- Adding paid subscriptions.
+/******************************************************************************/
+
+---# Creating subscriptions table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}subscriptions(
+	id_subscribe mediumint(8) unsigned NOT NULL auto_increment,
+	name varchar(60) NOT NULL default '',
+	description varchar(255) NOT NULL default '',
+	cost text NOT NULL,
+	length varchar(6) NOT NULL default '',
+	id_group smallint(5) NOT NULL default '0',
+	add_groups varchar(40) NOT NULL default '',
+	active tinyint(3) NOT NULL default '1',
+	repeatable tinyint(3) NOT NULL default '0',
+	allow_partial tinyint(3) NOT NULL default '0',
+	reminder tinyint(3) NOT NULL default '0',
+	email_complete text NOT NULL,
+	PRIMARY KEY (id_subscribe),
+	KEY active (active)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Creating log_subscribed table...
+CREATE TABLE IF NOT EXISTS {$db_prefix}log_subscribed(
+	id_sublog int(10) unsigned NOT NULL auto_increment,
+	id_subscribe mediumint(8) unsigned NOT NULL default '0',
+	id_member int(10) NOT NULL default '0',
+	old_id_group smallint(5) NOT NULL default '0',
+	start_time int(10) NOT NULL default '0',
+	end_time int(10) NOT NULL default '0',
+	status tinyint(3) NOT NULL default '0',
+	payments_pending tinyint(3) NOT NULL default '0',
+	pending_details text NOT NULL,
+	reminder_sent tinyint(3) NOT NULL default '0',
+	vendor_ref varchar(255) NOT NULL default '',
+	PRIMARY KEY (id_sublog),
+	UNIQUE KEY id_subscribe (id_subscribe, id_member),
+	KEY end_time (end_time),
+	KEY reminder_sent (reminder_sent),
+	KEY payments_pending (payments_pending),
+	KEY id_member (id_member)
+) ENGINE=MyISAM{$db_collation};
+---#
+
+---# Clean up any pre-2.0 mod settings.
+UPDATE {$db_prefix}settings
+SET variable = 'paid_currency_code'
+WHERE variable = 'currency_code';
+
+UPDATE {$db_prefix}settings
+SET variable = 'paid_currency_symbol'
+WHERE variable = 'currency_symbol';
+
+DELETE FROM {$db_prefix}settings
+WHERE variable = 'currency_code'
+	OR variable = 'currency_symbol';
+---#
+
+---# Clean up any pre-2.0 mod settings (part 2).
+---{
+$request = upgrade_query("
+	SHOW COLUMNS
+	FROM {$db_prefix}subscriptions");
+$new_cols = array('repeatable', 'reminder', 'email_complete', 'allow_partial');
+$new_cols = array_flip($new_cols);
+while ($request && $row = mysqli_fetch_row($request))
+{
+	$row[0] = strtolower($row[0]);
+	if (isset($new_cols[$row[0]]))
+		unset($new_cols[$row[0]]);
+}
+if ($request)
+	mysqli_free_result($request);
+
+if (isset($new_cols['repeatable']))
+	upgrade_query("
+		ALTER TABLE {$db_prefix}subscriptions
+		ADD COLUMN Repeatable tinyint(3) NOT NULL default '0'");
+if (isset($new_cols['reminder']))
+	upgrade_query("
+		ALTER TABLE {$db_prefix}subscriptions
+		ADD COLUMN reminder tinyint(3) NOT NULL default '0'");
+if (isset($new_cols['email_complete']))
+	upgrade_query("
+		ALTER TABLE {$db_prefix}subscriptions
+		ADD COLUMN email_complete text NOT NULL");
+if (isset($new_cols['allowpartial']))
+	upgrade_query("
+		ALTER TABLE {$db_prefix}subscriptions
+		ADD COLUMN allow_partial tinyint(3) NOT NULL default '0'");
+
+$request = upgrade_query("
+	SHOW COLUMNS
+	FROM {$db_prefix}log_subscribed");
+$new_cols = array('reminder_sent', 'vendor_ref', 'payments_pending', 'pending_details');
+$new_cols = array_flip($new_cols);
+while ($request && $row = mysqli_fetch_row($request))
+{
+	if (isset($new_cols[$row[0]]))
+		unset($new_cols[$row[0]]);
+}
+if ($request)
+	mysqli_free_result($request);
+
+if (isset($new_cols['reminder_sent']))
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_subscribed
+		ADD COLUMN reminder_sent tinyint(3) NOT NULL default '0'");
+if (isset($new_cols['vendor_ref']))
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_subscribed
+		ADD COLUMN vendor_ref varchar(255) NOT NULL default ''");
+if (isset($new_cols['payments_pending']))
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_subscribed
+		ADD COLUMN payments_pending tinyint(3) NOT NULL default '0'");
+if (isset($new_cols['pending_details']))
+{
+	upgrade_query("
+		UPDATE {$db_prefix}log_subscribed
+		SET status = 0
+		WHERE status = 1");
+	upgrade_query("
+		UPDATE {$db_prefix}log_subscribed
+		SET status = 1
+		WHERE status = 2");
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_subscribed
+		ADD COLUMN pending_details text NOT NULL");
+}
+---}
+---#
+
+---# Confirming paid subscription keys are in place ...
+ALTER TABLE {$db_prefix}log_subscribed
+ADD KEY reminder_sent (reminder_sent),
+ADD KEY end_time (end_time),
+ADD KEY payments_pending (payments_pending),
+ADD KEY status (status);
+---#
+
+/******************************************************************************/
+--- Adding weekly maintenance task.
+/******************************************************************************/
+
+---# Adding scheduled task...
+INSERT IGNORE INTO {$db_prefix}scheduled_tasks (next_time, time_offset, time_regularity, time_unit, disabled, task) VALUES (0, 0, 1, 'w', 0, 'weekly_maintenance');
+---#
+
+/******************************************************************************/
+--- Adding log pruning.
+/******************************************************************************/
+
+---# Adding pruning option...
+INSERT IGNORE INTO {$db_prefix}settings (variable, value) VALUES ('pruningOptions', '30,180,180,180,30,0');
+---#
+
+/******************************************************************************/
+--- Adding restore topic from recycle.
+/******************************************************************************/
+
+---# Adding restore from recycle feature...
+ALTER TABLE {$db_prefix}topics
+ADD COLUMN id_previous_board smallint(5) NOT NULL default '0',
+ADD COLUMN id_previous_topic mediumint(8) NOT NULL default '0';
+---#
+
+/******************************************************************************/
+--- Providing more room for apf options.
+/******************************************************************************/
+
+---# Changing field_options column to a larger field type...
+ALTER TABLE {$db_prefix}custom_fields
+CHANGE field_options field_options text NOT NULL;
+---#
+
+/******************************************************************************/
+--- Providing more room for ignoring boards.
+/******************************************************************************/
+
+---# Changing ignore_boards column to a larger field type...
+ALTER TABLE {$db_prefix}members
+CHANGE ignore_boards ignore_boards text NOT NULL;
+---#
+
+/******************************************************************************/
+--- Allow for longer calendar event/holiday titles.
+/******************************************************************************/
+
+---# Changing event title column to a larger field type...
+ALTER TABLE {$db_prefix}calendar
+CHANGE title title varchar(255) NOT NULL default '';
+---#
+
+---# Changing holidays title column to a larger field type...
+ALTER TABLE {$db_prefix}calendar_holidays
+CHANGE title title varchar(255) NOT NULL default '';
+---#
+
+/******************************************************************************/
+--- Adding extra columns to polls.
+/******************************************************************************/
+
+---# Adding reset poll timestamp and guest voters counter...
+ALTER TABLE {$db_prefix}polls
+ADD COLUMN reset_poll int(10) unsigned NOT NULL default '0' AFTER guest_vote,
+ADD COLUMN num_guest_voters int(10) unsigned NOT NULL default '0' AFTER guest_vote;
+---#
+
+---# Fixing guest voter tallys on existing polls...
+---{
+$request = upgrade_query("
+	SELECT p.id_poll, count(lp.id_member) as guest_voters
+	FROM {$db_prefix}polls AS p
+		LEFT JOIN {$db_prefix}log_polls AS lp ON (lp.id_poll = p.id_poll AND lp.id_member = 0)
+	WHERE lp.id_member = 0
+		AND p.num_guest_voters = 0
+	GROUP BY p.id_poll");
+
+while ($request && $row = $smcFunc['db_fetch_assoc']($request))
+	upgrade_query("
+		UPDATE {$db_prefix}polls
+		SET num_guest_voters = ". $row['guest_voters']. "
+		WHERE id_poll = " . $row['id_poll'] . "
+			AND num_guest_voters = 0");
+---}
+---#
+
+/******************************************************************************/
+--- Changing all tinytext columns to varchar(255).
+/******************************************************************************/
+
+---# Changing all tinytext columns to varchar(255)...
+---{
+// The array holding all the changes.
+$nameChanges = array(
+	'admin_info_files' => array(
+		'filename' => 'filename filename varchar(255) NOT NULL default \'\'',
+		'path' => 'path path varchar(255) NOT NULL default \'\'',
+		'parameters' => 'parameters parameters varchar(255) NOT NULL default \'\'',
+		'filetype' => 'filetype filetype varchar(255) NOT NULL default \'\'',
+	),
+	'attachments' => array(
+		'filename' => 'filename filename varchar(255) NOT NULL default \'\'',
+	),
+	'ban_groups' => array(
+		'reason' => 'reason reason varchar(255) NOT NULL default \'\'',
+	),
+	'ban_items' => array(
+		'hostname' => 'hostname hostname varchar(255) NOT NULL default \'\'',
+		'email_address' => 'email_address email_address varchar(255) NOT NULL default \'\'',
+	),
+	'boards' => array(
+		'name' => 'name name varchar(255) NOT NULL default \'\'',
+	),
+	'categories' => array(
+		'name' => 'name name varchar(255) NOT NULL default \'\'',
+	),
+	'custom_fields' => array(
+		'field_desc' => 'field_desc field_desc varchar(255) NOT NULL default \'\'',
+		'mask' => 'mask mask varchar(255) NOT NULL default \'\'',
+		'default_value' => 'default_value default_value varchar(255) NOT NULL default \'\'',
+	),
+	'log_banned' => array(
+		'email' => 'email email varchar(255) NOT NULL default \'\'',
+	),
+	'log_comments' => array(
+		'recipient_name' => 'recipient_name recipient_name varchar(255) NOT NULL default \'\'',
+	),
+	'log_errors' => array(
+		'file' => 'file file varchar(255) NOT NULL default \'\'',
+	),
+	'log_member_notices' => array(
+		'subject' => 'subject subject varchar(255) NOT NULL default \'\'',
+	),
+	'log_packages' => array(
+		'filename' => 'filename filename varchar(255) NOT NULL default \'\'',
+		'package_id' => 'package_id package_id varchar(255) NOT NULL default \'\'',
+		'name' => 'name name varchar(255) NOT NULL default \'\'',
+		'version' => 'version version varchar(255) NOT NULL default \'\'',
+		'member_installed' => 'member_installed member_installed varchar(255) NOT NULL default \'\'',
+		'member_removed' => 'member_removed member_removed varchar(255) NOT NULL default \'\'',
+		'themes_installed' => 'themes_installed themes_installed varchar(255) NOT NULL default \'\'',
+	),
+	'log_reported' => array(
+		'membername' => 'membername membername varchar(255) NOT NULL default \'\'',
+		'subject' => 'subject subject varchar(255) NOT NULL default \'\'',
+	),
+	'log_reported_comments' => array(
+		'membername' => 'membername membername varchar(255) NOT NULL default \'\'',
+		'comment' => 'comment comment varchar(255) NOT NULL default \'\'',
+	),
+	'log_spider_hits' => array(
+		'url' => 'url url varchar(255) NOT NULL default \'\'',
+	),
+	'log_subscribed' => array(
+		'vendor_ref' => 'vendor_ref vendor_ref varchar(255) NOT NULL default \'\'',
+	),
+	'mail_queue' => array(
+		'recipient' => 'recipient recipient varchar(255) NOT NULL default \'\'',
+		'subject' => 'subject subject varchar(255) NOT NULL default \'\'',
+	),
+	'membergroups' => array(
+		'stars' => 'stars stars varchar(255) NOT NULL default \'\'',
+	),
+	'members' => array(
+		'lngfile' => 'lngfile lngfile varchar(255) NOT NULL default \'\'',
+		'real_name' => 'real_name real_name varchar(255) NOT NULL default \'\'',
+		'pm_ignore_list' => 'pm_ignore_list pm_ignore_list varchar(255) NOT NULL default \'\'',
+		'email_address' => 'email_address email_address varchar(255) NOT NULL default \'\'',
+		'personal_text' => 'personal_text personal_text varchar(255) NOT NULL default \'\'',
+		'website_title' => 'website_title website_title varchar(255) NOT NULL default \'\'',
+		'website_url' => 'website_url website_url varchar(255) NOT NULL default \'\'',
+		'location' => 'location location varchar(255) NOT NULL default \'\'',
+		'icq' => 'icq icq varchar(255) NOT NULL default \'\'',
+		'aim' => 'aim aim varchar(255) NOT NULL default \'\'',
+		'msn' => 'msn msn varchar(255) NOT NULL default \'\'',
+		'avatar' => 'avatar avatar varchar(255) NOT NULL default \'\'',
+		'usertitle' => 'usertitle usertitle varchar(255) NOT NULL default \'\'',
+		'member_ip' => 'member_ip member_ip varchar(255) NOT NULL default \'\'',
+		'member_ip2' => 'member_ip2 member_ip2 varchar(255) NOT NULL default \'\'',
+		'secret_question' => 'secret_question secret_question varchar(255) NOT NULL default \'\'',
+		'additional_groups' => 'additional_groups additional_groups varchar(255) NOT NULL default \'\'',
+	),
+	'messages' => array(
+		'subject' => 'subject subject varchar(255) NOT NULL default \'\'',
+		'poster_name' => 'poster_name poster_name varchar(255) NOT NULL default \'\'',
+		'poster_email' => 'poster_email poster_email varchar(255) NOT NULL default \'\'',
+		'poster_ip' => 'poster_ip poster_ip varchar(255) NOT NULL default \'\'',
+		'modified_name' => 'modified_name modified_name varchar(255) NOT NULL default \'\'',
+	),
+	'openid_assoc' => array(
+		'handle' => 'handle handle varchar(255) NOT NULL default \'\'',
+	),
+	'package_servers' => array(
+		'name' => 'name name varchar(255) NOT NULL default \'\'',
+		'url' => 'url url varchar(255) NOT NULL default \'\'',
+	),
+	'permission_profiles' => array(
+		'profile_name' => 'profile_name profile_name varchar(255) NOT NULL default \'\'',
+	),
+	'personal_messages' => array(
+		'from_name' => 'from_name from_name varchar(255) NOT NULL default \'\'',
+		'subject' => 'subject subject varchar(255) NOT NULL default \'\'',
+	),
+	'polls' => array(
+		'question' => 'question question varchar(255) NOT NULL default \'\'',
+		'poster_name' => 'poster_name poster_name varchar(255) NOT NULL default \'\'',
+	),
+	'poll_choices' => array(
+		'label' => 'label label varchar(255) NOT NULL default \'\'',
+	),
+	'settings' => array(
+		'variable' => 'variable variable varchar(255) NOT NULL default \'\'',
+	),
+	'spiders' => array(
+		'spider_name' => 'spider_name spider_name varchar(255) NOT NULL default \'\'',
+		'user_agent' => 'user_agent user_agent varchar(255) NOT NULL default \'\'',
+		'ip_info' => 'ip_info ip_info varchar(255) NOT NULL default \'\'',
+	),
+	'subscriptions' => array(
+		'description' => 'description description varchar(255) NOT NULL default \'\'',
+	),
+	'themes' => array(
+		'variable' => 'variable variable varchar(255) NOT NULL default \'\'',
+	),
+);
+
+$_GET['ren_col'] = isset($_GET['ren_col']) ? (int) $_GET['ren_col'] : 0;
+$step_progress['name'] = 'Changing tinytext columns to varchar(255)';
+$step_progress['current'] = $_GET['ren_col'];
+$step_progress['total'] = count($nameChanges);
+
+$count = 0;
+// Now do every table...
+foreach ($nameChanges as $table_name => $table)
+{
+	// Already done this?
+	$count++;
+	if ($_GET['ren_col'] > $count)
+		continue;
+	$_GET['ren_col'] = $count;
+
+	// Check the table exists!
+	$request = upgrade_query("
+		SHOW TABLES
+		LIKE '{$db_prefix}$table_name'");
+	if (mysqli_num_rows($request) == 0)
+	{
+		mysqli_free_result($request);
+		continue;
+	}
+	mysqli_free_result($request);
+
+	// Converting is intensive, so make damn sure that we need to do it.
+	$request = upgrade_query("
+		SHOW FIELDS
+		FROM `{$db_prefix}$table_name`");
+	$tinytextColumns = array();
+	while($row = mysqli_fetch_assoc($request))
+	{
+		// Tinytext detected so store column name.
+		if ($row['Type'] == 'tinytext')
+			$tinytextColumns[$row['Field']] = $row['Field'];
+	}
+	mysqli_free_result($request);
+
+	// Check each column!
+	$actualChanges = array();
+	foreach ($table as $colname => $coldef)
+	{
+		// Column was not detected as tinytext so skip it
+		// Either it was already converted or was changed eg text (so do not break it)
+		if (!isset($tinytextColumns[$colname]))
+			continue;
+
+		$change = array(
+			'table' => $table_name,
+			'name' => $colname,
+			'type' => 'column',
+			'method' => 'change_remove',
+			'text' => 'CHANGE ' . $coldef,
+		);
+		if (protected_alter($change, $substep, true) == false)
+			$actualChanges[] = ' CHANGE COLUMN ' . $coldef;
+	}
+
+	// Do the query - if it needs doing.
+	if (!empty($actualChanges))
+	{
+		$change = array(
+			'table' => $table_name,
+			'name' => 'na',
+			'type' => 'table',
+			'method' => 'full_change',
+			'text' => implode(', ', $actualChanges),
+		);
+
+		// Here we go - hold on!
+		protected_alter($change, $substep);
+	}
+
+	// Update where we are!
+	$step_progress['current'] = $_GET['ren_col'];
+}
+
+// All done!
+unset($_GET['ren_col']);
+---}
+---#
+
+/******************************************************************************/
+--- Adding new personal message setting.
+/******************************************************************************/
+
+---# Adding column that stores the PM receiving setting...
+ALTER TABLE {$db_prefix}members
+ADD COLUMN pm_receive_from tinyint(4) unsigned NOT NULL default '1';
+---#
+
+---# Enable the buddy and ignore lists if we have not done so thus far...
+---{
+
+// Don't do this if we've done this already.
+if (empty($modSettings['dont_repeat_buddylists']))
+{
+	// Make sure the pm_receive_from column has the right default value - early adopters might have a '0' set here.
+	upgrade_query("
+		ALTER TABLE {$db_prefix}members
+		CHANGE pm_receive_from pm_receive_from tinyint(3) unsigned NOT NULL default '1'");
+
+	// Update previous ignore lists if they're set to ignore all.
+	upgrade_query("
+		UPDATE {$db_prefix}members
+		SET pm_receive_from = 3, pm_ignore_list = ''
+		WHERE pm_ignore_list = '*'");
+
+	// Ignore posts made by ignored users by default.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}themes
+			(id_member, id_theme, variable, value)
+		VALUES
+			(-1, 1, 'posts_apply_ignore_list', '1')");
+
+	// Enable buddy and ignore lists, and make sure not to skip this step next time we run this.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('enable_buddylist', '1'),
+			('dont_repeat_buddylists', '1')");
+}
+
+// And yet, and yet... We might have a small hiccup here...
+if (!empty($modSettings['dont_repeat_buddylists']) && !isset($modSettings['enable_buddylist']))
+{
+	// Correct RC3 adopters setting here...
+	if (isset($modSettings['enable_buddylists']))
+	{
+		upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('enable_buddylist', '" . $modSettings['enable_buddylists'] . "')");
+	}
+	else
+	{
+		// This should never happen :)
+		upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('enable_buddylist', '1')");
+	}
+}
+
+---}
+---#
+
+/******************************************************************************/
+--- Adding settings for attachments and avatars.
+/******************************************************************************/
+
+---# Add new security settings for attachments and avatars...
+---{
+
+// Don't do this if we've done this already.
+if (!isset($modSettings['attachment_image_reencode']))
+{
+	// Enable image re-encoding by default.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('attachment_image_reencode', '1')");
+}
+if (!isset($modSettings['attachment_image_paranoid']))
+{
+	// Disable draconic checks by default.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('attachment_image_paranoid', '0')");
+}
+if (!isset($modSettings['avatar_reencode']))
+{
+	// Enable image re-encoding by default.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('avatar_reencode', '1')");
+}
+if (!isset($modSettings['avatar_paranoid']))
+{
+	// Disable draconic checks by default.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('avatar_paranoid', '0')");
+}
+
+---}
+---#
+
+---# Add other attachment settings...
+---{
+if (!isset($modSettings['attachment_thumb_png']))
+{
+	// Make image attachment thumbnail as PNG by default.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('attachment_thumb_png', '1')");
+}
+
+---}
+---#
+
+/******************************************************************************/
+--- Cleaning up after old themes...
+/******************************************************************************/
+
+---# Checking for "babylon" and removing it if necessary...
+---{
+// Do they have "babylon" installed?
+if (file_exists($GLOBALS['boarddir'] . '/Themes/babylon'))
+{
+	$babylon_dir = $GLOBALS['boarddir'] . '/Themes/babylon';
+	$theme_request = $smcFunc['db_query']('', '
+		SELECT id_theme
+		FROM {db_prefix}themes
+		WHERE variable = {string:themedir}
+			AND value = {string:babylondir}',
+		array(
+			'themedir' => 'theme_dir',
+			'babylondir' => $babylon_dir,
+		)
+	);
+
+	// Don't do anything if this theme is already uninstalled
+	if ($smcFunc['db_num_rows']($theme_request) == 1)
+	{
+		$row = $smcFunc['db_fetch_row']($theme_request);
+		$id_theme = $row[0];
+		$smcFunc['db_free_result']($theme_request);
+		unset($row);
+
+		$known_themes = explode(',', $modSettings['knownThemes']);
+
+		// Remove this value...
+		$known_themes = array_diff($known_themes, array($id_theme));
+
+		// Change back to a string...
+		$known_themes = implode(',', $known_themes);
+
+		// Update the database
+		$smcFunc['db_insert']('replace',
+			'{db_prefix}settings',
+			array('variable' => 'string', 'value' => 'string'),
+			array('knownThemes', $known_themes),
+			array('variable')
+		);
+
+		// Delete any info about this theme
+		upgrade_query("
+			DELETE FROM {$db_prefix}themes
+			WHERE id_theme = $id_theme");
+
+		// Set any members or boards using this theme to the default
+		upgrade_query("
+			UPDATE {$db_prefix}members
+			SET id_theme = 0
+			WHERE id_theme = $id_theme");
+
+		upgrade_query("
+			UPDATE {$db_prefix}boards
+			SET id_theme = 0
+			WHERE id_theme = $id_theme");
+
+		if ($modSettings['theme_guests'] == $id_theme)
+		{
+			$smcFunc['db_insert']('replace',
+				'{db_prefix}settings',
+				array('variable' => 'string', 'value' => 'string'),
+				array('theme_guests', 0),
+				array('variable')
+			);
+		}
+	}
+}
+---}
+---#
+
+/******************************************************************************/
+--- Installing new smileys sets...
+/******************************************************************************/
+
+---# Installing new smiley sets...
+---{
+// Don't do this twice!
+if (empty($modSettings['dont_repeat_smileys_20']) && empty($modSettings['installed_new_smiley_sets_20']))
+{
+	// First, the entries.
+	upgrade_query("
+		UPDATE {$db_prefix}settings
+		SET value = CONCAT(value, ',aaron,akyhne')
+		WHERE variable = 'smiley_sets_known'");
+
+	// Second, the names.
+	upgrade_query("
+		UPDATE {$db_prefix}settings
+		SET value = CONCAT(value, '\nAaron\nAkyhne')
+		WHERE variable = 'smiley_sets_names'");
+
+	// This ain't running twice either.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('installed_new_smiley_sets_20', '1')");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Adding new indexes to the topics table.
+/******************************************************************************/
+
+---# Adding index member_started...
+ALTER TABLE {$db_prefix}topics
+ADD INDEX member_started (id_member_started, id_board);
+---#
+
+---# Adding index last_message_sticky...
+ALTER TABLE {$db_prefix}topics
+ADD INDEX last_message_sticky (id_board, is_sticky, id_last_msg);
+---#
+
+---# Adding index board_news...
+ALTER TABLE {$db_prefix}topics
+ADD INDEX board_news (id_board, id_first_msg);
+---#
+
+/******************************************************************************/
+--- Adding new indexes to members table.
+/******************************************************************************/
+
+---# Adding index on total_time_logged_in...
+ALTER TABLE {$db_prefix}members
+ADD INDEX total_time_logged_in (total_time_logged_in);
+---#
+
+---# Adding index on id_theme...
+ALTER TABLE {$db_prefix}members
+ADD INDEX id_theme (id_theme);
+---#
+
+---# Dropping index on real_name(30) ...
+---{
+// Detect existing index with limited length
+$request = upgrade_query("
+	SHOW INDEXES
+	FROM {$db_prefix}members"
+);
+
+// Drop the existing index before we recreate it.
+while ($row = mysqli_fetch_assoc($request))
+{
+	if ($row['Key_name'] === 'real_name' && $row['Sub_part'] == 30)
+	{
+		upgrade_query("
+			ALTER TABLE {$db_prefix}members
+			DROP INDEX real_name"
+		);
+		break;
+	}
+}
+
+mysqli_free_result($request);
+---}
+---#
+
+---# Adding index on real_name...
+ALTER TABLE {$db_prefix}members
+ADD INDEX real_name (real_name);
+---#
+
+---# Dropping index member_name(30)...
+---{
+// Detect existing index with limited length
+$request = upgrade_query("
+	SHOW INDEXES
+	FROM {$db_prefix}members"
+);
+
+// Drop the existing index before we recreate it.
+while ($row = mysqli_fetch_assoc($request))
+{
+	if ($row['Key_name'] === 'member_name' && $row['Sub_part'] == 30)
+	{
+		upgrade_query("
+			ALTER TABLE {$db_prefix}members
+			DROP INDEX member_name"
+		);
+		break;
+	}
+}
+
+mysqli_free_result($request);
+
+---}
+---#
+
+---# Adding index on member_name...
+ALTER TABLE {$db_prefix}members
+ADD INDEX member_name (member_name);
+---#
+
+/******************************************************************************/
+--- Adding new indexes to messages table.
+/******************************************************************************/
+
+---# Adding index id_member_msg...
+ALTER TABLE {$db_prefix}messages
+ADD INDEX id_member_msg (id_member, approved, id_msg);
+---#
+
+---# Adding index current_topic...
+ALTER TABLE {$db_prefix}messages
+ADD INDEX current_topic (id_topic, id_msg, id_member, approved);
+---#
+
+---# Adding index related_ip...
+ALTER TABLE {$db_prefix}messages
+ADD INDEX related_ip (id_member, poster_ip, id_msg);
+---#
+
+/******************************************************************************/
+--- Adding new indexes to attachments table.
+/******************************************************************************/
+
+---# Adding index on attachment_type...
+ALTER TABLE {$db_prefix}attachments
+ADD INDEX attachment_type (attachment_type);
+---#
+
+/******************************************************************************/
+--- Dropping unnecessary indexes...
+/******************************************************************************/
+
+---# Removing index on hits...
+ALTER TABLE {$db_prefix}log_activity
+DROP INDEX hits;
+---#
+
+/******************************************************************************/
+--- Adding extra columns to reported post comments
+/******************************************************************************/
+
+---# Adding email address and member ip columns...
+ALTER TABLE {$db_prefix}log_reported_comments
+ADD COLUMN member_ip varchar(255) NOT NULL default '' AFTER membername,
+ADD COLUMN email_address varchar(255) NOT NULL default '' AFTER membername;
+---#
+
+/******************************************************************************/
+--- Adjusting group types.
+/******************************************************************************/
+
+---# Changing the group type for Administrator group.
+UPDATE {$db_prefix}membergroups
+SET group_type = 1
+WHERE id_group = 1;
+---#
+
+/******************************************************************************/
+--- Fixing old policy acceptance records...
+/******************************************************************************/
+
+---# Fixing missing values in log_actions
+---{
+// Find the missing id_members
+$request = upgrade_query("
+	SELECT id_action, extra
+		FROM {$db_prefix}log_actions
+		WHERE id_member = 0
+		AND action IN ('policy_accepted', 'agreement_accepted')");
+
+// Fortunately they're in the extra field
+while ($row = $smcFunc['db_fetch_assoc']($request))
+{
+	$extra = @unserialize($row['extra']);
+	if ($extra === false)
+		continue;
+	if (!empty($extra['applicator']))
+	{
+		upgrade_query("
+			UPDATE {$db_prefix}log_actions
+				SET id_member = " . $extra['applicator'] . "
+				WHERE id_action = " . $row['id_action']);
+	}
+}
+
+---}
+---#
+
+/******************************************************************************/
+--- Final clean up...
+/******************************************************************************/
+
+---# Sorting the boards...
+ALTER TABLE {$db_prefix}categories
+ORDER BY cat_order;
+
+ALTER TABLE {$db_prefix}boards
+ORDER BY board_order;
+---#
diff --git a/upgrade_2-0_postgresql.sql b/upgrade_2-0_postgresql.sql
new file mode 100644
index 0000000..77a6a2e
--- /dev/null
+++ b/upgrade_2-0_postgresql.sql
@@ -0,0 +1,1319 @@
+/* ATTENTION: You don't need to run or use this file!  The upgrade.php script does everything for you! */
+
+/******************************************************************************/
+--- Adding Open ID support.
+/******************************************************************************/
+
+---# Adding Open ID Association table...
+CREATE TABLE {$db_prefix}openid_assoc (
+	server_url text NOT NULL,
+	handle varchar(255) NOT NULL,
+	secret text NOT NULL,
+	issued int NOT NULL,
+	expires int NOT NULL,
+	assoc_type varchar(64) NOT NULL,
+	PRIMARY KEY (server_url, handle)
+);
+---#
+
+/******************************************************************************/
+--- Updating custom fields.
+/******************************************************************************/
+
+---# Adding search ability to custom fields.
+---{
+if ($smcFunc['db_server_info'] < 8.0)
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}custom_fields
+		ADD COLUMN can_search smallint");
+
+	upgrade_query("
+		UPDATE {$db_prefix}custom_fields
+		SET can_search = 0");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}custom_fields
+		ALTER COLUMN can_search SET NOT NULL");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}custom_fields
+		ALTER COLUMN can_search SET default '0'");
+}
+else
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}custom_fields
+		ADD COLUMN can_search smallint NOT NULL default '0'");
+}
+---}
+---#
+
+---# Enhancing privacy settings for custom fields.
+---{
+if (isset($modSettings['smfVersion']) && $modSettings['smfVersion'] <= '2.0 Beta 1')
+{
+upgrade_query("
+	UPDATE {$db_prefix}custom_fields
+	SET private = 2
+	WHERE private = 1");
+}
+if (isset($modSettings['smfVersion']) && $modSettings['smfVersion'] < '2.0 Beta 4')
+{
+upgrade_query("
+	UPDATE {$db_prefix}custom_fields
+	SET private = 3
+	WHERE private = 2");
+}
+---}
+---#
+
+---# Changing default_values column to a larger field type...
+ALTER TABLE {$db_prefix}custom_fields
+ALTER COLUMN default_value TYPE varchar(255);
+---#
+
+---# Adding new custom fields columns.
+ALTER TABLE {$db_prefix}custom_fields
+ADD enclose text NOT NULL;
+
+ALTER TABLE {$db_prefix}custom_fields
+ADD placement smallint NOT NULL default '0';
+---#
+
+---# Fixing default value for the "show_profile" column
+ALTER TABLE {$db_prefix}custom_fields
+ALTER COLUMN show_profile SET DEFAULT 'forumprofile';
+
+UPDATE {$db_prefix}custom_fields
+SET show_profile='forumprofile' WHERE show_profile='forumProfile';
+---#
+
+/******************************************************************************/
+--- Adding new board specific features.
+/******************************************************************************/
+
+---# Implementing board redirects.
+---{
+if ($db_type == 'postgresql' && $smcFunc['db_server_info'] < 8.0)
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}boards
+		ADD COLUMN redirect varchar(255)");
+
+	upgrade_query("
+		UPDATE {$db_prefix}boards
+		SET redirect = ''");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}boards
+		ALTER COLUMN redirect SET NOT NULL");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}boards
+		ALTER COLUMN redirect SET default ''");
+}
+else
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}boards
+		ADD COLUMN redirect varchar(255) NOT NULL DEFAULT ''");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Adding search engine tracking.
+/******************************************************************************/
+
+---# Creating spider sequence.
+CREATE SEQUENCE {$db_prefix}spiders_seq;
+---#
+
+---# Creating spider table.
+CREATE TABLE {$db_prefix}spiders (
+	id_spider smallint NOT NULL default nextval('{$db_prefix}spiders_seq'),
+	spider_name varchar(255) NOT NULL,
+	user_agent varchar(255) NOT NULL,
+	ip_info varchar(255) NOT NULL,
+	PRIMARY KEY (id_spider)
+);
+
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (1, 'Google', 'googlebot', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (2, 'Yahoo!', 'slurp', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (3, 'MSN', 'msnbot', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (4, 'Google (Mobile)', 'Googlebot-Mobile', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (5, 'Google (Image)', 'Googlebot-Image', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (6, 'Google (AdSense)', 'Mediapartners-Google', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (7, 'Google (Adwords)', 'AdsBot-Google', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (8, 'Yahoo! (Mobile)', 'YahooSeeker/M1A1-R2D2', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (9, 'Yahoo! (Image)', 'Yahoo-MMCrawler', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (10, 'MSN (Mobile)', 'MSNBOT_Mobile', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (11, 'MSN (Media)', 'msnbot-media', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (12, 'Cuil', 'twiceler', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (13, 'Ask', 'Teoma', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (14, 'Baidu', 'Baiduspider', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (15, 'Gigablast', 'Gigabot', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (16, 'InternetArchive', 'ia_archiver-web.archive.org', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (17, 'Alexa', 'ia_archiver', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (18, 'Omgili', 'omgilibot', '');
+INSERT INTO {$db_prefix}spiders	(id_spider, spider_name, user_agent, ip_info) VALUES (19, 'EntireWeb', 'Speedy Spider', '');
+---#
+
+---# Removing a spider.
+---{
+	upgrade_query("
+		DELETE FROM {$db_prefix}spiders
+		WHERE user_agent = 'yahoo'
+			AND spider_name = 'Yahoo! (Publisher)'
+	");
+---}
+---#
+
+---# Sequence for table log_spider_hits.
+CREATE SEQUENCE {$db_prefix}log_spider_hits_seq;
+---#
+
+---# Creating spider hit tracking table.
+CREATE TABLE {$db_prefix}log_spider_hits (
+	id_hit int default nextval('{$db_prefix}log_spider_hits_seq'),
+	id_spider smallint NOT NULL default '0',
+	log_time int NOT NULL,
+	url varchar(255) NOT NULL,
+	processed smallint NOT NULL default '0'
+);
+
+CREATE INDEX {$db_prefix}log_spider_hits_id_spider ON {$db_prefix}log_spider_hits (id_spider);
+CREATE INDEX {$db_prefix}log_spider_hits_log_time ON {$db_prefix}log_spider_hits (log_time);
+CREATE INDEX {$db_prefix}log_spider_hits_processed ON {$db_prefix}log_spider_hits (processed);
+---#
+
+---# Creating spider statistic table.
+CREATE TABLE {$db_prefix}log_spider_stats (
+  id_spider smallint NOT NULL default '0',
+  page_hits smallint NOT NULL default '0',
+  last_seen int NOT NULL default '0',
+  stat_date date NOT NULL default '0001-01-01',
+  PRIMARY KEY (stat_date, id_spider)
+);
+---#
+
+/******************************************************************************/
+--- Adding new forum settings.
+/******************************************************************************/
+
+---# GDPR compliance settings.
+---{
+if (!isset($modSettings['requirePolicyAgreement']))
+{
+    upgrade_query("
+        INSERT INTO {$db_prefix}settings
+            (variable, value)
+        VALUES ('requirePolicyAgreement', '0')");
+}
+---}
+---#
+
+---# Enable cache if upgrading from 2.0 beta 1 and lower.
+---{
+if (isset($modSettings['smfVersion']) && $modSettings['smfVersion'] <= '2.0 Beta 1')
+{
+	$request = upgrade_query("
+		SELECT value
+		FROM {$db_prefix}settings
+		WHERE variable = 'cache_enable'");
+	list ($cache_enable) = $smcFunc['db_fetch_row']($request);
+
+	// No cache before
+	if ($smcFunc['db_num_rows']($request) == 0)
+		upgrade_query("
+			INSERT INTO {$db_prefix}settings
+				(variable, value)
+			VALUES ('cache_enable', '1')");
+	elseif (empty($cache_enable))
+		upgrade_query("
+			UPDATE {$db_prefix}settings
+			SET value = '1'
+			WHERE variable = 'cache_enable'");
+}
+---}
+---#
+
+---# Ensuring forum width setting present...
+---{
+// Don't do this twice!
+$smcFunc['db_insert']('ignore',
+	'{db_prefix}themes',
+	array('id_theme' => 'int', 'variable' => 'string-255', 'value' => 'string-255'),
+	array(1, 'forum_width', '90%'),
+	array('id_theme', 'variable', 'value')
+);
+---}
+---#
+
+/******************************************************************************/
+--- Adding misc functionality.
+/******************************************************************************/
+
+---# Converting "log_online".
+ALTER TABLE {$db_prefix}log_online DROP CONSTRAINT {$db_prefix}log_online_log_time;
+ALTER TABLE {$db_prefix}log_online DROP CONSTRAINT {$db_prefix}log_online_id_member;
+DROP TABLE {$db_prefix}log_online;
+CREATE TABLE {$db_prefix}log_online (
+  session varchar(32) NOT NULL default '',
+  log_time int NOT NULL default '0',
+  id_member int NOT NULL default '0',
+  id_spider smallint NOT NULL default '0',
+  ip int NOT NULL default '0',
+  url text NOT NULL,
+  PRIMARY KEY (session)
+);
+CREATE INDEX {$db_prefix}log_online_log_time ON {$db_prefix}log_online (log_time);
+CREATE INDEX {$db_prefix}log_online_id_member ON {$db_prefix}log_online (id_member);
+---#
+
+---# Adding guest voting - part 1...
+---{
+if ($smcFunc['db_server_info'] < 8.0)
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}polls
+		ADD COLUMN guest_vote smallint");
+
+	upgrade_query("
+		UPDATE {$db_prefix}polls
+		SET guest_vote = 0");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}polls
+		ALTER COLUMN guest_vote SET NOT NULL");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}polls
+		ALTER COLUMN guest_vote SET default '0'");
+}
+else
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}polls
+		ADD COLUMN guest_vote smallint NOT NULL default '0'");
+}
+---}
+---#
+
+---# Adding guest voting - part 2...
+DELETE FROM {$db_prefix}log_polls
+WHERE id_member < 0;
+
+ALTER TABLE {$db_prefix}log_polls DROP CONSTRAINT {$db_prefix}log_polls_pkey;
+
+CREATE INDEX {$db_prefix}log_polls_id_poll ON {$db_prefix}log_polls (id_poll, id_member, id_choice);
+---#
+
+---# Adding admin log...
+---{
+if ($db_type == 'postgresql' && $smcFunc['db_server_info'] < 8.0)
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_actions
+		ADD COLUMN id_log smallint");
+
+	upgrade_query("
+		UPDATE {$db_prefix}log_actions
+		SET id_log = 1");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_actions
+		ALTER COLUMN id_log SET NOT NULL");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_actions
+		ALTER COLUMN id_log SET default '1'");
+}
+else
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_actions
+		ADD COLUMN id_log smallint NOT NULL default '1'");
+}
+---}
+---#
+
+---# Adding search ability to custom fields.
+---{
+if ($smcFunc['db_server_info'] < 8.0)
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}members
+		ADD COLUMN passwd_flood varchar(12)");
+
+	upgrade_query("
+		UPDATE {$db_prefix}members
+		SET passwd_flood = ''");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}members
+		ALTER COLUMN passwd_flood SET NOT NULL");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}members
+		ALTER COLUMN passwd_flood SET default ''");
+}
+else
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}members
+		ADD COLUMN passwd_flood varchar(12) NOT NULL default ''");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Adding weekly maintenance task.
+/******************************************************************************/
+
+---# Adding weekly maintenance task...
+INSERT INTO {$db_prefix}scheduled_tasks (next_time, time_offset, time_regularity, time_unit, disabled, task) VALUES (0, 0, 1, 'w', 0, 'weekly_maintenance');
+---#
+
+---# Setting the birthday email template if not set...
+---{
+if (!isset($modSettings['birthday_email']))
+{
+	upgrade_query("
+		INSERT INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('birthday_email', 'happy_birthday')");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Adding log pruning.
+/******************************************************************************/
+
+---# Adding pruning option...
+INSERT INTO {$db_prefix}settings (variable, value) VALUES ('pruningOptions', '30,180,180,180,30');
+---#
+
+/******************************************************************************/
+--- Updating mail queue functionality.
+/******************************************************************************/
+
+---# Adding private to mail queue...
+---{
+if ($smcFunc['db_server_info'] < 8.0)
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}mail_queue
+		ADD COLUMN private smallint");
+
+	upgrade_query("
+		UPDATE {$db_prefix}mail_queue
+		SET private = 0");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}mail_queue
+		ALTER COLUMN private SET NOT NULL");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}mail_queue
+		ALTER COLUMN private SET default '0'");
+}
+else
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}mail_queue
+		ADD COLUMN private smallint NOT NULL default '0'");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Updating attachments.
+/******************************************************************************/
+
+---# Adding multiple attachment path functionality.
+---{
+if ($smcFunc['db_server_info'] < 8.0)
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}attachments
+		ADD COLUMN id_folder smallint");
+
+	upgrade_query("
+		UPDATE {$db_prefix}attachments
+		SET id_folder = 1");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}attachments
+		ALTER COLUMN id_folder SET NOT NULL");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}attachments
+		ALTER COLUMN id_folder SET default '1'");
+}
+else
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}attachments
+		ADD COLUMN id_folder smallint NOT NULL default '1'");
+}
+---}
+---#
+
+---# Adding file hash.
+---{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}attachments
+		ADD COLUMN file_hash varchar(40) NOT NULL default ''");
+---}
+---#
+
+/******************************************************************************/
+--- Adding restore topic from recycle.
+/******************************************************************************/
+
+---# Adding restore topic from recycle feature...
+---{
+if ($db_type == 'postgresql' && $smcFunc['db_server_info'] < 8.0)
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}topics
+		ADD COLUMN id_previous_board smallint");
+	upgrade_query("
+		ALTER TABLE {$db_prefix}topics
+		ADD COLUMN id_previous_topic int");
+
+	upgrade_query("
+		UPDATE {$db_prefix}topics
+		SET
+			id_previous_board = 0,
+			id_previous_topic = 0");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}topics
+		ALTER COLUMN id_previous_board SET NOT NULL");
+	upgrade_query("
+		ALTER TABLE {$db_prefix}topics
+		ALTER COLUMN id_previous_topic SET NOT NULL");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}topics
+		ALTER COLUMN id_previous_board SET default '0'");
+	upgrade_query("
+		ALTER TABLE {$db_prefix}topics
+		ALTER COLUMN id_previous_topic SET default '0'");
+}
+else
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}topics
+		ADD COLUMN id_previous_board smallint NOT NULL default '0'");
+	upgrade_query("
+		ALTER TABLE {$db_prefix}topics
+		ADD COLUMN id_previous_topic int NOT NULL default '0'");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Making changes to the package manager.
+/******************************************************************************/
+
+---# Changing URL to SMF package server...
+UPDATE {$db_prefix}package_servers
+SET url = 'https://custom.simplemachines.org/packages/mods'
+WHERE
+	url = 'http://mods.simplemachines.org'
+	OR url = 'http://custom.simplemachines.org/packages/mods';
+---#
+
+/******************************************************************************/
+--- Adding new indexes to the topics table.
+/******************************************************************************/
+
+---# Adding index member_started...
+CREATE INDEX {$db_prefix}topics_member_started ON {$db_prefix}topics (id_member_started, id_board);
+---#
+
+---# Adding index last_message_sticky...
+CREATE INDEX {$db_prefix}topics_last_message_sticky ON {$db_prefix}topics (id_board, is_sticky, id_last_msg);
+---#
+
+---# Adding index board_news...
+CREATE INDEX {$db_prefix}topics_board_news ON {$db_prefix}topics (id_board, id_first_msg);
+---#
+
+/******************************************************************************/
+--- Adding new indexes to members table.
+/******************************************************************************/
+
+---# Adding index on total_time_logged_in...
+CREATE INDEX {$db_prefix}members_total_time_logged_in ON {$db_prefix}members (total_time_logged_in);
+---#
+
+---# Adding index on id_theme...
+CREATE INDEX {$db_prefix}members_id_theme ON {$db_prefix}members (id_theme);
+---#
+
+---# Adding index on real_name...
+CREATE INDEX {$db_prefix}members_real_name ON {$db_prefix}members (real_name);
+---#
+
+/******************************************************************************/
+--- Adding new indexes to messages table.
+/******************************************************************************/
+
+---# Adding index id_member_msg...
+CREATE INDEX {$db_prefix}messages_id_member_msg ON {$db_prefix}messages (id_member, approved, id_msg);
+---#
+
+---# Adding index current_topic...
+CREATE INDEX {$db_prefix}messages_current_topic ON {$db_prefix}messages (id_topic, id_msg, id_member, approved);
+---#
+
+---# Adding index related_ip...
+CREATE INDEX {$db_prefix}messages_related_ip ON {$db_prefix}messages (id_member, poster_ip, id_msg);
+---#
+
+/******************************************************************************/
+--- Adding new indexes to attachments table.
+/******************************************************************************/
+
+---# Adding index on attachment_type...
+CREATE INDEX {$db_prefix}attachments_attachment_type ON {$db_prefix}attachments (attachment_type);
+---#
+
+/******************************************************************************/
+--- Providing more room for ignoring boards.
+/******************************************************************************/
+
+---# Changing ignore_boards column to a larger field type...
+ALTER TABLE {$db_prefix}members
+ALTER COLUMN ignore_boards TYPE text;
+---#
+
+/******************************************************************************/
+--- Adding default values to a couple of columns in log_subscribed
+/******************************************************************************/
+
+---# Adding default value for pending_details column
+ALTER TABLE {$db_prefix}log_subscribed
+ALTER COLUMN pending_details
+SET DEFAULT '';
+---#
+
+---# Adding default value for vendor_ref column
+ALTER TABLE {$db_prefix}log_subscribed
+ALTER COLUMN vendor_ref
+SET DEFAULT '';
+---#
+
+/*****************************************************************************/
+--- Fixing aim on members for longer nicks.
+/*****************************************************************************/
+
+---# Changing 'aim' to varchar to allow using email...
+ALTER TABLE {$db_prefix}members
+ALTER COLUMN aim TYPE varchar(255);
+
+ALTER TABLE {$db_prefix}members
+ALTER COLUMN aim SET DEFAULT '';
+---#
+
+/*****************************************************************************/
+--- Fixing column types in log_errors
+/*****************************************************************************/
+
+---# Changing 'ip' from char to varchar
+ALTER TABLE {$db_prefix}log_errors
+ALTER COLUMN ip TYPE varchar(16);
+
+ALTER TABLE {$db_prefix}log_errors
+ALTER COLUMN ip SET DEFAULT '';
+---#
+
+---# Changing 'error_type' from char to varchar
+ALTER TABLE {$db_prefix}log_errors
+ALTER COLUMN error_type TYPE varchar(15);
+---#
+
+/******************************************************************************/
+--- Allow for longer calendar event/holiday titles.
+/******************************************************************************/
+
+---# Changing event title column to a larger field type...
+ALTER TABLE {$db_prefix}calendar
+ALTER COLUMN title TYPE varchar(255);
+---#
+
+---# Changing holiday title column to a larger field type...
+ALTER TABLE {$db_prefix}calendar_holidays
+ALTER COLUMN title TYPE varchar(255);
+---#
+
+/******************************************************************************/
+--- Providing more room for apf options.
+/******************************************************************************/
+
+---# Changing field_options column to a larger field type...
+ALTER TABLE {$db_prefix}custom_fields
+ALTER COLUMN field_options TYPE text;
+---#
+
+/******************************************************************************/
+--- Adding extra columns to polls.
+/******************************************************************************/
+
+---# Adding reset poll timestamp and guest voters counter.
+---{
+if ($smcFunc['db_server_info'] < 8.0)
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}polls
+		ADD COLUMN reset_poll int");
+
+	upgrade_query("
+		UPDATE {$db_prefix}polls
+		SET reset_poll = '0'
+		WHERE reset_poll < 1");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}polls
+		ALTER COLUMN reset_poll SET NOT NULL");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}polls
+		ALTER COLUMN reset_poll SET default '0'");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}polls
+		ADD COLUMN num_guest_voters int");
+
+	upgrade_query("
+		UPDATE {$db_prefix}polls
+		SET num_guest_voters = '0'
+		WHERE num_guest_voters < 1");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}polls
+		ALTER COLUMN num_guest_voters SET NOT NULL");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}polls
+		ALTER COLUMN num_guest_voters SET default '0'");
+}
+else
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}polls
+		ADD COLUMN reset_poll int NOT NULL default '0'");
+	upgrade_query("
+		ALTER TABLE {$db_prefix}polls
+		ADD COLUMN num_guest_voters int NOT NULL default '0'");
+}
+---}
+---#
+
+---# Fixing guest voter tallys on existing polls...
+---{
+$request = upgrade_query("
+	SELECT p.id_poll, count(lp.id_member) as guest_voters
+	FROM {$db_prefix}polls AS p
+		LEFT JOIN {$db_prefix}log_polls AS lp ON (lp.id_poll = p.id_poll AND lp.id_member = 0)
+	WHERE lp.id_member = 0
+		AND p.num_guest_voters = 0
+	GROUP BY p.id_poll");
+
+while ($request && $row = $smcFunc['db_fetch_assoc']($request))
+	upgrade_query("
+		UPDATE {$db_prefix}polls
+		SET num_guest_voters = ". $row['guest_voters']. "
+		WHERE id_poll = " . $row['id_poll'] . "
+			AND num_guest_voters = 0");
+---}
+---#
+
+/*****************************************************************************/
+--- Fixing a bug with the inet_aton() function.
+/*****************************************************************************/
+
+---# Changing inet_aton function to use bigint instead of int...
+CREATE OR REPLACE FUNCTION INET_ATON(text) RETURNS bigint AS
+  'SELECT
+	CASE WHEN
+		$1 !~ ''^[0-9]?[0-9]?[0-9]?\.[0-9]?[0-9]?[0-9]?\.[0-9]?[0-9]?[0-9]?\.[0-9]?[0-9]?[0-9]?$'' THEN 0
+	ELSE
+		split_part($1, ''.'', 1)::int8 * (256 * 256 * 256) +
+		split_part($1, ''.'', 2)::int8 * (256 * 256) +
+		split_part($1, ''.'', 3)::int8 * 256 +
+		split_part($1, ''.'', 4)::int8
+	END AS result'
+LANGUAGE 'sql';
+---#
+
+/*****************************************************************************/
+--- Making additional changes to handle results from fixed inet_aton().
+/*****************************************************************************/
+
+---# Adding an IFNULL to handle 8-bit integers returned by inet_aton
+CREATE OR REPLACE FUNCTION IFNULL(int8, int8) RETURNS int8 AS
+  'SELECT COALESCE($1, $2) AS result'
+LANGUAGE 'sql';
+---#
+
+---# Changing ip column in log_online to int8
+ALTER TABLE {$db_prefix}log_online
+ALTER COLUMN ip TYPE int8;
+---#
+
+/******************************************************************************/
+--- Dropping unnecessary indexes...
+/******************************************************************************/
+
+---# Removing index on hits...
+---{
+$smcFunc['db_remove_index']($db_prefix . 'log_activity', $db_prefix . 'log_activity_hits');
+---}
+---#
+
+
+/******************************************************************************/
+--- Adding new personal message setting.
+/******************************************************************************/
+
+---# Adding column that stores the PM receiving setting...
+---{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}members
+		ADD COLUMN pm_receive_from smallint NOT NULL default '1'");
+---}
+---#
+
+---# Enable the buddy and ignore lists if we have not done so thus far...
+---{
+
+// Don't do this if we've done this already.
+if (empty($modSettings['dont_repeat_buddylists']))
+{
+	// Make sure the pm_receive_from column has the right default value - early adoptors might have a '0' set here.
+	upgrade_query("
+		ALTER TABLE {$db_prefix}members
+		ALTER COLUMN pm_receive_from SET DEFAULT '1'");
+
+	// Update previous ignore lists if they're set to ignore all.
+	upgrade_query("
+		UPDATE {$db_prefix}members
+		SET pm_receive_from = 3, pm_ignore_list = ''
+		WHERE pm_ignore_list = '*'");
+
+	// Enable buddy and ignore lists.
+	$smcFunc['db_insert']('replace',
+		'{db_prefix}settings',
+		array('variable' => 'string-255', 'value' => 'string-255'),
+		array('enable_buddylist', '1'),
+		array('variable', 'value')
+	);
+
+	// Ignore posts made by ignored users by default, too.
+	$smcFunc['db_insert']('replace',
+		'{db_prefix}themes',
+		array('id_member' => 'int', 'id_theme' => 'int', 'variable' => 'string-255', 'value' => 'string-255'),
+		array(-1, 1, 'posts_apply_ignore_list', '1'),
+		array('id_member', 'id_theme', 'variable', 'value')
+	);
+
+	// Make sure not to skip this step next time we run this.
+	$smcFunc['db_insert']('replace',
+		'{db_prefix}settings',
+		array('variable' => 'string-255', 'value' => 'string-255'),
+		array('dont_repeat_buddylists', '1'),
+		array('variable', 'value')
+	);
+}
+
+// And yet, and yet... We might have a small hiccup here...
+if (!empty($modSettings['dont_repeat_buddylists']) && !isset($modSettings['enable_buddylist']))
+{
+	// Correct RC3 adopters setting here...
+	if (isset($modSettings['enable_buddylists']))
+	{
+		$smcFunc['db_insert']('replace',
+			'{db_prefix}settings',
+			array('variable' => 'string-255', 'value' => 'string-255'),
+			array('enable_buddylist', $modSettings['enable_buddylists']),
+			array('variable', 'value')
+		);
+	}
+	else
+	{
+		// This should never happen :)
+		$smcFunc['db_insert']('replace',
+			'{db_prefix}settings',
+			array('variable' => 'string-255', 'value' => 'string-255'),
+			array('enable_buddylist', '1'),
+			array('variable', 'value')
+		);
+	}
+}
+
+---}
+---#
+
+/******************************************************************************/
+--- Adding settings for attachments and avatars.
+/******************************************************************************/
+
+---# Add new security settings for attachments and avatars...
+---{
+
+// Don't do this if we've done this already.
+if (!isset($modSettings['attachment_image_reencode']))
+{
+	// Enable image re-encoding by default.
+	$smcFunc['db_insert']('replace',
+		'{db_prefix}settings',
+		array('variable' => 'string-255', 'value' => 'string-255'),
+		array('attachment_image_reencode', '1'),
+		array('variable', 'value')
+	);
+}
+if (!isset($modSettings['attachment_image_paranoid']))
+{
+	// Disable draconic checks by default.
+	$smcFunc['db_insert']('replace',
+		'{db_prefix}settings',
+		array('variable' => 'string-255', 'value' => 'string-255'),
+		array('attachment_image_paranoid', '0'),
+		array('variable', 'value')
+	);
+}
+if (!isset($modSettings['avatar_reencode']))
+{
+	// Enable image re-encoding by default.
+	$smcFunc['db_insert']('replace',
+		'{db_prefix}settings',
+		array('variable' => 'string-255', 'value' => 'string-255'),
+		array('avatar_reencode', '1'),
+		array('variable', 'value')
+	);
+}
+if (!isset($modSettings['avatar_paranoid']))
+{
+	// Disable draconic checks by default.
+	$smcFunc['db_insert']('replace',
+		'{db_prefix}settings',
+		array('variable' => 'string-255', 'value' => 'string-255'),
+		array('avatar_paranoid', '0'),
+		array('variable', 'value')
+	);
+}
+---}
+---#
+
+---# Add other attachment settings...
+---{
+if (!isset($modSettings['attachment_thumb_png']))
+{
+	// Make image attachment thumbnail as PNG by default.
+	$smcFunc['db_insert']('replace',
+		'{db_prefix}settings',
+		array('variable' => 'string-255', 'value' => 'string-255'),
+		array('attachment_thumb_png', '1'),
+		array('variable', 'value')
+	);
+}
+---}
+---#
+
+/******************************************************************************/
+--- Cleaning up after old themes...
+/******************************************************************************/
+
+---# Checking for "babylon" and removing it if necessary...
+---{
+// Do they have "babylon" installed?
+if (file_exists($GLOBALS['boarddir'] . '/Themes/babylon'))
+{
+	$babylon_dir = $GLOBALS['boarddir'] . '/Themes/babylon';
+	$theme_request = $smcFunc['db_query']('', '
+		SELECT id_theme
+		FROM {db_prefix}themes
+		WHERE variable = {string:themedir}
+			AND value = {string:babylondir}',
+		array(
+			'themedir' => 'theme_dir',
+			'babylondir' => $babylon_dir,
+		)
+	);
+
+	// Don't do anything if this theme is already uninstalled
+	if ($smcFunc['db_num_rows']($theme_request) == 1)
+	{
+		$row = $smcFunc['db_fetch_row']($theme_request);
+		$id_theme = $row[0];
+		$smcFunc['db_free_result']($theme_request);
+		unset($row);
+
+		$known_themes = explode(',', $modSettings['knownThemes']);
+
+		// Remove this value...
+		$known_themes = array_diff($known_themes, array($id_theme));
+
+		// Change back to a string...
+		$known_themes = implode(',', $known_themes);
+
+		// Update the database
+		$smcFunc['db_insert']('replace',
+			'{db_prefix}settings',
+			array('variable' => 'string', 'value' => 'string'),
+			array('knownThemes', $known_themes),
+			array('variable')
+		);
+
+		// Delete any info about this theme
+		upgrade_query("
+			DELETE FROM {$db_prefix}themes
+			WHERE id_theme = $id_theme");
+
+		// Set any members or boards using this theme to the default
+		upgrade_query("
+			UPDATE {$db_prefix}members
+			SET id_theme = 0
+			WHERE id_theme = $id_theme");
+
+		upgrade_query("
+			UPDATE {$db_prefix}boards
+			SET id_theme = 0
+			WHERE id_theme = $id_theme");
+
+		if ($modSettings['theme_guests'] == $id_theme)
+		{
+			$smcFunc['db_insert']('replace',
+				'{db_prefix}settings',
+				array('variable' => 'string', 'value' => 'string'),
+				array('theme_guests', 0),
+				array('variable')
+			);
+		}
+	}
+}
+---}
+---#
+
+/******************************************************************************/
+--- Installing new smileys sets...
+/******************************************************************************/
+
+---# Installing new smiley sets...
+---{
+// Don't do this twice!
+if (empty($modSettings['installed_new_smiley_sets_20']))
+{
+	// First, the entries.
+	upgrade_query("
+		UPDATE {$db_prefix}settings
+		SET value = CONCAT(value, ',aaron,akyhne')
+		WHERE variable = 'smiley_sets_known'");
+
+	// Second, the names.
+	upgrade_query("
+		UPDATE {$db_prefix}settings
+		SET value = CONCAT(value, '\nAaron\nAkyhne')
+		WHERE variable = 'smiley_sets_names'");
+
+	// This ain't running twice either.
+	$smcFunc['db_insert']('replace',
+		'{db_prefix}settings',
+		array('variable' => 'string-255', 'value' => 'string-255'),
+		array('installed_new_smiley_sets_20', '1'),
+		array('variable', 'value')
+	);
+}
+---}
+---#
+
+/*****************************************************************************/
+--- Adding additional functions
+/*****************************************************************************/
+
+---# Adding instr()
+---{
+if ($smcFunc['db_server_info'] < 8.2)
+{
+	$request = upgrade_query("
+		SELECT type_udt_name
+		FROM information_schema.routines
+		WHERE routine_name = 'inet_aton'
+	");
+
+	// Assume there's only one such function called inet_aton()
+	$return_type = $smcFunc['db_fetch_assoc']($request);
+
+	// No point in dropping and recreating it if it's already what we want
+	if ($return_type['type_udt_name'] != 'int4')
+	{
+		upgrade_query("
+			DROP FUNCTION INSTR(text, text)");
+	}
+}
+else
+{
+	upgrade_query("
+		DROP FUNCTION IF EXISTS INSTR(text, text)");
+}
+---}
+CREATE OR REPLACE FUNCTION INSTR(text, text) RETURNS integer AS
+  'SELECT POSITION($2 IN $1) AS result'
+LANGUAGE 'sql';
+---#
+
+---# Adding date_format()
+CREATE OR REPLACE FUNCTION DATE_FORMAT (timestamp, text) RETURNS text AS
+  'SELECT
+    REPLACE(
+        REPLACE($2, ''%m'', to_char($1, ''MM'')),
+    ''%d'', to_char($1, ''DD'')) AS result'
+LANGUAGE 'sql';
+---#
+
+---# Adding day()
+CREATE OR REPLACE FUNCTION day(date) RETURNS integer AS
+  'SELECT EXTRACT(DAY FROM DATE($1))::integer AS result'
+LANGUAGE 'sql';
+---#
+
+---# Adding IFNULL(varying, varying)
+CREATE OR REPLACE FUNCTION IFNULL (character varying, character varying) RETURNS character varying AS
+  'SELECT COALESCE($1, $2) AS result'
+LANGUAGE 'sql';
+---#
+
+---# Adding IFNULL(varying, bool)
+CREATE OR REPLACE FUNCTION IFNULL(character varying, boolean) RETURNS character varying AS
+  'SELECT COALESCE($1, CAST(CAST($2 AS int) AS varchar)) AS result'
+LANGUAGE 'sql';
+---#
+
+---# Adding IFNULL(int, bool)
+CREATE OR REPLACE FUNCTION IFNULL(int, boolean) RETURNS int AS
+  'SELECT COALESCE($1, CAST($2 AS int)) AS result'
+LANGUAGE 'sql';
+---#
+
+---# Adding bool_not_eq_int()
+CREATE OR REPLACE FUNCTION bool_not_eq_int (boolean, integer) RETURNS boolean AS
+  'SELECT CAST($1 AS integer) != $2 AS result'
+LANGUAGE 'sql';
+---#
+
+---# Creating operator bool_not_eq_int()
+---{
+$result = upgrade_query("SELECT oprname FROM pg_operator WHERE oprcode='bool_not_eq_int'::regproc");
+if($smcFunc['db_num_rows']($result) == 0)
+{
+	upgrade_query("
+		CREATE OPERATOR != (PROCEDURE = bool_not_eq_int, LEFTARG = boolean, RIGHTARG = integer)");
+}
+---}
+---#
+
+---# Recreating function FIND_IN_SET()
+---{
+if ($smcFunc['db_server_info'] < 8.2)
+{
+	$query = upgrade_query("SELECT * FROM pg_proc WHERE proname = 'find_in_set' AND proargtypes = '25 25'");
+	if ($smcFunc['db_num_rows']($query) != 0)
+	{
+		upgrade_query("DROP FUNCTION FIND_IN_SET(text, text)");
+	}
+
+	$query = upgrade_query("SELECT * FROM pg_proc WHERE proname = 'find_in_set' AND proargtypes = '23 1043'");
+	if ($smcFunc['db_num_rows']($query) != 0)
+	{
+		upgrade_query("DROP FUNCTION FIND_IN_SET(integer, character varying)");
+	}
+}
+else
+{
+	upgrade_query("DROP FUNCTION IF EXISTS FIND_IN_SET(text, text)");
+	upgrade_query("DROP FUNCTION IF EXISTS FIND_IN_SET(integer, character varying)");
+}
+---}
+CREATE OR REPLACE FUNCTION FIND_IN_SET(needle text, haystack text) RETURNS integer AS '
+	SELECT i AS result
+	FROM generate_series(1, array_upper(string_to_array($2,'',''), 1)) AS g(i)
+	WHERE  (string_to_array($2,'',''))[i] = $1
+		UNION ALL
+	SELECT 0
+	LIMIT 1'
+LANGUAGE 'sql';
+
+CREATE OR REPLACE FUNCTION FIND_IN_SET(needle integer, haystack text) RETURNS integer AS '
+	SELECT i AS result
+	FROM generate_series(1, array_upper(string_to_array($2,'',''), 1)) AS g(i)
+	WHERE  (string_to_array($2,'',''))[i] = CAST($1 AS text)
+		UNION ALL
+	SELECT 0
+	LIMIT 1'
+LANGUAGE 'sql';
+---#
+
+CREATE OR REPLACE FUNCTION DATE_FORMAT (timestamp, text) RETURNS text AS
+  'SELECT
+    REPLACE(
+        REPLACE($2, ''%m'', to_char($1, ''MM'')),
+    ''%d'', to_char($1, ''DD'')) AS result'
+LANGUAGE 'sql';
+
+---# Updating TO_DAYS()
+CREATE OR REPLACE FUNCTION TO_DAYS (timestamp) RETURNS integer AS
+  'SELECT DATE_PART(''DAY'', $1 - ''0001-01-01bc'')::integer AS result'
+LANGUAGE 'sql';
+---#
+
+/******************************************************************************/
+--- Adding extra columns to reported post comments
+/******************************************************************************/
+
+---# Adding email address and member ip columns...
+---{
+if ($smcFunc['db_server_info'] < 8.0)
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_reported_comments
+		ADD COLUMN email_address varchar(255)");
+
+	upgrade_query("
+		UPDATE {$db_prefix}log_reported_comments
+		SET email_address = ''");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_reported_comments
+		ALTER COLUMN email_address SET NOT NULL");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_reported_comments
+		ALTER COLUMN email_address SET default ''");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_reported_comments
+		ADD COLUMN member_ip varchar(255)");
+
+	upgrade_query("
+		UPDATE {$db_prefix}log_reported_comments
+		SET member_ip = ''");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_reported_comments
+		ALTER COLUMN member_ip SET NOT NULL");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_reported_comments
+		ALTER COLUMN member_ip SET default ''");
+}
+else
+{
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_reported_comments
+		ADD COLUMN email_address varchar(255) NOT NULL default ''");
+
+	upgrade_query("
+		ALTER TABLE {$db_prefix}log_reported_comments
+		ADD COLUMN member_ip varchar(255) NOT NULL default ''");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Adjusting group types.
+/******************************************************************************/
+
+---# Changing the group type for Administrator group.
+UPDATE {$db_prefix}membergroups
+SET group_type = 1
+WHERE id_group = 1;
+---#
+
+/******************************************************************************/
+--- Adjusting calendar maximum year.
+/******************************************************************************/
+
+---# Adjusting calendar maximum year.
+---{
+if (!isset($modSettings['cal_maxyear']) || $modSettings['cal_maxyear'] < 2030)
+{
+	$smcFunc['db_insert']('replace',
+		'{db_prefix}settings',
+		array('variable' => 'string-255', 'value' => 'string-255'),
+		array('cal_maxyear', '2030'),
+		array('variable', 'value')
+	);
+}
+---}
+---#
+
+---# Fixing the calendar holidays if they were somehow wrong before...
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2013-11-28'
+WHERE event_date = '2013-11-21'
+	AND title = 'Thanksgiving';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2014-11-27'
+WHERE event_date = '2014-11-20'
+	AND title = 'Thanksgiving';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2019-11-28'
+WHERE event_date = '2019-11-21'
+	AND title = 'Thanksgiving';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2013-09-02'
+WHERE event_date = '2013-09-09'
+	AND title = 'Labor Day';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2014-09-01'
+WHERE event_date = '2014-09-08'
+	AND title = 'Labor Day';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2019-09-02'
+WHERE event_date = '2019-09-09'
+	AND title = 'Labor Day';
+---#
+
+/******************************************************************************/
+--- Fixing old policy acceptance records...
+/******************************************************************************/
+
+---# Fixing missing values in log_actions
+---{
+// Find the missing id_members
+$request = upgrade_query("
+	SELECT id_action, extra
+		FROM {$db_prefix}log_actions
+		WHERE id_member = 0
+		AND action IN ('policy_accepted', 'agreement_accepted')");
+
+// Fortunately they're in the extra field
+while ($row = $smcFunc['db_fetch_assoc']($request))
+{
+	$extra = @unserialize($row['extra']);
+	if ($extra === false)
+		continue;
+	if (!empty($extra['applicator']))
+	{
+		upgrade_query("
+			UPDATE {$db_prefix}log_actions
+				SET id_member = " . $extra['applicator'] . "
+				WHERE id_action = " . $row['id_action']);
+	}
+}
+
+---}
+---#
diff --git a/upgrade_2-0_sqlite.sql b/upgrade_2-0_sqlite.sql
new file mode 100644
index 0000000..6b094e5
--- /dev/null
+++ b/upgrade_2-0_sqlite.sql
@@ -0,0 +1,1018 @@
+/* ATTENTION: You don't need to run or use this file!  The upgrade.php script does everything for you! */
+
+/******************************************************************************/
+--- Updating custom fields.
+/******************************************************************************/
+
+---# Adding search ability to custom fields.
+---{
+$smcFunc['db_alter_table']('{db_prefix}custom_fields', array(
+	'add' => array(
+		'can_search' => array(
+			'name' => 'can_search',
+			'null' => false,
+			'default' => 0,
+			'type' => 'smallint',
+			'size' => 255,
+			'auto' => false,
+		),
+	),
+));
+
+if (isset($modSettings['smfVersion']) && $modSettings['smfVersion'] < '2.0 Beta 4')
+{
+upgrade_query("
+	UPDATE {$db_prefix}custom_fields
+	SET private = 3
+	WHERE private = 2");
+}
+---}
+---#
+
+---# Adding new custom fields columns.
+---{
+$smcFunc['db_alter_table']('{db_prefix}custom_fields', array(
+	'add' => array(
+		'enclose' => array(
+			'name' => 'enclose',
+			'null' => false,
+			'default' => '',
+			'type' => 'text',
+			'auto' => false,
+		),
+	)
+));
+
+$smcFunc['db_alter_table']('{db_prefix}custom_fields', array(
+	'add' => array(
+		'placement' => array(
+			'name' => 'placement',
+			'null' => false,
+			'default' => '',
+			'type' => 'smallint',
+			'auto' => false,
+		),
+	)
+));
+---}
+---#
+
+---# Fixing default value for the "show_profile" column
+---{
+$smcFunc['db_alter_table']('{db_prefix}custom_fields', array(
+	'change' => array(
+		'show_profile' => array(
+			'name' => 'show_profile',
+			'null' => false,
+			'default' => 'forumprofile',
+			'type' => 'varchar(20)',
+			'auto' => false,
+		),
+	)
+));
+---}
+---#
+
+ALTER TABLE {$db_prefix}custom_fields
+ALTER COLUMN show_profile DEFAULT 'forumprofile';
+---#
+
+/******************************************************************************/
+--- Adding search engine tracking.
+/******************************************************************************/
+
+---# Creating spider table.
+CREATE TABLE {$db_prefix}spiders (
+	id_spider integer primary key,
+	spider_name varchar(255) NOT NULL,
+	user_agent varchar(255) NOT NULL,
+	ip_info varchar(255) NOT NULL
+);
+---#
+
+---# Inserting the search engines.
+---{
+$smcFunc['db_insert']('ignore',
+	'{db_prefix}spiders',
+	array('id_spider' => 'int', 'spider_name' => 'string-255', 'user_agent' => 'string-255', 'ip_info' => 'string-255'),
+	array(
+		array(1, 'Google', 'googlebot', ''),
+		array(2, 'Yahoo!', 'slurp', ''),
+		array(3, 'MSN', 'msnbot', ''),
+		array(4, 'Google (Mobile)', 'Googlebot-Mobile', ''),
+		array(5, 'Google (Image)', 'Googlebot-Image', ''),
+		array(6, 'Google (AdSense)', 'Mediapartners-Google', ''),
+		array(7, 'Google (Adwords)', 'AdsBot-Google', ''),
+		array(8, 'Yahoo! (Mobile)', 'YahooSeeker/M1A1-R2D2', ''),
+		array(9, 'Yahoo! (Image)', 'Yahoo-MMCrawler', ''),
+		array(10, 'MSN (Mobile)', 'MSNBOT_Mobile', ''),
+		array(11, 'MSN (Media)', 'msnbot-media', ''),
+		array(12, 'Cuil', 'twiceler', ''),
+		array(13, 'Ask', 'Teoma', ''),
+		array(14, 'Baidu', 'Baiduspider', ''),
+		array(15, 'Gigablast', 'Gigabot', ''),
+		array(16, 'InternetArchive', 'ia_archiver-web.archive.org', ''),
+		array(17, 'Alexa', 'ia_archiver', ''),
+		array(18, 'Omgili', 'omgilibot', ''),
+		array(19, 'EntireWeb', 'Speedy Spider', '')
+	),
+	array('user_agent')
+);
+---}
+---#
+
+---# Removing a spider.
+---{
+	upgrade_query("
+		DELETE FROM {$db_prefix}spiders
+		WHERE user_agent = 'yahoo'
+			AND spider_name = 'Yahoo! (Publisher)'
+	");
+---}
+---#
+
+---# Creating spider hit tracking table.
+CREATE TABLE {$db_prefix}log_spider_hits (
+	id_spider integer NOT NULL default '0',
+	session varchar(32) NOT NULL default '',
+	log_time int NOT NULL,
+	url varchar(255) NOT NULL,
+	processed smallint NOT NULL default '0'
+);
+
+CREATE INDEX {$db_prefix}log_spider_hits_id_spider ON {$db_prefix}log_spider_hits (id_spider);
+CREATE INDEX {$db_prefix}log_spider_hits_log_time ON {$db_prefix}log_spider_hits (log_time);
+CREATE INDEX {$db_prefix}log_spider_hits_processed ON {$db_prefix}log_spider_hits (processed);
+---#
+
+---# Creating spider statistic table.
+CREATE TABLE {$db_prefix}log_spider_stats (
+	id_spider integer NOT NULL default '0',
+	unique_visits smallint NOT NULL default '0',
+	page_hits smallint NOT NULL default '0',
+	last_seen int NOT NULL default '0',
+	stat_date date NOT NULL default '0001-01-01',
+	PRIMARY KEY (stat_date, id_spider)
+);
+---#
+
+/******************************************************************************/
+--- Adding new forum settings.
+/******************************************************************************/
+
+---# Enable cache if upgrading from 2.0 beta 1 and lower.
+---{
+if (isset($modSettings['smfVersion']) && $modSettings['smfVersion'] <= '2.0 Beta 1')
+{
+	$request = upgrade_query("
+		SELECT value
+		FROM {$db_prefix}settings
+		WHERE variable = 'cache_enable'");
+	list ($cache_enable) = $smcFunc['db_fetch_row']($request);
+
+	// No cache before
+	if ($smcFunc['db_num_rows']($request) == 0)
+		upgrade_query("
+			INSERT INTO {$db_prefix}settings
+				(variable, value)
+			VALUES ('cache_enable', '1')");
+	elseif (empty($cache_enable))
+		upgrade_query("
+			UPDATE {$db_prefix}settings
+			SET value = '1'
+			WHERE variable = 'cache_enable'");
+}
+---}
+---#
+
+---# GDPR compliance settings.
+---{
+if (!isset($modSettings['requirePolicyAgreement']))
+{
+	upgrade_query("
+		INSERT INTO {$db_prefix}settings
+			(variable, value)
+		VALUES ('requirePolicyAgreement', '0')");
+}
+---}
+---#
+
+---# Adding advanced password brute force protection to "members" table...
+---{
+$smcFunc['db_alter_table']('{db_prefix}members', array(
+	'add' => array(
+		'passwd_flood' => array(
+			'name' => 'passwd_flood',
+			'null' => false,
+			'default' => '',
+			'type' => 'varchar',
+			'size' => 12,
+			'auto' => false,
+		),
+	)
+));
+---}
+---#
+
+---# Ensuring forum width setting present...
+---{
+// Don't do this twice!
+$smcFunc['db_insert']('ignore',
+	'{db_prefix}themes',
+	array('id_theme' => 'int', 'variable' => 'string-255', 'value' => 'string-255'),
+	array(1, 'forum_width', '90%'),
+	array('id_theme', 'variable', 'value')
+);
+---}
+---#
+
+/******************************************************************************/
+--- Adding weekly maintenance task.
+/******************************************************************************/
+
+---# Adding weekly maintenance task...
+---{
+$smcFunc['db_insert']('ignore',
+	'{db_prefix}scheduled_tasks',
+	array(
+		'next_time' => 'int', 'time_offset' => 'int', 'time_regularity' => 'int',
+		'time_unit' => 'string', 'disabled' => 'int', 'task' => 'string',
+	),
+	array(
+		0, 0, 1, 'w', 0, 'weekly_maintenance',
+	),
+	array('task')
+);
+---}
+---#
+
+---# Setting the birthday email template if not set...
+---{
+if (!isset($modSettings['birthday_email']))
+{
+	upgrade_query("
+		INSERT INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('birthday_email', 'happy_birthday')");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Adding log pruning.
+/******************************************************************************/
+
+---# Adding pruning option...
+---{
+$smcFunc['db_insert']('ignore',
+	'{db_prefix}settings',
+	array('variable' => 'string-255', 'value' => 'string-65534'),
+	array('pruningOptions', '30,180,180,180,30'),
+	array('variable')
+);
+---}
+---#
+
+/******************************************************************************/
+--- Updating mail queue functionality.
+/******************************************************************************/
+
+---# Adding type to mail queue...
+---{
+$smcFunc['db_alter_table']('{db_prefix}mail_queue', array(
+	'add' => array(
+		'private' => array(
+			'name' => 'private',
+			'null' => false,
+			'default' => 0,
+			'type' => 'smallint',
+			'size' => 1,
+			'auto' => false,
+		),
+	)
+));
+---}
+---#
+
+/******************************************************************************/
+--- Updating attachments.
+/******************************************************************************/
+
+---# Adding multiple attachment path functionality.
+---{
+$smcFunc['db_alter_table']('{db_prefix}attachments', array(
+	'add' => array(
+		'id_folder' => array(
+			'name' => 'id_folder',
+			'null' => false,
+			'default' => 1,
+			'type' => 'smallint',
+			'size' => 255,
+			'auto' => false,
+		),
+	)
+));
+---}
+---#
+
+---# Adding file hash.
+---{
+$smcFunc['db_alter_table']('{db_prefix}attachments', array(
+	'add' => array(
+		'file_hash' => array(
+			'name' => 'file_hash',
+			'null' => false,
+			'default' => '',
+			'type' => 'varchar',
+			'size' => 40,
+			'auto' => false,
+		),
+	)
+));
+---}
+---#
+
+/******************************************************************************/
+--- Providing more room for apf options.
+/******************************************************************************/
+
+---# Changing field_options column to a larger field type...
+---{
+$smcFunc['db_alter_table']('{db_prefix}custom_fields', array(
+	'change' => array(
+		'aim' => array(
+			'name' => 'field_options',
+			'null' => false,
+			'type' => 'text',
+			'default' => ''
+		)
+	)
+));
+---}
+---#
+
+/******************************************************************************/
+--- Adding extra columns to polls.
+/******************************************************************************/
+
+---# Adding reset poll timestamp and guest voters counter...
+---{
+$smcFunc['db_alter_table']('{db_prefix}polls', array(
+	'add' => array(
+		'reset_poll' => array(
+			'name' => 'reset_poll',
+			'null' => false,
+			'default' => 0,
+			'type' => 'int',
+			'size' => 10,
+			'auto' => false,
+		),
+		'num_guest_voters' => array(
+			'name' => 'num_guest_voters',
+			'null' => false,
+			'default' => 0,
+			'type' => 'int',
+			'size' => 10,
+			'auto' => false,
+		),
+	)
+));
+---}
+---#
+
+---# Fixing guest voter tallys on existing polls...
+---{
+$request = upgrade_query("
+	SELECT p.id_poll, count(lp.id_member) as guest_voters
+	FROM {$db_prefix}polls AS p
+		LEFT JOIN {$db_prefix}log_polls AS lp ON (lp.id_poll = p.id_poll AND lp.id_member = 0)
+	WHERE lp.id_member = 0
+		AND p.num_guest_voters = 0
+	GROUP BY p.id_poll");
+
+while ($request && $row = $smcFunc['db_fetch_assoc']($request))
+	upgrade_query("
+		UPDATE {$db_prefix}polls
+		SET num_guest_voters = ". $row['guest_voters']. "
+		WHERE id_poll = " . $row['id_poll'] . "
+			AND num_guest_voters = 0");
+---}
+---#
+
+/******************************************************************************/
+--- Adding restore topic from recycle.
+/******************************************************************************/
+
+---# Adding restore from recycle feature...
+---{
+$smcFunc['db_alter_table']('{db_prefix}topics', array(
+	'add' => array(
+		'id_previous_board' => array(
+			'name' => 'id_previous_board',
+			'null' => false,
+			'default' => 0,
+			'type' => 'smallint',
+			'auto' => false,
+		),
+		'id_previous_topic' => array(
+			'name' => 'id_previous_topic',
+			'null' => false,
+			'default' => 0,
+			'type' => 'int',
+			'auto' => false,
+		),
+	)
+));
+---}
+---#
+
+/******************************************************************************/
+--- Fixing aim on members for longer nicks.
+/******************************************************************************/
+
+---# Changing 'aim' to varchar to allow using email...
+---{
+$smcFunc['db_alter_table']('{db_prefix}members', array(
+	'change' => array(
+		'aim' => array(
+			'name' => 'aim',
+			'null' => false,
+			'type' => 'varchar',
+			'size' => 255,
+			'default' => ''
+		)
+	)
+));
+---}
+---#
+
+/******************************************************************************/
+--- Allow for longer calendar event/holiday titles.
+/******************************************************************************/
+
+---# Changing event title column to a larger field type...
+---{
+$smcFunc['db_alter_table']('{db_prefix}calendar', array(
+	'change' => array(
+		'title' => array(
+			'name' => 'title',
+			'null' => false,
+			'type' => 'varchar',
+			'size' => 255,
+			'default' => ''
+		)
+	)
+));
+---}
+---#
+
+---# Changing holiday title column to a larger field type...
+---{
+$smcFunc['db_alter_table']('{db_prefix}calendar_holidays', array(
+	'change' => array(
+		'title' => array(
+			'name' => 'title',
+			'null' => false,
+			'type' => 'varchar',
+			'size' => 255,
+			'default' => ''
+		)
+	)
+));
+---}
+---#
+
+/******************************************************************************/
+--- Making changes to the package manager.
+/******************************************************************************/
+
+---# Changing URL to SMF package server...
+UPDATE {$db_prefix}package_servers
+SET url = 'https://custom.simplemachines.org/packages/mods'
+WHERE
+	url = 'http://mods.simplemachines.org'
+	OR url = 'http://custom.simplemachines.org/packages/mods';
+---#
+
+/******************************************************************************/
+--- Adding new indexes to the topics table.
+/******************************************************************************/
+
+---# Adding index member_started...
+CREATE INDEX {$db_prefix}topics_member_started ON {$db_prefix}topics (id_member_started, id_board);
+---#
+
+---# Adding index last_message_sticky...
+CREATE INDEX {$db_prefix}topics_last_message_sticky ON {$db_prefix}topics (id_board, is_sticky, id_last_msg);
+---#
+
+---# Adding index board_news...
+CREATE INDEX {$db_prefix}topics_board_news ON {$db_prefix}topics (id_board, id_first_msg);
+---#
+
+/******************************************************************************/
+--- Adding new indexes to members table.
+/******************************************************************************/
+
+---# Adding index on total_time_logged_in...
+CREATE INDEX {$db_prefix}members_total_time_logged_in ON {$db_prefix}members (total_time_logged_in);
+---#
+
+---# Adding index on id_theme...
+CREATE INDEX {$db_prefix}members_id_theme ON {$db_prefix}members (id_theme);
+---#
+
+---# Adding index on real_name...
+CREATE INDEX {$db_prefix}members_real_name ON {$db_prefix}members (real_name);
+---#
+
+/******************************************************************************/
+--- Adding new indexes to messages table.
+/******************************************************************************/
+
+---# Adding index id_member_msg...
+CREATE INDEX {$db_prefix}messages_id_member_msg ON {$db_prefix}messages (id_member, approved, id_msg);
+---#
+
+---# Adding index current_topic...
+CREATE INDEX {$db_prefix}messages_current_topic ON {$db_prefix}messages (id_topic, id_msg, id_member, approved);
+---#
+
+---# Adding index related_ip...
+CREATE INDEX {$db_prefix}messages_related_ip ON {$db_prefix}messages (id_member, poster_ip, id_msg);
+---#
+
+/******************************************************************************/
+--- Adding new indexes to attachments table.
+/******************************************************************************/
+
+---# Adding index on attachment_type...
+CREATE INDEX {$db_prefix}attachments_attachment_type ON {$db_prefix}attachments (attachment_type);
+---#
+
+/******************************************************************************/
+--- Dropping unnecessary indexes...
+/******************************************************************************/
+
+---# Removing index on hits...
+---{
+$smcFunc['db_remove_index']($db_prefix . 'log_activity', $db_prefix . 'log_activity_hits');
+---}
+---#
+
+/******************************************************************************/
+--- Adding new personal message setting.
+/******************************************************************************/
+
+---# Adding column that stores the PM receiving setting...
+---{
+$smcFunc['db_alter_table']('{db_prefix}members', array(
+	'add' => array(
+		'pm_receive_from' => array(
+			'name' => 'pm_receive_from',
+			'null' => false,
+			'type' => 'tinyint',
+			'size' => 4,
+			'default' => '1'
+		)
+	)
+));
+---}
+---#
+
+---# Enable the buddy and ignore lists if we have not done so thus far...
+---{
+
+// Don't do this if we've done this already.
+if (empty($modSettings['dont_repeat_buddylists']))
+{
+	// Make sure the pm_receive_from column has the right default value - early adoptors might have a '0' set here.
+	$smcFunc['db_alter_table']('{db_prefix}members', array(
+		'change' => array(
+			'pm_receive_from' => array(
+				'name' => 'pm_receive_from',
+				'null' => false,
+				'type' => 'tinyint',
+				'size' => 4,
+				'default' => '1'
+			)
+		)
+	));
+
+	// Update previous ignore lists if they're set to ignore all.
+	upgrade_query("
+		UPDATE {$db_prefix}members
+		SET pm_receive_from = 3, pm_ignore_list = ''
+		WHERE pm_ignore_list = '*'");
+
+	// Enable buddy and ignore lists.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('enable_buddylist', '1')");
+
+	// Ignore posts made by ignored users by default, too.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}themes
+			(id_member, id_theme, variable, value)
+		VALUES
+			(-1, 1, 'posts_apply_ignore_list', '1')");
+
+	// Make sure not to skip this step next time we run this.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('dont_repeat_buddylists', '1')");
+}
+
+// And yet, and yet... We might have a small hiccup here...
+if (!empty($modSettings['dont_repeat_buddylists']) && !isset($modSettings['enable_buddylist']))
+{
+	// Correct RC3 adopters setting here...
+	if (isset($modSettings['enable_buddylists']))
+	{
+		upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('enable_buddylist', '". $modSettings['enable_buddylists']. "')");
+	}
+	else
+	{
+		// This should never happen :)
+		upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('enable_buddylist', '1')");
+	}
+}
+---}
+---#
+
+/******************************************************************************/
+--- Adding settings for attachments and avatars.
+/******************************************************************************/
+
+---# Add new security settings for attachments and avatars...
+---{
+
+// Don't do this if we've done this already.
+if (!isset($modSettings['attachment_image_reencode']))
+{
+	// Enable image re-encoding by default.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('attachment_image_reencode', '1')");
+}
+if (!isset($modSettings['attachment_image_paranoid']))
+{
+	// Disable draconic checks by default.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('attachment_image_paranoid', '0')");
+}
+if (!isset($modSettings['avatar_reencode']))
+{
+	// Enable image re-encoding by default.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('avatar_reencode', '1')");
+}
+if (!isset($modSettings['avatar_paranoid']))
+{
+	// Disable draconic checks by default.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('avatar_paranoid', '0')");
+}
+
+---}
+---#
+
+---# Add other attachment settings...
+---{
+if (!isset($modSettings['attachment_thumb_png']))
+{
+	// Make image attachment thumbnail as PNG by default.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('attachment_thumb_png', '1')");
+}
+
+---}
+---#
+
+/******************************************************************************/
+--- Installing new default theme...
+/******************************************************************************/
+
+---# Installing theme settings...
+---{
+// This is Grudge's secret "I'm not a developer" theme install code - keep this quiet ;)
+
+// Firstly, I'm going out of my way to not do this twice!
+if ((!isset($modSettings['smfVersion']) || $modSettings['smfVersion'] <= '2.0 RC2') && empty($modSettings['dont_repeat_theme_core']))
+{
+	// Check it's not already here, just in case.
+	$theme_request = upgrade_query("
+		SELECT id_theme
+		FROM {$db_prefix}themes
+		WHERE variable = 'theme_dir'
+			AND value LIKE '%core'");
+	// Only do the upgrade if it doesn't find the theme already.
+	if ($smcFunc['db_num_rows']($theme_request) == 0)
+	{
+		// Try to get some settings from the current default theme.
+		$request = upgrade_query("
+			SELECT t1.value AS theme_dir, t2.value AS theme_url, t3.value AS images_url
+			FROM {$db_prefix}themes AS t1, {$db_prefix}themes AS t2, {$db_prefix}themes AS t3
+			WHERE t1.id_theme = 1
+				AND t1.id_member = 0
+				AND t1.variable = 'theme_dir'
+				AND t2.id_theme = 1
+				AND t2.id_member = 0
+				AND t2.variable = 'theme_url'
+				AND t3.id_theme = 1
+				AND t3.id_member = 0
+				AND t3.variable = 'images_url'
+			LIMIT 1");
+		if ($smcFunc['db_num_rows']($request) != 0)
+		{
+			$curve = $smcFunc['db_fetch_assoc']($request);
+
+			if (substr_count($curve['theme_dir'], 'default') === 1)
+				$core['theme_dir'] = strtr($curve['theme_dir'], array('default' => 'core'));
+			if (substr_count($curve['theme_url'], 'default') === 1)
+				$core['theme_url'] = strtr($curve['theme_url'], array('default' => 'core'));
+			if (substr_count($curve['images_url'], 'default') === 1)
+				$core['images_url'] = strtr($curve['images_url'], array('default' => 'core'));
+		}
+		$smcFunc['db_free_result']($request);
+
+		if (!isset($core['theme_dir']))
+			$core['theme_dir'] = addslashes($GLOBALS['boarddir']) . '/Themes/core';
+		if (!isset($core['theme_url']))
+			$core['theme_url'] = $GLOBALS['boardurl'] . '/Themes/core';
+		if (!isset($core['images_url']))
+			$core['images_url'] = $GLOBALS['boardurl'] . '/Themes/core/images';
+
+		// Get an available id_theme first...
+		$request = upgrade_query("
+			SELECT MAX(id_theme) + 1
+			FROM {$db_prefix}themes");
+		list ($id_core_theme) = $smcFunc['db_fetch_row']($request);
+		$smcFunc['db_free_result']($request);
+
+		// Insert the core theme into the tables.
+		$smcFunc['db_insert']('ignore',
+			'{db_prefix}themes',
+				array('id_member' => 'int', 'id_theme' => 'int', 'variable' => 'string-255', 'value' => 'string-255'),
+				array(
+					array(0, $id_core_theme, 'name', 'Core Theme'),
+					array(0, $id_core_theme, 'theme_url', $core['theme_url']),
+					array(0, $id_core_theme, 'images_url', $core['images_url']),
+					array(0, $id_core_theme, 'theme_dir', $core['theme_dir'])
+				),
+				array()
+		);
+
+		// Update the name of the default theme in the database.
+		upgrade_query("
+			UPDATE {$db_prefix}themes
+			SET value = 'SMF Default Theme - Curve'
+			WHERE id_theme = 1
+				AND variable = 'name'");
+
+		$newSettings = array();
+		// Now that we have the old theme details - switch anyone who used the default to it (Make sense?!)
+		if (!empty($modSettings['theme_default']) && $modSettings['theme_default'] == 1)
+			$newSettings[] = "('theme_default', $id_core_theme)";
+		// Did guests use to use the default?
+		if (!empty($modSettings['theme_guests']) && $modSettings['theme_guests'] == 1)
+			$newSettings[] = "('theme_guests', $id_core_theme)";
+
+		// If known themes aren't set, let's just pick all themes available.
+		if (empty($modSettings['knownThemes']))
+		{
+			$request = upgrade_query("
+				SELECT DISTINCT id_theme
+				FROM {$db_prefix}themes");
+			$themes = array();
+			while ($row = $smcFunc['db_fetch_assoc']($request))
+				$themes[] = $row['id_theme'];
+			$modSettings['knownThemes'] = implode(',', $themes);
+			upgrade_query("
+				UPDATE {$db_prefix}settings
+				SET value = '$modSettings[knownThemes]'
+				WHERE variable = 'knownThemes'");
+		}
+
+		// Known themes.
+		$allThemes = explode(',', $modSettings['knownThemes']);
+		$allThemes[] = $id_core_theme;
+		$newSettings[] = "('knownThemes', '" . implode(',', $allThemes) . "')";
+
+		upgrade_query("
+			REPLACE INTO {$db_prefix}settings
+				(variable, value)
+			VALUES
+				" . implode(', ', $newSettings));
+
+		// What about members?
+		upgrade_query("
+			UPDATE {$db_prefix}members
+			SET id_theme = $id_core_theme
+			WHERE id_theme = 1");
+
+		// Boards?
+		upgrade_query("
+			UPDATE {$db_prefix}boards
+			SET id_theme = $id_core_theme
+			WHERE id_theme = 1");
+
+		// The other themes used to use core as their base theme.
+		if (isset($core['theme_dir']) && isset($core['theme_url']))
+		{
+			$coreBasedThemes = array_diff($allThemes, array(1));
+
+			// Exclude the themes that already have a base_theme_dir.
+			$request = upgrade_query("
+				SELECT DISTINCT id_theme
+				FROM {$db_prefix}themes
+				WHERE variable = 'base_theme_dir'");
+			while ($row = $smcFunc['db_fetch_assoc']($request))
+				$coreBasedThemes = array_diff($coreBasedThemes, array($row['id_theme']));
+			$smcFunc['db_free_result']($request);
+
+			// Only base themes if there are templates that need a fall-back.
+			$insertRows = array();
+			$request = upgrade_query("
+				SELECT id_theme, value AS theme_dir
+				FROM {$db_prefix}themes
+				WHERE id_theme IN (" . implode(', ', $coreBasedThemes) . ")
+					AND id_member = 0
+					AND variable = 'theme_dir'");
+			while ($row = $smcFunc['db_fetch_assoc']($request))
+			{
+				if (!file_exists($row['theme_dir'] . '/BoardIndex.template.php') || !file_exists($row['theme_dir'] . '/Display.template.php') || !file_exists($row['theme_dir'] . '/index.template.php') || !file_exists($row['theme_dir'] . '/MessageIndex.template.php') || !file_exists($row['theme_dir'] . '/Settings.template.php'))
+				{
+					$insertRows[] = "(0, $row[id_theme], 'base_theme_dir', '" . addslashes($core['theme_dir']) . "')";
+					$insertRows[] = "(0, $row[id_theme], 'base_theme_url', '" . addslashes($core['theme_url']) . "')";
+				}
+			}
+			$smcFunc['db_free_result']($request);
+
+			if (!empty($insertRows))
+				upgrade_query("
+					INSERT IGNORE INTO {$db_prefix}themes
+						(id_member, id_theme, variable, value)
+					VALUES
+						" . implode(',
+						', $insertRows));
+		}
+	}
+	$smcFunc['db_free_result']($theme_request);
+
+	// This ain't running twice either - not with the risk of log_tables timing us all out!
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('dont_repeat_theme_core', '1')");
+}
+
+---}
+---#
+
+/******************************************************************************/
+--- Installing new smileys sets...
+/******************************************************************************/
+
+---# Installing new smiley sets...
+---{
+// Don't do this twice!
+if (empty($modSettings['installed_new_smiley_sets_20']))
+{
+	// First, the entries.
+	upgrade_query("
+		UPDATE {$db_prefix}settings
+		SET value = CONCAT(value, ',aaron,akyhne')
+		WHERE variable = 'smiley_sets_known'");
+
+	// Second, the names.
+	upgrade_query("
+		UPDATE {$db_prefix}settings
+		SET value = CONCAT(value, '\nAaron\nAkyhne')
+		WHERE variable = 'smiley_sets_names'");
+
+	// This ain't running twice either.
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('installed_new_smiley_sets_20', '1')");
+}
+---}
+---#
+
+/******************************************************************************/
+--- Adding extra columns to reported post comments
+/******************************************************************************/
+
+---# Adding email address and member ip columns...
+---{
+$smcFunc['db_alter_table']('{db_prefix}log_reported_comments', array(
+	'add' => array(
+		'email_address' => array(
+			'name' => 'email_address',
+			'null' => false,
+			'default' => '',
+			'type' => 'varchar',
+			'size' => 255,
+			'auto' => false,
+		),
+		'member_ip' => array(
+			'name' => 'member_ip',
+			'null' => false,
+			'default' => '',
+			'type' => 'varchar',
+			'size' => 255,
+			'auto' => false,
+		),
+	)
+));
+---}
+---#
+
+/******************************************************************************/
+--- Adjusting group types.
+/******************************************************************************/
+
+---# Changing the group type for Administrator group.
+UPDATE {$db_prefix}membergroups
+SET group_type = 1
+WHERE id_group = 1;
+---#
+
+/******************************************************************************/
+--- Adjusting calendar maximum year.
+/******************************************************************************/
+
+---# Adjusting calendar maximum year.
+---{
+if (!isset($modSettings['cal_maxyear']) || $modSettings['cal_maxyear'] < 2030)
+{
+	upgrade_query("
+		REPLACE INTO {$db_prefix}settings
+			(variable, value)
+		VALUES
+			('cal_maxyear', '2030')");
+}
+---}
+---#
+
+---# Fixing the calendar holidays if they were somehow wrong before...
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2013-11-28'
+WHERE event_date = '2013-11-21'
+	AND title = 'Thanksgiving';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2014-11-27'
+WHERE event_date = '2014-11-20'
+	AND title = 'Thanksgiving';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2019-11-28'
+WHERE event_date = '2019-11-21'
+	AND title = 'Thanksgiving';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2013-09-02'
+WHERE event_date = '2013-09-09'
+	AND title = 'Labor Day';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2014-09-01'
+WHERE event_date = '2014-09-08'
+	AND title = 'Labor Day';
+
+UPDATE {$db_prefix}calendar_holidays
+SET event_date = '2019-09-02'
+WHERE event_date = '2019-09-09'
+	AND title = 'Labor Day';
+---#
\ No newline at end of file
